<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>My Project: seafile-4.1.2/daemon/Backups/repo-mgr.c File Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">My Project
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#define-members">Defines</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">seafile-4.1.2/daemon/Backups/repo-mgr.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;common.h&quot;</code><br/>
<code>#include &lt;glib/gstdio.h&gt;</code><br/>
<code>#include &lt;<a class="el" href="ccnet_8h_source.html">ccnet.h</a>&gt;</code><br/>
<code>#include &quot;utils.h&quot;</code><br/>
<code>#include &quot;log.h&quot;</code><br/>
<code>#include &quot;<a class="el" href="status_8h_source.html">status.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="vc-utils_8h_source.html">vc-utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="merge_8h_source.html">merge.h</a>&quot;</code><br/>
<code>#include &quot;seafile-session.h&quot;</code><br/>
<code>#include &quot;<a class="el" href="seafile-config_8h_source.html">seafile-config.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="commit-mgr_8h_source.html">commit-mgr.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="branch-mgr_8h_source.html">branch-mgr.h</a>&quot;</code><br/>
<code>#include &quot;repo-mgr.h&quot;</code><br/>
<code>#include &quot;<a class="el" href="fs-mgr_8h_source.html">fs-mgr.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="seafile-error_8h_source.html">seafile-error.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="seafile-crypt_8h_source.html">seafile-crypt.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="index_8h_source.html">index/index.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="cache-tree_8h_source.html">index/cache-tree.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="unpack-trees_8h_source.html">unpack-trees.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="diff-simple_8h_source.html">diff-simple.h</a>&quot;</code><br/>
<code>#include &quot;db.h&quot;</code><br/>
</div>
<p><a href="daemon_2Backups_2repo-mgr_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct__SeafRepoManagerPriv.html">_SeafRepoManagerPriv</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct__AddOptions.html">_AddOptions</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structCAInfo.html">CAInfo</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structCheckoutData.html">CheckoutData</a></td></tr>
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a05d1af42442c934b555896d3fe55c79e">DEBUG_FLAG</a>&#160;&#160;&#160;<a class="el" href="seafile-4_81_82_2common_2log_8h.html#ab0ef81bf7d4daa70c41b9e89e6543bfbaddde2b807762dde36d8143cb8d062bff">SEAFILE_DEBUG_SYNC</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a823aa5bebe4b4b836619cae12751b8a5">INDEX_DIR</a>&#160;&#160;&#160;&quot;index&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a237e501289ed87ac7fb2bb3859e81cb0">IGNORE_FILE</a>&#160;&#160;&#160;&quot;seafile-ignore.txt&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a67a7df7fa60be3209b087d86faaab360">MAX_COMMIT_SIZE</a>&#160;&#160;&#160;100 * (1 &lt;&lt; 20) /* 100MB */</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a4ee85b8b11bc0c69227a8c331a8d9d30">UPDATE_CACHE_SIZE_LIMIT</a>&#160;&#160;&#160;100 * (1 &lt;&lt; 20) /* 100MB */</td></tr>
<tr><td colspan="2"><h2><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct__AddOptions.html">_AddOptions</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a484d651f14e66ed05ff54bab5793a695">AddOptions</a></td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="daemon_2repo-mgr_8h.html#adccaa653ef97d8570cac74163af03002">LockedFileSet</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a06294e91365be10d46a356d427f62e07">seaf_repo_manager_get_locked_file_set</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#ab44c57f5e23996e5eb807f7c84f443f5">locked_file_set_free</a> (<a class="el" href="daemon_2repo-mgr_8h.html#adccaa653ef97d8570cac74163af03002">LockedFileSet</a> *fset)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a8782ae78d069d4073a35d981b04a2a88">locked_file_set_add_update</a> (<a class="el" href="daemon_2repo-mgr_8h.html#adccaa653ef97d8570cac74163af03002">LockedFileSet</a> *fset, const char *path, const char *operation, gint64 old_mtime, const char *file_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a4d1dacc802b818970800154a9bc6e3db">locked_file_set_remove</a> (<a class="el" href="daemon_2repo-mgr_8h.html#adccaa653ef97d8570cac74163af03002">LockedFileSet</a> *fset, const char *path, gboolean db_only)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="daemon_2repo-mgr_8h.html#a12a39343dc26a7f7692652fc43b2d3cb">LockedFile</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a818fec9b8684b386170e39cfe5feff55">locked_file_set_lookup</a> (<a class="el" href="daemon_2repo-mgr_8h.html#adccaa653ef97d8570cac74163af03002">LockedFileSet</a> *fset, const char *path)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="daemon_2repo-mgr_8h.html#a56a1cab242a6825a469495e61c711aa6">FolderPerm</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#af73ee61bbe7c459c590af5aa523bfec4">folder_perm_new</a> (const char *path, const char *permission)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a16e4a5db024bcc5baf2ef8a3f0623a41">folder_perm_free</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a56a1cab242a6825a469495e61c711aa6">FolderPerm</a> *perm)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a446e8f23cdec415146a604f1b954c1a3">seaf_repo_manager_update_folder_perms</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, <a class="el" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1a">FolderPermType</a> <a class="el" href="fs-mgr_8c.html#a65cfc9e13d3352fd9099a0408cba715c">type</a>, GList *folder_perms)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#ad00e4e927e8099054e29e532cae9c5e4">seaf_repo_manager_load_folder_perms</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, <a class="el" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1a">FolderPermType</a> <a class="el" href="fs-mgr_8c.html#a65cfc9e13d3352fd9099a0408cba715c">type</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#af7adb54d2ed6bcfd5b722428bfcfb6d6">seaf_repo_manager_update_folder_perm_timestamp</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, gint64 timestamp)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gint64&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a7320afc04f67e0cb3dcc20389479c234">seaf_repo_manager_get_folder_perm_timestamp</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gboolean&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a35ce9f51287bbd5f961c261516c1c5f0">is_repo_id_valid</a> (const char *id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a63ab9fe4694e3d967376c911cbe2c655">seaf_repo_new</a> (const char *id, const char *<a class="el" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>, const char *desc)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#ad1200d69d8e6219885da4e85af15dca2">seaf_repo_check_worktree</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#ad0a65514ad80789ff244b20c66460b96">seaf_repo_free</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a6c47d6277897f6afbe866f2755f9762d">seaf_repo_set_head</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, <a class="el" href="branch-mgr_8h.html#a43063fab0cfaf940abc07b1cd941fb85">SeafBranch</a> *branch)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="commit-mgr_8h.html#ab20cfcee12e164d94824e8be23c2c8ea">SeafCommit</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a7fdd2ba98b2cab98aaced0e49a1685a9">seaf_repo_get_head_commit</a> (const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a9c8ead9892374c87ece888d76e810197">seaf_repo_from_commit</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, <a class="el" href="commit-mgr_8h.html#ab20cfcee12e164d94824e8be23c2c8ea">SeafCommit</a> *commit)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a39a9a41ffdfc324f3c935251d9e14d51">seaf_repo_to_commit</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, <a class="el" href="commit-mgr_8h.html#ab20cfcee12e164d94824e8be23c2c8ea">SeafCommit</a> *commit)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#adc55911231fbdbb9d54f39d7f0e60dca">seaf_repo_get_commits</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a01b64563a9ab1351f8a9626c86ff8d6a">seaf_repo_set_readonly</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#af712f7a4551fbc0dfa780f3aada0a029">seaf_repo_unset_readonly</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gboolean&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a1705de1c533ed3783c9e7ad4b34f4b96">seaf_repo_manager_is_ignored_hidden_file</a> (const char *filename)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#aadbf4eb74b53f6423e7eabf716f5f4fb">seaf_repo_index_worktree_files</a> (const char *repo_id, int repo_version, const char *modifier, const char *worktree, const char *passwd, int enc_version, const char *random_key, char *root_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gboolean&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a461e72948bba5928329e269ad395e293">seaf_repo_is_worktree_changed</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gboolean&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a79db93d798035e3e07f48c2ad32d87f1">seaf_repo_is_index_unmerged</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#af591ba84286a82123c728debd33ff300">seaf_repo_index_commit</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, const char *desc, gboolean is_force_commit, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a7923c5fb7b957a121f1b2616a8d66745">seaf_repo_checkout_commit</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, <a class="el" href="commit-mgr_8h.html#ab20cfcee12e164d94824e8be23c2c8ea">SeafCommit</a> *commit, gboolean recover_merge, char **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a888b4c185cc198eaf4eb7d4d3b8e9054">seaf_repo_checkout</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, const char *worktree, char **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a25b9a6f8f5199db34dcb95789a80eba4">seaf_repo_merge</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, const char *branch, char **error, int *merge_status)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a450e5bcc50da4c40b7ba2bde33a22a84">checkout_file</a> (const char *repo_id, int repo_version, const char *worktree, const char *<a class="el" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>, const char *file_id, gint64 <a class="el" href="index_8h.html#adb9fb1ca66f1a67516c2ee1492e6ab2b">mtime</a>, unsigned int <a class="el" href="index_8h.html#ac1b4d694fc07a39e06900e82872aac7f">mode</a>, <a class="el" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt, struct <a class="el" href="structcache__entry.html">cache_entry</a> *ce, <a class="el" href="transfer-mgr_8h.html#ac3aaa1ec5e8dc2ac42d8d2b87ee8fcca">TransferTask</a> *task, <a class="el" href="http-tx-mgr_8h.html#a3ef685a6dcf2af7909e698d37b21d5e2">HttpTxTask</a> *http_task, gboolean is_http, const char *conflict_head_id, GHashTable *conflict_hash, GHashTable *no_conflict_hash, gboolean download_only)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a181f66e1d3900771c37883e97fea7fba">checkout_empty_dir</a> (const char *worktree, const char *<a class="el" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>, gint64 <a class="el" href="index_8h.html#adb9fb1ca66f1a67516c2ee1492e6ab2b">mtime</a>, struct <a class="el" href="structcache__entry.html">cache_entry</a> *ce, GHashTable *conflict_hash, GHashTable *no_conflict_hash)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a3ae125d7fd328d8d141dc38710ffd24e">seaf_repo_fetch_and_checkout</a> (<a class="el" href="transfer-mgr_8h.html#ac3aaa1ec5e8dc2ac42d8d2b87ee8fcca">TransferTask</a> *task, <a class="el" href="http-tx-mgr_8h.html#a3ef685a6dcf2af7909e698d37b21d5e2">HttpTxTask</a> *http_task, gboolean is_http, const char *remote_head_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a6ed05df6501a326fc58a0fefb91aef3d">seaf_repo_manager_set_repo_worktree</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, <a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, const char *worktree)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a4002175d5613c80a6dd82b95bc1fae24">seaf_repo_manager_invalidate_repo_worktree</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, <a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a8299b47936df15cd58ba2ae41e344450">seaf_repo_manager_validate_repo_worktree</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, <a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a8f91693d20dfa77546527064cb1097e3">seaf_repo_manager_new</a> (<a class="el" href="daemon_2seafile-session_8h.html#a3412e7ea22f43083cdc07acffa80f859">SeafileSession</a> *<a class="el" href="server_2seafile-session_8h.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a8dab773e289d1148e7afec7c8614278a">seaf_repo_manager_init</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a2e049cfa3d0546aaf51e7f6792e1467d">seaf_repo_manager_start</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#ab599ba29e40bdb918ac78060d1165c2d">seaf_repo_manager_create_new_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *<a class="el" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>, const char *desc)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a140616a89d5a02935665f86cf3bb744c">seaf_repo_manager_add_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, <a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#ad41b6fcdbf4fdfa7d70daf98af124460">seaf_repo_manager_mark_repo_deleted</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, <a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#ae45351706ea0868c8e6c9bad500e1785">seaf_repo_manager_list_garbage_repos</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a7d2cf85f06fa2e7d459730f7494c1a65">seaf_repo_manager_remove_garbage_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a008f145440cf3620f7883d1fe109f69c">seaf_repo_manager_remove_repo_ondisk</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, gboolean add_deleted_record)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#afdce2de6ee36dcf6b6264ac35fb17f7a">seaf_repo_manager_del_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, <a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const gchar *id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gboolean&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a4b2497e6cdde50c4ce3cb642370e06eb">seaf_repo_manager_repo_exists</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const gchar *id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a45b0ed6bbbdfac4fd104962800f426c3">seaf_repo_manager_get_repo_lantoken</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a93b2f3d8f0964708f8fb0450fded2a42">seaf_repo_manager_set_repo_lantoken</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const char *repo_id, const char *token)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a297f8a46a2390465725298d9a08c1145">seaf_repo_manager_verify_repo_lantoken</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const char *repo_id, const char *token)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#afebb8831a3f9be12c5612c5707118d3b">seaf_repo_manager_generate_tmp_token</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const char *repo_id, const char *peer_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#ae27495cf631eca68cf5e94048b7e66f2">seaf_repo_manager_verify_tmp_token</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const char *repo_id, const char *peer_id, const char *token)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#ae586fb5fbd61d6b44be3e47e7b6c86da">seaf_repo_manager_branch_repo_unmap</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, <a class="el" href="branch-mgr_8h.html#a43063fab0cfaf940abc07b1cd941fb85">SeafBranch</a> *branch)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#ad2263393047e4ea1f5226842b11e7b05">seaf_repo_manager_set_repo_relay_id</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, <a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, const char *relay_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const char *repo_id, const char *key, const char *value)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a71edf5bba9589fa8793d7b0312cb9553">seaf_repo_manager_get_repo_property</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const char *repo_id, const char *key)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a683d25df06076d282da2f7ae01e05a49">seaf_repo_manager_set_repo_passwd</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, <a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, const char *passwd)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a2e382a4324579845c975befc11cccda2">seaf_repo_manager_set_merge</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const char *repo_id, const char *remote_head)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a04253ac87d4466bd4e2abd1e312a1663">seaf_repo_manager_clear_merge</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#ac0e4e52af419d42f34ce53d368777070">seaf_repo_manager_get_merge_info</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const char *repo_id, <a class="el" href="structSeafRepoMergeInfo.html">SeafRepoMergeInfo</a> *info)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a3d8affa43a26075cdd6821e330f68748">seaf_repo_manager_get_common_ancestor</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const char *repo_id, char *common_ancestor, char *head_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#af2f71495e665325efae99d4beb03deb5">seaf_repo_manager_set_common_ancestor</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const char *repo_id, const char *common_ancestor, const char *head_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a5fe41fb7382995f3f335e408ba4ddb30">seaf_repo_manager_get_repo_list</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, int start, int limit)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#ae2b1438737e8d1bebeb1e674013b02b5">seaf_repo_manager_add_checkout_task</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, <a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, const char *worktree, <a class="el" href="daemon_2repo-mgr_8h.html#a699bd5e643ce774eaebfc58876713669">CheckoutDoneCallback</a> done_cb, void *cb_data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structCheckoutTask.html">CheckoutTask</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#abe8b32b343e5e7d2d06018e398011151">seaf_repo_manager_get_checkout_task</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a4f525e2d8e12d4d8afab74b4291c24d3">seaf_repo_manager_set_repo_email</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, <a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, const char *email)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a4fdafbeb326de99eec7160b72bcc3dd4">seaf_repo_manager_set_repo_token</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, <a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, const char *token)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#abbca41e16d1632518aedb8cbe31199b5">seaf_repo_manager_remove_repo_token</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, <a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a8539157b5ddbb1e183886ac3f03b0f0d">seaf_repo_manager_set_repo_relay_info</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *relay_addr, const char *relay_port)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a018177d17e765b6b8519f6537650e1cc">seaf_repo_manager_get_repo_relay_info</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, char **relay_addr, char **relay_port)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#aaca4b8f68d91db58fc8e1484d9695ce6">seaf_repo_manager_update_repo_relay_info</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, <a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, const char *new_addr, const char *new_port)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#ae3753999b4845dfe68bd6f098313280c">seaf_repo_manager_update_repos_server_host</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *old_host, const char *new_host, const char *new_server_url)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#abdf6d76830c08b16b49d76e2f34037a5">seaf_repo_load_ignore_files</a> (const char *worktree)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gboolean&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a32907bbaf9e2790699ddb7aaa97a3052">seaf_repo_check_ignore_file</a> (GList *ignore_list, const char *fullpath)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="daemon_2Backups_2repo-mgr_8c.html#ae640da4e7db6b316cd0e3c1ba463f9bd">seaf_repo_free_ignore_files</a> (GList *ignore_list)</td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a05d1af42442c934b555896d3fe55c79e"></a><!-- doxytag: member="repo&#45;mgr.c::DEBUG_FLAG" ref="a05d1af42442c934b555896d3fe55c79e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="user-mgr_8c.html#a05d1af42442c934b555896d3fe55c79e">DEBUG_FLAG</a>&#160;&#160;&#160;<a class="el" href="seafile-4_81_82_2common_2log_8h.html#ab0ef81bf7d4daa70c41b9e89e6543bfbaddde2b807762dde36d8143cb8d062bff">SEAFILE_DEBUG_SYNC</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00012">12</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>

</div>
</div>
<a class="anchor" id="a237e501289ed87ac7fb2bb3859e81cb0"></a><!-- doxytag: member="repo&#45;mgr.c::IGNORE_FILE" ref="a237e501289ed87ac7fb2bb3859e81cb0" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="daemon_2repo-mgr_8c.html#a237e501289ed87ac7fb2bb3859e81cb0">IGNORE_FILE</a>&#160;&#160;&#160;&quot;seafile-ignore.txt&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00035">35</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>

</div>
</div>
<a class="anchor" id="a823aa5bebe4b4b836619cae12751b8a5"></a><!-- doxytag: member="repo&#45;mgr.c::INDEX_DIR" ref="a823aa5bebe4b4b836619cae12751b8a5" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="repo-op_8c.html#a823aa5bebe4b4b836619cae12751b8a5">INDEX_DIR</a>&#160;&#160;&#160;&quot;index&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00034">34</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>

</div>
</div>
<a class="anchor" id="a67a7df7fa60be3209b087d86faaab360"></a><!-- doxytag: member="repo&#45;mgr.c::MAX_COMMIT_SIZE" ref="a67a7df7fa60be3209b087d86faaab360" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="daemon_2repo-mgr_8c.html#a67a7df7fa60be3209b087d86faaab360">MAX_COMMIT_SIZE</a>&#160;&#160;&#160;100 * (1 &lt;&lt; 20) /* 100MB */</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00901">901</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>

</div>
</div>
<a class="anchor" id="a4ee85b8b11bc0c69227a8c331a8d9d30"></a><!-- doxytag: member="repo&#45;mgr.c::UPDATE_CACHE_SIZE_LIMIT" ref="a4ee85b8b11bc0c69227a8c331a8d9d30" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="daemon_2repo-mgr_8c.html#a4ee85b8b11bc0c69227a8c331a8d9d30">UPDATE_CACHE_SIZE_LIMIT</a>&#160;&#160;&#160;100 * (1 &lt;&lt; 20) /* 100MB */</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l03454">3454</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>

</div>
</div>
<hr/><h2>Typedef Documentation</h2>
<a class="anchor" id="a484d651f14e66ed05ff54bab5793a695"></a><!-- doxytag: member="repo&#45;mgr.c::AddOptions" ref="a484d651f14e66ed05ff54bab5793a695" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct__AddOptions.html">_AddOptions</a>  <a class="el" href="daemon_2Backups_2repo-mgr_8c.html#a484d651f14e66ed05ff54bab5793a695">AddOptions</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a181f66e1d3900771c37883e97fea7fba"></a><!-- doxytag: member="repo&#45;mgr.c::checkout_empty_dir" ref="a181f66e1d3900771c37883e97fea7fba" args="(const char *worktree, const char *name, gint64 mtime, struct cache_entry *ce, GHashTable *conflict_hash, GHashTable *no_conflict_hash)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8c.html#a181f66e1d3900771c37883e97fea7fba">checkout_empty_dir</a> </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>worktree</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gint64&#160;</td>
          <td class="paramname"><em>mtime</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structcache__entry.html">cache_entry</a> *&#160;</td>
          <td class="paramname"><em>ce</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GHashTable *&#160;</td>
          <td class="paramname"><em>conflict_hash</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GHashTable *&#160;</td>
          <td class="paramname"><em>no_conflict_hash</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l03111">3111</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *path;
    gboolean case_conflict = FALSE;

<span class="preprocessor">#ifndef __linux__</span>
<span class="preprocessor"></span>    path = <a class="code" href="vc-utils_8h.html#a055d7e42fb7353b50b3a0a075e830fea">build_case_conflict_free_path</a> (worktree, <a class="code" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>,
                                          conflict_hash, no_conflict_hash,
                                          &amp;case_conflict,
                                          FALSE);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>    path = <a class="code" href="vc-utils_8h.html#a02eca597ddebd74fe744c41265969b02">build_checkout_path</a> (worktree, <a class="code" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>, strlen(<a class="code" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>));
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="keywordflow">if</span> (!path)
        <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;

    <span class="keywordflow">if</span> (!<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a1c2448a989efb1ce953a90f3db3c8042">seaf_util_exists</a> (path) &amp;&amp; <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a51aa6c51cc437a2766ca666660289bce">seaf_util_mkdir</a> (path, 0777) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;Failed to create empty dir %s in checkout.\n&quot;</span>, path);
        g_free (path);
        <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;
    }

    <span class="keywordflow">if</span> (<a class="code" href="index_8h.html#adb9fb1ca66f1a67516c2ee1492e6ab2b">mtime</a> != 0 &amp;&amp; <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#abc8dd3d83f54a07998aea73c4071d818">seaf_set_file_time</a> (path, <a class="code" href="index_8h.html#adb9fb1ca66f1a67516c2ee1492e6ab2b">mtime</a>) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;Failed to set mtime for %s.\n&quot;</span>, path);
    }

    <span class="keywordflow">if</span> (case_conflict) {
        ce-&gt;<a class="code" href="structcache__entry.html#a4dab14fd813a1bb6b67352674ff4afb2">ce_flags</a> |= <a class="code" href="index_8h.html#aa5ee599d9d7af67f19dba204ce9030c0">CE_REMOVE</a>;
        g_free (path);
        <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>;
    }

    <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (path, &amp;st);
    <a class="code" href="index_8c.html#a8225ef1fb93e6538cc4c632928516314">fill_stat_cache_info</a> (ce, &amp;st);

    g_free (path);
    <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a450e5bcc50da4c40b7ba2bde33a22a84"></a><!-- doxytag: member="repo&#45;mgr.c::checkout_file" ref="a450e5bcc50da4c40b7ba2bde33a22a84" args="(const char *repo_id, int repo_version, const char *worktree, const char *name, const char *file_id, gint64 mtime, unsigned int mode, SeafileCrypt *crypt, struct cache_entry *ce, TransferTask *task, HttpTxTask *http_task, gboolean is_http, const char *conflict_head_id, GHashTable *conflict_hash, GHashTable *no_conflict_hash, gboolean download_only)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8c.html#a450e5bcc50da4c40b7ba2bde33a22a84">checkout_file</a> </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>repo_version</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>worktree</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gint64&#160;</td>
          <td class="paramname"><em>mtime</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&#160;</td>
          <td class="paramname"><em>mode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structSeafileCrypt.html">SeafileCrypt</a> *&#160;</td>
          <td class="paramname"><em>crypt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structcache__entry.html">cache_entry</a> *&#160;</td>
          <td class="paramname"><em>ce</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="transfer-mgr_8h.html#ac3aaa1ec5e8dc2ac42d8d2b87ee8fcca">TransferTask</a> *&#160;</td>
          <td class="paramname"><em>task</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="http-tx-mgr_8h.html#a3ef685a6dcf2af7909e698d37b21d5e2">HttpTxTask</a> *&#160;</td>
          <td class="paramname"><em>http_task</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gboolean&#160;</td>
          <td class="paramname"><em>is_http</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>conflict_head_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GHashTable *&#160;</td>
          <td class="paramname"><em>conflict_hash</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GHashTable *&#160;</td>
          <td class="paramname"><em>no_conflict_hash</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gboolean&#160;</td>
          <td class="paramname"><em>download_only</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l02935">2935</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *path;
    <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st, st2;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="index_8h.html#a96e76167c968d38441e90ee0488ee4aa">sha1</a>[20];
    gboolean path_exists = FALSE;
    gboolean case_conflict = FALSE;
    gboolean force_conflict = FALSE;
    gboolean update_mode_only = FALSE;

<span class="preprocessor">#ifndef __linux__</span>
<span class="preprocessor"></span>    path = <a class="code" href="vc-utils_8h.html#a055d7e42fb7353b50b3a0a075e830fea">build_case_conflict_free_path</a> (worktree, <a class="code" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>,
                                          conflict_hash, no_conflict_hash,
                                          &amp;case_conflict,
                                          FALSE);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>    path = <a class="code" href="vc-utils_8h.html#a02eca597ddebd74fe744c41265969b02">build_checkout_path</a> (worktree, <a class="code" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>, strlen(<a class="code" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>));
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="keywordflow">if</span> (!path)
        <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;

    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a130e83c1ad29d78ef1a5b6baef1754d5">hex_to_rawdata</a> (file_id, sha1, 20);

    path_exists = (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (path, &amp;st) == 0);

    <span class="keywordflow">if</span> (path_exists &amp;&amp; S_ISREG(st.st_mode)) {
        <span class="keywordflow">if</span> (st.st_mtime == ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a>) {
            <span class="comment">/* Worktree and index are consistent. */</span>
            <span class="keywordflow">if</span> (memcmp (sha1, ce-&gt;<a class="code" href="structcache__entry.html#a119ab5c5e9db495e6e5f8d301f01421c">sha1</a>, 20) == 0) {
                <span class="keywordflow">if</span> (<a class="code" href="index_8h.html#ac1b4d694fc07a39e06900e82872aac7f">mode</a> == ce-&gt;<a class="code" href="structcache__entry.html#a5fcbcc4e7265ae8150f136380ed92c05">ce_mode</a>) {
                    <span class="comment">/* Worktree and index are all uptodate, no need to checkout.</span>
<span class="comment">                     * This may happen after an interrupted checkout.</span>
<span class="comment">                     */</span>
                    seaf_debug (<span class="stringliteral">&quot;wt and index are consistent. no need to checkout.\n&quot;</span>);
                    <span class="keywordflow">goto</span> update_cache;
                } <span class="keywordflow">else</span>
                    update_mode_only = TRUE;
            }
            <span class="comment">/* otherwise we have to checkout the file. */</span>
        } <span class="keywordflow">else</span> {
            <span class="keywordflow">if</span> (<a class="code" href="vc-utils_8c.html#afa0ef6de91f37ec2adcfbfa16a70e0d0">compare_file_content</a> (path, &amp;st, sha1, crypt, repo_version) == 0) {
                <span class="comment">/* This happens after the worktree file was updated,</span>
<span class="comment">                 * but the index was not. Just need to update the index.</span>
<span class="comment">                 */</span>
                seaf_debug (<span class="stringliteral">&quot;update index only.\n&quot;</span>);
                <span class="keywordflow">goto</span> update_cache;
            } <span class="keywordflow">else</span> {
                <span class="comment">/* Conflict. The worktree file was updated by the user. */</span>
                seaf_message (<span class="stringliteral">&quot;File %s is updated by user. &quot;</span>
                              <span class="stringliteral">&quot;Will checkout to conflict file later.\n&quot;</span>, path);
                force_conflict = TRUE;
            }
        }
    }

    <span class="keywordflow">if</span> (update_mode_only) {
<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>        g_free (path);
        <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>        chmod (path, <a class="code" href="index_8h.html#ac1b4d694fc07a39e06900e82872aac7f">mode</a> &amp; ~S_IFMT);
        ce-&gt;<a class="code" href="structcache__entry.html#a5fcbcc4e7265ae8150f136380ed92c05">ce_mode</a> = <a class="code" href="index_8h.html#ac1b4d694fc07a39e06900e82872aac7f">mode</a>;
        g_free (path);
        <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }

    <span class="comment">/* Download the blocks of this file. */</span>
    <span class="keywordtype">int</span> rc;
    <span class="keywordflow">if</span> (!is_http) {
        rc = <a class="code" href="transfer-mgr_8c.html#a760b69b5aa68dcb74c3020f091d1fc6c">seaf_transfer_manager_download_file_blocks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa04a8214ef989d1e5d68799dc19cbf22">transfer_mgr</a>,
                                                         task, file_id);
        <span class="keywordflow">switch</span> (rc) {
        <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87edda66f4cf8f7807f8038262d56bc42c61df">BLOCK_CLIENT_SUCCESS</a>:
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87edda961f855d617f8d1c95ffbe88a1729b23">BLOCK_CLIENT_UNKNOWN</a>:
        <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87eddab6ee07e1f93fd060c972725c7a5642a0">BLOCK_CLIENT_FAILED</a>:
        <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87edda77daa389ab8b27e7dfb05e61b181c643">BLOCK_CLIENT_NET_ERROR</a>:
        <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87edda879e124929511a9dbbcbba1efb527900">BLOCK_CLIENT_SERVER_ERROR</a>:
            g_free (path);
            <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a4a1718c70eba70651160111e48589161">FETCH_CHECKOUT_TRANSFER_ERROR</a>;
        <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87edda5176a3efc074d82147f6ad9aee27702b">BLOCK_CLIENT_CANCELED</a>:
            g_free (path);
            <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ae2a1e8d995b67343e5162cdb29513380">FETCH_CHECKOUT_CANCELED</a>;
        }
    } <span class="keywordflow">else</span> {
        rc = <a class="code" href="http-tx-mgr_8c.html#a3cdcb1e4f4996dabc1adb7ae742ddfb4">http_tx_task_download_file_blocks</a> (http_task, file_id);
        <span class="keywordflow">if</span> (http_task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>) {
            g_free (path);
            <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ae2a1e8d995b67343e5162cdb29513380">FETCH_CHECKOUT_CANCELED</a>;
        }
        <span class="keywordflow">if</span> (rc &lt; 0) {
            g_free (path);
            <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a4a1718c70eba70651160111e48589161">FETCH_CHECKOUT_TRANSFER_ERROR</a>;
        }
    }

    <span class="keywordflow">if</span> (download_only) {
        g_free (path);
        <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>;
    }

    <span class="comment">/* The worktree file may have been changed when we&#39;re downloading the blocks. */</span>
    <span class="keywordflow">if</span> (path_exists &amp;&amp; S_ISREG(st.st_mode) &amp;&amp; !force_conflict) {
        <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (path, &amp;st2);
        <span class="keywordflow">if</span> (st.st_mtime != st2.st_mtime) {
            seaf_message (<span class="stringliteral">&quot;File %s is updated by user. &quot;</span>
                          <span class="stringliteral">&quot;Will checkout to conflict file later.\n&quot;</span>, path);
            force_conflict = TRUE;
        }
    }

    <span class="comment">/* then checkout the file. */</span>
    gboolean conflicted = FALSE;
    <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#aa1e02fce35b0a00a0a65c37299865628">seaf_fs_manager_checkout_file</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                       repo_id,
                                       repo_version,
                                       file_id,
                                       path,
                                       <a class="code" href="index_8h.html#ac1b4d694fc07a39e06900e82872aac7f">mode</a>,
                                       <a class="code" href="index_8h.html#adb9fb1ca66f1a67516c2ee1492e6ab2b">mtime</a>,
                                       crypt,
                                       <a class="code" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>,
                                       conflict_head_id,
                                       force_conflict,
                                       &amp;conflicted) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;Failed to checkout file %s.\n&quot;</span>, path);
        g_free (path);
        <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;
    }

    <span class="comment">/* If case conflict, this file has been checked out to another path.</span>
<span class="comment">     * Remove the current entry, otherwise it won&#39;t be removed later</span>
<span class="comment">     * since it&#39;s timestamp is 0.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (case_conflict) {
        ce-&gt;<a class="code" href="structcache__entry.html#a4dab14fd813a1bb6b67352674ff4afb2">ce_flags</a> |= <a class="code" href="index_8h.html#aa5ee599d9d7af67f19dba204ce9030c0">CE_REMOVE</a>;
        g_free (path);
        <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>;
    }

    <span class="keywordflow">if</span> (conflicted) {
        g_free (path);
        <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>;
    }

update_cache:
    <span class="comment">/* finally fill cache_entry info */</span>
    <span class="comment">/* Only update index if we checked out the file without any error</span>
<span class="comment">     * or conflicts. The timestamp of the entry will remain 0 if error</span>
<span class="comment">     * or conflicted.</span>
<span class="comment">     */</span>
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (path, &amp;st);
    <a class="code" href="index_8c.html#a8225ef1fb93e6538cc4c632928516314">fill_stat_cache_info</a> (ce, &amp;st);

    g_free (path);
    <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a16e4a5db024bcc5baf2ef8a3f0623a41"></a><!-- doxytag: member="repo&#45;mgr.c::folder_perm_free" ref="a16e4a5db024bcc5baf2ef8a3f0623a41" args="(FolderPerm *perm)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="daemon_2repo-mgr_8h.html#a16e4a5db024bcc5baf2ef8a3f0623a41">folder_perm_free</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a56a1cab242a6825a469495e61c711aa6">FolderPerm</a> *&#160;</td>
          <td class="paramname"><em>perm</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00283">283</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (!perm)
        <span class="keywordflow">return</span>;

    g_free (perm-&gt;<a class="code" href="struct__FolderPerm.html#a1d44107695fb128bdc7de3a224a69d42">path</a>);
    g_free (perm-&gt;<a class="code" href="struct__FolderPerm.html#a5032277d09756796f0d26e373383dac6">permission</a>);
    g_free (perm);
}
</pre></div>
</div>
</div>
<a class="anchor" id="af73ee61bbe7c459c590af5aa523bfec4"></a><!-- doxytag: member="repo&#45;mgr.c::folder_perm_new" ref="af73ee61bbe7c459c590af5aa523bfec4" args="(const char *path, const char *permission)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="daemon_2repo-mgr_8h.html#a56a1cab242a6825a469495e61c711aa6">FolderPerm</a>* <a class="el" href="daemon_2repo-mgr_8c.html#af73ee61bbe7c459c590af5aa523bfec4">folder_perm_new</a> </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>permission</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00272">272</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__FolderPerm.html">FolderPerm</a> *perm = g_new0 (<a class="code" href="struct__FolderPerm.html">FolderPerm</a>, 1);

    perm-&gt;<a class="code" href="struct__FolderPerm.html#a1d44107695fb128bdc7de3a224a69d42">path</a> = g_strdup(path);
    perm-&gt;<a class="code" href="struct__FolderPerm.html#a5032277d09756796f0d26e373383dac6">permission</a> = g_strdup(permission);

    <span class="keywordflow">return</span> perm;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a35ce9f51287bbd5f961c261516c1c5f0"></a><!-- doxytag: member="repo&#45;mgr.c::is_repo_id_valid" ref="a35ce9f51287bbd5f961c261516c1c5f0" args="(const char *id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gboolean <a class="el" href="server_2repo-mgr_8h.html#a35ce9f51287bbd5f961c261516c1c5f0">is_repo_id_valid</a> </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00527">527</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (!<span class="keywordtype">id</span>)
        <span class="keywordflow">return</span> FALSE;

    <span class="keywordflow">return</span> <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a48ecdc72b727191abafbbf2ec1f70ace">is_uuid_valid</a> (<span class="keywordtype">id</span>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a8782ae78d069d4073a35d981b04a2a88"></a><!-- doxytag: member="repo&#45;mgr.c::locked_file_set_add_update" ref="a8782ae78d069d4073a35d981b04a2a88" args="(LockedFileSet *fset, const char *path, const char *operation, gint64 old_mtime, const char *file_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#a8782ae78d069d4073a35d981b04a2a88">locked_file_set_add_update</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#adccaa653ef97d8570cac74163af03002">LockedFileSet</a> *&#160;</td>
          <td class="paramname"><em>fset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>operation</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gint64&#160;</td>
          <td class="paramname"><em>old_mtime</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00149">149</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = fset-&gt;<a class="code" href="struct__LockedFileSet.html#ae599e7470165a7f4eaaaefad7bb85c5f">mgr</a>;
    <span class="keywordtype">char</span> *sql;
    sqlite3_stmt *stmt;
    <a class="code" href="struct__LockedFile.html">LockedFile</a> *file;
    gboolean exists;

    exists = (g_hash_table_lookup (fset-&gt;<a class="code" href="struct__LockedFileSet.html#a228bfd2b438cfa59fcf2dbd596ce335a">locked_files</a>, path) != NULL);

    pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="keywordflow">if</span> (!exists) {
        seaf_debug (<span class="stringliteral">&quot;New locked file record %.8s, %s, %s, %&quot;</span>
                    G_GINT64_FORMAT<span class="stringliteral">&quot;.\n&quot;</span>,
                    fset-&gt;<a class="code" href="struct__LockedFileSet.html#ae51031b45e0a18e92898ce33bef301fe">repo_id</a>, path, operation, old_mtime);

        sql = <span class="stringliteral">&quot;INSERT INTO LockedFiles VALUES (?, ?, ?, ?, ?, NULL)&quot;</span>;
        stmt = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a4d1d0eb407f8f5dd522c3875beb7b9c8">sqlite_query_prepare</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
        sqlite3_bind_text (stmt, 1, fset-&gt;<a class="code" href="struct__LockedFileSet.html#ae51031b45e0a18e92898ce33bef301fe">repo_id</a>, -1, SQLITE_TRANSIENT);
        sqlite3_bind_text (stmt, 2, path, -1, SQLITE_TRANSIENT);
        sqlite3_bind_text (stmt, 3, operation, -1, SQLITE_TRANSIENT);
        sqlite3_bind_int64 (stmt, 4, old_mtime);
        sqlite3_bind_text (stmt, 5, file_id, -1, SQLITE_TRANSIENT);
        <span class="keywordflow">if</span> (sqlite3_step (stmt) != SQLITE_DONE) {
            seaf_warning (<span class="stringliteral">&quot;Failed to insert locked file %s to db: %s.\n&quot;</span>,
                          path, sqlite3_errmsg (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>));
            sqlite3_finalize (stmt);
            pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
            <span class="keywordflow">return</span> -1;
        }
        sqlite3_finalize (stmt);

        file = g_new0 (<a class="code" href="struct__LockedFile.html">LockedFile</a>, 1);
        file-&gt;<a class="code" href="struct__LockedFile.html#abdcab3c93928ff7a61146d497d5e4ec7">operation</a> = g_strdup(operation);
        file-&gt;<a class="code" href="struct__LockedFile.html#a1e6ec2e3b09c05236c6898df5dc77475">old_mtime</a> = old_mtime;
        <span class="keywordflow">if</span> (file_id)
            memcpy (file-&gt;<a class="code" href="struct__LockedFile.html#aebea73a3294e0a1493195022ffce6f23">file_id</a>, file_id, 40);

        g_hash_table_insert (fset-&gt;<a class="code" href="struct__LockedFileSet.html#a228bfd2b438cfa59fcf2dbd596ce335a">locked_files</a>, g_strdup(path), file);
    } <span class="keywordflow">else</span> {
        seaf_debug (<span class="stringliteral">&quot;Update locked file record %.8s, %s, %s.\n&quot;</span>,
                    fset-&gt;<a class="code" href="struct__LockedFileSet.html#ae51031b45e0a18e92898ce33bef301fe">repo_id</a>, path, operation);

        <span class="comment">/* If a UPDATE record exists, don&#39;t update the old_mtime.</span>
<span class="comment">         * We need to keep the old mtime when the locked file was first detected.</span>
<span class="comment">         */</span>

        sql = <span class="stringliteral">&quot;UPDATE LockedFiles SET operation = ?, file_id = ? &quot;</span>
            <span class="stringliteral">&quot;WHERE repo_id = ? AND path = ?&quot;</span>;
        stmt = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a4d1d0eb407f8f5dd522c3875beb7b9c8">sqlite_query_prepare</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
        sqlite3_bind_text (stmt, 1, operation, -1, SQLITE_TRANSIENT);
        sqlite3_bind_text (stmt, 2, file_id, -1, SQLITE_TRANSIENT);
        sqlite3_bind_text (stmt, 3, fset-&gt;<a class="code" href="struct__LockedFileSet.html#ae51031b45e0a18e92898ce33bef301fe">repo_id</a>, -1, SQLITE_TRANSIENT);
        sqlite3_bind_text (stmt, 4, path, -1, SQLITE_TRANSIENT);
        <span class="keywordflow">if</span> (sqlite3_step (stmt) != SQLITE_DONE) {
            seaf_warning (<span class="stringliteral">&quot;Failed to update locked file %s to db: %s.\n&quot;</span>,
                          path, sqlite3_errmsg (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>));
            sqlite3_finalize (stmt);
            pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
            <span class="keywordflow">return</span> -1;
        }
        sqlite3_finalize (stmt);

        file = g_hash_table_lookup (fset-&gt;<a class="code" href="struct__LockedFileSet.html#a228bfd2b438cfa59fcf2dbd596ce335a">locked_files</a>, path);
        g_free (file-&gt;<a class="code" href="struct__LockedFile.html#abdcab3c93928ff7a61146d497d5e4ec7">operation</a>);
        file-&gt;<a class="code" href="struct__LockedFile.html#abdcab3c93928ff7a61146d497d5e4ec7">operation</a> = g_strdup(operation);
        <span class="keywordflow">if</span> (file_id)
            memcpy (file-&gt;<a class="code" href="struct__LockedFile.html#aebea73a3294e0a1493195022ffce6f23">file_id</a>, file_id, 40);
    }

    pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ab44c57f5e23996e5eb807f7c84f443f5"></a><!-- doxytag: member="repo&#45;mgr.c::locked_file_set_free" ref="ab44c57f5e23996e5eb807f7c84f443f5" args="(LockedFileSet *fset)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="daemon_2repo-mgr_8h.html#ab44c57f5e23996e5eb807f7c84f443f5">locked_file_set_free</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#adccaa653ef97d8570cac74163af03002">LockedFileSet</a> *&#160;</td>
          <td class="paramname"><em>fset</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00140">140</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (!fset)
        <span class="keywordflow">return</span>;
    g_hash_table_destroy (fset-&gt;<a class="code" href="struct__LockedFileSet.html#a228bfd2b438cfa59fcf2dbd596ce335a">locked_files</a>);
    g_free (fset);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a818fec9b8684b386170e39cfe5feff55"></a><!-- doxytag: member="repo&#45;mgr.c::locked_file_set_lookup" ref="a818fec9b8684b386170e39cfe5feff55" args="(LockedFileSet *fset, const char *path)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="daemon_2repo-mgr_8h.html#a12a39343dc26a7f7692652fc43b2d3cb">LockedFile</a>* <a class="el" href="daemon_2repo-mgr_8h.html#a818fec9b8684b386170e39cfe5feff55">locked_file_set_lookup</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#adccaa653ef97d8570cac74163af03002">LockedFileSet</a> *&#160;</td>
          <td class="paramname"><em>fset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>path</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00264">264</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">return</span> (<a class="code" href="struct__LockedFile.html">LockedFile</a> *) g_hash_table_lookup (fset-&gt;<a class="code" href="struct__LockedFileSet.html#a228bfd2b438cfa59fcf2dbd596ce335a">locked_files</a>, path);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a4d1dacc802b818970800154a9bc6e3db"></a><!-- doxytag: member="repo&#45;mgr.c::locked_file_set_remove" ref="a4d1dacc802b818970800154a9bc6e3db" args="(LockedFileSet *fset, const char *path, gboolean db_only)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#a4d1dacc802b818970800154a9bc6e3db">locked_file_set_remove</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#adccaa653ef97d8570cac74163af03002">LockedFileSet</a> *&#160;</td>
          <td class="paramname"><em>fset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gboolean&#160;</td>
          <td class="paramname"><em>db_only</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00230">230</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = fset-&gt;<a class="code" href="struct__LockedFileSet.html#ae599e7470165a7f4eaaaefad7bb85c5f">mgr</a>;
    <span class="keywordtype">char</span> *sql;
    sqlite3_stmt *stmt;

    <span class="keywordflow">if</span> (g_hash_table_lookup (fset-&gt;<a class="code" href="struct__LockedFileSet.html#a228bfd2b438cfa59fcf2dbd596ce335a">locked_files</a>, path) == NULL)
        <span class="keywordflow">return</span> 0;

    seaf_debug (<span class="stringliteral">&quot;Remove locked file record %.8s, %s.\n&quot;</span>,
                fset-&gt;<a class="code" href="struct__LockedFileSet.html#ae51031b45e0a18e92898ce33bef301fe">repo_id</a>, path);

    pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    sql = <span class="stringliteral">&quot;DELETE FROM LockedFiles WHERE repo_id = ? AND path = ?&quot;</span>;
    stmt = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a4d1d0eb407f8f5dd522c3875beb7b9c8">sqlite_query_prepare</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
    sqlite3_bind_text (stmt, 1, fset-&gt;<a class="code" href="struct__LockedFileSet.html#ae51031b45e0a18e92898ce33bef301fe">repo_id</a>, -1, SQLITE_TRANSIENT);
    sqlite3_bind_text (stmt, 2, path, -1, SQLITE_TRANSIENT);
    <span class="keywordflow">if</span> (sqlite3_step (stmt) != SQLITE_DONE) {
        seaf_warning (<span class="stringliteral">&quot;Failed to remove locked file %s from db: %s.\n&quot;</span>,
                      path, sqlite3_errmsg (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>));
        sqlite3_finalize (stmt);
        pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
        <span class="keywordflow">return</span> -1;
    }
    sqlite3_finalize (stmt);
    pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    g_hash_table_remove (fset-&gt;<a class="code" href="struct__LockedFileSet.html#a228bfd2b438cfa59fcf2dbd596ce335a">locked_files</a>, path);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a32907bbaf9e2790699ddb7aaa97a3052"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_check_ignore_file" ref="a32907bbaf9e2790699ddb7aaa97a3052" args="(GList *ignore_list, const char *fullpath)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gboolean <a class="el" href="daemon_2repo-mgr_8h.html#a32907bbaf9e2790699ddb7aaa97a3052">seaf_repo_check_ignore_file</a> </td>
          <td>(</td>
          <td class="paramtype">GList *&#160;</td>
          <td class="paramname"><em>ignore_list</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>fullpath</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l05480">5480</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *str;
    <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
    GPatternSpec *ignore_spec;
    GList *p;

    str = g_strdup(fullpath);

    <span class="comment">/* first check the path is a reg file or a dir */</span>
    <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a>(str, &amp;st) &lt; 0) {
        g_free(str);
        <span class="keywordflow">return</span> FALSE;
    }
    <span class="keywordflow">if</span> (S_ISDIR(st.st_mode)) {
        g_free(str);
        str = g_strconcat (fullpath, <span class="stringliteral">&quot;/&quot;</span>, NULL);
    }

    <span class="keywordflow">for</span> (p = ignore_list; p != NULL; p = p-&gt;next) {
        <span class="keywordtype">char</span> *pattern = (<span class="keywordtype">char</span> *)p-&gt;data;

        ignore_spec = g_pattern_spec_new(pattern);
        <span class="keywordflow">if</span> (g_pattern_match_string(ignore_spec, str)) {
            g_free (str);
            g_pattern_spec_free(ignore_spec);
            <span class="keywordflow">return</span> TRUE;
        }
        g_pattern_spec_free(ignore_spec);
    }

    g_free (str);
    <span class="keywordflow">return</span> FALSE;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad1200d69d8e6219885da4e85af15dca2"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_check_worktree" ref="ad1200d69d8e6219885da4e85af15dca2" args="(SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#ad1200d69d8e6219885da4e85af15dca2">seaf_repo_check_worktree</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00559">559</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;

    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a> == NULL) {
        seaf_warning (<span class="stringliteral">&quot;Worktree for repo &#39;%s&#39;(%.8s) is not set.\n&quot;</span>,
                      repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
        <span class="keywordflow">return</span> -1;
    }

    <span class="comment">/* check repo worktree */</span>
    <span class="keywordflow">if</span> (g_access(repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, F_OK) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;Failed to access worktree %s for repo &#39;%s&#39;(%.8s)\n&quot;</span>,
                      repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
        <span class="keywordflow">return</span> -1;
    }
    <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, &amp;st) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;Failed to stat worktree %s for repo &#39;%s&#39;(%.8s)\n&quot;</span>,
                      repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
        <span class="keywordflow">return</span> -1;
    }
    <span class="keywordflow">if</span> (!S_ISDIR(st.st_mode)) {
        seaf_warning (<span class="stringliteral">&quot;Worktree %s for repo &#39;%s&#39;(%.8s) is not a directory.\n&quot;</span>,
                      repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
        <span class="keywordflow">return</span> -1;
    }

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a888b4c185cc198eaf4eb7d4d3b8e9054"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_checkout" ref="a888b4c185cc198eaf4eb7d4d3b8e9054" args="(SeafRepo *repo, const char *worktree, char **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#ab553f7b1a5290e99821753acf9e87c86">seaf_repo_checkout</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>worktree</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Checkout the content of "local" branch to &lt;worktree_parent&gt;/repo-name. The worktree will be set to this place too. </p>

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l02823">2823</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">const</span> <span class="keywordtype">char</span> *commit_id;
    <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit;
    GString *err_msgs;

    <span class="comment">/* remove original index */</span>
    <span class="keywordtype">char</span> <a class="code" href="index_8c.html#a35caece3e3575d32521f820a8f0a24a7">index_path</a>[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    snprintf (index_path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a26f091009701c5a9d1886b9d6ceb9c8e">seaf_util_unlink</a> (index_path);

    branch = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>,
                                             repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="stringliteral">&quot;local&quot;</span>);
    <span class="keywordflow">if</span> (!branch) {
        g_warning (<span class="stringliteral">&quot;[repo-mgr] Checkout repo failed: local branch does not exists\n&quot;</span>);
        *error = g_strdup (<span class="stringliteral">&quot;Repo&#39;s local branch does not exists.&quot;</span>);
        <span class="keywordflow">goto</span> error;
    }
    commit_id = branch-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>;
        
    commit = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                             repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
                                             repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                             commit_id);
    <span class="keywordflow">if</span> (!commit) {
        err_msgs = g_string_new (<span class="stringliteral">&quot;&quot;</span>);
        g_string_append_printf (err_msgs, <span class="stringliteral">&quot;Commit %s does not exist.\n&quot;</span>,
                                commit_id);
        g_warning (<span class="stringliteral">&quot;%s&quot;</span>, err_msgs-&gt;str);
        *error = g_string_free (err_msgs, FALSE);
        <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
        <span class="keywordflow">goto</span> error;
    }

    <span class="keywordflow">if</span> (strcmp(repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#af9c51057516029191941d47985df7f5f">repo_id</a>) != 0) {
        err_msgs = g_string_new (<span class="stringliteral">&quot;&quot;</span>);
        g_string_append_printf (err_msgs, <span class="stringliteral">&quot;Commit %s is not in Repo %s.\n&quot;</span>, 
                                commit_id, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
        g_warning (<span class="stringliteral">&quot;%s&quot;</span>, err_msgs-&gt;str);
        *error = g_string_free (err_msgs, FALSE);
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
        <span class="keywordflow">if</span> (branch)
            <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
        <span class="keywordflow">goto</span> error;
    }

    <a class="code" href="structCheckoutTask.html">CheckoutTask</a> *task = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#abe8b32b343e5e7d2d06018e398011151">seaf_repo_manager_get_checkout_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
                                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
    <span class="keywordflow">if</span> (!task) {
        seaf_warning (<span class="stringliteral">&quot;No checkout task found for repo %.10s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
        <span class="keywordflow">goto</span> error;
    }
    task-&gt;<a class="code" href="structCheckoutTask.html#a91c93d2e31b4ce625dcfd7e98a0b1c4f">total_files</a> = <a class="code" href="fs-mgr_8c.html#afa141245d62ac11820ad120fef68d01e">seaf_fs_manager_count_fs_files</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                                        repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                        commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>);

    <span class="keywordflow">if</span> (task-&gt;<a class="code" href="structCheckoutTask.html#a91c93d2e31b4ce625dcfd7e98a0b1c4f">total_files</a> &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;Failed to count files for repo %.10s .\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
        <span class="keywordflow">goto</span> error;
    }

    <span class="keywordflow">if</span> (<a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a7923c5fb7b957a121f1b2616a8d66745">seaf_repo_checkout_commit</a> (repo, commit, FALSE, error) &lt; 0) {
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
        <span class="keywordflow">if</span> (branch)
            <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
        <span class="keywordflow">goto</span> error;
    }

    <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
    <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);

    <span class="keywordflow">return</span> 0;

error:
    <span class="keywordflow">return</span> -1;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a7923c5fb7b957a121f1b2616a8d66745"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_checkout_commit" ref="a7923c5fb7b957a121f1b2616a8d66745" args="(SeafRepo *repo, SeafCommit *commit, gboolean recover_merge, char **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#a7923c5fb7b957a121f1b2616a8d66745">seaf_repo_checkout_commit</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="commit-mgr_8h.html#ab20cfcee12e164d94824e8be23c2c8ea">SeafCommit</a> *&#160;</td>
          <td class="paramname"><em>commit</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gboolean&#160;</td>
          <td class="paramname"><em>recover_merge</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l02702">2702</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>;
    <span class="keywordtype">char</span> <a class="code" href="index_8c.html#a35caece3e3575d32521f820a8f0a24a7">index_path</a>[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keyword">struct </span><a class="code" href="structtree__desc.html">tree_desc</a> trees[2];
    <span class="keyword">struct </span><a class="code" href="structunpack__trees__options.html">unpack_trees_options</a> topts;
    <span class="keyword">struct </span><a class="code" href="structindex__state.html">index_state</a> istate;
    gboolean initial_checkout;
    GString *err_msgs;
    <span class="keywordtype">int</span> ret = 0;

    memset (&amp;istate, 0, <span class="keyword">sizeof</span>(istate));
    snprintf (index_path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
    <span class="keywordflow">if</span> (<a class="code" href="index_8c.html#a0f9de2761514c9136fb4b9c5541ef6f8">read_index_from</a> (&amp;istate, index_path, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;Failed to load index.\n&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a5377f474b9e1cc96a69ab26d5da8e244">index_corrupted</a> = FALSE;
    initial_checkout = <a class="code" href="index_8c.html#a9527d61c2cbd37e4f1691dfc0f543a5d">is_index_unborn</a>(&amp;istate);

    <span class="keywordflow">if</span> (!initial_checkout) {
        <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>) {
            <span class="comment">/* TODO: Set error string*/</span>
            g_warning (<span class="stringliteral">&quot;Repo corrupt: Index exists but head branch is not set\n&quot;</span>);
            <span class="keywordflow">return</span> -1;
        }
        <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head =
            <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                            repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                            repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
        <span class="keywordflow">if</span> (!head) {
            seaf_warning (<span class="stringliteral">&quot;Failed to get commit %s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
            <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
            <span class="keywordflow">return</span> -1;
        }
        <a class="code" href="seaf-tree-walk_8c.html#a7b310abaeb185b8918eb2a9fc843e097">fill_tree_descriptor</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, &amp;trees[0], head-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>);
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (head);
    } <span class="keywordflow">else</span> {
        <a class="code" href="seaf-tree-walk_8c.html#a7b310abaeb185b8918eb2a9fc843e097">fill_tree_descriptor</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, &amp;trees[0], NULL);
    }
    <a class="code" href="seaf-tree-walk_8c.html#a7b310abaeb185b8918eb2a9fc843e097">fill_tree_descriptor</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, &amp;trees[1], commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>);

    <span class="comment">/* 2-way merge to the new branch */</span>
    memset(&amp;topts, 0, <span class="keyword">sizeof</span>(topts));
    memcpy (topts.repo_id, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, 36);
    topts.version = repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>;
    topts.base = repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>;
    topts.head_idx = -1;
    topts.src_index = &amp;istate;
    <span class="comment">/* topts.dst_index = &amp;istate; */</span>
    topts.initial_checkout = initial_checkout;
    topts.update = 1;
    topts.merge = 1;
    topts.gently = 0;
    topts.verbose_update = 0;
    <span class="comment">/* topts.debug_unpack = 1; */</span>
    topts.fn = <a class="code" href="unpack-trees_8c.html#a37f4950a59ff1ce85ed1bf91eeea7054">twoway_merge</a>;
    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
        topts.crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>, 
                                         repo-&gt;<a class="code" href="struct__SeafRepo.html#ad951f63e287f0ea14c863937afea6779">enc_key</a>, 
                                         repo-&gt;<a class="code" href="struct__SeafRepo.html#a7ad105e1fab206035f1c585c25e0dc94">enc_iv</a>);
    }

    <span class="keywordflow">if</span> (<a class="code" href="unpack-trees_8c.html#a5bfe365644fb33537027e988fb891e08">unpack_trees</a> (2, trees, &amp;topts) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;Failed to merge commit %s with work tree.\n&quot;</span>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (!initial_checkout &amp;&amp; !recover_merge &amp;&amp;
        <a class="code" href="vc-utils_8h.html#a60f3e68c113c902bbc43e308317a259e">files_locked_on_windows</a>(&amp;topts.result, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>)) {
        <a class="code" href="seafile-4_81_82_2lib_2include_8h.html#ae5a5c3cadbc1f6e2363d25fc0fb46084">g_debug</a> (<span class="stringliteral">&quot;[checkout] files are locked, quit checkout now.\n&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="keywordtype">int</span> *finished_entries = NULL;
    <a class="code" href="structCheckoutTask.html">CheckoutTask</a> *c_task = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#abe8b32b343e5e7d2d06018e398011151">seaf_repo_manager_get_checkout_task</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
    <span class="keywordflow">if</span> (c_task) {
        finished_entries = &amp;c_task-&gt;<a class="code" href="structCheckoutTask.html#a870604697553d88bc67e5a3b4ef0549b">finished_files</a>;
    }
    <span class="keywordflow">if</span> (<a class="code" href="vc-utils_8c.html#a4b8dc271b94740a5cb1e32827ee88d29">update_worktree</a> (&amp;topts, recover_merge,
                         initial_checkout ? NULL : commit-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>,
                         commit-&gt;<a class="code" href="struct__SeafCommit.html#ab19d020b7c936d11821fe0b836aa548e">creator_name</a>,
                         finished_entries) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;Failed to update worktree.\n&quot;</span>);
        <span class="comment">/* Still finish checkout even have I/O errors. */</span>
    }

    <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
    istate = topts.result;
    <span class="keywordflow">if</span> (<a class="code" href="vc-utils_8c.html#ab93fff6b962d6fd7482c95d17c8bf6eb">update_index</a> (&amp;istate, index_path) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;Failed to update index.\n&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

out:
    err_msgs = g_string_new (<span class="stringliteral">&quot;&quot;</span>);
    <a class="code" href="unpack-trees_8c.html#a795a271a95b2bc0ef892ee87f48a0c62">get_unpack_trees_error_msgs</a> (&amp;topts, err_msgs, <a class="code" href="unpack-trees_8h.html#abed82baf7f470b522273a3e37c24c600af3d4fc3232b5bb0490577270e80493c6">OPR_CHECKOUT</a>);
    *error = g_string_free (err_msgs, FALSE);

    tree_desc_free (&amp;trees[0]);
    tree_desc_free (&amp;trees[1]);

    g_free (topts.crypt);

    <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a3ae125d7fd328d8d141dc38710ffd24e"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_fetch_and_checkout" ref="a3ae125d7fd328d8d141dc38710ffd24e" args="(TransferTask *task, HttpTxTask *http_task, gboolean is_http, const char *remote_head_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#a836678a67f23541ed108f922f0848e52">seaf_repo_fetch_and_checkout</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="transfer-mgr_8h.html#ac3aaa1ec5e8dc2ac42d8d2b87ee8fcca">TransferTask</a> *&#160;</td>
          <td class="paramname"><em>task</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="http-tx-mgr_8h.html#a3ef685a6dcf2af7909e698d37b21d5e2">HttpTxTask</a> *&#160;</td>
          <td class="paramname"><em>http_task</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gboolean&#160;</td>
          <td class="paramname"><em>is_http</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>remote_head_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l03457">3457</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *repo_id;
    <span class="keywordtype">int</span> repo_version;
    gboolean is_clone;
    <span class="keywordtype">char</span> *worktree;
    <span class="keywordtype">char</span> *passwd;

    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *master = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *remote_head = NULL, *master_head = NULL;
    <span class="keywordtype">char</span> <a class="code" href="index_8c.html#a35caece3e3575d32521f820a8f0a24a7">index_path</a>[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keyword">struct </span><a class="code" href="structindex__state.html">index_state</a> istate;
    <span class="keywordtype">int</span> ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>;
    GList *results = NULL;
    <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt = NULL;
    GHashTable *conflict_hash = NULL, *no_conflict_hash = NULL;
    GList *ignore_list = NULL;
    <a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset = NULL;

    <span class="keywordflow">if</span> (is_http) {
        repo_id = http_task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>;
        repo_version = http_task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>;
        is_clone = http_task-&gt;<a class="code" href="struct__HttpTxTask.html#a8dc7ba305c249ab73ce9424725776d41">is_clone</a>;
        worktree = http_task-&gt;<a class="code" href="struct__HttpTxTask.html#aa3f98febcc990a1b3ac304baa0f7d800">worktree</a>;
        passwd = http_task-&gt;<a class="code" href="struct__HttpTxTask.html#a1a4bf0844a0d15f8128fbaa521e649f1">passwd</a>;
    } <span class="keywordflow">else</span> {
        repo_id = task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>;
        repo_version = task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>;
        is_clone = task-&gt;<a class="code" href="struct__TransferTask.html#a4462883da6780feae2b41060e5b48456">is_clone</a>;
        worktree = task-&gt;<a class="code" href="struct__TransferTask.html#a0a8e92f99b30194a9e2315f3b70b5c13">worktree</a>;
        passwd = task-&gt;<a class="code" href="struct__TransferTask.html#a5d04ab09b9dd283c65cb78d1918164b2">passwd</a>;
    }

    memset (&amp;istate, 0, <span class="keyword">sizeof</span>(istate));
    snprintf (index_path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>,
              <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>, repo_id);
    <span class="keywordflow">if</span> (<a class="code" href="index_8c.html#a0f9de2761514c9136fb4b9c5541ef6f8">read_index_from</a> (&amp;istate, index_path, repo_version) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;Failed to load index.\n&quot;</span>);
        <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;
    }

    <span class="keywordflow">if</span> (!is_clone) {
        repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id);
        <span class="keywordflow">if</span> (!repo) {
            seaf_warning (<span class="stringliteral">&quot;Failed to get repo %.8s.\n&quot;</span>, repo_id);
            <span class="keywordflow">goto</span> out;
        }

        master = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>,
                                                 repo_id, <span class="stringliteral">&quot;master&quot;</span>);
        <span class="keywordflow">if</span> (!master) {
            seaf_warning (<span class="stringliteral">&quot;Failed to get master branch for repo %.8s.\n&quot;</span>,
                          repo_id);
            ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;
            <span class="keywordflow">goto</span> out;
        }

        master_head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                                      repo_id,
                                                      repo_version,
                                                      master-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
        <span class="keywordflow">if</span> (!master_head) {
            seaf_warning (<span class="stringliteral">&quot;Failed to get master head %s of repo %.8s.\n&quot;</span>,
                          repo_id, master-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
            ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;
            <span class="keywordflow">goto</span> out;
        }
    }

    <span class="keywordflow">if</span> (!is_clone)
        worktree = repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>;

    remote_head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                                  repo_id,
                                                  repo_version,
                                                  remote_head_id);
    <span class="keywordflow">if</span> (!remote_head) {
        seaf_warning (<span class="stringliteral">&quot;Failed to get remote head %s of repo %.8s.\n&quot;</span>,
                      repo_id, remote_head_id);
        ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (<a class="code" href="diff-simple_8c.html#a76134c9482b81d9ff5455eac2765a656">diff_commit_roots</a> (repo_id, repo_version,
                           master_head ? master_head-&gt;root_id : <a class="code" href="seafile-4_81_82_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>,
                           remote_head-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                           &amp;results, TRUE) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;Failed to diff for repo %.8s.\n&quot;</span>, repo_id);
        ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;
        <span class="keywordflow">goto</span> out;
    }

    GList *ptr;
    <a class="code" href="structDiffEntry.html">DiffEntry</a> *de;

    <span class="comment">/* Expand DIR_ADDED diff entries. */</span>
    <span class="keywordflow">if</span> (expand_diff_results (repo_id, repo_version,
                             remote_head-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                             master_head ? master_head-&gt;root_id : EMPTY_SHA1,
                             &amp;results) &lt; 0) {
        ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;
        <span class="keywordflow">goto</span> out;
    }

<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>    <span class="keywordflow">for</span> (ptr = results; ptr; ptr = ptr-&gt;next) {
        de = ptr-&gt;data;
        <span class="keywordflow">if</span> (de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a7ebaae7e72a366dbc3aba360e5e9957c">DIFF_STATUS_DIR_RENAMED</a> ||
            de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a820629607c6c8a44530724c2c9bc4974">DIFF_STATUS_DIR_DELETED</a>) {
            <span class="keywordflow">if</span> (<a class="code" href="vc-utils_8h.html#a88a07e43e3943080e6105849af3658eb">do_check_dir_locked</a> (de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, worktree)) {
                seaf_message (<span class="stringliteral">&quot;File(s) in dir %s are locked by other program, &quot;</span>
                              <span class="stringliteral">&quot;skip rename/delete.\n&quot;</span>, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);
                ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a662e1ae03ecdd8c6d02c7195e332d3ce">FETCH_CHECKOUT_LOCKED</a>;
                <span class="keywordflow">goto</span> out;
            }
        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#abcf4512ebeae34bfed839057e70a72c2">DIFF_STATUS_RENAMED</a>) {
            <span class="keywordflow">if</span> (<a class="code" href="vc-utils_8h.html#ade755cc297b064bd93b1527533979454">do_check_file_locked</a> (de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, worktree)) {
                seaf_message (<span class="stringliteral">&quot;File %s is locked by other program, skip rename.\n&quot;</span>,
                              de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);
                ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a662e1ae03ecdd8c6d02c7195e332d3ce">FETCH_CHECKOUT_LOCKED</a>;
                <span class="keywordflow">goto</span> out;
            }
        }
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="keywordflow">if</span> (remote_head-&gt;<a class="code" href="struct__SeafCommit.html#a906e77d2a658f4337437ff8694a4bfc0">encrypted</a>) {
        <span class="keywordflow">if</span> (!is_clone) {
            crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>,
                                       repo-&gt;<a class="code" href="struct__SeafRepo.html#ad951f63e287f0ea14c863937afea6779">enc_key</a>,
                                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a7ad105e1fab206035f1c585c25e0dc94">enc_iv</a>);
        } <span class="keywordflow">else</span> {
            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> enc_key[32], enc_iv[16];
            <a class="code" href="seafile-crypt_8c.html#af0dc7b06b352baa5469b21beec40f73a">seafile_decrypt_repo_enc_key</a> (remote_head-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a>,
                                          passwd,
                                          remote_head-&gt;<a class="code" href="struct__SeafCommit.html#ab1d44814bc44472105aef8761656e3d7">random_key</a>,
                                          enc_key, enc_iv);
            crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (remote_head-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a>,
                                       enc_key, enc_iv);
        }
    }

    conflict_hash = g_hash_table_new_full (g_str_hash, g_str_equal,
                                           g_free, g_free);
    no_conflict_hash = g_hash_table_new_full (g_str_hash, g_str_equal,
                                              g_free, NULL);

    ignore_list = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#abdf6d76830c08b16b49d76e2f34037a5">seaf_repo_load_ignore_files</a> (worktree);

    <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *ce;

    <span class="keywordflow">for</span> (ptr = results; ptr; ptr = ptr-&gt;next) {
        de = ptr-&gt;data;
        <span class="keywordflow">if</span> (de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a8a5184ba68f5168383e7a1017e89e290">DIFF_STATUS_ADDED</a> || de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a94791401bdf8fe513b0a744823436190">DIFF_STATUS_MODIFIED</a>) {
            <span class="keywordflow">if</span> (!is_http)
                ++(task-&gt;<a class="code" href="struct__TransferTask.html#a3271f44397eb71c95a51afa70b8743d3">n_to_download</a>);
            <span class="keywordflow">else</span>
                ++(http_task-&gt;<a class="code" href="struct__HttpTxTask.html#a89a08e86e788096b51d35c7d6244f115">n_files</a>);
        }
    }

<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>    fset = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a06294e91365be10d46a356d427f62e07">seaf_repo_manager_get_locked_file_set</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="keywordflow">for</span> (ptr = results; ptr; ptr = ptr-&gt;next) {
        de = ptr-&gt;data;
        <span class="keywordflow">if</span> (de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a33f1598ea0372aa7bd1dcf4b36bad9e8">DIFF_STATUS_DELETED</a>) {
            seaf_debug (<span class="stringliteral">&quot;Delete file %s.\n&quot;</span>, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);

            ce = <a class="code" href="index_8c.html#a3931a94c55aad8bf8267f179ae846711">index_name_exists</a> (&amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, strlen(de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>), 0);
            <span class="keywordflow">if</span> (!ce)
                <span class="keywordflow">continue</span>;

<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> (!<a class="code" href="vc-utils_8h.html#ade755cc297b064bd93b1527533979454">do_check_file_locked</a> (de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, worktree)) {
                <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a4d1dacc802b818970800154a9bc6e3db">locked_file_set_remove</a> (fset, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, FALSE);
                <a class="code" href="vc-utils_8c.html#afe4721091f815b2382d2cc8b30e97cf0">delete_path</a> (worktree, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, de-&gt;mode, ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a>);
            } <span class="keywordflow">else</span> {
                <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a8782ae78d069d4073a35d981b04a2a88">locked_file_set_add_update</a> (fset, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, <a class="code" href="daemon_2repo-mgr_8h.html#ae9d9b81961c1ed4497f7f808c6be96ed">LOCKED_OP_DELETE</a>,
                                            ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a>, NULL);
            }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>            <a class="code" href="vc-utils_8c.html#afe4721091f815b2382d2cc8b30e97cf0">delete_path</a> (worktree, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, de-&gt;mode, ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
            <a class="code" href="index_8c.html#a86bf1084dfc4e0057a52b4da1922de9b">remove_from_index_with_prefix</a> (&amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, NULL);
            try_add_empty_parent_dir_entry (worktree, &amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);
        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a820629607c6c8a44530724c2c9bc4974">DIFF_STATUS_DIR_DELETED</a>) {
            seaf_debug (<span class="stringliteral">&quot;Delete dir %s.\n&quot;</span>, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);

            <span class="comment">/* Nothing to delete. */</span>
            <span class="keywordflow">if</span> (!master_head || strcmp(master_head-&gt;root_id, EMPTY_SHA1) == 0)
                <span class="keywordflow">continue</span>;

            delete_worktree_dir (worktree, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);

            <span class="comment">/* Remove all index entries under this directory */</span>
            <a class="code" href="index_8c.html#a86bf1084dfc4e0057a52b4da1922de9b">remove_from_index_with_prefix</a> (&amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, NULL);

            try_add_empty_parent_dir_entry (worktree, &amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);
        }
    }

    <span class="keywordflow">for</span> (ptr = results; ptr; ptr = ptr-&gt;next) {
        de = ptr-&gt;data;
        <span class="keywordflow">if</span> (de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#abcf4512ebeae34bfed839057e70a72c2">DIFF_STATUS_RENAMED</a> ||
            de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a7ebaae7e72a366dbc3aba360e5e9957c">DIFF_STATUS_DIR_RENAMED</a>) {
            seaf_debug (<span class="stringliteral">&quot;Rename %s to %s.\n&quot;</span>, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, de-&gt;<a class="code" href="structDiffEntry.html#acfe7cac599e8737146318883029c26e9">new_name</a>);

            do_rename_in_worktree (de, worktree, conflict_hash, no_conflict_hash);

            <a class="code" href="index_8c.html#a56d1945a0677d925b25c610d613aeefc">rename_index_entries</a> (&amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, de-&gt;<a class="code" href="structDiffEntry.html#acfe7cac599e8737146318883029c26e9">new_name</a>, NULL);

            <span class="comment">/* Moving files out of a dir may make it empty. */</span>
            try_add_empty_parent_dir_entry (worktree, &amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);
        }
    }

    <span class="keywordflow">if</span> (istate.cache_changed)
        <a class="code" href="vc-utils_8c.html#ab93fff6b962d6fd7482c95d17c8bf6eb">update_index</a> (&amp;istate, index_path);

    gint64 checkout_size = 0;
    <span class="keywordtype">int</span> rc;
    <span class="keywordflow">for</span> (ptr = results; ptr; ptr = ptr-&gt;next) {
        de = ptr-&gt;data;

        <span class="keywordflow">if</span> (de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a8a5184ba68f5168383e7a1017e89e290">DIFF_STATUS_ADDED</a> ||
            de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a94791401bdf8fe513b0a744823436190">DIFF_STATUS_MODIFIED</a>) {
            seaf_debug (<span class="stringliteral">&quot;Checkout file %s.\n&quot;</span>, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);

            gboolean add_ce = FALSE;
            gboolean is_locked = FALSE;
            <span class="keywordtype">char</span> file_id[41];

            <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a> (de-&gt;<a class="code" href="structDiffEntry.html#a3329ba035605e868d00fb3b773ae021d">sha1</a>, file_id, 20);

            ce = <a class="code" href="index_8c.html#a3931a94c55aad8bf8267f179ae846711">index_name_exists</a> (&amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, strlen(de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>), 0);
            <span class="keywordflow">if</span> (!ce) {
                ce = cache_entry_from_diff_entry (de);
                add_ce = TRUE;
            }

            <span class="keywordflow">if</span> (!should_ignore_on_checkout (de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>)) {
<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>                is_locked = <a class="code" href="vc-utils_8h.html#ade755cc297b064bd93b1527533979454">do_check_file_locked</a> (de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, worktree);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
                rc = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a450e5bcc50da4c40b7ba2bde33a22a84">checkout_file</a> (repo_id,
                                    repo_version,
                                    worktree,
                                    de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>,
                                    file_id,
                                    de-&gt;mtime,
                                    de-&gt;mode,
                                    crypt,
                                    ce,
                                    task,
                                    http_task,
                                    is_http,
                                    remote_head_id,
                                    conflict_hash,
                                    no_conflict_hash,
                                    is_locked);

                <span class="comment">/* Even if the file failed to check out, still need to update index.</span>
<span class="comment">                 * But we have to stop after transfer errors.</span>
<span class="comment">                 */</span>
                <span class="keywordflow">if</span> (rc == <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ae2a1e8d995b67343e5162cdb29513380">FETCH_CHECKOUT_CANCELED</a>) {
                    seaf_debug (<span class="stringliteral">&quot;Transfer canceled.\n&quot;</span>);
                    ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ae2a1e8d995b67343e5162cdb29513380">FETCH_CHECKOUT_CANCELED</a>;
                    <span class="keywordflow">if</span> (add_ce)
                        <a class="code" href="index_8c.html#a156a4ea461fcf14e0b73755b02e7e7d1">cache_entry_free</a> (ce);
                    <span class="keywordflow">goto</span> out;
                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a4a1718c70eba70651160111e48589161">FETCH_CHECKOUT_TRANSFER_ERROR</a>) {
                    seaf_warning (<span class="stringliteral">&quot;Transfer failed.\n&quot;</span>);
                    ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a4a1718c70eba70651160111e48589161">FETCH_CHECKOUT_TRANSFER_ERROR</a>;
                    <span class="keywordflow">if</span> (add_ce)
                        <a class="code" href="index_8c.html#a156a4ea461fcf14e0b73755b02e7e7d1">cache_entry_free</a> (ce);
                    <span class="keywordflow">goto</span> out;
                }

                <span class="keywordflow">if</span> (!is_locked) {
                    cleanup_file_blocks (repo_id, repo_version, file_id);
                } <span class="keywordflow">else</span> {
<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>                    <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a8782ae78d069d4073a35d981b04a2a88">locked_file_set_add_update</a> (fset, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a73695736a3b6d6bc38b8a7e439dba0b4">LOCKED_OP_UPDATE</a>,
                                                ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a>, file_id);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                }
            }

            <span class="keywordflow">if</span> (!is_http)
                ++(task-&gt;<a class="code" href="struct__TransferTask.html#a70063517880957e979f6f222bec67220">n_downloaded</a>);
            <span class="keywordflow">else</span>
                ++(http_task-&gt;<a class="code" href="struct__HttpTxTask.html#a60379872ec333476dfd2b86f9fb0864d">done_files</a>);

            <span class="keywordflow">if</span> (add_ce) {
                <span class="keywordflow">if</span> (!(ce-&gt;<a class="code" href="structcache__entry.html#a4dab14fd813a1bb6b67352674ff4afb2">ce_flags</a> &amp; <a class="code" href="index_8h.html#aa5ee599d9d7af67f19dba204ce9030c0">CE_REMOVE</a>)) {
                    <a class="code" href="index_8c.html#afafdfbe15ca205599303d6e2230886c0">add_index_entry</a> (&amp;istate, ce,
                                     (<a class="code" href="index_8h.html#a4e7659151088d67c163cc90e6f12c39c">ADD_CACHE_OK_TO_ADD</a>|<a class="code" href="index_8h.html#a6b5725eef5481c5f354df57bd32a4d87">ADD_CACHE_OK_TO_REPLACE</a>));
                }
            } <span class="keywordflow">else</span> {
                ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a> = de-&gt;mtime;
                ce-&gt;<a class="code" href="structcache__entry.html#a869a62534c704e5d24ee26cf2f7b86b7">ce_size</a> = de-&gt;size;
                memcpy (ce-&gt;<a class="code" href="structcache__entry.html#a119ab5c5e9db495e6e5f8d301f01421c">sha1</a>, de-&gt;<a class="code" href="structDiffEntry.html#a3329ba035605e868d00fb3b773ae021d">sha1</a>, 20);
                <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="structcache__entry.html#a786aa5bc6234542fe202023bcf721afd">modifier</a>) g_free (ce-&gt;<a class="code" href="structcache__entry.html#a786aa5bc6234542fe202023bcf721afd">modifier</a>);
                ce-&gt;<a class="code" href="structcache__entry.html#a786aa5bc6234542fe202023bcf721afd">modifier</a> = g_strdup(de-&gt;modifier);
                ce-&gt;<a class="code" href="structcache__entry.html#a5fcbcc4e7265ae8150f136380ed92c05">ce_mode</a> = create_ce_mode (de-&gt;mode);
            }

            <span class="comment">/* Save index file to disk after checking out some size of files.</span>
<span class="comment">             * This way we don&#39;t need to re-compare too many files if this</span>
<span class="comment">             * checkout is interrupted.</span>
<span class="comment">             */</span>
            checkout_size += ce-&gt;<a class="code" href="structcache__entry.html#a869a62534c704e5d24ee26cf2f7b86b7">ce_size</a>;
            <span class="keywordflow">if</span> (checkout_size &gt;= <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a4ee85b8b11bc0c69227a8c331a8d9d30">UPDATE_CACHE_SIZE_LIMIT</a>) {
                seaf_debug (<span class="stringliteral">&quot;Save index file.\n&quot;</span>);
                <a class="code" href="vc-utils_8c.html#ab93fff6b962d6fd7482c95d17c8bf6eb">update_index</a> (&amp;istate, index_path);
                checkout_size = 0;
            }
        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a36e1b9c5a30fee84055977065fd0265d">DIFF_STATUS_DIR_ADDED</a>) {
            seaf_debug (<span class="stringliteral">&quot;Checkout empty dir %s.\n&quot;</span>, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);

            gboolean add_ce = FALSE;

            ce = <a class="code" href="index_8c.html#a3931a94c55aad8bf8267f179ae846711">index_name_exists</a> (&amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, strlen(de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>), 0);
            <span class="keywordflow">if</span> (!ce) {
                ce = cache_entry_from_diff_entry (de);
                add_ce = TRUE;
            }

            <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a181f66e1d3900771c37883e97fea7fba">checkout_empty_dir</a> (worktree,
                                de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>,
                                de-&gt;mtime,
                                ce,
                                conflict_hash,
                                no_conflict_hash);

            <span class="keywordflow">if</span> (add_ce) {
                <span class="keywordflow">if</span> (!(ce-&gt;<a class="code" href="structcache__entry.html#a4dab14fd813a1bb6b67352674ff4afb2">ce_flags</a> &amp; <a class="code" href="index_8h.html#aa5ee599d9d7af67f19dba204ce9030c0">CE_REMOVE</a>)) {
                    <a class="code" href="index_8c.html#afafdfbe15ca205599303d6e2230886c0">add_index_entry</a> (&amp;istate, ce,
                                     (<a class="code" href="index_8h.html#a4e7659151088d67c163cc90e6f12c39c">ADD_CACHE_OK_TO_ADD</a>|<a class="code" href="index_8h.html#a6b5725eef5481c5f354df57bd32a4d87">ADD_CACHE_OK_TO_REPLACE</a>));
                }
            } <span class="keywordflow">else</span>
                ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a> = de-&gt;mtime;
        }
    }

    <a class="code" href="vc-utils_8c.html#ab93fff6b962d6fd7482c95d17c8bf6eb">update_index</a> (&amp;istate, index_path);

out:
    <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);

    <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (master);
    <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (master_head);
    <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (remote_head);

    <span class="keywordflow">for</span> (ptr = results; ptr; ptr = ptr-&gt;next)
        <a class="code" href="diff-simple_8c.html#abb759117ec4b4aca623768424487f5da">diff_entry_free</a> ((<a class="code" href="structDiffEntry.html">DiffEntry</a> *)ptr-&gt;data);

    g_free (crypt);
    <span class="keywordflow">if</span> (conflict_hash)
        g_hash_table_destroy (conflict_hash);
    <span class="keywordflow">if</span> (no_conflict_hash)
        g_hash_table_destroy (no_conflict_hash);

    <span class="keywordflow">if</span> (ignore_list)
        <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ae640da4e7db6b316cd0e3c1ba463f9bd">seaf_repo_free_ignore_files</a> (ignore_list);

<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>    <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ab44c57f5e23996e5eb807f7c84f443f5">locked_file_set_free</a> (fset);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad0a65514ad80789ff244b20c66460b96"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_free" ref="ad0a65514ad80789ff244b20c66460b96" args="(SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="server_2repo-mgr_8h.html#ad0a65514ad80789ff244b20c66460b96">seaf_repo_free</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00607">607</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>) <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>);

    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>);
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a>);
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4d7c42c5644eb9dbfd24bf43adb9316c">category</a>);
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>);
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>);
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a>);
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a0ce3b61cb31e78ffea429615379b3eb4">token</a>);
    g_free (repo);
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae640da4e7db6b316cd0e3c1ba463f9bd"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_free_ignore_files" ref="ae640da4e7db6b316cd0e3c1ba463f9bd" args="(GList *ignore_list)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="daemon_2repo-mgr_8h.html#ae640da4e7db6b316cd0e3c1ba463f9bd">seaf_repo_free_ignore_files</a> </td>
          <td>(</td>
          <td class="paramtype">GList *&#160;</td>
          <td class="paramname"><em>ignore_list</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l05518">5518</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *p;

    <span class="keywordflow">if</span> (ignore_list == NULL)
        <span class="keywordflow">return</span>;

    <span class="keywordflow">for</span> (p = ignore_list; p != NULL; p = p-&gt;next)
        free(p-&gt;data);

    g_list_free (ignore_list);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a9c8ead9892374c87ece888d76e810197"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_from_commit" ref="a9c8ead9892374c87ece888d76e810197" args="(SeafRepo *repo, SeafCommit *commit)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="server_2repo-mgr_8h.html#a9c8ead9892374c87ece888d76e810197">seaf_repo_from_commit</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="commit-mgr_8h.html#ab20cfcee12e164d94824e8be23c2c8ea">SeafCommit</a> *&#160;</td>
          <td class="paramname"><em>commit</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00663">663</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a> = g_strdup (commit-&gt;<a class="code" href="struct__SeafCommit.html#aacd7b88f8a3e72446cd7352396eaa09e">repo_name</a>);
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a> = g_strdup (commit-&gt;<a class="code" href="struct__SeafCommit.html#aa3d8e868c630cfbecbcb9158c4bbe2e4">repo_desc</a>);
    repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#a906e77d2a658f4337437ff8694a4bfc0">encrypted</a>;
    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
        repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a>;
        <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> == 1)
            memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a>, 32);
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> == 2) {
            memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a>, 64);
            memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#a83e0a2366ba320396f2deb6faa167b84">random_key</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#ab1d44814bc44472105aef8761656e3d7">random_key</a>, 96);
        }
    }
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a4710aaee11c7887df402fffa7ca6c54f">no_local_history</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#a383ea4a4b94417c7d9e9827d60420d64">no_local_history</a>;
    repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#abc83f168ce2b43fa864522bf0ea26d6d">version</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="adc55911231fbdbb9d54f39d7f0e60dca"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_get_commits" ref="adc55911231fbdbb9d54f39d7f0e60dca" args="(SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#adc55911231fbdbb9d54f39d7f0e60dca">seaf_repo_get_commits</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00713">713</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *branches;
    GList *ptr;
    <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch;
    GList *commits = NULL;

    branches = <a class="code" href="branch-mgr_8c.html#ad5bd62cbe17cb8fe91bcd993956a1fbf">seaf_branch_manager_get_branch_list</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
    <span class="keywordflow">if</span> (branches == NULL) {
        g_warning (<span class="stringliteral">&quot;Failed to get branch list of repo %s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">for</span> (ptr = branches; ptr != NULL; ptr = ptr-&gt;next) {
        branch = ptr-&gt;data;
        gboolean res = <a class="code" href="commit-mgr_8c.html#ac6547d5546781608b39446d9a2077fed">seaf_commit_manager_traverse_commit_tree</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                                                 repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
                                                                 repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                                 branch-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>,
                                                                 collect_commit,
                                                                 &amp;commits, FALSE);
        <span class="keywordflow">if</span> (!res) {
            <span class="keywordflow">for</span> (ptr = commits; ptr != NULL; ptr = ptr-&gt;next)
                <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> ((<a class="code" href="struct__SeafCommit.html">SeafCommit</a> *)(ptr-&gt;data));
            g_list_free (commits);
            <span class="keywordflow">goto</span> out;
        }
    }

    commits = g_list_reverse (commits);

out:
    <span class="keywordflow">for</span> (ptr = branches; ptr != NULL; ptr = ptr-&gt;next) {
        <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> ((<a class="code" href="struct__SeafBranch.html">SeafBranch</a> *)ptr-&gt;data);
    }
    <span class="keywordflow">return</span> commits;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a7fdd2ba98b2cab98aaced0e49a1685a9"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_get_head_commit" ref="a7fdd2ba98b2cab98aaced0e49a1685a9" args="(const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="commit-mgr_8h.html#ab20cfcee12e164d94824e8be23c2c8ea">SeafCommit</a>* <a class="el" href="daemon_2repo-mgr_8h.html#a7fdd2ba98b2cab98aaced0e49a1685a9">seaf_repo_get_head_commit</a> </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00640">640</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head;

    repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id);
    <span class="keywordflow">if</span> (!repo) {
        seaf_warning (<span class="stringliteral">&quot;Failed to get repo %s.\n&quot;</span>, repo_id);
        <span class="keywordflow">return</span> NULL;
    }

    head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                           repo_id, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                           repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
    <span class="keywordflow">if</span> (!head) {
        seaf_warning (<span class="stringliteral">&quot;Failed to get head for repo %s.\n&quot;</span>, repo_id);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> head;
}
</pre></div>
</div>
</div>
<a class="anchor" id="af591ba84286a82123c728debd33ff300"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_index_commit" ref="af591ba84286a82123c728debd33ff300" args="(SeafRepo *repo, const char *desc, gboolean is_force_commit, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="daemon_2repo-mgr_8h.html#ab6d5318b3a1cc6f86733ff71b16815a8">seaf_repo_index_commit</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>desc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gboolean&#160;</td>
          <td class="paramname"><em>is_force_commit</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l02580">2580</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>;
    <span class="keyword">struct </span><a class="code" href="structindex__state.html">index_state</a> istate;
    <span class="keyword">struct </span><a class="code" href="structcache__tree.html">cache_tree</a> *it;
    <span class="keywordtype">char</span> <a class="code" href="index_8c.html#a35caece3e3575d32521f820a8f0a24a7">index_path</a>[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> commit_id[41];
    gboolean unmerged = FALSE;

    <span class="keywordflow">if</span> (!check_worktree_common (repo))
        <span class="keywordflow">return</span> NULL;

    memset (&amp;istate, 0, <span class="keyword">sizeof</span>(istate));
    snprintf (index_path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
    <span class="keywordflow">if</span> (<a class="code" href="index_8c.html#a0f9de2761514c9136fb4b9c5541ef6f8">read_index_from</a> (&amp;istate, index_path, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;Failed to load index.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;Internal data structure error&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">if</span> (need_handle_unmerged_index (repo, &amp;istate))
        unmerged = TRUE;

    <span class="keywordflow">if</span> (index_add (repo, &amp;istate, is_force_commit, unmerged) &lt; 0) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;Failed to add&quot;</span>);
        <span class="keywordflow">goto</span> error;
    }

    <span class="comment">/* Commit before updating the index, so that new blocks won&#39;t be GC&#39;ed. */</span>

    <span class="keywordtype">char</span> *my_desc = g_strdup(desc);
    <span class="keywordflow">if</span> (my_desc[0] == <span class="charliteral">&#39;\0&#39;</span>) {
        <span class="keywordtype">char</span> *gen_desc = gen_commit_description (repo, &amp;istate);
        <span class="keywordflow">if</span> (!gen_desc) {
            <span class="comment">/* error not set. */</span>
            g_free (my_desc);

            <span class="comment">/* Still need to update index even nothing to commit. */</span>
            <a class="code" href="vc-utils_8c.html#ab93fff6b962d6fd7482c95d17c8bf6eb">update_index</a> (&amp;istate, index_path);
            <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);

            <span class="keywordflow">return</span> NULL;
        }
        g_free (my_desc);
        my_desc = gen_desc;
    }

    it = <a class="code" href="cache-tree_8c.html#a120475d6b5efa481c3acb318724e308d">cache_tree</a> ();
    <span class="keywordflow">if</span> (<a class="code" href="cache-tree_8c.html#abc55c58b49566383d534a4ab37d0b255">cache_tree_update</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                           repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>,
                           it, istate.cache,
                           istate.cache_nr, 0, 0, <a class="code" href="vc-utils_8c.html#a4b086cedacd72882aa71266710f3d869">commit_trees_cb</a>) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;Failed to build cache tree&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;Internal data structure error&quot;</span>);
        <a class="code" href="cache-tree_8c.html#a4d76480b03fedc601676872518b3bc71">cache_tree_free</a> (&amp;it);
        <span class="keywordflow">goto</span> error;
    }

    <span class="keywordflow">if</span> (commit_tree (repo, it, my_desc, commit_id, unmerged) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;Failed to save commit file&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;Internal error&quot;</span>);
        <a class="code" href="cache-tree_8c.html#a4d76480b03fedc601676872518b3bc71">cache_tree_free</a> (&amp;it);
        <span class="keywordflow">goto</span> error;
    }
    g_free (my_desc);
    <a class="code" href="cache-tree_8c.html#a4d76480b03fedc601676872518b3bc71">cache_tree_free</a> (&amp;it);

    <span class="keywordflow">if</span> (<a class="code" href="vc-utils_8c.html#ab93fff6b962d6fd7482c95d17c8bf6eb">update_index</a> (&amp;istate, index_path) &lt; 0)
        <span class="keywordflow">goto</span> error;

    <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);

    g_signal_emit_by_name (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>, <span class="stringliteral">&quot;repo-committed&quot;</span>, repo);

    <span class="keywordflow">return</span> g_strdup(commit_id);

error:
    <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
    <span class="keywordflow">return</span> NULL;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aadbf4eb74b53f6423e7eabf716f5f4fb"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_index_worktree_files" ref="aadbf4eb74b53f6423e7eabf716f5f4fb" args="(const char *repo_id, int repo_version, const char *modifier, const char *worktree, const char *passwd, int enc_version, const char *random_key, char *root_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#a77e557bb1fedd648a109ab5d9bff5ef4">seaf_repo_index_worktree_files</a> </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>repo_version</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>modifier</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>worktree</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>passwd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>enc_version</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>random_key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>root_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l02265">2265</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> <a class="code" href="index_8c.html#a35caece3e3575d32521f820a8f0a24a7">index_path</a>[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keyword">struct </span><a class="code" href="structindex__state.html">index_state</a> istate;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> key[32], iv[16];
    <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt = NULL;
    <span class="keyword">struct </span><a class="code" href="structcache__tree.html">cache_tree</a> *it = NULL;
    GList *ignore_list = NULL;

    memset (&amp;istate, 0, <span class="keyword">sizeof</span>(istate));
    snprintf (index_path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>, repo_id);

    <span class="comment">/* Remove existing index. An existing index signifies an interrupted</span>
<span class="comment">     * clone-merge. Removing it assures that new blocks from the worktree</span>
<span class="comment">     * get added into the repo again (they&#39;re deleted by GC).</span>
<span class="comment">     */</span>
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a26f091009701c5a9d1886b9d6ceb9c8e">seaf_util_unlink</a> (index_path);

    <span class="keywordflow">if</span> (<a class="code" href="index_8c.html#a0f9de2761514c9136fb4b9c5541ef6f8">read_index_from</a> (&amp;istate, index_path, repo_version) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;Failed to load index.\n&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    <span class="keywordflow">if</span> (passwd != NULL) {
        <span class="keywordflow">if</span> (<a class="code" href="seafile-crypt_8c.html#af0dc7b06b352baa5469b21beec40f73a">seafile_decrypt_repo_enc_key</a> (enc_version, passwd,
                                          random_key, key, iv) &lt; 0) {
            seaf_warning (<span class="stringliteral">&quot;Failed to generate enc key for repo %s.\n&quot;</span>, repo_id);
            <span class="keywordflow">goto</span> error;
        }
        crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (enc_version, key, iv);
    }

    ignore_list = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#abdf6d76830c08b16b49d76e2f34037a5">seaf_repo_load_ignore_files</a>(worktree);

    <span class="comment">/* Add empty dir to index. Otherwise if the repo on relay contains an empty</span>
<span class="comment">     * dir, we&#39;ll fail to detect fast-forward relationship later.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (add_recursive (repo_id, repo_version, modifier,
                       &amp;istate, worktree, <span class="stringliteral">&quot;&quot;</span>, crypt, FALSE, ignore_list,
                       NULL, NULL, NULL) &lt; 0)
        <span class="keywordflow">goto</span> error;

    remove_deleted (&amp;istate, worktree, <span class="stringliteral">&quot;&quot;</span>, ignore_list, NULL, NULL, NULL, FALSE);

    it = <a class="code" href="cache-tree_8c.html#a120475d6b5efa481c3acb318724e308d">cache_tree</a> ();
    <span class="keywordflow">if</span> (<a class="code" href="cache-tree_8c.html#abc55c58b49566383d534a4ab37d0b255">cache_tree_update</a> (repo_id, repo_version, worktree,
                           it, istate.cache, istate.cache_nr,
                           0, 0, <a class="code" href="vc-utils_8c.html#a4b086cedacd72882aa71266710f3d869">commit_trees_cb</a>) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;Failed to build cache tree&quot;</span>);
        <span class="keywordflow">goto</span> error;
    }

    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a> (it-&gt;<a class="code" href="structcache__tree.html#a662341619d00b9fd6cbd25ea74cc22dd">sha1</a>, root_id, 20);

    <span class="keywordflow">if</span> (<a class="code" href="vc-utils_8c.html#ab93fff6b962d6fd7482c95d17c8bf6eb">update_index</a> (&amp;istate, index_path) &lt; 0)
        <span class="keywordflow">goto</span> error;

    <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
    g_free (crypt);
    <span class="keywordflow">if</span> (it)
        <a class="code" href="cache-tree_8c.html#a4d76480b03fedc601676872518b3bc71">cache_tree_free</a> (&amp;it);
    <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ae640da4e7db6b316cd0e3c1ba463f9bd">seaf_repo_free_ignore_files</a>(ignore_list);
    <span class="keywordflow">return</span> 0;

error:
    <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
    g_free (crypt);
    <span class="keywordflow">if</span> (it)
        <a class="code" href="cache-tree_8c.html#a4d76480b03fedc601676872518b3bc71">cache_tree_free</a> (&amp;it);
    <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ae640da4e7db6b316cd0e3c1ba463f9bd">seaf_repo_free_ignore_files</a>(ignore_list);
    <span class="keywordflow">return</span> -1;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a79db93d798035e3e07f48c2ad32d87f1"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_is_index_unmerged" ref="a79db93d798035e3e07f48c2ad32d87f1" args="(SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gboolean <a class="el" href="daemon_2repo-mgr_8h.html#a79db93d798035e3e07f48c2ad32d87f1">seaf_repo_is_index_unmerged</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l02469">2469</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>;
    <span class="keyword">struct </span><a class="code" href="structindex__state.html">index_state</a> istate;
    <span class="keywordtype">char</span> <a class="code" href="index_8c.html#a35caece3e3575d32521f820a8f0a24a7">index_path</a>[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    gboolean ret = FALSE;

    <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>)
        <span class="keywordflow">return</span> FALSE;

    memset (&amp;istate, 0, <span class="keyword">sizeof</span>(istate));
    snprintf (index_path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
    <span class="keywordflow">if</span> (<a class="code" href="index_8c.html#a0f9de2761514c9136fb4b9c5541ef6f8">read_index_from</a> (&amp;istate, index_path, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;Failed to load index.\n&quot;</span>);
        <span class="keywordflow">return</span> FALSE;
    }

    <span class="keywordflow">if</span> (<a class="code" href="index_8c.html#a177df5d9afa8392326c1a1cef68f08c0">unmerged_index</a> (&amp;istate))
        ret = TRUE;

    <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a461e72948bba5928329e269ad395e293"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_is_worktree_changed" ref="a461e72948bba5928329e269ad395e293" args="(SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gboolean <a class="el" href="daemon_2repo-mgr_8h.html#a461e72948bba5928329e269ad395e293">seaf_repo_is_worktree_changed</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l02346">2346</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>;
    GList *res = NULL, *p;
    <span class="keyword">struct </span><a class="code" href="structindex__state.html">index_state</a> istate;
    <span class="keywordtype">char</span> <a class="code" href="index_8c.html#a35caece3e3575d32521f820a8f0a24a7">index_path</a>[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];

    <a class="code" href="structDiffEntry.html">DiffEntry</a> *de;
    <span class="keywordtype">int</span> pos;
    <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *ce;
    <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> sb;
    <span class="keywordtype">char</span> *full_path;

    <span class="keywordflow">if</span> (!check_worktree_common (repo))
        <span class="keywordflow">return</span> FALSE;

    memset (&amp;istate, 0, <span class="keyword">sizeof</span>(istate));
    snprintf (index_path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
    <span class="keywordflow">if</span> (<a class="code" href="index_8c.html#a0f9de2761514c9136fb4b9c5541ef6f8">read_index_from</a> (&amp;istate, index_path, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>) &lt; 0) {
        repo-&gt;<a class="code" href="struct__SeafRepo.html#a5377f474b9e1cc96a69ab26d5da8e244">index_corrupted</a> = TRUE;
        g_warning (<span class="stringliteral">&quot;Failed to load index.\n&quot;</span>);
        <span class="keywordflow">goto</span> error;
    }
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a5377f474b9e1cc96a69ab26d5da8e244">index_corrupted</a> = FALSE;

    <a class="code" href="status_8c.html#aedde1fa2f15b7c6a05b14c2dcc04f6be">wt_status_collect_changes_worktree</a> (&amp;istate, &amp;res, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>);
    <span class="keywordflow">if</span> (res != NULL)
        <span class="keywordflow">goto</span> changed;

    <a class="code" href="status_8c.html#ae9ecb4f4ad21d7ff69f36e16cc6996de">wt_status_collect_untracked</a> (&amp;istate, &amp;res, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, should_ignore);
    <span class="keywordflow">if</span> (res != NULL)
        <span class="keywordflow">goto</span> changed;

    <a class="code" href="status_8c.html#a5aaef0b3a73d20b9f422c9d39f0a2325">wt_status_collect_changes_index</a> (&amp;istate, &amp;res, repo);
    <span class="keywordflow">if</span> (res != NULL)
        <span class="keywordflow">goto</span> changed;

    <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);

    repo-&gt;<a class="code" href="struct__SeafRepo.html#a0c328bbabc240a013e03b822a5304933">wt_changed</a> = FALSE;

    <span class="comment">/* g_debug (&quot;%s worktree is changed\n&quot;, repo-&gt;id); */</span>
    <span class="keywordflow">return</span> FALSE;

changed:

    g_message (<span class="stringliteral">&quot;Worktree changes (at most 5 files are shown):\n&quot;</span>);
    <span class="keywordtype">int</span> i = 0;
    <span class="keywordflow">for</span> (p = res; p != NULL &amp;&amp; i &lt; 5; p = p-&gt;next, ++i) {
        de = p-&gt;data;

        full_path = g_build_path (<span class="stringliteral">&quot;/&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, NULL);
        <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (full_path, &amp;sb) &lt; 0) {
            g_warning (<span class="stringliteral">&quot;Failed to stat %s: %s.\n&quot;</span>, full_path, strerror(errno));
            g_free (full_path);
            <span class="keywordflow">continue</span>;
        }
        g_free (full_path);

        pos = <a class="code" href="index_8c.html#a1f5ad45bcfb5a2dcc3fae542fa293d4a">index_name_pos</a> (&amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, strlen(de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>));
        <span class="keywordflow">if</span> (pos &lt; 0) {
            g_warning (<span class="stringliteral">&quot;Cannot find diff entry %s in index.\n&quot;</span>, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);
            <span class="keywordflow">continue</span>;
        }
        ce = istate.cache[pos];

        g_message (<span class="stringliteral">&quot;type: %c, status: %c, name: %s, &quot;</span>
                   <span class="stringliteral">&quot;ce mtime: %&quot;</span>G_GINT64_FORMAT<span class="stringliteral">&quot;, ce size: %&quot;</span> G_GUINT64_FORMAT <span class="stringliteral">&quot;, &quot;</span>
                   <span class="stringliteral">&quot;file mtime: %d, file size: %&quot;</span> G_GUINT64_FORMAT <span class="stringliteral">&quot;\n&quot;</span>,
                   de-&gt;<a class="code" href="structDiffEntry.html#a07ebfe57746e5fc5017603545ab04b47">type</a>, de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a>, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>,
                   ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a>, ce-&gt;<a class="code" href="structcache__entry.html#a869a62534c704e5d24ee26cf2f7b86b7">ce_size</a>, (<span class="keywordtype">int</span>)sb.st_mtime, sb.st_size);
    }

    <span class="keywordflow">for</span> (p = res; p; p = p-&gt;next) {
        de = p-&gt;data;
        <a class="code" href="diff-simple_8c.html#abb759117ec4b4aca623768424487f5da">diff_entry_free</a> (de);
    }
    g_list_free (res);

    <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);

    repo-&gt;<a class="code" href="struct__SeafRepo.html#a0c328bbabc240a013e03b822a5304933">wt_changed</a> = TRUE;

    <span class="comment">/* g_debug (&quot;%s worktree is changed\n&quot;, repo-&gt;id); */</span>
    <span class="keywordflow">return</span> TRUE;

error:
    <span class="keywordflow">return</span> FALSE;
}
</pre></div>
</div>
</div>
<a class="anchor" id="abdf6d76830c08b16b49d76e2f34037a5"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_load_ignore_files" ref="abdf6d76830c08b16b49d76e2f34037a5" args="(const char *worktree)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="daemon_2repo-mgr_8h.html#abdf6d76830c08b16b49d76e2f34037a5">seaf_repo_load_ignore_files</a> </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>worktree</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l05435">5435</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *list = NULL;
    <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
    FILE *fp;
    <span class="keywordtype">char</span> *full_path, *pattern;
    <span class="keywordtype">char</span> path[PATH_MAX];

    full_path = g_build_path (<a class="code" href="vc-utils_8h.html#aa7da4cdc6796b13fca1a4b263488dfdd">PATH_SEPERATOR</a>, worktree,
                              <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a237e501289ed87ac7fb2bb3859e81cb0">IGNORE_FILE</a>, NULL);
    <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (full_path, &amp;st) &lt; 0)
        <span class="keywordflow">goto</span> error;
    <span class="keywordflow">if</span> (!S_ISREG(st.st_mode))
        <span class="keywordflow">goto</span> error;
    fp = g_fopen(full_path, <span class="stringliteral">&quot;r&quot;</span>);
    <span class="keywordflow">if</span> (fp == NULL)
        <span class="keywordflow">goto</span> error;

    <span class="keywordflow">while</span> (fgets(path, PATH_MAX, fp) != NULL) {
        <span class="comment">/* remove leading and trailing whitespace, including \n \r. */</span>
        g_strstrip (path);

        <span class="comment">/* ignore comment and blank line */</span>
        <span class="keywordflow">if</span> (path[0] == <span class="charliteral">&#39;#&#39;</span> || path[0] == <span class="charliteral">&#39;\0&#39;</span>)
            <span class="keywordflow">continue</span>;

        <span class="comment">/* Change &#39;foo/&#39; to &#39;foo/ *&#39;. */</span>
        <span class="keywordflow">if</span> (path[strlen(path)-1] == <span class="charliteral">&#39;/&#39;</span>)
            pattern = g_strdup_printf(<span class="stringliteral">&quot;%s/%s*&quot;</span>, worktree, path);
        <span class="keywordflow">else</span>
            pattern = g_strdup_printf(<span class="stringliteral">&quot;%s/%s&quot;</span>, worktree, path);

        list = g_list_prepend(list, pattern);
    }

    fclose(fp);
    g_free (full_path);
    <span class="keywordflow">return</span> list;

error:
    g_free (full_path);
    <span class="keywordflow">return</span> NULL;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae2b1438737e8d1bebeb1e674013b02b5"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_add_checkout_task" ref="ae2b1438737e8d1bebeb1e674013b02b5" args="(SeafRepoManager *mgr, SeafRepo *repo, const char *worktree, CheckoutDoneCallback done_cb, void *cb_data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#ae2b1438737e8d1bebeb1e674013b02b5">seaf_repo_manager_add_checkout_task</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>worktree</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a699bd5e643ce774eaebfc58876713669">CheckoutDoneCallback</a>&#160;</td>
          <td class="paramname"><em>done_cb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>cb_data</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l05263">5263</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (!repo || !worktree) {
        seaf_warning (<span class="stringliteral">&quot;Invaid args\n&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    <a class="code" href="structCheckoutTask.html">CheckoutTask</a> *task = g_new0 (<a class="code" href="structCheckoutTask.html">CheckoutTask</a>, 1);
    memcpy (task-&gt;<a class="code" href="structCheckoutTask.html#a84eafe72ec4243ad00e41f6fd8a9050b">repo_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, 41);
    g_return_val_if_fail (strlen(worktree) &lt; <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, -1);
    strcpy (task-&gt;<a class="code" href="structCheckoutTask.html#a26041098da1295d02fe5c82b35deb75d">worktree</a>, worktree);

    g_hash_table_insert (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a7fde21f0d7bba66fac76f4783377f20c">checkout_tasks_hash</a>,
                         g_strdup(repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>), task);

    <a class="code" href="structCheckoutData.html">CheckoutData</a> *cdata = g_new0 (<a class="code" href="structCheckoutData.html">CheckoutData</a>, 1);
    cdata-&gt;<a class="code" href="structCheckoutData.html#a03c40d0bdf3f7188b8d5a65d1c91311b">repo</a> = repo;
    cdata-&gt;<a class="code" href="structCheckoutData.html#af0930d83e4f52dde3b3dc1042505d30a">task</a> = task;
    cdata-&gt;<a class="code" href="structCheckoutData.html#a110a3d2da03b5eedf63ee17e64aa28f0">done_cb</a> = done_cb;
    cdata-&gt;<a class="code" href="structCheckoutData.html#a509cbdb4a742d8fe7995c99b8633c499">cb_data</a> = cb_data;
    <a class="code" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768">ccnet_job_manager_schedule_job</a>(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#abcbb9886e315abb16c620ce49808a0b2">job_mgr</a>,
                                   (<a class="code" href="job-mgr_8h.html#a6afa5278e04afad06a1953d430c877b8">JobThreadFunc</a>)checkout_repo_job,
                                   (<a class="code" href="job-mgr_8h.html#a837a757135a35cf40cefa26e8909b402">JobDoneCallback</a>)checkout_job_done,
                                   cdata);
    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a140616a89d5a02935665f86cf3bb744c"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_add_repo" ref="a140616a89d5a02935665f86cf3bb744c" args="(SeafRepoManager *manager, SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a2c0a60c4eefbb0b4bc68bf871856f32d">seaf_repo_manager_add_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04002">4002</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];
    sqlite3 *db = manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>;

    pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;REPLACE INTO Repo VALUES (&#39;%s&#39;);&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
    <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);

    pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="comment">/* There may be a &quot;deletion record&quot; for this repo when it was deleted</span>
<span class="comment">     * last time.</span>
<span class="comment">     */</span>
    <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a7d2cf85f06fa2e7d459730f7494c1a65">seaf_repo_manager_remove_garbage_repo</a> (manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);

    repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a> = manager;

    <span class="keywordflow">if</span> (pthread_rwlock_wrlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;[repo mgr] failed to lock repo cache.\n&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    g_hash_table_insert (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a46e78181430977b311346c02e5738286">repo_hash</a>, g_strdup(repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>), repo);

    pthread_rwlock_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae586fb5fbd61d6b44be3e47e7b6c86da"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_branch_repo_unmap" ref="ae586fb5fbd61d6b44be3e47e7b6c86da" args="(SeafRepoManager *manager, SeafBranch *branch)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#ae586fb5fbd61d6b44be3e47e7b6c86da">seaf_repo_manager_branch_repo_unmap</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="branch-mgr_8h.html#a43063fab0cfaf940abc07b1cd941fb85">SeafBranch</a> *&#160;</td>
          <td class="paramname"><em>branch</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04397">4397</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    sqlite3 *db = manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>;

    pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    sql = sqlite3_mprintf (<span class="stringliteral">&quot;DELETE FROM RepoBranch WHERE branch_name = %Q&quot;</span>
                           <span class="stringliteral">&quot; AND repo_id = %Q&quot;</span>,
                           branch-&gt;<a class="code" href="struct__SeafBranch.html#ae6af0006b9b80ded4f0525a3be06ccda">name</a>, branch-&gt;<a class="code" href="struct__SeafBranch.html#a88717f46308eb12629b99f9ff91740c2">repo_id</a>);
    <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;Unmap branch repo failed\n&quot;</span>);
        pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
        sqlite3_free (sql);
        <span class="keywordflow">return</span> -1;
    }

    sqlite3_free (sql);
    pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a04253ac87d4466bd4e2abd1e312a1663"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_clear_merge" ref="a04253ac87d4466bd4e2abd1e312a1663" args="(SeafRepoManager *manager, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#a04253ac87d4466bd4e2abd1e312a1663">seaf_repo_manager_clear_merge</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l05031">5031</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];

    pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;UPDATE MergeInfo SET in_merge=0 WHERE repo_id=&#39;%s&#39;;&quot;</span>,
              repo_id);
    <span class="keywordtype">int</span> ret = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);

    pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ab599ba29e40bdb918ac78060d1165c2d"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_create_new_repo" ref="ab599ba29e40bdb918ac78060d1165c2d" args="(SeafRepoManager *mgr, const char *name, const char *desc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a>* <a class="el" href="server_2repo-mgr_8h.html#a3706de93ba77e5068dba6a1dd073a0fd">seaf_repo_manager_create_new_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>desc</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l03976">3976</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
    <span class="keywordtype">char</span> *repo_id;
    
    repo_id = <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af64020f0be33abde6a2a076ff9808809">gen_uuid</a> ();
    repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a63ab9fe4694e3d967376c911cbe2c655">seaf_repo_new</a> (repo_id, <a class="code" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>, desc);
    <span class="keywordflow">if</span> (!repo) {
        g_free (repo_id);
        <span class="keywordflow">return</span> NULL;
    }
    g_free (repo_id);

    <span class="comment">/* we directly create dir because it shouldn&#39;t exist */</span>
    <span class="comment">/* if (seaf_repo_mkdir (repo, base) &lt; 0) { */</span>
    <span class="comment">/*     seaf_repo_free (repo); */</span>
    <span class="comment">/*     goto out; */</span>
    <span class="comment">/* } */</span>

    <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a140616a89d5a02935665f86cf3bb744c">seaf_repo_manager_add_repo</a> (mgr, repo);
    <span class="keywordflow">return</span> repo;
}
</pre></div>
</div>
</div>
<a class="anchor" id="afdce2de6ee36dcf6b6264ac35fb17f7a"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_del_repo" ref="afdce2de6ee36dcf6b6264ac35fb17f7a" args="(SeafRepoManager *mgr, SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a512a79980f7d3698e591cf87aeccd314">seaf_repo_manager_del_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04184">4184</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a008f145440cf3620f7883d1fe109f69c">seaf_repo_manager_remove_repo_ondisk</a> (mgr, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
                                          (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a> &gt; 0) ? TRUE : FALSE);

    <span class="keywordflow">if</span> (pthread_rwlock_wrlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;[repo mgr] failed to lock repo cache.\n&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    g_hash_table_remove (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a46e78181430977b311346c02e5738286">repo_hash</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);

    pthread_rwlock_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);

    <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ad0a65514ad80789ff244b20c66460b96">seaf_repo_free</a> (repo);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="afebb8831a3f9be12c5612c5707118d3b"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_generate_tmp_token" ref="afebb8831a3f9be12c5612c5707118d3b" args="(SeafRepoManager *manager, const char *repo_id, const char *peer_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="daemon_2repo-mgr_8h.html#afebb8831a3f9be12c5612c5707118d3b">seaf_repo_manager_generate_tmp_token</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>peer_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04327">4327</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];
    sqlite3 *db = manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>;

    <span class="keywordtype">int</span> now = time(NULL);
    <span class="keywordtype">char</span> *token = <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af64020f0be33abde6a2a076ff9808809">gen_uuid</a>();
    pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    snprintf (sql, <span class="keyword">sizeof</span>(sql),
              <span class="stringliteral">&quot;REPLACE INTO RepoTmpToken VALUES (&#39;%s&#39;, &#39;%s&#39;, &#39;%s&#39;, %d);&quot;</span>,
              repo_id, peer_id, token, now);
    <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql) &lt; 0) {
        pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
        g_free (token);
        <span class="keywordflow">return</span> NULL;
    }

    pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
    <span class="keywordflow">return</span> token;
}
</pre></div>
</div>
</div>
<a class="anchor" id="abe8b32b343e5e7d2d06018e398011151"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_get_checkout_task" ref="abe8b32b343e5e7d2d06018e398011151" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structCheckoutTask.html">CheckoutTask</a>* <a class="el" href="daemon_2repo-mgr_8h.html#abe8b32b343e5e7d2d06018e398011151">seaf_repo_manager_get_checkout_task</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l05295">5295</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (!repo_id || strlen(repo_id) != 36) {
        seaf_warning (<span class="stringliteral">&quot;Invalid args\n&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> g_hash_table_lookup(mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a7fde21f0d7bba66fac76f4783377f20c">checkout_tasks_hash</a>, repo_id);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a3d8affa43a26075cdd6821e330f68748"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_get_common_ancestor" ref="a3d8affa43a26075cdd6821e330f68748" args="(SeafRepoManager *manager, const char *repo_id, char *common_ancestor, char *head_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#a3d8affa43a26075cdd6821e330f68748">seaf_repo_manager_get_common_ancestor</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>common_ancestor</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>head_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l05112">5112</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];
    <a class="code" href="structCAInfo.html">CAInfo</a> info;

    memset (&amp;info, 0, <span class="keyword">sizeof</span>(info));

    pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    snprintf (sql, <span class="keyword">sizeof</span>(sql),
              <span class="stringliteral">&quot;SELECT ca_id, head_id FROM CommonAncestor WHERE repo_id=&#39;%s&#39;;&quot;</span>,
              repo_id);
    <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql,
                                     get_common_ancestor, &amp;info) &lt; 0) {
        pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
        <span class="keywordflow">return</span> -1;
    }

    pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    memcpy (common_ancestor, info.<a class="code" href="structCAInfo.html#a7cc5cc6b5c24fb17f1ae6fccd0b4886b">common_ancestor</a>, 41);
    memcpy (head_id, info.<a class="code" href="structCAInfo.html#a042601365b02d2737bc2466821337b3e">head_id</a>, 41);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a7320afc04f67e0cb3dcc20389479c234"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_get_folder_perm_timestamp" ref="a7320afc04f67e0cb3dcc20389479c234" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gint64 <a class="el" href="daemon_2repo-mgr_8h.html#a7320afc04f67e0cb3dcc20389479c234">seaf_repo_manager_get_folder_perm_timestamp</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00450">450</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];
    gint64 ret;

    sqlite3_snprintf (<span class="keyword">sizeof</span>(sql), sql,
                      <span class="stringliteral">&quot;SELECT timestamp FROM FolderPermTimestamp WHERE repo_id = &#39;%q&#39;&quot;</span>,
                      repo_id);

    pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    ret = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a8e8a339b39f493438e6a2c06dcdc06da">sqlite_get_int64</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);

    pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a06294e91365be10d46a356d427f62e07"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_get_locked_file_set" ref="a06294e91365be10d46a356d427f62e07" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="daemon_2repo-mgr_8h.html#adccaa653ef97d8570cac74163af03002">LockedFileSet</a>* <a class="el" href="daemon_2repo-mgr_8h.html#a06294e91365be10d46a356d427f62e07">seaf_repo_manager_get_locked_file_set</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00111">111</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GHashTable *locked_files = g_hash_table_new_full (g_str_hash, g_str_equal,
                                                      g_free,
                                                      (GDestroyNotify)locked_file_free);
    <span class="keywordtype">char</span> sql[256];

    sqlite3_snprintf (<span class="keyword">sizeof</span>(sql), sql,
                      <span class="stringliteral">&quot;SELECT path, operation, old_mtime, file_id FROM LockedFiles &quot;</span>
                      <span class="stringliteral">&quot;WHERE repo_id = &#39;%q&#39;&quot;</span>,
                      repo_id);

    pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="comment">/* Ingore database error. We return an empty set on error. */</span>
    <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql,
                                 load_locked_file, locked_files);

    pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *ret = g_new0 (<a class="code" href="struct__LockedFileSet.html">LockedFileSet</a>, 1);
    ret-&gt;<a class="code" href="struct__LockedFileSet.html#ae599e7470165a7f4eaaaefad7bb85c5f">mgr</a> = mgr;
    memcpy (ret-&gt;<a class="code" href="struct__LockedFileSet.html#ae51031b45e0a18e92898ce33bef301fe">repo_id</a>, repo_id, 36);
    ret-&gt;<a class="code" href="struct__LockedFileSet.html#a228bfd2b438cfa59fcf2dbd596ce335a">locked_files</a> = locked_files;

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ac0e4e52af419d42f34ce53d368777070"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_get_merge_info" ref="ac0e4e52af419d42f34ce53d368777070" args="(SeafRepoManager *manager, const char *repo_id, SeafRepoMergeInfo *info)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#ac0e4e52af419d42f34ce53d368777070">seaf_repo_manager_get_merge_info</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structSeafRepoMergeInfo.html">SeafRepoMergeInfo</a> *&#160;</td>
          <td class="paramname"><em>info</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l05068">5068</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];

    <span class="comment">/* Default not in_merge, if no row is found in db. */</span>
    info-&gt;<a class="code" href="structSeafRepoMergeInfo.html#a511f64caf502d7e67b2ce2d838c5fa51">in_merge</a> = FALSE;

    pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT * FROM MergeInfo WHERE repo_id=&#39;%s&#39;;&quot;</span>,
              repo_id);
    <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql,
                                     get_merge_info, info) &lt; 0) {
        pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
        <span class="keywordflow">return</span> -1;
    }

    pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="af0276c036723560e3e8b9aa5529133d6"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_get_repo" ref="af0276c036723560e3e8b9aa5529133d6" args="(SeafRepoManager *manager, const gchar *id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a>* <a class="el" href="server_2repo-mgr_8h.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const gchar *&#160;</td>
          <td class="paramname"><em>id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04208">4208</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *res;

    <span class="keywordflow">if</span> (pthread_rwlock_rdlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;[repo mgr] failed to lock repo cache.\n&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    res = g_hash_table_lookup (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a46e78181430977b311346c02e5738286">repo_hash</a>, <span class="keywordtype">id</span>);

    pthread_rwlock_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);

    <span class="keywordflow">if</span> (res &amp;&amp; !res-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>)
        <span class="keywordflow">return</span> res;

    <span class="keywordflow">return</span> NULL;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a45b0ed6bbbdfac4fd104962800f426c3"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_get_repo_lantoken" ref="a45b0ed6bbbdfac4fd104962800f426c3" args="(SeafRepoManager *manager, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="daemon_2repo-mgr_8h.html#a45b0ed6bbbdfac4fd104962800f426c3">seaf_repo_manager_get_repo_lantoken</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04258">4258</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];
    <span class="keywordtype">char</span> *ret = NULL;

    pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    snprintf (sql, <span class="keyword">sizeof</span>(sql),
              <span class="stringliteral">&quot;SELECT token FROM RepoLanToken WHERE repo_id=&#39;%s&#39;&quot;</span>,
              repo_id);
    <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql,
                                     get_token, &amp;ret) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;DB error when get token for repo %s.\n&quot;</span>, repo_id);
        pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
        <span class="keywordflow">return</span> NULL;
    }

    pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a5fe41fb7382995f3f335e408ba4ddb30"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_get_repo_list" ref="a5fe41fb7382995f3f335e408ba4ddb30" args="(SeafRepoManager *manager, int start, int limit)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#aa692b1e331cad063425d676afe1ae121">seaf_repo_manager_get_repo_list</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>start</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>limit</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l05161">5161</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *repo_list = NULL;
    GHashTableIter iter;
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
    gpointer key, value;

    <span class="keywordflow">if</span> (pthread_rwlock_rdlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;[repo mgr] failed to lock repo cache.\n&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }
    g_hash_table_iter_init (&amp;iter, manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a46e78181430977b311346c02e5738286">repo_hash</a>);

    <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
        repo = value;
        <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>)
            repo_list = g_list_prepend (repo_list, repo);
    }

    pthread_rwlock_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);

    <span class="keywordflow">return</span> repo_list;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a71edf5bba9589fa8793d7b0312cb9553"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_get_repo_property" ref="a71edf5bba9589fa8793d7b0312cb9553" args="(SeafRepoManager *manager, const char *repo_id, const char *key)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="daemon_2repo-mgr_8h.html#a71edf5bba9589fa8793d7b0312cb9553">seaf_repo_manager_get_repo_property</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>key</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04927">4927</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">return</span> load_repo_property (manager, repo_id, key);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a018177d17e765b6b8519f6537650e1cc"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_get_repo_relay_info" ref="a018177d17e765b6b8519f6537650e1cc" args="(SeafRepoManager *mgr, const char *repo_id, char **relay_addr, char **relay_port)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="daemon_2repo-mgr_8h.html#a018177d17e765b6b8519f6537650e1cc">seaf_repo_manager_get_repo_relay_info</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>relay_addr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>relay_port</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l05353">5353</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *addr, *port;

    addr = load_repo_property (mgr, repo_id, <a class="code" href="daemon_2repo-mgr_8h.html#aed012d90d39cca6687bcc13ab66cb796">REPO_PROP_RELAY_ADDR</a>);
    port = load_repo_property (mgr, repo_id, <a class="code" href="daemon_2repo-mgr_8h.html#a566c5e4d2fcf5f9de3a8e996430a22f4">REPO_PROP_RELAY_PORT</a>);

    <span class="keywordflow">if</span> (relay_addr &amp;&amp; addr)
        *relay_addr = addr;
    <span class="keywordflow">if</span> (relay_port &amp;&amp; port)
        *relay_port = port;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a8dab773e289d1148e7afec7c8614278a"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_init" ref="a8dab773e289d1148e7afec7c8614278a" args="(SeafRepoManager *mgr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a8dab773e289d1148e7afec7c8614278a">seaf_repo_manager_init</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l03932">3932</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ace0bdb78b60b2d088517a3e03a448e8b">checkdir_with_mkdir</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;Index dir %s does not exist and is unable to create\n&quot;</span>,
                   mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>);
        <span class="keywordflow">return</span> -1;
    }

    <span class="comment">/* Load all the repos into memory on the client side. */</span>
    load_repos (mgr, mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ae4df188e5674e3e4b405f14d0ee1bf9f">seaf_dir</a>);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a4002175d5613c80a6dd82b95bc1fae24"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_invalidate_repo_worktree" ref="a4002175d5613c80a6dd82b95bc1fae24" args="(SeafRepoManager *mgr, SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="daemon_2repo-mgr_8h.html#a4002175d5613c80a6dd82b95bc1fae24">seaf_repo_manager_invalidate_repo_worktree</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l03861">3861</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a>)
        <span class="keywordflow">return</span>;

    repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a> = TRUE;

    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a>) {
        <span class="keywordflow">if</span> (<a class="code" href="wt-monitor_8c.html#af6eb142936b07efb92d6b4e6ef650f64">seaf_wt_monitor_unwatch_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a64fc6ad3e80ab34bd2d5ac10dfc1aa66">wt_monitor</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>) &lt; 0) {
            g_warning (<span class="stringliteral">&quot;failed to unwatch repo %s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
        }
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a1705de1c533ed3783c9e7ad4b34f4b96"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_is_ignored_hidden_file" ref="a1705de1c533ed3783c9e7ad4b34f4b96" args="(const char *filename)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gboolean <a class="el" href="daemon_2repo-mgr_8h.html#a1705de1c533ed3783c9e7ad4b34f4b96">seaf_repo_manager_is_ignored_hidden_file</a> </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>filename</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00766">766</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GPatternSpec **spec = ignore_patterns;

    <span class="keywordflow">while</span> (*spec) {
        <span class="keywordflow">if</span> (g_pattern_match_string(*spec, filename))
            <span class="keywordflow">return</span> TRUE;
        spec++;
    }

    <span class="keywordflow">return</span> FALSE;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae45351706ea0868c8e6c9bad500e1785"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_list_garbage_repos" ref="ae45351706ea0868c8e6c9bad500e1785" args="(SeafRepoManager *mgr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2gc_2repo-mgr_8h.html#ae45351706ea0868c8e6c9bad500e1785">seaf_repo_manager_list_garbage_repos</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04068">4068</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *repo_ids = NULL;

    pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>,
                                 <span class="stringliteral">&quot;SELECT repo_id FROM GarbageRepos&quot;</span>,
                                 get_garbage_repo_id, &amp;repo_ids);
    pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="keywordflow">return</span> repo_ids;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad00e4e927e8099054e29e532cae9c5e4"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_load_folder_perms" ref="ad00e4e927e8099054e29e532cae9c5e4" args="(SeafRepoManager *mgr, const char *repo_id, FolderPermType type)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="daemon_2repo-mgr_8h.html#ad00e4e927e8099054e29e532cae9c5e4">seaf_repo_manager_load_folder_perms</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1a">FolderPermType</a>&#160;</td>
          <td class="paramname"><em>type</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00386">386</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *perms = NULL;
    <span class="keywordtype">char</span> sql[256];

    g_return_val_if_fail ((<a class="code" href="fs-mgr_8c.html#a65cfc9e13d3352fd9099a0408cba715c">type</a> == <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa664ef9343772c1e5e20606d23a2f696a">FOLDER_PERM_TYPE_USER</a> ||
                           <a class="code" href="fs-mgr_8c.html#a65cfc9e13d3352fd9099a0408cba715c">type</a> == <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa55b4f2e55f412aa138091a6f350d16de">FOLDER_PERM_TYPE_GROUP</a>),
                          NULL);

    <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#a65cfc9e13d3352fd9099a0408cba715c">type</a> == <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa664ef9343772c1e5e20606d23a2f696a">FOLDER_PERM_TYPE_USER</a>)
        sqlite3_snprintf (<span class="keyword">sizeof</span>(sql), sql,
                          <span class="stringliteral">&quot;SELECT path, permission FROM FolderUserPerms &quot;</span>
                          <span class="stringliteral">&quot;WHERE repo_id = &#39;%q&#39;&quot;</span>,
                          repo_id);
    <span class="keywordflow">else</span>
        sqlite3_snprintf (<span class="keyword">sizeof</span>(sql), sql,
                          <span class="stringliteral">&quot;SELECT path, permission FROM FolderGroupPerms &quot;</span>
                          <span class="stringliteral">&quot;WHERE repo_id = &#39;%q&#39;&quot;</span>,
                          repo_id);

    pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql,
                                     load_folder_perm, &amp;perms) &lt; 0) {
        pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
        GList *ptr;
        <span class="keywordflow">for</span> (ptr = perms; ptr; ptr = ptr-&gt;next)
            <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a16e4a5db024bcc5baf2ef8a3f0623a41">folder_perm_free</a> ((<a class="code" href="struct__FolderPerm.html">FolderPerm</a> *)ptr-&gt;data);
        g_list_free (perms);
        <span class="keywordflow">return</span> NULL;
    }

    pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="comment">/* Sort list in descending order by perm-&gt;path (longer path first). */</span>
    perms = g_list_sort (perms, comp_folder_perms);

    <span class="keywordflow">return</span> perms;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad41b6fcdbf4fdfa7d70daf98af124460"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_mark_repo_deleted" ref="ad41b6fcdbf4fdfa7d70daf98af124460" args="(SeafRepoManager *mgr, SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#ad41b6fcdbf4fdfa7d70daf98af124460">seaf_repo_manager_mark_repo_deleted</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04035">4035</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];

    pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;INSERT INTO DeletedRepo VALUES (&#39;%s&#39;)&quot;</span>,
              repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
    <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql) &lt; 0) {
        pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
        <span class="keywordflow">return</span> -1;
    }

    pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    repo-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a> = TRUE;

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a8f91693d20dfa77546527064cb1097e3"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_new" ref="a8f91693d20dfa77546527064cb1097e3" args="(SeafileSession *seaf)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a>* <a class="el" href="server_2repo-mgr_8h.html#a640edf431de146c19d5ac2cff6321397">seaf_repo_manager_new</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2seafile-session_8h.html#a3412e7ea22f43083cdc07acffa80f859">SeafileSession</a> *&#160;</td>
          <td class="paramname"><em>seaf</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l03899">3899</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = g_new0 (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a>, 1);

    mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a> = g_new0 (<a class="code" href="struct__SeafRepoManagerPriv.html">SeafRepoManagerPriv</a>, 1);
    mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a> = <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>;
    mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a> = g_build_path (<a class="code" href="vc-utils_8h.html#aa7da4cdc6796b13fca1a4b263488dfdd">PATH_SEPERATOR</a>, seaf-&gt;<a class="code" href="struct__SeafileSession.html#ae4df188e5674e3e4b405f14d0ee1bf9f">seaf_dir</a>, <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a823aa5bebe4b4b836619cae12751b8a5">INDEX_DIR</a>, NULL);

    pthread_mutex_init (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>, NULL);

    mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a7fde21f0d7bba66fac76f4783377f20c">checkout_tasks_hash</a> = g_hash_table_new_full
        (g_str_hash, g_str_equal, g_free, g_free);

    ignore_patterns = g_new0 (GPatternSpec*, G_N_ELEMENTS(ignore_table));
    <span class="keywordtype">int</span> i;
    <span class="keywordflow">for</span> (i = 0; ignore_table[i] != NULL; i++) {
        ignore_patterns[i] = g_pattern_spec_new (ignore_table[i]);
    }

    office_temp_ignore_patterns[0] = g_pattern_spec_new(<span class="stringliteral">&quot;~$*&quot;</span>);
    <span class="comment">/* for files like ~WRL0001.tmp */</span>
    office_temp_ignore_patterns[1] = g_pattern_spec_new(<span class="stringliteral">&quot;~*.tmp&quot;</span>);
    office_temp_ignore_patterns[2] = g_pattern_spec_new(<span class="stringliteral">&quot;.~lock*#&quot;</span>);
    office_temp_ignore_patterns[3] = NULL;

    mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a46e78181430977b311346c02e5738286">repo_hash</a> = g_hash_table_new_full (g_str_hash, g_str_equal, g_free, NULL);

    pthread_rwlock_init (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>, NULL);

    <span class="keywordflow">return</span> mgr;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a7d2cf85f06fa2e7d459730f7494c1a65"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_remove_garbage_repo" ref="a7d2cf85f06fa2e7d459730f7494c1a65" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="server_2gc_2repo-mgr_8h.html#a7d2cf85f06fa2e7d459730f7494c1a65">seaf_repo_manager_remove_garbage_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04083">4083</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];

    pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM GarbageRepos WHERE repo_id=&#39;%s&#39;&quot;</span>,
              repo_id);
    <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);

    pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a008f145440cf3620f7883d1fe109f69c"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_remove_repo_ondisk" ref="a008f145440cf3620f7883d1fe109f69c" args="(SeafRepoManager *mgr, const char *repo_id, gboolean add_deleted_record)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="daemon_2repo-mgr_8h.html#a008f145440cf3620f7883d1fe109f69c">seaf_repo_manager_remove_repo_ondisk</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gboolean&#160;</td>
          <td class="paramname"><em>add_deleted_record</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04097">4097</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];

    <span class="comment">/* We don&#39;t need to care about I/O errors here, since we can</span>
<span class="comment">     * GC any unreferenced repo data later.</span>
<span class="comment">     */</span>

    <span class="keywordflow">if</span> (add_deleted_record) {
        snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;REPLACE INTO GarbageRepos VALUES (&#39;%s&#39;)&quot;</span>,
                  repo_id);
        <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql) &lt; 0)
            <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Once the item in Repo table is deleted, the repo is gone.</span>
<span class="comment">     * This is the &quot;commit point&quot;.</span>
<span class="comment">     */</span>
    pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM Repo WHERE repo_id = &#39;%s&#39;&quot;</span>, repo_id);
    <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql) &lt; 0)
        <span class="keywordflow">goto</span> out;

    snprintf (sql, <span class="keyword">sizeof</span>(sql), 
              <span class="stringliteral">&quot;DELETE FROM DeletedRepo WHERE repo_id = &#39;%s&#39;&quot;</span>, repo_id);
    <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);

    pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="comment">/* remove index */</span>
    <span class="keywordtype">char</span> path[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    snprintf (path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>, repo_id);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a26f091009701c5a9d1886b9d6ceb9c8e">seaf_util_unlink</a> (path);

    <span class="comment">/* remove branch */</span>
    GList *p;
    GList *branch_list = 
        <a class="code" href="branch-mgr_8c.html#ad5bd62cbe17cb8fe91bcd993956a1fbf">seaf_branch_manager_get_branch_list</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo_id);
    <span class="keywordflow">for</span> (p = branch_list; p; p = p-&gt;next) {
        <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *b = (<a class="code" href="struct__SeafBranch.html">SeafBranch</a> *)p-&gt;data;
        <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ae586fb5fbd61d6b44be3e47e7b6c86da">seaf_repo_manager_branch_repo_unmap</a> (mgr, b);
        <a class="code" href="branch-mgr_8c.html#a16b2df7708f3a4c4b96e9135ec7e1a3d">seaf_branch_manager_del_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo_id, b-&gt;<a class="code" href="struct__SeafBranch.html#ae6af0006b9b80ded4f0525a3be06ccda">name</a>);
    }
    <a class="code" href="branch-mgr_8c.html#ac6476414064e0ff0c429629aaab0bfc9">seaf_branch_list_free</a> (branch_list);

    <span class="comment">/* delete repo property firstly */</span>
    seaf_repo_manager_del_repo_property (mgr, repo_id);

    pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM RepoPasswd WHERE repo_id = &#39;%s&#39;&quot;</span>, 
              repo_id);
    <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM RepoKeys WHERE repo_id = &#39;%s&#39;&quot;</span>, 
              repo_id);
    <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);

    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM MergeInfo WHERE repo_id = &#39;%s&#39;&quot;</span>, 
              repo_id);
    <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);

<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM LockedFiles WHERE repo_id = &#39;%s&#39;&quot;</span>,
              repo_id);
    <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM FolderUserPerms WHERE repo_id = &#39;%s&#39;&quot;</span>, 
              repo_id);
    <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);

    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM FolderGroupPerms WHERE repo_id = &#39;%s&#39;&quot;</span>, 
              repo_id);
    <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);

    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM FolderPermTimestamp WHERE repo_id = &#39;%s&#39;&quot;</span>, 
              repo_id);
    <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);

out:
    pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="abbca41e16d1632518aedb8cbe31199b5"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_remove_repo_token" ref="abbca41e16d1632518aedb8cbe31199b5" args="(SeafRepoManager *manager, SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#abbca41e16d1632518aedb8cbe31199b5">seaf_repo_manager_remove_repo_token</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l05332">5332</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a0ce3b61cb31e78ffea429615379b3eb4">token</a>);
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a0ce3b61cb31e78ffea429615379b3eb4">token</a> = NULL;
    seaf_repo_manager_del_repo_property_by_key(manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a1d2a9886ff3a1d69407ba0b287cbeac4">REPO_PROP_TOKEN</a>);
    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a4b2497e6cdde50c4ce3cb642370e06eb"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_repo_exists" ref="a4b2497e6cdde50c4ce3cb642370e06eb" args="(SeafRepoManager *manager, const gchar *id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gboolean <a class="el" href="server_2repo-mgr_8h.html#a4b2497e6cdde50c4ce3cb642370e06eb">seaf_repo_manager_repo_exists</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const gchar *&#160;</td>
          <td class="paramname"><em>id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04228">4228</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *res;

    <span class="keywordflow">if</span> (pthread_rwlock_rdlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;[repo mgr] failed to lock repo cache.\n&quot;</span>);
        <span class="keywordflow">return</span> FALSE;
    }

    res = g_hash_table_lookup (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a46e78181430977b311346c02e5738286">repo_hash</a>, <span class="keywordtype">id</span>);

    pthread_rwlock_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);

    <span class="keywordflow">if</span> (res &amp;&amp; !res-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>)
        <span class="keywordflow">return</span> TRUE;
    
    <span class="keywordflow">return</span> FALSE;
}
</pre></div>
</div>
</div>
<a class="anchor" id="af2f71495e665325efae99d4beb03deb5"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_set_common_ancestor" ref="af2f71495e665325efae99d4beb03deb5" args="(SeafRepoManager *manager, const char *repo_id, const char *common_ancestor, const char *head_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#af2f71495e665325efae99d4beb03deb5">seaf_repo_manager_set_common_ancestor</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>common_ancestor</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>head_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l05142">5142</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];

    pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    snprintf (sql, <span class="keyword">sizeof</span>(sql),
              <span class="stringliteral">&quot;REPLACE INTO CommonAncestor VALUES (&#39;%s&#39;, &#39;%s&#39;, &#39;%s&#39;);&quot;</span>,
              repo_id, common_ancestor, head_id);
    <span class="keywordtype">int</span> ret = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);

    pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a2e382a4324579845c975befc11cccda2"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_set_merge" ref="a2e382a4324579845c975befc11cccda2" args="(SeafRepoManager *manager, const char *repo_id, const char *remote_head)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#a2e382a4324579845c975befc11cccda2">seaf_repo_manager_set_merge</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>remote_head</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l05014">5014</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];

    pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;REPLACE INTO MergeInfo VALUES (&#39;%s&#39;, 1, &#39;%s&#39;);&quot;</span>,
              repo_id, remote_head);
    <span class="keywordtype">int</span> ret = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);

    pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a4f525e2d8e12d4d8afab74b4291c24d3"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_set_repo_email" ref="a4f525e2d8e12d4d8afab74b4291c24d3" args="(SeafRepoManager *mgr, SeafRepo *repo, const char *email)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#a5e3f5c1717bcd26c075860f5bc061e33">seaf_repo_manager_set_repo_email</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>email</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l05307">5307</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a>);
    repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a> = g_strdup(email);

    save_repo_property (mgr, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a710e166548b51934b6a3d916eb86442e">REPO_PROP_EMAIL</a>, email);
    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a93b2f3d8f0964708f8fb0450fded2a42"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_set_repo_lantoken" ref="a93b2f3d8f0964708f8fb0450fded2a42" args="(SeafRepoManager *manager, const char *repo_id, const char *token)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#a93b2f3d8f0964708f8fb0450fded2a42">seaf_repo_manager_set_repo_lantoken</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>token</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04282">4282</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];
    sqlite3 *db = manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>;

    pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;REPLACE INTO RepoLanToken VALUES (&#39;%s&#39;, &#39;%s&#39;);&quot;</span>,
              repo_id, token);
    <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql) &lt; 0) {
        pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
        <span class="keywordflow">return</span> -1;
    }

    pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a683d25df06076d282da2f7ae01e05a49"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_set_repo_passwd" ref="a683d25df06076d282da2f7ae01e05a49" args="(SeafRepoManager *manager, SeafRepo *repo, const char *passwd)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#a683d25df06076d282da2f7ae01e05a49">seaf_repo_manager_set_repo_passwd</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>passwd</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04994">4994</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> ret;

    <span class="keywordflow">if</span> (<a class="code" href="seafile-crypt_8c.html#af0dc7b06b352baa5469b21beec40f73a">seafile_decrypt_repo_enc_key</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>, passwd, repo-&gt;<a class="code" href="struct__SeafRepo.html#a83e0a2366ba320396f2deb6faa167b84">random_key</a>,
                                      repo-&gt;<a class="code" href="struct__SeafRepo.html#ad951f63e287f0ea14c863937afea6779">enc_key</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a7ad105e1fab206035f1c585c25e0dc94">enc_iv</a>) &lt; 0)
        <span class="keywordflow">return</span> -1;

    pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    ret = save_repo_enc_info (manager, repo);

    pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a9d2f586c85f26b2de677fd03606103aa"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_set_repo_property" ref="a9d2f586c85f26b2de677fd03606103aa" args="(SeafRepoManager *manager, const char *repo_id, const char *key, const char *value)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>value</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04874">4874</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;

    repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (manager, repo_id);
    <span class="keywordflow">if</span> (!repo)
        <span class="keywordflow">return</span> -1;

    <span class="keywordflow">if</span> (strcmp(key, <a class="code" href="daemon_2repo-mgr_8h.html#a2d6340e4ada61e93d58c0411fa6fcfe5">REPO_AUTO_SYNC</a>) == 0) {
        <span class="keywordflow">if</span> (!<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a5432788378b921624977855244c63a85">started</a>) {
            seaf_message (<span class="stringliteral">&quot;System not started, skip setting auto sync value.\n&quot;</span>);
            <span class="keywordflow">return</span> 0;
        }

        <span class="keywordflow">if</span> (g_strcmp0(value, <span class="stringliteral">&quot;true&quot;</span>) == 0) {
            repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a> = 1;
            <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>)
                <a class="code" href="wt-monitor_8c.html#aa6375a36881f0c171399a5116e64f061">seaf_wt_monitor_watch_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a64fc6ad3e80ab34bd2d5ac10dfc1aa66">wt_monitor</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
                                            repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>);
            repo-&gt;<a class="code" href="struct__SeafRepo.html#aea8a8f2c57241ca9b47ae1e7026b4ea5">last_sync_time</a> = 0;
        } <span class="keywordflow">else</span> {
            repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a> = 0;
            <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>)
                <a class="code" href="wt-monitor_8c.html#af6eb142936b07efb92d6b4e6ef650f64">seaf_wt_monitor_unwatch_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a64fc6ad3e80ab34bd2d5ac10dfc1aa66">wt_monitor</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
            <span class="comment">/* Cancel current sync task if any. */</span>
            <a class="code" href="sync-mgr_8c.html#a0b90f2ae7c7e7a85ae97b7ade254572a">seaf_sync_manager_cancel_sync_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a6b2a5e1e723955885f9fb27c5f064df4">sync_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
        }
    }
    <span class="keywordflow">if</span> (strcmp(key, <a class="code" href="daemon_2repo-mgr_8h.html#a4dc57106ac24f4cf008c10b85ae1e384">REPO_NET_BROWSABLE</a>) == 0) {
        <span class="keywordflow">if</span> (g_strcmp0(value, <span class="stringliteral">&quot;true&quot;</span>) == 0)
            repo-&gt;<a class="code" href="struct__SeafRepo.html#a575e562d38b7fc0adc79a6b24ea00ac1">net_browsable</a> = 1;
        <span class="keywordflow">else</span>
            repo-&gt;<a class="code" href="struct__SeafRepo.html#a575e562d38b7fc0adc79a6b24ea00ac1">net_browsable</a> = 0;
    }

    <span class="keywordflow">if</span> (strcmp(key, <a class="code" href="daemon_2repo-mgr_8h.html#a88e179c17ec642b434e82bb40403a6ba">REPO_RELAY_ID</a>) == 0)
        <span class="keywordflow">return</span> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ad2263393047e4ea1f5226842b11e7b05">seaf_repo_manager_set_repo_relay_id</a> (manager, repo, value);

    <span class="keywordflow">if</span> (strcmp (key, <a class="code" href="daemon_2repo-mgr_8h.html#a55797c21d6209596736b5a81a8411ff9">REPO_PROP_SERVER_URL</a>) == 0) {
        <span class="keywordtype">char</span> *url = canonical_server_url (value);
        repo-&gt;<a class="code" href="struct__SeafRepo.html#a1a7beee19acb913be2c23ac0e71ea733">server_url</a> = url;
        save_repo_property (manager, repo_id, key, url);
        <span class="keywordflow">return</span> 0;
    }

    save_repo_property (manager, repo_id, key, value);
    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad2263393047e4ea1f5226842b11e7b05"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_set_repo_relay_id" ref="ad2263393047e4ea1f5226842b11e7b05" args="(SeafRepoManager *mgr, SeafRepo *repo, const char *relay_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#ad2263393047e4ea1f5226842b11e7b05">seaf_repo_manager_set_repo_relay_id</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>relay_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04843">4843</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (relay_id &amp;&amp; strlen(relay_id) != 40)
        <span class="keywordflow">return</span> -1;

    save_repo_property (mgr, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a88e179c17ec642b434e82bb40403a6ba">REPO_RELAY_ID</a>, relay_id);

    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>);

    <span class="keywordflow">if</span> (relay_id)
        repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a> = g_strdup (relay_id);
    <span class="keywordflow">else</span>
        repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a> = NULL;        
    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a8539157b5ddbb1e183886ac3f03b0f0d"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_set_repo_relay_info" ref="a8539157b5ddbb1e183886ac3f03b0f0d" args="(SeafRepoManager *mgr, const char *repo_id, const char *relay_addr, const char *relay_port)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#ad1d48cf5dc2e28f66ad0c1c0c33f04dc">seaf_repo_manager_set_repo_relay_info</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>relay_addr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>relay_port</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l05342">5342</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    save_repo_property (mgr, repo_id, <a class="code" href="daemon_2repo-mgr_8h.html#aed012d90d39cca6687bcc13ab66cb796">REPO_PROP_RELAY_ADDR</a>, relay_addr);
    save_repo_property (mgr, repo_id, <a class="code" href="daemon_2repo-mgr_8h.html#a566c5e4d2fcf5f9de3a8e996430a22f4">REPO_PROP_RELAY_PORT</a>, relay_port);
    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a4fdafbeb326de99eec7160b72bcc3dd4"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_set_repo_token" ref="a4fdafbeb326de99eec7160b72bcc3dd4" args="(SeafRepoManager *manager, SeafRepo *repo, const char *token)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#a4fdafbeb326de99eec7160b72bcc3dd4">seaf_repo_manager_set_repo_token</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>token</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l05319">5319</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a0ce3b61cb31e78ffea429615379b3eb4">token</a>);
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a0ce3b61cb31e78ffea429615379b3eb4">token</a> = g_strdup(token);

    save_repo_property (manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a1d2a9886ff3a1d69407ba0b287cbeac4">REPO_PROP_TOKEN</a>, token);
    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a6ed05df6501a326fc58a0fefb91aef3d"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_set_repo_worktree" ref="a6ed05df6501a326fc58a0fefb91aef3d" args="(SeafRepoManager *mgr, SeafRepo *repo, const char *worktree)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#a6ed05df6501a326fc58a0fefb91aef3d">seaf_repo_manager_set_repo_worktree</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>worktree</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l03839">3839</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (g_access(worktree, F_OK) != 0)
        <span class="keywordflow">return</span> -1;

    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>)
        g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>);
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a> = g_strdup(worktree);

    <span class="keywordflow">if</span> (<a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (mgr, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
                                             <span class="stringliteral">&quot;worktree&quot;</span>,
                                             repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>) &lt; 0)
        <span class="keywordflow">return</span> -1;

    repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a> = FALSE;

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a2e049cfa3d0546aaf51e7f6792e1467d"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_start" ref="a2e049cfa3d0546aaf51e7f6792e1467d" args="(SeafRepoManager *mgr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a2e049cfa3d0546aaf51e7f6792e1467d">seaf_repo_manager_start</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l03968">3968</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    watch_repos (mgr);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="af7adb54d2ed6bcfd5b722428bfcfb6d6"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_update_folder_perm_timestamp" ref="af7adb54d2ed6bcfd5b722428bfcfb6d6" args="(SeafRepoManager *mgr, const char *repo_id, gint64 timestamp)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#af7adb54d2ed6bcfd5b722428bfcfb6d6">seaf_repo_manager_update_folder_perm_timestamp</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gint64&#160;</td>
          <td class="paramname"><em>timestamp</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00429">429</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];
    <span class="keywordtype">int</span> ret;

    snprintf (sql, <span class="keyword">sizeof</span>(sql),
              <span class="stringliteral">&quot;REPLACE INTO FolderPermTimestamp VALUES (&#39;%s&#39;, %&quot;</span>G_GINT64_FORMAT<span class="stringliteral">&quot;)&quot;</span>,
              repo_id, timestamp);

    pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    ret = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);

    pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a446e8f23cdec415146a604f1b954c1a3"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_update_folder_perms" ref="a446e8f23cdec415146a604f1b954c1a3" args="(SeafRepoManager *mgr, const char *repo_id, FolderPermType type, GList *folder_perms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#a446e8f23cdec415146a604f1b954c1a3">seaf_repo_manager_update_folder_perms</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1a">FolderPermType</a>&#160;</td>
          <td class="paramname"><em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GList *&#160;</td>
          <td class="paramname"><em>folder_perms</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00294">294</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    sqlite3_stmt *stmt;
    GList *ptr;
    <a class="code" href="struct__FolderPerm.html">FolderPerm</a> *perm;

    g_return_val_if_fail ((<a class="code" href="fs-mgr_8c.html#a65cfc9e13d3352fd9099a0408cba715c">type</a> == <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa664ef9343772c1e5e20606d23a2f696a">FOLDER_PERM_TYPE_USER</a> ||
                           <a class="code" href="fs-mgr_8c.html#a65cfc9e13d3352fd9099a0408cba715c">type</a> == <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa55b4f2e55f412aa138091a6f350d16de">FOLDER_PERM_TYPE_GROUP</a>),
                          -1);

    pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#a65cfc9e13d3352fd9099a0408cba715c">type</a> == <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa664ef9343772c1e5e20606d23a2f696a">FOLDER_PERM_TYPE_USER</a>)
        sql = <span class="stringliteral">&quot;DELETE FROM FolderUserPerms WHERE repo_id = ?&quot;</span>;
    <span class="keywordflow">else</span>
        sql = <span class="stringliteral">&quot;DELETE FROM FolderGroupPerms WHERE repo_id = ?&quot;</span>;
    stmt = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a4d1d0eb407f8f5dd522c3875beb7b9c8">sqlite_query_prepare</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
    sqlite3_bind_text (stmt, 1, repo_id, -1, SQLITE_TRANSIENT);
    <span class="keywordflow">if</span> (sqlite3_step (stmt) != SQLITE_DONE) {
        seaf_warning (<span class="stringliteral">&quot;Failed to remove folder perms for %.8s: %s.\n&quot;</span>,
                      repo_id, sqlite3_errmsg (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>));
        sqlite3_finalize (stmt);
        pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
        <span class="keywordflow">return</span> -1;
    }
    sqlite3_finalize (stmt);

    <span class="keywordflow">if</span> (!folder_perms) {
        pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
        <span class="keywordflow">return</span> 0;
    }

    <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#a65cfc9e13d3352fd9099a0408cba715c">type</a> == <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa664ef9343772c1e5e20606d23a2f696a">FOLDER_PERM_TYPE_USER</a>)
        sql = <span class="stringliteral">&quot;INSERT INTO FolderUserPerms VALUES (?, ?, ?)&quot;</span>;
    <span class="keywordflow">else</span>
        sql = <span class="stringliteral">&quot;INSERT INTO FolderGroupPerms VALUES (?, ?, ?)&quot;</span>;
    stmt = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a4d1d0eb407f8f5dd522c3875beb7b9c8">sqlite_query_prepare</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);

    <span class="keywordflow">for</span> (ptr = folder_perms; ptr; ptr = ptr-&gt;next) {
        perm = ptr-&gt;data;

        sqlite3_bind_text (stmt, 1, repo_id, -1, SQLITE_TRANSIENT);
        sqlite3_bind_text (stmt, 2, perm-&gt;<a class="code" href="struct__FolderPerm.html#a1d44107695fb128bdc7de3a224a69d42">path</a>, -1, SQLITE_TRANSIENT);
        sqlite3_bind_text (stmt, 3, perm-&gt;<a class="code" href="struct__FolderPerm.html#a5032277d09756796f0d26e373383dac6">permission</a>, -1, SQLITE_TRANSIENT);

        <span class="keywordflow">if</span> (sqlite3_step (stmt) != SQLITE_DONE) {
            seaf_warning (<span class="stringliteral">&quot;Failed to insert folder perms for %.8s: %s.\n&quot;</span>,
                          repo_id, sqlite3_errmsg (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>));
            sqlite3_finalize (stmt);
            pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
            <span class="keywordflow">return</span> -1;
        }

        sqlite3_reset (stmt);
        sqlite3_clear_bindings (stmt);
    }

    sqlite3_finalize (stmt);

    pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aaca4b8f68d91db58fc8e1484d9695ce6"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_update_repo_relay_info" ref="aaca4b8f68d91db58fc8e1484d9695ce6" args="(SeafRepoManager *mgr, SeafRepo *repo, const char *new_addr, const char *new_port)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#aaca4b8f68d91db58fc8e1484d9695ce6">seaf_repo_manager_update_repo_relay_info</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new_addr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new_port</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l05370">5370</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *ptr, *repos = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a5fe41fb7382995f3f335e408ba4ddb30">seaf_repo_manager_get_repo_list</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, 0, -1);
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *r;
    <span class="keywordflow">for</span> (ptr = repos; ptr; ptr = ptr-&gt;next) {
        r = ptr-&gt;data;
        <span class="keywordflow">if</span> (g_strcmp0(r-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>) != 0)
            <span class="keywordflow">continue</span>;

        <span class="keywordtype">char</span> *relay_addr = NULL;
        <span class="keywordtype">char</span> *relay_port = NULL;
        <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a018177d17e765b6b8519f6537650e1cc">seaf_repo_manager_get_repo_relay_info</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, r-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
                                               &amp;relay_addr, &amp;relay_port);
        <span class="keywordflow">if</span> (g_strcmp0(relay_addr, new_addr) != 0 ||
            g_strcmp0(relay_port, new_port) != 0) {
            <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a8539157b5ddbb1e183886ac3f03b0f0d">seaf_repo_manager_set_repo_relay_info</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, r-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
                                                   new_addr, new_port);
        }

        g_free (relay_addr);
        g_free (relay_port);
    }

    g_list_free (repos);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae3753999b4845dfe68bd6f098313280c"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_update_repos_server_host" ref="ae3753999b4845dfe68bd6f098313280c" args="(SeafRepoManager *mgr, const char *old_host, const char *new_host, const char *new_server_url)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#ae3753999b4845dfe68bd6f098313280c">seaf_repo_manager_update_repos_server_host</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>old_host</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new_host</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new_server_url</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l05402">5402</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *ptr, *repos = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a5fe41fb7382995f3f335e408ba4ddb30">seaf_repo_manager_get_repo_list</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, 0, -1);
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *r;
    <span class="keywordflow">for</span> (ptr = repos; ptr; ptr = ptr-&gt;next) {
        r = ptr-&gt;data;
                
        <span class="keywordtype">char</span> *relay_addr = NULL;
        <span class="keywordtype">char</span> *relay_port = NULL;
        <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a018177d17e765b6b8519f6537650e1cc">seaf_repo_manager_get_repo_relay_info</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, r-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, 
                                               &amp;relay_addr, &amp;relay_port);
        <span class="keywordflow">if</span> (g_strcmp0(relay_addr, old_host) == 0) {
            <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a8539157b5ddbb1e183886ac3f03b0f0d">seaf_repo_manager_set_repo_relay_info</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, r-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
                                                   new_host, relay_port);
            <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (
                <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, r-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a55797c21d6209596736b5a81a8411ff9">REPO_PROP_SERVER_URL</a>, new_server_url);
        }

        g_free (relay_addr);
        g_free (relay_port);
    }

    g_list_free (repos);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a8299b47936df15cd58ba2ae41e344450"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_validate_repo_worktree" ref="a8299b47936df15cd58ba2ae41e344450" args="(SeafRepoManager *mgr, SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="daemon_2repo-mgr_8h.html#a8299b47936df15cd58ba2ae41e344450">seaf_repo_manager_validate_repo_worktree</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l03877">3877</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a>)
        <span class="keywordflow">return</span>;

    repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a> = FALSE;

    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a>) {
        <span class="keywordflow">if</span> (<a class="code" href="wt-monitor_8c.html#aa6375a36881f0c171399a5116e64f061">seaf_wt_monitor_watch_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a64fc6ad3e80ab34bd2d5ac10dfc1aa66">wt_monitor</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>) &lt; 0) {
            g_warning (<span class="stringliteral">&quot;failed to watch repo %s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
        }
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a297f8a46a2390465725298d9a08c1145"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_verify_repo_lantoken" ref="a297f8a46a2390465725298d9a08c1145" args="(SeafRepoManager *manager, const char *repo_id, const char *token)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#a297f8a46a2390465725298d9a08c1145">seaf_repo_manager_verify_repo_lantoken</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>token</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04304">4304</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> ret = 0;
    <span class="keywordflow">if</span> (!token)
        <span class="keywordflow">return</span> 0;

    <span class="keywordtype">char</span> *my_token = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a45b0ed6bbbdfac4fd104962800f426c3">seaf_repo_manager_get_repo_lantoken</a> (manager, repo_id);

    <span class="keywordflow">if</span> (!my_token) {
        <span class="keywordflow">if</span> (memcmp (<a class="code" href="daemon_2repo-mgr_8h.html#afa2f07ad83586c04020cc7fa2760ff1a">DEFAULT_REPO_TOKEN</a>, token, strlen(token)) == 0)
            ret = 1;
    } <span class="keywordflow">else</span> {
        <span class="keywordflow">if</span> (memcmp (my_token, token, strlen(token)) == 0)
            ret = 1;
        g_free (my_token);
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae27495cf631eca68cf5e94048b7e66f2"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_manager_verify_tmp_token" ref="ae27495cf631eca68cf5e94048b7e66f2" args="(SeafRepoManager *manager, const char *repo_id, const char *peer_id, const char *token)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#ae27495cf631eca68cf5e94048b7e66f2">seaf_repo_manager_verify_tmp_token</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>peer_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>token</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04352">4352</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> ret;
    <span class="keywordtype">char</span> sql[512];
    <span class="keywordflow">if</span> (!repo_id || !peer_id || !token)
        <span class="keywordflow">return</span> 0;

    pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
    snprintf (sql, 512, <span class="stringliteral">&quot;SELECT timestamp FROM RepoTmpToken &quot;</span>
              <span class="stringliteral">&quot;WHERE repo_id=&#39;%s&#39; AND peer_id=&#39;%s&#39; AND token=&#39;%s&#39;&quot;</span>,
              repo_id, peer_id, token);
    ret = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#aceca02fb8bd317ba59939bae695d1a48">sqlite_check_for_existence</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
    <span class="keywordflow">if</span> (ret) {
        snprintf (sql, 512, <span class="stringliteral">&quot;DELETE FROM RepoTmpToken WHERE &quot;</span>
                  <span class="stringliteral">&quot;repo_id=&#39;%s&#39; AND peer_id=&#39;%s&#39;&quot;</span>,
                  repo_id, peer_id);
        <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
    }
    pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a25b9a6f8f5199db34dcb95789a80eba4"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_merge" ref="a25b9a6f8f5199db34dcb95789a80eba4" args="(SeafRepo *repo, const char *branch, char **error, int *merge_status)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="daemon_2repo-mgr_8h.html#a25b9a6f8f5199db34dcb95789a80eba4">seaf_repo_merge</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>branch</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>error</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>merge_status</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l02902">2902</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *remote_branch;
    <span class="keywordtype">int</span> ret = 0;

    <span class="keywordflow">if</span> (!check_worktree_common (repo))
        <span class="keywordflow">return</span> -1;

    remote_branch = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>,
                                                    repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
                                                    branch);
    <span class="keywordflow">if</span> (!remote_branch) {
        *error = g_strdup(<span class="stringliteral">&quot;Invalid remote branch.\n&quot;</span>);
        <span class="keywordflow">goto</span> error;
    }

    <span class="keywordflow">if</span> (g_strcmp0 (remote_branch-&gt;<a class="code" href="struct__SeafBranch.html#a88717f46308eb12629b99f9ff91740c2">repo_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>) != 0) {
        *error = g_strdup (<span class="stringliteral">&quot;Remote branch is not in this repository.\n&quot;</span>);
        <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (remote_branch);
        <span class="keywordflow">goto</span> error;
    }

    ret = <a class="code" href="merge_8c.html#a65b859e991bbf3718673fa75b0251c85">merge_branches</a> (repo, remote_branch, error, merge_status);
    <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (remote_branch);

    <span class="keywordflow">return</span> ret;

error:
    <span class="keywordflow">return</span> -1;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a63ab9fe4694e3d967376c911cbe2c655"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_new" ref="a63ab9fe4694e3d967376c911cbe2c655" args="(const char *id, const char *name, const char *desc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a>* <a class="el" href="server_2repo-mgr_8h.html#a63ab9fe4694e3d967376c911cbe2c655">seaf_repo_new</a> </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>desc</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00536">536</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a>* repo;

    <span class="comment">/* valid check */</span>
  
    
    repo = g_new0 (<a class="code" href="struct__SeafRepo.html">SeafRepo</a>, 1);
    memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="keywordtype">id</span>, 36);
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>[36] = <span class="charliteral">&#39;\0&#39;</span>;

    repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a> = g_strdup(<a class="code" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>);
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a> = g_strdup(desc);

    repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a> = TRUE;
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a> = 1;
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a575e562d38b7fc0adc79a6b24ea00ac1">net_browsable</a> = 0;
    pthread_mutex_init (&amp;repo-&gt;<a class="code" href="struct__SeafRepo.html#aaa93119bb8b7b6038e9feb3c3a78b0ab">lock</a>, NULL);

    <span class="keywordflow">return</span> repo;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a6c47d6277897f6afbe866f2755f9762d"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_set_head" ref="a6c47d6277897f6afbe866f2755f9762d" args="(SeafRepo *repo, SeafBranch *branch)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a6c47d6277897f6afbe866f2755f9762d">seaf_repo_set_head</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="branch-mgr_8h.html#a43063fab0cfaf940abc07b1cd941fb85">SeafBranch</a> *&#160;</td>
          <td class="paramname"><em>branch</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00631">631</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (save_branch_repo_map (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>, branch) &lt; 0)
        <span class="keywordflow">return</span> -1;
    set_head_common (repo, branch);
    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a01b64563a9ab1351f8a9626c86ff8d6a"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_set_readonly" ref="a01b64563a9ab1351f8a9626c86ff8d6a" args="(SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="daemon_2repo-mgr_8h.html#a01b64563a9ab1351f8a9626c86ff8d6a">seaf_repo_set_readonly</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00752">752</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a> = TRUE;
    save_repo_property (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a152076b2a531e04976bdc390e8d43b92">REPO_PROP_IS_READONLY</a>, <span class="stringliteral">&quot;true&quot;</span>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a39a9a41ffdfc324f3c935251d9e14d51"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_to_commit" ref="a39a9a41ffdfc324f3c935251d9e14d51" args="(SeafRepo *repo, SeafCommit *commit)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="server_2repo-mgr_8h.html#a39a9a41ffdfc324f3c935251d9e14d51">seaf_repo_to_commit</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="commit-mgr_8h.html#ab20cfcee12e164d94824e8be23c2c8ea">SeafCommit</a> *&#160;</td>
          <td class="paramname"><em>commit</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00682">682</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    commit-&gt;<a class="code" href="struct__SeafCommit.html#aacd7b88f8a3e72446cd7352396eaa09e">repo_name</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>);
    commit-&gt;<a class="code" href="struct__SeafCommit.html#aa3d8e868c630cfbecbcb9158c4bbe2e4">repo_desc</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a>);
    commit-&gt;<a class="code" href="struct__SeafCommit.html#a906e77d2a658f4337437ff8694a4bfc0">encrypted</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>;
    <span class="keywordflow">if</span> (commit-&gt;<a class="code" href="struct__SeafCommit.html#a906e77d2a658f4337437ff8694a4bfc0">encrypted</a>) {
        commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>;
        <span class="keywordflow">if</span> (commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a> == 1)
            commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>);
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a> == 2) {
            commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>);
            commit-&gt;<a class="code" href="struct__SeafCommit.html#ab1d44814bc44472105aef8761656e3d7">random_key</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a83e0a2366ba320396f2deb6faa167b84">random_key</a>);
        }
    }
    commit-&gt;<a class="code" href="struct__SeafCommit.html#a383ea4a4b94417c7d9e9827d60420d64">no_local_history</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#a4710aaee11c7887df402fffa7ca6c54f">no_local_history</a>;
    commit-&gt;<a class="code" href="struct__SeafCommit.html#abc83f168ce2b43fa864522bf0ea26d6d">version</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="af712f7a4551fbc0dfa780f3aada0a029"></a><!-- doxytag: member="repo&#45;mgr.c::seaf_repo_unset_readonly" ref="af712f7a4551fbc0dfa780f3aada0a029" args="(SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="daemon_2repo-mgr_8h.html#af712f7a4551fbc0dfa780f3aada0a029">seaf_repo_unset_readonly</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00759">759</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a> = FALSE;
    save_repo_property (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a152076b2a531e04976bdc390e8d43b92">REPO_PROP_IS_READONLY</a>, <span class="stringliteral">&quot;false&quot;</span>);
}
</pre></div>
</div>
</div>
</div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Wed Aug 19 2015 02:52:52 for My Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
