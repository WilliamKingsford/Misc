<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>My Project: seafile-4.1.2/server/repo-mgr.h File Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">My Project
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#define-members">Defines</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">seafile-4.1.2/server/repo-mgr.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;seafile-object.h&quot;</code><br/>
<code>#include &quot;<a class="el" href="commit-mgr_8h_source.html">commit-mgr.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="branch-mgr_8h_source.html">branch-mgr.h</a>&quot;</code><br/>
</div><div class="textblock"><div class="dynheader">
Include dependency graph for repo-mgr.h:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h__incl.png" border="0" usemap="#seafile-4_81_82_2server_2repo-mgr_8h" alt=""/></div>
<map name="seafile-4_81_82_2server_2repo-mgr_8h" id="seafile-4_81_82_2server_2repo-mgr_8h">
<area shape="rect" id="node5" href="commit-mgr_8h.html" title="commit&#45;mgr.h" alt="" coords="144,160,245,189"/><area shape="rect" id="node17" href="branch-mgr_8h.html" title="branch&#45;mgr.h" alt="" coords="189,83,288,112"/><area shape="rect" id="node11" href="obj-store_8h.html" title="obj&#45;store.h" alt="" coords="241,237,324,267"/></map>
</div>
</div><div class="textblock"><div class="dynheader">
This graph shows which files directly or indirectly include this file:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h__dep__incl.png" border="0" usemap="#seafile-4_81_82_2server_2repo-mgr_8hdep" alt=""/></div>
<map name="seafile-4_81_82_2server_2repo-mgr_8hdep" id="seafile-4_81_82_2server_2repo-mgr_8hdep">
<area shape="rect" id="node3" href="seafile-4_81_82_2common_2rpc-service_8c.html" title="seafile&#45;4.1.2/common/rpc&#45;service.c" alt="" coords="35,160,262,189"/><area shape="rect" id="node5" href="daemon_2Backups_2repo-mgr_8c.html" title="seafile&#45;4.1.2/daemon/Backups/repo&#45;mgr.c" alt="" coords="1108,237,1372,267"/><area shape="rect" id="node7" href="getcommit-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/getcommit&#45;proc.c" alt="" coords="286,160,600,189"/><area shape="rect" id="node9" href="sync-repo-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/sync&#45;repo&#45;proc.c" alt="" coords="624,160,936,189"/><area shape="rect" id="node11" href="fuse_2Backups_2repo-mgr_8c.html" title="seafile&#45;4.1.2/fuse/Backups/repo&#45;mgr.c" alt="" coords="960,160,1203,189"/><area shape="rect" id="node13" href="server_2seafile-session_8h.html" title="seafile&#45;4.1.2/server/seafile&#45;session.h" alt="" coords="6532,83,6767,112"/><area shape="rect" id="node24" href="Backups_2repo-op_8c.html" title="seafile&#45;4.1.2/server/Backups/repo&#45;op.c" alt="" coords="3531,237,3776,267"/><area shape="rect" id="node26" href="repo-op_8c.html" title="seafile&#45;4.1.2/server/repo&#45;op.c" alt="" coords="11696,237,11886,267"/><area shape="rect" id="node28" href="virtual-repo_8c.html" title="seafile&#45;4.1.2/server/virtual&#45;repo.c" alt="" coords="11910,237,12120,267"/><area shape="rect" id="node95" href="server_2Backups_2repo-mgr_8c.html" title="seafile&#45;4.1.2/server/Backups/repo&#45;mgr.c" alt="" coords="11966,160,12219,189"/><area shape="rect" id="node98" href="server_2gc_2Backups_2repo-mgr_8c.html" title="seafile&#45;4.1.2/server/gc/Backups/repo&#45;mgr.c" alt="" coords="12243,160,12515,189"/><area shape="rect" id="node100" href="putrepoemailtoken-proc_8c.html" title="seafile&#45;4.1.2/server/processors/putrepoemailtoken&#45;proc.c" alt="" coords="12539,160,12888,189"/><area shape="rect" id="node102" href="sync-repo-slave-proc_8c.html" title="seafile&#45;4.1.2/server/processors/sync&#45;repo&#45;slave&#45;proc.c" alt="" coords="12912,160,13248,189"/><area shape="rect" id="node104" href="server_2repo-mgr_8c.html" title="seafile&#45;4.1.2/server/repo&#45;mgr.c" alt="" coords="13272,160,13470,189"/><area shape="rect" id="node107" href="repo-perm_8c.html" title="seafile&#45;4.1.2/server/repo&#45;perm.c" alt="" coords="13494,160,13699,189"/><area shape="rect" id="node15" href="block-mgr_8c.html" title="seafile&#45;4.1.2/common/block&#45;mgr.c" alt="" coords="1278,160,1496,189"/><area shape="rect" id="node17" href="branch-mgr_8c.html" title="seafile&#45;4.1.2/common/branch&#45;mgr.c" alt="" coords="1520,160,1747,189"/><area shape="rect" id="node19" href="commit-mgr_8c.html" title="seafile&#45;4.1.2/common/commit&#45;mgr.c" alt="" coords="1771,160,2000,189"/><area shape="rect" id="node21" href="diff-simple_8h.html" title="seafile&#45;4.1.2/common/diff&#45;simple.h" alt="" coords="7531,160,7752,189"/><area shape="rect" id="node30" href="fs-mgr_8c.html" title="seafile&#45;4.1.2/common/fs&#45;mgr.c" alt="" coords="2024,160,2222,189"/><area shape="rect" id="node32" href="merge-new_8c.html" title="seafile&#45;4.1.2/common/merge&#45;new.c" alt="" coords="2246,160,2472,189"/><area shape="rect" id="node34" href="mq-mgr_8c.html" title="seafile&#45;4.1.2/common/mq&#45;mgr.c" alt="" coords="2496,160,2702,189"/><area shape="rect" id="node36" href="obj-store_8c.html" title="seafile&#45;4.1.2/common/obj&#45;store.c" alt="" coords="2726,160,2936,189"/><area shape="rect" id="node38" href="putblock-proc_8c.html" title="seafile&#45;4.1.2/common/processors/putblock&#45;proc.c" alt="" coords="2960,160,3267,189"/><area shape="rect" id="node40" href="putblock-v2-proc_8c.html" title="seafile&#45;4.1.2/common/processors/putblock&#45;v2&#45;proc.c" alt="" coords="3291,160,3616,189"/><area shape="rect" id="node43" href="seaf-tree-walk_8c.html" title="seafile&#45;4.1.2/common/seaf&#45;tree&#45;walk.c" alt="" coords="3691,160,3934,189"/><area shape="rect" id="node45" href="seaf-utils_8c.html" title="seafile&#45;4.1.2/common/seaf&#45;utils.c" alt="" coords="3958,160,4171,189"/><area shape="rect" id="node47" href="vc-common_8c.html" title="seafile&#45;4.1.2/common/vc&#45;common.c" alt="" coords="4195,160,4424,189"/><area shape="rect" id="node50" href="check-tx-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/check&#45;tx&#45;proc.c" alt="" coords="4448,160,4752,189"/><area shape="rect" id="node52" href="daemon_2processors_2check-tx-slave-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/check&#45;tx&#45;slave&#45;proc.c" alt="" coords="4776,160,5115,189"/><area shape="rect" id="node54" href="check-tx-v2-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/check&#45;tx&#45;v2&#45;proc.c" alt="" coords="5139,160,5462,189"/><area shape="rect" id="node56" href="check-tx-v3-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/check&#45;tx&#45;v3&#45;proc.c" alt="" coords="5486,160,5808,189"/><area shape="rect" id="node58" href="getblock-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/getblock&#45;proc.c" alt="" coords="5832,160,6136,189"/><area shape="rect" id="node60" href="getblock-v2-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/getblock&#45;v2&#45;proc.c" alt="" coords="6160,160,6483,189"/><area shape="rect" id="node62" href="getca-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/getca&#45;proc.c" alt="" coords="6507,160,6792,189"/><area shape="rect" id="node65" href="getcommit-v2-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/getcommit&#45;v2&#45;proc.c" alt="" coords="6816,160,7150,189"/><area shape="rect" id="node67" href="getcommit-v3-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/getcommit&#45;v3&#45;proc.c" alt="" coords="7174,160,7507,189"/><area shape="rect" id="node69" href="getcs-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/getcs&#45;proc.c" alt="" coords="7776,160,8062,189"/><area shape="rect" id="node71" href="getcs-v2-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/getcs&#45;v2&#45;proc.c" alt="" coords="8086,160,8390,189"/><area shape="rect" id="node73" href="getfs-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/getfs&#45;proc.c" alt="" coords="8414,160,8696,189"/><area shape="rect" id="node75" href="getfs-v2-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/getfs&#45;v2&#45;proc.c" alt="" coords="8720,160,9022,189"/><area shape="rect" id="node77" href="daemon_2processors_2putcommit-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/putcommit&#45;proc.c" alt="" coords="9046,160,9360,189"/><area shape="rect" id="node79" href="daemon_2processors_2putfs-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/putfs&#45;proc.c" alt="" coords="9384,160,9667,189"/><area shape="rect" id="node81" href="sendblock-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/sendblock&#45;proc.c" alt="" coords="9691,160,10006,189"/><area shape="rect" id="node83" href="sendblock-v2-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/sendblock&#45;v2&#45;proc.c" alt="" coords="10030,160,10360,189"/><area shape="rect" id="node85" href="sendcommit-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/sendcommit&#45;proc.c" alt="" coords="10384,160,10710,189"/><area shape="rect" id="node87" href="sendcommit-v2-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/sendcommit&#45;v2&#45;proc.c" alt="" coords="10734,160,11078,189"/><area shape="rect" id="node89" href="sendcommit-v3-new-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/sendcommit&#45;v3&#45;new&#45;proc.c" alt="" coords="11102,160,11472,189"/><area shape="rect" id="node91" href="sendcommit-v3-proc_8c.html" title="seafile&#45;4.1.2/daemon/processors/sendcommit&#45;v3&#45;proc.c" alt="" coords="11496,160,11840,189"/></map>
</div>
</div>
<p><a href="server_2repo-mgr_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structSeafVirtRepo.html">SeafVirtRepo</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct__SeafRepo.html">_SeafRepo</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct__SeafRepoManager.html">_SeafRepoManager</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structGroupPerm.html">GroupPerm</a></td></tr>
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a2d6340e4ada61e93d58c0411fa6fcfe5">REPO_AUTO_SYNC</a>&#160;&#160;&#160;&quot;auto-sync&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a502b8f6b8ad6882683294f590b302cc0">REPO_AUTO_FETCH</a>&#160;&#160;&#160;&quot;auto-fetch&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ade9494be6db68ada29c0b9812da1f762">REPO_AUTO_UPLOAD</a>&#160;&#160;&#160;&quot;auto-upload&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ae570b1e2acc8cfd7c3433f974674cfa9">REPO_AUTO_MERGE</a>&#160;&#160;&#160;&quot;auto-merge&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ac5d086060283109eedf8bb27d3e7965c">REPO_AUTO_COMMIT</a>&#160;&#160;&#160;&quot;auto-commit&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a88e179c17ec642b434e82bb40403a6ba">REPO_RELAY_ID</a>&#160;&#160;&#160;&quot;relay-id&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a4dc57106ac24f4cf008c10b85ae1e384">REPO_NET_BROWSABLE</a>&#160;&#160;&#160;&quot;net-browsable&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ae717be3f43ee1abacd91e3703906d518">REPO_DOUBLE_SYNC</a>&#160;&#160;&#160;&quot;double-sync&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#af63040384723b88eb87e261c8ebb298b">REPO_REMOTE_HEAD</a>&#160;&#160;&#160;&quot;remote-head&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a913fa2a61a58336164c1d2538e12f60e">REPO_ENCRYPTED</a>&#160;&#160;&#160;0x1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a1d3305b8bae92ef04cfac74707b663d7">MAX_REPO_TOKEN</a>&#160;&#160;&#160;64</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#afa2f07ad83586c04020cc7fa2760ff1a">DEFAULT_REPO_TOKEN</a>&#160;&#160;&#160;&quot;default&quot;</td></tr>
<tr><td colspan="2"><h2><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct__SeafRepo.html">_SeafRepo</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structSeafVirtRepo.html">SeafVirtRepo</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a40426440d590ec0161993d5850b3ec47">SeafVirtRepo</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct__SeafRepoManager.html">_SeafRepoManager</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct__SeafRepoManagerPriv.html">_SeafRepoManagerPriv</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a4c34a185eca37d07c53358b27bd439f2">SeafRepoManagerPriv</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structGroupPerm.html">GroupPerm</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ae1cbacc908575b028ec23e07d1c5df94">GroupPerm</a></td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gboolean&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a35ce9f51287bbd5f961c261516c1c5f0">is_repo_id_valid</a> (const char *id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a63ab9fe4694e3d967376c911cbe2c655">seaf_repo_new</a> (const char *id, const char *<a class="el" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>, const char *desc)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ad0a65514ad80789ff244b20c66460b96">seaf_repo_free</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ab8f60cbbd6c35ee55ea72acbbd3a1608">seaf_repo_ref</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a6c47d6277897f6afbe866f2755f9762d">seaf_repo_set_head</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, <a class="el" href="branch-mgr_8h.html#a43063fab0cfaf940abc07b1cd941fb85">SeafBranch</a> *branch)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a9c8ead9892374c87ece888d76e810197">seaf_repo_from_commit</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, <a class="el" href="commit-mgr_8h.html#ab20cfcee12e164d94824e8be23c2c8ea">SeafCommit</a> *commit)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a39a9a41ffdfc324f3c935251d9e14d51">seaf_repo_to_commit</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, <a class="el" href="commit-mgr_8h.html#ab20cfcee12e164d94824e8be23c2c8ea">SeafCommit</a> *commit)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#adc55911231fbdbb9d54f39d7f0e60dca">seaf_repo_get_commits</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a168ba33665e04b18089dd5a5d2a18fe3">seaf_repo_diff</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, const char *arg1, const char *arg2, int fold_dir_diff, char **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a640edf431de146c19d5ac2cff6321397">seaf_repo_manager_new</a> (struct <a class="el" href="struct__SeafileSession.html">_SeafileSession</a> *<a class="el" href="server_2seafile-session_8h.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a8dab773e289d1148e7afec7c8614278a">seaf_repo_manager_init</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a2e049cfa3d0546aaf51e7f6792e1467d">seaf_repo_manager_start</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a2c0a60c4eefbb0b4bc68bf871856f32d">seaf_repo_manager_add_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, <a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a512a79980f7d3698e591cf87aeccd314">seaf_repo_manager_del_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a69efc9d099ac370fff9fe9e4caea05ea">seaf_repo_manager_del_virtual_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const gchar *id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a11cc1a4ecd45778ea5a10af0cb72b347">seaf_repo_manager_get_repo_ex</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const gchar *id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gboolean&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a4b2497e6cdde50c4ce3cb642370e06eb">seaf_repo_manager_repo_exists</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const gchar *id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#aa692b1e331cad063425d676afe1ae121">seaf_repo_manager_get_repo_list</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, int start, int limit)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a8fec30cb36491cb94d968df3ce06d5d7">seaf_repo_manager_get_trash_repo_list</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, int start, int limit, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a507c39fec59f1a4672a0cdd5493c6887">seaf_repo_manager_get_trash_repos_by_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *owner, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a94469a7522aa5a67fbc58440544e299a">seaf_repo_manager_del_repo_from_trash</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a47fd08ad688d035ae95e11545bb0a68b">seaf_repo_manager_empty_repo_trash</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a99f0a8fafd75a617d03ea745d36df9be">seaf_repo_manager_empty_repo_trash_by_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *owner, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a4db874916fe89f6b839e389d74034288">seaf_repo_manager_restore_repo_from_trash</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a928ca86df93e60744ca6edacb33a386f">seaf_repo_manager_get_repo_id_list</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ae586fb5fbd61d6b44be3e47e7b6c86da">seaf_repo_manager_branch_repo_unmap</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, <a class="el" href="branch-mgr_8h.html#a43063fab0cfaf940abc07b1cd941fb85">SeafBranch</a> *branch)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a2413f0a10a33c5de4d82193c9c8b7f08">seaf_repo_manager_get_email_by_token</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const char *repo_id, const char *token)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a7899787e6f32bc1f2c578c740b2d716e">seaf_repo_manager_generate_repo_token</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *email, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a673a63eb50ecebd6c689aaadaea5c5e5">seaf_repo_manager_add_token_peer_info</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *token, const char *peer_id, const char *peer_ip, const char *peer_name, gint64 sync_time)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a33b75eede501da0a4c6100b30b9facf0">seaf_repo_manager_update_token_peer_info</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *token, const char *peer_ip, gint64 sync_time)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gboolean&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#aa40635ee3473d593c5edc1a9e9976cd7">seaf_repo_manager_token_peer_info_exists</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *token)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#aab7412302b0f206f7717a29d86d80e0f">seaf_repo_manager_delete_token</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *token, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#afab1803ccaa8885ec65db8075e87a40a">seaf_repo_manager_list_repo_tokens</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a754dc377da1101690257dd8be7fbe78f">seaf_repo_manager_list_repo_tokens_by_email</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *email, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ab1d760446ae882d377b26dcd36eac582">seaf_repo_manager_delete_repo_tokens_by_peer_id</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *email, const char *peer_id, GList **tokens, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#abd2450d97efc42795b87ad7b4624ae63">seaf_repo_manager_delete_repo_tokens_by_email</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *email, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gint64&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ae37e80051d587e921a003fc06c21d540">seaf_repo_manager_get_repo_size</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ac78c13c68a1a9d1d025e45f4e51193ac">seaf_repo_manager_set_repo_history_limit</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, int days)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a0f63ca499435a0d01f03c8c3a2d86c44">seaf_repo_manager_get_repo_history_limit</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#aeeda6cf1cb41515388afd8a10c6297e1">seaf_repo_manager_set_repo_valid_since</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, gint64 timestamp)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gint64&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#aa8aafa2da81a00419443a068fe98958b">seaf_repo_manager_get_repo_valid_since</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gint64&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a774e0a8ea59c07c94dc8014612b3f948">seaf_repo_manager_get_repo_truncate_time</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a75071fddf41a1371d4f89be8d2b59b88">seaf_repo_manager_revert_on_server</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *commit_id, const char *user_name, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a3128bd2930667427a22976b6a2b85743">seaf_repo_manager_post_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *temp_file_path, const char *parent_dir, const char *file_name, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a248a05b4a54ff2d9302d0779cbcc3542">seaf_repo_manager_post_multi_files</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *filenames_json, const char *paths_json, const char *user, int replace_existed, char **new_ids, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a0d6750947e09a7c4f4eb2146147e9db1">seaf_repo_manager_post_file_blocks</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *file_name, const char *blockids_json, const char *paths_json, const char *user, gint64 <a class="el" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>, int replace_existed, char **new_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a2e0e32263ad7bbeaa4ab13a62135c46a">seaf_repo_manager_post_empty_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *new_file_name, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#aa870306d94f3e7b16e66229040590138">seaf_repo_manager_post_dir</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *new_dir_name, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a46c094895964e060809372262c9b9923">seaf_repo_manager_put_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *temp_file_path, const char *parent_dir, const char *file_name, const char *user, const char *head_id, char **new_file_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#aad15cfaf3210b47e9f59a481073aafbc">seaf_repo_manager_put_file_blocks</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *file_name, const char *blockids_json, const char *paths_json, const char *user, const char *head_id, gint64 <a class="el" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>, char **new_file_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ad6564c23b0e50d8a34dd425432b80db4">seaf_repo_manager_del_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *file_name, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">SeafileCopyResult *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ab7eae6af688907f68212dca114549c4b">seaf_repo_manager_copy_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *src_repo_id, const char *src_dir, const char *src_filename, const char *dst_repo_id, const char *dst_dir, const char *dst_filename, const char *user, int need_progress, int synchronous, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">SeafileCopyResult *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a056b45d63edfafbc5287012a2a1062ec">seaf_repo_manager_move_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *src_repo_id, const char *src_dir, const char *src_filename, const char *dst_repo_id, const char *dst_dir, const char *dst_filename, const char *user, int need_progress, int synchronous, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ae68e4b6427bb239b697e515c8617cbfb">seaf_repo_manager_rename_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *oldname, const char *newname, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a7e2d25a533ae3eeced99134a7ffb5dbe">seaf_repo_manager_is_valid_filename</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *filename, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a3706de93ba77e5068dba6a1dd073a0fd">seaf_repo_manager_create_new_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_name, const char *repo_desc, const char *owner_email, const char *passwd, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ad9feaba8f2f873b6685560fd86f4c40d">seaf_repo_manager_create_enc_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *repo_name, const char *repo_desc, const char *owner_email, const char *magic, const char *random_key, int enc_version, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ab10ffbf8777e16cc18e78a263d7fbb1c">seaf_repo_manager_list_file_revisions</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *start_commit_id, const char *path, int max_revision, int limit, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ad00a42c20e1baadf267215e7e683f9e4">seaf_repo_manager_calc_files_last_modified</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, int limit, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a246dc6695f1ee0c1806de54109848096">seaf_repo_manager_revert_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *commit_id, const char *path, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#abf48f3efee4705f32fa8f3a95098921e">seaf_repo_manager_revert_dir</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *old_commit_id, const char *dir_path, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a3bd2aea3b14fe8a45243d175ef86bb61">seaf_repo_manager_get_deleted_entries</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, int show_days, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a3702d0c75995d0221e33b9ba673b99fd">seaf_repo_manager_update_dir</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *dir_path, const char *new_dir_id, const char *user, const char *head_id, char *new_commit_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a5f096821f41a339e41e9341fc0c4010d">seaf_repo_manager_set_repo_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *email)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#af227a31082c71908bf0a0ac35cfeb294">seaf_repo_manager_get_repo_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#aa30a874076b81b802de8763e30433c97">seaf_repo_manager_get_orphan_repo_list</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a7cf33a85dd9c77b44a83d6c8ed300948">seaf_repo_manager_get_repos_by_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *email)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a6a2b07102342d3acc5722e059635aacb">seaf_repo_manager_get_repo_ids_by_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *email)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ae90467b188b67b2c7dd720a159cbbbaa">seaf_repo_manager_add_group_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, int group_id, const char *owner, const char *permission, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a1085e1b2d057850d0a87132107a0e741">seaf_repo_manager_del_group_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, int group_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a404f7522a538d92d2ac68e49956a5a9b">seaf_repo_manager_get_groups_by_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a82d76d79aed153b9165b48e12dc2f2d0">seaf_repo_manager_get_group_perm_by_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a6c5f4f43e7e198238b3b24dff3e9c389">seaf_repo_manager_set_group_repo_perm</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, int group_id, const char *permission, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a9ef2e3d497a572ee1642e6e6dc0c2977">seaf_repo_manager_get_group_repo_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a8e5e47e57afc5432400aeac4e42494b3">seaf_repo_manager_get_group_repoids</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, int group_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a9b3550e6d994e1ab95cbd65e454b8614">seaf_repo_manager_get_group_repos_by_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *owner, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a921cbac599e1c80869659e545d99b62f">seaf_repo_manager_remove_group_repos</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, int group_id, const char *owner, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ab4740f8bce8f9f3571adf0adfb63590b">seaf_repo_manager_set_inner_pub_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *permission)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a4a3708ac06f2c015cc665f5ba61ee36a">seaf_repo_manager_unset_inner_pub_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gboolean&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a4f04f29fd9180ef2982cc0d7bfeee5e4">seaf_repo_manager_is_inner_pub_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a715b426c9fadfc393ece3afdec8587f7">seaf_repo_manager_list_inner_pub_repos</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gint64&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a2365b6daa6aef0d8476fa90f2aeca051">seaf_repo_manager_count_inner_pub_repos</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a8be31ce1507a9a9fb63e15123961acdb">seaf_repo_manager_list_inner_pub_repos_by_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *user)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a24cf3ec157b1edc047b115b28ee8bd0c">seaf_repo_manager_get_inner_pub_repo_perm</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a6a318e5a5bcb0d46286030040ab6e23b">seaf_repo_manager_check_permission</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#aaabba29e879e5e4e53ff753e86b5427b">seaf_repo_manager_set_access_property</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *ap)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a3f3921eba68da813d0d1a583c8923396">seaf_repo_manager_query_access_property</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a26b82474124b9be618ec1564097e5e95">seaf_repo_manager_add_decrypted_token</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *encrypted_token, const char *session_key, const char *decrypted_token)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#af52386548dacb8d7b466e1c75c79a208">seaf_repo_manager_get_decrypted_token</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *encrypted_token, const char *session_key)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a9a8dcda29ee6cd28d92c1897ad12f268">seaf_repo_manager_create_virtual_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *origin_repo_id, const char *path, const char *repo_name, const char *repo_desc, const char *owner, const char *passwd, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structSeafVirtRepo.html">SeafVirtRepo</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a316db228b35dde3dc88ae9dab9ec9c22">seaf_repo_manager_get_virtual_repo_info</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a5e7e933b737fca2ccdb657124812fc90">seaf_repo_manager_get_virtual_info_by_origin</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *origin_repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a66a6ccfc59462f4c59fd322c693c3d5a">seaf_virtual_repo_info_free</a> (<a class="el" href="structSeafVirtRepo.html">SeafVirtRepo</a> *vinfo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gboolean&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a0b9efffb3301d72133b4a3fdd28fc69c">seaf_repo_manager_is_virtual_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ab6ef9796edaf6e7e5b53f3633dc88fa8">seaf_repo_manager_get_virtual_repo_id</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *origin_repo, const char *path, const char *owner)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a89c9b19ae91ea15fe9aa684c5509d4ec">seaf_repo_manager_get_virtual_repos_by_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *owner, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a0e2fecd8fae5355455342e43f6588967">seaf_repo_manager_get_virtual_repo_ids_by_origin</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *origin_repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *exclude_repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a1cd4a8c70076d40d2a778dda774a2263">seaf_repo_manager_cleanup_virtual_repos</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *origin_repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a9545839eb2c54af7e7e2e3948647f47c">seaf_repo_manager_init_merge_scheduler</a> ()</td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="afa2f07ad83586c04020cc7fa2760ff1a"></a><!-- doxytag: member="repo&#45;mgr.h::DEFAULT_REPO_TOKEN" ref="afa2f07ad83586c04020cc7fa2760ff1a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#afa2f07ad83586c04020cc7fa2760ff1a">DEFAULT_REPO_TOKEN</a>&#160;&#160;&#160;&quot;default&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00185">185</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="a1d3305b8bae92ef04cfac74707b663d7"></a><!-- doxytag: member="repo&#45;mgr.h::MAX_REPO_TOKEN" ref="a1d3305b8bae92ef04cfac74707b663d7" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#a1d3305b8bae92ef04cfac74707b663d7">MAX_REPO_TOKEN</a>&#160;&#160;&#160;64</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00184">184</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="ac5d086060283109eedf8bb27d3e7965c"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_AUTO_COMMIT" ref="ac5d086060283109eedf8bb27d3e7965c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#ac5d086060283109eedf8bb27d3e7965c">REPO_AUTO_COMMIT</a>&#160;&#160;&#160;&quot;auto-commit&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00014">14</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="a502b8f6b8ad6882683294f590b302cc0"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_AUTO_FETCH" ref="a502b8f6b8ad6882683294f590b302cc0" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#a502b8f6b8ad6882683294f590b302cc0">REPO_AUTO_FETCH</a>&#160;&#160;&#160;&quot;auto-fetch&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00011">11</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="ae570b1e2acc8cfd7c3433f974674cfa9"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_AUTO_MERGE" ref="ae570b1e2acc8cfd7c3433f974674cfa9" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#ae570b1e2acc8cfd7c3433f974674cfa9">REPO_AUTO_MERGE</a>&#160;&#160;&#160;&quot;auto-merge&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00013">13</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="a2d6340e4ada61e93d58c0411fa6fcfe5"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_AUTO_SYNC" ref="a2d6340e4ada61e93d58c0411fa6fcfe5" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#a2d6340e4ada61e93d58c0411fa6fcfe5">REPO_AUTO_SYNC</a>&#160;&#160;&#160;&quot;auto-sync&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00010">10</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="ade9494be6db68ada29c0b9812da1f762"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_AUTO_UPLOAD" ref="ade9494be6db68ada29c0b9812da1f762" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#ade9494be6db68ada29c0b9812da1f762">REPO_AUTO_UPLOAD</a>&#160;&#160;&#160;&quot;auto-upload&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00012">12</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="ae717be3f43ee1abacd91e3703906d518"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_DOUBLE_SYNC" ref="ae717be3f43ee1abacd91e3703906d518" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#ae717be3f43ee1abacd91e3703906d518">REPO_DOUBLE_SYNC</a>&#160;&#160;&#160;&quot;double-sync&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00017">17</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="a913fa2a61a58336164c1d2538e12f60e"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_ENCRYPTED" ref="a913fa2a61a58336164c1d2538e12f60e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#a913fa2a61a58336164c1d2538e12f60e">REPO_ENCRYPTED</a>&#160;&#160;&#160;0x1</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00019">19</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="a4dc57106ac24f4cf008c10b85ae1e384"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_NET_BROWSABLE" ref="a4dc57106ac24f4cf008c10b85ae1e384" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#a4dc57106ac24f4cf008c10b85ae1e384">REPO_NET_BROWSABLE</a>&#160;&#160;&#160;&quot;net-browsable&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00016">16</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="a88e179c17ec642b434e82bb40403a6ba"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_RELAY_ID" ref="a88e179c17ec642b434e82bb40403a6ba" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#a88e179c17ec642b434e82bb40403a6ba">REPO_RELAY_ID</a>&#160;&#160;&#160;&quot;relay-id&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00015">15</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="af63040384723b88eb87e261c8ebb298b"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_REMOTE_HEAD" ref="af63040384723b88eb87e261c8ebb298b" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#af63040384723b88eb87e261c8ebb298b">REPO_REMOTE_HEAD</a>&#160;&#160;&#160;&quot;remote-head&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00018">18</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<hr/><h2>Typedef Documentation</h2>
<a class="anchor" id="ae1cbacc908575b028ec23e07d1c5df94"></a><!-- doxytag: member="repo&#45;mgr.h::GroupPerm" ref="ae1cbacc908575b028ec23e07d1c5df94" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structGroupPerm.html">GroupPerm</a>  <a class="el" href="structGroupPerm.html">GroupPerm</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a3e8b6c8c2a077518a17c75c6ace3ae1c"></a><!-- doxytag: member="repo&#45;mgr.h::SeafRepo" ref="a3e8b6c8c2a077518a17c75c6ace3ae1c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct__SeafRepo.html">_SeafRepo</a> <a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00022">22</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="af5833aac28a20ee1e1217fc33b9c3a54"></a><!-- doxytag: member="repo&#45;mgr.h::SeafRepoManager" ref="af5833aac28a20ee1e1217fc33b9c3a54" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct__SeafRepoManager.html">_SeafRepoManager</a> <a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00098">98</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="a4c34a185eca37d07c53358b27bd439f2"></a><!-- doxytag: member="repo&#45;mgr.h::SeafRepoManagerPriv" ref="a4c34a185eca37d07c53358b27bd439f2" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct__SeafRepoManagerPriv.html">_SeafRepoManagerPriv</a> <a class="el" href="daemon_2repo-mgr_8h.html#a4c34a185eca37d07c53358b27bd439f2">SeafRepoManagerPriv</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00099">99</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="a40426440d590ec0161993d5850b3ec47"></a><!-- doxytag: member="repo&#45;mgr.h::SeafVirtRepo" ref="a40426440d590ec0161993d5850b3ec47" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structSeafVirtRepo.html">SeafVirtRepo</a>  <a class="el" href="structSeafVirtRepo.html">SeafVirtRepo</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a35ce9f51287bbd5f961c261516c1c5f0"></a><!-- doxytag: member="repo&#45;mgr.h::is_repo_id_valid" ref="a35ce9f51287bbd5f961c261516c1c5f0" args="(const char *id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gboolean <a class="el" href="server_2repo-mgr_8h.html#a35ce9f51287bbd5f961c261516c1c5f0">is_repo_id_valid</a> </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00527">527</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (!<span class="keywordtype">id</span>)
        <span class="keywordflow">return</span> FALSE;

    <span class="keywordflow">return</span> <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a48ecdc72b727191abafbbf2ec1f70ace">is_uuid_valid</a> (<span class="keywordtype">id</span>);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a35ce9f51287bbd5f961c261516c1c5f0_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a35ce9f51287bbd5f961c261516c1c5f0_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a35ce9f51287bbd5f961c261516c1c5f0_cgraph" id="server_2repo-mgr_8h_a35ce9f51287bbd5f961c261516c1c5f0_cgraph">
<area shape="rect" id="node3" href="seafile-4_81_82_2lib_2utils_8c.html#a48ecdc72b727191abafbbf2ec1f70ace" title="is_uuid_valid" alt="" coords="169,5,265,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a168ba33665e04b18089dd5a5d2a18fe3"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_diff" ref="a168ba33665e04b18089dd5a5d2a18fe3" args="(SeafRepo *repo, const char *arg1, const char *arg2, int fold_dir_diff, char **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="repo-op_8c.html#ab69fe2104c734bb5d32b025e3f444736">seaf_repo_diff</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>arg1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>arg2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>fold_dir_diff</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l04766">4766</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *c1 = NULL, *c2 = NULL;
    <span class="keywordtype">int</span> ret = 0;
    GList *diff_entries = NULL;

    g_return_val_if_fail (*error == NULL, NULL);

    c2 = get_commit (repo, <span class="keyword">new</span>);
    <span class="keywordflow">if</span> (!c2) {
        *error = g_strdup(<span class="stringliteral">&quot;Can&#39;t find new commit&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }
    
    <span class="keywordflow">if</span> (old == NULL || old[0] == <span class="charliteral">&#39;\0&#39;</span>) {
        <span class="keywordflow">if</span> (c2-&gt;parent_id &amp;&amp; c2-&gt;second_parent_id) {
            ret = <a class="code" href="diff-simple_8c.html#a8c800ee63c23c5ff78d838974f678e47">diff_merge</a> (c2, &amp;diff_entries, fold_dir_diff);
            <span class="keywordflow">if</span> (ret &lt; 0) {
                *error = g_strdup(<span class="stringliteral">&quot;Failed to do diff&quot;</span>);
                <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (c2);
                <span class="keywordflow">return</span> NULL;
            }
            <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (c2);
            <span class="keywordflow">return</span> diff_entries;
        }

        <span class="keywordflow">if</span> (!c2-&gt;parent_id) {
            <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (c2);
            <span class="keywordflow">return</span> NULL;
        }
        c1 = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                             repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, 
                                             c2-&gt;parent_id);
    } <span class="keywordflow">else</span> {
        c1 = get_commit (repo, old);
    }

    <span class="keywordflow">if</span> (!c1) {
        *error = g_strdup(<span class="stringliteral">&quot;Can&#39;t find old commit&quot;</span>);
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (c2);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="comment">/* do diff */</span>
    ret = <a class="code" href="diff-simple_8c.html#a9e9cbe6847c88fc7bca7035f45a0a50e">diff_commits</a> (c1, c2, &amp;diff_entries, fold_dir_diff);
    <span class="keywordflow">if</span> (ret &lt; 0)
        *error = g_strdup(<span class="stringliteral">&quot;Failed to do diff&quot;</span>);

    <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (c1);
    <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (c2);

    <span class="keywordflow">return</span> diff_entries;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a168ba33665e04b18089dd5a5d2a18fe3_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a168ba33665e04b18089dd5a5d2a18fe3_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a168ba33665e04b18089dd5a5d2a18fe3_cgraph" id="server_2repo-mgr_8h_a168ba33665e04b18089dd5a5d2a18fe3_cgraph">
<area shape="rect" id="node3" href="diff-simple_8c.html#a8c800ee63c23c5ff78d838974f678e47" title="diff_merge" alt="" coords="165,165,248,195"/><area shape="rect" id="node7" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f" title="seaf_commit_manager_get_commit" alt="" coords="304,219,533,248"/><area shape="rect" id="node11" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="352,272,485,301"/><area shape="rect" id="node39" href="diff-simple_8c.html#a9e9cbe6847c88fc7bca7035f45a0a50e" title="diff_commits" alt="" coords="159,112,255,141"/><area shape="rect" id="node5" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6" title="seaf_repo_manager_get_repo" alt="" coords="323,5,515,35"/><area shape="rect" id="node13" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="361,59,476,88"/><area shape="rect" id="node15" href="diff-simple_8c.html#aad681f9b9d7dbc7586efaa4cd0b254e6" title="diff_trees" alt="" coords="381,112,456,141"/><area shape="rect" id="node27" href="diff-simple_8c.html#a3d936e2ea0a740cbdc9bbab7113b3742" title="diff_resolve_renames" alt="" coords="345,165,492,195"/><area shape="rect" id="node9" href="commit-mgr_8c.html#a2b1cc305cf40cb64c341a0e64d0fe921" title="seaf_commit_ref" alt="" coords="620,325,737,355"/><area shape="rect" id="node17" href="fs-mgr_8c.html#a08103ffc3a5cd19b70167404c39ce3e4" title="seaf_fs_manager_get_seafdir" alt="" coords="583,59,775,88"/><area shape="rect" id="node23" href="fs-mgr_8c.html#ae04d3c4669cd7b0fc691cd2da6dc2de1" title="seaf_dir_free" alt="" coords="631,5,727,35"/><area shape="rect" id="node19" href="obj-store_8c.html#a6e93a0214f9cb8a7fc837a2bc3a3c529" title="seaf_obj_store_read_obj" alt="" coords="824,112,987,141"/><area shape="rect" id="node21" href="fs-mgr_8c.html#a6875a119da427bb1cd9796eee916b703" title="seaf_dir_from_data" alt="" coords="839,59,972,88"/><area shape="rect" id="node25" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a" title="seaf_dirent_free" alt="" coords="848,5,963,35"/><area shape="rect" id="node29" href="seafile-4_81_82_2lib_2utils_8c.html#ac846d436ccbb4031fa7a8d76ceadad07" title="ccnet_sha1_hash" alt="" coords="617,165,740,195"/><area shape="rect" id="node31" href="seafile-4_81_82_2lib_2utils_8c.html#a75a7a2a1400f4cf5f6cd5ea988e705f4" title="ccnet_sha1_equal" alt="" coords="616,219,741,248"/><area shape="rect" id="node33" href="diff-simple_8c.html#a5a9e3f70659801a181ca4ff6004bf021" title="diff_entry_new" alt="" coords="625,272,732,301"/><area shape="rect" id="node35" href="diff-simple_8c.html#abb759117ec4b4aca623768424487f5da" title="diff_entry_free" alt="" coords="627,112,731,141"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ad0a65514ad80789ff244b20c66460b96"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_free" ref="ad0a65514ad80789ff244b20c66460b96" args="(SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="server_2repo-mgr_8h.html#ad0a65514ad80789ff244b20c66460b96">seaf_repo_free</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00607">607</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>) <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>);

    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>);
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a>);
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4d7c42c5644eb9dbfd24bf43adb9316c">category</a>);
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>);
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>);
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a>);
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a0ce3b61cb31e78ffea429615379b3eb4">token</a>);
    g_free (repo);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_ad0a65514ad80789ff244b20c66460b96_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_ad0a65514ad80789ff244b20c66460b96_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_ad0a65514ad80789ff244b20c66460b96_cgraph" id="server_2repo-mgr_8h_ad0a65514ad80789ff244b20c66460b96_cgraph">
<area shape="rect" id="node3" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653" title="seaf_branch_unref" alt="" coords="188,5,316,35"/><area shape="rect" id="node7" href="server_2gc_2Backups_2repo-mgr_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a" title="seaf_virtual_repo_info_free" alt="" coords="163,59,341,88"/><area shape="rect" id="node5" href="branch-mgr_8c.html#a449a49952dc253bd7b16367869d0ebdc" title="seaf_branch_free" alt="" coords="389,5,512,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_ad0a65514ad80789ff244b20c66460b96_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_ad0a65514ad80789ff244b20c66460b96_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_ad0a65514ad80789ff244b20c66460b96_icgraph" id="server_2repo-mgr_8h_ad0a65514ad80789ff244b20c66460b96_icgraph">
<area shape="rect" id="node3" href="server_2gc_2repo-mgr_8h.html#afdce2de6ee36dcf6b6264ac35fb17f7a" title="seaf_repo_manager_del_repo" alt="" coords="163,376,355,405"/><area shape="rect" id="node7" href="server_2repo-mgr_8h.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="201,800,316,829"/><area shape="rect" id="node5" href="seafile-4_81_82_2common_2rpc-service_8c.html#a3743ba1324330f8ef0cb9a5c33a52e92" title="seafile_destroy_repo" alt="" coords="473,5,615,35"/><area shape="rect" id="node9" href="diff-simple_8h.html#a9e9cbe6847c88fc7bca7035f45a0a50e" title="diff_commits" alt="" coords="496,112,592,141"/><area shape="rect" id="node13" href="diff-simple_8h.html#a8c800ee63c23c5ff78d838974f678e47" title="diff_merge" alt="" coords="503,59,585,88"/><area shape="rect" id="node16" href="seafile-rpc_8h.html#aba4837db052d18cd952ad53e10ebd379" title="seafile_get_repo_list" alt="" coords="473,216,615,245"/><area shape="rect" id="node18" href="seafile-4_81_82_2common_2rpc-service_8c.html#a37949d30db3977c8fbb573881173987b" title="seafile_get_repo" alt="" coords="485,269,603,299"/><area shape="rect" id="node20" href="seafile-4_81_82_2common_2rpc-service_8c.html#a5594de7f321b08c515c465bc44e25c60" title="seafile_get_commit_list" alt="" coords="465,323,623,352"/><area shape="rect" id="node24" href="server_2gc_2repo-mgr_8h.html#a2272730e6465361e0e715fa029ace947" title="seaf_repo_manager_get_repo_list" alt="" coords="436,376,652,405"/><area shape="rect" id="node26" href="server_2gc_2gc-core_8h.html#ab1ddc08d785efb15290a677e8e152c18" title="gc_core_run" alt="" coords="497,429,591,459"/><area shape="rect" id="node28" href="server_2repo-mgr_8h.html#a3128bd2930667427a22976b6a2b85743" title="seaf_repo_manager_post_file" alt="" coords="448,483,640,512"/><area shape="rect" id="node30" href="server_2repo-mgr_8h.html#a248a05b4a54ff2d9302d0779cbcc3542" title="seaf_repo_manager_post_multi_files" alt="" coords="427,536,661,565"/><area shape="rect" id="node32" href="server_2repo-mgr_8h.html#a0d6750947e09a7c4f4eb2146147e9db1" title="seaf_repo_manager_post_file_blocks" alt="" coords="425,589,663,619"/><area shape="rect" id="node34" href="server_2repo-mgr_8h.html#ad6564c23b0e50d8a34dd425432b80db4" title="seaf_repo_manager_del_file" alt="" coords="747,745,931,775"/><area shape="rect" id="node36" href="server_2repo-mgr_8h.html#a056b45d63edfafbc5287012a2a1062ec" title="seaf_repo_manager_move_file" alt="" coords="993,693,1191,723"/><area shape="rect" id="node38" href="server_2repo-mgr_8h.html#ab7eae6af688907f68212dca114549c4b" title="seaf_repo_manager_copy_file" alt="" coords="447,747,641,776"/><area shape="rect" id="node41" href="server_2repo-mgr_8h.html#aa870306d94f3e7b16e66229040590138" title="seaf_repo_manager_post_dir" alt="" coords="449,800,639,829"/><area shape="rect" id="node43" href="server_2repo-mgr_8h.html#a2e0e32263ad7bbeaa4ab13a62135c46a" title="seaf_repo_manager_post_empty_file" alt="" coords="427,853,661,883"/><area shape="rect" id="node45" href="server_2repo-mgr_8h.html#ae68e4b6427bb239b697e515c8617cbfb" title="seaf_repo_manager_rename_file" alt="" coords="733,641,944,671"/><area shape="rect" id="node47" href="server_2repo-mgr_8h.html#a46c094895964e060809372262c9b9923" title="seaf_repo_manager_put_file" alt="" coords="452,957,636,987"/><area shape="rect" id="node49" href="server_2repo-mgr_8h.html#a3702d0c75995d0221e33b9ba673b99fd" title="seaf_repo_manager_update_dir" alt="" coords="443,1011,645,1040"/><area shape="rect" id="node51" href="server_2repo-mgr_8h.html#aad15cfaf3210b47e9f59a481073aafbc" title="seaf_repo_manager_put_file_blocks" alt="" coords="429,1064,659,1093"/><area shape="rect" id="node53" href="server_2repo-mgr_8h.html#a246dc6695f1ee0c1806de54109848096" title="seaf_repo_manager_revert_file" alt="" coords="444,1117,644,1147"/><area shape="rect" id="node55" href="server_2repo-mgr_8h.html#abf48f3efee4705f32fa8f3a95098921e" title="seaf_repo_manager_revert_dir" alt="" coords="445,1171,643,1200"/><area shape="rect" id="node57" href="server_2repo-mgr_8h.html#ab10ffbf8777e16cc18e78a263d7fbb1c" title="seaf_repo_manager_list_file_revisions" alt="" coords="423,1248,665,1277"/><area shape="rect" id="node60" href="server_2repo-mgr_8h.html#ad00a42c20e1baadf267215e7e683f9e4" title="seaf_repo_manager_calc_files_last_modified" alt="" coords="403,1301,685,1331"/><area shape="rect" id="node62" href="server_2repo-mgr_8h.html#a75071fddf41a1371d4f89be8d2b59b88" title="seaf_repo_manager_revert_on_server" alt="" coords="424,1355,664,1384"/><area shape="rect" id="node64" href="server_2repo-mgr_8h.html#a3bd2aea3b14fe8a45243d175ef86bb61" title="seaf_repo_manager_get_deleted_entries" alt="" coords="416,1408,672,1437"/><area shape="rect" id="node66" href="verify_8h.html#ac9054d2eed9bb3a221b531f65b5cf0f5" title="verify_repos" alt="" coords="497,1461,591,1491"/><area shape="rect" id="node70" href="passwd-mgr_8h.html#aa869fc42cc145aacb31da546c5b60ddb" title="seaf_passwd_manager_check_passwd" alt="" coords="419,1515,669,1544"/><area shape="rect" id="node72" href="passwd-mgr_8h.html#a423fa6bdd74869a9d46a706ecd7790da" title="seaf_passwd_manager_set_passwd" alt="" coords="428,1568,660,1597"/><area shape="rect" id="node74" href="virtual-repo_8c.html#a9a8dcda29ee6cd28d92c1897ad12f268" title="seaf_repo_manager_create_virtual_repo" alt="" coords="417,1621,671,1651"/><area shape="rect" id="node76" href="virtual-repo_8c.html#a1cd4a8c70076d40d2a778dda774a2263" title="seaf_repo_manager_cleanup_virtual_repos" alt="" coords="409,693,679,723"/><area shape="rect" id="node11" href="server_2repo-mgr_8h.html#a168ba33665e04b18089dd5a5d2a18fe3" title="seaf_repo_diff" alt="" coords="787,85,891,115"/><area shape="rect" id="node22" href="rpc-deprecated_8c.html#a374cf49b787fef8fc91266c87cc15375" title="seafile_get_commit_list_pub" alt="" coords="745,323,932,352"/><area shape="rect" id="node68" href="seafserv-gc_8c.html#a0ddf1224851353fc92bfbff6f499fa97" title="main" alt="" coords="813,1461,864,1491"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a9c8ead9892374c87ece888d76e810197"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_from_commit" ref="a9c8ead9892374c87ece888d76e810197" args="(SeafRepo *repo, SeafCommit *commit)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="server_2repo-mgr_8h.html#a9c8ead9892374c87ece888d76e810197">seaf_repo_from_commit</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="commit-mgr_8h.html#ab20cfcee12e164d94824e8be23c2c8ea">SeafCommit</a> *&#160;</td>
          <td class="paramname"><em>commit</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00663">663</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a> = g_strdup (commit-&gt;<a class="code" href="struct__SeafCommit.html#aacd7b88f8a3e72446cd7352396eaa09e">repo_name</a>);
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a> = g_strdup (commit-&gt;<a class="code" href="struct__SeafCommit.html#aa3d8e868c630cfbecbcb9158c4bbe2e4">repo_desc</a>);
    repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#a906e77d2a658f4337437ff8694a4bfc0">encrypted</a>;
    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
        repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a>;
        <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> == 1)
            memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a>, 32);
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> == 2) {
            memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a>, 64);
            memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#a83e0a2366ba320396f2deb6faa167b84">random_key</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#ab1d44814bc44472105aef8761656e3d7">random_key</a>, 96);
        }
    }
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a4710aaee11c7887df402fffa7ca6c54f">no_local_history</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#a383ea4a4b94417c7d9e9827d60420d64">no_local_history</a>;
    repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#abc83f168ce2b43fa864522bf0ea26d6d">version</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="adc55911231fbdbb9d54f39d7f0e60dca"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_get_commits" ref="adc55911231fbdbb9d54f39d7f0e60dca" args="(SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#adc55911231fbdbb9d54f39d7f0e60dca">seaf_repo_get_commits</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00713">713</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *branches;
    GList *ptr;
    <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch;
    GList *commits = NULL;

    branches = <a class="code" href="branch-mgr_8c.html#ad5bd62cbe17cb8fe91bcd993956a1fbf">seaf_branch_manager_get_branch_list</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
    <span class="keywordflow">if</span> (branches == NULL) {
        g_warning (<span class="stringliteral">&quot;Failed to get branch list of repo %s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">for</span> (ptr = branches; ptr != NULL; ptr = ptr-&gt;next) {
        branch = ptr-&gt;data;
        gboolean res = <a class="code" href="commit-mgr_8c.html#ac6547d5546781608b39446d9a2077fed">seaf_commit_manager_traverse_commit_tree</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                                                 repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
                                                                 repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                                 branch-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>,
                                                                 collect_commit,
                                                                 &amp;commits, FALSE);
        <span class="keywordflow">if</span> (!res) {
            <span class="keywordflow">for</span> (ptr = commits; ptr != NULL; ptr = ptr-&gt;next)
                <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> ((<a class="code" href="struct__SeafCommit.html">SeafCommit</a> *)(ptr-&gt;data));
            g_list_free (commits);
            <span class="keywordflow">goto</span> out;
        }
    }

    commits = g_list_reverse (commits);

out:
    <span class="keywordflow">for</span> (ptr = branches; ptr != NULL; ptr = ptr-&gt;next) {
        <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> ((<a class="code" href="struct__SeafBranch.html">SeafBranch</a> *)ptr-&gt;data);
    }
    <span class="keywordflow">return</span> commits;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_adc55911231fbdbb9d54f39d7f0e60dca_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_adc55911231fbdbb9d54f39d7f0e60dca_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_adc55911231fbdbb9d54f39d7f0e60dca_cgraph" id="server_2repo-mgr_8h_adc55911231fbdbb9d54f39d7f0e60dca_cgraph">
<area shape="rect" id="node3" href="branch-mgr_8c.html#ad5bd62cbe17cb8fe91bcd993956a1fbf" title="seaf_branch_manager_get_branch_list" alt="" coords="237,85,483,115"/><area shape="rect" id="node11" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653" title="seaf_branch_unref" alt="" coords="748,139,876,168"/><area shape="rect" id="node15" href="commit-mgr_8c.html#ac6547d5546781608b39446d9a2077fed" title="seaf_commit_manager_traverse_commit_tree" alt="" coords="217,216,503,245"/><area shape="rect" id="node17" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="293,269,427,299"/><area shape="rect" id="node5" href="seafile-4_81_82_2lib_2db_8c.html#a4d1d0eb407f8f5dd522c3875beb7b9c8" title="sqlite_query_prepare" alt="" coords="555,5,696,35"/><area shape="rect" id="node7" href="branch-mgr_8c.html#a4d213520d8a22d5191051715ccbfd1dd" title="seaf_branch_new" alt="" coords="564,59,687,88"/><area shape="rect" id="node9" href="branch-mgr_8c.html#ac6476414064e0ff0c429629aaab0bfc9" title="seaf_branch_list_free" alt="" coords="552,112,699,141"/><area shape="rect" id="node13" href="branch-mgr_8c.html#a449a49952dc253bd7b16367869d0ebdc" title="seaf_branch_free" alt="" coords="925,139,1048,168"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a26b82474124b9be618ec1564097e5e95"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_add_decrypted_token" ref="a26b82474124b9be618ec1564097e5e95" args="(SeafRepoManager *mgr, const char *encrypted_token, const char *session_key, const char *decrypted_token)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="server_2repo-mgr_8h.html#a26b82474124b9be618ec1564097e5e95">seaf_repo_manager_add_decrypted_token</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>encrypted_token</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>session_key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>decrypted_token</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02859">2859</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> key[256];
    <a class="code" href="structDecryptedToken.html">DecryptedToken</a> *token;

    snprintf (key, <span class="keyword">sizeof</span>(key), <span class="stringliteral">&quot;%s%s&quot;</span>, encrypted_token, session_key);
    key[255] = 0;

    pthread_rwlock_wrlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);

    token = g_new0 (<a class="code" href="structDecryptedToken.html">DecryptedToken</a>, 1);
    token-&gt;<a class="code" href="structDecryptedToken.html#a42141944bd09e6d0a41fca83e8c970aa">token</a> = g_strdup(decrypted_token);
    token-&gt;<a class="code" href="structDecryptedToken.html#ac28926407787ff9b8f9e85f677c02447">reap_time</a> = (gint64)time(NULL) + <a class="code" href="server_2Backups_2repo-mgr_8c.html#a6e0d8a1f0eba39caca9c0b6745241644">DECRYPTED_TOKEN_TTL</a>;

    g_hash_table_insert (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a57897702376986982d366379746bd694">decrypted_tokens</a>,
                         g_strdup(key),
                         token);

    pthread_rwlock_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae90467b188b67b2c7dd720a159cbbbaa"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_add_group_repo" ref="ae90467b188b67b2c7dd720a159cbbbaa" args="(SeafRepoManager *mgr, const char *repo_id, int group_id, const char *owner, const char *permission, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#ae90467b188b67b2c7dd720a159cbbbaa">seaf_repo_manager_add_group_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>group_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>permission</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02208">2208</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                 <span class="stringliteral">&quot;INSERT INTO RepoGroup VALUES (?, ?, ?, ?)&quot;</span>,
                                 4, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;int&quot;</span>, group_id,
                                 <span class="stringliteral">&quot;string&quot;</span>, owner, <span class="stringliteral">&quot;string&quot;</span>, permission) &lt; 0)
        <span class="keywordflow">return</span> -1;

    <span class="keywordflow">return</span> 0;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_ae90467b188b67b2c7dd720a159cbbbaa_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_ae90467b188b67b2c7dd720a159cbbbaa_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_ae90467b188b67b2c7dd720a159cbbbaa_cgraph" id="server_2repo-mgr_8h_ae90467b188b67b2c7dd720a159cbbbaa_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5" title="seaf_db_statement_query" alt="" coords="289,32,460,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="511,5,692,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="520,59,683,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a2c0a60c4eefbb0b4bc68bf871856f32d"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_add_repo" ref="a2c0a60c4eefbb0b4bc68bf871856f32d" args="(SeafRepoManager *mgr, SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a2c0a60c4eefbb0b4bc68bf871856f32d">seaf_repo_manager_add_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04002">4002</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];
    sqlite3 *db = manager-&gt;priv-&gt;db;

    pthread_mutex_lock (&amp;manager-&gt;priv-&gt;db_lock);

    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;REPLACE INTO Repo VALUES (&#39;%s&#39;);&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
    <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);

    pthread_mutex_unlock (&amp;manager-&gt;priv-&gt;db_lock);

    <span class="comment">/* There may be a &quot;deletion record&quot; for this repo when it was deleted</span>
<span class="comment">     * last time.</span>
<span class="comment">     */</span>
    <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a7d2cf85f06fa2e7d459730f7494c1a65">seaf_repo_manager_remove_garbage_repo</a> (manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);

    repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a> = manager;

    <span class="keywordflow">if</span> (pthread_rwlock_wrlock (&amp;manager-&gt;priv-&gt;lock) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;[repo mgr] failed to lock repo cache.\n&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    g_hash_table_insert (manager-&gt;priv-&gt;repo_hash, g_strdup(repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>), repo);

    pthread_rwlock_unlock (&amp;manager-&gt;priv-&gt;lock);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a2c0a60c4eefbb0b4bc68bf871856f32d_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a2c0a60c4eefbb0b4bc68bf871856f32d_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a2c0a60c4eefbb0b4bc68bf871856f32d_cgraph" id="server_2repo-mgr_8h_a2c0a60c4eefbb0b4bc68bf871856f32d_cgraph">
<area shape="rect" id="node3" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9" title="sqlite_query_exec" alt="" coords="324,5,449,35"/><area shape="rect" id="node5" href="daemon_2Backups_2repo-mgr_8c.html#a7d2cf85f06fa2e7d459730f7494c1a65" title="seaf_repo_manager_remove_garbage_repo" alt="" coords="252,59,521,88"/><area shape="rect" id="node7" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5" title="seaf_db_statement_query" alt="" coords="301,112,472,141"/><area shape="rect" id="node9" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="572,85,753,115"/><area shape="rect" id="node11" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="581,139,744,168"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a2c0a60c4eefbb0b4bc68bf871856f32d_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a2c0a60c4eefbb0b4bc68bf871856f32d_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a2c0a60c4eefbb0b4bc68bf871856f32d_icgraph" id="server_2repo-mgr_8h_a2c0a60c4eefbb0b4bc68bf871856f32d_icgraph">
<area shape="rect" id="node3" href="daemon_2repo-mgr_8h.html#ab599ba29e40bdb918ac78060d1165c2d" title="seaf_repo_manager_create_new_repo" alt="" coords="251,5,493,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a673a63eb50ecebd6c689aaadaea5c5e5"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_add_token_peer_info" ref="a673a63eb50ecebd6c689aaadaea5c5e5" args="(SeafRepoManager *mgr, const char *token, const char *peer_id, const char *peer_ip, const char *peer_name, gint64 sync_time)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a673a63eb50ecebd6c689aaadaea5c5e5">seaf_repo_manager_add_token_peer_info</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>token</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>peer_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>peer_ip</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>peer_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gint64&#160;</td>
          <td class="paramname"><em>sync_time</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01099">1099</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> ret = 0;

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                 <span class="stringliteral">&quot;INSERT INTO RepoTokenPeerInfo VALUES (&quot;</span>
                                 <span class="stringliteral">&quot;?, ?, ?, ?, ?)&quot;</span>,
                                 5, <span class="stringliteral">&quot;string&quot;</span>, token,
                                 <span class="stringliteral">&quot;string&quot;</span>, peer_id,
                                 <span class="stringliteral">&quot;string&quot;</span>, peer_ip,
                                 <span class="stringliteral">&quot;string&quot;</span>, peer_name,
                                 <span class="stringliteral">&quot;int64&quot;</span>, sync_time) &lt; 0)
        ret = -1;

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a673a63eb50ecebd6c689aaadaea5c5e5_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a673a63eb50ecebd6c689aaadaea5c5e5_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a673a63eb50ecebd6c689aaadaea5c5e5_cgraph" id="server_2repo-mgr_8h_a673a63eb50ecebd6c689aaadaea5c5e5_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5" title="seaf_db_statement_query" alt="" coords="319,32,489,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="540,5,721,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="549,59,712,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ae586fb5fbd61d6b44be3e47e7b6c86da"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_branch_repo_unmap" ref="ae586fb5fbd61d6b44be3e47e7b6c86da" args="(SeafRepoManager *manager, SeafBranch *branch)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#ae586fb5fbd61d6b44be3e47e7b6c86da">seaf_repo_manager_branch_repo_unmap</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="branch-mgr_8h.html#a43063fab0cfaf940abc07b1cd941fb85">SeafBranch</a> *&#160;</td>
          <td class="paramname"><em>branch</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04397">4397</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    sqlite3 *db = manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>;

    pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    sql = sqlite3_mprintf (<span class="stringliteral">&quot;DELETE FROM RepoBranch WHERE branch_name = %Q&quot;</span>
                           <span class="stringliteral">&quot; AND repo_id = %Q&quot;</span>,
                           branch-&gt;<a class="code" href="struct__SeafBranch.html#ae6af0006b9b80ded4f0525a3be06ccda">name</a>, branch-&gt;<a class="code" href="struct__SeafBranch.html#a88717f46308eb12629b99f9ff91740c2">repo_id</a>);
    <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;Unmap branch repo failed\n&quot;</span>);
        pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
        sqlite3_free (sql);
        <span class="keywordflow">return</span> -1;
    }

    sqlite3_free (sql);
    pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_ae586fb5fbd61d6b44be3e47e7b6c86da_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_ae586fb5fbd61d6b44be3e47e7b6c86da_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_ae586fb5fbd61d6b44be3e47e7b6c86da_cgraph" id="server_2repo-mgr_8h_ae586fb5fbd61d6b44be3e47e7b6c86da_cgraph">
<area shape="rect" id="node3" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9" title="sqlite_query_exec" alt="" coords="339,5,464,35"/><area shape="rect" id="node5" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5" title="seaf_db_statement_query" alt="" coords="316,59,487,88"/><area shape="rect" id="node7" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="537,32,719,61"/><area shape="rect" id="node9" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="547,85,709,115"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_ae586fb5fbd61d6b44be3e47e7b6c86da_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_ae586fb5fbd61d6b44be3e47e7b6c86da_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_ae586fb5fbd61d6b44be3e47e7b6c86da_icgraph" id="server_2repo-mgr_8h_ae586fb5fbd61d6b44be3e47e7b6c86da_icgraph">
<area shape="rect" id="node3" href="rpc-deprecated_8c.html#afb600f07a2183e34f31eb2fa5c783a15" title="seafile_branch_del" alt="" coords="381,32,512,61"/><area shape="rect" id="node5" href="daemon_2repo-mgr_8h.html#a008f145440cf3620f7883d1fe109f69c" title="seaf_repo_manager_remove_repo_ondisk" alt="" coords="316,85,577,115"/><area shape="rect" id="node19" href="server_2repo-mgr_8h.html#a94469a7522aa5a67fbc58440544e299a" title="seaf_repo_manager_del_repo_from_trash" alt="" coords="316,165,577,195"/><area shape="rect" id="node7" href="server_2gc_2repo-mgr_8h.html#afdce2de6ee36dcf6b6264ac35fb17f7a" title="seaf_repo_manager_del_repo" alt="" coords="687,5,879,35"/><area shape="rect" id="node11" href="clone-mgr_8h.html#a6b3ef937f8308db69c87bb650cb42fe9" title="seaf_clone_manager_add_task" alt="" coords="681,59,884,88"/><area shape="rect" id="node15" href="clone-mgr_8h.html#ab6b5a2b4f13b382b9c7034131fa92783" title="seaf_clone_manager_add_download_task" alt="" coords="651,112,915,141"/><area shape="rect" id="node9" href="seafile-4_81_82_2common_2rpc-service_8c.html#a3743ba1324330f8ef0cb9a5c33a52e92" title="seafile_destroy_repo" alt="" coords="988,5,1129,35"/><area shape="rect" id="node13" href="seafile-rpc_8h.html#aca75772f76f8eafb2b08a023cd476f65" title="seafile_clone" alt="" coords="1009,59,1108,88"/><area shape="rect" id="node17" href="seafile-rpc_8h.html#a704ca859f1a1f7044c27b27982658672" title="seafile_download" alt="" coords="997,112,1120,141"/><area shape="rect" id="node21" href="server_2repo-mgr_8h.html#a47fd08ad688d035ae95e11545bb0a68b" title="seaf_repo_manager_empty_repo_trash" alt="" coords="660,165,905,195"/><area shape="rect" id="node23" href="server_2repo-mgr_8h.html#a99f0a8fafd75a617d03ea745d36df9be" title="seaf_repo_manager_empty_repo_trash_by_owner" alt="" coords="628,219,937,248"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ad00a42c20e1baadf267215e7e683f9e4"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_calc_files_last_modified" ref="ad00a42c20e1baadf267215e7e683f9e4" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, int limit, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="repo-op_8c.html#ad00a42c20e1baadf267215e7e683f9e4">seaf_repo_manager_calc_files_last_modified</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>limit</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Give a directory, return the last modification timestamps of all the files under this directory.</p>
<p>First we record the current id of every file, then traverse the commit tree. Give a commit, for each file, if the file id in that commit is different than its current id, then this file is last modified in the commit previous to that commit. </p>

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l04207">4207</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <a class="code" href="struct__SeafDir.html">SeafDir</a> *dir = NULL;
    GList *ptr = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *dent = NULL; 
    <a class="code" href="structCalcFilesLastModifiedParam.html">CalcFilesLastModifiedParam</a> data = {0};
    GList *ret_list = NULL;

    repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (!repo) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;No such repo %s&quot;</span>, repo_id);
        <span class="keywordflow">goto</span> out;
    }

    head_commit = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, 
                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
    <span class="keywordflow">if</span> (!head_commit) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to get commit %s&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
        <span class="keywordflow">goto</span> out;
    }

    dir = <a class="code" href="fs-mgr_8c.html#a033b8831db7345eec0ff09216b63593d">seaf_fs_manager_get_seafdir_by_path</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                               repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                               head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                               parent_dir, error);
    <span class="keywordflow">if</span> (*error || !dir) {
        <span class="keywordflow">goto</span> out;
    }

    data.<a class="code" href="structCalcFilesLastModifiedParam.html#a97697edcf7ab91b67f253899a91703c5">repo</a> = repo;
    
    <span class="comment">/* A hash table of pattern (file_name, current_file_id) */</span>
    data.<a class="code" href="structCalcFilesLastModifiedParam.html#a702738ebda8b8ec9109a48537c8b91ac">current_file_id_hash</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
                                                       g_free, g_free);
    <span class="comment">/* A (file_name, last_modified) hashtable. &lt;last_modified&gt; is a heap</span>
<span class="comment">       allocated gint64</span>
<span class="comment">    */</span>
    data.<a class="code" href="structCalcFilesLastModifiedParam.html#a7e1281cdb47bc1680b9635719d1e417c">last_modified_hash</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
                                                     g_free, g_free);
    <span class="keywordflow">for</span> (ptr = dir-&gt;<a class="code" href="struct__SeafDir.html#ae45d2a99b493e8a080e910d2fd580df4">entries</a>; ptr; ptr = ptr-&gt;next) {
        dent = ptr-&gt;data;
        g_hash_table_insert (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a702738ebda8b8ec9109a48537c8b91ac">current_file_id_hash</a>,
                             g_strdup(dent-&gt;<a class="code" href="struct__SeafDirent.html#a400094123179edfd24b0db4925780624">name</a>),
                             g_strdup(dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>));

        gint64 *<a class="code" href="index_8h.html#a774773e5c25d1b44dac32468246cc980">ctime</a> = g_new (gint64, 1);
        *ctime = head_commit-&gt;<a class="code" href="struct__SeafCommit.html#ae3f1657ab475921889a1e9c74b94e7a2">ctime</a>;
        g_hash_table_insert (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a7e1281cdb47bc1680b9635719d1e417c">last_modified_hash</a>,
                             g_strdup(dent-&gt;<a class="code" href="struct__SeafDirent.html#a400094123179edfd24b0db4925780624">name</a>), 
                             ctime);
    }

    <span class="keywordflow">if</span> (g_hash_table_size (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a702738ebda8b8ec9109a48537c8b91ac">current_file_id_hash</a>) == 0) {
        <span class="comment">/* An empty directory, no need to traverse */</span>
        <span class="keywordflow">goto</span> out;
    }

    data.<a class="code" href="structCalcFilesLastModifiedParam.html#ada88490177184de19fbb57b5c27a1ba8">parent_dir</a> = parent_dir;
    data.<a class="code" href="structCalcFilesLastModifiedParam.html#adde465b06b50b85a61903a27b20be738">error</a> = error;

    <span class="keywordflow">if</span> (!<a class="code" href="commit-mgr_8c.html#a032f260db46d5566e78dfcbbc4b2859a">seaf_commit_manager_traverse_commit_tree_with_limit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, 
                                                        repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>,
                                (<a class="code" href="commit-mgr_8h.html#ace73a042fe8571009de1750edb729c83">CommitTraverseFunc</a>)collect_files_last_modified,
                                                              limit, &amp;data, FALSE)) {
        <span class="keywordflow">if</span> (*error)
            seaf_warning (<span class="stringliteral">&quot;error when traversing commits: %s\n&quot;</span>, (*error)-&gt;message);
        <span class="keywordflow">else</span>
            seaf_warning (<span class="stringliteral">&quot;error when traversing commits.\n&quot;</span>);
        g_clear_error (error);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;failed to traverse commit of repo %s&quot;</span>, repo_id);
        <span class="keywordflow">goto</span> out;
    }

    GHashTableIter iter;
    gpointer key, value;

    g_hash_table_iter_init (&amp;iter, data.<a class="code" href="structCalcFilesLastModifiedParam.html#a7e1281cdb47bc1680b9635719d1e417c">last_modified_hash</a>);
    <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
        SeafileFileLastModifiedInfo *info;
        gint64 last_modified = *(gint64 *)value;
        info = g_object_new (SEAFILE_TYPE_FILE_LAST_MODIFIED_INFO,
                             <span class="stringliteral">&quot;file_name&quot;</span>, key,
                             <span class="stringliteral">&quot;last_modified&quot;</span>, last_modified,
                             NULL);
        ret_list = g_list_prepend (ret_list, info);
    }

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <span class="keywordflow">if</span> (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a7e1281cdb47bc1680b9635719d1e417c">last_modified_hash</a>)
        g_hash_table_destroy (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a7e1281cdb47bc1680b9635719d1e417c">last_modified_hash</a>);
    <span class="keywordflow">if</span> (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a702738ebda8b8ec9109a48537c8b91ac">current_file_id_hash</a>)
        g_hash_table_destroy (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a702738ebda8b8ec9109a48537c8b91ac">current_file_id_hash</a>);
    <span class="keywordflow">if</span> (dir)
        <a class="code" href="fs-mgr_8c.html#ae04d3c4669cd7b0fc691cd2da6dc2de1">seaf_dir_free</a> (dir);

    <span class="keywordflow">return</span> g_list_reverse(ret_list);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_ad00a42c20e1baadf267215e7e683f9e4_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_ad00a42c20e1baadf267215e7e683f9e4_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_ad00a42c20e1baadf267215e7e683f9e4_cgraph" id="server_2repo-mgr_8h_ad00a42c20e1baadf267215e7e683f9e4_cgraph">
<area shape="rect" id="node3" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6" title="seaf_repo_manager_get_repo" alt="" coords="415,7,607,36"/><area shape="rect" id="node5" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f" title="seaf_commit_manager_get_commit" alt="" coords="733,177,963,207"/><area shape="rect" id="node9" href="fs-mgr_8c.html#a033b8831db7345eec0ff09216b63593d" title="seaf_fs_manager_get_seafdir_by_path" alt="" coords="388,60,633,89"/><area shape="rect" id="node17" href="fs-mgr_8c.html#ae04d3c4669cd7b0fc691cd2da6dc2de1" title="seaf_dir_free" alt="" coords="800,112,896,141"/><area shape="rect" id="node21" href="commit-mgr_8c.html#a032f260db46d5566e78dfcbbc4b2859a" title="seaf_commit_manager_traverse_commit_tree_with_limit" alt="" coords="336,215,685,244"/><area shape="rect" id="node24" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="781,255,915,284"/><area shape="rect" id="node26" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="453,319,568,348"/><area shape="rect" id="node7" href="commit-mgr_8c.html#a2b1cc305cf40cb64c341a0e64d0fe921" title="seaf_commit_ref" alt="" coords="1033,177,1151,207"/><area shape="rect" id="node11" href="fs-mgr_8c.html#a08103ffc3a5cd19b70167404c39ce3e4" title="seaf_fs_manager_get_seafdir" alt="" coords="752,59,944,88"/><area shape="rect" id="node13" href="obj-store_8c.html#a6e93a0214f9cb8a7fc837a2bc3a3c529" title="seaf_obj_store_read_obj" alt="" coords="1011,5,1173,35"/><area shape="rect" id="node15" href="fs-mgr_8c.html#a6875a119da427bb1cd9796eee916b703" title="seaf_dir_from_data" alt="" coords="1025,59,1159,88"/><area shape="rect" id="node19" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a" title="seaf_dirent_free" alt="" coords="1035,112,1149,141"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a6a318e5a5bcb0d46286030040ab6e23b"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_check_permission" ref="a6a318e5a5bcb0d46286030040ab6e23b" args="(SeafRepoManager *mgr, const char *repo_id, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="repo-perm_8c.html#a6a318e5a5bcb0d46286030040ab6e23b">seaf_repo_manager_check_permission</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="repo-perm_8c_source.html#l00133">133</a> of file <a class="el" href="repo-perm_8c_source.html">repo-perm.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="structSeafVirtRepo.html">SeafVirtRepo</a> *vinfo;
    <span class="keywordtype">char</span> *owner = NULL;
    <span class="keywordtype">char</span> *permission = NULL;

    <span class="comment">/* This is a virtual repo.*/</span>
    vinfo = <a class="code" href="server_2gc_2Backups_2repo-mgr_8c.html#a316db228b35dde3dc88ae9dab9ec9c22">seaf_repo_manager_get_virtual_repo_info</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (vinfo) {
        permission = check_virtual_repo_permission (mgr, repo_id,
                                                    vinfo-&gt;<a class="code" href="structSeafVirtRepo.html#a23bc0205036c7a0c807c4f89145794b1">origin_repo_id</a>,
                                                    user, error);
        <span class="keywordflow">goto</span> out;
    }

    owner = <a class="code" href="server_2Backups_2repo-mgr_8c.html#af227a31082c71908bf0a0ac35cfeb294">seaf_repo_manager_get_repo_owner</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (owner != NULL) {
        <span class="keywordflow">if</span> (strcmp (owner, user) == 0)
            permission = g_strdup(<span class="stringliteral">&quot;rw&quot;</span>);
        <span class="keywordflow">else</span>
            permission = check_repo_share_permission (mgr, repo_id, user);
    }

out:
    <a class="code" href="server_2gc_2Backups_2repo-mgr_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a">seaf_virtual_repo_info_free</a> (vinfo);
    g_free (owner);
    <span class="keywordflow">return</span> permission;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a6a318e5a5bcb0d46286030040ab6e23b_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a6a318e5a5bcb0d46286030040ab6e23b_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a6a318e5a5bcb0d46286030040ab6e23b_cgraph" id="server_2repo-mgr_8h_a6a318e5a5bcb0d46286030040ab6e23b_cgraph">
<area shape="rect" id="node3" href="server_2gc_2Backups_2repo-mgr_8c.html#a316db228b35dde3dc88ae9dab9ec9c22" title="seaf_repo_manager_get_virtual_repo_info" alt="" coords="303,5,564,35"/><area shape="rect" id="node5" href="server_2Backups_2repo-mgr_8c.html#af227a31082c71908bf0a0ac35cfeb294" title="seaf_repo_manager_get_repo_owner" alt="" coords="316,59,551,88"/><area shape="rect" id="node7" href="server_2gc_2Backups_2repo-mgr_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a" title="seaf_virtual_repo_info_free" alt="" coords="344,112,523,141"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a1cd4a8c70076d40d2a778dda774a2263"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_cleanup_virtual_repos" ref="a1cd4a8c70076d40d2a778dda774a2263" args="(SeafRepoManager *mgr, const char *origin_repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="virtual-repo_8c.html#a1cd4a8c70076d40d2a778dda774a2263">seaf_repo_manager_cleanup_virtual_repos</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>origin_repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="virtual-repo_8c_source.html#l00619">619</a> of file <a class="el" href="virtual-repo_8c_source.html">virtual-repo.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head = NULL;
    GList *vinfo_list = NULL, *ptr;
    <a class="code" href="structSeafVirtRepo.html">SeafVirtRepo</a> *vinfo;
    <a class="code" href="struct__SeafDir.html">SeafDir</a> *dir;
    GError *error = NULL;

    repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, origin_repo_id);
    <span class="keywordflow">if</span> (!repo) {
        seaf_warning (<span class="stringliteral">&quot;Failed to get repo %.10s.\n&quot;</span>, origin_repo_id);
        <span class="keywordflow">goto</span> out;
    }

    head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                           repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
                                           repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                           repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
    <span class="keywordflow">if</span> (!head) {
        seaf_warning (<span class="stringliteral">&quot;Failed to get commit %.8s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
        <span class="keywordflow">goto</span> out;
    }

    vinfo_list = <a class="code" href="server_2repo-mgr_8h.html#a5e7e933b737fca2ccdb657124812fc90">seaf_repo_manager_get_virtual_info_by_origin</a> (mgr,
                                                               origin_repo_id);
    <span class="keywordflow">for</span> (ptr = vinfo_list; ptr; ptr = ptr-&gt;next) {
        vinfo = ptr-&gt;data;
        dir = <a class="code" href="fs-mgr_8c.html#a033b8831db7345eec0ff09216b63593d">seaf_fs_manager_get_seafdir_by_path</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>,
                                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                   head-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                                   vinfo-&gt;<a class="code" href="structSeafVirtRepo.html#abd2d9ee29b9d78255cd52b8f7aa053ec">path</a>,
                                                   &amp;error);
        <span class="keywordflow">if</span> (error) {
            <span class="keywordflow">if</span> (error-&gt;code == <a class="code" href="seafile-error_8h.html#aabbb62a1d7a32a24a7d227ad7cc46535">SEAF_ERR_PATH_NO_EXIST</a>) {
                handle_missing_virtual_repo (mgr, repo, head, vinfo);
            }
            g_clear_error (&amp;error);
        } <span class="keywordflow">else</span>
            <a class="code" href="fs-mgr_8c.html#ae04d3c4669cd7b0fc691cd2da6dc2de1">seaf_dir_free</a> (dir);
        <a class="code" href="server_2gc_2Backups_2repo-mgr_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a">seaf_virtual_repo_info_free</a> (vinfo);
    }

out:
    <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (head);
    g_list_free (vinfo_list);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a1cd4a8c70076d40d2a778dda774a2263_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a1cd4a8c70076d40d2a778dda774a2263_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a1cd4a8c70076d40d2a778dda774a2263_cgraph" id="server_2repo-mgr_8h_a1cd4a8c70076d40d2a778dda774a2263_cgraph">
<area shape="rect" id="node3" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6" title="seaf_repo_manager_get_repo" alt="" coords="372,5,564,35"/><area shape="rect" id="node5" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f" title="seaf_commit_manager_get_commit" alt="" coords="353,59,583,88"/><area shape="rect" id="node9" href="server_2repo-mgr_8h.html#a5e7e933b737fca2ccdb657124812fc90" title="seaf_repo_manager_get_virtual_info_by_origin" alt="" coords="323,112,613,141"/><area shape="rect" id="node17" href="fs-mgr_8c.html#a033b8831db7345eec0ff09216b63593d" title="seaf_fs_manager_get_seafdir_by_path" alt="" coords="345,165,591,195"/><area shape="rect" id="node25" href="fs-mgr_8c.html#ae04d3c4669cd7b0fc691cd2da6dc2de1" title="seaf_dir_free" alt="" coords="719,219,815,248"/><area shape="rect" id="node30" href="server_2gc_2Backups_2repo-mgr_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a" title="seaf_virtual_repo_info_free" alt="" coords="379,269,557,299"/><area shape="rect" id="node32" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="411,323,525,352"/><area shape="rect" id="node34" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="401,376,535,405"/><area shape="rect" id="node7" href="commit-mgr_8c.html#a2b1cc305cf40cb64c341a0e64d0fe921" title="seaf_commit_ref" alt="" coords="708,59,825,88"/><area shape="rect" id="node11" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="661,112,872,141"/><area shape="rect" id="node13" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="921,59,1103,88"/><area shape="rect" id="node15" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="931,112,1093,141"/><area shape="rect" id="node19" href="fs-mgr_8c.html#a08103ffc3a5cd19b70167404c39ce3e4" title="seaf_fs_manager_get_seafdir" alt="" coords="671,165,863,195"/><area shape="rect" id="node21" href="obj-store_8c.html#a6e93a0214f9cb8a7fc837a2bc3a3c529" title="seaf_obj_store_read_obj" alt="" coords="931,165,1093,195"/><area shape="rect" id="node23" href="fs-mgr_8c.html#a6875a119da427bb1cd9796eee916b703" title="seaf_dir_from_data" alt="" coords="945,219,1079,248"/><area shape="rect" id="node27" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a" title="seaf_dirent_free" alt="" coords="955,272,1069,301"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a1cd4a8c70076d40d2a778dda774a2263_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a1cd4a8c70076d40d2a778dda774a2263_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a1cd4a8c70076d40d2a778dda774a2263_icgraph" id="server_2repo-mgr_8h_a1cd4a8c70076d40d2a778dda774a2263_icgraph">
<area shape="rect" id="node3" href="server_2repo-mgr_8h.html#ad6564c23b0e50d8a34dd425432b80db4" title="seaf_repo_manager_del_file" alt="" coords="336,5,520,35"/><area shape="rect" id="node5" href="server_2repo-mgr_8h.html#a056b45d63edfafbc5287012a2a1062ec" title="seaf_repo_manager_move_file" alt="" coords="583,32,780,61"/><area shape="rect" id="node8" href="server_2repo-mgr_8h.html#ae68e4b6427bb239b697e515c8617cbfb" title="seaf_repo_manager_rename_file" alt="" coords="323,109,533,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab7eae6af688907f68212dca114549c4b"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_copy_file" ref="ab7eae6af688907f68212dca114549c4b" args="(SeafRepoManager *mgr, const char *src_repo_id, const char *src_dir, const char *src_filename, const char *dst_repo_id, const char *dst_dir, const char *dst_filename, const char *user, int need_progress, int synchronous, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">SeafileCopyResult* <a class="el" href="repo-op_8c.html#a88f5fdc80a71e558b5508387eafbb6de">seaf_repo_manager_copy_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>src_repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>src_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>src_filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dst_repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dst_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dst_filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>need_progress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>synchronous</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Copy a SeafDirent from a SeafDir to another.</p>
<p>1. When  and  are not the same repo, neither of them should be encrypted.</p>
<p>2. the file being copied must not exist in the dst path of the dst repo. </p>

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l01756">1756</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *src_repo = NULL, *dst_repo = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *src_dent = NULL, *dst_dent = NULL;
    <span class="keywordtype">char</span> *src_canon_path = NULL, *dst_canon_path = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *dst_head_commit = NULL;
    <span class="keywordtype">int</span> ret = 0;
    gboolean background = FALSE;
    <span class="keywordtype">char</span> *task_id = NULL;
    SeafileCopyResult *res= NULL;

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(src_repo, src_repo_id);

    <span class="keywordflow">if</span> (strcmp(src_repo_id, dst_repo_id) != 0) {
        <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(dst_repo, dst_repo_id);

        <span class="keywordflow">if</span> (src_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a> || dst_repo-&gt;encrypted) {
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                         <span class="stringliteral">&quot;Can&#39;t copy files between encrypted repo(s)&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
        
    } <span class="keywordflow">else</span> {
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#ab8f60cbbd6c35ee55ea72acbbd3a1608">seaf_repo_ref</a> (src_repo);
        dst_repo = src_repo;
    }
    
    src_canon_path = get_canonical_path (src_path);
    dst_canon_path = get_canonical_path (dst_path);

    <span class="comment">/* first check whether a file with file_name already exists in destination dir */</span>
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(dst_head_commit,
                       dst_repo-&gt;id, dst_repo-&gt;<a class="code" href="struct__SeafCommit.html#abc83f168ce2b43fa864522bf0ea26d6d">version</a>, 
                       dst_repo-&gt;head-&gt;commit_id);
    
    <a class="code" href="Backups_2repo-op_8c.html#a897aab32c75a36b188922b8726831ccf">FAIL_IF_FILE_EXISTS</a>(dst_repo-&gt;store_id, dst_repo-&gt;version,
                        dst_head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, dst_canon_path, dst_filename, NULL);

    <span class="comment">/* get src dirent */</span>
    src_dent = get_dirent_by_path (src_repo, NULL,
                                   src_canon_path, src_filename, error);
    <span class="keywordflow">if</span> (!src_dent) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (strcmp (src_repo_id, dst_repo_id) == 0 ||
        is_virtual_repo_and_origin (src_repo, dst_repo)) {

        gint64 <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a> = (src_dent-&gt;<a class="code" href="struct__SeafDirent.html#afc58a80e040b009230ce1d3d500e2f1f">version</a> &gt; 0) ? src_dent-&gt;<a class="code" href="struct__SeafDirent.html#abf0e9b6fade594b7897cb9896d370961">size</a> : -1;

        <span class="comment">/* duplicate src dirent with new name */</span>
        dst_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(dst_repo-&gt;version),
                                    src_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>, src_dent-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>, dst_filename,
                                    (gint64)time(NULL), user, <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>);

        <span class="keywordflow">if</span> (put_dirent_and_commit (dst_repo,
                                   dst_canon_path,
                                   dst_dent,
                                   user,
                                   error) &lt; 0) {
            <span class="keywordflow">if</span> (!error)
                g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                             <span class="stringliteral">&quot;failed to put dirent&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }

        <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, dst_repo_id, NULL);

        update_repo_size (dst_repo_id);
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!synchronous) {
        background = TRUE;

        gint64 total_files = -1;
        <span class="keywordflow">if</span> (S_ISDIR(src_dent-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>))
            total_files = <a class="code" href="fs-mgr_8c.html#afa141245d62ac11820ad120fef68d01e">seaf_fs_manager_count_fs_files</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                                          src_repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>,
                                                          src_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                          src_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
        <span class="keywordflow">else</span>
            total_files = 1;
        <span class="keywordflow">if</span> (total_files &lt; 0) {
            seaf_warning (<span class="stringliteral">&quot;Failed to get file count.\n&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }

        <span class="keywordflow">if</span> (!check_file_count_and_size (src_repo, src_dent, total_files, error)) {
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }

        task_id = <a class="code" href="copy-mgr_8c.html#ae731d17024807023ab2689f9ffca5e99">seaf_copy_manager_add_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a1826aa8bcba056a4f41755627b270751">copy_mgr</a>,
                                              src_repo_id,
                                              src_canon_path,
                                              src_filename,
                                              dst_repo_id,
                                              dst_canon_path,
                                              dst_filename,
                                              user,
                                              total_files,
                                              cross_repo_copy,
                                              need_progress);
        <span class="keywordflow">if</span> (need_progress &amp;&amp; !task_id) {
            seaf_warning (<span class="stringliteral">&quot;Failed to start copy task.\n&quot;</span>);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;failed to start copy task&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    } <span class="keywordflow">else</span> {
        <span class="comment">/* Synchronous for cross-repo move */</span>
        <span class="keywordflow">if</span> (cross_repo_copy (src_repo_id,
                             src_canon_path,
                             src_filename,
                             dst_repo_id,
                             dst_canon_path,
                             dst_filename,
                             user,
                             NULL) &lt; 0) {
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;Failed to move&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

out:
    <span class="keywordflow">if</span> (src_repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (src_repo);
    <span class="keywordflow">if</span> (dst_repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (dst_repo);
    <span class="keywordflow">if</span> (dst_head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(dst_head_commit);
    <span class="keywordflow">if</span> (src_canon_path)
        g_free (src_canon_path);
    <span class="keywordflow">if</span> (dst_canon_path)
        g_free (dst_canon_path);
    <span class="keywordflow">if</span> (src_dent)
        <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a>(src_dent);
    <span class="keywordflow">if</span> (dst_dent)
        <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a>(dst_dent);

    <span class="keywordflow">if</span> (ret == 0) {
        res = seafile_copy_result_new ();
        g_object_set (res, <span class="stringliteral">&quot;background&quot;</span>, background, <span class="stringliteral">&quot;task_id&quot;</span>, task_id, NULL);
        g_free (task_id);
    }

    <span class="keywordflow">return</span> res;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_ab7eae6af688907f68212dca114549c4b_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_ab7eae6af688907f68212dca114549c4b_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_ab7eae6af688907f68212dca114549c4b_cgraph" id="server_2repo-mgr_8h_ab7eae6af688907f68212dca114549c4b_cgraph">
<area shape="rect" id="node3" href="fuse_2Backups_2repo-mgr_8c.html#ab8f60cbbd6c35ee55ea72acbbd3a1608" title="seaf_repo_ref" alt="" coords="324,5,425,35"/><area shape="rect" id="node5" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f" title="seaf_dirent_new" alt="" coords="316,59,433,88"/><area shape="rect" id="node7" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1" title="dir_version_from_repo_version" alt="" coords="276,112,473,141"/><area shape="rect" id="node9" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04" title="seaf_repo_manager_merge_virtual_repo" alt="" coords="248,165,501,195"/><area shape="rect" id="node17" href="fs-mgr_8c.html#afa141245d62ac11820ad120fef68d01e" title="seaf_fs_manager_count_fs_files" alt="" coords="269,219,480,248"/><area shape="rect" id="node19" href="copy-mgr_8c.html#ae731d17024807023ab2689f9ffca5e99" title="seaf_copy_manager_add_task" alt="" coords="276,272,473,301"/><area shape="rect" id="node29" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="317,325,432,355"/><area shape="rect" id="node31" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="308,379,441,408"/><area shape="rect" id="node33" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a" title="seaf_dirent_free" alt="" coords="317,432,432,461"/><area shape="rect" id="node11" href="fuse_2Backups_2repo-mgr_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c" title="seaf_repo_manager_is_virtual_repo" alt="" coords="596,112,823,141"/><area shape="rect" id="node13" href="server_2gc_2Backups_2repo-mgr_8c.html#a0e2fecd8fae5355455342e43f6588967" title="seaf_repo_manager_get_virtual_repo_ids_by_origin" alt="" coords="551,165,868,195"/><area shape="rect" id="node15" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="656,219,763,248"/><area shape="rect" id="node21" href="seafile-4_81_82_2lib_2utils_8c.html#af64020f0be33abde6a2a076ff9808809" title="gen_uuid" alt="" coords="672,272,747,301"/><area shape="rect" id="node23" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768" title="ccnet_job_manager_schedule_job" alt="" coords="600,325,819,355"/><area shape="rect" id="node25" href="job-mgr_8c.html#a6272c9579bee3c9bfb469e720e6a03e0" title="ccnet_job_new" alt="" coords="925,299,1035,328"/><area shape="rect" id="node27" href="job-mgr_8c.html#a0df701b89788bcc8e5fd0035f30afe29" title="job_thread_create" alt="" coords="917,352,1043,381"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a2365b6daa6aef0d8476fa90f2aeca051"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_count_inner_pub_repos" ref="a2365b6daa6aef0d8476fa90f2aeca051" args="(SeafRepoManager *mgr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gint64 <a class="el" href="server_2repo-mgr_8h.html#a2365b6daa6aef0d8476fa90f2aeca051">seaf_repo_manager_count_inner_pub_repos</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02587">2587</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];

    snprintf (sql, 256, <span class="stringliteral">&quot;SELECT COUNT(*) FROM InnerPubRepo&quot;</span>);

    <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a401edd7e7937648d96ffb06486097020">seaf_db_get_int64</a>(mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a2365b6daa6aef0d8476fa90f2aeca051_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a2365b6daa6aef0d8476fa90f2aeca051_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a2365b6daa6aef0d8476fa90f2aeca051_cgraph" id="server_2repo-mgr_8h_a2365b6daa6aef0d8476fa90f2aeca051_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#a401edd7e7937648d96ffb06486097020" title="seaf_db_get_int64" alt="" coords="331,5,459,35"/><area shape="rect" id="node5" href="seaf-db_8c.html#ac9d9437b19d33c23ce45ec6b1f4d8a05" title="seaf_db_row_get_column_int64" alt="" coords="507,5,712,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ad9feaba8f2f873b6685560fd86f4c40d"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_create_enc_repo" ref="ad9feaba8f2f873b6685560fd86f4c40d" args="(SeafRepoManager *mgr, const char *repo_id, const char *repo_name, const char *repo_desc, const char *owner_email, const char *magic, const char *random_key, int enc_version, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="server_2repo-mgr_8h.html#ad9feaba8f2f873b6685560fd86f4c40d">seaf_repo_manager_create_enc_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_desc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner_email</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>magic</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>random_key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>enc_version</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02789">2789</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (!repo_id || !<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a48ecdc72b727191abafbbf2ec1f70ace">is_uuid_valid</a> (repo_id)) {
        seaf_warning (<span class="stringliteral">&quot;Invalid repo_id.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid repo id&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">if</span> (<a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a4b2497e6cdde50c4ce3cb642370e06eb">seaf_repo_manager_repo_exists</a> (mgr, repo_id)) {
        seaf_warning (<span class="stringliteral">&quot;Repo %s exists, refuse to create.\n&quot;</span>, repo_id);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Repo already exists&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">if</span> (create_repo_common (mgr, repo_id, repo_name, repo_desc, owner_email,
                            magic, random_key, enc_version, error) &lt; 0)
        <span class="keywordflow">return</span> NULL;

    <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a5f096821f41a339e41e9341fc0c4010d">seaf_repo_manager_set_repo_owner</a> (mgr, repo_id, owner_email) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;Failed to set repo owner.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to set repo owner.&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> g_strdup (repo_id);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_ad9feaba8f2f873b6685560fd86f4c40d_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_ad9feaba8f2f873b6685560fd86f4c40d_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_ad9feaba8f2f873b6685560fd86f4c40d_cgraph" id="server_2repo-mgr_8h_ad9feaba8f2f873b6685560fd86f4c40d_cgraph">
<area shape="rect" id="node3" href="seafile-4_81_82_2lib_2utils_8c.html#a48ecdc72b727191abafbbf2ec1f70ace" title="is_uuid_valid" alt="" coords="363,5,459,35"/><area shape="rect" id="node5" href="daemon_2Backups_2repo-mgr_8c.html#a4b2497e6cdde50c4ce3cb642370e06eb" title="seaf_repo_manager_repo_exists" alt="" coords="305,59,516,88"/><area shape="rect" id="node7" href="server_2Backups_2repo-mgr_8c.html#a5f096821f41a339e41e9341fc0c4010d" title="seaf_repo_manager_set_repo_owner" alt="" coords="293,112,528,141"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a3706de93ba77e5068dba6a1dd073a0fd"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_create_new_repo" ref="a3706de93ba77e5068dba6a1dd073a0fd" args="(SeafRepoManager *mgr, const char *repo_name, const char *repo_desc, const char *owner_email, const char *passwd, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="server_2repo-mgr_8h.html#a3706de93ba77e5068dba6a1dd073a0fd">seaf_repo_manager_create_new_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_desc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner_email</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>passwd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02746">2746</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *repo_id = NULL;
    <span class="keywordtype">char</span> magic[65], random_key[97];

    repo_id = <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af64020f0be33abde6a2a076ff9808809">gen_uuid</a> ();

    <span class="keywordflow">if</span> (passwd &amp;&amp; passwd[0] != 0) {
        <a class="code" href="seafile-crypt_8c.html#a4f67d65d3f21019477c1a0d8d7ec2477">seafile_generate_magic</a> (2, repo_id, passwd, magic);
        <a class="code" href="seafile-crypt_8c.html#ae58dda89366c1a52a611cee06b487f89">seafile_generate_random_key</a> (passwd, random_key);
    }

    <span class="keywordtype">int</span> rc;
    <span class="keywordflow">if</span> (passwd)
        rc = create_repo_common (mgr, repo_id, repo_name, repo_desc, owner_email,
                                 magic, random_key, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a79d3ddb90929fe8420a585a0105a50ec">CURRENT_ENC_VERSION</a>, error);
    <span class="keywordflow">else</span>
        rc = create_repo_common (mgr, repo_id, repo_name, repo_desc, owner_email,
                                 NULL, NULL, -1, error);
    <span class="keywordflow">if</span> (rc &lt; 0)
        <span class="keywordflow">goto</span> bad;

    <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a5f096821f41a339e41e9341fc0c4010d">seaf_repo_manager_set_repo_owner</a> (mgr, repo_id, owner_email) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;Failed to set repo owner.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to set repo owner.&quot;</span>);
        <span class="keywordflow">goto</span> bad;
    }

    <span class="keywordflow">return</span> repo_id;
    
bad:
    <span class="keywordflow">if</span> (repo_id)
        g_free (repo_id);
    <span class="keywordflow">return</span> NULL;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a3706de93ba77e5068dba6a1dd073a0fd_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a3706de93ba77e5068dba6a1dd073a0fd_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a3706de93ba77e5068dba6a1dd073a0fd_cgraph" id="server_2repo-mgr_8h_a3706de93ba77e5068dba6a1dd073a0fd_cgraph">
<area shape="rect" id="node3" href="seafile-4_81_82_2lib_2utils_8c.html#af64020f0be33abde6a2a076ff9808809" title="gen_uuid" alt="" coords="376,5,451,35"/><area shape="rect" id="node5" href="seafile-crypt_8c.html#a4f67d65d3f21019477c1a0d8d7ec2477" title="seafile_generate_magic" alt="" coords="335,59,492,88"/><area shape="rect" id="node11" href="seafile-crypt_8c.html#ae58dda89366c1a52a611cee06b487f89" title="seafile_generate_random_key" alt="" coords="316,112,511,141"/><area shape="rect" id="node19" href="server_2Backups_2repo-mgr_8c.html#a5f096821f41a339e41e9341fc0c4010d" title="seaf_repo_manager_set_repo_owner" alt="" coords="296,165,531,195"/><area shape="rect" id="node7" href="seafile-crypt_8c.html#aef671f4a46b3d132f4219e55fbcb72d9" title="seafile_derive_key" alt="" coords="579,32,709,61"/><area shape="rect" id="node9" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09" title="rawdata_to_hex" alt="" coords="587,85,701,115"/><area shape="rect" id="node14" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228" title="seafile_crypt_new" alt="" coords="581,139,707,168"/><area shape="rect" id="node16" href="seafile-crypt_8c.html#a153a2146ed90b98ccdb91da4bc343016" title="seafile_encrypt" alt="" coords="589,192,699,221"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a9a8dcda29ee6cd28d92c1897ad12f268"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_create_virtual_repo" ref="a9a8dcda29ee6cd28d92c1897ad12f268" args="(SeafRepoManager *mgr, const char *origin_repo_id, const char *path, const char *repo_name, const char *repo_desc, const char *owner, const char *passwd, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="virtual-repo_8c.html#a9a8dcda29ee6cd28d92c1897ad12f268">seaf_repo_manager_create_virtual_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>origin_repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_desc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>passwd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="virtual-repo_8c_source.html#l00168">168</a> of file <a class="el" href="virtual-repo_8c_source.html">virtual-repo.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *origin_repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *origin_head = NULL;
    <span class="keywordtype">char</span> *repo_id = NULL;
    <span class="keywordtype">char</span> *dir_id = NULL;
    <span class="keywordtype">char</span> *orig_owner = NULL;

    <span class="keywordflow">if</span> (<a class="code" href="fuse_2Backups_2repo-mgr_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c">seaf_repo_manager_is_virtual_repo</a> (mgr, origin_repo_id)) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Cannot create sub-library from a sub-library&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    repo_id = get_existing_virtual_repo (mgr, origin_repo_id, path);
    <span class="keywordflow">if</span> (repo_id) {
        <span class="keywordflow">return</span> repo_id;
    }

    origin_repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, origin_repo_id);
    <span class="keywordflow">if</span> (!origin_repo) {
        seaf_warning (<span class="stringliteral">&quot;Failed to get origin repo %.10s\n&quot;</span>, origin_repo_id);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Origin library not exists&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">if</span> (origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
        <span class="keywordflow">if</span> (origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> &lt; 2) {
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                         <span class="stringliteral">&quot;Library encryption version must be higher than 2&quot;</span>);
            <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (origin_repo);
            <span class="keywordflow">return</span> NULL;
        }

        <span class="keywordflow">if</span> (!passwd || passwd[0] == 0) {
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                         <span class="stringliteral">&quot;Password is not set&quot;</span>);
            <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (origin_repo);
            <span class="keywordflow">return</span> NULL;
        }

        <span class="keywordflow">if</span> (<a class="code" href="seafile-crypt_8c.html#a9ada7f42f1f31b91dabdc5edde6b73f9">seafile_verify_repo_passwd</a> (origin_repo_id,
                                        passwd,
                                        origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>,
                                        origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>) &lt; 0) {
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;Incorrect password&quot;</span>);
            <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (origin_repo);
            <span class="keywordflow">return</span> NULL;
        }
    }

    origin_head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                                  origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
                                                  origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                  origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
    <span class="keywordflow">if</span> (!origin_head) {
        seaf_warning (<span class="stringliteral">&quot;Failed to get head commit %.8s.\n&quot;</span>,
                      origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Bad origin repo head&quot;</span>);
        <span class="keywordflow">goto</span> error;
    }

    dir_id = <a class="code" href="fs-mgr_8c.html#a3fbd81f579b4a8594861cbc0595595ca">seaf_fs_manager_get_seafdir_id_by_path</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                                     origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>,
                                                     origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                     origin_head-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                                     path, NULL);
    <span class="keywordflow">if</span> (!dir_id) {
        seaf_warning (<span class="stringliteral">&quot;Path %s doesn&#39;t exist or is not a dir in repo %.10s.\n&quot;</span>,
                      path, origin_repo_id);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Bad path&quot;</span>);
        <span class="keywordflow">goto</span> error;
    }

    repo_id = <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af64020f0be33abde6a2a076ff9808809">gen_uuid</a>();

    <span class="comment">/* Save virtual repo info before actually create the repo.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (save_virtual_repo_info (mgr, repo_id, origin_repo_id,
                                path, origin_head-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;Failed to save virtual repo info for %.10s:%s&quot;</span>,
                      origin_repo_id, path);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;Internal error&quot;</span>);
        <span class="keywordflow">goto</span> error;
    }

    orig_owner = <a class="code" href="server_2Backups_2repo-mgr_8c.html#af227a31082c71908bf0a0ac35cfeb294">seaf_repo_manager_get_repo_owner</a> (mgr, origin_repo_id);

    <span class="keywordflow">if</span> (do_create_virtual_repo (mgr, origin_repo, repo_id, repo_name, repo_desc,
                                dir_id, orig_owner, passwd, error) &lt; 0)
        <span class="keywordflow">goto</span> error;

    <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a5f096821f41a339e41e9341fc0c4010d">seaf_repo_manager_set_repo_owner</a> (mgr, repo_id, orig_owner) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;Failed to set repo owner for %.10s.\n&quot;</span>, repo_id);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to set repo owner.&quot;</span>);
        <span class="keywordflow">goto</span> error;
    }

    <span class="comment">/* The size of virtual repo is non-zero at the beginning. */</span>
    update_repo_size (repo_id);

    <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (origin_repo);
    <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (origin_head);
    g_free (dir_id);
    g_free (orig_owner);
    <span class="keywordflow">return</span> repo_id;

error:
    <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (origin_repo);
    <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (origin_head);
    g_free (repo_id);
    g_free (dir_id);
    g_free (orig_owner);
    <span class="keywordflow">return</span> NULL;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a9a8dcda29ee6cd28d92c1897ad12f268_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a9a8dcda29ee6cd28d92c1897ad12f268_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a9a8dcda29ee6cd28d92c1897ad12f268_cgraph" id="server_2repo-mgr_8h_a9a8dcda29ee6cd28d92c1897ad12f268_cgraph">
<area shape="rect" id="node3" href="fuse_2Backups_2repo-mgr_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c" title="seaf_repo_manager_is_virtual_repo" alt="" coords="325,5,552,35"/><area shape="rect" id="node5" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6" title="seaf_repo_manager_get_repo" alt="" coords="343,59,535,88"/><area shape="rect" id="node7" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="381,112,496,141"/><area shape="rect" id="node9" href="seafile-crypt_8c.html#a9ada7f42f1f31b91dabdc5edde6b73f9" title="seafile_verify_repo_passwd" alt="" coords="348,165,529,195"/><area shape="rect" id="node15" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f" title="seaf_commit_manager_get_commit" alt="" coords="324,219,553,248"/><area shape="rect" id="node19" href="fs-mgr_8c.html#a3fbd81f579b4a8594861cbc0595595ca" title="seaf_fs_manager_get_seafdir_id_by_path" alt="" coords="308,272,569,301"/><area shape="rect" id="node37" href="seafile-4_81_82_2lib_2utils_8c.html#af64020f0be33abde6a2a076ff9808809" title="gen_uuid" alt="" coords="401,325,476,355"/><area shape="rect" id="node39" href="server_2Backups_2repo-mgr_8c.html#af227a31082c71908bf0a0ac35cfeb294" title="seaf_repo_manager_get_repo_owner" alt="" coords="321,379,556,408"/><area shape="rect" id="node41" href="server_2Backups_2repo-mgr_8c.html#a5f096821f41a339e41e9341fc0c4010d" title="seaf_repo_manager_set_repo_owner" alt="" coords="321,432,556,461"/><area shape="rect" id="node43" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="372,485,505,515"/><area shape="rect" id="node11" href="seafile-crypt_8c.html#aef671f4a46b3d132f4219e55fbcb72d9" title="seafile_derive_key" alt="" coords="660,112,791,141"/><area shape="rect" id="node13" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09" title="rawdata_to_hex" alt="" coords="668,165,783,195"/><area shape="rect" id="node17" href="commit-mgr_8c.html#a2b1cc305cf40cb64c341a0e64d0fe921" title="seaf_commit_ref" alt="" coords="667,219,784,248"/><area shape="rect" id="node21" href="fs-mgr_8c.html#a60a96b2445ab49d626baac6b16e75fe9" title="seaf_fs_manager_path_to_obj_id" alt="" coords="619,272,832,301"/><area shape="rect" id="node23" href="fs-mgr_8c.html#a08103ffc3a5cd19b70167404c39ce3e4" title="seaf_fs_manager_get_seafdir" alt="" coords="1177,227,1369,256"/><area shape="rect" id="node29" href="fs-mgr_8c.html#a033b8831db7345eec0ff09216b63593d" title="seaf_fs_manager_get_seafdir_by_path" alt="" coords="881,272,1127,301"/><area shape="rect" id="node32" href="fs-mgr_8c.html#ae04d3c4669cd7b0fc691cd2da6dc2de1" title="seaf_dir_free" alt="" coords="1225,299,1321,328"/><area shape="rect" id="node25" href="obj-store_8c.html#a6e93a0214f9cb8a7fc837a2bc3a3c529" title="seaf_obj_store_read_obj" alt="" coords="1419,185,1581,215"/><area shape="rect" id="node27" href="fs-mgr_8c.html#a6875a119da427bb1cd9796eee916b703" title="seaf_dir_from_data" alt="" coords="1433,239,1567,268"/><area shape="rect" id="node34" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a" title="seaf_dirent_free" alt="" coords="1443,299,1557,328"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ad6564c23b0e50d8a34dd425432b80db4"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_del_file" ref="ad6564c23b0e50d8a34dd425432b80db4" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *file_name, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#ad6564c23b0e50d8a34dd425432b80db4">seaf_repo_manager_del_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l01318">1318</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <span class="keywordtype">int</span> <a class="code" href="index_8h.html#ac1b4d694fc07a39e06900e82872aac7f">mode</a> = 0;
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    <span class="keywordflow">if</span> (!canon_path)
        canon_path = get_canonical_path (parent_dir);
    
    <span class="keywordflow">if</span> (!check_file_exists(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                           head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, file_name, &amp;mode)) {
        seaf_warning (<span class="stringliteral">&quot;[del file] target file %s/%s does not exist, skip\n&quot;</span>,
                      canon_path, file_name);
        <span class="keywordflow">goto</span> out;
    }

    root_id = do_del_file (repo,
                           head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, file_name);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[del file] Failed to del file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to del file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    <span class="keywordflow">if</span> (S_ISDIR(mode)) {
        snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Removed directory \&quot;%s\&quot;&quot;</span>, file_name);
    } <span class="keywordflow">else</span> {
        snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Deleted \&quot;%s\&quot;&quot;</span>, file_name);
    }

    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a1cd4a8c70076d40d2a778dda774a2263">seaf_repo_manager_cleanup_virtual_repos</a> (mgr, repo_id);

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    g_free (root_id);
    g_free (canon_path);

    <span class="keywordflow">if</span> (ret == 0) {
        update_repo_size (repo_id);
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_ad6564c23b0e50d8a34dd425432b80db4_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_ad6564c23b0e50d8a34dd425432b80db4_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_ad6564c23b0e50d8a34dd425432b80db4_cgraph" id="server_2repo-mgr_8h_ad6564c23b0e50d8a34dd425432b80db4_cgraph">
<area shape="rect" id="node3" href="server_2repo-mgr_8h.html#a1cd4a8c70076d40d2a778dda774a2263" title="seaf_repo_manager_cleanup_virtual_repos" alt="" coords="237,271,507,300"/><area shape="rect" id="node34" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="657,377,772,407"/><area shape="rect" id="node36" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="648,431,781,460"/><area shape="rect" id="node38" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04" title="seaf_repo_manager_merge_virtual_repo" alt="" coords="245,511,499,540"/><area shape="rect" id="node5" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6" title="seaf_repo_manager_get_repo" alt="" coords="619,217,811,247"/><area shape="rect" id="node7" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f" title="seaf_commit_manager_get_commit" alt="" coords="600,271,829,300"/><area shape="rect" id="node11" href="server_2repo-mgr_8h.html#a5e7e933b737fca2ccdb657124812fc90" title="seaf_repo_manager_get_virtual_info_by_origin" alt="" coords="569,324,860,353"/><area shape="rect" id="node19" href="fs-mgr_8c.html#a033b8831db7345eec0ff09216b63593d" title="seaf_fs_manager_get_seafdir_by_path" alt="" coords="592,60,837,89"/><area shape="rect" id="node27" href="fs-mgr_8c.html#ae04d3c4669cd7b0fc691cd2da6dc2de1" title="seaf_dir_free" alt="" coords="980,112,1076,141"/><area shape="rect" id="node32" href="server_2gc_2Backups_2repo-mgr_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a" title="seaf_virtual_repo_info_free" alt="" coords="625,164,804,193"/><area shape="rect" id="node9" href="commit-mgr_8c.html#a2b1cc305cf40cb64c341a0e64d0fe921" title="seaf_commit_ref" alt="" coords="969,271,1087,300"/><area shape="rect" id="node13" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="923,324,1133,353"/><area shape="rect" id="node15" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="1183,297,1364,327"/><area shape="rect" id="node17" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="1192,351,1355,380"/><area shape="rect" id="node21" href="fs-mgr_8c.html#a08103ffc3a5cd19b70167404c39ce3e4" title="seaf_fs_manager_get_seafdir" alt="" coords="932,59,1124,88"/><area shape="rect" id="node23" href="obj-store_8c.html#a6e93a0214f9cb8a7fc837a2bc3a3c529" title="seaf_obj_store_read_obj" alt="" coords="1192,59,1355,88"/><area shape="rect" id="node25" href="fs-mgr_8c.html#a6875a119da427bb1cd9796eee916b703" title="seaf_dir_from_data" alt="" coords="1207,5,1340,35"/><area shape="rect" id="node29" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a" title="seaf_dirent_free" alt="" coords="1216,112,1331,141"/><area shape="rect" id="node40" href="fuse_2Backups_2repo-mgr_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c" title="seaf_repo_manager_is_virtual_repo" alt="" coords="601,484,828,513"/><area shape="rect" id="node42" href="server_2gc_2Backups_2repo-mgr_8c.html#a0e2fecd8fae5355455342e43f6588967" title="seaf_repo_manager_get_virtual_repo_ids_by_origin" alt="" coords="556,537,873,567"/><area shape="rect" id="node44" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="661,591,768,620"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_ad6564c23b0e50d8a34dd425432b80db4_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_ad6564c23b0e50d8a34dd425432b80db4_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_ad6564c23b0e50d8a34dd425432b80db4_icgraph" id="server_2repo-mgr_8h_ad6564c23b0e50d8a34dd425432b80db4_icgraph">
<area shape="rect" id="node3" href="server_2repo-mgr_8h.html#a056b45d63edfafbc5287012a2a1062ec" title="seaf_repo_manager_move_file" alt="" coords="239,5,436,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a1085e1b2d057850d0a87132107a0e741"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_del_group_repo" ref="a1085e1b2d057850d0a87132107a0e741" args="(SeafRepoManager *mgr, const char *repo_id, int group_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a1085e1b2d057850d0a87132107a0e741">seaf_repo_manager_del_group_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>group_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02225">2225</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                    <span class="stringliteral">&quot;DELETE FROM RepoGroup WHERE group_id=? &quot;</span>
                                    <span class="stringliteral">&quot;AND repo_id=?&quot;</span>,
                                    2, <span class="stringliteral">&quot;int&quot;</span>, group_id, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a1085e1b2d057850d0a87132107a0e741_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a1085e1b2d057850d0a87132107a0e741_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a1085e1b2d057850d0a87132107a0e741_cgraph" id="server_2repo-mgr_8h_a1085e1b2d057850d0a87132107a0e741_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5" title="seaf_db_statement_query" alt="" coords="287,32,457,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="508,5,689,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="517,59,680,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a512a79980f7d3698e591cf87aeccd314"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_del_repo" ref="a512a79980f7d3698e591cf87aeccd314" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a512a79980f7d3698e591cf87aeccd314">seaf_repo_manager_del_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l00445">445</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (add_deleted_repo_to_trash (mgr, repo_id) &lt; 0)
        <span class="keywordflow">return</span> -1;

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM Repo WHERE repo_id = ?&quot;</span>,
                                 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0)
        <span class="keywordflow">return</span> -1;

    <span class="comment">/* Repo branches are not removed at this point. */</span>

    <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM RepoOwner WHERE repo_id = ?&quot;</span>,
                             1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);

    <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM SharedRepo WHERE repo_id = ?&quot;</span>,
                             1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);

    <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM RepoGroup WHERE repo_id = ?&quot;</span>,
                             1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);

    <span class="keywordflow">if</span> (!<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a65f4d1d214fce9bd718d84aa87b9bd9c">cloud_mode</a>) {
        <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM InnerPubRepo WHERE repo_id = ?&quot;</span>,
                                 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
    }

    <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM RepoUserToken WHERE repo_id = ?&quot;</span>,
                             1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);

    <span class="comment">/* Remove virtual repos when origin repo is deleted. */</span>
    GList *vrepos, *ptr;
    vrepos = <a class="code" href="server_2gc_2Backups_2repo-mgr_8c.html#a0e2fecd8fae5355455342e43f6588967">seaf_repo_manager_get_virtual_repo_ids_by_origin</a> (mgr, repo_id);
    <span class="keywordflow">for</span> (ptr = vrepos; ptr != NULL; ptr = ptr-&gt;next)
        remove_virtual_repo_ondisk (mgr, (<span class="keywordtype">char</span> *)ptr-&gt;data);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (vrepos);

    <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM VirtualRepo &quot;</span>
                             <span class="stringliteral">&quot;WHERE repo_id=? OR origin_repo=?&quot;</span>,
                             2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;string&quot;</span>, repo_id);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a512a79980f7d3698e591cf87aeccd314_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a512a79980f7d3698e591cf87aeccd314_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a512a79980f7d3698e591cf87aeccd314_cgraph" id="server_2repo-mgr_8h_a512a79980f7d3698e591cf87aeccd314_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5" title="seaf_db_statement_query" alt="" coords="320,32,491,61"/><area shape="rect" id="node9" href="server_2gc_2Backups_2repo-mgr_8c.html#a0e2fecd8fae5355455342e43f6588967" title="seaf_repo_manager_get_virtual_repo_ids_by_origin" alt="" coords="247,85,564,115"/><area shape="rect" id="node11" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="352,139,459,168"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="615,5,796,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="624,59,787,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a94469a7522aa5a67fbc58440544e299a"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_del_repo_from_trash" ref="a94469a7522aa5a67fbc58440544e299a" args="(SeafRepoManager *mgr, const char *repo_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a94469a7522aa5a67fbc58440544e299a">seaf_repo_manager_del_repo_from_trash</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01995">1995</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> ret = 0;

    <span class="comment">/* As long as the repo is successfully moved into GarbageRepo table,</span>
<span class="comment">     * we consider this operation successful.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (add_deleted_repo_record (mgr, repo_id) &lt; 0) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;DB error: Add deleted record&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    <span class="comment">/* remove branch */</span>
    GList *p;
    GList *branch_list = <a class="code" href="branch-mgr_8c.html#ad5bd62cbe17cb8fe91bcd993956a1fbf">seaf_branch_manager_get_branch_list</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo_id);
    <span class="keywordflow">for</span> (p = branch_list; p; p = p-&gt;next) {
        <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *b = (<a class="code" href="struct__SeafBranch.html">SeafBranch</a> *)p-&gt;data;
        <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ae586fb5fbd61d6b44be3e47e7b6c86da">seaf_repo_manager_branch_repo_unmap</a> (mgr, b);
        <a class="code" href="branch-mgr_8c.html#a16b2df7708f3a4c4b96e9135ec7e1a3d">seaf_branch_manager_del_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo_id, b-&gt;<a class="code" href="struct__SeafBranch.html#ae6af0006b9b80ded4f0525a3be06ccda">name</a>);
    }
    <a class="code" href="branch-mgr_8c.html#ac6476414064e0ff0c429629aaab0bfc9">seaf_branch_list_free</a> (branch_list);

    <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                             <span class="stringliteral">&quot;DELETE FROM RepoTrash WHERE repo_id = ?&quot;</span>,
                             1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a94469a7522aa5a67fbc58440544e299a_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a94469a7522aa5a67fbc58440544e299a_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a94469a7522aa5a67fbc58440544e299a_cgraph" id="server_2repo-mgr_8h_a94469a7522aa5a67fbc58440544e299a_cgraph">
<area shape="rect" id="node3" href="branch-mgr_8c.html#ad5bd62cbe17cb8fe91bcd993956a1fbf" title="seaf_branch_manager_get_branch_list" alt="" coords="323,59,568,88"/><area shape="rect" id="node9" href="branch-mgr_8c.html#ac6476414064e0ff0c429629aaab0bfc9" title="seaf_branch_list_free" alt="" coords="637,112,784,141"/><area shape="rect" id="node15" href="daemon_2Backups_2repo-mgr_8c.html#ae586fb5fbd61d6b44be3e47e7b6c86da" title="seaf_repo_manager_branch_repo_unmap" alt="" coords="316,163,575,192"/><area shape="rect" id="node17" href="branch-mgr_8c.html#a16b2df7708f3a4c4b96e9135ec7e1a3d" title="seaf_branch_manager_del_branch" alt="" coords="336,216,555,245"/><area shape="rect" id="node21" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5" title="seaf_db_statement_query" alt="" coords="625,268,796,297"/><area shape="rect" id="node5" href="seafile-4_81_82_2lib_2db_8c.html#a4d1d0eb407f8f5dd522c3875beb7b9c8" title="sqlite_query_prepare" alt="" coords="640,5,781,35"/><area shape="rect" id="node7" href="branch-mgr_8c.html#a4d213520d8a22d5191051715ccbfd1dd" title="seaf_branch_new" alt="" coords="649,59,772,88"/><area shape="rect" id="node11" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653" title="seaf_branch_unref" alt="" coords="873,112,1001,141"/><area shape="rect" id="node13" href="branch-mgr_8c.html#a449a49952dc253bd7b16367869d0ebdc" title="seaf_branch_free" alt="" coords="1077,112,1200,141"/><area shape="rect" id="node19" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9" title="sqlite_query_exec" alt="" coords="648,215,773,244"/><area shape="rect" id="node23" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="847,241,1028,271"/><area shape="rect" id="node25" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="856,295,1019,324"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a94469a7522aa5a67fbc58440544e299a_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a94469a7522aa5a67fbc58440544e299a_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a94469a7522aa5a67fbc58440544e299a_icgraph" id="server_2repo-mgr_8h_a94469a7522aa5a67fbc58440544e299a_icgraph">
<area shape="rect" id="node3" href="server_2repo-mgr_8h.html#a47fd08ad688d035ae95e11545bb0a68b" title="seaf_repo_manager_empty_repo_trash" alt="" coords="348,5,593,35"/><area shape="rect" id="node5" href="server_2repo-mgr_8h.html#a99f0a8fafd75a617d03ea745d36df9be" title="seaf_repo_manager_empty_repo_trash_by_owner" alt="" coords="316,59,625,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a69efc9d099ac370fff9fe9e4caea05ea"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_del_virtual_repo" ref="a69efc9d099ac370fff9fe9e4caea05ea" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a69efc9d099ac370fff9fe9e4caea05ea">seaf_repo_manager_del_virtual_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l00489">489</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">return</span> remove_virtual_repo_ondisk (mgr, repo_id);
}
</pre></div>
</div>
</div>
<a class="anchor" id="abd2450d97efc42795b87ad7b4624ae63"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_delete_repo_tokens_by_email" ref="abd2450d97efc42795b87ad7b4624ae63" args="(SeafRepoManager *mgr, const char *email, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#abd2450d97efc42795b87ad7b4624ae63">seaf_repo_manager_delete_repo_tokens_by_email</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>email</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01403">1403</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> ret = 0;
    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">template</span>;
    GList *token_list = NULL;
    GList *ptr;
    GString *token_list_str = g_string_new (<span class="stringliteral">&quot;&quot;</span>);
    GString *sql = g_string_new (<span class="stringliteral">&quot;&quot;</span>);
    <span class="keywordtype">int</span> rc;

    <span class="keyword">template</span> = <span class="stringliteral">&quot;SELECT u.token &quot;</span>
        <span class="stringliteral">&quot;FROM RepoUserToken as u, RepoTokenPeerInfo as p &quot;</span>
        <span class="stringliteral">&quot;WHERE u.token = p.token &quot;</span>
        <span class="stringliteral">&quot;AND u.email = ?&quot;</span>;
    rc = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="keyword">template</span>,
                                        collect_token_list, &amp;token_list,
                                        1, <span class="stringliteral">&quot;string&quot;</span>, email);
    <span class="keywordflow">if</span> (rc &lt; 0) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (rc == 0)
        <span class="keywordflow">goto</span> out;

    <span class="keywordflow">for</span> (ptr = token_list; ptr; ptr = ptr-&gt;next) {
        <span class="keyword">const</span> <span class="keywordtype">char</span> *token = (<span class="keywordtype">char</span> *)ptr-&gt;data;
        if (token_list_str-&gt;len == 0)
            g_string_append_printf (token_list_str, <span class="stringliteral">&quot;&#39;%s&#39;&quot;</span>, token);
        <span class="keywordflow">else</span>
            g_string_append_printf (token_list_str, <span class="stringliteral">&quot;,&#39;%s&#39;&quot;</span>, token);
    }

    <span class="comment">/* Note that there is a size limit on sql query. In MySQL it&#39;s 1MB by default.</span>
<span class="comment">     * Normally the token_list won&#39;t be that long.</span>
<span class="comment">     */</span>
    g_string_printf (sql, <span class="stringliteral">&quot;DELETE FROM RepoUserToken WHERE token in (%s)&quot;</span>,
                     token_list_str-&gt;str);
    rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql-&gt;str, 0);
    <span class="keywordflow">if</span> (rc &lt; 0) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
        <span class="keywordflow">goto</span> out;
    }

    g_string_printf (sql, <span class="stringliteral">&quot;DELETE FROM RepoTokenPeerInfo WHERE token in (%s)&quot;</span>,
                     token_list_str-&gt;str);
    rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql-&gt;str, 0);
    <span class="keywordflow">if</span> (rc &lt; 0) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="Backups_2http-server_8c.html#a4b50fa8bc6c458c1a5bdc640cc71b6cb">seaf_http_server_invalidate_tokens</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a0309f60018b54c38ec8d3275ee1d6666">http_server</a>, token_list);

out:
    g_string_free (token_list_str, TRUE);
    g_string_free (sql, TRUE);
    g_list_free_full (token_list, (GDestroyNotify)g_free);

    <span class="keywordflow">if</span> (rc &lt; 0) {
        ret = -1;
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_abd2450d97efc42795b87ad7b4624ae63_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_abd2450d97efc42795b87ad7b4624ae63_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_abd2450d97efc42795b87ad7b4624ae63_cgraph" id="server_2repo-mgr_8h_abd2450d97efc42795b87ad7b4624ae63_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="376,59,587,88"/><area shape="rect" id="node9" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5" title="seaf_db_statement_query" alt="" coords="396,5,567,35"/><area shape="rect" id="node13" href="Backups_2http-server_8c.html#a4b50fa8bc6c458c1a5bdc640cc71b6cb" title="seaf_http_server_invalidate_tokens" alt="" coords="368,112,595,141"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="644,5,825,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="653,59,816,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab1d760446ae882d377b26dcd36eac582"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_delete_repo_tokens_by_peer_id" ref="ab1d760446ae882d377b26dcd36eac582" args="(SeafRepoManager *mgr, const char *email, const char *peer_id, GList **tokens, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#ab1d760446ae882d377b26dcd36eac582">seaf_repo_manager_delete_repo_tokens_by_peer_id</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>email</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>peer_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GList **&#160;</td>
          <td class="paramname"><em>tokens</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Delete all repo tokens for a given user on a given client </p>

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01334">1334</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> ret = 0;
    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">template</span>;
    GList *token_list = NULL;
    GString *token_list_str = g_string_new (<span class="stringliteral">&quot;&quot;</span>);
    GString *sql = g_string_new (<span class="stringliteral">&quot;&quot;</span>);
    GList *ptr;
    <span class="keywordtype">int</span> rc = 0;

    <span class="keyword">template</span> = <span class="stringliteral">&quot;SELECT u.token &quot;</span>
        <span class="stringliteral">&quot;FROM RepoUserToken as u, RepoTokenPeerInfo as p &quot;</span>
        <span class="stringliteral">&quot;WHERE u.token = p.token &quot;</span>
        <span class="stringliteral">&quot;AND u.email = ? AND p.peer_id = ?&quot;</span>;
    rc = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="keyword">template</span>,
                                        collect_token_list, &amp;token_list,
                                        2, <span class="stringliteral">&quot;string&quot;</span>, email, <span class="stringliteral">&quot;string&quot;</span>, peer_id);
    <span class="keywordflow">if</span> (rc &lt; 0) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (rc == 0)
        <span class="keywordflow">goto</span> out;

    <span class="keywordflow">for</span> (ptr = token_list; ptr; ptr = ptr-&gt;next) {
        <span class="keyword">const</span> <span class="keywordtype">char</span> *token = (<span class="keywordtype">char</span> *)ptr-&gt;data;
        if (token_list_str-&gt;len == 0)
            g_string_append_printf (token_list_str, <span class="stringliteral">&quot;&#39;%s&#39;&quot;</span>, token);
        <span class="keywordflow">else</span>
            g_string_append_printf (token_list_str, <span class="stringliteral">&quot;,&#39;%s&#39;&quot;</span>, token);
    }

    <span class="comment">/* Note that there is a size limit on sql query. In MySQL it&#39;s 1MB by default.</span>
<span class="comment">     * Normally the token_list won&#39;t be that long.</span>
<span class="comment">     */</span>
    g_string_printf (sql, <span class="stringliteral">&quot;DELETE FROM RepoUserToken WHERE token in (%s)&quot;</span>,
                     token_list_str-&gt;str);
    rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql-&gt;str, 0);
    <span class="keywordflow">if</span> (rc &lt; 0) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
        <span class="keywordflow">goto</span> out;
    }

    g_string_printf (sql, <span class="stringliteral">&quot;DELETE FROM RepoTokenPeerInfo WHERE token in (%s)&quot;</span>,
                     token_list_str-&gt;str);
    rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql-&gt;str, 0);
    <span class="keywordflow">if</span> (rc &lt; 0)
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);

out:
    g_string_free (token_list_str, TRUE);
    g_string_free (sql, TRUE);

    <span class="keywordflow">if</span> (rc &lt; 0) {
        ret = -1;
        g_list_free_full (token_list, (GDestroyNotify)g_free);
    } <span class="keywordflow">else</span> {
        *tokens = token_list;
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_ab1d760446ae882d377b26dcd36eac582_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_ab1d760446ae882d377b26dcd36eac582_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_ab1d760446ae882d377b26dcd36eac582_cgraph" id="server_2repo-mgr_8h_ab1d760446ae882d377b26dcd36eac582_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="381,5,592,35"/><area shape="rect" id="node9" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5" title="seaf_db_statement_query" alt="" coords="401,59,572,88"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="641,5,823,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="651,59,813,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aab7412302b0f206f7717a29d86d80e0f"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_delete_token" ref="aab7412302b0f206f7717a29d86d80e0f" args="(SeafRepoManager *mgr, const char *repo_id, const char *token, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#aab7412302b0f206f7717a29d86d80e0f">seaf_repo_manager_delete_token</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>token</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01152">1152</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *token_owner;

    token_owner = <a class="code" href="server_2Backups_2repo-mgr_8c.html#a2413f0a10a33c5de4d82193c9c8b7f08">seaf_repo_manager_get_email_by_token</a> (mgr, repo_id, token);
    <span class="keywordflow">if</span> (!token_owner || strcmp (user, token_owner) != 0) {
        seaf_warning (<span class="stringliteral">&quot;Requesting user is %s, token owner is %s, &quot;</span>
                      <span class="stringliteral">&quot;refuse to delete token %.10s.\n&quot;</span>, user, token_owner, token);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;Permission denied&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                 <span class="stringliteral">&quot;DELETE FROM RepoUserToken &quot;</span>
                                 <span class="stringliteral">&quot;WHERE repo_id=? and token=?&quot;</span>,
                                 2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;string&quot;</span>, token) &lt; 0) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                 <span class="stringliteral">&quot;DELETE FROM RepoTokenPeerInfo WHERE token=?&quot;</span>,
                                 1, <span class="stringliteral">&quot;string&quot;</span>, token) &lt; 0) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    GList *tokens = NULL;
    tokens = g_list_append (tokens, g_strdup(token));
    <a class="code" href="Backups_2http-server_8c.html#a4b50fa8bc6c458c1a5bdc640cc71b6cb">seaf_http_server_invalidate_tokens</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a0309f60018b54c38ec8d3275ee1d6666">http_server</a>, tokens);
    g_list_free_full (tokens, (GDestroyNotify)g_free);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_aab7412302b0f206f7717a29d86d80e0f_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_aab7412302b0f206f7717a29d86d80e0f_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_aab7412302b0f206f7717a29d86d80e0f_cgraph" id="server_2repo-mgr_8h_aab7412302b0f206f7717a29d86d80e0f_cgraph">
<area shape="rect" id="node3" href="server_2Backups_2repo-mgr_8c.html#a2413f0a10a33c5de4d82193c9c8b7f08" title="seaf_repo_manager_get_email_by_token" alt="" coords="272,5,531,35"/><area shape="rect" id="node5" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5" title="seaf_db_statement_query" alt="" coords="316,59,487,88"/><area shape="rect" id="node11" href="Backups_2http-server_8c.html#a4b50fa8bc6c458c1a5bdc640cc71b6cb" title="seaf_http_server_invalidate_tokens" alt="" coords="288,112,515,141"/><area shape="rect" id="node7" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="580,32,761,61"/><area shape="rect" id="node9" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="589,85,752,115"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a47fd08ad688d035ae95e11545bb0a68b"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_empty_repo_trash" ref="a47fd08ad688d035ae95e11545bb0a68b" args="(SeafRepoManager *mgr, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a47fd08ad688d035ae95e11545bb0a68b">seaf_repo_manager_empty_repo_trash</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02028">2028</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *trash_repos = NULL, *ptr;
    SeafileTrashRepo *repo;

    trash_repos = <a class="code" href="server_2Backups_2repo-mgr_8c.html#a8fec30cb36491cb94d968df3ce06d5d7">seaf_repo_manager_get_trash_repo_list</a> (mgr, -1, -1, error);
    <span class="keywordflow">if</span> (*error)
        <span class="keywordflow">return</span> -1;

    <span class="keywordflow">for</span> (ptr = trash_repos; ptr; ptr = ptr-&gt;next) {
        repo = ptr-&gt;data;
        <a class="code" href="server_2Backups_2repo-mgr_8c.html#a94469a7522aa5a67fbc58440544e299a">seaf_repo_manager_del_repo_from_trash</a> (mgr,
                                               seafile_trash_repo_get_repo_id(repo),
                                               NULL);
        g_object_unref (repo);
    }

    g_list_free (trash_repos);
    <span class="keywordflow">return</span> 0;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a47fd08ad688d035ae95e11545bb0a68b_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a47fd08ad688d035ae95e11545bb0a68b_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a47fd08ad688d035ae95e11545bb0a68b_cgraph" id="server_2repo-mgr_8h_a47fd08ad688d035ae95e11545bb0a68b_cgraph">
<area shape="rect" id="node3" href="server_2Backups_2repo-mgr_8c.html#a8fec30cb36491cb94d968df3ce06d5d7" title="seaf_repo_manager_get_trash_repo_list" alt="" coords="305,5,559,35"/><area shape="rect" id="node5" href="server_2Backups_2repo-mgr_8c.html#a94469a7522aa5a67fbc58440544e299a" title="seaf_repo_manager_del_repo_from_trash" alt="" coords="301,59,563,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a99f0a8fafd75a617d03ea745d36df9be"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_empty_repo_trash_by_owner" ref="a99f0a8fafd75a617d03ea745d36df9be" args="(SeafRepoManager *mgr, const char *owner, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a99f0a8fafd75a617d03ea745d36df9be">seaf_repo_manager_empty_repo_trash_by_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02050">2050</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *trash_repos = NULL, *ptr;
    SeafileTrashRepo *repo;

    trash_repos = <a class="code" href="server_2Backups_2repo-mgr_8c.html#a507c39fec59f1a4672a0cdd5493c6887">seaf_repo_manager_get_trash_repos_by_owner</a> (mgr, owner, error);
    <span class="keywordflow">if</span> (*error)
        <span class="keywordflow">return</span> -1;

    <span class="keywordflow">for</span> (ptr = trash_repos; ptr; ptr = ptr-&gt;next) {
        repo = ptr-&gt;data;
        <a class="code" href="server_2Backups_2repo-mgr_8c.html#a94469a7522aa5a67fbc58440544e299a">seaf_repo_manager_del_repo_from_trash</a> (mgr,
                                               seafile_trash_repo_get_repo_id(repo),
                                               NULL);
        g_object_unref (repo);
    }

    g_list_free (trash_repos);
    <span class="keywordflow">return</span> 0;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a99f0a8fafd75a617d03ea745d36df9be_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a99f0a8fafd75a617d03ea745d36df9be_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a99f0a8fafd75a617d03ea745d36df9be_cgraph" id="server_2repo-mgr_8h_a99f0a8fafd75a617d03ea745d36df9be_cgraph">
<area shape="rect" id="node3" href="server_2Backups_2repo-mgr_8c.html#a507c39fec59f1a4672a0cdd5493c6887" title="seaf_repo_manager_get_trash_repos_by_owner" alt="" coords="365,5,664,35"/><area shape="rect" id="node5" href="server_2Backups_2repo-mgr_8c.html#a94469a7522aa5a67fbc58440544e299a" title="seaf_repo_manager_del_repo_from_trash" alt="" coords="384,59,645,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a7899787e6f32bc1f2c578c740b2d716e"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_generate_repo_token" ref="a7899787e6f32bc1f2c578c740b2d716e" args="(SeafRepoManager *mgr, const char *repo_id, const char *email, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="server_2repo-mgr_8h.html#a7899787e6f32bc1f2c578c740b2d716e">seaf_repo_manager_generate_repo_token</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>email</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01084">1084</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *token = generate_repo_token ();
    <span class="keywordflow">if</span> (add_repo_token (mgr, repo_id, email, token, error) &lt; 0) {
        g_free (token);        
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> token;
}
</pre></div>
</div>
</div>
<a class="anchor" id="af52386548dacb8d7b466e1c75c79a208"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_decrypted_token" ref="af52386548dacb8d7b466e1c75c79a208" args="(SeafRepoManager *mgr, const char *encrypted_token, const char *session_key)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="server_2repo-mgr_8h.html#af52386548dacb8d7b466e1c75c79a208">seaf_repo_manager_get_decrypted_token</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>encrypted_token</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>session_key</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02884">2884</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> key[256];
    <a class="code" href="structDecryptedToken.html">DecryptedToken</a> *token;

    snprintf (key, <span class="keyword">sizeof</span>(key), <span class="stringliteral">&quot;%s%s&quot;</span>, encrypted_token, session_key);
    key[255] = 0;

    pthread_rwlock_rdlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);
    token = g_hash_table_lookup (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a57897702376986982d366379746bd694">decrypted_tokens</a>, key);
    pthread_rwlock_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);

    <span class="keywordflow">if</span> (token)
        <span class="keywordflow">return</span> g_strdup(token-&gt;<a class="code" href="structDecryptedToken.html#a42141944bd09e6d0a41fca83e8c970aa">token</a>);
    <span class="keywordflow">return</span> NULL;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a3bd2aea3b14fe8a45243d175ef86bb61"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_deleted_entries" ref="a3bd2aea3b14fe8a45243d175ef86bb61" args="(SeafRepoManager *mgr, const char *repo_id, int show_days, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="repo-op_8c.html#a3bd2aea3b14fe8a45243d175ef86bb61">seaf_repo_manager_get_deleted_entries</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>show_days</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l04673">4673</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
    gint64 truncate_time, show_time;
    GList *ret = NULL;

    truncate_time = <a class="code" href="server_2Backups_2repo-mgr_8c.html#a774e0a8ea59c07c94dc8014612b3f948">seaf_repo_manager_get_repo_truncate_time</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (truncate_time == 0)
        <span class="keywordflow">return</span> NULL;

    <span class="keywordflow">if</span> (show_days &lt;= 0)
        show_time = -1;
    <span class="keywordflow">else</span>
        show_time = (gint64)time(NULL) - show_days * 24 * 3600;

    repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (!repo) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Invalid repo id&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <a class="code" href="structCollectDelData.html">CollectDelData</a> data = {0};
    GHashTable *entries = g_hash_table_new_full (g_str_hash, g_str_equal,
                                                 g_free, g_object_unref);
    data.<a class="code" href="structCollectDelData.html#a9f4baf8d28352a26145a3eba21de3799">repo</a> = repo;
    data.<a class="code" href="structCollectDelData.html#aa12f02a8698ba507ae308d9a87a33d66">entries</a> = entries;
    data.<a class="code" href="structCollectDelData.html#a68ae2e7913cdf780efc859ec5eb218e9">truncate_time</a> = MAX (show_time, truncate_time);

    <span class="keywordflow">if</span> (!<a class="code" href="commit-mgr_8c.html#ac6547d5546781608b39446d9a2077fed">seaf_commit_manager_traverse_commit_tree</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, 
                                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>,
                                                   collect_deleted,
                                                   &amp;data,
                                                   TRUE))
    {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>,
                     <span class="stringliteral">&quot;Internal error&quot;</span>);
        g_hash_table_destroy (entries);
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="comment">/* Remove entries exist in the current commit.</span>
<span class="comment">     * This is necessary because some files may be added back after deletion.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (filter_out_existing_entries (entries, repo,
                                     repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>) == 0) {
        <span class="comment">// filter success, then add collected result to list</span>
        g_hash_table_foreach_steal (entries, hash_to_list, &amp;ret);
    }

    g_hash_table_destroy (entries);

    <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a3bd2aea3b14fe8a45243d175ef86bb61_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a3bd2aea3b14fe8a45243d175ef86bb61_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a3bd2aea3b14fe8a45243d175ef86bb61_cgraph" id="server_2repo-mgr_8h_a3bd2aea3b14fe8a45243d175ef86bb61_cgraph">
<area shape="rect" id="node3" href="server_2Backups_2repo-mgr_8c.html#a774e0a8ea59c07c94dc8014612b3f948" title="seaf_repo_manager_get_repo_truncate_time" alt="" coords="315,5,592,35"/><area shape="rect" id="node5" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6" title="seaf_repo_manager_get_repo" alt="" coords="357,59,549,88"/><area shape="rect" id="node7" href="commit-mgr_8c.html#ac6547d5546781608b39446d9a2077fed" title="seaf_commit_manager_traverse_commit_tree" alt="" coords="311,112,596,141"/><area shape="rect" id="node9" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="396,165,511,195"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a2413f0a10a33c5de4d82193c9c8b7f08"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_email_by_token" ref="a2413f0a10a33c5de4d82193c9c8b7f08" args="(SeafRepoManager *manager, const char *repo_id, const char *token)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="server_2repo-mgr_8h.html#a2413f0a10a33c5de4d82193c9c8b7f08">seaf_repo_manager_get_email_by_token</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>token</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01483">1483</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (!repo_id || !token)
        <span class="keywordflow">return</span> NULL;
    
    <span class="keywordtype">char</span> *email = NULL;
    <span class="keywordtype">char</span> *sql;

    sql = <span class="stringliteral">&quot;SELECT email FROM RepoUserToken &quot;</span>
        <span class="stringliteral">&quot;WHERE repo_id = ? AND token = ?&quot;</span>;

    <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                   get_email_by_token_cb, &amp;email,
                                   2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;string&quot;</span>, token);

    <span class="keywordflow">return</span> email;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a2413f0a10a33c5de4d82193c9c8b7f08_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a2413f0a10a33c5de4d82193c9c8b7f08_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a2413f0a10a33c5de4d82193c9c8b7f08_cgraph" id="server_2repo-mgr_8h_a2413f0a10a33c5de4d82193c9c8b7f08_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="312,32,523,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="572,5,753,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="581,59,744,88"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a2413f0a10a33c5de4d82193c9c8b7f08_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a2413f0a10a33c5de4d82193c9c8b7f08_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a2413f0a10a33c5de4d82193c9c8b7f08_icgraph" id="server_2repo-mgr_8h_a2413f0a10a33c5de4d82193c9c8b7f08_icgraph">
<area shape="rect" id="node3" href="server_2repo-mgr_8h.html#aab7412302b0f206f7717a29d86d80e0f" title="seaf_repo_manager_delete_token" alt="" coords="313,5,529,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a82d76d79aed153b9165b48e12dc2f2d0"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_group_perm_by_repo" ref="a82d76d79aed153b9165b48e12dc2f2d0" args="(SeafRepoManager *mgr, const char *repo_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a82d76d79aed153b9165b48e12dc2f2d0">seaf_repo_manager_get_group_perm_by_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02283">2283</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    GList *group_perms = NULL, *p;
    
    sql = <span class="stringliteral">&quot;SELECT group_id, permission FROM RepoGroup WHERE repo_id = ?&quot;</span>;
    
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, get_group_perms_cb,
                                       &amp;group_perms, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0) {
        <span class="keywordflow">for</span> (p = group_perms; p != NULL; p = p-&gt;next)
            g_free (p-&gt;data);
        g_list_free (group_perms);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> g_list_reverse (group_perms);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a82d76d79aed153b9165b48e12dc2f2d0_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a82d76d79aed153b9165b48e12dc2f2d0_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a82d76d79aed153b9165b48e12dc2f2d0_cgraph" id="server_2repo-mgr_8h_a82d76d79aed153b9165b48e12dc2f2d0_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="344,32,555,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="604,5,785,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="613,59,776,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a9ef2e3d497a572ee1642e6e6dc0c2977"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_group_repo_owner" ref="a9ef2e3d497a572ee1642e6e6dc0c2977" args="(SeafRepoManager *mgr, const char *repo_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="server_2repo-mgr_8h.html#a9ef2e3d497a572ee1642e6e6dc0c2977">seaf_repo_manager_get_group_repo_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02424">2424</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    <span class="keywordtype">char</span> *ret = NULL;

    sql = <span class="stringliteral">&quot;SELECT user_name FROM RepoGroup WHERE repo_id = ?&quot;</span>;
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                       get_group_repo_owner, &amp;ret,
                                       1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;DB error when get repo share from for repo %s.\n&quot;</span>,
                   repo_id);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a9ef2e3d497a572ee1642e6e6dc0c2977_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a9ef2e3d497a572ee1642e6e6dc0c2977_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a9ef2e3d497a572ee1642e6e6dc0c2977_cgraph" id="server_2repo-mgr_8h_a9ef2e3d497a572ee1642e6e6dc0c2977_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="328,32,539,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="588,5,769,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="597,59,760,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a8e5e47e57afc5432400aeac4e42494b3"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_group_repoids" ref="a8e5e47e57afc5432400aeac4e42494b3" args="(SeafRepoManager *mgr, int group_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a8e5e47e57afc5432400aeac4e42494b3">seaf_repo_manager_get_group_repoids</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>group_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02330">2330</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    GList *repo_ids = NULL;

    sql =  <span class="stringliteral">&quot;SELECT repo_id FROM RepoGroup WHERE group_id = ?&quot;</span>;
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, get_group_repoids_cb,
                                       &amp;repo_ids, 1, <span class="stringliteral">&quot;int&quot;</span>, group_id) &lt; 0)
        <span class="keywordflow">return</span> NULL;

    <span class="keywordflow">return</span> g_list_reverse (repo_ids);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a8e5e47e57afc5432400aeac4e42494b3_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a8e5e47e57afc5432400aeac4e42494b3_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a8e5e47e57afc5432400aeac4e42494b3_cgraph" id="server_2repo-mgr_8h_a8e5e47e57afc5432400aeac4e42494b3_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="304,32,515,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="564,5,745,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="573,59,736,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a9b3550e6d994e1ab95cbd65e454b8614"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_group_repos_by_owner" ref="a9b3550e6d994e1ab95cbd65e454b8614" args="(SeafRepoManager *mgr, const char *owner, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a9b3550e6d994e1ab95cbd65e454b8614">seaf_repo_manager_get_group_repos_by_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02390">2390</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    GList *repos = NULL;

    sql = <span class="stringliteral">&quot;SELECT RepoGroup.repo_id, VirtualRepo.repo_id, &quot;</span>
        <span class="stringliteral">&quot;group_id, user_name, permission, commit_id &quot;</span>
        <span class="stringliteral">&quot;FROM RepoGroup LEFT JOIN VirtualRepo ON &quot;</span>
        <span class="stringliteral">&quot;RepoGroup.repo_id = VirtualRepo.repo_id, &quot;</span>
        <span class="stringliteral">&quot;Branch &quot;</span>
        <span class="stringliteral">&quot;WHERE user_name = ? AND &quot;</span>
        <span class="stringliteral">&quot;RepoGroup.repo_id = Branch.repo_id AND &quot;</span>
        <span class="stringliteral">&quot;Branch.name = &#39;master&#39;&quot;</span>;
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, get_group_repos_cb,
                                       &amp;repos, 1, <span class="stringliteral">&quot;string&quot;</span>, owner) &lt; 0)
        <span class="keywordflow">return</span> NULL;

    <span class="keywordflow">return</span> g_list_reverse (repos);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a9b3550e6d994e1ab95cbd65e454b8614_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a9b3550e6d994e1ab95cbd65e454b8614_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a9b3550e6d994e1ab95cbd65e454b8614_cgraph" id="server_2repo-mgr_8h_a9b3550e6d994e1ab95cbd65e454b8614_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="357,32,568,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="617,5,799,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="627,59,789,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a404f7522a538d92d2ac68e49956a5a9b"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_groups_by_repo" ref="a404f7522a538d92d2ac68e49956a5a9b" args="(SeafRepoManager *mgr, const char *repo_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a404f7522a538d92d2ac68e49956a5a9b">seaf_repo_manager_get_groups_by_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02249">2249</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    GList *group_ids = NULL;
    
    sql =  <span class="stringliteral">&quot;SELECT group_id FROM RepoGroup WHERE repo_id = ?&quot;</span>;
    
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, get_group_ids_cb,
                                       &amp;group_ids, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0) {
        g_list_free (group_ids);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> g_list_reverse (group_ids);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a404f7522a538d92d2ac68e49956a5a9b_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a404f7522a538d92d2ac68e49956a5a9b_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a404f7522a538d92d2ac68e49956a5a9b_cgraph" id="server_2repo-mgr_8h_a404f7522a538d92d2ac68e49956a5a9b_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="315,32,525,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="575,5,756,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="584,59,747,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a24cf3ec157b1edc047b115b28ee8bd0c"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_inner_pub_repo_perm" ref="a24cf3ec157b1edc047b115b28ee8bd0c" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="server_2repo-mgr_8h.html#a24cf3ec157b1edc047b115b28ee8bd0c">seaf_repo_manager_get_inner_pub_repo_perm</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02623">2623</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;

    sql = <span class="stringliteral">&quot;SELECT permission FROM InnerPubRepo WHERE repo_id=?&quot;</span>;
    <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a86087185f6d613c62c740d1f58cfb574">seaf_db_statement_get_string</a>(mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a24cf3ec157b1edc047b115b28ee8bd0c_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a24cf3ec157b1edc047b115b28ee8bd0c_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a24cf3ec157b1edc047b115b28ee8bd0c_cgraph" id="server_2repo-mgr_8h_a24cf3ec157b1edc047b115b28ee8bd0c_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#a86087185f6d613c62c740d1f58cfb574" title="seaf_db_statement_get_string" alt="" coords="347,59,544,88"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="601,5,783,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="611,59,773,88"/><area shape="rect" id="node9" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c" title="seaf_db_row_get_column_text" alt="" coords="593,112,791,141"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aa30a874076b81b802de8763e30433c97"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_orphan_repo_list" ref="aa30a874076b81b802de8763e30433c97" args="(SeafRepoManager *mgr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#aa30a874076b81b802de8763e30433c97">seaf_repo_manager_get_orphan_repo_list</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01751">1751</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *id_list = NULL, *ptr;
    GList *ret = NULL;
    <span class="keywordtype">char</span> sql[256];

    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT Repo.repo_id FROM Repo LEFT JOIN &quot;</span>
              <span class="stringliteral">&quot;RepoOwner ON Repo.repo_id = RepoOwner.repo_id WHERE &quot;</span>
              <span class="stringliteral">&quot;RepoOwner.owner_id is NULL&quot;</span>);

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4">seaf_db_foreach_selected_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                      collect_repo_id, &amp;id_list) &lt; 0)
        <span class="keywordflow">return</span> NULL;

    <span class="keywordflow">for</span> (ptr = id_list; ptr; ptr = ptr-&gt;next) {
        <span class="keywordtype">char</span> *repo_id = ptr-&gt;data;
        <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
        <span class="keywordflow">if</span> (repo != NULL)
            ret = g_list_prepend (ret, repo);
    }

    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (id_list);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_aa30a874076b81b802de8763e30433c97_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_aa30a874076b81b802de8763e30433c97_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_aa30a874076b81b802de8763e30433c97_cgraph" id="server_2repo-mgr_8h_aa30a874076b81b802de8763e30433c97_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4" title="seaf_db_foreach_selected_row" alt="" coords="317,5,520,35"/><area shape="rect" id="node5" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6" title="seaf_repo_manager_get_repo" alt="" coords="323,59,515,88"/><area shape="rect" id="node7" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="365,112,472,141"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="af0276c036723560e3e8b9aa5529133d6"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo" ref="af0276c036723560e3e8b9aa5529133d6" args="(SeafRepoManager *manager, const gchar *id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a>* <a class="el" href="server_2repo-mgr_8h.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const gchar *&#160;</td>
          <td class="paramname"><em>id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04208">4208</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *res;

    <span class="keywordflow">if</span> (pthread_rwlock_rdlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;[repo mgr] failed to lock repo cache.\n&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    res = g_hash_table_lookup (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a46e78181430977b311346c02e5738286">repo_hash</a>, <span class="keywordtype">id</span>);

    pthread_rwlock_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);

    <span class="keywordflow">if</span> (res &amp;&amp; !res-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>)
        <span class="keywordflow">return</span> res;

    <span class="keywordflow">return</span> NULL;
}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_af0276c036723560e3e8b9aa5529133d6_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_af0276c036723560e3e8b9aa5529133d6_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_af0276c036723560e3e8b9aa5529133d6_icgraph" id="server_2repo-mgr_8h_af0276c036723560e3e8b9aa5529133d6_icgraph">
<area shape="rect" id="node3" href="diff-simple_8h.html#a9e9cbe6847c88fc7bca7035f45a0a50e" title="diff_commits" alt="" coords="353,59,449,88"/><area shape="rect" id="node7" href="diff-simple_8h.html#a8c800ee63c23c5ff78d838974f678e47" title="diff_merge" alt="" coords="360,5,443,35"/><area shape="rect" id="node10" href="fs-mgr_8h.html#a36b814252ae47bd595a9282266ea1b56" title="seaf_fs_manager_checkout_file" alt="" coords="299,163,504,192"/><area shape="rect" id="node14" href="daemon_2repo-mgr_8h.html#a836678a67f23541ed108f922f0848e52" title="seaf_repo_fetch_and_checkout" alt="" coords="956,137,1159,167"/><area shape="rect" id="node16" href="rpc-deprecated_8c.html#afb600f07a2183e34f31eb2fa5c783a15" title="seafile_branch_del" alt="" coords="336,216,467,245"/><area shape="rect" id="node18" href="rpc-deprecated_8c.html#af1251308e7e0c5e16435c893431f70fc" title="seafile_status" alt="" coords="351,269,452,299"/><area shape="rect" id="node20" href="seafile-rpc_8h.html#a4be3dbe527186e1687ad3c33bd4432d4" title="seafile_get_repo_pub" alt="" coords="679,347,823,376"/><area shape="rect" id="node22" href="rpc-deprecated_8c.html#a374cf49b787fef8fc91266c87cc15375" title="seafile_get_commit_list_pub" alt="" coords="657,531,844,560"/><area shape="rect" id="node24" href="seafile-rpc_8h.html#a3e4e9d217daa4c70314c43c6065a57ea" title="seafile_repo_last_modify" alt="" coords="319,373,484,403"/><area shape="rect" id="node27" href="seafile-4_81_82_2common_2rpc-service_8c.html#a37949d30db3977c8fbb573881173987b" title="seafile_get_repo" alt="" coords="692,413,809,443"/><area shape="rect" id="node29" href="seafile-rpc_8h.html#aa5af40788ef2c7bcccc071abf16acefe" title="seafile_get_repo_sync_task" alt="" coords="309,531,493,560"/><area shape="rect" id="node31" href="seafile-rpc_8h.html#a3880f357c6b6e7e350ce5a781e9668c1" title="seafile_set_repo_property" alt="" coords="665,819,836,848"/><area shape="rect" id="node33" href="seafile-rpc_8h.html#adf72ee1ff10ccd5adbb97369392835ef" title="seafile_get_repo_property" alt="" coords="316,635,487,664"/><area shape="rect" id="node35" href="seafile-rpc_8h.html#a71e6ea38c1cc19c4989505a4bed67955" title="seafile_update_repo_relay_info" alt="" coords="301,688,501,717"/><area shape="rect" id="node38" href="seafile-4_81_82_2common_2rpc-service_8c.html#a5594de7f321b08c515c465bc44e25c60" title="seafile_get_commit_list" alt="" coords="323,477,480,507"/><area shape="rect" id="node41" href="seafile-rpc_8h.html#abc5f8a72ec2fe4760591520d16828306" title="seafile_set_repo_token" alt="" coords="324,792,479,821"/><area shape="rect" id="node43" href="seafile-4_81_82_2common_2rpc-service_8c.html#a3743ba1324330f8ef0cb9a5c33a52e92" title="seafile_destroy_repo" alt="" coords="331,845,472,875"/><area shape="rect" id="node45" href="daemon_2repo-mgr_8h.html#a7fdd2ba98b2cab98aaced0e49a1685a9" title="seaf_repo_get_head_commit" alt="" coords="307,899,496,928"/><area shape="rect" id="node48" href="daemon_2repo-mgr_8h.html#a9d2f586c85f26b2de677fd03606103aa" title="seaf_repo_manager_set_repo_property" alt="" coords="279,952,524,981"/><area shape="rect" id="node57" href="fuse_2Backups_2repo-mgr_8c.html#aa692b1e331cad063425d676afe1ae121" title="seaf_repo_manager_get_repo_list" alt="" coords="293,1005,509,1035"/><area shape="rect" id="node59" href="server_2repo-mgr_8h.html#a7cf33a85dd9c77b44a83d6c8ed300948" title="seaf_repo_manager_get_repos_by_owner" alt="" coords="271,1059,532,1088"/><area shape="rect" id="node61" href="server_2repo-mgr_8h.html#aa30a874076b81b802de8763e30433c97" title="seaf_repo_manager_get_orphan_repo_list" alt="" coords="271,1112,532,1141"/><area shape="rect" id="node63" href="clone-mgr_8h.html#a6b3ef937f8308db69c87bb650cb42fe9" title="seaf_clone_manager_add_task" alt="" coords="300,1165,503,1195"/><area shape="rect" id="node67" href="clone-mgr_8h.html#ab6b5a2b4f13b382b9c7034131fa92783" title="seaf_clone_manager_add_download_task" alt="" coords="269,1219,533,1248"/><area shape="rect" id="node71" href="http-tx-mgr_8h.html#a585b7bf53556be4ced268b966dd11fd2" title="http_tx_manager_add_upload" alt="" coords="305,1272,497,1301"/><area shape="rect" id="node73" href="http-tx-mgr_8h.html#a0bd2d454a6270528980a22372d300ddb" title="http_tx_manager_add_download" alt="" coords="297,1325,505,1355"/><area shape="rect" id="node75" href="sync-mgr_8h.html#aeea02ab15ddf4c48dd3227f30b791f37" title="seaf_sync_manager_add_sync_task" alt="" coords="284,1379,519,1408"/><area shape="rect" id="node79" href="transfer-mgr_8h.html#a084f2ccd845f2ff514aa3fd6a4a7b697" title="seaf_transfer_manager_add_upload" alt="" coords="288,1432,515,1461"/><area shape="rect" id="node81" href="server_2repo-mgr_8h.html#ab10ffbf8777e16cc18e78a263d7fbb1c" title="seaf_repo_manager_list_file_revisions" alt="" coords="280,1509,523,1539"/><area shape="rect" id="node84" href="server_2repo-mgr_8h.html#ad00a42c20e1baadf267215e7e683f9e4" title="seaf_repo_manager_calc_files_last_modified" alt="" coords="260,1563,543,1592"/><area shape="rect" id="node86" href="server_2repo-mgr_8h.html#a75071fddf41a1371d4f89be8d2b59b88" title="seaf_repo_manager_revert_on_server" alt="" coords="281,1616,521,1645"/><area shape="rect" id="node88" href="server_2repo-mgr_8h.html#a3bd2aea3b14fe8a45243d175ef86bb61" title="seaf_repo_manager_get_deleted_entries" alt="" coords="273,1669,529,1699"/><area shape="rect" id="node90" href="passwd-mgr_8h.html#aa869fc42cc145aacb31da546c5b60ddb" title="seaf_passwd_manager_check_passwd" alt="" coords="276,1723,527,1752"/><area shape="rect" id="node92" href="passwd-mgr_8h.html#a423fa6bdd74869a9d46a706ecd7790da" title="seaf_passwd_manager_set_passwd" alt="" coords="285,1776,517,1805"/><area shape="rect" id="node94" href="virtual-repo_8c.html#a9a8dcda29ee6cd28d92c1897ad12f268" title="seaf_repo_manager_create_virtual_repo" alt="" coords="275,1829,528,1859"/><area shape="rect" id="node96" href="virtual-repo_8c.html#a89c9b19ae91ea15fe9aa684c5509d4ec" title="seaf_repo_manager_get_virtual_repos_by_owner" alt="" coords="249,1883,553,1912"/><area shape="rect" id="node98" href="virtual-repo_8c.html#a1cd4a8c70076d40d2a778dda774a2263" title="seaf_repo_manager_cleanup_virtual_repos" alt="" coords="267,1936,536,1965"/><area shape="rect" id="node5" href="server_2repo-mgr_8h.html#a168ba33665e04b18089dd5a5d2a18fe3" title="seaf_repo_diff" alt="" coords="699,32,803,61"/><area shape="rect" id="node12" href="daemon_2Backups_2repo-mgr_8c.html#a450e5bcc50da4c40b7ba2bde33a22a84" title="checkout_file" alt="" coords="701,163,800,192"/><area shape="rect" id="node51" href="daemon_2repo-mgr_8h.html#a6ed05df6501a326fc58a0fefb91aef3d" title="seaf_repo_manager_set_repo_worktree" alt="" coords="625,979,876,1008"/><area shape="rect" id="node53" href="daemon_2repo-mgr_8h.html#ae3753999b4845dfe68bd6f098313280c" title="seaf_repo_manager_update_repos_server_host" alt="" coords="603,925,899,955"/><area shape="rect" id="node55" href="seafile-rpc_8h.html#a2d3ae7fdb45f784fe4eb4abc2f4055c2" title="seafile_update_repos_server_host" alt="" coords="948,925,1167,955"/><area shape="rect" id="node65" href="seafile-rpc_8h.html#aca75772f76f8eafb2b08a023cd476f65" title="seafile_clone" alt="" coords="701,1165,800,1195"/><area shape="rect" id="node69" href="seafile-rpc_8h.html#a704ca859f1a1f7044c27b27982658672" title="seafile_download" alt="" coords="689,1219,812,1248"/><area shape="rect" id="node77" href="seafile-rpc_8h.html#a69a68f15746004a2a844c35c7d305b22" title="seafile_sync" alt="" coords="704,1379,797,1408"/><area shape="rect" id="node100" href="server_2repo-mgr_8h.html#ad6564c23b0e50d8a34dd425432b80db4" title="seaf_repo_manager_del_file" alt="" coords="659,1936,843,1965"/><area shape="rect" id="node102" href="server_2repo-mgr_8h.html#a056b45d63edfafbc5287012a2a1062ec" title="seaf_repo_manager_move_file" alt="" coords="959,1911,1156,1940"/><area shape="rect" id="node105" href="server_2repo-mgr_8h.html#ae68e4b6427bb239b697e515c8617cbfb" title="seaf_repo_manager_rename_file" alt="" coords="645,1989,856,2019"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a11cc1a4ecd45778ea5a10af0cb72b347"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo_ex" ref="a11cc1a4ecd45778ea5a10af0cb72b347" args="(SeafRepoManager *manager, const gchar *id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a>* <a class="el" href="server_2repo-mgr_8h.html#a11cc1a4ecd45778ea5a10af0cb72b347">seaf_repo_manager_get_repo_ex</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const gchar *&#160;</td>
          <td class="paramname"><em>id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l00524">524</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> len = strlen(<span class="keywordtype">id</span>);
    gboolean db_err = FALSE, exists;
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *ret = NULL;

    <span class="keywordflow">if</span> (len &gt;= 37)
        <span class="keywordflow">return</span> NULL;

    exists = repo_exists_in_db (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="keywordtype">id</span>, &amp;db_err);

    <span class="keywordflow">if</span> (db_err) {
        ret = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a63ab9fe4694e3d967376c911cbe2c655">seaf_repo_new</a>(<span class="keywordtype">id</span>, NULL, NULL);
        ret-&gt;<a class="code" href="struct__SeafRepo.html#a30acbbe15ec4e36a8b3bb31581c333e5">is_corrupted</a> = TRUE;
        <span class="keywordflow">return</span> ret;
    }

    <span class="keywordflow">if</span> (exists) {
        ret = load_repo (manager, <span class="keywordtype">id</span>, TRUE);
        <span class="keywordflow">return</span> ret;
    }

    <span class="keywordflow">return</span> NULL;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a11cc1a4ecd45778ea5a10af0cb72b347_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a11cc1a4ecd45778ea5a10af0cb72b347_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a11cc1a4ecd45778ea5a10af0cb72b347_cgraph" id="server_2repo-mgr_8h_a11cc1a4ecd45778ea5a10af0cb72b347_cgraph">
<area shape="rect" id="node3" href="daemon_2Backups_2repo-mgr_8c.html#a63ab9fe4694e3d967376c911cbe2c655" title="seaf_repo_new" alt="" coords="271,5,380,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a11cc1a4ecd45778ea5a10af0cb72b347_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a11cc1a4ecd45778ea5a10af0cb72b347_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a11cc1a4ecd45778ea5a10af0cb72b347_icgraph" id="server_2repo-mgr_8h_a11cc1a4ecd45778ea5a10af0cb72b347_icgraph">
<area shape="rect" id="node3" href="server_2Backups_2repo-mgr_8c.html#aa692b1e331cad063425d676afe1ae121" title="seaf_repo_manager_get_repo_list" alt="" coords="271,5,487,35"/><area shape="rect" id="node5" href="server_2gc_2gc-core_8h.html#ab1ddc08d785efb15290a677e8e152c18" title="gc_core_run" alt="" coords="332,59,425,88"/><area shape="rect" id="node7" href="verify_8h.html#ac9054d2eed9bb3a221b531f65b5cf0f5" title="verify_repos" alt="" coords="332,112,425,141"/><area shape="rect" id="node9" href="seafserv-gc_8c.html#a0ddf1224851353fc92bfbff6f499fa97" title="main" alt="" coords="536,112,587,141"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a0f63ca499435a0d01f03c8c3a2d86c44"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo_history_limit" ref="a0f63ca499435a0d01f03c8c3a2d86c44" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a0f63ca499435a0d01f03c8c3a2d86c44">seaf_repo_manager_get_repo_history_limit</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01576">1576</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="structSeafVirtRepo.html">SeafVirtRepo</a> *vinfo;
    <span class="keyword">const</span> <span class="keywordtype">char</span> *r_repo_id = repo_id;
    <span class="keywordtype">char</span> *sql;
    <span class="keywordtype">int</span> per_repo_days;

    vinfo = <a class="code" href="server_2gc_2Backups_2repo-mgr_8c.html#a316db228b35dde3dc88ae9dab9ec9c22">seaf_repo_manager_get_virtual_repo_info</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (vinfo)
        r_repo_id = vinfo-&gt;<a class="code" href="structSeafVirtRepo.html#a23bc0205036c7a0c807c4f89145794b1">origin_repo_id</a>;

    sql = <span class="stringliteral">&quot;SELECT days FROM RepoHistoryLimit WHERE repo_id=?&quot;</span>;
    per_repo_days = <a class="code" href="seaf-db_8c.html#a69eb3d0620dabc0731b9e00ce06d1a3e">seaf_db_statement_get_int</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                               1, <span class="stringliteral">&quot;string&quot;</span>, r_repo_id);

    <a class="code" href="server_2gc_2Backups_2repo-mgr_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a">seaf_virtual_repo_info_free</a> (vinfo);

    <span class="comment">/* If per repo value is not set or DB error, return the global one. */</span>
    <span class="keywordflow">if</span> (per_repo_days &lt; 0)
        <span class="keywordflow">return</span> mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ad1d597138a7b676e94cd273a4a446776">keep_history_days</a>;

    <span class="keywordflow">return</span> per_repo_days;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a0f63ca499435a0d01f03c8c3a2d86c44_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a0f63ca499435a0d01f03c8c3a2d86c44_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a0f63ca499435a0d01f03c8c3a2d86c44_cgraph" id="server_2repo-mgr_8h_a0f63ca499435a0d01f03c8c3a2d86c44_cgraph">
<area shape="rect" id="node3" href="server_2gc_2Backups_2repo-mgr_8c.html#a316db228b35dde3dc88ae9dab9ec9c22" title="seaf_repo_manager_get_virtual_repo_info" alt="" coords="327,5,588,35"/><area shape="rect" id="node5" href="seaf-db_8c.html#a69eb3d0620dabc0731b9e00ce06d1a3e" title="seaf_db_statement_get_int" alt="" coords="368,59,547,88"/><area shape="rect" id="node13" href="server_2gc_2Backups_2repo-mgr_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a" title="seaf_virtual_repo_info_free" alt="" coords="368,112,547,141"/><area shape="rect" id="node15" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4" title="seaf_db_foreach_selected_row" alt="" coords="356,165,559,195"/><area shape="rect" id="node7" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="643,5,824,35"/><area shape="rect" id="node9" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="652,59,815,88"/><area shape="rect" id="node11" href="seaf-db_8c.html#a1a5b664c767155460f4f61cc7602f6f7" title="seaf_db_row_get_column_int" alt="" coords="639,112,828,141"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a0f63ca499435a0d01f03c8c3a2d86c44_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a0f63ca499435a0d01f03c8c3a2d86c44_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a0f63ca499435a0d01f03c8c3a2d86c44_icgraph" id="server_2repo-mgr_8h_a0f63ca499435a0d01f03c8c3a2d86c44_icgraph">
<area shape="rect" id="node3" href="server_2repo-mgr_8h.html#a774e0a8ea59c07c94dc8014612b3f948" title="seaf_repo_manager_get_repo_truncate_time" alt="" coords="327,83,604,112"/><area shape="rect" id="node5" href="seafile-4_81_82_2common_2rpc-service_8c.html#a5594de7f321b08c515c465bc44e25c60" title="seafile_get_commit_list" alt="" coords="703,5,860,35"/><area shape="rect" id="node9" href="server_2repo-mgr_8h.html#ab10ffbf8777e16cc18e78a263d7fbb1c" title="seaf_repo_manager_list_file_revisions" alt="" coords="660,83,903,112"/><area shape="rect" id="node12" href="server_2repo-mgr_8h.html#a3bd2aea3b14fe8a45243d175ef86bb61" title="seaf_repo_manager_get_deleted_entries" alt="" coords="653,136,909,165"/><area shape="rect" id="node7" href="rpc-deprecated_8c.html#a374cf49b787fef8fc91266c87cc15375" title="seafile_get_commit_list_pub" alt="" coords="957,5,1144,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a928ca86df93e60744ca6edacb33a386f"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo_id_list" ref="a928ca86df93e60744ca6edacb33a386f" args="(SeafRepoManager *mgr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a928ca86df93e60744ca6edacb33a386f">seaf_repo_manager_get_repo_id_list</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="fuse_2Backups_2repo-mgr_8c_source.html#l00350">350</a> of file <a class="el" href="fuse_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *ret = NULL;
    <span class="keywordtype">char</span> sql[256];

    snprintf (sql, 256, <span class="stringliteral">&quot;SELECT repo_id FROM Repo&quot;</span>);

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4">seaf_db_foreach_selected_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 
                                      collect_repo_id, &amp;ret) &lt; 0)
        <span class="keywordflow">return</span> NULL;

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a928ca86df93e60744ca6edacb33a386f_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a928ca86df93e60744ca6edacb33a386f_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a928ca86df93e60744ca6edacb33a386f_cgraph" id="server_2repo-mgr_8h_a928ca86df93e60744ca6edacb33a386f_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4" title="seaf_db_foreach_selected_row" alt="" coords="288,5,491,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a928ca86df93e60744ca6edacb33a386f_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a928ca86df93e60744ca6edacb33a386f_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a928ca86df93e60744ca6edacb33a386f_icgraph" id="server_2repo-mgr_8h_a928ca86df93e60744ca6edacb33a386f_icgraph">
<area shape="rect" id="node3" href="server_2gc_2gc-core_8h.html#ab1ddc08d785efb15290a677e8e152c18" title="gc_core_run" alt="" coords="288,5,381,35"/><area shape="rect" id="node5" href="fsck_8h.html#a8f0e50f00d3c3c41d43e3f714d7425dd" title="seaf_fsck" alt="" coords="296,59,373,88"/><area shape="rect" id="node9" href="verify_8h.html#ac9054d2eed9bb3a221b531f65b5cf0f5" title="verify_repos" alt="" coords="288,112,381,141"/><area shape="rect" id="node7" href="seaf-fsck_8c.html#a0ddf1224851353fc92bfbff6f499fa97" title="main" alt="" coords="429,59,480,88"/><area shape="rect" id="node11" href="seafserv-gc_8c.html#a0ddf1224851353fc92bfbff6f499fa97" title="main" alt="" coords="429,112,480,141"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a6a2b07102342d3acc5722e059635aacb"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo_ids_by_owner" ref="a6a2b07102342d3acc5722e059635aacb" args="(SeafRepoManager *mgr, const char *email)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a6a2b07102342d3acc5722e059635aacb">seaf_repo_manager_get_repo_ids_by_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>email</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01855">1855</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *ret = NULL;
    <span class="keywordtype">char</span> *sql;

    sql = <span class="stringliteral">&quot;SELECT repo_id FROM RepoOwner WHERE owner_id=?&quot;</span>;

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 
                                       collect_repo_id, &amp;ret,
                                       1, <span class="stringliteral">&quot;string&quot;</span>, email) &lt; 0) {
        <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (ret);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a6a2b07102342d3acc5722e059635aacb_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a6a2b07102342d3acc5722e059635aacb_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a6a2b07102342d3acc5722e059635aacb_cgraph" id="server_2repo-mgr_8h_a6a2b07102342d3acc5722e059635aacb_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="333,32,544,61"/><area shape="rect" id="node9" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="385,85,492,115"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="593,5,775,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="603,59,765,88"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a6a2b07102342d3acc5722e059635aacb_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a6a2b07102342d3acc5722e059635aacb_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a6a2b07102342d3acc5722e059635aacb_icgraph" id="server_2repo-mgr_8h_a6a2b07102342d3acc5722e059635aacb_icgraph">
<area shape="rect" id="node3" href="quota-mgr_8h.html#a12e60fee869eff11295588d7565ea677" title="seaf_quota_manager_get_user_share_usage" alt="" coords="335,5,615,35"/><area shape="rect" id="node5" href="quota-mgr_8h.html#ae10caa81f529a80e3729b9a050666302" title="seaf_quota_manager_check_quota" alt="" coords="664,5,888,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aa692b1e331cad063425d676afe1ae121"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo_list" ref="aa692b1e331cad063425d676afe1ae121" args="(SeafRepoManager *mgr, int start, int limit)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#aa692b1e331cad063425d676afe1ae121">seaf_repo_manager_get_repo_list</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>start</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>limit</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l05161">5161</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *repo_list = NULL;
    GHashTableIter iter;
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
    gpointer key, value;

    <span class="keywordflow">if</span> (pthread_rwlock_rdlock (&amp;manager-&gt;priv-&gt;lock) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;[repo mgr] failed to lock repo cache.\n&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }
    g_hash_table_iter_init (&amp;iter, manager-&gt;priv-&gt;repo_hash);

    <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
        repo = value;
        <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>)
            repo_list = g_list_prepend (repo_list, repo);
    }

    pthread_rwlock_unlock (&amp;manager-&gt;priv-&gt;lock);

    <span class="keywordflow">return</span> repo_list;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_aa692b1e331cad063425d676afe1ae121_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_aa692b1e331cad063425d676afe1ae121_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_aa692b1e331cad063425d676afe1ae121_cgraph" id="server_2repo-mgr_8h_aa692b1e331cad063425d676afe1ae121_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4" title="seaf_db_foreach_selected_row" alt="" coords="279,5,481,35"/><area shape="rect" id="node5" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6" title="seaf_repo_manager_get_repo" alt="" coords="284,59,476,88"/><area shape="rect" id="node7" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="327,112,433,141"/><area shape="rect" id="node9" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="275,165,485,195"/><area shape="rect" id="node15" href="server_2Backups_2repo-mgr_8c.html#a11cc1a4ecd45778ea5a10af0cb72b347" title="seaf_repo_manager_get_repo_ex" alt="" coords="273,219,487,248"/><area shape="rect" id="node11" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="537,139,719,168"/><area shape="rect" id="node13" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="547,192,709,221"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_aa692b1e331cad063425d676afe1ae121_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_aa692b1e331cad063425d676afe1ae121_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_aa692b1e331cad063425d676afe1ae121_icgraph" id="server_2repo-mgr_8h_aa692b1e331cad063425d676afe1ae121_icgraph">
<area shape="rect" id="node3" href="seafile-rpc_8h.html#a44c13248d230153c03d45590ab434a9c" title="seafile_get_repo_list_pub" alt="" coords="336,5,504,35"/><area shape="rect" id="node5" href="seafile-rpc_8h.html#aba4837db052d18cd952ad53e10ebd379" title="seafile_get_repo_list" alt="" coords="349,59,491,88"/><area shape="rect" id="node7" href="seafile-rpc_8h.html#adb655a9a19eca34297b5c71d125cde24" title="seafile_unsync_repos_by_account" alt="" coords="309,112,531,141"/><area shape="rect" id="node9" href="seafile-rpc_8h.html#a21c3244c53c1bd6caa5f0cfb23617bc6" title="seafile_remove_repo_tokens_by_account" alt="" coords="289,165,551,195"/><area shape="rect" id="node11" href="daemon_2repo-mgr_8h.html#aaca4b8f68d91db58fc8e1484d9695ce6" title="seaf_repo_manager_update_repo_relay_info" alt="" coords="281,219,559,248"/><area shape="rect" id="node15" href="daemon_2repo-mgr_8h.html#ae3753999b4845dfe68bd6f098313280c" title="seaf_repo_manager_update_repos_server_host" alt="" coords="272,272,568,301"/><area shape="rect" id="node19" href="client-migrate_8h.html#abf80a8325d6c9ee326125f5df7dd0aa0" title="migrate_client_v0_repos" alt="" coords="339,325,501,355"/><area shape="rect" id="node21" href="clone-mgr_8h.html#a45fe95b1bbe19ee533a8f9e57884658e" title="seaf_clone_manager_check_worktree_path" alt="" coords="284,379,556,408"/><area shape="rect" id="node29" href="daemon_2gc-core_8h.html#aba2eeeb61b0f8fe34dfbdc8fc23067b3" title="gc_core_run" alt="" coords="373,432,467,461"/><area shape="rect" id="node13" href="seafile-rpc_8h.html#a71e6ea38c1cc19c4989505a4bed67955" title="seafile_update_repo_relay_info" alt="" coords="627,219,827,248"/><area shape="rect" id="node17" href="seafile-rpc_8h.html#a2d3ae7fdb45f784fe4eb4abc2f4055c2" title="seafile_update_repos_server_host" alt="" coords="617,272,836,301"/><area shape="rect" id="node23" href="seafile-rpc_8h.html#a80c8591afe413de060923bf01abf2bf1" title="seafile_check_path_for_clone" alt="" coords="629,325,824,355"/><area shape="rect" id="node25" href="clone-mgr_8h.html#a6b3ef937f8308db69c87bb650cb42fe9" title="seaf_clone_manager_add_task" alt="" coords="625,379,828,408"/><area shape="rect" id="node27" href="seafile-rpc_8h.html#aca75772f76f8eafb2b08a023cd476f65" title="seafile_clone" alt="" coords="885,379,984,408"/><area shape="rect" id="node31" href="seafserv-gc_8c.html#a0ddf1224851353fc92bfbff6f499fa97" title="main" alt="" coords="701,432,752,461"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="af227a31082c71908bf0a0ac35cfeb294"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo_owner" ref="af227a31082c71908bf0a0ac35cfeb294" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="server_2repo-mgr_8h.html#af227a31082c71908bf0a0ac35cfeb294">seaf_repo_manager_get_repo_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01721">1721</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    <span class="keywordtype">char</span> *ret = NULL;

    sql = <span class="stringliteral">&quot;SELECT owner_id FROM RepoOwner WHERE repo_id=?&quot;</span>;
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                       get_owner, &amp;ret,
                                       1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;Failed to get owner id for repo %s.\n&quot;</span>, repo_id);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_af227a31082c71908bf0a0ac35cfeb294_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_af227a31082c71908bf0a0ac35cfeb294_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_af227a31082c71908bf0a0ac35cfeb294_cgraph" id="server_2repo-mgr_8h_af227a31082c71908bf0a0ac35cfeb294_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="288,32,499,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="548,5,729,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="557,59,720,88"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_af227a31082c71908bf0a0ac35cfeb294_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_af227a31082c71908bf0a0ac35cfeb294_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_af227a31082c71908bf0a0ac35cfeb294_icgraph" id="server_2repo-mgr_8h_af227a31082c71908bf0a0ac35cfeb294_icgraph">
<area shape="rect" id="node3" href="quota-mgr_8h.html#ae10caa81f529a80e3729b9a050666302" title="seaf_quota_manager_check_quota" alt="" coords="303,5,527,35"/><area shape="rect" id="node5" href="repo-perm_8c.html#a6a318e5a5bcb0d46286030040ab6e23b" title="seaf_repo_manager_check_permission" alt="" coords="291,59,539,88"/><area shape="rect" id="node7" href="virtual-repo_8c.html#a9a8dcda29ee6cd28d92c1897ad12f268" title="seaf_repo_manager_create_virtual_repo" alt="" coords="288,112,541,141"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ae37e80051d587e921a003fc06c21d540"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo_size" ref="ae37e80051d587e921a003fc06c21d540" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gint64 <a class="el" href="server_2repo-mgr_8h.html#ae37e80051d587e921a003fc06c21d540">seaf_repo_manager_get_repo_size</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01514">1514</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    gint64 <a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a> = 0;
    <span class="keywordtype">char</span> *sql;

    sql = <span class="stringliteral">&quot;SELECT size FROM RepoSize WHERE repo_id=?&quot;</span>;

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                       get_repo_size, &amp;size,
                                       1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0)
        <span class="keywordflow">return</span> -1;

    <span class="keywordflow">return</span> <a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a>;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_ae37e80051d587e921a003fc06c21d540_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_ae37e80051d587e921a003fc06c21d540_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_ae37e80051d587e921a003fc06c21d540_cgraph" id="server_2repo-mgr_8h_ae37e80051d587e921a003fc06c21d540_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="277,32,488,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="537,5,719,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="547,59,709,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a774e0a8ea59c07c94dc8014612b3f948"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo_truncate_time" ref="a774e0a8ea59c07c94dc8014612b3f948" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gint64 <a class="el" href="server_2repo-mgr_8h.html#a774e0a8ea59c07c94dc8014612b3f948">seaf_repo_manager_get_repo_truncate_time</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01652">1652</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> days;
    gint64 timestamp;

    days = <a class="code" href="server_2Backups_2repo-mgr_8c.html#a0f63ca499435a0d01f03c8c3a2d86c44">seaf_repo_manager_get_repo_history_limit</a> (mgr, repo_id);
    timestamp = <a class="code" href="server_2Backups_2repo-mgr_8c.html#aa8aafa2da81a00419443a068fe98958b">seaf_repo_manager_get_repo_valid_since</a> (mgr, repo_id);

    gint64 now = (gint64)time(NULL);
    <span class="keywordflow">if</span> (days &gt; 0)
        <span class="keywordflow">return</span> MAX (now - days * 24 * 3600, timestamp);
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (days &lt; 0)
        <span class="keywordflow">return</span> timestamp;
    <span class="keywordflow">else</span>
        <span class="keywordflow">return</span> 0;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a774e0a8ea59c07c94dc8014612b3f948_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a774e0a8ea59c07c94dc8014612b3f948_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a774e0a8ea59c07c94dc8014612b3f948_cgraph" id="server_2repo-mgr_8h_a774e0a8ea59c07c94dc8014612b3f948_cgraph">
<area shape="rect" id="node3" href="server_2Backups_2repo-mgr_8c.html#a0f63ca499435a0d01f03c8c3a2d86c44" title="seaf_repo_manager_get_repo_history_limit" alt="" coords="335,5,604,35"/><area shape="rect" id="node5" href="server_2Backups_2repo-mgr_8c.html#aa8aafa2da81a00419443a068fe98958b" title="seaf_repo_manager_get_repo_valid_since" alt="" coords="337,59,601,88"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a774e0a8ea59c07c94dc8014612b3f948_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a774e0a8ea59c07c94dc8014612b3f948_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a774e0a8ea59c07c94dc8014612b3f948_icgraph" id="server_2repo-mgr_8h_a774e0a8ea59c07c94dc8014612b3f948_icgraph">
<area shape="rect" id="node3" href="seafile-4_81_82_2common_2rpc-service_8c.html#a5594de7f321b08c515c465bc44e25c60" title="seafile_get_commit_list" alt="" coords="383,5,540,35"/><area shape="rect" id="node7" href="server_2repo-mgr_8h.html#ab10ffbf8777e16cc18e78a263d7fbb1c" title="seaf_repo_manager_list_file_revisions" alt="" coords="340,83,583,112"/><area shape="rect" id="node10" href="server_2repo-mgr_8h.html#a3bd2aea3b14fe8a45243d175ef86bb61" title="seaf_repo_manager_get_deleted_entries" alt="" coords="333,136,589,165"/><area shape="rect" id="node5" href="rpc-deprecated_8c.html#a374cf49b787fef8fc91266c87cc15375" title="seafile_get_commit_list_pub" alt="" coords="637,5,824,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aa8aafa2da81a00419443a068fe98958b"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo_valid_since" ref="aa8aafa2da81a00419443a068fe98958b" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gint64 <a class="el" href="server_2repo-mgr_8h.html#aa8aafa2da81a00419443a068fe98958b">seaf_repo_manager_get_repo_valid_since</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01641">1641</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;

    sql = <span class="stringliteral">&quot;SELECT timestamp FROM RepoValidSince WHERE repo_id=?&quot;</span>;
    <span class="comment">/* Also return -1 if doesn&#39;t exist. */</span>
    <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a148dee5d529525afa53d208d2f9d4b86">seaf_db_statement_get_int64</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_aa8aafa2da81a00419443a068fe98958b_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_aa8aafa2da81a00419443a068fe98958b_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_aa8aafa2da81a00419443a068fe98958b_cgraph" id="server_2repo-mgr_8h_aa8aafa2da81a00419443a068fe98958b_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#a148dee5d529525afa53d208d2f9d4b86" title="seaf_db_statement_get_int64" alt="" coords="321,59,513,88"/><area shape="rect" id="node11" href="seaf-db_8c.html#a401edd7e7937648d96ffb06486097020" title="seaf_db_get_int64" alt="" coords="353,112,481,141"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="575,5,756,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="584,59,747,88"/><area shape="rect" id="node9" href="seaf-db_8c.html#ac9d9437b19d33c23ce45ec6b1f4d8a05" title="seaf_db_row_get_column_int64" alt="" coords="563,112,768,141"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_aa8aafa2da81a00419443a068fe98958b_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_aa8aafa2da81a00419443a068fe98958b_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_aa8aafa2da81a00419443a068fe98958b_icgraph" id="server_2repo-mgr_8h_aa8aafa2da81a00419443a068fe98958b_icgraph">
<area shape="rect" id="node3" href="server_2repo-mgr_8h.html#a774e0a8ea59c07c94dc8014612b3f948" title="seaf_repo_manager_get_repo_truncate_time" alt="" coords="321,83,599,112"/><area shape="rect" id="node5" href="seafile-4_81_82_2common_2rpc-service_8c.html#a5594de7f321b08c515c465bc44e25c60" title="seafile_get_commit_list" alt="" coords="697,5,855,35"/><area shape="rect" id="node9" href="server_2repo-mgr_8h.html#ab10ffbf8777e16cc18e78a263d7fbb1c" title="seaf_repo_manager_list_file_revisions" alt="" coords="655,83,897,112"/><area shape="rect" id="node12" href="server_2repo-mgr_8h.html#a3bd2aea3b14fe8a45243d175ef86bb61" title="seaf_repo_manager_get_deleted_entries" alt="" coords="648,136,904,165"/><area shape="rect" id="node7" href="rpc-deprecated_8c.html#a374cf49b787fef8fc91266c87cc15375" title="seafile_get_commit_list_pub" alt="" coords="952,5,1139,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a7cf33a85dd9c77b44a83d6c8ed300948"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repos_by_owner" ref="a7cf33a85dd9c77b44a83d6c8ed300948" args="(SeafRepoManager *mgr, const char *email)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a7cf33a85dd9c77b44a83d6c8ed300948">seaf_repo_manager_get_repos_by_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>email</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="fuse_2Backups_2repo-mgr_8c_source.html#l00393">393</a> of file <a class="el" href="fuse_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *id_list = NULL, *ptr;
    GList *ret = NULL;
    <span class="keywordtype">char</span> sql[256];

    snprintf (sql, 256, <span class="stringliteral">&quot;SELECT repo_id FROM RepoOwner WHERE owner_id=&#39;%s&#39;&quot;</span>,
              email);

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4">seaf_db_foreach_selected_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 
                                      collect_repo_id, &amp;id_list) &lt; 0)
        <span class="keywordflow">return</span> NULL;

    <span class="keywordflow">for</span> (ptr = id_list; ptr; ptr = ptr-&gt;next) {
        <span class="keywordtype">char</span> *repo_id = ptr-&gt;data;
        <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
        <span class="keywordflow">if</span> (repo != NULL)
            ret = g_list_prepend (ret, repo);
    }

    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (id_list);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a7cf33a85dd9c77b44a83d6c8ed300948_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a7cf33a85dd9c77b44a83d6c8ed300948_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a7cf33a85dd9c77b44a83d6c8ed300948_cgraph" id="server_2repo-mgr_8h_a7cf33a85dd9c77b44a83d6c8ed300948_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4" title="seaf_db_foreach_selected_row" alt="" coords="321,5,524,35"/><area shape="rect" id="node5" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6" title="seaf_repo_manager_get_repo" alt="" coords="327,59,519,88"/><area shape="rect" id="node7" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="369,112,476,141"/><area shape="rect" id="node9" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="317,165,528,195"/><area shape="rect" id="node11" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="577,139,759,168"/><area shape="rect" id="node13" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="587,192,749,221"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a8fec30cb36491cb94d968df3ce06d5d7"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_trash_repo_list" ref="a8fec30cb36491cb94d968df3ce06d5d7" args="(SeafRepoManager *mgr, int start, int limit, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a8fec30cb36491cb94d968df3ce06d5d7">seaf_repo_manager_get_trash_repo_list</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>start</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>limit</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01908">1908</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *trash_repos = NULL;
    <span class="keywordtype">int</span> rc;

    <span class="keywordflow">if</span> (start == -1 &amp;&amp; limit == -1)
        rc = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                            <span class="stringliteral">&quot;SELECT repo_id, repo_name, head_id, owner_id, &quot;</span>
                                            <span class="stringliteral">&quot;size FROM RepoTrash&quot;</span>,
                                            collect_trash_repo, &amp;trash_repos,
                                            0);
    <span class="keywordflow">else</span>
        rc = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                            <span class="stringliteral">&quot;SELECT repo_id, repo_name, head_id, owner_id, &quot;</span>
                                            <span class="stringliteral">&quot;size FROM RepoTrash &quot;</span>
                                            <span class="stringliteral">&quot;ORDER BY repo_id LIMIT ? OFFSET ?&quot;</span>,
                                            collect_trash_repo, &amp;trash_repos,
                                            2, <span class="stringliteral">&quot;int&quot;</span>, limit, <span class="stringliteral">&quot;int&quot;</span>, start);

    <span class="keywordflow">if</span> (rc &lt; 0) {
        <span class="keywordflow">while</span> (trash_repos) {
            g_object_unref (trash_repos-&gt;data);
            trash_repos = g_list_delete_link (trash_repos, trash_repos);
        }
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to get trashed repo from db.&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> trash_repos;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a8fec30cb36491cb94d968df3ce06d5d7_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a8fec30cb36491cb94d968df3ce06d5d7_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a8fec30cb36491cb94d968df3ce06d5d7_cgraph" id="server_2repo-mgr_8h_a8fec30cb36491cb94d968df3ce06d5d7_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="307,32,517,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="567,5,748,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="576,59,739,88"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a8fec30cb36491cb94d968df3ce06d5d7_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a8fec30cb36491cb94d968df3ce06d5d7_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a8fec30cb36491cb94d968df3ce06d5d7_icgraph" id="server_2repo-mgr_8h_a8fec30cb36491cb94d968df3ce06d5d7_icgraph">
<area shape="rect" id="node3" href="server_2repo-mgr_8h.html#a47fd08ad688d035ae95e11545bb0a68b" title="seaf_repo_manager_empty_repo_trash" alt="" coords="308,5,553,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a507c39fec59f1a4672a0cdd5493c6887"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_trash_repos_by_owner" ref="a507c39fec59f1a4672a0cdd5493c6887" args="(SeafRepoManager *mgr, const char *owner, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a507c39fec59f1a4672a0cdd5493c6887">seaf_repo_manager_get_trash_repos_by_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01944">1944</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *trash_repos = NULL;
    <span class="keywordtype">int</span> rc;

    rc = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                        <span class="stringliteral">&quot;SELECT repo_id, repo_name, head_id, owner_id, &quot;</span>
                                        <span class="stringliteral">&quot;size FROM RepoTrash WHERE owner_id = ?&quot;</span>,
                                        collect_trash_repo, &amp;trash_repos,
                                        1, <span class="stringliteral">&quot;string&quot;</span>, owner);

    <span class="keywordflow">if</span> (rc &lt; 0) {
        <span class="keywordflow">while</span> (trash_repos) {
            g_object_unref (trash_repos-&gt;data);
            trash_repos = g_list_delete_link (trash_repos, trash_repos);
        }
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to get trashed repo from db.&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> trash_repos;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a507c39fec59f1a4672a0cdd5493c6887_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a507c39fec59f1a4672a0cdd5493c6887_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a507c39fec59f1a4672a0cdd5493c6887_cgraph" id="server_2repo-mgr_8h_a507c39fec59f1a4672a0cdd5493c6887_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="352,32,563,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="612,5,793,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="621,59,784,88"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a507c39fec59f1a4672a0cdd5493c6887_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a507c39fec59f1a4672a0cdd5493c6887_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a507c39fec59f1a4672a0cdd5493c6887_icgraph" id="server_2repo-mgr_8h_a507c39fec59f1a4672a0cdd5493c6887_icgraph">
<area shape="rect" id="node3" href="server_2repo-mgr_8h.html#a99f0a8fafd75a617d03ea745d36df9be" title="seaf_repo_manager_empty_repo_trash_by_owner" alt="" coords="353,5,663,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a5e7e933b737fca2ccdb657124812fc90"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_virtual_info_by_origin" ref="a5e7e933b737fca2ccdb657124812fc90" args="(SeafRepoManager *mgr, const char *origin_repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="virtual-repo_8c.html#a5e7e933b737fca2ccdb657124812fc90">seaf_repo_manager_get_virtual_info_by_origin</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>origin_repo</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="virtual-repo_8c_source.html#l00457">457</a> of file <a class="el" href="virtual-repo_8c_source.html">virtual-repo.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *ret = NULL;
    <span class="keywordtype">char</span> *sql;

    sql = <span class="stringliteral">&quot;SELECT repo_id, origin_repo, path, base_commit &quot;</span>
        <span class="stringliteral">&quot;FROM VirtualRepo WHERE origin_repo=?&quot;</span>;
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 
                                       collect_virtual_info, &amp;ret,
                                       1, <span class="stringliteral">&quot;string&quot;</span>, origin_repo) &lt; 0) {
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> g_list_reverse (ret);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a5e7e933b737fca2ccdb657124812fc90_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a5e7e933b737fca2ccdb657124812fc90_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a5e7e933b737fca2ccdb657124812fc90_cgraph" id="server_2repo-mgr_8h_a5e7e933b737fca2ccdb657124812fc90_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="344,32,555,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="604,5,785,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="613,59,776,88"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a5e7e933b737fca2ccdb657124812fc90_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a5e7e933b737fca2ccdb657124812fc90_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a5e7e933b737fca2ccdb657124812fc90_icgraph" id="server_2repo-mgr_8h_a5e7e933b737fca2ccdb657124812fc90_icgraph">
<area shape="rect" id="node3" href="virtual-repo_8c.html#a1cd4a8c70076d40d2a778dda774a2263" title="seaf_repo_manager_cleanup_virtual_repos" alt="" coords="344,57,613,87"/><area shape="rect" id="node5" href="server_2repo-mgr_8h.html#ad6564c23b0e50d8a34dd425432b80db4" title="seaf_repo_manager_del_file" alt="" coords="675,5,859,35"/><area shape="rect" id="node7" href="server_2repo-mgr_8h.html#a056b45d63edfafbc5287012a2a1062ec" title="seaf_repo_manager_move_file" alt="" coords="921,32,1119,61"/><area shape="rect" id="node10" href="server_2repo-mgr_8h.html#ae68e4b6427bb239b697e515c8617cbfb" title="seaf_repo_manager_rename_file" alt="" coords="661,109,872,139"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab6ef9796edaf6e7e5b53f3633dc88fa8"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_virtual_repo_id" ref="ab6ef9796edaf6e7e5b53f3633dc88fa8" args="(SeafRepoManager *mgr, const char *origin_repo, const char *path, const char *owner)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="virtual-repo_8c.html#ab6ef9796edaf6e7e5b53f3633dc88fa8">seaf_repo_manager_get_virtual_repo_id</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>origin_repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="virtual-repo_8c_source.html#l00352">352</a> of file <a class="el" href="virtual-repo_8c_source.html">virtual-repo.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    <span class="keywordtype">char</span> *ret;

    sql = <span class="stringliteral">&quot;SELECT RepoOwner.repo_id FROM RepoOwner, VirtualRepo &quot;</span>
        <span class="stringliteral">&quot;WHERE owner_id=? AND origin_repo=? AND path=? &quot;</span>
        <span class="stringliteral">&quot;AND RepoOwner.repo_id = VirtualRepo.repo_id&quot;</span>;

    ret = <a class="code" href="seaf-db_8c.html#a86087185f6d613c62c740d1f58cfb574">seaf_db_statement_get_string</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                        3, <span class="stringliteral">&quot;string&quot;</span>, owner, <span class="stringliteral">&quot;string&quot;</span>, origin_repo,
                                        <span class="stringliteral">&quot;string&quot;</span>, path);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_ab6ef9796edaf6e7e5b53f3633dc88fa8_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_ab6ef9796edaf6e7e5b53f3633dc88fa8_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_ab6ef9796edaf6e7e5b53f3633dc88fa8_cgraph" id="server_2repo-mgr_8h_ab6ef9796edaf6e7e5b53f3633dc88fa8_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#a86087185f6d613c62c740d1f58cfb574" title="seaf_db_statement_get_string" alt="" coords="307,59,504,88"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="561,5,743,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="571,59,733,88"/><area shape="rect" id="node9" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c" title="seaf_db_row_get_column_text" alt="" coords="553,112,751,141"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a0e2fecd8fae5355455342e43f6588967"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_virtual_repo_ids_by_origin" ref="a0e2fecd8fae5355455342e43f6588967" args="(SeafRepoManager *mgr, const char *origin_repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="virtual-repo_8c.html#a0e2fecd8fae5355455342e43f6588967">seaf_repo_manager_get_virtual_repo_ids_by_origin</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>origin_repo</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2gc_2Backups_2repo-mgr_8c_source.html#l00632">632</a> of file <a class="el" href="server_2gc_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *ret = NULL;
    <span class="keywordtype">char</span> sql[256];

    snprintf (sql, 256,
              <span class="stringliteral">&quot;SELECT repo_id FROM VirtualRepo WHERE origin_repo=&#39;%s&#39;&quot;</span>,
              origin_repo);
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4">seaf_db_foreach_selected_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 
                                      collect_virtual_repo_ids, &amp;ret) &lt; 0) {
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> g_list_reverse (ret);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a0e2fecd8fae5355455342e43f6588967_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a0e2fecd8fae5355455342e43f6588967_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a0e2fecd8fae5355455342e43f6588967_cgraph" id="server_2repo-mgr_8h_a0e2fecd8fae5355455342e43f6588967_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4" title="seaf_db_foreach_selected_row" alt="" coords="377,5,580,35"/><area shape="rect" id="node5" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="373,59,584,88"/><area shape="rect" id="node7" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="633,32,815,61"/><area shape="rect" id="node9" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="643,85,805,115"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a0e2fecd8fae5355455342e43f6588967_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a0e2fecd8fae5355455342e43f6588967_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a0e2fecd8fae5355455342e43f6588967_icgraph" id="server_2repo-mgr_8h_a0e2fecd8fae5355455342e43f6588967_icgraph">
<area shape="rect" id="node3" href="server_2repo-mgr_8h.html#a512a79980f7d3698e591cf87aeccd314" title="seaf_repo_manager_del_repo" alt="" coords="404,243,596,272"/><area shape="rect" id="node5" href="virtual-repo_8c.html#a30755ff2c01595d4927715310beaee04" title="seaf_repo_manager_merge_virtual_repo" alt="" coords="373,296,627,325"/><area shape="rect" id="node7" href="server_2repo-mgr_8h.html#a3128bd2930667427a22976b6a2b85743" title="seaf_repo_manager_post_file" alt="" coords="699,5,891,35"/><area shape="rect" id="node9" href="server_2repo-mgr_8h.html#a248a05b4a54ff2d9302d0779cbcc3542" title="seaf_repo_manager_post_multi_files" alt="" coords="677,59,912,88"/><area shape="rect" id="node11" href="server_2repo-mgr_8h.html#ad6564c23b0e50d8a34dd425432b80db4" title="seaf_repo_manager_del_file" alt="" coords="703,112,887,141"/><area shape="rect" id="node13" href="server_2repo-mgr_8h.html#a056b45d63edfafbc5287012a2a1062ec" title="seaf_repo_manager_move_file" alt="" coords="964,139,1161,168"/><area shape="rect" id="node15" href="server_2repo-mgr_8h.html#ab7eae6af688907f68212dca114549c4b" title="seaf_repo_manager_copy_file" alt="" coords="697,216,892,245"/><area shape="rect" id="node18" href="server_2repo-mgr_8h.html#aa870306d94f3e7b16e66229040590138" title="seaf_repo_manager_post_dir" alt="" coords="700,269,889,299"/><area shape="rect" id="node20" href="server_2repo-mgr_8h.html#a2e0e32263ad7bbeaa4ab13a62135c46a" title="seaf_repo_manager_post_empty_file" alt="" coords="677,323,912,352"/><area shape="rect" id="node22" href="server_2repo-mgr_8h.html#ae68e4b6427bb239b697e515c8617cbfb" title="seaf_repo_manager_rename_file" alt="" coords="689,376,900,405"/><area shape="rect" id="node24" href="server_2repo-mgr_8h.html#a46c094895964e060809372262c9b9923" title="seaf_repo_manager_put_file" alt="" coords="703,429,887,459"/><area shape="rect" id="node26" href="server_2repo-mgr_8h.html#a246dc6695f1ee0c1806de54109848096" title="seaf_repo_manager_revert_file" alt="" coords="695,483,895,512"/><area shape="rect" id="node28" href="server_2repo-mgr_8h.html#abf48f3efee4705f32fa8f3a95098921e" title="seaf_repo_manager_revert_dir" alt="" coords="696,536,893,565"/><area shape="rect" id="node30" href="server_2repo-mgr_8h.html#a75071fddf41a1371d4f89be8d2b59b88" title="seaf_repo_manager_revert_on_server" alt="" coords="675,589,915,619"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a316db228b35dde3dc88ae9dab9ec9c22"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_virtual_repo_info" ref="a316db228b35dde3dc88ae9dab9ec9c22" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structSeafVirtRepo.html">SeafVirtRepo</a>* <a class="el" href="virtual-repo_8c.html#a316db228b35dde3dc88ae9dab9ec9c22">seaf_repo_manager_get_virtual_repo_info</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2gc_2Backups_2repo-mgr_8c_source.html#l00596">596</a> of file <a class="el" href="server_2gc_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];
    <a class="code" href="structSeafVirtRepo.html">SeafVirtRepo</a> *vinfo = NULL;

    snprintf (sql, 256,
              <span class="stringliteral">&quot;SELECT origin_repo, path, base_commit FROM VirtualRepo &quot;</span>
              <span class="stringliteral">&quot;WHERE repo_id = &#39;%s&#39;&quot;</span>, repo_id);
    <a class="code" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4">seaf_db_foreach_selected_row</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, load_virtual_info, &amp;vinfo);

    <span class="keywordflow">return</span> vinfo;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a316db228b35dde3dc88ae9dab9ec9c22_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a316db228b35dde3dc88ae9dab9ec9c22_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a316db228b35dde3dc88ae9dab9ec9c22_cgraph" id="server_2repo-mgr_8h_a316db228b35dde3dc88ae9dab9ec9c22_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4" title="seaf_db_foreach_selected_row" alt="" coords="321,5,524,35"/><area shape="rect" id="node5" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="317,59,528,88"/><area shape="rect" id="node7" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="577,32,759,61"/><area shape="rect" id="node9" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="587,85,749,115"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a316db228b35dde3dc88ae9dab9ec9c22_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a316db228b35dde3dc88ae9dab9ec9c22_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a316db228b35dde3dc88ae9dab9ec9c22_icgraph" id="server_2repo-mgr_8h_a316db228b35dde3dc88ae9dab9ec9c22_icgraph">
<area shape="rect" id="node3" href="server_2repo-mgr_8h.html#ac78c13c68a1a9d1d025e45f4e51193ac" title="seaf_repo_manager_set_repo_history_limit" alt="" coords="319,29,588,59"/><area shape="rect" id="node5" href="server_2repo-mgr_8h.html#a0f63ca499435a0d01f03c8c3a2d86c44" title="seaf_repo_manager_get_repo_history_limit" alt="" coords="319,83,588,112"/><area shape="rect" id="node18" href="quota-mgr_8h.html#ae10caa81f529a80e3729b9a050666302" title="seaf_quota_manager_check_quota" alt="" coords="341,136,565,165"/><area shape="rect" id="node20" href="repo-perm_8c.html#a6a318e5a5bcb0d46286030040ab6e23b" title="seaf_repo_manager_check_permission" alt="" coords="329,189,577,219"/><area shape="rect" id="node7" href="server_2repo-mgr_8h.html#a774e0a8ea59c07c94dc8014612b3f948" title="seaf_repo_manager_get_repo_truncate_time" alt="" coords="639,83,916,112"/><area shape="rect" id="node9" href="seafile-4_81_82_2common_2rpc-service_8c.html#a5594de7f321b08c515c465bc44e25c60" title="seafile_get_commit_list" alt="" coords="1015,5,1172,35"/><area shape="rect" id="node13" href="server_2repo-mgr_8h.html#ab10ffbf8777e16cc18e78a263d7fbb1c" title="seaf_repo_manager_list_file_revisions" alt="" coords="972,83,1215,112"/><area shape="rect" id="node16" href="server_2repo-mgr_8h.html#a3bd2aea3b14fe8a45243d175ef86bb61" title="seaf_repo_manager_get_deleted_entries" alt="" coords="965,136,1221,165"/><area shape="rect" id="node11" href="rpc-deprecated_8c.html#a374cf49b787fef8fc91266c87cc15375" title="seafile_get_commit_list_pub" alt="" coords="1269,5,1456,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a89c9b19ae91ea15fe9aa684c5509d4ec"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_virtual_repos_by_owner" ref="a89c9b19ae91ea15fe9aa684c5509d4ec" args="(SeafRepoManager *mgr, const char *owner, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="virtual-repo_8c.html#a89c9b19ae91ea15fe9aa684c5509d4ec">seaf_repo_manager_get_virtual_repos_by_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="virtual-repo_8c_source.html#l00384">384</a> of file <a class="el" href="virtual-repo_8c_source.html">virtual-repo.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *id_list = NULL, *ptr;
    GList *ret = NULL;
    <span class="keywordtype">char</span> *sql;

    sql = <span class="stringliteral">&quot;SELECT RepoOwner.repo_id FROM RepoOwner, VirtualRepo &quot;</span>
        <span class="stringliteral">&quot;WHERE owner_id=? &quot;</span>
        <span class="stringliteral">&quot;AND RepoOwner.repo_id = VirtualRepo.repo_id&quot;</span>;

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 
                                       collect_virtual_repo_ids, &amp;id_list,
                                       1, <span class="stringliteral">&quot;string&quot;</span>, owner) &lt; 0) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordtype">char</span> *repo_id;
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
    <span class="keywordflow">for</span> (ptr = id_list; ptr; ptr = ptr-&gt;next) {
        repo_id = ptr-&gt;data;
        repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
        <span class="keywordflow">if</span> (repo != NULL)
            ret = g_list_prepend (ret, repo);
    }

    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (id_list);
    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a89c9b19ae91ea15fe9aa684c5509d4ec_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a89c9b19ae91ea15fe9aa684c5509d4ec_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a89c9b19ae91ea15fe9aa684c5509d4ec_cgraph" id="server_2repo-mgr_8h_a89c9b19ae91ea15fe9aa684c5509d4ec_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="360,32,571,61"/><area shape="rect" id="node9" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6" title="seaf_repo_manager_get_repo" alt="" coords="369,85,561,115"/><area shape="rect" id="node11" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="412,139,519,168"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="620,5,801,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="629,59,792,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a8dab773e289d1148e7afec7c8614278a"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_init" ref="a8dab773e289d1148e7afec7c8614278a" args="(SeafRepoManager *mgr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a8dab773e289d1148e7afec7c8614278a">seaf_repo_manager_init</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l03932">3932</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ace0bdb78b60b2d088517a3e03a448e8b">checkdir_with_mkdir</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;Index dir %s does not exist and is unable to create\n&quot;</span>,
                   mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>);
        <span class="keywordflow">return</span> -1;
    }

    <span class="comment">/* Load all the repos into memory on the client side. */</span>
    load_repos (mgr, mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ae4df188e5674e3e4b405f14d0ee1bf9f">seaf_dir</a>);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a8dab773e289d1148e7afec7c8614278a_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a8dab773e289d1148e7afec7c8614278a_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a8dab773e289d1148e7afec7c8614278a_cgraph" id="server_2repo-mgr_8h_a8dab773e289d1148e7afec7c8614278a_cgraph">
<area shape="rect" id="node3" href="seafile-4_81_82_2lib_2utils_8c.html#ace0bdb78b60b2d088517a3e03a448e8b" title="checkdir_with_mkdir" alt="" coords="276,5,417,35"/><area shape="rect" id="node5" href="server_2repo-mgr_8h.html#a9545839eb2c54af7e7e2e3948647f47c" title="seaf_repo_manager_init_merge_scheduler" alt="" coords="213,59,480,88"/><area shape="rect" id="node7" href="job-mgr_8h.html#af6f650ef4b54aace587f2e3e4bd1e622" title="ccnet_job_manager_new" alt="" coords="529,32,695,61"/><area shape="rect" id="node11" href="timer_8h.html#a68b6afb704a7f56b625ed78146691b7c" title="ccnet_timer_new" alt="" coords="552,85,672,115"/><area shape="rect" id="node9" href="job-mgr_8c.html#a5118330dbe662e28e6bb759ad343022a" title="ccnet_job_free" alt="" coords="759,32,865,61"/><area shape="rect" id="node13" href="seafile-4_81_82_2lib_2utils_8c.html#ac0aa6c70f613ad3344b5f1f917b6b68a" title="timeval_from_msec" alt="" coords="744,85,880,115"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a8dab773e289d1148e7afec7c8614278a_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a8dab773e289d1148e7afec7c8614278a_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a8dab773e289d1148e7afec7c8614278a_icgraph" id="server_2repo-mgr_8h_a8dab773e289d1148e7afec7c8614278a_icgraph">
<area shape="rect" id="node3" href="daemon_2seafile-session_8h.html#abe136340477380edec6a5deba0ff8e1a" title="seafile_session_prepare" alt="" coords="213,5,376,35"/><area shape="rect" id="node7" href="server_2seafile-session_8h.html#a5dbc4cb373997a756130cfe875b86ce6" title="seafile_session_init" alt="" coords="227,83,363,112"/><area shape="rect" id="node5" href="seaf-daemon_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="424,5,475,35"/><area shape="rect" id="node10" href="seaf-fuse_8c.html#a0ddf1224851353fc92bfbff6f499fa97" title="main" alt="" coords="424,83,475,112"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a9545839eb2c54af7e7e2e3948647f47c"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_init_merge_scheduler" ref="a9545839eb2c54af7e7e2e3948647f47c" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="virtual-repo_8c.html#a9545839eb2c54af7e7e2e3948647f47c">seaf_repo_manager_init_merge_scheduler</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="virtual-repo_8c_source.html#l00967">967</a> of file <a class="el" href="virtual-repo_8c_source.html">virtual-repo.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    scheduler = g_new0 (<a class="code" href="structMergeScheduler.html">MergeScheduler</a>, 1);
    <span class="keywordflow">if</span> (!scheduler)
        <span class="keywordflow">return</span> -1;

    pthread_mutex_init (&amp;scheduler-&gt;<a class="code" href="structMergeScheduler.html#a83d1e13daf7c64ac3fb1e3c2859ac9f9">q_lock</a>, NULL);

    scheduler-&gt;<a class="code" href="structMergeScheduler.html#a6982da78986ec10f326f4fd82e21301f">queue</a> = g_queue_new ();
    scheduler-&gt;<a class="code" href="structMergeScheduler.html#a04c5f9e5c29f3a5c8387217e2c9fc327">running</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
                                                g_free, g_free);

    scheduler-&gt;<a class="code" href="structMergeScheduler.html#a8e2741aaec76ea29ca430e2defbdd1e1">tpool</a> = <a class="code" href="job-mgr_8h.html#af6f650ef4b54aace587f2e3e4bd1e622">ccnet_job_manager_new</a> (<a class="code" href="virtual-repo_8c.html#ab3a5a8b3812ad5665b82e89aa83bd880">MAX_RUNNING_TASKS</a>);
    scheduler-&gt;<a class="code" href="structMergeScheduler.html#a82de20ac4f4c2a7f9b9336e2f4322e41">timer</a> = <a class="code" href="timer_8h.html#a68b6afb704a7f56b625ed78146691b7c">ccnet_timer_new</a> (schedule_merge_tasks,
                                        scheduler,
                                        <a class="code" href="virtual-repo_8c.html#af66ade775b3232f46645be3b78ac46de">SCHEDULE_INTERVAL</a>);
    <span class="keywordflow">return</span> 0;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a9545839eb2c54af7e7e2e3948647f47c_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a9545839eb2c54af7e7e2e3948647f47c_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a9545839eb2c54af7e7e2e3948647f47c_cgraph" id="server_2repo-mgr_8h_a9545839eb2c54af7e7e2e3948647f47c_cgraph">
<area shape="rect" id="node3" href="job-mgr_8h.html#af6f650ef4b54aace587f2e3e4bd1e622" title="ccnet_job_manager_new" alt="" coords="321,5,487,35"/><area shape="rect" id="node7" href="timer_8h.html#a68b6afb704a7f56b625ed78146691b7c" title="ccnet_timer_new" alt="" coords="344,59,464,88"/><area shape="rect" id="node5" href="job-mgr_8c.html#a5118330dbe662e28e6bb759ad343022a" title="ccnet_job_free" alt="" coords="551,5,657,35"/><area shape="rect" id="node9" href="seafile-4_81_82_2lib_2utils_8c.html#ac0aa6c70f613ad3344b5f1f917b6b68a" title="timeval_from_msec" alt="" coords="536,59,672,88"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a9545839eb2c54af7e7e2e3948647f47c_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a9545839eb2c54af7e7e2e3948647f47c_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a9545839eb2c54af7e7e2e3948647f47c_icgraph" id="server_2repo-mgr_8h_a9545839eb2c54af7e7e2e3948647f47c_icgraph">
<area shape="rect" id="node3" href="server_2Backups_2repo-mgr_8c.html#a8dab773e289d1148e7afec7c8614278a" title="seaf_repo_manager_init" alt="" coords="320,5,480,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a4f04f29fd9180ef2982cc0d7bfeee5e4"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_is_inner_pub_repo" ref="a4f04f29fd9180ef2982cc0d7bfeee5e4" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gboolean <a class="el" href="server_2repo-mgr_8h.html#a4f04f29fd9180ef2982cc0d7bfeee5e4">seaf_repo_manager_is_inner_pub_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02510">2510</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    gboolean db_err = FALSE;

    <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#af77a76302b3316a4d71e418de27843c4">seaf_db_statement_exists</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                     <span class="stringliteral">&quot;SELECT repo_id FROM InnerPubRepo WHERE repo_id=?&quot;</span>,
                                     &amp;db_err, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a4f04f29fd9180ef2982cc0d7bfeee5e4_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a4f04f29fd9180ef2982cc0d7bfeee5e4_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a4f04f29fd9180ef2982cc0d7bfeee5e4_cgraph" id="server_2repo-mgr_8h_a4f04f29fd9180ef2982cc0d7bfeee5e4_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#af77a76302b3316a4d71e418de27843c4" title="seaf_db_statement_exists" alt="" coords="303,32,476,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="527,5,708,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="536,59,699,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a7e2d25a533ae3eeced99134a7ffb5dbe"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_is_valid_filename" ref="a7e2d25a533ae3eeced99134a7ffb5dbe" args="(SeafRepoManager *mgr, const char *repo_id, const char *filename, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a7e2d25a533ae3eeced99134a7ffb5dbe">seaf_repo_manager_is_valid_filename</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02634">2634</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a>(filename, NULL))
        <span class="keywordflow">return</span> 0;
    <span class="keywordflow">else</span>
        <span class="keywordflow">return</span> 1;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a7e2d25a533ae3eeced99134a7ffb5dbe_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a7e2d25a533ae3eeced99134a7ffb5dbe_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a7e2d25a533ae3eeced99134a7ffb5dbe_cgraph" id="server_2repo-mgr_8h_a7e2d25a533ae3eeced99134a7ffb5dbe_cgraph">
<area shape="rect" id="node3" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f" title="should_ignore_file" alt="" coords="297,5,423,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a0b9efffb3301d72133b4a3fdd28fc69c"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_is_virtual_repo" ref="a0b9efffb3301d72133b4a3fdd28fc69c" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gboolean <a class="el" href="virtual-repo_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c">seaf_repo_manager_is_virtual_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="fuse_2Backups_2repo-mgr_8c_source.html#l00420">420</a> of file <a class="el" href="fuse_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];
    gboolean db_err;

    snprintf (sql, 256,
              <span class="stringliteral">&quot;SELECT 1 FROM VirtualRepo WHERE repo_id = &#39;%s&#39;&quot;</span>, repo_id);
    <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a6410cd243563343861ba3c6c16fc06a7">seaf_db_check_for_existence</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, &amp;db_err);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a0b9efffb3301d72133b4a3fdd28fc69c_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a0b9efffb3301d72133b4a3fdd28fc69c_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a0b9efffb3301d72133b4a3fdd28fc69c_cgraph" id="server_2repo-mgr_8h_a0b9efffb3301d72133b4a3fdd28fc69c_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#a6410cd243563343861ba3c6c16fc06a7" title="seaf_db_check_for_existence" alt="" coords="280,5,475,35"/><area shape="rect" id="node5" href="seaf-db_8c.html#af77a76302b3316a4d71e418de27843c4" title="seaf_db_statement_exists" alt="" coords="291,59,464,88"/><area shape="rect" id="node7" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="524,32,705,61"/><area shape="rect" id="node9" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="533,85,696,115"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a0b9efffb3301d72133b4a3fdd28fc69c_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a0b9efffb3301d72133b4a3fdd28fc69c_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a0b9efffb3301d72133b4a3fdd28fc69c_icgraph" id="server_2repo-mgr_8h_a0b9efffb3301d72133b4a3fdd28fc69c_icgraph">
<area shape="rect" id="node3" href="virtual-repo_8c.html#a9a8dcda29ee6cd28d92c1897ad12f268" title="seaf_repo_manager_create_virtual_repo" alt="" coords="280,243,533,272"/><area shape="rect" id="node5" href="virtual-repo_8c.html#a30755ff2c01595d4927715310beaee04" title="seaf_repo_manager_merge_virtual_repo" alt="" coords="280,296,533,325"/><area shape="rect" id="node7" href="server_2repo-mgr_8h.html#a3128bd2930667427a22976b6a2b85743" title="seaf_repo_manager_post_file" alt="" coords="605,5,797,35"/><area shape="rect" id="node9" href="server_2repo-mgr_8h.html#a248a05b4a54ff2d9302d0779cbcc3542" title="seaf_repo_manager_post_multi_files" alt="" coords="584,59,819,88"/><area shape="rect" id="node11" href="server_2repo-mgr_8h.html#ad6564c23b0e50d8a34dd425432b80db4" title="seaf_repo_manager_del_file" alt="" coords="609,112,793,141"/><area shape="rect" id="node13" href="server_2repo-mgr_8h.html#a056b45d63edfafbc5287012a2a1062ec" title="seaf_repo_manager_move_file" alt="" coords="871,139,1068,168"/><area shape="rect" id="node15" href="server_2repo-mgr_8h.html#ab7eae6af688907f68212dca114549c4b" title="seaf_repo_manager_copy_file" alt="" coords="604,216,799,245"/><area shape="rect" id="node18" href="server_2repo-mgr_8h.html#aa870306d94f3e7b16e66229040590138" title="seaf_repo_manager_post_dir" alt="" coords="607,269,796,299"/><area shape="rect" id="node20" href="server_2repo-mgr_8h.html#a2e0e32263ad7bbeaa4ab13a62135c46a" title="seaf_repo_manager_post_empty_file" alt="" coords="584,323,819,352"/><area shape="rect" id="node22" href="server_2repo-mgr_8h.html#ae68e4b6427bb239b697e515c8617cbfb" title="seaf_repo_manager_rename_file" alt="" coords="596,376,807,405"/><area shape="rect" id="node24" href="server_2repo-mgr_8h.html#a46c094895964e060809372262c9b9923" title="seaf_repo_manager_put_file" alt="" coords="609,429,793,459"/><area shape="rect" id="node26" href="server_2repo-mgr_8h.html#a246dc6695f1ee0c1806de54109848096" title="seaf_repo_manager_revert_file" alt="" coords="601,483,801,512"/><area shape="rect" id="node28" href="server_2repo-mgr_8h.html#abf48f3efee4705f32fa8f3a95098921e" title="seaf_repo_manager_revert_dir" alt="" coords="603,536,800,565"/><area shape="rect" id="node30" href="server_2repo-mgr_8h.html#a75071fddf41a1371d4f89be8d2b59b88" title="seaf_repo_manager_revert_on_server" alt="" coords="581,589,821,619"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab10ffbf8777e16cc18e78a263d7fbb1c"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_list_file_revisions" ref="ab10ffbf8777e16cc18e78a263d7fbb1c" args="(SeafRepoManager *mgr, const char *repo_id, const char *start_commit_id, const char *path, int max_revision, int limit, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="repo-op_8c.html#ab10ffbf8777e16cc18e78a263d7fbb1c">seaf_repo_manager_list_file_revisions</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>start_commit_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>max_revision</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>limit</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l03990">3990</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    GList *commit_list = NULL, *file_id_list = NULL, *file_size_list = NULL;
    GList *ret = NULL, *ptr;
    <a class="code" href="structCollectRevisionParam.html">CollectRevisionParam</a> data = {0};
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *last_commit = NULL;
    <span class="keyword">const</span> <span class="keywordtype">char</span> *head_id;
    gboolean is_renamed = FALSE;
    <span class="keywordtype">char</span> *parent_id = NULL, *old_path = NULL;
    GList *old_revisions = NULL;

    repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (!repo) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;No such repo %s&quot;</span>, repo_id);
        <span class="keywordflow">goto</span> out;
    }

    data.<a class="code" href="structCollectRevisionParam.html#a07864553b581ce4c6cdbda3f04c09dfe">repo</a> = repo;

    <span class="keywordflow">if</span> (!start_commit_id)
        head_id = repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>;
    <span class="keywordflow">else</span>
        head_id = start_commit_id;

    data.<a class="code" href="structCollectRevisionParam.html#a19382402505c15b32693a3f4c07259fc">path</a> = path;
    data.<a class="code" href="structCollectRevisionParam.html#aa20a18c673b6d2bdeab1475cbadfec05">error</a> = error;
    data.<a class="code" href="structCollectRevisionParam.html#a8f727a17d75f4a2459d65ee3513a319c">max_revision</a> = max_revision;

    data.<a class="code" href="structCollectRevisionParam.html#ac3711b50d3a73a6f766fe2bcaa6d378c">truncate_time</a> = <a class="code" href="server_2Backups_2repo-mgr_8c.html#a774e0a8ea59c07c94dc8014612b3f948">seaf_repo_manager_get_repo_truncate_time</a> (mgr, repo_id);
    data.<a class="code" href="structCollectRevisionParam.html#af9f62ff203010354269f5ae0a3f0659c">wanted_commits</a> = NULL;
    data.<a class="code" href="structCollectRevisionParam.html#a2e9f00e819bc4f0f65c403635b36d0a1">file_id_list</a> = NULL;
    data.<a class="code" href="structCollectRevisionParam.html#a16b7714b3c3327a32c4f1352f8e6be18">file_size_list</a> = NULL;

    <span class="comment">/* A hash table to cache caculated file id of &lt;path&gt; in &lt;commit&gt; */</span>
    data.<a class="code" href="structCollectRevisionParam.html#ac271167b2503f96b7a8d0ead7f34ae5e">file_id_cache</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
                                                g_free, g_free);

    <span class="keywordflow">if</span> (!<a class="code" href="commit-mgr_8c.html#a032f260db46d5566e78dfcbbc4b2859a">seaf_commit_manager_traverse_commit_tree_with_limit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
                                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                              head_id,
                                                              (<a class="code" href="commit-mgr_8h.html#ace73a042fe8571009de1750edb729c83">CommitTraverseFunc</a>)collect_file_revisions,
                                                              limit, &amp;data, TRUE)) {
        g_clear_error (error);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;failed to traverse commit of repo %s&quot;</span>, repo_id);
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (!data.<a class="code" href="structCollectRevisionParam.html#af9f62ff203010354269f5ae0a3f0659c">wanted_commits</a>) {
        g_clear_error (error);
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* commit list in descending commit time order. */</span>
    last_commit = data.<a class="code" href="structCollectRevisionParam.html#af9f62ff203010354269f5ae0a3f0659c">wanted_commits</a>-&gt;data;

    is_renamed = detect_rename_revision (repo,
                                         last_commit, path, &amp;parent_id, &amp;old_path);

    commit_list = g_list_reverse (data.<a class="code" href="structCollectRevisionParam.html#af9f62ff203010354269f5ae0a3f0659c">wanted_commits</a>);
    file_id_list = g_list_reverse (data.<a class="code" href="structCollectRevisionParam.html#a2e9f00e819bc4f0f65c403635b36d0a1">file_id_list</a>);
    file_size_list = g_list_reverse (data.<a class="code" href="structCollectRevisionParam.html#a16b7714b3c3327a32c4f1352f8e6be18">file_size_list</a>);

    ret = convert_rpc_commit_list (commit_list, file_id_list, file_size_list,
                                   is_renamed, old_path);

    <span class="keywordflow">if</span> (is_renamed) {
        <span class="comment">/* Get the revisions of the old path, starting from parent commit. */</span>
        old_revisions = <a class="code" href="Backups_2repo-op_8c.html#ab10ffbf8777e16cc18e78a263d7fbb1c">seaf_repo_manager_list_file_revisions</a> (mgr, repo_id,
                                                               parent_id, old_path,
                                                               -1, -1, error);
        ret = g_list_concat (ret, old_revisions);
        g_free (parent_id);
        g_free (old_path);
    }

    g_clear_error (error);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">for</span> (ptr = commit_list; ptr; ptr = ptr-&gt;next)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> ((<a class="code" href="struct__SeafCommit.html">SeafCommit</a> *)ptr-&gt;data);
    g_list_free (commit_list);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (file_id_list);
    <span class="keywordflow">for</span> (ptr = file_size_list; ptr; ptr = ptr-&gt;next)
        g_free (ptr-&gt;data);
    g_list_free (file_size_list);
    <span class="keywordflow">if</span> (data.<a class="code" href="structCollectRevisionParam.html#ac271167b2503f96b7a8d0ead7f34ae5e">file_id_cache</a>)
        g_hash_table_destroy (data.<a class="code" href="structCollectRevisionParam.html#ac271167b2503f96b7a8d0ead7f34ae5e">file_id_cache</a>);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_ab10ffbf8777e16cc18e78a263d7fbb1c_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_ab10ffbf8777e16cc18e78a263d7fbb1c_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_ab10ffbf8777e16cc18e78a263d7fbb1c_cgraph" id="server_2repo-mgr_8h_ab10ffbf8777e16cc18e78a263d7fbb1c_cgraph">
<area shape="rect" id="node3" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6" title="seaf_repo_manager_get_repo" alt="" coords="375,5,567,35"/><area shape="rect" id="node5" href="server_2Backups_2repo-mgr_8c.html#a774e0a8ea59c07c94dc8014612b3f948" title="seaf_repo_manager_get_repo_truncate_time" alt="" coords="332,59,609,88"/><area shape="rect" id="node7" href="commit-mgr_8c.html#a032f260db46d5566e78dfcbbc4b2859a" title="seaf_commit_manager_traverse_commit_tree_with_limit" alt="" coords="296,112,645,141"/><area shape="rect" id="node13" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="741,164,875,193"/><area shape="rect" id="node15" href="Backups_2repo-op_8c.html#ab10ffbf8777e16cc18e78a263d7fbb1c" title="seaf_repo_manager_list_file_revisions" alt="" coords="349,216,592,245"/><area shape="rect" id="node17" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="413,269,528,299"/><area shape="rect" id="node20" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="417,323,524,352"/><area shape="rect" id="node9" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f" title="seaf_commit_manager_get_commit" alt="" coords="693,111,923,140"/><area shape="rect" id="node11" href="commit-mgr_8c.html#a2b1cc305cf40cb64c341a0e64d0fe921" title="seaf_commit_ref" alt="" coords="972,111,1089,140"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_ab10ffbf8777e16cc18e78a263d7fbb1c_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_ab10ffbf8777e16cc18e78a263d7fbb1c_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_ab10ffbf8777e16cc18e78a263d7fbb1c_icgraph" id="server_2repo-mgr_8h_ab10ffbf8777e16cc18e78a263d7fbb1c_icgraph">
</map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a715b426c9fadfc393ece3afdec8587f7"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_list_inner_pub_repos" ref="a715b426c9fadfc393ece3afdec8587f7" args="(SeafRepoManager *mgr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a715b426c9fadfc393ece3afdec8587f7">seaf_repo_manager_list_inner_pub_repos</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02562">2562</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *ret = NULL, *p;
    <span class="keywordtype">char</span> *sql;

    sql = <span class="stringliteral">&quot;SELECT InnerPubRepo.repo_id, VirtualRepo.repo_id, &quot;</span>
        <span class="stringliteral">&quot;owner_id, permission, commit_id &quot;</span>
        <span class="stringliteral">&quot;FROM InnerPubRepo LEFT JOIN VirtualRepo ON &quot;</span>
        <span class="stringliteral">&quot;InnerPubRepo.repo_id=VirtualRepo.repo_id, RepoOwner, Branch &quot;</span>
        <span class="stringliteral">&quot;WHERE InnerPubRepo.repo_id=RepoOwner.repo_id AND &quot;</span>
        <span class="stringliteral">&quot;InnerPubRepo.repo_id = Branch.repo_id AND Branch.name = &#39;master&#39;&quot;</span>;

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                       collect_public_repos, &amp;ret,
                                       0) &lt; 0) {
        <span class="keywordflow">for</span> (p = ret; p != NULL; p = p-&gt;next)
            g_object_unref (p-&gt;data);
        g_list_free (ret);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> g_list_reverse (ret);    
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a715b426c9fadfc393ece3afdec8587f7_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a715b426c9fadfc393ece3afdec8587f7_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a715b426c9fadfc393ece3afdec8587f7_cgraph" id="server_2repo-mgr_8h_a715b426c9fadfc393ece3afdec8587f7_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="317,32,528,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="577,5,759,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="587,59,749,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a8be31ce1507a9a9fb63e15123961acdb"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_list_inner_pub_repos_by_owner" ref="a8be31ce1507a9a9fb63e15123961acdb" args="(SeafRepoManager *mgr, const char *user)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a8be31ce1507a9a9fb63e15123961acdb">seaf_repo_manager_list_inner_pub_repos_by_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02597">2597</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *ret = NULL, *p;
    <span class="keywordtype">char</span> *sql;

    sql = <span class="stringliteral">&quot;SELECT InnerPubRepo.repo_id, VirtualRepo.repo_id, &quot;</span>
        <span class="stringliteral">&quot;owner_id, permission, commit_id &quot;</span>
        <span class="stringliteral">&quot;FROM InnerPubRepo LEFT JOIN VirtualRepo ON &quot;</span>
        <span class="stringliteral">&quot;InnerPubRepo.repo_id=VirtualRepo.repo_id, RepoOwner, Branch &quot;</span>
        <span class="stringliteral">&quot;WHERE InnerPubRepo.repo_id=RepoOwner.repo_id AND owner_id=? &quot;</span>
        <span class="stringliteral">&quot;AND InnerPubRepo.repo_id = Branch.repo_id AND Branch.name = &#39;master&#39;&quot;</span>;

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                       collect_public_repos, &amp;ret,
                                       1, <span class="stringliteral">&quot;string&quot;</span>, user) &lt; 0) {
        <span class="keywordflow">for</span> (p = ret; p != NULL; p = p-&gt;next)
            g_object_unref (p-&gt;data);
        g_list_free (ret);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> g_list_reverse (ret);    
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a8be31ce1507a9a9fb63e15123961acdb_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a8be31ce1507a9a9fb63e15123961acdb_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a8be31ce1507a9a9fb63e15123961acdb_cgraph" id="server_2repo-mgr_8h_a8be31ce1507a9a9fb63e15123961acdb_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="379,32,589,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="639,5,820,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="648,59,811,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="afab1803ccaa8885ec65db8075e87a40a"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_list_repo_tokens" ref="afab1803ccaa8885ec65db8075e87a40a" args="(SeafRepoManager *mgr, const char *repo_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#afab1803ccaa8885ec65db8075e87a40a">seaf_repo_manager_list_repo_tokens</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01253">1253</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *ret_list = NULL;
    <span class="keywordtype">char</span> *sql;
    gboolean db_err = FALSE;

    <span class="keywordflow">if</span> (!repo_exists_in_db (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, repo_id, &amp;db_err)) {
        <span class="keywordflow">if</span> (db_err) {
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
        }
        <span class="keywordflow">return</span> NULL;
    }

    sql = <span class="stringliteral">&quot;SELECT u.repo_id, o.owner_id, u.email, u.token, &quot;</span>
        <span class="stringliteral">&quot;p.peer_id, p.peer_ip, p.peer_name, p.sync_time &quot;</span>
        <span class="stringliteral">&quot;FROM RepoUserToken u LEFT JOIN RepoTokenPeerInfo p &quot;</span>
        <span class="stringliteral">&quot;ON u.token = p.token, RepoOwner o &quot;</span>
        <span class="stringliteral">&quot;WHERE u.repo_id = ? and o.repo_id = ? &quot;</span>;

    <span class="keywordtype">int</span> n_row = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                              collect_repo_token, &amp;ret_list,
                                              2, <span class="stringliteral">&quot;string&quot;</span>, repo_id,
                                              <span class="stringliteral">&quot;string&quot;</span>, repo_id);
    <span class="keywordflow">if</span> (n_row &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;DB error when get token info for repo %.10s.\n&quot;</span>,
                      repo_id);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
    }

    fill_in_token_info (ret_list);

    <span class="keywordflow">return</span> g_list_reverse(ret_list);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_afab1803ccaa8885ec65db8075e87a40a_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_afab1803ccaa8885ec65db8075e87a40a_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_afab1803ccaa8885ec65db8075e87a40a_cgraph" id="server_2repo-mgr_8h_afab1803ccaa8885ec65db8075e87a40a_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="293,32,504,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="553,5,735,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="563,59,725,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a754dc377da1101690257dd8be7fbe78f"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_list_repo_tokens_by_email" ref="a754dc377da1101690257dd8be7fbe78f" args="(SeafRepoManager *mgr, const char *email, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a754dc377da1101690257dd8be7fbe78f">seaf_repo_manager_list_repo_tokens_by_email</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>email</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01290">1290</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *ret_list = NULL;
    <span class="keywordtype">char</span> *sql;

    sql = <span class="stringliteral">&quot;SELECT u.repo_id, o.owner_id, u.email, u.token, &quot;</span>
        <span class="stringliteral">&quot;p.peer_id, p.peer_ip, p.peer_name, p.sync_time &quot;</span>
        <span class="stringliteral">&quot;FROM RepoUserToken u LEFT JOIN RepoTokenPeerInfo p &quot;</span>
        <span class="stringliteral">&quot;ON u.token = p.token, RepoOwner o &quot;</span>
        <span class="stringliteral">&quot;WHERE u.email = ? and u.repo_id = o.repo_id&quot;</span>;

    <span class="keywordtype">int</span> n_row = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                              collect_repo_token, &amp;ret_list,
                                              1, <span class="stringliteral">&quot;string&quot;</span>, email);
    <span class="keywordflow">if</span> (n_row &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;DB error when get token info for email %s.\n&quot;</span>,
                      email);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
    }

    fill_in_token_info (ret_list);

    <span class="keywordflow">return</span> g_list_reverse(ret_list);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a754dc377da1101690257dd8be7fbe78f_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a754dc377da1101690257dd8be7fbe78f_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a754dc377da1101690257dd8be7fbe78f_cgraph" id="server_2repo-mgr_8h_a754dc377da1101690257dd8be7fbe78f_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="352,32,563,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="612,5,793,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="621,59,784,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a30755ff2c01595d4927715310beaee04"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_merge_virtual_repo" ref="a30755ff2c01595d4927715310beaee04" args="(SeafRepoManager *mgr, const char *repo_id, const char *exclude_repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="virtual-repo_8c.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>exclude_repo</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="virtual-repo_8c_source.html#l00485">485</a> of file <a class="el" href="virtual-repo_8c_source.html">virtual-repo.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *vrepos = NULL, *ptr;
    <span class="keywordtype">char</span> *vrepo_id;
    <span class="keywordtype">int</span> ret = 0;

    <span class="keywordflow">if</span> (<a class="code" href="fuse_2Backups_2repo-mgr_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c">seaf_repo_manager_is_virtual_repo</a> (mgr, repo_id)) {
        add_merge_task (repo_id);
        <span class="keywordflow">return</span> 0;
    }

    vrepos = <a class="code" href="server_2gc_2Backups_2repo-mgr_8c.html#a0e2fecd8fae5355455342e43f6588967">seaf_repo_manager_get_virtual_repo_ids_by_origin</a> (mgr, repo_id);
    <span class="keywordflow">for</span> (ptr = vrepos; ptr; ptr = ptr-&gt;next) {
        vrepo_id = ptr-&gt;data;

        <span class="keywordflow">if</span> (g_strcmp0 (exclude_repo, vrepo_id) == 0)
            <span class="keywordflow">continue</span>;

        add_merge_task (vrepo_id);
    }

    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (vrepos);
    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a30755ff2c01595d4927715310beaee04_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a30755ff2c01595d4927715310beaee04_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a30755ff2c01595d4927715310beaee04_cgraph" id="server_2repo-mgr_8h_a30755ff2c01595d4927715310beaee04_cgraph">
<area shape="rect" id="node3" href="fuse_2Backups_2repo-mgr_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c" title="seaf_repo_manager_is_virtual_repo" alt="" coords="353,5,580,35"/><area shape="rect" id="node5" href="server_2gc_2Backups_2repo-mgr_8c.html#a0e2fecd8fae5355455342e43f6588967" title="seaf_repo_manager_get_virtual_repo_ids_by_origin" alt="" coords="308,59,625,88"/><area shape="rect" id="node7" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="413,112,520,141"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a30755ff2c01595d4927715310beaee04_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a30755ff2c01595d4927715310beaee04_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a30755ff2c01595d4927715310beaee04_icgraph" id="server_2repo-mgr_8h_a30755ff2c01595d4927715310beaee04_icgraph">
<area shape="rect" id="node3" href="server_2repo-mgr_8h.html#a3128bd2930667427a22976b6a2b85743" title="seaf_repo_manager_post_file" alt="" coords="331,5,523,35"/><area shape="rect" id="node5" href="server_2repo-mgr_8h.html#a248a05b4a54ff2d9302d0779cbcc3542" title="seaf_repo_manager_post_multi_files" alt="" coords="309,59,544,88"/><area shape="rect" id="node7" href="server_2repo-mgr_8h.html#ad6564c23b0e50d8a34dd425432b80db4" title="seaf_repo_manager_del_file" alt="" coords="335,112,519,141"/><area shape="rect" id="node9" href="server_2repo-mgr_8h.html#a056b45d63edfafbc5287012a2a1062ec" title="seaf_repo_manager_move_file" alt="" coords="596,139,793,168"/><area shape="rect" id="node11" href="server_2repo-mgr_8h.html#ab7eae6af688907f68212dca114549c4b" title="seaf_repo_manager_copy_file" alt="" coords="329,216,524,245"/><area shape="rect" id="node14" href="server_2repo-mgr_8h.html#aa870306d94f3e7b16e66229040590138" title="seaf_repo_manager_post_dir" alt="" coords="332,269,521,299"/><area shape="rect" id="node16" href="server_2repo-mgr_8h.html#a2e0e32263ad7bbeaa4ab13a62135c46a" title="seaf_repo_manager_post_empty_file" alt="" coords="309,323,544,352"/><area shape="rect" id="node18" href="server_2repo-mgr_8h.html#ae68e4b6427bb239b697e515c8617cbfb" title="seaf_repo_manager_rename_file" alt="" coords="321,376,532,405"/><area shape="rect" id="node20" href="server_2repo-mgr_8h.html#a46c094895964e060809372262c9b9923" title="seaf_repo_manager_put_file" alt="" coords="335,429,519,459"/><area shape="rect" id="node22" href="server_2repo-mgr_8h.html#a246dc6695f1ee0c1806de54109848096" title="seaf_repo_manager_revert_file" alt="" coords="327,483,527,512"/><area shape="rect" id="node24" href="server_2repo-mgr_8h.html#abf48f3efee4705f32fa8f3a95098921e" title="seaf_repo_manager_revert_dir" alt="" coords="328,536,525,565"/><area shape="rect" id="node26" href="server_2repo-mgr_8h.html#a75071fddf41a1371d4f89be8d2b59b88" title="seaf_repo_manager_revert_on_server" alt="" coords="307,589,547,619"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a056b45d63edfafbc5287012a2a1062ec"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_move_file" ref="a056b45d63edfafbc5287012a2a1062ec" args="(SeafRepoManager *mgr, const char *src_repo_id, const char *src_dir, const char *src_filename, const char *dst_repo_id, const char *dst_dir, const char *dst_filename, const char *user, int need_progress, int synchronous, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">SeafileCopyResult* <a class="el" href="repo-op_8c.html#ac11bd852cc7cc4f30e40123b7bae901e">seaf_repo_manager_move_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>src_repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>src_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>src_filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dst_repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dst_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dst_filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>need_progress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>synchronous</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l02063">2063</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *src_repo = NULL, *dst_repo = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *src_dent = NULL, *dst_dent = NULL;
    <span class="keywordtype">char</span> *src_canon_path = NULL, *dst_canon_path = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *dst_head_commit = NULL;
    <span class="keywordtype">int</span> ret = 0;
    gboolean background = FALSE;
    <span class="keywordtype">char</span> *task_id = NULL;
    SeafileCopyResult *res = NULL;

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(src_repo, src_repo_id);

    <span class="keywordflow">if</span> (strcmp(src_repo_id, dst_repo_id) != 0) {
        <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(dst_repo, dst_repo_id);

        <span class="keywordflow">if</span> (src_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a> || dst_repo-&gt;encrypted) {
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                         <span class="stringliteral">&quot;Can&#39;t copy files between encrypted repo(s)&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
        
    } <span class="keywordflow">else</span> {
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#ab8f60cbbd6c35ee55ea72acbbd3a1608">seaf_repo_ref</a> (src_repo);
        dst_repo = src_repo;
    }
    
    src_canon_path = get_canonical_path (src_path);
    dst_canon_path = get_canonical_path (dst_path);
    <span class="comment">/* first check whether a file with file_name already exists in destination dir */</span>
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(dst_head_commit,
                       dst_repo-&gt;id, dst_repo-&gt;<a class="code" href="struct__SeafCommit.html#abc83f168ce2b43fa864522bf0ea26d6d">version</a>, 
                       dst_repo-&gt;head-&gt;commit_id);
    <a class="code" href="Backups_2repo-op_8c.html#a897aab32c75a36b188922b8726831ccf">FAIL_IF_FILE_EXISTS</a>(dst_repo-&gt;store_id, dst_repo-&gt;version,
                        dst_head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, dst_canon_path, dst_filename, NULL);

    <span class="comment">/* get src dirent */</span>
    src_dent = get_dirent_by_path (src_repo, NULL,
                                   src_canon_path, src_filename, error);
    <span class="keywordflow">if</span> (!src_dent) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    gint64 <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a> = (src_dent-&gt;<a class="code" href="struct__SeafDirent.html#afc58a80e040b009230ce1d3d500e2f1f">version</a> &gt; 0) ? src_dent-&gt;<a class="code" href="struct__SeafDirent.html#abf0e9b6fade594b7897cb9896d370961">size</a> : -1;

    if (src_repo == dst_repo) {
        <span class="comment">/* duplicate src dirent with new name */</span>
        dst_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a> (dst_repo-&gt;version),
                                    src_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>, src_dent-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>, dst_filename,
                                    (gint64)time(NULL), user, file_size);

        <span class="comment">/* move file within the same repo */</span>
        <span class="keywordflow">if</span> (move_file_same_repo (src_repo_id,
                                 src_canon_path, src_dent,
                                 dst_canon_path, dst_dent,
                                 user, error) &lt; 0) {
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }

        <a class="code" href="server_2repo-mgr_8h.html#a1cd4a8c70076d40d2a778dda774a2263">seaf_repo_manager_cleanup_virtual_repos</a> (mgr, src_repo_id);
        <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, src_repo_id, NULL);

        update_repo_size (dst_repo_id);
    } <span class="keywordflow">else</span> {
        <span class="comment">/* move between different repos */</span>

        <span class="keywordflow">if</span> (is_virtual_repo_and_origin (src_repo, dst_repo)) {
            <span class="comment">/* duplicate src dirent with new name */</span>
            dst_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(dst_repo-&gt;version),
                                        src_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>, src_dent-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>, dst_filename,
                                        (gint64)time(NULL), user, file_size);

            <span class="comment">/* add this dirent to dst repo */</span>
            <span class="keywordflow">if</span> (put_dirent_and_commit (dst_repo,
                                       dst_canon_path,
                                       dst_dent,
                                       user,
                                       error) &lt; 0) {
                <span class="keywordflow">if</span> (!error)
                    g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                                 <span class="stringliteral">&quot;failed to put dirent&quot;</span>);
                ret = -1;
                <span class="keywordflow">goto</span> out;
            }

            <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, dst_repo_id, NULL);

            <span class="keywordflow">if</span> (<a class="code" href="Backups_2repo-op_8c.html#ad6564c23b0e50d8a34dd425432b80db4">seaf_repo_manager_del_file</a> (mgr, src_repo_id, src_path,
                                            src_filename, user, error) &lt; 0) {
                ret = -1;
                <span class="keywordflow">goto</span> out;
            }

            <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, src_repo_id, NULL);

            update_repo_size (dst_repo_id);
        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!synchronous) {
            background = TRUE;

            gint64 total_files = -1;
            <span class="keywordflow">if</span> (S_ISDIR(src_dent-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>))
                total_files = <a class="code" href="fs-mgr_8c.html#afa141245d62ac11820ad120fef68d01e">seaf_fs_manager_count_fs_files</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                                              src_repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>,
                                                              src_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                              src_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
            <span class="keywordflow">else</span>
                total_files = 1;
            <span class="keywordflow">if</span> (total_files &lt; 0) {
                seaf_warning (<span class="stringliteral">&quot;Failed to get file count.\n&quot;</span>);
                ret = -1;
                <span class="keywordflow">goto</span> out;
            }

            <span class="keywordflow">if</span> (!check_file_count_and_size (src_repo, src_dent, total_files, error)) {
                ret = -1;
                <span class="keywordflow">goto</span> out;
            }

            task_id = <a class="code" href="copy-mgr_8c.html#ae731d17024807023ab2689f9ffca5e99">seaf_copy_manager_add_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a1826aa8bcba056a4f41755627b270751">copy_mgr</a>,
                                                  src_repo_id,
                                                  src_canon_path,
                                                  src_filename,
                                                  dst_repo_id,
                                                  dst_canon_path,
                                                  dst_filename,
                                                  user,
                                                  total_files,
                                                  cross_repo_move,
                                                  need_progress);
            <span class="keywordflow">if</span> (need_progress &amp;&amp; !task_id) {
                seaf_warning (<span class="stringliteral">&quot;Failed to start copy task.\n&quot;</span>);
                g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                             <span class="stringliteral">&quot;failed to start copy task&quot;</span>);
                ret = -1;
                <span class="keywordflow">goto</span> out;
            }
        } <span class="keywordflow">else</span> {
            <span class="comment">/* Synchronous for cross-repo move */</span>
            <span class="keywordflow">if</span> (cross_repo_move (src_repo_id,
                                 src_canon_path,
                                 src_filename,
                                 dst_repo_id,
                                 dst_canon_path,
                                 dst_filename,
                                 user,
                                 NULL) &lt; 0) {
                g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                             <span class="stringliteral">&quot;Failed to move&quot;</span>);
                ret = -1;
                <span class="keywordflow">goto</span> out;
            }
        }
    }

out:
    <span class="keywordflow">if</span> (src_repo) <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (src_repo);
    <span class="keywordflow">if</span> (dst_repo) <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (dst_repo);

    <span class="keywordflow">if</span> (dst_head_commit) <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(dst_head_commit);
    
    <span class="keywordflow">if</span> (src_canon_path) g_free (src_canon_path);
    <span class="keywordflow">if</span> (dst_canon_path) g_free (dst_canon_path);
    
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a>(src_dent);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a>(dst_dent);

    <span class="keywordflow">if</span> (ret == 0) {
        res = seafile_copy_result_new ();
        g_object_set (res, <span class="stringliteral">&quot;background&quot;</span>, background, <span class="stringliteral">&quot;task_id&quot;</span>, task_id, NULL);
        g_free (task_id);
    }

    <span class="keywordflow">return</span> res;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a056b45d63edfafbc5287012a2a1062ec_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a056b45d63edfafbc5287012a2a1062ec_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a056b45d63edfafbc5287012a2a1062ec_cgraph" id="server_2repo-mgr_8h_a056b45d63edfafbc5287012a2a1062ec_cgraph">
<area shape="rect" id="node3" href="fuse_2Backups_2repo-mgr_8c.html#ab8f60cbbd6c35ee55ea72acbbd3a1608" title="seaf_repo_ref" alt="" coords="337,5,439,35"/><area shape="rect" id="node5" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f" title="seaf_dirent_new" alt="" coords="329,59,447,88"/><area shape="rect" id="node7" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1" title="dir_version_from_repo_version" alt="" coords="289,112,487,141"/><area shape="rect" id="node9" href="server_2repo-mgr_8h.html#a1cd4a8c70076d40d2a778dda774a2263" title="seaf_repo_manager_cleanup_virtual_repos" alt="" coords="253,321,523,351"/><area shape="rect" id="node35" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a" title="seaf_dirent_free" alt="" coords="1232,137,1347,167"/><area shape="rect" id="node40" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="673,428,788,457"/><area shape="rect" id="node42" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="664,481,797,511"/><area shape="rect" id="node44" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04" title="seaf_repo_manager_merge_virtual_repo" alt="" coords="261,533,515,563"/><area shape="rect" id="node52" href="Backups_2repo-op_8c.html#ad6564c23b0e50d8a34dd425432b80db4" title="seaf_repo_manager_del_file" alt="" coords="296,587,480,616"/><area shape="rect" id="node54" href="fs-mgr_8c.html#afa141245d62ac11820ad120fef68d01e" title="seaf_fs_manager_count_fs_files" alt="" coords="283,640,493,669"/><area shape="rect" id="node56" href="copy-mgr_8c.html#ae731d17024807023ab2689f9ffca5e99" title="seaf_copy_manager_add_task" alt="" coords="289,695,487,724"/><area shape="rect" id="node11" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6" title="seaf_repo_manager_get_repo" alt="" coords="635,164,827,193"/><area shape="rect" id="node13" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f" title="seaf_commit_manager_get_commit" alt="" coords="616,217,845,247"/><area shape="rect" id="node17" href="server_2repo-mgr_8h.html#a5e7e933b737fca2ccdb657124812fc90" title="seaf_repo_manager_get_virtual_info_by_origin" alt="" coords="585,375,876,404"/><area shape="rect" id="node25" href="fs-mgr_8c.html#a033b8831db7345eec0ff09216b63593d" title="seaf_fs_manager_get_seafdir_by_path" alt="" coords="608,321,853,351"/><area shape="rect" id="node33" href="fs-mgr_8c.html#ae04d3c4669cd7b0fc691cd2da6dc2de1" title="seaf_dir_free" alt="" coords="996,269,1092,299"/><area shape="rect" id="node38" href="server_2gc_2Backups_2repo-mgr_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a" title="seaf_virtual_repo_info_free" alt="" coords="641,111,820,140"/><area shape="rect" id="node15" href="commit-mgr_8c.html#a2b1cc305cf40cb64c341a0e64d0fe921" title="seaf_commit_ref" alt="" coords="985,216,1103,245"/><area shape="rect" id="node19" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="939,376,1149,405"/><area shape="rect" id="node21" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="1199,429,1380,459"/><area shape="rect" id="node23" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="1208,376,1371,405"/><area shape="rect" id="node27" href="fs-mgr_8c.html#a08103ffc3a5cd19b70167404c39ce3e4" title="seaf_fs_manager_get_seafdir" alt="" coords="948,323,1140,352"/><area shape="rect" id="node29" href="obj-store_8c.html#a6e93a0214f9cb8a7fc837a2bc3a3c529" title="seaf_obj_store_read_obj" alt="" coords="1208,269,1371,299"/><area shape="rect" id="node31" href="fs-mgr_8c.html#a6875a119da427bb1cd9796eee916b703" title="seaf_dir_from_data" alt="" coords="1223,323,1356,352"/><area shape="rect" id="node46" href="fuse_2Backups_2repo-mgr_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c" title="seaf_repo_manager_is_virtual_repo" alt="" coords="617,641,844,671"/><area shape="rect" id="node48" href="server_2gc_2Backups_2repo-mgr_8c.html#a0e2fecd8fae5355455342e43f6588967" title="seaf_repo_manager_get_virtual_repo_ids_by_origin" alt="" coords="572,535,889,564"/><area shape="rect" id="node50" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="677,588,784,617"/><area shape="rect" id="node58" href="seafile-4_81_82_2lib_2utils_8c.html#af64020f0be33abde6a2a076ff9808809" title="gen_uuid" alt="" coords="693,695,768,724"/><area shape="rect" id="node60" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768" title="ccnet_job_manager_schedule_job" alt="" coords="621,748,840,777"/><area shape="rect" id="node62" href="job-mgr_8c.html#a6272c9579bee3c9bfb469e720e6a03e0" title="ccnet_job_new" alt="" coords="989,775,1099,804"/><area shape="rect" id="node64" href="job-mgr_8c.html#a0df701b89788bcc8e5fd0035f30afe29" title="job_thread_create" alt="" coords="981,721,1107,751"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a640edf431de146c19d5ac2cff6321397"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_new" ref="a640edf431de146c19d5ac2cff6321397" args="(struct _SeafileSession *seaf)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a>* <a class="el" href="server_2repo-mgr_8h.html#a640edf431de146c19d5ac2cff6321397">seaf_repo_manager_new</a> </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="struct__SeafileSession.html">_SeafileSession</a> *&#160;</td>
          <td class="paramname"><em>seaf</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l03899">3899</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = g_new0 (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a>, 1);

    mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a> = g_new0 (<a class="code" href="struct__SeafRepoManagerPriv.html">SeafRepoManagerPriv</a>, 1);
    mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a> = <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>;
    mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a> = g_build_path (<a class="code" href="vc-utils_8h.html#aa7da4cdc6796b13fca1a4b263488dfdd">PATH_SEPERATOR</a>, seaf-&gt;<a class="code" href="struct__SeafileSession.html#ae4df188e5674e3e4b405f14d0ee1bf9f">seaf_dir</a>, <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a823aa5bebe4b4b836619cae12751b8a5">INDEX_DIR</a>, NULL);

    pthread_mutex_init (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>, NULL);

    mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a7fde21f0d7bba66fac76f4783377f20c">checkout_tasks_hash</a> = g_hash_table_new_full
        (g_str_hash, g_str_equal, g_free, g_free);

    ignore_patterns = g_new0 (GPatternSpec*, G_N_ELEMENTS(ignore_table));
    <span class="keywordtype">int</span> i;
    <span class="keywordflow">for</span> (i = 0; ignore_table[i] != NULL; i++) {
        ignore_patterns[i] = g_pattern_spec_new (ignore_table[i]);
    }

    office_temp_ignore_patterns[0] = g_pattern_spec_new(<span class="stringliteral">&quot;~$*&quot;</span>);
    <span class="comment">/* for files like ~WRL0001.tmp */</span>
    office_temp_ignore_patterns[1] = g_pattern_spec_new(<span class="stringliteral">&quot;~*.tmp&quot;</span>);
    office_temp_ignore_patterns[2] = g_pattern_spec_new(<span class="stringliteral">&quot;.~lock*#&quot;</span>);
    office_temp_ignore_patterns[3] = NULL;

    mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a46e78181430977b311346c02e5738286">repo_hash</a> = g_hash_table_new_full (g_str_hash, g_str_equal, g_free, NULL);

    pthread_rwlock_init (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>, NULL);

    <span class="keywordflow">return</span> mgr;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a640edf431de146c19d5ac2cff6321397_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a640edf431de146c19d5ac2cff6321397_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a640edf431de146c19d5ac2cff6321397_cgraph" id="server_2repo-mgr_8h_a640edf431de146c19d5ac2cff6321397_cgraph">
<area shape="rect" id="node3" href="timer_8h.html#a68b6afb704a7f56b625ed78146691b7c" title="ccnet_timer_new" alt="" coords="223,5,343,35"/><area shape="rect" id="node5" href="seafile-4_81_82_2lib_2utils_8c.html#ac0aa6c70f613ad3344b5f1f917b6b68a" title="timeval_from_msec" alt="" coords="392,5,528,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a640edf431de146c19d5ac2cff6321397_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a640edf431de146c19d5ac2cff6321397_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a640edf431de146c19d5ac2cff6321397_icgraph" id="server_2repo-mgr_8h_a640edf431de146c19d5ac2cff6321397_icgraph">
<area shape="rect" id="node3" href="daemon_2seafile-session_8h.html#a3eea8fbb412edb5ff72027285edb7c72" title="seafile_session_new" alt="" coords="223,5,364,35"/><area shape="rect" id="node5" href="seaf-daemon_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="main" alt="" coords="413,5,464,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aa870306d94f3e7b16e66229040590138"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_post_dir" ref="aa870306d94f3e7b16e66229040590138" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *new_dir_name, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#aa870306d94f3e7b16e66229040590138">seaf_repo_manager_post_dir</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new_dir_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l02252">2252</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (new_dir_name, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[post dir] Invalid dir name %s.\n&quot;</span>, new_dir_name);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid dir name&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="Backups_2repo-op_8c.html#a897aab32c75a36b188922b8726831ccf">FAIL_IF_FILE_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                        head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dir_name, NULL);

    <span class="keywordflow">if</span> (!new_dent) {
        new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                    <a class="code" href="seafile-4_81_82_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>, S_IFDIR, new_dir_name,
                                    (gint64)time(NULL), NULL, -1);
    }

    root_id = do_post_file (repo,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[put dir] Failed to put dir.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to put dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Added directory \&quot;%s\&quot;&quot;</span>, new_dir_name);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (root_id);
    g_free (canon_path);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_aa870306d94f3e7b16e66229040590138_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_aa870306d94f3e7b16e66229040590138_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_aa870306d94f3e7b16e66229040590138_cgraph" id="server_2repo-mgr_8h_aa870306d94f3e7b16e66229040590138_cgraph">
<area shape="rect" id="node3" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f" title="should_ignore_file" alt="" coords="307,5,432,35"/><area shape="rect" id="node5" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f" title="seaf_dirent_new" alt="" coords="311,59,428,88"/><area shape="rect" id="node7" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1" title="dir_version_from_repo_version" alt="" coords="271,112,468,141"/><area shape="rect" id="node9" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04" title="seaf_repo_manager_merge_virtual_repo" alt="" coords="243,165,496,195"/><area shape="rect" id="node17" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="312,219,427,248"/><area shape="rect" id="node19" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="303,272,436,301"/><area shape="rect" id="node21" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a" title="seaf_dirent_free" alt="" coords="312,325,427,355"/><area shape="rect" id="node11" href="fuse_2Backups_2repo-mgr_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c" title="seaf_repo_manager_is_virtual_repo" alt="" coords="591,112,817,141"/><area shape="rect" id="node13" href="server_2gc_2Backups_2repo-mgr_8c.html#a0e2fecd8fae5355455342e43f6588967" title="seaf_repo_manager_get_virtual_repo_ids_by_origin" alt="" coords="545,165,863,195"/><area shape="rect" id="node15" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="651,219,757,248"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a2e0e32263ad7bbeaa4ab13a62135c46a"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_post_empty_file" ref="a2e0e32263ad7bbeaa4ab13a62135c46a" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *new_file_name, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a2e0e32263ad7bbeaa4ab13a62135c46a">seaf_repo_manager_post_empty_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new_file_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l02322">2322</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    <span class="keywordflow">if</span> (!canon_path)
        <span class="comment">/* no need to call get_canonical_path again when retry */</span>
        canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (new_file_name, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[post file] Invalid file name %s.\n&quot;</span>, new_file_name);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid file name&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="Backups_2repo-op_8c.html#a897aab32c75a36b188922b8726831ccf">FAIL_IF_FILE_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                        head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_file_name, NULL);

    <span class="keywordflow">if</span> (!new_dent) {
        new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                    <a class="code" href="seafile-4_81_82_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>, <a class="code" href="Backups_2repo-op_8c.html#a68c7bdf3d604f5310c1a353eab98692f">STD_FILE_MODE</a>, new_file_name,
                                    (gint64)time(NULL), user, 0);
    }

    root_id = do_post_file (repo,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[put dir] Failed to create empty file dir.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to put dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Added \&quot;%s\&quot;&quot;</span>, new_file_name);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (root_id);
    g_free (canon_path);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a2e0e32263ad7bbeaa4ab13a62135c46a_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a2e0e32263ad7bbeaa4ab13a62135c46a_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a2e0e32263ad7bbeaa4ab13a62135c46a_cgraph" id="server_2repo-mgr_8h_a2e0e32263ad7bbeaa4ab13a62135c46a_cgraph">
<area shape="rect" id="node3" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f" title="should_ignore_file" alt="" coords="352,5,477,35"/><area shape="rect" id="node5" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f" title="seaf_dirent_new" alt="" coords="356,59,473,88"/><area shape="rect" id="node7" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1" title="dir_version_from_repo_version" alt="" coords="316,112,513,141"/><area shape="rect" id="node9" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04" title="seaf_repo_manager_merge_virtual_repo" alt="" coords="288,165,541,195"/><area shape="rect" id="node17" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="357,219,472,248"/><area shape="rect" id="node19" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="348,272,481,301"/><area shape="rect" id="node21" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a" title="seaf_dirent_free" alt="" coords="357,325,472,355"/><area shape="rect" id="node11" href="fuse_2Backups_2repo-mgr_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c" title="seaf_repo_manager_is_virtual_repo" alt="" coords="636,112,863,141"/><area shape="rect" id="node13" href="server_2gc_2Backups_2repo-mgr_8c.html#a0e2fecd8fae5355455342e43f6588967" title="seaf_repo_manager_get_virtual_repo_ids_by_origin" alt="" coords="591,165,908,195"/><area shape="rect" id="node15" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="696,219,803,248"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a3128bd2930667427a22976b6a2b85743"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_post_file" ref="a3128bd2930667427a22976b6a2b85743" args="(SeafRepoManager *mgr, const char *repo_id, const char *temp_file_path, const char *parent_dir, const char *file_name, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a3128bd2930667427a22976b6a2b85743">seaf_repo_manager_post_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>temp_file_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Add a new file in a repo. The content of the file is stored in a temporary file. : id of the repo : path of the temporary file : the directory to add this file : the name of the new file : author of this operation </p>

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l00598">598</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="index_8h.html#a96e76167c968d38441e90ee0488ee4aa">sha1</a>[20];
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    <span class="keywordtype">char</span> hex[41];
    <span class="keywordtype">int</span> ret = 0;

    <span class="keywordflow">if</span> (g_access (temp_file_path, R_OK) != 0) {
        seaf_warning (<span class="stringliteral">&quot;[post file] File %s doesn&#39;t exist or not readable.\n&quot;</span>,
                      temp_file_path);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid input file&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    <span class="keywordflow">if</span> (!canon_path)
        canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (file_name, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[post file] Invalid filename %s.\n&quot;</span>, file_name);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid filename&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (strstr (parent_dir, <span class="stringliteral">&quot;//&quot;</span>) != NULL) {
        seaf_warning (<span class="stringliteral">&quot;[post file] parent_dir cantains // sequence.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid parent dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }
    
    <span class="comment">/* Write blocks. */</span>
    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> key[32], iv[16];
        <span class="keywordflow">if</span> (<a class="code" href="passwd-mgr_8c.html#a4f5b6064abbc55dff4873b288e4ea834">seaf_passwd_manager_get_decrypt_key_raw</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa6154751a20cdaa84110e1a8370c1164">passwd_mgr</a>,
                                                     repo_id, user,
                                                     key, iv) &lt; 0) {
            seaf_warning (<span class="stringliteral">&quot;Passwd for repo %s is not set.\n&quot;</span>, repo_id);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;Passwd is not set&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
        crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>, key, iv);
    }

    gint64 <a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a>;
    <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#af41e85bce809b9f05ed5b20ac5eeb745">seaf_fs_manager_index_blocks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                      repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                      temp_file_path,
                                      sha1, &amp;size, crypt, TRUE) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;failed to index blocks&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to index blocks&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a>(sha1, hex, 20);
    new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                hex, <a class="code" href="Backups_2repo-op_8c.html#a68c7bdf3d604f5310c1a353eab98692f">STD_FILE_MODE</a>, file_name,
                                (gint64)time(NULL), user, size);

    root_id = do_post_file (repo,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[post file] Failed to put file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to put file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Added \&quot;%s\&quot;&quot;</span>, file_name);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (root_id);
    g_free (canon_path);
    g_free (crypt);

    <span class="keywordflow">if</span> (ret == 0)
        update_repo_size(repo_id);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a3128bd2930667427a22976b6a2b85743_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a3128bd2930667427a22976b6a2b85743_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a3128bd2930667427a22976b6a2b85743_cgraph" id="server_2repo-mgr_8h_a3128bd2930667427a22976b6a2b85743_cgraph">
<area shape="rect" id="node3" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f" title="should_ignore_file" alt="" coords="327,5,452,35"/><area shape="rect" id="node5" href="passwd-mgr_8c.html#a4f5b6064abbc55dff4873b288e4ea834" title="seaf_passwd_manager_get_decrypt_key_raw" alt="" coords="247,59,532,88"/><area shape="rect" id="node7" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228" title="seafile_crypt_new" alt="" coords="327,112,452,141"/><area shape="rect" id="node9" href="fs-mgr_8c.html#af41e85bce809b9f05ed5b20ac5eeb745" title="seaf_fs_manager_index_blocks" alt="" coords="287,165,492,195"/><area shape="rect" id="node29" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09" title="rawdata_to_hex" alt="" coords="332,219,447,248"/><area shape="rect" id="node31" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f" title="seaf_dirent_new" alt="" coords="331,272,448,301"/><area shape="rect" id="node33" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1" title="dir_version_from_repo_version" alt="" coords="291,325,488,355"/><area shape="rect" id="node35" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04" title="seaf_repo_manager_merge_virtual_repo" alt="" coords="263,379,516,408"/><area shape="rect" id="node43" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="332,432,447,461"/><area shape="rect" id="node45" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="323,485,456,515"/><area shape="rect" id="node47" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a" title="seaf_dirent_free" alt="" coords="332,539,447,568"/><area shape="rect" id="node11" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299" title="seaf_stat" alt="" coords="704,85,779,115"/><area shape="rect" id="node13" href="fs-mgr_8c.html#a056e47c5aca021aae437a764b3bc7c29" title="calculate_chunk_size" alt="" coords="668,139,815,168"/><area shape="rect" id="node15" href="fs-mgr_8c.html#a7182f3f9fdba2447f48c1978deea35d5" title="seafile_write_chunk" alt="" coords="673,192,809,221"/><area shape="rect" id="node19" href="cdc_8c.html#ab0a7b062dc6ce4e3f4963c6cad019e8e" title="filename_chunk_cdc" alt="" coords="671,245,812,275"/><area shape="rect" id="node17" href="seafile-crypt_8c.html#a153a2146ed90b98ccdb91da4bc343016" title="seafile_encrypt" alt="" coords="951,192,1060,221"/><area shape="rect" id="node21" href="seafile-4_81_82_2lib_2utils_8c.html#ad154e736c3751fe880395dff55fab739" title="seaf_util_open" alt="" coords="952,245,1059,275"/><area shape="rect" id="node23" href="cdc_8c.html#a80122178012f79fd76191c3a4787ec82" title="file_chunk_cdc" alt="" coords="951,299,1060,328"/><area shape="rect" id="node25" href="seafile-4_81_82_2lib_2utils_8c.html#a09f0677ad28b98b7a85bcda57f71e7c8" title="seaf_fstat" alt="" coords="1109,272,1189,301"/><area shape="rect" id="node27" href="seafile-4_81_82_2lib_2utils_8c.html#a05f0eae648599d413d03103758473e30" title="readn" alt="" coords="1123,325,1176,355"/><area shape="rect" id="node37" href="fuse_2Backups_2repo-mgr_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c" title="seaf_repo_manager_is_virtual_repo" alt="" coords="628,325,855,355"/><area shape="rect" id="node39" href="server_2gc_2Backups_2repo-mgr_8c.html#a0e2fecd8fae5355455342e43f6588967" title="seaf_repo_manager_get_virtual_repo_ids_by_origin" alt="" coords="583,379,900,408"/><area shape="rect" id="node41" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="688,432,795,461"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a0d6750947e09a7c4f4eb2146147e9db1"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_post_file_blocks" ref="a0d6750947e09a7c4f4eb2146147e9db1" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *file_name, const char *blockids_json, const char *paths_json, const char *user, gint64 file_size, int replace_existed, char **new_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a0d6750947e09a7c4f4eb2146147e9db1">seaf_repo_manager_post_file_blocks</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>blockids_json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>paths_json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gint64&#160;</td>
          <td class="paramname"><em>file_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>replace_existed</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>new_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l01099">1099</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="index_8h.html#a96e76167c968d38441e90ee0488ee4aa">sha1</a>[20];
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    GList *blockids = NULL, *paths = NULL, *ptr;
    <span class="keywordtype">char</span> hex[41];
    <span class="keywordtype">int</span> ret = 0;

    blockids = json_to_file_list (blockids_json);
    paths = json_to_file_list (paths_json);
    <span class="keywordflow">if</span> (g_list_length(blockids) != g_list_length(paths)) {
        seaf_warning (<span class="stringliteral">&quot;[post-blks] Invalid blockids or paths.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Invalid files&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">for</span> (ptr = paths; ptr; ptr = ptr-&gt;next) {
        <span class="keywordtype">char</span> *temp_file_path = ptr-&gt;data;
        <span class="keywordflow">if</span> (g_access (temp_file_path, R_OK) != 0) {
            seaf_warning (<span class="stringliteral">&quot;[post-blks] File block %s doesn&#39;t exist or not readable.\n&quot;</span>,
                          temp_file_path);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                         <span class="stringliteral">&quot;Invalid input file&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    <span class="keywordflow">if</span> (!canon_path)
        canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (file_name, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[post-blks] Invalid filename %s.\n&quot;</span>, file_name);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid filename&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (strstr (parent_dir, <span class="stringliteral">&quot;//&quot;</span>) != NULL) {
        seaf_warning (<span class="stringliteral">&quot;[post-blks] parent_dir cantains // sequence.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid parent dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Write blocks. */</span>
    <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#a562e73b605551b411fc8ccd333e26d36">seaf_fs_manager_index_file_blocks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                           repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                           paths,
                                           blockids, sha1, <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;Failed to index file blocks&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to index blocks&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a>(sha1, hex, 20);
    new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                hex, <a class="code" href="Backups_2repo-op_8c.html#a68c7bdf3d604f5310c1a353eab98692f">STD_FILE_MODE</a>, file_name,
                                (gint64)time(NULL), user, <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>);

    root_id = do_post_file_replace (repo, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                    canon_path, replace_existed, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[post-blks] Failed to post file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to put file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    *new_id = g_strdup(hex);
    snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Added \&quot;%s\&quot;&quot;</span>, file_name);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0)
        ret = -1;

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (blockids);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (paths);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (root_id);
    g_free (canon_path);

    <span class="keywordflow">if</span> (ret == 0)
        update_repo_size(repo_id);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a0d6750947e09a7c4f4eb2146147e9db1_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a0d6750947e09a7c4f4eb2146147e9db1_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a0d6750947e09a7c4f4eb2146147e9db1_cgraph" id="server_2repo-mgr_8h_a0d6750947e09a7c4f4eb2146147e9db1_cgraph">
<area shape="rect" id="node3" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f" title="should_ignore_file" alt="" coords="343,5,468,35"/><area shape="rect" id="node5" href="fs-mgr_8c.html#a562e73b605551b411fc8ccd333e26d36" title="seaf_fs_manager_index_file_blocks" alt="" coords="291,59,520,88"/><area shape="rect" id="node7" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09" title="rawdata_to_hex" alt="" coords="348,112,463,141"/><area shape="rect" id="node9" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f" title="seaf_dirent_new" alt="" coords="347,165,464,195"/><area shape="rect" id="node11" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1" title="dir_version_from_repo_version" alt="" coords="307,219,504,248"/><area shape="rect" id="node13" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="348,272,463,301"/><area shape="rect" id="node15" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="339,325,472,355"/><area shape="rect" id="node17" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="352,379,459,408"/><area shape="rect" id="node19" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a" title="seaf_dirent_free" alt="" coords="348,432,463,461"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a248a05b4a54ff2d9302d0779cbcc3542"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_post_multi_files" ref="a248a05b4a54ff2d9302d0779cbcc3542" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *filenames_json, const char *paths_json, const char *user, int replace_existed, char **new_ids, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#ae7346d14d7ad21fef1537bf44b50273e">seaf_repo_manager_post_multi_files</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>filenames_json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>paths_json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>replace_existed</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>new_ids</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l00950">950</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    GList *filenames = NULL, *paths = NULL, *id_list = NULL, *name_list = NULL,
        *size_list = NULL, *ptr;
    <span class="keywordtype">char</span> *filename, *path;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="index_8h.html#a96e76167c968d38441e90ee0488ee4aa">sha1</a>[20];
    GString *buf = g_string_new (NULL);
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt = NULL;
    <span class="keywordtype">char</span> hex[41];
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    canon_path = get_canonical_path (parent_dir);

    <span class="comment">/* Decode file name and tmp file paths from json. */</span>
    filenames = json_to_file_list (filenames_json);
    paths = json_to_file_list (paths_json);
    <span class="keywordflow">if</span> (!filenames || !paths) {
        seaf_warning (<span class="stringliteral">&quot;[post files] Invalid filenames or paths.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Invalid files&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Check inputs. */</span>
    <span class="keywordflow">for</span> (ptr = filenames; ptr; ptr = ptr-&gt;next) {
        filename = ptr-&gt;data;
        <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (filename, NULL)) {
            seaf_warning (<span class="stringliteral">&quot;[post files] Invalid filename %s.\n&quot;</span>, filename);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile_8h.html#a9bfa592ef51a797800aae08840640fc8">POST_FILE_ERR_FILENAME</a>,
                         <span class="stringliteral">&quot;%s&quot;</span>, filename);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    <span class="keywordflow">if</span> (strstr (parent_dir, <span class="stringliteral">&quot;//&quot;</span>) != NULL) {
        seaf_warning (<span class="stringliteral">&quot;[post file] parent_dir cantains // sequence.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid parent dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Index tmp files and get file id list. */</span>
    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> key[32], iv[16];
        <span class="keywordflow">if</span> (<a class="code" href="passwd-mgr_8c.html#a4f5b6064abbc55dff4873b288e4ea834">seaf_passwd_manager_get_decrypt_key_raw</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa6154751a20cdaa84110e1a8370c1164">passwd_mgr</a>,
                                                     repo_id, user,
                                                     key, iv) &lt; 0) {
            seaf_warning (<span class="stringliteral">&quot;Passwd for repo %s is not set.\n&quot;</span>, repo_id);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;Passwd is not set&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
        crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>, key, iv);
    }

    gint64 *<a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a>;
    <span class="keywordflow">for</span> (ptr = paths; ptr; ptr = ptr-&gt;next) {
        path = ptr-&gt;data;

        size = g_new (gint64, 1);
        <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#af41e85bce809b9f05ed5b20ac5eeb745">seaf_fs_manager_index_blocks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                          repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                          path, sha1, size, crypt, TRUE) &lt; 0) {
            seaf_warning (<span class="stringliteral">&quot;failed to index blocks&quot;</span>);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;Failed to index blocks&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }

        <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a>(sha1, hex, 20);
        id_list = g_list_prepend (id_list, g_strdup(hex));
        size_list = g_list_prepend (size_list, size);
    }
    id_list = g_list_reverse (id_list);
    size_list = g_list_reverse (size_list);

    <span class="comment">/* Add the files to parent dir and commit. */</span>
    root_id = do_post_multi_files (repo, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path,
                                   filenames, id_list, size_list, user,
                                   replace_existed, &amp;name_list);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[post file] Failed to put file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>,
                     <span class="stringliteral">&quot;Failed to put file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    guint len = g_list_length (filenames);
    <span class="keywordflow">if</span> (len &gt; 1)
        g_string_printf (buf, <span class="stringliteral">&quot;Added \&quot;%s\&quot; and %u more files.&quot;</span>,
                         (<span class="keywordtype">char</span> *)(filenames-&gt;data), len - 1);
    <span class="keywordflow">else</span>
        g_string_printf (buf, <span class="stringliteral">&quot;Added \&quot;%s\&quot;.&quot;</span>, (<span class="keywordtype">char</span> *)(filenames-&gt;data));

    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf-&gt;str, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

    <span class="keywordflow">if</span> (ret_json)
        *ret_json = format_json_ret (name_list, id_list, size_list);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (filenames);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (paths);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (id_list);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (name_list);
    <span class="keywordflow">for</span> (ptr = size_list; ptr; ptr = ptr-&gt;next)
        g_free (ptr-&gt;data);
    g_list_free (size_list);
    g_string_free (buf, TRUE);
    g_free (root_id);
    g_free (canon_path);
    g_free (crypt);

    <span class="keywordflow">if</span> (ret == 0)
        update_repo_size(repo_id);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a248a05b4a54ff2d9302d0779cbcc3542_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a248a05b4a54ff2d9302d0779cbcc3542_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a248a05b4a54ff2d9302d0779cbcc3542_cgraph" id="server_2repo-mgr_8h_a248a05b4a54ff2d9302d0779cbcc3542_cgraph">
<area shape="rect" id="node3" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f" title="should_ignore_file" alt="" coords="369,5,495,35"/><area shape="rect" id="node5" href="passwd-mgr_8c.html#a4f5b6064abbc55dff4873b288e4ea834" title="seaf_passwd_manager_get_decrypt_key_raw" alt="" coords="289,59,575,88"/><area shape="rect" id="node7" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228" title="seafile_crypt_new" alt="" coords="369,112,495,141"/><area shape="rect" id="node9" href="fs-mgr_8c.html#af41e85bce809b9f05ed5b20ac5eeb745" title="seaf_fs_manager_index_blocks" alt="" coords="329,165,535,195"/><area shape="rect" id="node29" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09" title="rawdata_to_hex" alt="" coords="375,219,489,248"/><area shape="rect" id="node31" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04" title="seaf_repo_manager_merge_virtual_repo" alt="" coords="305,272,559,301"/><area shape="rect" id="node37" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="731,352,837,381"/><area shape="rect" id="node39" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="375,376,489,405"/><area shape="rect" id="node41" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="365,429,499,459"/><area shape="rect" id="node11" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299" title="seaf_stat" alt="" coords="747,32,821,61"/><area shape="rect" id="node13" href="fs-mgr_8c.html#a056e47c5aca021aae437a764b3bc7c29" title="calculate_chunk_size" alt="" coords="711,85,857,115"/><area shape="rect" id="node15" href="fs-mgr_8c.html#a7182f3f9fdba2447f48c1978deea35d5" title="seafile_write_chunk" alt="" coords="716,139,852,168"/><area shape="rect" id="node19" href="cdc_8c.html#ab0a7b062dc6ce4e3f4963c6cad019e8e" title="filename_chunk_cdc" alt="" coords="713,192,855,221"/><area shape="rect" id="node17" href="seafile-crypt_8c.html#a153a2146ed90b98ccdb91da4bc343016" title="seafile_encrypt" alt="" coords="993,139,1103,168"/><area shape="rect" id="node21" href="seafile-4_81_82_2lib_2utils_8c.html#ad154e736c3751fe880395dff55fab739" title="seaf_util_open" alt="" coords="995,192,1101,221"/><area shape="rect" id="node23" href="cdc_8c.html#a80122178012f79fd76191c3a4787ec82" title="file_chunk_cdc" alt="" coords="993,245,1103,275"/><area shape="rect" id="node25" href="seafile-4_81_82_2lib_2utils_8c.html#a09f0677ad28b98b7a85bcda57f71e7c8" title="seaf_fstat" alt="" coords="1152,219,1232,248"/><area shape="rect" id="node27" href="seafile-4_81_82_2lib_2utils_8c.html#a05f0eae648599d413d03103758473e30" title="readn" alt="" coords="1165,272,1219,301"/><area shape="rect" id="node33" href="fuse_2Backups_2repo-mgr_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c" title="seaf_repo_manager_is_virtual_repo" alt="" coords="671,245,897,275"/><area shape="rect" id="node35" href="server_2gc_2Backups_2repo-mgr_8c.html#a0e2fecd8fae5355455342e43f6588967" title="seaf_repo_manager_get_virtual_repo_ids_by_origin" alt="" coords="625,299,943,328"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a46c094895964e060809372262c9b9923"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_put_file" ref="a46c094895964e060809372262c9b9923" args="(SeafRepoManager *mgr, const char *repo_id, const char *temp_file_path, const char *parent_dir, const char *file_name, const char *user, const char *head_id, char **new_file_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a46c094895964e060809372262c9b9923">seaf_repo_manager_put_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>temp_file_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>head_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>new_file_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Update an existing file in a repo : same as seaf_repo_manager_post_file : the commit id for the original file version. It's optional. If it's NULL, the current repo head will be used. : The return location of the new file id </p>

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l02688">2688</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="index_8h.html#a96e76167c968d38441e90ee0488ee4aa">sha1</a>[20];
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    <span class="keywordtype">char</span> hex[41];
    <span class="keywordtype">char</span> *old_file_id = NULL, *fullpath = NULL;
    <span class="keywordtype">int</span> ret = 0;

    <span class="keywordflow">if</span> (g_access (temp_file_path, R_OK) != 0) {
        seaf_warning (<span class="stringliteral">&quot;[put file] File %s doesn&#39;t exist or not readable.\n&quot;</span>,
                      temp_file_path);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid input file&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <span class="keyword">const</span> <span class="keywordtype">char</span> *base = head_id ? head_id : repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>;
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, base);

    <span class="keywordflow">if</span> (!canon_path)
        canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (file_name, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[put file] Invalid filename %s.\n&quot;</span>, file_name);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid filename&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (strstr (parent_dir, <span class="stringliteral">&quot;//&quot;</span>) != NULL) {
        seaf_warning (<span class="stringliteral">&quot;[put file] parent_dir cantains // sequence.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid parent dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }
    
    <a class="code" href="Backups_2repo-op_8c.html#a5b81d4727cc3ed61fabaf57e9ec58fbc">FAIL_IF_FILE_NOT_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, file_name, NULL);

    <span class="comment">/* Write blocks. */</span>
    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> key[32], iv[16];
        <span class="keywordflow">if</span> (<a class="code" href="passwd-mgr_8c.html#a4f5b6064abbc55dff4873b288e4ea834">seaf_passwd_manager_get_decrypt_key_raw</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa6154751a20cdaa84110e1a8370c1164">passwd_mgr</a>,
                                                     repo_id, user,
                                                     key, iv) &lt; 0) {
            seaf_warning (<span class="stringliteral">&quot;Passwd for repo %s is not set.\n&quot;</span>, repo_id);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;Passwd is not set&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
        crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>, key, iv);
    }

    gint64 <a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a>;
    <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#af41e85bce809b9f05ed5b20ac5eeb745">seaf_fs_manager_index_blocks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                      repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                      temp_file_path,
                                      sha1, &amp;size, crypt, TRUE) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;failed to index blocks&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to index blocks&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }
        
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a>(sha1, hex, 20);
    new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                hex, <a class="code" href="Backups_2repo-op_8c.html#a68c7bdf3d604f5310c1a353eab98692f">STD_FILE_MODE</a>, file_name,
                                (gint64)time(NULL), user, size);

    <span class="keywordflow">if</span> (!fullpath)
        fullpath = g_build_filename(parent_dir, file_name, NULL);

    old_file_id = <a class="code" href="fs-mgr_8c.html#a60a96b2445ab49d626baac6b16e75fe9">seaf_fs_manager_path_to_obj_id</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                  head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                                  fullpath, NULL, NULL);

    <span class="keywordflow">if</span> (g_strcmp0(old_file_id, new_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>) == 0) {
        <span class="keywordflow">if</span> (new_file_id)
            *new_file_id = g_strdup(new_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
        <span class="keywordflow">goto</span> out;
    }

    root_id = do_put_file (repo, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[put file] Failed to put file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to put file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Modified \&quot;%s\&quot;&quot;</span>, file_name);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id, user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;       
    }

    <span class="keywordflow">if</span> (new_file_id)
        *new_file_id = g_strdup(new_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (root_id);
    g_free (canon_path);
    g_free (crypt);
    g_free (old_file_id);
    g_free (fullpath);

    <span class="keywordflow">if</span> (ret == 0) {
        update_repo_size (repo_id);
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a46c094895964e060809372262c9b9923_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a46c094895964e060809372262c9b9923_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a46c094895964e060809372262c9b9923_cgraph" id="server_2repo-mgr_8h_a46c094895964e060809372262c9b9923_cgraph">
<area shape="rect" id="node3" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f" title="should_ignore_file" alt="" coords="321,5,447,35"/><area shape="rect" id="node5" href="passwd-mgr_8c.html#a4f5b6064abbc55dff4873b288e4ea834" title="seaf_passwd_manager_get_decrypt_key_raw" alt="" coords="241,59,527,88"/><area shape="rect" id="node7" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228" title="seafile_crypt_new" alt="" coords="321,112,447,141"/><area shape="rect" id="node9" href="fs-mgr_8c.html#af41e85bce809b9f05ed5b20ac5eeb745" title="seaf_fs_manager_index_blocks" alt="" coords="281,165,487,195"/><area shape="rect" id="node29" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09" title="rawdata_to_hex" alt="" coords="327,219,441,248"/><area shape="rect" id="node31" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f" title="seaf_dirent_new" alt="" coords="325,272,443,301"/><area shape="rect" id="node33" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1" title="dir_version_from_repo_version" alt="" coords="285,325,483,355"/><area shape="rect" id="node35" href="fs-mgr_8c.html#a60a96b2445ab49d626baac6b16e75fe9" title="seaf_fs_manager_path_to_obj_id" alt="" coords="277,379,491,408"/><area shape="rect" id="node48" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a" title="seaf_dirent_free" alt="" coords="1211,431,1325,460"/><area shape="rect" id="node51" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04" title="seaf_repo_manager_merge_virtual_repo" alt="" coords="257,483,511,512"/><area shape="rect" id="node59" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="327,536,441,565"/><area shape="rect" id="node61" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="317,589,451,619"/><area shape="rect" id="node11" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299" title="seaf_stat" alt="" coords="699,59,773,88"/><area shape="rect" id="node13" href="fs-mgr_8c.html#a056e47c5aca021aae437a764b3bc7c29" title="calculate_chunk_size" alt="" coords="663,112,809,141"/><area shape="rect" id="node15" href="fs-mgr_8c.html#a7182f3f9fdba2447f48c1978deea35d5" title="seafile_write_chunk" alt="" coords="668,165,804,195"/><area shape="rect" id="node19" href="cdc_8c.html#ab0a7b062dc6ce4e3f4963c6cad019e8e" title="filename_chunk_cdc" alt="" coords="665,219,807,248"/><area shape="rect" id="node17" href="seafile-crypt_8c.html#a153a2146ed90b98ccdb91da4bc343016" title="seafile_encrypt" alt="" coords="987,164,1096,193"/><area shape="rect" id="node21" href="seafile-4_81_82_2lib_2utils_8c.html#ad154e736c3751fe880395dff55fab739" title="seaf_util_open" alt="" coords="988,217,1095,247"/><area shape="rect" id="node23" href="cdc_8c.html#a80122178012f79fd76191c3a4787ec82" title="file_chunk_cdc" alt="" coords="987,271,1096,300"/><area shape="rect" id="node25" href="seafile-4_81_82_2lib_2utils_8c.html#a09f0677ad28b98b7a85bcda57f71e7c8" title="seaf_fstat" alt="" coords="1228,217,1308,247"/><area shape="rect" id="node27" href="seafile-4_81_82_2lib_2utils_8c.html#a05f0eae648599d413d03103758473e30" title="readn" alt="" coords="1241,271,1295,300"/><area shape="rect" id="node37" href="fs-mgr_8c.html#a08103ffc3a5cd19b70167404c39ce3e4" title="seaf_fs_manager_get_seafdir" alt="" coords="945,325,1137,355"/><area shape="rect" id="node43" href="fs-mgr_8c.html#a033b8831db7345eec0ff09216b63593d" title="seaf_fs_manager_get_seafdir_by_path" alt="" coords="613,328,859,357"/><area shape="rect" id="node46" href="fs-mgr_8c.html#ae04d3c4669cd7b0fc691cd2da6dc2de1" title="seaf_dir_free" alt="" coords="993,379,1089,408"/><area shape="rect" id="node39" href="obj-store_8c.html#a6e93a0214f9cb8a7fc837a2bc3a3c529" title="seaf_obj_store_read_obj" alt="" coords="1187,324,1349,353"/><area shape="rect" id="node41" href="fs-mgr_8c.html#a6875a119da427bb1cd9796eee916b703" title="seaf_dir_from_data" alt="" coords="1201,377,1335,407"/><area shape="rect" id="node53" href="fuse_2Backups_2repo-mgr_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c" title="seaf_repo_manager_is_virtual_repo" alt="" coords="623,483,849,512"/><area shape="rect" id="node55" href="server_2gc_2Backups_2repo-mgr_8c.html#a0e2fecd8fae5355455342e43f6588967" title="seaf_repo_manager_get_virtual_repo_ids_by_origin" alt="" coords="577,536,895,565"/><area shape="rect" id="node57" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="683,589,789,619"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aad15cfaf3210b47e9f59a481073aafbc"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_put_file_blocks" ref="aad15cfaf3210b47e9f59a481073aafbc" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *file_name, const char *blockids_json, const char *paths_json, const char *user, const char *head_id, gint64 file_size, char **new_file_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#aad15cfaf3210b47e9f59a481073aafbc">seaf_repo_manager_put_file_blocks</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>blockids_json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>paths_json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>head_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gint64&#160;</td>
          <td class="paramname"><em>file_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>new_file_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l02938">2938</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="index_8h.html#a96e76167c968d38441e90ee0488ee4aa">sha1</a>[20];
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    <span class="keywordtype">char</span> hex[41];
    GList *blockids = NULL, *paths = NULL, *ptr;
    <span class="keywordtype">char</span> *old_file_id = NULL, *fullpath = NULL;
    <span class="keywordtype">int</span> ret = 0;

    blockids = json_to_file_list (blockids_json);
    paths = json_to_file_list (paths_json);
    <span class="keywordflow">if</span> (g_list_length(blockids) != g_list_length(paths)) {
        seaf_warning (<span class="stringliteral">&quot;[put-blks] Invalid blockids or paths.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Invalid files&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }


    <span class="keywordflow">for</span> (ptr = paths; ptr; ptr = ptr-&gt;next) {
        <span class="keywordtype">char</span> *temp_file_path = ptr-&gt;data;
        <span class="keywordflow">if</span> (g_access (temp_file_path, R_OK) != 0) {
            seaf_warning (<span class="stringliteral">&quot;[put-blks] File block %s doesn&#39;t exist or not readable.\n&quot;</span>,
                          temp_file_path);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                         <span class="stringliteral">&quot;Invalid input file&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <span class="keyword">const</span> <span class="keywordtype">char</span> *base = head_id ? head_id : repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>;
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, base);

    <span class="keywordflow">if</span> (!canon_path)
        canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (file_name, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[put-blks] Invalid filename %s.\n&quot;</span>, file_name);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid filename&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (strstr (parent_dir, <span class="stringliteral">&quot;//&quot;</span>) != NULL) {
        seaf_warning (<span class="stringliteral">&quot;[put-blks] parent_dir cantains // sequence.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid parent dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="Backups_2repo-op_8c.html#a5b81d4727cc3ed61fabaf57e9ec58fbc">FAIL_IF_FILE_NOT_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, file_name, NULL);

    <span class="comment">/* Write blocks. */</span>
    <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#a562e73b605551b411fc8ccd333e26d36">seaf_fs_manager_index_file_blocks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                           repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                           paths,
                                           blockids, sha1, <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;failed to index blocks&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to index blocks&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a>(sha1, hex, 20);
    new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                hex, <a class="code" href="Backups_2repo-op_8c.html#a68c7bdf3d604f5310c1a353eab98692f">STD_FILE_MODE</a>, file_name,
                                (gint64)time(NULL), user, <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>);

    <span class="keywordflow">if</span> (!fullpath)
        fullpath = g_build_filename(parent_dir, file_name, NULL);

    old_file_id = <a class="code" href="fs-mgr_8c.html#a60a96b2445ab49d626baac6b16e75fe9">seaf_fs_manager_path_to_obj_id</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                  head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                                  fullpath, NULL, NULL);

    <span class="keywordflow">if</span> (g_strcmp0(old_file_id, new_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>) == 0) {
        <span class="keywordflow">if</span> (new_file_id)
            *new_file_id = g_strdup(new_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
        <span class="keywordflow">goto</span> out;
    }

    root_id = do_put_file (repo, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[put-blks] Failed to put file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to put file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Modified \&quot;%s\&quot;&quot;</span>, file_name);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id, user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (new_file_id)
        *new_file_id = g_strdup(new_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (blockids);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (paths);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (root_id);
    g_free (canon_path);
    g_free (old_file_id);
    g_free (fullpath);

    <span class="keywordflow">if</span> (ret == 0) {
        update_repo_size (repo_id);
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_aad15cfaf3210b47e9f59a481073aafbc_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_aad15cfaf3210b47e9f59a481073aafbc_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_aad15cfaf3210b47e9f59a481073aafbc_cgraph" id="server_2repo-mgr_8h_aad15cfaf3210b47e9f59a481073aafbc_cgraph">
<area shape="rect" id="node3" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f" title="should_ignore_file" alt="" coords="337,5,463,35"/><area shape="rect" id="node5" href="fs-mgr_8c.html#a562e73b605551b411fc8ccd333e26d36" title="seaf_fs_manager_index_file_blocks" alt="" coords="285,59,515,88"/><area shape="rect" id="node7" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09" title="rawdata_to_hex" alt="" coords="343,112,457,141"/><area shape="rect" id="node9" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f" title="seaf_dirent_new" alt="" coords="341,165,459,195"/><area shape="rect" id="node11" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1" title="dir_version_from_repo_version" alt="" coords="301,219,499,248"/><area shape="rect" id="node13" href="fs-mgr_8c.html#a60a96b2445ab49d626baac6b16e75fe9" title="seaf_fs_manager_path_to_obj_id" alt="" coords="293,272,507,301"/><area shape="rect" id="node26" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a" title="seaf_dirent_free" alt="" coords="1125,299,1240,328"/><area shape="rect" id="node29" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="343,376,457,405"/><area shape="rect" id="node31" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="333,429,467,459"/><area shape="rect" id="node33" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="347,483,453,512"/><area shape="rect" id="node15" href="fs-mgr_8c.html#a08103ffc3a5cd19b70167404c39ce3e4" title="seaf_fs_manager_get_seafdir" alt="" coords="860,219,1052,248"/><area shape="rect" id="node21" href="fs-mgr_8c.html#a033b8831db7345eec0ff09216b63593d" title="seaf_fs_manager_get_seafdir_by_path" alt="" coords="564,221,809,251"/><area shape="rect" id="node24" href="fs-mgr_8c.html#ae04d3c4669cd7b0fc691cd2da6dc2de1" title="seaf_dir_free" alt="" coords="908,272,1004,301"/><area shape="rect" id="node17" href="obj-store_8c.html#a6e93a0214f9cb8a7fc837a2bc3a3c529" title="seaf_obj_store_read_obj" alt="" coords="1101,179,1264,208"/><area shape="rect" id="node19" href="fs-mgr_8c.html#a6875a119da427bb1cd9796eee916b703" title="seaf_dir_from_data" alt="" coords="1116,232,1249,261"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a3f3921eba68da813d0d1a583c8923396"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_query_access_property" ref="a3f3921eba68da813d0d1a583c8923396" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="server_2repo-mgr_8h.html#a3f3921eba68da813d0d1a583c8923396">seaf_repo_manager_query_access_property</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02189">2189</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    <span class="keywordtype">char</span> *ret = NULL;

    sql =  <span class="stringliteral">&quot;SELECT access_property FROM WebAP WHERE repo_id=?&quot;</span>;
 
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, get_ap, &amp;ret,
                                       1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;DB error when get access property for repo %s.\n&quot;</span>, repo_id);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a3f3921eba68da813d0d1a583c8923396_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a3f3921eba68da813d0d1a583c8923396_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a3f3921eba68da813d0d1a583c8923396_cgraph" id="server_2repo-mgr_8h_a3f3921eba68da813d0d1a583c8923396_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="333,32,544,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="593,5,775,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="603,59,765,88"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a3f3921eba68da813d0d1a583c8923396_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a3f3921eba68da813d0d1a583c8923396_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a3f3921eba68da813d0d1a583c8923396_icgraph" id="server_2repo-mgr_8h_a3f3921eba68da813d0d1a583c8923396_icgraph">
<area shape="rect" id="node3" href="server_2repo-mgr_8h.html#aaabba29e879e5e4e53ff753e86b5427b" title="seaf_repo_manager_set_access_property" alt="" coords="333,5,597,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a921cbac599e1c80869659e545d99b62f"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_remove_group_repos" ref="a921cbac599e1c80869659e545d99b62f" args="(SeafRepoManager *mgr, int group_id, const char *owner, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a921cbac599e1c80869659e545d99b62f">seaf_repo_manager_remove_group_repos</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>group_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02444">2444</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;
    <span class="keywordtype">int</span> rc;

    <span class="keywordflow">if</span> (!owner) {
        rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db, <span class="stringliteral">&quot;DELETE FROM RepoGroup WHERE group_id=?&quot;</span>,
                                      1, <span class="stringliteral">&quot;int&quot;</span>, group_id);
    } <span class="keywordflow">else</span> {
        rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db,
                                      <span class="stringliteral">&quot;DELETE FROM RepoGroup WHERE group_id=? AND &quot;</span>
                                      <span class="stringliteral">&quot;user_name = ?&quot;</span>,
                                      2, <span class="stringliteral">&quot;int&quot;</span>, group_id, <span class="stringliteral">&quot;string&quot;</span>, owner);
    }

    <span class="keywordflow">return</span> rc;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a921cbac599e1c80869659e545d99b62f_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a921cbac599e1c80869659e545d99b62f_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a921cbac599e1c80869659e545d99b62f_cgraph" id="server_2repo-mgr_8h_a921cbac599e1c80869659e545d99b62f_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5" title="seaf_db_statement_query" alt="" coords="319,32,489,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="540,5,721,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="549,59,712,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ae68e4b6427bb239b697e515c8617cbfb"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_rename_file" ref="ae68e4b6427bb239b697e515c8617cbfb" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *oldname, const char *newname, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#ae68e4b6427bb239b697e515c8617cbfb">seaf_repo_manager_rename_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>oldname</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>newname</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l02510">2510</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *root_id = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">int</span> <a class="code" href="index_8h.html#ac1b4d694fc07a39e06900e82872aac7f">mode</a> = 0;
    <span class="keywordtype">int</span> ret = 0;

    <span class="keywordflow">if</span> (strcmp(oldname, newname) == 0)
        <span class="keywordflow">return</span> 0;
    
    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
    
    <span class="keywordflow">if</span> (!canon_path)
        canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (newname, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[rename file] Invalid filename %s.\n&quot;</span>, newname);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid filename&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="Backups_2repo-op_8c.html#a5b81d4727cc3ed61fabaf57e9ec58fbc">FAIL_IF_FILE_NOT_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, oldname, &amp;mode);
    <a class="code" href="Backups_2repo-op_8c.html#a897aab32c75a36b188922b8726831ccf">FAIL_IF_FILE_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                        head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, newname, NULL);

    root_id = do_rename_file (repo, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path,
                              oldname, newname);
    <span class="keywordflow">if</span> (!root_id) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;faile to rename file %s&quot;</span>, oldname);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    <span class="keywordflow">if</span> (S_ISDIR(mode)) {
        snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Renamed directory \&quot;%s\&quot;&quot;</span>, oldname);
    } <span class="keywordflow">else</span> {
        snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Renamed \&quot;%s\&quot;&quot;</span>, oldname);
    }

    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a1cd4a8c70076d40d2a778dda774a2263">seaf_repo_manager_cleanup_virtual_repos</a> (mgr, repo_id);
    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (head_commit);
    g_free (canon_path);
    g_free (root_id);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_ae68e4b6427bb239b697e515c8617cbfb_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_ae68e4b6427bb239b697e515c8617cbfb_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_ae68e4b6427bb239b697e515c8617cbfb_cgraph" id="server_2repo-mgr_8h_ae68e4b6427bb239b697e515c8617cbfb_cgraph">
<area shape="rect" id="node3" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f" title="should_ignore_file" alt="" coords="336,244,461,273"/><area shape="rect" id="node5" href="server_2repo-mgr_8h.html#a1cd4a8c70076d40d2a778dda774a2263" title="seaf_repo_manager_cleanup_virtual_repos" alt="" coords="264,297,533,327"/><area shape="rect" id="node36" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="684,377,799,407"/><area shape="rect" id="node38" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="675,431,808,460"/><area shape="rect" id="node40" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04" title="seaf_repo_manager_merge_virtual_repo" alt="" coords="272,511,525,540"/><area shape="rect" id="node7" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6" title="seaf_repo_manager_get_repo" alt="" coords="645,217,837,247"/><area shape="rect" id="node9" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f" title="seaf_commit_manager_get_commit" alt="" coords="627,271,856,300"/><area shape="rect" id="node13" href="server_2repo-mgr_8h.html#a5e7e933b737fca2ccdb657124812fc90" title="seaf_repo_manager_get_virtual_info_by_origin" alt="" coords="596,324,887,353"/><area shape="rect" id="node21" href="fs-mgr_8c.html#a033b8831db7345eec0ff09216b63593d" title="seaf_fs_manager_get_seafdir_by_path" alt="" coords="619,60,864,89"/><area shape="rect" id="node29" href="fs-mgr_8c.html#ae04d3c4669cd7b0fc691cd2da6dc2de1" title="seaf_dir_free" alt="" coords="1007,112,1103,141"/><area shape="rect" id="node34" href="server_2gc_2Backups_2repo-mgr_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a" title="seaf_virtual_repo_info_free" alt="" coords="652,164,831,193"/><area shape="rect" id="node11" href="commit-mgr_8c.html#a2b1cc305cf40cb64c341a0e64d0fe921" title="seaf_commit_ref" alt="" coords="996,271,1113,300"/><area shape="rect" id="node15" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="949,324,1160,353"/><area shape="rect" id="node17" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="1209,297,1391,327"/><area shape="rect" id="node19" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="1219,351,1381,380"/><area shape="rect" id="node23" href="fs-mgr_8c.html#a08103ffc3a5cd19b70167404c39ce3e4" title="seaf_fs_manager_get_seafdir" alt="" coords="959,59,1151,88"/><area shape="rect" id="node25" href="obj-store_8c.html#a6e93a0214f9cb8a7fc837a2bc3a3c529" title="seaf_obj_store_read_obj" alt="" coords="1219,59,1381,88"/><area shape="rect" id="node27" href="fs-mgr_8c.html#a6875a119da427bb1cd9796eee916b703" title="seaf_dir_from_data" alt="" coords="1233,5,1367,35"/><area shape="rect" id="node31" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a" title="seaf_dirent_free" alt="" coords="1243,112,1357,141"/><area shape="rect" id="node42" href="fuse_2Backups_2repo-mgr_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c" title="seaf_repo_manager_is_virtual_repo" alt="" coords="628,484,855,513"/><area shape="rect" id="node44" href="server_2gc_2Backups_2repo-mgr_8c.html#a0e2fecd8fae5355455342e43f6588967" title="seaf_repo_manager_get_virtual_repo_ids_by_origin" alt="" coords="583,537,900,567"/><area shape="rect" id="node46" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="688,591,795,620"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a4b2497e6cdde50c4ce3cb642370e06eb"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_repo_exists" ref="a4b2497e6cdde50c4ce3cb642370e06eb" args="(SeafRepoManager *manager, const gchar *id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gboolean <a class="el" href="server_2repo-mgr_8h.html#a4b2497e6cdde50c4ce3cb642370e06eb">seaf_repo_manager_repo_exists</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const gchar *&#160;</td>
          <td class="paramname"><em>id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l04228">4228</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *res;

    <span class="keywordflow">if</span> (pthread_rwlock_rdlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;[repo mgr] failed to lock repo cache.\n&quot;</span>);
        <span class="keywordflow">return</span> FALSE;
    }

    res = g_hash_table_lookup (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a46e78181430977b311346c02e5738286">repo_hash</a>, <span class="keywordtype">id</span>);

    pthread_rwlock_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);

    <span class="keywordflow">if</span> (res &amp;&amp; !res-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>)
        <span class="keywordflow">return</span> TRUE;
    
    <span class="keywordflow">return</span> FALSE;
}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a4b2497e6cdde50c4ce3cb642370e06eb_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a4b2497e6cdde50c4ce3cb642370e06eb_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a4b2497e6cdde50c4ce3cb642370e06eb_icgraph" id="server_2repo-mgr_8h_a4b2497e6cdde50c4ce3cb642370e06eb_icgraph">
<area shape="rect" id="node3" href="rpc-deprecated_8c.html#a5bb007b4c99262f41df4510520153dee" title="seafile_set_repo_lantoken" alt="" coords="300,5,473,35"/><area shape="rect" id="node5" href="server_2repo-mgr_8h.html#ad9feaba8f2f873b6685560fd86f4c40d" title="seaf_repo_manager_create_enc_repo" alt="" coords="268,59,505,88"/><area shape="rect" id="node7" href="daemon_2gc-core_8h.html#aba2eeeb61b0f8fe34dfbdc8fc23067b3" title="gc_core_run" alt="" coords="340,112,433,141"/><area shape="rect" id="node11" href="transfer-mgr_8h.html#a7c1421651b69da119fab63e9f1d5bf55" title="seaf_transfer_manager_add_download" alt="" coords="264,165,509,195"/><area shape="rect" id="node9" href="seafserv-gc_8c.html#a0ddf1224851353fc92bfbff6f499fa97" title="main" alt="" coords="557,112,608,141"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a4db874916fe89f6b839e389d74034288"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_restore_repo_from_trash" ref="a4db874916fe89f6b839e389d74034288" args="(SeafRepoManager *mgr, const char *repo_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a4db874916fe89f6b839e389d74034288">seaf_repo_manager_restore_repo_from_trash</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02074">2074</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    SeafileTrashRepo *repo = NULL;
    <span class="keywordtype">int</span> ret = 0;
    gboolean exists = FALSE;
    gboolean db_err;

    repo = <a class="code" href="server_2Backups_2repo-mgr_8c.html#a8326627abe60741e456d4acf6e5ac244">seaf_repo_manager_get_repo_from_trash</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (!repo) {
        seaf_warning (<span class="stringliteral">&quot;Repo %.8s not found in trash.\n&quot;</span>, repo_id);
        <span class="keywordflow">return</span> -1;
    }

    <a class="code" href="structSeafDBTrans.html">SeafDBTrans</a> *trans = <a class="code" href="seaf-db_8c.html#a3f672ef795004a79886871b1d7e36862">seaf_db_begin_transaction</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>);

    exists = <a class="code" href="seaf-db_8c.html#a85906acba812801fd6ef8137920d3dcc">seaf_db_trans_check_for_existence</a> (trans,
                                                <span class="stringliteral">&quot;SELECT 1 FROM Repo WHERE repo_id=?&quot;</span>,
                                                &amp;db_err, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);

    <span class="keywordflow">if</span> (!exists) {
        ret = <a class="code" href="seaf-db_8c.html#abfa65542f46d16df51de1e82fefcebb3">seaf_db_trans_query</a> (trans,
                                   <span class="stringliteral">&quot;INSERT INTO Repo(repo_id) VALUES (?)&quot;</span>,
                                   1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0;
        <span class="keywordflow">if</span> (ret &lt; 0) {
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;DB error: Insert Repo.&quot;</span>);
            <a class="code" href="seaf-db_8c.html#a2786c0aa2d6f3629bc9ed8960e8de288">seaf_db_rollback</a> (trans);
            <a class="code" href="seaf-db_8c.html#af47f83c610aa48fca8f2f667fe2d096d">seaf_db_trans_close</a> (trans);
            <span class="keywordflow">goto</span> out;
        }
    }

    exists = <a class="code" href="seaf-db_8c.html#a85906acba812801fd6ef8137920d3dcc">seaf_db_trans_check_for_existence</a> (trans,
                                                <span class="stringliteral">&quot;SELECT 1 FROM RepoOwner WHERE repo_id=?&quot;</span>,
                                                &amp;db_err, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);

    <span class="keywordflow">if</span> (!exists) {
        ret = <a class="code" href="seaf-db_8c.html#abfa65542f46d16df51de1e82fefcebb3">seaf_db_trans_query</a> (trans,
                                   <span class="stringliteral">&quot;INSERT INTO RepoOwner VALUES (?, ?)&quot;</span>,
                                   2, <span class="stringliteral">&quot;string&quot;</span>, repo_id,
                                   <span class="stringliteral">&quot;string&quot;</span>, seafile_trash_repo_get_owner_id(repo));
        <span class="keywordflow">if</span> (ret &lt; 0) {
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;DB error: Insert Repo Owner.&quot;</span>);
            <a class="code" href="seaf-db_8c.html#a2786c0aa2d6f3629bc9ed8960e8de288">seaf_db_rollback</a> (trans);
            <a class="code" href="seaf-db_8c.html#af47f83c610aa48fca8f2f667fe2d096d">seaf_db_trans_close</a> (trans);
            <span class="keywordflow">goto</span> out;
        }
    }

    ret = <a class="code" href="seaf-db_8c.html#abfa65542f46d16df51de1e82fefcebb3">seaf_db_trans_query</a> (trans,
                               <span class="stringliteral">&quot;DELETE FROM RepoTrash WHERE repo_id = ?&quot;</span>,
                               1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
    <span class="keywordflow">if</span> (ret &lt; 0) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;DB error: delete from RepoTrash.&quot;</span>);
        <a class="code" href="seaf-db_8c.html#a2786c0aa2d6f3629bc9ed8960e8de288">seaf_db_rollback</a> (trans);
        <a class="code" href="seaf-db_8c.html#af47f83c610aa48fca8f2f667fe2d096d">seaf_db_trans_close</a> (trans);
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a8f67506e6cc01be4aa0a2a9fc5b08bd2">seaf_db_commit</a> (trans) &lt; 0) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;DB error: Failed to commit.&quot;</span>);
        <a class="code" href="seaf-db_8c.html#a2786c0aa2d6f3629bc9ed8960e8de288">seaf_db_rollback</a> (trans);
        ret = -1;
    }

    <a class="code" href="seaf-db_8c.html#af47f83c610aa48fca8f2f667fe2d096d">seaf_db_trans_close</a> (trans);

out:
    g_object_unref (repo);
    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a4db874916fe89f6b839e389d74034288_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a4db874916fe89f6b839e389d74034288_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a4db874916fe89f6b839e389d74034288_cgraph" id="server_2repo-mgr_8h_a4db874916fe89f6b839e389d74034288_cgraph">
<area shape="rect" id="node3" href="server_2Backups_2repo-mgr_8c.html#a8326627abe60741e456d4acf6e5ac244" title="seaf_repo_manager_get_repo_from_trash" alt="" coords="340,32,601,61"/><area shape="rect" id="node11" href="seaf-db_8c.html#a3f672ef795004a79886871b1d7e36862" title="seaf_db_begin_transaction" alt="" coords="383,85,559,115"/><area shape="rect" id="node13" href="seaf-db_8c.html#a85906acba812801fd6ef8137920d3dcc" title="seaf_db_trans_check_for_existence" alt="" coords="356,139,585,168"/><area shape="rect" id="node15" href="seaf-db_8c.html#abfa65542f46d16df51de1e82fefcebb3" title="seaf_db_trans_query" alt="" coords="400,192,541,221"/><area shape="rect" id="node17" href="seaf-db_8c.html#a2786c0aa2d6f3629bc9ed8960e8de288" title="seaf_db_rollback" alt="" coords="411,245,531,275"/><area shape="rect" id="node19" href="seaf-db_8c.html#af47f83c610aa48fca8f2f667fe2d096d" title="seaf_db_trans_close" alt="" coords="400,299,541,328"/><area shape="rect" id="node21" href="seaf-db_8c.html#a8f67506e6cc01be4aa0a2a9fc5b08bd2" title="seaf_db_commit" alt="" coords="412,352,529,381"/><area shape="rect" id="node5" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224" title="seaf_db_statement_foreach_row" alt="" coords="651,32,861,61"/><area shape="rect" id="node7" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="911,5,1092,35"/><area shape="rect" id="node9" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="920,59,1083,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="abf48f3efee4705f32fa8f3a95098921e"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_revert_dir" ref="abf48f3efee4705f32fa8f3a95098921e" args="(SeafRepoManager *mgr, const char *repo_id, const char *old_commit_id, const char *dir_path, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#abf48f3efee4705f32fa8f3a95098921e">seaf_repo_manager_revert_dir</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>old_commit_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dir_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l03496">3496</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL, *old_commit = NULL;
    <span class="keywordtype">char</span> *parent_dir = NULL, *dirname = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *old_dent = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL, *root_id = NULL;
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    gboolean parent_dir_exist = FALSE;
    gboolean revert_to_root = FALSE;
    gboolean skipped = FALSE;
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    <span class="comment">/* If old_commit_id is head commit, do nothing. */</span>
    <span class="keywordflow">if</span> (strcmp(repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>, old_commit_id) == 0) {
        <a class="code" href="seafile-4_81_82_2lib_2include_8h.html#ae5a5c3cadbc1f6e2363d25fc0fb46084">g_debug</a> (<span class="stringliteral">&quot;[revert dir] commit is head, do nothing\n&quot;</span>);
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (!old_commit) {
        <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(old_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, old_commit_id);
        <span class="keywordflow">if</span> (strcmp(old_commit-&gt;repo_id, repo_id) != 0) {
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a53023377dfe455de5672c199e9f2e831">SEAF_ERR_BAD_COMMIT</a>,
                         <span class="stringliteral">&quot;bad commit id&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    <span class="keywordflow">if</span> (!canon_path) {
        canon_path = get_canonical_path (dir_path);

        parent_dir  = g_path_get_dirname(canon_path);
        dirname = g_path_get_basename(canon_path);

        old_dent = get_dirent_by_path (repo, old_commit-&gt;root_id,
                                       parent_dir, dirname, error);
        <span class="keywordflow">if</span> (*error) {
            seaf_warning (<span class="stringliteral">&quot;[revert dir] error: %s\n&quot;</span>, (*error)-&gt;message);
            g_clear_error (error);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;internal error&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    parent_dir_exist = detect_path_exist (repo,
                                          head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                          parent_dir, error);
    <span class="keywordflow">if</span> (*error) {
        seaf_warning (<span class="stringliteral">&quot;[revert dir] error: %s\n&quot;</span>, (*error)-&gt;message);
        g_clear_error (error);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;internal error&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }
    
    <span class="keywordflow">if</span> (!parent_dir_exist) {
        <span class="comment">/* When parent dir does not exist, revert this file to root dir. */</span>
        revert_to_root = TRUE;
        root_id = revert_dir (repo,
                              head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                              <span class="stringliteral">&quot;/&quot;</span>,
                              old_dent,
                              &amp;skipped, error);
    } <span class="keywordflow">else</span> {
        revert_to_root = FALSE;
        root_id = revert_dir (repo,
                              head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                              parent_dir,
                              old_dent,
                              &amp;skipped, error);
    }

    <span class="keywordflow">if</span> (*error) {
        seaf_warning (<span class="stringliteral">&quot;[revert dir] error: %s\n&quot;</span>, (*error)-&gt;message);
        g_clear_error (error);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;internal error&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (skipped) {
        <span class="keywordflow">goto</span> out;
    }
    
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[revert dir] Failed to revert dir.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to revert dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Recovered deleted directory \&quot;%s\&quot;&quot;</span>, dirname);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (head_commit);
    <span class="keywordflow">if</span> (old_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (old_commit);

    g_free (root_id);
    g_free (parent_dir);
    g_free (dirname);

    g_free (canon_path);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (old_dent);

<span class="preprocessor">#define REVERT_TO_ROOT              0x1</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (ret == 0) {
        <span class="keywordflow">if</span> (revert_to_root)
            ret |= <a class="code" href="Backups_2repo-op_8c.html#a65c9627aee501057c2e4968adbd34c71">REVERT_TO_ROOT</a>;
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_abf48f3efee4705f32fa8f3a95098921e_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_abf48f3efee4705f32fa8f3a95098921e_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_abf48f3efee4705f32fa8f3a95098921e_cgraph" id="server_2repo-mgr_8h_abf48f3efee4705f32fa8f3a95098921e_cgraph">
<area shape="rect" id="node3" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04" title="seaf_repo_manager_merge_virtual_repo" alt="" coords="251,59,504,88"/><area shape="rect" id="node11" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="320,112,435,141"/><area shape="rect" id="node13" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="311,165,444,195"/><area shape="rect" id="node15" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a" title="seaf_dirent_free" alt="" coords="320,219,435,248"/><area shape="rect" id="node5" href="fuse_2Backups_2repo-mgr_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c" title="seaf_repo_manager_is_virtual_repo" alt="" coords="599,5,825,35"/><area shape="rect" id="node7" href="server_2gc_2Backups_2repo-mgr_8c.html#a0e2fecd8fae5355455342e43f6588967" title="seaf_repo_manager_get_virtual_repo_ids_by_origin" alt="" coords="553,59,871,88"/><area shape="rect" id="node9" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="659,112,765,141"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a246dc6695f1ee0c1806de54109848096"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_revert_file" ref="a246dc6695f1ee0c1806de54109848096" args="(SeafRepoManager *mgr, const char *repo_id, const char *commit_id, const char *path, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a352b05f8d991d13b5d5e1f0ee1b7616c">seaf_repo_manager_revert_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>commit_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l03281">3281</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL, *old_commit = NULL;
    <span class="keywordtype">char</span> *parent_dir = NULL, *filename = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *old_dent = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL, *root_id = NULL;
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> time_str[512];
    gboolean parent_dir_exist = FALSE;
    gboolean revert_to_root = FALSE;
    gboolean skipped = FALSE;
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    <span class="comment">/* If old_commit_id is head commit, do nothing. */</span>
    <span class="keywordflow">if</span> (strcmp(repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>, old_commit_id) == 0) {
        <a class="code" href="seafile-4_81_82_2lib_2include_8h.html#ae5a5c3cadbc1f6e2363d25fc0fb46084">g_debug</a> (<span class="stringliteral">&quot;[revert file] commit is head, do nothing\n&quot;</span>);
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (!old_commit) {
        <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(old_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, old_commit_id);
        <span class="keywordflow">if</span> (strcmp(old_commit-&gt;repo_id, repo_id) != 0) {
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a53023377dfe455de5672c199e9f2e831">SEAF_ERR_BAD_COMMIT</a>,
                         <span class="stringliteral">&quot;bad commit id&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    <span class="keywordflow">if</span> (!canon_path) {
        canon_path = get_canonical_path (file_path);
        <span class="keywordflow">if</span> (canon_path[strlen(canon_path) -1 ] == <span class="charliteral">&#39;/&#39;</span>) {
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a53023377dfe455de5672c199e9f2e831">SEAF_ERR_BAD_COMMIT</a>,
                         <span class="stringliteral">&quot;bad target file path&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }

        parent_dir  = g_path_get_dirname(canon_path);
        filename = g_path_get_basename(canon_path);

        old_dent = get_dirent_by_path (repo, old_commit-&gt;root_id,
                                       parent_dir, filename, error);
        <span class="keywordflow">if</span> (*error) {
            seaf_warning (<span class="stringliteral">&quot;[revert file] error: %s\n&quot;</span>, (*error)-&gt;message);
            g_clear_error (error);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;internal error&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    parent_dir_exist = detect_path_exist (repo,
                                          head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                          parent_dir, error);
    <span class="keywordflow">if</span> (*error) {
        seaf_warning (<span class="stringliteral">&quot;[revert file] error: %s\n&quot;</span>, (*error)-&gt;message);
        g_clear_error (error);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;internal error&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }
    
    <span class="keywordflow">if</span> (!parent_dir_exist) {
        <span class="comment">/* When parent dir does not exist, revert this file to root dir. */</span>
        revert_to_root = TRUE;
        root_id = revert_file_to_root (repo,
                                       head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                       old_dent,
                                       &amp;skipped, error);
    } <span class="keywordflow">else</span> {
        revert_to_root = FALSE;
        root_id = revert_file_to_parent_dir (repo,
                                             head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, parent_dir,
                                             old_dent,
                                             &amp;skipped, error);
    }

    <span class="keywordflow">if</span> (*error) {
        seaf_warning (<span class="stringliteral">&quot;[revert file] error: %s\n&quot;</span>, (*error)-&gt;message);
        g_clear_error (error);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;internal error&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (skipped) {
        <span class="keywordflow">goto</span> out;
    }
    
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[revert file] Failed to revert file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to revert file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
<span class="preprocessor">#ifndef WIN32</span>
<span class="preprocessor"></span>    strftime (time_str, <span class="keyword">sizeof</span>(time_str), <span class="stringliteral">&quot;%F %T&quot;</span>,
              localtime((time_t *)(&amp;old_commit-&gt;ctime)));
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>    strftime (time_str, <span class="keyword">sizeof</span>(time_str), <span class="stringliteral">&quot;%Y-%m-%d %H:%M:%S&quot;</span>,
              localtime((time_t *)(&amp;old_commit-&gt;ctime)));
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Reverted file \&quot;%s\&quot; to status at %s&quot;</span>, filename, time_str);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (head_commit);
    <span class="keywordflow">if</span> (old_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (old_commit);

    g_free (root_id);
    g_free (parent_dir);
    g_free (filename);

    g_free (canon_path);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (old_dent);

<span class="preprocessor">#define REVERT_TO_ROOT              0x1</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (ret == 0) {
        <span class="keywordflow">if</span> (revert_to_root)
            ret |= <a class="code" href="Backups_2repo-op_8c.html#a65c9627aee501057c2e4968adbd34c71">REVERT_TO_ROOT</a>;
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a246dc6695f1ee0c1806de54109848096_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a246dc6695f1ee0c1806de54109848096_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a246dc6695f1ee0c1806de54109848096_cgraph" id="server_2repo-mgr_8h_a246dc6695f1ee0c1806de54109848096_cgraph">
<area shape="rect" id="node3" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04" title="seaf_repo_manager_merge_virtual_repo" alt="" coords="253,59,507,88"/><area shape="rect" id="node11" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="323,112,437,141"/><area shape="rect" id="node13" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="313,165,447,195"/><area shape="rect" id="node15" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a" title="seaf_dirent_free" alt="" coords="323,219,437,248"/><area shape="rect" id="node5" href="fuse_2Backups_2repo-mgr_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c" title="seaf_repo_manager_is_virtual_repo" alt="" coords="601,5,828,35"/><area shape="rect" id="node7" href="server_2gc_2Backups_2repo-mgr_8c.html#a0e2fecd8fae5355455342e43f6588967" title="seaf_repo_manager_get_virtual_repo_ids_by_origin" alt="" coords="556,59,873,88"/><area shape="rect" id="node9" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="661,112,768,141"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a75071fddf41a1371d4f89be8d2b59b88"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_revert_on_server" ref="a75071fddf41a1371d4f89be8d2b59b88" args="(SeafRepoManager *mgr, const char *repo_id, const char *commit_id, const char *user_name, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a75071fddf41a1371d4f89be8d2b59b88">seaf_repo_manager_revert_on_server</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>commit_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l04321">4321</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit = NULL, *new_commit = NULL;
    <span class="keywordtype">char</span> desc[512];
    <span class="keywordtype">int</span> ret = 0;

retry:
    repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (!repo) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;No such repo&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    commit = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                             repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, 
                                             commit_id);
    <span class="keywordflow">if</span> (!commit) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Commit doesn&#39;t exist&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

<span class="preprocessor">#ifndef WIN32</span>
<span class="preprocessor"></span>    strftime (desc, <span class="keyword">sizeof</span>(desc), <span class="stringliteral">&quot;Reverted repo to status at %F %T.&quot;</span>, 
              localtime((time_t *)(&amp;commit-&gt;<a class="code" href="struct__SeafCommit.html#ae3f1657ab475921889a1e9c74b94e7a2">ctime</a>)));
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>    strftime (desc, <span class="keyword">sizeof</span>(desc), <span class="stringliteral">&quot;Reverted repo to status at %Y-%m-%d %H:%M:%S.&quot;</span>,
              localtime((time_t *)(&amp;commit-&gt;<a class="code" href="struct__SeafCommit.html#ae3f1657ab475921889a1e9c74b94e7a2">ctime</a>)));
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    new_commit = <a class="code" href="commit-mgr_8c.html#afe68dfa15b1bbd8557b044b1b1b58dc2">seaf_commit_new</a> (NULL, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                  user_name, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>,
                                  desc, 0);

    new_commit-&gt;parent_id = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
    <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a39a9a41ffdfc324f3c935251d9e14d51">seaf_repo_to_commit</a> (repo, new_commit);

    <span class="keywordflow">if</span> (<a class="code" href="commit-mgr_8c.html#a7c138604e615440b65741b77e71248c6">seaf_commit_manager_add_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>, new_commit) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="branch-mgr_8c.html#a7a776ebd084d2335050c68d9a2e10c18">seaf_branch_set_commit</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>, new_commit-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
    <span class="keywordflow">if</span> (seaf_branch_manager_test_and_update_branch (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>,
                                                    repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>,
                                                    new_commit-&gt;parent_id) &lt; 0)
    {
        seaf_warning (<span class="stringliteral">&quot;[revert] Concurrent branch update, retry.\n&quot;</span>);
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (new_commit);
        repo = NULL;
        commit = new_commit = NULL;
        <span class="keywordflow">goto</span> retry;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (new_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (new_commit);
    <span class="keywordflow">if</span> (commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);

    <span class="keywordflow">if</span> (ret == 0) {
        update_repo_size (repo_id);
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a75071fddf41a1371d4f89be8d2b59b88_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a75071fddf41a1371d4f89be8d2b59b88_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a75071fddf41a1371d4f89be8d2b59b88_cgraph" id="server_2repo-mgr_8h_a75071fddf41a1371d4f89be8d2b59b88_cgraph">
<area shape="rect" id="node3" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6" title="seaf_repo_manager_get_repo" alt="" coords="324,5,516,35"/><area shape="rect" id="node5" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f" title="seaf_commit_manager_get_commit" alt="" coords="305,59,535,88"/><area shape="rect" id="node9" href="commit-mgr_8c.html#afe68dfa15b1bbd8557b044b1b1b58dc2" title="seaf_commit_new" alt="" coords="356,112,484,141"/><area shape="rect" id="node11" href="daemon_2Backups_2repo-mgr_8c.html#a39a9a41ffdfc324f3c935251d9e14d51" title="seaf_repo_to_commit" alt="" coords="347,165,493,195"/><area shape="rect" id="node13" href="commit-mgr_8c.html#a7c138604e615440b65741b77e71248c6" title="seaf_commit_manager_add_commit" alt="" coords="304,219,536,248"/><area shape="rect" id="node15" href="branch-mgr_8c.html#a7a776ebd084d2335050c68d9a2e10c18" title="seaf_branch_set_commit" alt="" coords="336,272,504,301"/><area shape="rect" id="node17" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="363,325,477,355"/><area shape="rect" id="node19" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="353,379,487,408"/><area shape="rect" id="node21" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04" title="seaf_repo_manager_merge_virtual_repo" alt="" coords="293,432,547,461"/><area shape="rect" id="node7" href="commit-mgr_8c.html#a2b1cc305cf40cb64c341a0e64d0fe921" title="seaf_commit_ref" alt="" coords="696,59,813,88"/><area shape="rect" id="node23" href="fuse_2Backups_2repo-mgr_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c" title="seaf_repo_manager_is_virtual_repo" alt="" coords="641,379,868,408"/><area shape="rect" id="node25" href="server_2gc_2Backups_2repo-mgr_8c.html#a0e2fecd8fae5355455342e43f6588967" title="seaf_repo_manager_get_virtual_repo_ids_by_origin" alt="" coords="596,432,913,461"/><area shape="rect" id="node27" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2" title="string_list_free" alt="" coords="701,485,808,515"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aaabba29e879e5e4e53ff753e86b5427b"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_set_access_property" ref="aaabba29e879e5e4e53ff753e86b5427b" args="(SeafRepoManager *mgr, const char *repo_id, const char *ap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#aaabba29e879e5e4e53ff753e86b5427b">seaf_repo_manager_set_access_property</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>ap</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02154">2154</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> rc;

    <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a3f3921eba68da813d0d1a583c8923396">seaf_repo_manager_query_access_property</a> (mgr, repo_id) == NULL) {
        rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                      <span class="stringliteral">&quot;INSERT INTO WebAP VALUES (?, ?)&quot;</span>,
                                      2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;string&quot;</span>, ap);
    } <span class="keywordflow">else</span> {
        rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                      <span class="stringliteral">&quot;UPDATE WebAP SET access_property=? &quot;</span>
                                      <span class="stringliteral">&quot;WHERE repo_id=?&quot;</span>,
                                      2, <span class="stringliteral">&quot;string&quot;</span>, ap, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
    }

    <span class="keywordflow">if</span> (rc &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;DB error when set access property for repo %s, %s.\n&quot;</span>, repo_id, ap);
        <span class="keywordflow">return</span> -1;
    }
    
    <span class="keywordflow">return</span> 0;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_aaabba29e879e5e4e53ff753e86b5427b_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_aaabba29e879e5e4e53ff753e86b5427b_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_aaabba29e879e5e4e53ff753e86b5427b_cgraph" id="server_2repo-mgr_8h_aaabba29e879e5e4e53ff753e86b5427b_cgraph">
<area shape="rect" id="node3" href="server_2Backups_2repo-mgr_8c.html#a3f3921eba68da813d0d1a583c8923396" title="seaf_repo_manager_query_access_property" alt="" coords="319,5,596,35"/><area shape="rect" id="node5" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5" title="seaf_db_statement_query" alt="" coords="372,59,543,88"/><area shape="rect" id="node7" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="647,32,828,61"/><area shape="rect" id="node9" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="656,85,819,115"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a6c5f4f43e7e198238b3b24dff3e9c389"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_set_group_repo_perm" ref="a6c5f4f43e7e198238b3b24dff3e9c389" args="(SeafRepoManager *mgr, const char *repo_id, int group_id, const char *permission, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a6c5f4f43e7e198238b3b24dff3e9c389">seaf_repo_manager_set_group_repo_perm</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>group_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>permission</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02304">2304</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                    <span class="stringliteral">&quot;UPDATE RepoGroup SET permission=? WHERE &quot;</span>
                                    <span class="stringliteral">&quot;repo_id=? AND group_id=?&quot;</span>,
                                    3, <span class="stringliteral">&quot;string&quot;</span>, permission, <span class="stringliteral">&quot;string&quot;</span>, repo_id,
                                    <span class="stringliteral">&quot;int&quot;</span>, group_id);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a6c5f4f43e7e198238b3b24dff3e9c389_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a6c5f4f43e7e198238b3b24dff3e9c389_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a6c5f4f43e7e198238b3b24dff3e9c389_cgraph" id="server_2repo-mgr_8h_a6c5f4f43e7e198238b3b24dff3e9c389_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5" title="seaf_db_statement_query" alt="" coords="324,32,495,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="545,5,727,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="555,59,717,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab4740f8bce8f9f3571adf0adfb63590b"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_set_inner_pub_repo" ref="ab4740f8bce8f9f3571adf0adfb63590b" args="(SeafRepoManager *mgr, const char *repo_id, const char *permission)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#ab4740f8bce8f9f3571adf0adfb63590b">seaf_repo_manager_set_inner_pub_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>permission</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02468">2468</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;
    <span class="keywordtype">char</span> sql[256];

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae183a9c45ec082962bdd361491b0a8cb">seaf_db_type</a>(db) == <a class="code" href="seaf-db_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da62ce2e8a052406ede3fcf39ec407ccf8">SEAF_DB_TYPE_PGSQL</a>) {
        gboolean err;
        snprintf(sql, <span class="keyword">sizeof</span>(sql),
                 <span class="stringliteral">&quot;SELECT repo_id FROM InnerPubRepo WHERE repo_id=&#39;%s&#39;&quot;</span>,
                 repo_id);
        <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a6410cd243563343861ba3c6c16fc06a7">seaf_db_check_for_existence</a>(db, sql, &amp;err))
            snprintf(sql, <span class="keyword">sizeof</span>(sql),
                     <span class="stringliteral">&quot;UPDATE InnerPubRepo SET permission=&#39;%s&#39; &quot;</span>
                     <span class="stringliteral">&quot;WHERE repo_id=&#39;%s&#39;&quot;</span>, permission, repo_id);
        <span class="keywordflow">else</span>
            snprintf(sql, <span class="keyword">sizeof</span>(sql),
                     <span class="stringliteral">&quot;INSERT INTO InnerPubRepo VALUES &quot;</span>
                     <span class="stringliteral">&quot;(&#39;%s&#39;, &#39;%s&#39;)&quot;</span>, repo_id, permission);
        <span class="keywordflow">if</span> (err)
            <span class="keywordflow">return</span> -1;
        <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql);
    } <span class="keywordflow">else</span> {
        <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db,
                                        <span class="stringliteral">&quot;REPLACE INTO InnerPubRepo VALUES (?, ?)&quot;</span>,
                                        2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;string&quot;</span>, permission);
    }

    <span class="keywordflow">return</span> -1;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_ab4740f8bce8f9f3571adf0adfb63590b_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_ab4740f8bce8f9f3571adf0adfb63590b_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_ab4740f8bce8f9f3571adf0adfb63590b_cgraph" id="server_2repo-mgr_8h_ab4740f8bce8f9f3571adf0adfb63590b_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae183a9c45ec082962bdd361491b0a8cb" title="seaf_db_type" alt="" coords="357,5,456,35"/><area shape="rect" id="node5" href="seaf-db_8c.html#a6410cd243563343861ba3c6c16fc06a7" title="seaf_db_check_for_existence" alt="" coords="309,59,504,88"/><area shape="rect" id="node7" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d" title="seaf_db_query" alt="" coords="353,112,460,141"/><area shape="rect" id="node9" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5" title="seaf_db_statement_query" alt="" coords="321,165,492,195"/><area shape="rect" id="node11" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="553,139,735,168"/><area shape="rect" id="node13" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="563,192,725,221"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ac78c13c68a1a9d1d025e45f4e51193ac"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_set_repo_history_limit" ref="ac78c13c68a1a9d1d025e45f4e51193ac" args="(SeafRepoManager *mgr, const char *repo_id, int days)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#ac78c13c68a1a9d1d025e45f4e51193ac">seaf_repo_manager_set_repo_history_limit</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>days</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01530">1530</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="structSeafVirtRepo.html">SeafVirtRepo</a> *vinfo;
    <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;

    vinfo = <a class="code" href="server_2gc_2Backups_2repo-mgr_8c.html#a316db228b35dde3dc88ae9dab9ec9c22">seaf_repo_manager_get_virtual_repo_info</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (vinfo) {
        <a class="code" href="server_2gc_2Backups_2repo-mgr_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a">seaf_virtual_repo_info_free</a> (vinfo);
        <span class="keywordflow">return</span> 0;
    }

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae183a9c45ec082962bdd361491b0a8cb">seaf_db_type</a>(db) == <a class="code" href="seaf-db_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da62ce2e8a052406ede3fcf39ec407ccf8">SEAF_DB_TYPE_PGSQL</a>) {
        gboolean exists, err;
        <span class="keywordtype">int</span> rc;

        exists = <a class="code" href="seaf-db_8c.html#af77a76302b3316a4d71e418de27843c4">seaf_db_statement_exists</a> (db,
                                           <span class="stringliteral">&quot;SELECT repo_id FROM RepoHistoryLimit &quot;</span>
                                           <span class="stringliteral">&quot;WHERE repo_id=?&quot;</span>,
                                           &amp;err, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
        <span class="keywordflow">if</span> (err)
            <span class="keywordflow">return</span> -1;

        <span class="keywordflow">if</span> (exists)
            rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db,
                                          <span class="stringliteral">&quot;UPDATE RepoHistoryLimit SET days=%d&quot;</span>
                                          <span class="stringliteral">&quot;WHERE repo_id=?&quot;</span>,
                                          2, <span class="stringliteral">&quot;int&quot;</span>, days, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
        <span class="keywordflow">else</span>
            rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db,
                                          <span class="stringliteral">&quot;INSERT INTO RepoHistoryLimit VALUES &quot;</span>
                                          <span class="stringliteral">&quot;(?, ?)&quot;</span>,
                                          2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;int&quot;</span>, days);
        <span class="keywordflow">return</span> rc;
    } <span class="keywordflow">else</span> {
        <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db,
                                     <span class="stringliteral">&quot;REPLACE INTO RepoHistoryLimit VALUES (?, ?)&quot;</span>,
                                     2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;int&quot;</span>, days) &lt; 0)
            <span class="keywordflow">return</span> -1;
    }

    <span class="keywordflow">return</span> 0;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_ac78c13c68a1a9d1d025e45f4e51193ac_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_ac78c13c68a1a9d1d025e45f4e51193ac_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_ac78c13c68a1a9d1d025e45f4e51193ac_cgraph" id="server_2repo-mgr_8h_ac78c13c68a1a9d1d025e45f4e51193ac_cgraph">
<area shape="rect" id="node3" href="server_2gc_2Backups_2repo-mgr_8c.html#a316db228b35dde3dc88ae9dab9ec9c22" title="seaf_repo_manager_get_virtual_repo_info" alt="" coords="327,5,588,35"/><area shape="rect" id="node5" href="server_2gc_2Backups_2repo-mgr_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a" title="seaf_virtual_repo_info_free" alt="" coords="368,59,547,88"/><area shape="rect" id="node7" href="seaf-db_8c.html#ae183a9c45ec082962bdd361491b0a8cb" title="seaf_db_type" alt="" coords="408,112,507,141"/><area shape="rect" id="node9" href="seaf-db_8c.html#af77a76302b3316a4d71e418de27843c4" title="seaf_db_statement_exists" alt="" coords="371,219,544,248"/><area shape="rect" id="node15" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5" title="seaf_db_statement_query" alt="" coords="372,165,543,195"/><area shape="rect" id="node19" href="seaf-db_8c.html#a6410cd243563343861ba3c6c16fc06a7" title="seaf_db_check_for_existence" alt="" coords="360,272,555,301"/><area shape="rect" id="node21" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d" title="seaf_db_query" alt="" coords="404,325,511,355"/><area shape="rect" id="node11" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="639,165,820,195"/><area shape="rect" id="node13" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="648,219,811,248"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a5f096821f41a339e41e9341fc0c4010d"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_set_repo_owner" ref="a5f096821f41a339e41e9341fc0c4010d" args="(SeafRepoManager *mgr, const char *repo_id, const char *email)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a5f096821f41a339e41e9341fc0c4010d">seaf_repo_manager_set_repo_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>email</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01677">1677</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;
    <span class="keywordtype">char</span> sql[256];

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae183a9c45ec082962bdd361491b0a8cb">seaf_db_type</a>(db) == <a class="code" href="seaf-db_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da62ce2e8a052406ede3fcf39ec407ccf8">SEAF_DB_TYPE_PGSQL</a>) {
        gboolean err;
        snprintf(sql, <span class="keyword">sizeof</span>(sql),
                 <span class="stringliteral">&quot;SELECT repo_id FROM RepoOwner WHERE repo_id=&#39;%s&#39;&quot;</span>, repo_id);
        <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a6410cd243563343861ba3c6c16fc06a7">seaf_db_check_for_existence</a>(db, sql, &amp;err))
            snprintf(sql, <span class="keyword">sizeof</span>(sql),
                     <span class="stringliteral">&quot;UPDATE RepoOwner SET owner_id=&#39;%s&#39; WHERE &quot;</span>
                     <span class="stringliteral">&quot;repo_id=&#39;%s&#39;&quot;</span>, email, repo_id);
        <span class="keywordflow">else</span>
            snprintf(sql, <span class="keyword">sizeof</span>(sql),
                     <span class="stringliteral">&quot;INSERT INTO RepoOwner VALUES (&#39;%s&#39;, &#39;%s&#39;)&quot;</span>,
                     repo_id, email);
        <span class="keywordflow">if</span> (err)
            <span class="keywordflow">return</span> -1;
        <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
            <span class="keywordflow">return</span> -1;
    } <span class="keywordflow">else</span> {
        <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db, <span class="stringliteral">&quot;REPLACE INTO RepoOwner VALUES (?, ?)&quot;</span>,
                                     2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;string&quot;</span>, email) &lt; 0)
            <span class="keywordflow">return</span> -1;
    }

    <span class="keywordflow">return</span> 0;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a5f096821f41a339e41e9341fc0c4010d_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a5f096821f41a339e41e9341fc0c4010d_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a5f096821f41a339e41e9341fc0c4010d_cgraph" id="server_2repo-mgr_8h_a5f096821f41a339e41e9341fc0c4010d_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae183a9c45ec082962bdd361491b0a8cb" title="seaf_db_type" alt="" coords="336,5,435,35"/><area shape="rect" id="node5" href="seaf-db_8c.html#a6410cd243563343861ba3c6c16fc06a7" title="seaf_db_check_for_existence" alt="" coords="288,59,483,88"/><area shape="rect" id="node7" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d" title="seaf_db_query" alt="" coords="332,112,439,141"/><area shape="rect" id="node9" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5" title="seaf_db_statement_query" alt="" coords="300,165,471,195"/><area shape="rect" id="node11" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="532,139,713,168"/><area shape="rect" id="node13" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="541,192,704,221"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a5f096821f41a339e41e9341fc0c4010d_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a5f096821f41a339e41e9341fc0c4010d_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a5f096821f41a339e41e9341fc0c4010d_icgraph" id="server_2repo-mgr_8h_a5f096821f41a339e41e9341fc0c4010d_icgraph">
<area shape="rect" id="node3" href="server_2repo-mgr_8h.html#a3706de93ba77e5068dba6a1dd073a0fd" title="seaf_repo_manager_create_new_repo" alt="" coords="293,5,536,35"/><area shape="rect" id="node5" href="server_2repo-mgr_8h.html#ad9feaba8f2f873b6685560fd86f4c40d" title="seaf_repo_manager_create_enc_repo" alt="" coords="296,59,533,88"/><area shape="rect" id="node7" href="virtual-repo_8c.html#a9a8dcda29ee6cd28d92c1897ad12f268" title="seaf_repo_manager_create_virtual_repo" alt="" coords="288,112,541,141"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aeeda6cf1cb41515388afd8a10c6297e1"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_set_repo_valid_since" ref="aeeda6cf1cb41515388afd8a10c6297e1" args="(SeafRepoManager *mgr, const char *repo_id, gint64 timestamp)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#aeeda6cf1cb41515388afd8a10c6297e1">seaf_repo_manager_set_repo_valid_since</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gint64&#160;</td>
          <td class="paramname"><em>timestamp</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01602">1602</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae183a9c45ec082962bdd361491b0a8cb">seaf_db_type</a>(db) == <a class="code" href="seaf-db_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da62ce2e8a052406ede3fcf39ec407ccf8">SEAF_DB_TYPE_PGSQL</a>) {
        gboolean exists, err;
        <span class="keywordtype">int</span> rc;

        exists = <a class="code" href="seaf-db_8c.html#af77a76302b3316a4d71e418de27843c4">seaf_db_statement_exists</a> (db,
                                           <span class="stringliteral">&quot;SELECT repo_id FROM RepoValidSince WHERE &quot;</span>
                                           <span class="stringliteral">&quot;repo_id=?&quot;</span>, &amp;err, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
        <span class="keywordflow">if</span> (err)
            <span class="keywordflow">return</span> -1;

        <span class="keywordflow">if</span> (exists)
            rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db,
                                          <span class="stringliteral">&quot;UPDATE RepoValidSince SET timestamp=?&quot;</span>
                                          <span class="stringliteral">&quot; WHERE repo_id=?&quot;</span>,
                                          2, <span class="stringliteral">&quot;int64&quot;</span>, timestamp, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
        <span class="keywordflow">else</span>
            rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db,
                                          <span class="stringliteral">&quot;INSERT INTO RepoValidSince VALUES &quot;</span>
                                          <span class="stringliteral">&quot;(?, ?)&quot;</span>, 2, <span class="stringliteral">&quot;string&quot;</span>, repo_id,
                                          <span class="stringliteral">&quot;int64&quot;</span>, timestamp);
        <span class="keywordflow">if</span> (rc &lt; 0)
            <span class="keywordflow">return</span> -1;
    } <span class="keywordflow">else</span> {
        <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db,
                           <span class="stringliteral">&quot;REPLACE INTO RepoValidSince VALUES (?, ?)&quot;</span>,
                           2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;int64&quot;</span>, timestamp) &lt; 0)
            <span class="keywordflow">return</span> -1;
    }

    <span class="keywordflow">return</span> 0;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_aeeda6cf1cb41515388afd8a10c6297e1_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_aeeda6cf1cb41515388afd8a10c6297e1_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_aeeda6cf1cb41515388afd8a10c6297e1_cgraph" id="server_2repo-mgr_8h_aeeda6cf1cb41515388afd8a10c6297e1_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#ae183a9c45ec082962bdd361491b0a8cb" title="seaf_db_type" alt="" coords="368,5,467,35"/><area shape="rect" id="node5" href="seaf-db_8c.html#af77a76302b3316a4d71e418de27843c4" title="seaf_db_statement_exists" alt="" coords="331,112,504,141"/><area shape="rect" id="node11" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5" title="seaf_db_statement_query" alt="" coords="332,59,503,88"/><area shape="rect" id="node15" href="seaf-db_8c.html#a6410cd243563343861ba3c6c16fc06a7" title="seaf_db_check_for_existence" alt="" coords="320,165,515,195"/><area shape="rect" id="node17" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d" title="seaf_db_query" alt="" coords="364,219,471,248"/><area shape="rect" id="node7" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="564,59,745,88"/><area shape="rect" id="node9" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="573,112,736,141"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a2e049cfa3d0546aaf51e7f6792e1467d"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_start" ref="a2e049cfa3d0546aaf51e7f6792e1467d" args="(SeafRepoManager *mgr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a2e049cfa3d0546aaf51e7f6792e1467d">seaf_repo_manager_start</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l03968">3968</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    watch_repos (mgr);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa40635ee3473d593c5edc1a9e9976cd7"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_token_peer_info_exists" ref="aa40635ee3473d593c5edc1a9e9976cd7" args="(SeafRepoManager *mgr, const char *token)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gboolean <a class="el" href="server_2repo-mgr_8h.html#aa40635ee3473d593c5edc1a9e9976cd7">seaf_repo_manager_token_peer_info_exists</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>token</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01141">1141</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    gboolean db_error = FALSE;

    <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#af77a76302b3316a4d71e418de27843c4">seaf_db_statement_exists</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                     <span class="stringliteral">&quot;SELECT token FROM RepoTokenPeerInfo WHERE token=?&quot;</span>,
                                     &amp;db_error, 1, <span class="stringliteral">&quot;string&quot;</span>, token);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_aa40635ee3473d593c5edc1a9e9976cd7_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_aa40635ee3473d593c5edc1a9e9976cd7_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_aa40635ee3473d593c5edc1a9e9976cd7_cgraph" id="server_2repo-mgr_8h_aa40635ee3473d593c5edc1a9e9976cd7_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#af77a76302b3316a4d71e418de27843c4" title="seaf_db_statement_exists" alt="" coords="332,32,505,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="556,5,737,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="565,59,728,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a4a3708ac06f2c015cc665f5ba61ee36a"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_unset_inner_pub_repo" ref="a4a3708ac06f2c015cc665f5ba61ee36a" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a4a3708ac06f2c015cc665f5ba61ee36a">seaf_repo_manager_unset_inner_pub_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l02501">2501</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                    <span class="stringliteral">&quot;DELETE FROM InnerPubRepo WHERE repo_id = ?&quot;</span>,
                                    1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a4a3708ac06f2c015cc665f5ba61ee36a_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a4a3708ac06f2c015cc665f5ba61ee36a_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a4a3708ac06f2c015cc665f5ba61ee36a_cgraph" id="server_2repo-mgr_8h_a4a3708ac06f2c015cc665f5ba61ee36a_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5" title="seaf_db_statement_query" alt="" coords="327,32,497,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="548,5,729,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="557,59,720,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a3702d0c75995d0221e33b9ba673b99fd"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_update_dir" ref="a3702d0c75995d0221e33b9ba673b99fd" args="(SeafRepoManager *mgr, const char *repo_id, const char *dir_path, const char *new_dir_id, const char *user, const char *head_id, char *new_commit_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a3702d0c75995d0221e33b9ba673b99fd">seaf_repo_manager_update_dir</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dir_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new_dir_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>head_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>new_commit_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l02854">2854</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">char</span> *parent = NULL, *dirname = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    <span class="keywordtype">char</span> *root_id = NULL;
    <span class="keywordtype">char</span> *commit_desc = NULL;
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <span class="keyword">const</span> <span class="keywordtype">char</span> *base = head_id ? head_id : repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>;
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, base);

    <span class="comment">/* Are we updating the root? */</span>
    <span class="keywordflow">if</span> (strcmp (dir_path, <span class="stringliteral">&quot;/&quot;</span>) == 0) {
        commit_desc = gen_commit_description (repo, new_dir_id, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>);
        <span class="keywordflow">if</span> (!commit_desc)
            commit_desc = g_strdup(<span class="stringliteral">&quot;Auto merge by system&quot;</span>);

        <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, new_dir_id,
                            user, commit_desc, new_commit_id, error) &lt; 0)
            ret = -1;
        g_free (commit_desc);
        <span class="keywordflow">goto</span> out;
    }

    parent = g_path_get_dirname (dir_path);
    canon_path = get_canonical_path (parent);
    g_free (parent);

    dirname = g_path_get_basename (dir_path);

    <a class="code" href="Backups_2repo-op_8c.html#a5b81d4727cc3ed61fabaf57e9ec58fbc">FAIL_IF_FILE_NOT_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, dirname, NULL);

    new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                new_dir_id, S_IFDIR, dirname,
                                (gint64)time(NULL), NULL, -1);

    root_id = do_put_file (repo, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[update dir] Failed to put file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to update dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    commit_desc = gen_commit_description (repo, root_id, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>);
    <span class="keywordflow">if</span> (!commit_desc)
        commit_desc = g_strdup(<span class="stringliteral">&quot;Auto merge by system&quot;</span>);

    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, commit_desc, new_commit_id, error) &lt; 0) {
        ret = -1;
        g_free (commit_desc);
        <span class="keywordflow">goto</span> out;
    }
    g_free (commit_desc);

out:
    <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (head_commit);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (canon_path);
    g_free (dirname);
    g_free (root_id);

    <span class="keywordflow">if</span> (ret == 0)
        update_repo_size (repo_id);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a3702d0c75995d0221e33b9ba673b99fd_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a3702d0c75995d0221e33b9ba673b99fd_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a3702d0c75995d0221e33b9ba673b99fd_cgraph" id="server_2repo-mgr_8h_a3702d0c75995d0221e33b9ba673b99fd_cgraph">
<area shape="rect" id="node3" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f" title="seaf_dirent_new" alt="" coords="297,5,415,35"/><area shape="rect" id="node5" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1" title="dir_version_from_repo_version" alt="" coords="257,59,455,88"/><area shape="rect" id="node7" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07" title="seaf_repo_unref" alt="" coords="299,112,413,141"/><area shape="rect" id="node9" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04" title="seaf_commit_unref" alt="" coords="289,165,423,195"/><area shape="rect" id="node11" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a" title="seaf_dirent_free" alt="" coords="299,219,413,248"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a33b75eede501da0a4c6100b30b9facf0"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_update_token_peer_info" ref="a33b75eede501da0a4c6100b30b9facf0" args="(SeafRepoManager *mgr, const char *token, const char *peer_ip, gint64 sync_time)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a33b75eede501da0a4c6100b30b9facf0">seaf_repo_manager_update_token_peer_info</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>token</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>peer_ip</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gint64&#160;</td>
          <td class="paramname"><em>sync_time</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l01122">1122</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> ret = 0;

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                 <span class="stringliteral">&quot;UPDATE RepoTokenPeerInfo SET &quot;</span>
                                 <span class="stringliteral">&quot;peer_ip=?, sync_time=? WHERE token=?&quot;</span>,
                                 3, <span class="stringliteral">&quot;string&quot;</span>, peer_ip,
                                 <span class="stringliteral">&quot;int64&quot;</span>, sync_time,
                                 <span class="stringliteral">&quot;string&quot;</span>, token) &lt; 0)
        ret = -1;

    <span class="keywordflow">return</span> ret;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a33b75eede501da0a4c6100b30b9facf0_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_a33b75eede501da0a4c6100b30b9facf0_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a33b75eede501da0a4c6100b30b9facf0_cgraph" id="server_2repo-mgr_8h_a33b75eede501da0a4c6100b30b9facf0_cgraph">
<area shape="rect" id="node3" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5" title="seaf_db_statement_query" alt="" coords="337,32,508,61"/><area shape="rect" id="node5" href="seaf-db_8c.html#a022621519c8205275746dafb4801013a" title="seaf_db_prepare_statement" alt="" coords="559,5,740,35"/><area shape="rect" id="node7" href="seaf-db_8c.html#a0cb484988d9e1c156227b99eba482e3c" title="seaf_db_statement_free" alt="" coords="568,59,731,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a63ab9fe4694e3d967376c911cbe2c655"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_new" ref="a63ab9fe4694e3d967376c911cbe2c655" args="(const char *id, const char *name, const char *desc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a>* <a class="el" href="server_2repo-mgr_8h.html#a63ab9fe4694e3d967376c911cbe2c655">seaf_repo_new</a> </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>desc</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00536">536</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a>* repo;

    <span class="comment">/* valid check */</span>
  
    
    repo = g_new0 (<a class="code" href="struct__SeafRepo.html">SeafRepo</a>, 1);
    memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="keywordtype">id</span>, 36);
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>[36] = <span class="charliteral">&#39;\0&#39;</span>;

    repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a> = g_strdup(<a class="code" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>);
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a> = g_strdup(desc);

    repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a> = TRUE;
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a> = 1;
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a575e562d38b7fc0adc79a6b24ea00ac1">net_browsable</a> = 0;
    pthread_mutex_init (&amp;repo-&gt;<a class="code" href="struct__SeafRepo.html#aaa93119bb8b7b6038e9feb3c3a78b0ab">lock</a>, NULL);

    <span class="keywordflow">return</span> repo;
}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a63ab9fe4694e3d967376c911cbe2c655_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a63ab9fe4694e3d967376c911cbe2c655_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a63ab9fe4694e3d967376c911cbe2c655_icgraph" id="server_2repo-mgr_8h_a63ab9fe4694e3d967376c911cbe2c655_icgraph">
<area shape="rect" id="node3" href="daemon_2repo-mgr_8h.html#ab599ba29e40bdb918ac78060d1165c2d" title="seaf_repo_manager_create_new_repo" alt="" coords="165,5,408,35"/><area shape="rect" id="node5" href="server_2repo-mgr_8h.html#a11cc1a4ecd45778ea5a10af0cb72b347" title="seaf_repo_manager_get_repo_ex" alt="" coords="180,59,393,88"/><area shape="rect" id="node7" href="server_2Backups_2repo-mgr_8c.html#aa692b1e331cad063425d676afe1ae121" title="seaf_repo_manager_get_repo_list" alt="" coords="457,5,673,35"/><area shape="rect" id="node9" href="server_2gc_2gc-core_8h.html#ab1ddc08d785efb15290a677e8e152c18" title="gc_core_run" alt="" coords="519,59,612,88"/><area shape="rect" id="node11" href="verify_8h.html#ac9054d2eed9bb3a221b531f65b5cf0f5" title="verify_repos" alt="" coords="519,112,612,141"/><area shape="rect" id="node13" href="seafserv-gc_8c.html#a0ddf1224851353fc92bfbff6f499fa97" title="main" alt="" coords="723,112,773,141"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab8f60cbbd6c35ee55ea72acbbd3a1608"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_ref" ref="ab8f60cbbd6c35ee55ea72acbbd3a1608" args="(SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="server_2repo-mgr_8h.html#ab8f60cbbd6c35ee55ea72acbbd3a1608">seaf_repo_ref</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="fuse_2Backups_2repo-mgr_8c_source.html#l00068">68</a> of file <a class="el" href="fuse_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    g_atomic_int_inc (&amp;repo-&gt;<a class="code" href="struct__SeafRepo.html#a73ff67300bff9e51d98f02e0729e569d">ref_cnt</a>);
}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_ab8f60cbbd6c35ee55ea72acbbd3a1608_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_ab8f60cbbd6c35ee55ea72acbbd3a1608_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_ab8f60cbbd6c35ee55ea72acbbd3a1608_icgraph" id="server_2repo-mgr_8h_ab8f60cbbd6c35ee55ea72acbbd3a1608_icgraph">
<area shape="rect" id="node3" href="server_2repo-mgr_8h.html#ab7eae6af688907f68212dca114549c4b" title="seaf_repo_manager_copy_file" alt="" coords="157,5,352,35"/><area shape="rect" id="node5" href="server_2repo-mgr_8h.html#a056b45d63edfafbc5287012a2a1062ec" title="seaf_repo_manager_move_file" alt="" coords="156,59,353,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a6c47d6277897f6afbe866f2755f9762d"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_set_head" ref="a6c47d6277897f6afbe866f2755f9762d" args="(SeafRepo *repo, SeafBranch *branch)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a6c47d6277897f6afbe866f2755f9762d">seaf_repo_set_head</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="branch-mgr_8h.html#a43063fab0cfaf940abc07b1cd941fb85">SeafBranch</a> *&#160;</td>
          <td class="paramname"><em>branch</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00631">631</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (save_branch_repo_map (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>, branch) &lt; 0)
        <span class="keywordflow">return</span> -1;
    set_head_common (repo, branch);
    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a39a9a41ffdfc324f3c935251d9e14d51"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_to_commit" ref="a39a9a41ffdfc324f3c935251d9e14d51" args="(SeafRepo *repo, SeafCommit *commit)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="server_2repo-mgr_8h.html#a39a9a41ffdfc324f3c935251d9e14d51">seaf_repo_to_commit</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="commit-mgr_8h.html#ab20cfcee12e164d94824e8be23c2c8ea">SeafCommit</a> *&#160;</td>
          <td class="paramname"><em>commit</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html#l00682">682</a> of file <a class="el" href="daemon_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    commit-&gt;<a class="code" href="struct__SeafCommit.html#aacd7b88f8a3e72446cd7352396eaa09e">repo_name</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>);
    commit-&gt;<a class="code" href="struct__SeafCommit.html#aa3d8e868c630cfbecbcb9158c4bbe2e4">repo_desc</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a>);
    commit-&gt;<a class="code" href="struct__SeafCommit.html#a906e77d2a658f4337437ff8694a4bfc0">encrypted</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>;
    <span class="keywordflow">if</span> (commit-&gt;<a class="code" href="struct__SeafCommit.html#a906e77d2a658f4337437ff8694a4bfc0">encrypted</a>) {
        commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>;
        <span class="keywordflow">if</span> (commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a> == 1)
            commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>);
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a> == 2) {
            commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>);
            commit-&gt;<a class="code" href="struct__SeafCommit.html#ab1d44814bc44472105aef8761656e3d7">random_key</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a83e0a2366ba320396f2deb6faa167b84">random_key</a>);
        }
    }
    commit-&gt;<a class="code" href="struct__SeafCommit.html#a383ea4a4b94417c7d9e9827d60420d64">no_local_history</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#a4710aaee11c7887df402fffa7ca6c54f">no_local_history</a>;
    commit-&gt;<a class="code" href="struct__SeafCommit.html#abc83f168ce2b43fa864522bf0ea26d6d">version</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>;
}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a39a9a41ffdfc324f3c935251d9e14d51_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a39a9a41ffdfc324f3c935251d9e14d51_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a39a9a41ffdfc324f3c935251d9e14d51_icgraph" id="server_2repo-mgr_8h_a39a9a41ffdfc324f3c935251d9e14d51_icgraph">
<area shape="rect" id="node3" href="server_2repo-mgr_8h.html#a75071fddf41a1371d4f89be8d2b59b88" title="seaf_repo_manager_revert_on_server" alt="" coords="200,5,440,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="af6bedb063685823d91f2a335c6882e07"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_unref" ref="af6bedb063685823d91f2a335c6882e07" args="(SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="server_2repo-mgr_8h.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="fuse_2Backups_2repo-mgr_8c_source.html#l00074">74</a> of file <a class="el" href="fuse_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (!repo)
        <span class="keywordflow">return</span>;

    <span class="keywordflow">if</span> (g_atomic_int_dec_and_test (&amp;repo-&gt;<a class="code" href="struct__SeafRepo.html#a73ff67300bff9e51d98f02e0729e569d">ref_cnt</a>))
        <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ad0a65514ad80789ff244b20c66460b96">seaf_repo_free</a> (repo);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_af6bedb063685823d91f2a335c6882e07_cgraph.png" border="0" usemap="#server_2repo-mgr_8h_af6bedb063685823d91f2a335c6882e07_cgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_af6bedb063685823d91f2a335c6882e07_cgraph" id="server_2repo-mgr_8h_af6bedb063685823d91f2a335c6882e07_cgraph">
<area shape="rect" id="node3" href="daemon_2Backups_2repo-mgr_8c.html#ad0a65514ad80789ff244b20c66460b96" title="seaf_repo_free" alt="" coords="169,5,276,35"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_af6bedb063685823d91f2a335c6882e07_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_af6bedb063685823d91f2a335c6882e07_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_af6bedb063685823d91f2a335c6882e07_icgraph" id="server_2repo-mgr_8h_af6bedb063685823d91f2a335c6882e07_icgraph">
<area shape="rect" id="node3" href="diff-simple_8h.html#a9e9cbe6847c88fc7bca7035f45a0a50e" title="diff_commits" alt="" coords="261,5,357,35"/><area shape="rect" id="node7" href="diff-simple_8h.html#a8c800ee63c23c5ff78d838974f678e47" title="diff_merge" alt="" coords="268,59,351,88"/><area shape="rect" id="node10" href="seafile-rpc_8h.html#aba4837db052d18cd952ad53e10ebd379" title="seafile_get_repo_list" alt="" coords="239,112,380,141"/><area shape="rect" id="node12" href="seafile-4_81_82_2common_2rpc-service_8c.html#a37949d30db3977c8fbb573881173987b" title="seafile_get_repo" alt="" coords="251,165,368,195"/><area shape="rect" id="node14" href="seafile-4_81_82_2common_2rpc-service_8c.html#a5594de7f321b08c515c465bc44e25c60" title="seafile_get_commit_list" alt="" coords="231,219,388,248"/><area shape="rect" id="node18" href="server_2gc_2repo-mgr_8h.html#a2272730e6465361e0e715fa029ace947" title="seaf_repo_manager_get_repo_list" alt="" coords="201,272,417,301"/><area shape="rect" id="node20" href="server_2gc_2gc-core_8h.html#ab1ddc08d785efb15290a677e8e152c18" title="gc_core_run" alt="" coords="263,325,356,355"/><area shape="rect" id="node22" href="server_2repo-mgr_8h.html#a3128bd2930667427a22976b6a2b85743" title="seaf_repo_manager_post_file" alt="" coords="213,379,405,408"/><area shape="rect" id="node24" href="server_2repo-mgr_8h.html#a248a05b4a54ff2d9302d0779cbcc3542" title="seaf_repo_manager_post_multi_files" alt="" coords="192,432,427,461"/><area shape="rect" id="node26" href="server_2repo-mgr_8h.html#a0d6750947e09a7c4f4eb2146147e9db1" title="seaf_repo_manager_post_file_blocks" alt="" coords="191,485,428,515"/><area shape="rect" id="node28" href="server_2repo-mgr_8h.html#ad6564c23b0e50d8a34dd425432b80db4" title="seaf_repo_manager_del_file" alt="" coords="512,589,696,619"/><area shape="rect" id="node30" href="server_2repo-mgr_8h.html#a056b45d63edfafbc5287012a2a1062ec" title="seaf_repo_manager_move_file" alt="" coords="759,589,956,619"/><area shape="rect" id="node32" href="server_2repo-mgr_8h.html#ab7eae6af688907f68212dca114549c4b" title="seaf_repo_manager_copy_file" alt="" coords="212,744,407,773"/><area shape="rect" id="node35" href="server_2repo-mgr_8h.html#aa870306d94f3e7b16e66229040590138" title="seaf_repo_manager_post_dir" alt="" coords="215,797,404,827"/><area shape="rect" id="node37" href="server_2repo-mgr_8h.html#a2e0e32263ad7bbeaa4ab13a62135c46a" title="seaf_repo_manager_post_empty_file" alt="" coords="192,851,427,880"/><area shape="rect" id="node39" href="server_2repo-mgr_8h.html#ae68e4b6427bb239b697e515c8617cbfb" title="seaf_repo_manager_rename_file" alt="" coords="499,693,709,723"/><area shape="rect" id="node41" href="server_2repo-mgr_8h.html#a46c094895964e060809372262c9b9923" title="seaf_repo_manager_put_file" alt="" coords="217,904,401,933"/><area shape="rect" id="node43" href="server_2repo-mgr_8h.html#a3702d0c75995d0221e33b9ba673b99fd" title="seaf_repo_manager_update_dir" alt="" coords="208,957,411,987"/><area shape="rect" id="node45" href="server_2repo-mgr_8h.html#aad15cfaf3210b47e9f59a481073aafbc" title="seaf_repo_manager_put_file_blocks" alt="" coords="195,1011,424,1040"/><area shape="rect" id="node47" href="server_2repo-mgr_8h.html#a246dc6695f1ee0c1806de54109848096" title="seaf_repo_manager_revert_file" alt="" coords="209,1064,409,1093"/><area shape="rect" id="node49" href="server_2repo-mgr_8h.html#abf48f3efee4705f32fa8f3a95098921e" title="seaf_repo_manager_revert_dir" alt="" coords="211,1117,408,1147"/><area shape="rect" id="node51" href="server_2repo-mgr_8h.html#ab10ffbf8777e16cc18e78a263d7fbb1c" title="seaf_repo_manager_list_file_revisions" alt="" coords="188,1195,431,1224"/><area shape="rect" id="node54" href="server_2repo-mgr_8h.html#ad00a42c20e1baadf267215e7e683f9e4" title="seaf_repo_manager_calc_files_last_modified" alt="" coords="168,1248,451,1277"/><area shape="rect" id="node56" href="server_2repo-mgr_8h.html#a75071fddf41a1371d4f89be8d2b59b88" title="seaf_repo_manager_revert_on_server" alt="" coords="189,1301,429,1331"/><area shape="rect" id="node58" href="server_2repo-mgr_8h.html#a3bd2aea3b14fe8a45243d175ef86bb61" title="seaf_repo_manager_get_deleted_entries" alt="" coords="181,1355,437,1384"/><area shape="rect" id="node60" href="verify_8h.html#ac9054d2eed9bb3a221b531f65b5cf0f5" title="verify_repos" alt="" coords="263,1408,356,1437"/><area shape="rect" id="node64" href="passwd-mgr_8h.html#aa869fc42cc145aacb31da546c5b60ddb" title="seaf_passwd_manager_check_passwd" alt="" coords="184,1461,435,1491"/><area shape="rect" id="node66" href="passwd-mgr_8h.html#a423fa6bdd74869a9d46a706ecd7790da" title="seaf_passwd_manager_set_passwd" alt="" coords="193,1515,425,1544"/><area shape="rect" id="node68" href="virtual-repo_8c.html#a9a8dcda29ee6cd28d92c1897ad12f268" title="seaf_repo_manager_create_virtual_repo" alt="" coords="183,1568,436,1597"/><area shape="rect" id="node70" href="virtual-repo_8c.html#a1cd4a8c70076d40d2a778dda774a2263" title="seaf_repo_manager_cleanup_virtual_repos" alt="" coords="175,640,444,669"/><area shape="rect" id="node5" href="server_2repo-mgr_8h.html#a168ba33665e04b18089dd5a5d2a18fe3" title="seaf_repo_diff" alt="" coords="552,32,656,61"/><area shape="rect" id="node16" href="rpc-deprecated_8c.html#a374cf49b787fef8fc91266c87cc15375" title="seafile_get_commit_list_pub" alt="" coords="511,219,697,248"/><area shape="rect" id="node62" href="seafserv-gc_8c.html#a0ddf1224851353fc92bfbff6f499fa97" title="main" alt="" coords="579,1408,629,1437"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a66a6ccfc59462f4c59fd322c693c3d5a"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_virtual_repo_info_free" ref="a66a6ccfc59462f4c59fd322c693c3d5a" args="(SeafVirtRepo *vinfo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="virtual-repo_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a">seaf_virtual_repo_info_free</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSeafVirtRepo.html">SeafVirtRepo</a> *&#160;</td>
          <td class="paramname"><em>vinfo</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2gc_2Backups_2repo-mgr_8c_source.html#l00611">611</a> of file <a class="el" href="server_2gc_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (!vinfo) <span class="keywordflow">return</span>;

    g_free (vinfo-&gt;<a class="code" href="structSeafVirtRepo.html#abd2d9ee29b9d78255cd52b8f7aa053ec">path</a>);
    g_free (vinfo);
}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="server_2repo-mgr_8h_a66a6ccfc59462f4c59fd322c693c3d5a_icgraph.png" border="0" usemap="#server_2repo-mgr_8h_a66a6ccfc59462f4c59fd322c693c3d5a_icgraph" alt=""/></div>
<map name="server_2repo-mgr_8h_a66a6ccfc59462f4c59fd322c693c3d5a_icgraph" id="server_2repo-mgr_8h_a66a6ccfc59462f4c59fd322c693c3d5a_icgraph">
<area shape="rect" id="node3" href="server_2Backups_2repo-mgr_8c.html#ad0a65514ad80789ff244b20c66460b96" title="seaf_repo_free" alt="" coords="315,5,421,35"/><area shape="rect" id="node5" href="server_2repo-mgr_8h.html#ac78c13c68a1a9d1d025e45f4e51193ac" title="seaf_repo_manager_set_repo_history_limit" alt="" coords="233,59,503,88"/><area shape="rect" id="node7" href="server_2repo-mgr_8h.html#a0f63ca499435a0d01f03c8c3a2d86c44" title="seaf_repo_manager_get_repo_history_limit" alt="" coords="233,112,503,141"/><area shape="rect" id="node20" href="quota-mgr_8h.html#ae10caa81f529a80e3729b9a050666302" title="seaf_quota_manager_check_quota" alt="" coords="256,165,480,195"/><area shape="rect" id="node22" href="repo-perm_8c.html#a6a318e5a5bcb0d46286030040ab6e23b" title="seaf_repo_manager_check_permission" alt="" coords="244,219,492,248"/><area shape="rect" id="node24" href="virtual-repo_8c.html#a1cd4a8c70076d40d2a778dda774a2263" title="seaf_repo_manager_cleanup_virtual_repos" alt="" coords="233,272,503,301"/><area shape="rect" id="node9" href="server_2repo-mgr_8h.html#a774e0a8ea59c07c94dc8014612b3f948" title="seaf_repo_manager_get_repo_truncate_time" alt="" coords="553,112,831,141"/><area shape="rect" id="node11" href="seafile-4_81_82_2common_2rpc-service_8c.html#a5594de7f321b08c515c465bc44e25c60" title="seafile_get_commit_list" alt="" coords="929,35,1087,64"/><area shape="rect" id="node15" href="server_2repo-mgr_8h.html#ab10ffbf8777e16cc18e78a263d7fbb1c" title="seaf_repo_manager_list_file_revisions" alt="" coords="887,112,1129,141"/><area shape="rect" id="node18" href="server_2repo-mgr_8h.html#a3bd2aea3b14fe8a45243d175ef86bb61" title="seaf_repo_manager_get_deleted_entries" alt="" coords="880,165,1136,195"/><area shape="rect" id="node13" href="rpc-deprecated_8c.html#a374cf49b787fef8fc91266c87cc15375" title="seafile_get_commit_list_pub" alt="" coords="1184,35,1371,64"/><area shape="rect" id="node26" href="server_2repo-mgr_8h.html#ad6564c23b0e50d8a34dd425432b80db4" title="seaf_repo_manager_del_file" alt="" coords="600,220,784,249"/><area shape="rect" id="node28" href="server_2repo-mgr_8h.html#a056b45d63edfafbc5287012a2a1062ec" title="seaf_repo_manager_move_file" alt="" coords="909,245,1107,275"/><area shape="rect" id="node31" href="server_2repo-mgr_8h.html#ae68e4b6427bb239b697e515c8617cbfb" title="seaf_repo_manager_rename_file" alt="" coords="587,324,797,353"/></map>
</div>
</p>

</div>
</div>
</div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Wed Aug 19 2015 03:59:47 for My Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
