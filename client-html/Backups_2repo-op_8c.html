<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>My Project: seafile-4.1.2/server/Backups/repo-op.c File Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">My Project
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#define-members">Defines</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">seafile-4.1.2/server/Backups/repo-op.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;common.h&quot;</code><br/>
<code>#include &lt;glib/gstdio.h&gt;</code><br/>
<code>#include &lt;jansson.h&gt;</code><br/>
<code>#include &lt;openssl/sha.h&gt;</code><br/>
<code>#include &lt;<a class="el" href="ccnet_8h_source.html">ccnet.h</a>&gt;</code><br/>
<code>#include &lt;ccnet/ccnet-object.h&gt;</code><br/>
<code>#include &quot;utils.h&quot;</code><br/>
<code>#include &quot;log.h&quot;</code><br/>
<code>#include &quot;<a class="el" href="seafile_8h_source.html">seafile.h</a>&quot;</code><br/>
<code>#include &quot;seafile-object.h&quot;</code><br/>
<code>#include &quot;seafile-session.h&quot;</code><br/>
<code>#include &quot;<a class="el" href="commit-mgr_8h_source.html">commit-mgr.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="branch-mgr_8h_source.html">branch-mgr.h</a>&quot;</code><br/>
<code>#include &quot;repo-mgr.h&quot;</code><br/>
<code>#include &quot;<a class="el" href="fs-mgr_8h_source.html">fs-mgr.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="seafile-error_8h_source.html">seafile-error.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="seafile-crypt_8h_source.html">seafile-crypt.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="diff-simple_8h_source.html">diff-simple.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="merge-new_8h_source.html">merge-new.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="monitor-rpc-wrappers_8h_source.html">monitor-rpc-wrappers.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="seaf-db_8h_source.html">seaf-db.h</a>&quot;</code><br/>
</div>
<p><a href="Backups_2repo-op_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structCollectRevisionParam.html">CollectRevisionParam</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structCalcFilesLastModifiedParam.html">CalcFilesLastModifiedParam</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structCollectDelData.html">CollectDelData</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structRemoveExistingParam.html">RemoveExistingParam</a></td></tr>
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a05d1af42442c934b555896d3fe55c79e">DEBUG_FLAG</a>&#160;&#160;&#160;<a class="el" href="seafile-4_81_82_2common_2log_8h.html#ab0ef81bf7d4daa70c41b9e89e6543bfbae1471e45af9b7be288c8f1a787534868">SEAFILE_DEBUG_OTHER</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a823aa5bebe4b4b836619cae12751b8a5">INDEX_DIR</a>&#160;&#160;&#160;&quot;index&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#ab536a51ba147200490ad51af9075a1da">PREFIX_DEL_FILE</a>&#160;&#160;&#160;&quot;Deleted \&quot;&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a973079a1cd8e03ce2cdf64f4a25dc664">PREFIX_DEL_DIR</a>&#160;&#160;&#160;&quot;Removed directory \&quot;&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#aecf300f12c8fcb253662d02215fc0ad2">PREFIX_DEL_DIRS</a>&#160;&#160;&#160;&quot;Removed \&quot;&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo_var, repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(commit_var, repo_id, repo_version, commit_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a897aab32c75a36b188922b8726831ccf">FAIL_IF_FILE_EXISTS</a>(store_id, repo_version, root_id, parent_dir, filename, <a class="el" href="index_8h.html#ac1b4d694fc07a39e06900e82872aac7f">mode</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a5b81d4727cc3ed61fabaf57e9ec58fbc">FAIL_IF_FILE_NOT_EXISTS</a>(store_id, repo_version, root_id, parent_dir, filename, <a class="el" href="index_8h.html#ac1b4d694fc07a39e06900e82872aac7f">mode</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a68c7bdf3d604f5310c1a353eab98692f">STD_FILE_MODE</a>&#160;&#160;&#160;(S_IFREG | 0644)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a2533c727b20aa2e442d550ec2737535e">MAX_RETRY_COUNT</a>&#160;&#160;&#160;3</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a65c9627aee501057c2e4968adbd34c71">REVERT_TO_ROOT</a>&#160;&#160;&#160;0x1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a65c9627aee501057c2e4968adbd34c71">REVERT_TO_ROOT</a>&#160;&#160;&#160;0x1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#ad9c4b5cdb2b279c4f64d27c82d06531b">DEFAULT_RECYCLE_DAYS</a>&#160;&#160;&#160;7</td></tr>
<tr><td colspan="2"><h2><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structCollectRevisionParam.html">CollectRevisionParam</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a458d0a987cb9429e0780d8b8fff8f513">CollectRevisionParam</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <br class="typebreak"/>
<a class="el" href="structCalcFilesLastModifiedParam.html">CalcFilesLastModifiedParam</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a56476b7bd4ecc32a3e329f6ab9460c09">CalcFilesLastModifiedParam</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structCollectDelData.html">CollectDelData</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#ae9c688f2360db18b323e75e79cee6f84">CollectDelData</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structRemoveExistingParam.html">RemoveExistingParam</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#ab62ec989afb52ccc777ac2a2641dfdfb">RemoveExistingParam</a></td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gboolean&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (const char *filename, void *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a3128bd2930667427a22976b6a2b85743">seaf_repo_manager_post_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *temp_file_path, const char *parent_dir, const char *file_name, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#ae7346d14d7ad21fef1537bf44b50273e">seaf_repo_manager_post_multi_files</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *filenames_json, const char *paths_json, const char *user, int replace_existed, char **ret_json, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a0d6750947e09a7c4f4eb2146147e9db1">seaf_repo_manager_post_file_blocks</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *file_name, const char *blockids_json, const char *paths_json, const char *user, gint64 <a class="el" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>, int replace_existed, char **new_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#ad6564c23b0e50d8a34dd425432b80db4">seaf_repo_manager_del_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *file_name, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">SeafileCopyResult *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a88f5fdc80a71e558b5508387eafbb6de">seaf_repo_manager_copy_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *src_repo_id, const char *src_path, const char *src_filename, const char *dst_repo_id, const char *dst_path, const char *dst_filename, const char *user, int need_progress, int synchronous, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">SeafileCopyResult *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#ac11bd852cc7cc4f30e40123b7bae901e">seaf_repo_manager_move_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *src_repo_id, const char *src_path, const char *src_filename, const char *dst_repo_id, const char *dst_path, const char *dst_filename, const char *user, int need_progress, int synchronous, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#aa870306d94f3e7b16e66229040590138">seaf_repo_manager_post_dir</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *new_dir_name, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a2e0e32263ad7bbeaa4ab13a62135c46a">seaf_repo_manager_post_empty_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *new_file_name, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#ae68e4b6427bb239b697e515c8617cbfb">seaf_repo_manager_rename_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *oldname, const char *newname, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a46c094895964e060809372262c9b9923">seaf_repo_manager_put_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *temp_file_path, const char *parent_dir, const char *file_name, const char *user, const char *head_id, char **new_file_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a3702d0c75995d0221e33b9ba673b99fd">seaf_repo_manager_update_dir</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *dir_path, const char *new_dir_id, const char *user, const char *head_id, char *new_commit_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#aad15cfaf3210b47e9f59a481073aafbc">seaf_repo_manager_put_file_blocks</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *file_name, const char *blockids_json, const char *paths_json, const char *user, const char *head_id, gint64 <a class="el" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>, char **new_file_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a352b05f8d991d13b5d5e1f0ee1b7616c">seaf_repo_manager_revert_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *old_commit_id, const char *file_path, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#abf48f3efee4705f32fa8f3a95098921e">seaf_repo_manager_revert_dir</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *old_commit_id, const char *dir_path, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#ab10ffbf8777e16cc18e78a263d7fbb1c">seaf_repo_manager_list_file_revisions</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *start_commit_id, const char *path, int max_revision, int limit, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#ad00a42c20e1baadf267215e7e683f9e4">seaf_repo_manager_calc_files_last_modified</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, int limit, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a75071fddf41a1371d4f89be8d2b59b88">seaf_repo_manager_revert_on_server</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *commit_id, const char *user_name, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#a3bd2aea3b14fe8a45243d175ef86bb61">seaf_repo_manager_get_deleted_entries</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, int show_days, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Backups_2repo-op_8c.html#ab69fe2104c734bb5d32b025e3f444736">seaf_repo_diff</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, const char *old, const char *new, int fold_dir_diff, char **error)</td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a05d1af42442c934b555896d3fe55c79e"></a><!-- doxytag: member="repo&#45;op.c::DEBUG_FLAG" ref="a05d1af42442c934b555896d3fe55c79e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="user-mgr_8c.html#a05d1af42442c934b555896d3fe55c79e">DEBUG_FLAG</a>&#160;&#160;&#160;<a class="el" href="seafile-4_81_82_2common_2log_8h.html#ab0ef81bf7d4daa70c41b9e89e6543bfbae1471e45af9b7be288c8f1a787534868">SEAFILE_DEBUG_OTHER</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l00013">13</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>

</div>
</div>
<a class="anchor" id="ad9c4b5cdb2b279c4f64d27c82d06531b"></a><!-- doxytag: member="repo&#45;op.c::DEFAULT_RECYCLE_DAYS" ref="ad9c4b5cdb2b279c4f64d27c82d06531b" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="repo-op_8c.html#ad9c4b5cdb2b279c4f64d27c82d06531b">DEFAULT_RECYCLE_DAYS</a>&#160;&#160;&#160;7</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l04534">4534</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>

</div>
</div>
<a class="anchor" id="a897aab32c75a36b188922b8726831ccf"></a><!-- doxytag: member="repo&#45;op.c::FAIL_IF_FILE_EXISTS" ref="a897aab32c75a36b188922b8726831ccf" args="(store_id, repo_version, root_id, parent_dir, filename, mode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="repo-op_8c.html#a897aab32c75a36b188922b8726831ccf">FAIL_IF_FILE_EXISTS</a></td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">store_id, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">repo_version, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">root_id, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">parent_dir, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">filename, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><a class="el" href="index_8h.html#ac1b4d694fc07a39e06900e82872aac7f">mode</a>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Value:</b><div class="fragment"><pre class="fragment"><span class="keywordflow">do</span> {                                                                \
        if (check_file_exists ((store_id), (repo_version), (root_id), (parent_dir), (filename), (<a class="code" href="index_8h.html#ac1b4d694fc07a39e06900e82872aac7f">mode</a>))) { \
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,      \
                         <span class="stringliteral">&quot;file already exists&quot;</span>);                        \
            ret = -1;                                                   \
            goto out;                                                   \
        }                                                               \
    } <span class="keywordflow">while</span> (0);
</pre></div>
<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l00388">388</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>

</div>
</div>
<a class="anchor" id="a5b81d4727cc3ed61fabaf57e9ec58fbc"></a><!-- doxytag: member="repo&#45;op.c::FAIL_IF_FILE_NOT_EXISTS" ref="a5b81d4727cc3ed61fabaf57e9ec58fbc" args="(store_id, repo_version, root_id, parent_dir, filename, mode)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="repo-op_8c.html#a5b81d4727cc3ed61fabaf57e9ec58fbc">FAIL_IF_FILE_NOT_EXISTS</a></td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">store_id, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">repo_version, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">root_id, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">parent_dir, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">filename, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><a class="el" href="index_8h.html#ac1b4d694fc07a39e06900e82872aac7f">mode</a>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Value:</b><div class="fragment"><pre class="fragment"><span class="keywordflow">do</span> {                                                                \
        if (!check_file_exists ((store_id), (repo_version), (root_id), (parent_dir), (filename), (<a class="code" href="index_8h.html#ac1b4d694fc07a39e06900e82872aac7f">mode</a>))) { \
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,      \
                         <span class="stringliteral">&quot;file does not exist&quot;</span>);                        \
            ret = -1;                                                   \
            goto out;                                                   \
        }                                                               \
    } <span class="keywordflow">while</span> (0);
</pre></div>
<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l00398">398</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>

</div>
</div>
<a class="anchor" id="a8e5a75fd7079c7668a1e39b9b57bafed"></a><!-- doxytag: member="repo&#45;op.c::GET_COMMIT_OR_FAIL" ref="a8e5a75fd7079c7668a1e39b9b57bafed" args="(commit_var, repo_id, repo_version, commit_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a></td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">commit_var, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">repo_id, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">repo_version, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">commit_id&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Value:</b><div class="fragment"><pre class="fragment"><span class="keywordflow">do</span> {                                                                \
        commit_var = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a>(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>, (repo_id), (repo_version), (commit_id)); \
        if (!(commit_var)) {                                            \
            seaf_warning (<span class="stringliteral">&quot;commit %s doesn&#39;t exist.\n&quot;</span>, (commit_id));   \
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Invalid commit&quot;</span>); \
            ret = -1;                                                   \
            goto out;                                                   \
        }                                                               \
    } <span class="keywordflow">while</span> (0);
</pre></div>
<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l00377">377</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>

</div>
</div>
<a class="anchor" id="ad4fe8ea6d1a020206fd349111f94f2c7"></a><!-- doxytag: member="repo&#45;op.c::GET_REPO_OR_FAIL" ref="ad4fe8ea6d1a020206fd349111f94f2c7" args="(repo_var, repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a></td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">repo_var, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">repo_id&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Value:</b><div class="fragment"><pre class="fragment"><span class="keywordflow">do</span> {                                                                \
        repo_var = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, (repo_id)); \
        if (!(repo_var)) {                                              \
            seaf_warning (<span class="stringliteral">&quot;Repo %s doesn&#39;t exist.\n&quot;</span>, (repo_id));       \
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Invalid repo&quot;</span>); \
            ret = -1;                                                   \
            goto out;                                                   \
        }                                                               \
    } <span class="keywordflow">while</span> (0);
</pre></div><p>Various online file/directory operations:</p>
<p>Put a file: 1. find parent seafdir 2. add a new dirent to parent seafdir 2. recursively update all seafdir in the path, in a bottom-up manner 3. commit it</p>
<p>Del a file/dir: basically the same as put a file</p>
<p>copy a file/dir: 1. get src dirent from src repo 2. duplicate src dirent with the new file name 3. put the new dirent to dst repo and commit it.</p>
<p>Move a file/dir: basically the same as a copy operation. Just one more step: 4. remove src dirent from src repo and commit it</p>
<p>Rename a file/dir: 1. find parent seafdir 2. update this seafdir with the old dirent replaced by a new dirent. 3. recursively update all seafdir in the path</p>
<p>NOTE:</p>
<p>All operations which add a new dirent would check if a dirent with the same name already exists. If found, they would raise errors.</p>
<p>All operations which remove a dirent would check if the dirent to be removed already exists. If not, they would do nothing and just return OK. </p>

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l00366">366</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>

</div>
</div>
<a class="anchor" id="a823aa5bebe4b4b836619cae12751b8a5"></a><!-- doxytag: member="repo&#45;op.c::INDEX_DIR" ref="a823aa5bebe4b4b836619cae12751b8a5" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="repo-op_8c.html#a823aa5bebe4b4b836619cae12751b8a5">INDEX_DIR</a>&#160;&#160;&#160;&quot;index&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l00031">31</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>

</div>
</div>
<a class="anchor" id="a2533c727b20aa2e442d550ec2737535e"></a><!-- doxytag: member="repo&#45;op.c::MAX_RETRY_COUNT" ref="a2533c727b20aa2e442d550ec2737535e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="repo-op_8c.html#a2533c727b20aa2e442d550ec2737535e">MAX_RETRY_COUNT</a>&#160;&#160;&#160;3</td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a973079a1cd8e03ce2cdf64f4a25dc664"></a><!-- doxytag: member="repo&#45;op.c::PREFIX_DEL_DIR" ref="a973079a1cd8e03ce2cdf64f4a25dc664" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="repo-op_8c.html#a973079a1cd8e03ce2cdf64f4a25dc664">PREFIX_DEL_DIR</a>&#160;&#160;&#160;&quot;Removed directory \&quot;&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l00034">34</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>

</div>
</div>
<a class="anchor" id="aecf300f12c8fcb253662d02215fc0ad2"></a><!-- doxytag: member="repo&#45;op.c::PREFIX_DEL_DIRS" ref="aecf300f12c8fcb253662d02215fc0ad2" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="repo-op_8c.html#aecf300f12c8fcb253662d02215fc0ad2">PREFIX_DEL_DIRS</a>&#160;&#160;&#160;&quot;Removed \&quot;&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l00035">35</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>

</div>
</div>
<a class="anchor" id="ab536a51ba147200490ad51af9075a1da"></a><!-- doxytag: member="repo&#45;op.c::PREFIX_DEL_FILE" ref="ab536a51ba147200490ad51af9075a1da" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="repo-op_8c.html#ab536a51ba147200490ad51af9075a1da">PREFIX_DEL_FILE</a>&#160;&#160;&#160;&quot;Deleted \&quot;&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l00033">33</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>

</div>
</div>
<a class="anchor" id="a65c9627aee501057c2e4968adbd34c71"></a><!-- doxytag: member="repo&#45;op.c::REVERT_TO_ROOT" ref="a65c9627aee501057c2e4968adbd34c71" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="repo-op_8c.html#a65c9627aee501057c2e4968adbd34c71">REVERT_TO_ROOT</a>&#160;&#160;&#160;0x1</td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a65c9627aee501057c2e4968adbd34c71"></a><!-- doxytag: member="repo&#45;op.c::REVERT_TO_ROOT" ref="a65c9627aee501057c2e4968adbd34c71" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="repo-op_8c.html#a65c9627aee501057c2e4968adbd34c71">REVERT_TO_ROOT</a>&#160;&#160;&#160;0x1</td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a68c7bdf3d604f5310c1a353eab98692f"></a><!-- doxytag: member="repo&#45;op.c::STD_FILE_MODE" ref="a68c7bdf3d604f5310c1a353eab98692f" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="repo-op_8c.html#a68c7bdf3d604f5310c1a353eab98692f">STD_FILE_MODE</a>&#160;&#160;&#160;(S_IFREG | 0644)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l00408">408</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>

</div>
</div>
<hr/><h2>Typedef Documentation</h2>
<a class="anchor" id="a56476b7bd4ecc32a3e329f6ab9460c09"></a><!-- doxytag: member="repo&#45;op.c::CalcFilesLastModifiedParam" ref="a56476b7bd4ecc32a3e329f6ab9460c09" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structCalcFilesLastModifiedParam.html">CalcFilesLastModifiedParam</a> <a class="el" href="structCalcFilesLastModifiedParam.html">CalcFilesLastModifiedParam</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l04093">4093</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>

</div>
</div>
<a class="anchor" id="ae9c688f2360db18b323e75e79cee6f84"></a><!-- doxytag: member="repo&#45;op.c::CollectDelData" ref="ae9c688f2360db18b323e75e79cee6f84" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structCollectDelData.html">CollectDelData</a>  <a class="el" href="structCollectDelData.html">CollectDelData</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a458d0a987cb9429e0780d8b8fff8f513"></a><!-- doxytag: member="repo&#45;op.c::CollectRevisionParam" ref="a458d0a987cb9429e0780d8b8fff8f513" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structCollectRevisionParam.html">CollectRevisionParam</a> <a class="el" href="structCollectRevisionParam.html">CollectRevisionParam</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l03635">3635</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>

</div>
</div>
<a class="anchor" id="ab62ec989afb52ccc777ac2a2641dfdfb"></a><!-- doxytag: member="repo&#45;op.c::RemoveExistingParam" ref="ab62ec989afb52ccc777ac2a2641dfdfb" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structRemoveExistingParam.html">RemoveExistingParam</a>  <a class="el" href="structRemoveExistingParam.html">RemoveExistingParam</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="ab69fe2104c734bb5d32b025e3f444736"></a><!-- doxytag: member="repo&#45;op.c::seaf_repo_diff" ref="ab69fe2104c734bb5d32b025e3f444736" args="(SeafRepo *repo, const char *old, const char *new, int fold_dir_diff, char **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="repo-op_8c.html#ab69fe2104c734bb5d32b025e3f444736">seaf_repo_diff</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>old</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>fold_dir_diff</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l04766">4766</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *c1 = NULL, *c2 = NULL;
    <span class="keywordtype">int</span> ret = 0;
    GList *diff_entries = NULL;

    g_return_val_if_fail (*error == NULL, NULL);

    c2 = get_commit (repo, <span class="keyword">new</span>);
    <span class="keywordflow">if</span> (!c2) {
        *error = g_strdup(<span class="stringliteral">&quot;Can&#39;t find new commit&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }
    
    <span class="keywordflow">if</span> (old == NULL || old[0] == <span class="charliteral">&#39;\0&#39;</span>) {
        <span class="keywordflow">if</span> (c2-&gt;parent_id &amp;&amp; c2-&gt;second_parent_id) {
            ret = <a class="code" href="diff-simple_8c.html#a8c800ee63c23c5ff78d838974f678e47">diff_merge</a> (c2, &amp;diff_entries, fold_dir_diff);
            <span class="keywordflow">if</span> (ret &lt; 0) {
                *error = g_strdup(<span class="stringliteral">&quot;Failed to do diff&quot;</span>);
                <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (c2);
                <span class="keywordflow">return</span> NULL;
            }
            <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (c2);
            <span class="keywordflow">return</span> diff_entries;
        }

        <span class="keywordflow">if</span> (!c2-&gt;parent_id) {
            <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (c2);
            <span class="keywordflow">return</span> NULL;
        }
        c1 = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                             repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, 
                                             c2-&gt;parent_id);
    } <span class="keywordflow">else</span> {
        c1 = get_commit (repo, old);
    }

    <span class="keywordflow">if</span> (!c1) {
        *error = g_strdup(<span class="stringliteral">&quot;Can&#39;t find old commit&quot;</span>);
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (c2);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="comment">/* do diff */</span>
    ret = <a class="code" href="diff-simple_8c.html#a9e9cbe6847c88fc7bca7035f45a0a50e">diff_commits</a> (c1, c2, &amp;diff_entries, fold_dir_diff);
    <span class="keywordflow">if</span> (ret &lt; 0)
        *error = g_strdup(<span class="stringliteral">&quot;Failed to do diff&quot;</span>);

    <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (c1);
    <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (c2);

    <span class="keywordflow">return</span> diff_entries;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad00a42c20e1baadf267215e7e683f9e4"></a><!-- doxytag: member="repo&#45;op.c::seaf_repo_manager_calc_files_last_modified" ref="ad00a42c20e1baadf267215e7e683f9e4" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, int limit, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="repo-op_8c.html#ad00a42c20e1baadf267215e7e683f9e4">seaf_repo_manager_calc_files_last_modified</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>limit</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Give a directory, return the last modification timestamps of all the files under this directory.</p>
<p>First we record the current id of every file, then traverse the commit tree. Give a commit, for each file, if the file id in that commit is different than its current id, then this file is last modified in the commit previous to that commit. </p>

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l04207">4207</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <a class="code" href="struct__SeafDir.html">SeafDir</a> *dir = NULL;
    GList *ptr = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *dent = NULL; 
    <a class="code" href="structCalcFilesLastModifiedParam.html">CalcFilesLastModifiedParam</a> data = {0};
    GList *ret_list = NULL;

    repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (!repo) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;No such repo %s&quot;</span>, repo_id);
        <span class="keywordflow">goto</span> out;
    }

    head_commit = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, 
                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
    <span class="keywordflow">if</span> (!head_commit) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to get commit %s&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
        <span class="keywordflow">goto</span> out;
    }

    dir = <a class="code" href="fs-mgr_8c.html#a033b8831db7345eec0ff09216b63593d">seaf_fs_manager_get_seafdir_by_path</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                               repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                               head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                               parent_dir, error);
    <span class="keywordflow">if</span> (*error || !dir) {
        <span class="keywordflow">goto</span> out;
    }

    data.<a class="code" href="structCalcFilesLastModifiedParam.html#a97697edcf7ab91b67f253899a91703c5">repo</a> = repo;
    
    <span class="comment">/* A hash table of pattern (file_name, current_file_id) */</span>
    data.<a class="code" href="structCalcFilesLastModifiedParam.html#a702738ebda8b8ec9109a48537c8b91ac">current_file_id_hash</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
                                                       g_free, g_free);
    <span class="comment">/* A (file_name, last_modified) hashtable. &lt;last_modified&gt; is a heap</span>
<span class="comment">       allocated gint64</span>
<span class="comment">    */</span>
    data.<a class="code" href="structCalcFilesLastModifiedParam.html#a7e1281cdb47bc1680b9635719d1e417c">last_modified_hash</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
                                                     g_free, g_free);
    <span class="keywordflow">for</span> (ptr = dir-&gt;<a class="code" href="struct__SeafDir.html#ae45d2a99b493e8a080e910d2fd580df4">entries</a>; ptr; ptr = ptr-&gt;next) {
        dent = ptr-&gt;data;
        g_hash_table_insert (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a702738ebda8b8ec9109a48537c8b91ac">current_file_id_hash</a>,
                             g_strdup(dent-&gt;<a class="code" href="struct__SeafDirent.html#a400094123179edfd24b0db4925780624">name</a>),
                             g_strdup(dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>));

        gint64 *<a class="code" href="index_8h.html#a774773e5c25d1b44dac32468246cc980">ctime</a> = g_new (gint64, 1);
        *ctime = head_commit-&gt;<a class="code" href="struct__SeafCommit.html#ae3f1657ab475921889a1e9c74b94e7a2">ctime</a>;
        g_hash_table_insert (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a7e1281cdb47bc1680b9635719d1e417c">last_modified_hash</a>,
                             g_strdup(dent-&gt;<a class="code" href="struct__SeafDirent.html#a400094123179edfd24b0db4925780624">name</a>), 
                             ctime);
    }

    <span class="keywordflow">if</span> (g_hash_table_size (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a702738ebda8b8ec9109a48537c8b91ac">current_file_id_hash</a>) == 0) {
        <span class="comment">/* An empty directory, no need to traverse */</span>
        <span class="keywordflow">goto</span> out;
    }

    data.<a class="code" href="structCalcFilesLastModifiedParam.html#ada88490177184de19fbb57b5c27a1ba8">parent_dir</a> = parent_dir;
    data.<a class="code" href="structCalcFilesLastModifiedParam.html#adde465b06b50b85a61903a27b20be738">error</a> = error;

    <span class="keywordflow">if</span> (!<a class="code" href="commit-mgr_8c.html#a032f260db46d5566e78dfcbbc4b2859a">seaf_commit_manager_traverse_commit_tree_with_limit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, 
                                                        repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>,
                                (<a class="code" href="commit-mgr_8h.html#ace73a042fe8571009de1750edb729c83">CommitTraverseFunc</a>)collect_files_last_modified,
                                                              limit, &amp;data, FALSE)) {
        <span class="keywordflow">if</span> (*error)
            seaf_warning (<span class="stringliteral">&quot;error when traversing commits: %s\n&quot;</span>, (*error)-&gt;message);
        <span class="keywordflow">else</span>
            seaf_warning (<span class="stringliteral">&quot;error when traversing commits.\n&quot;</span>);
        g_clear_error (error);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;failed to traverse commit of repo %s&quot;</span>, repo_id);
        <span class="keywordflow">goto</span> out;
    }

    GHashTableIter iter;
    gpointer key, value;

    g_hash_table_iter_init (&amp;iter, data.<a class="code" href="structCalcFilesLastModifiedParam.html#a7e1281cdb47bc1680b9635719d1e417c">last_modified_hash</a>);
    <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
        SeafileFileLastModifiedInfo *info;
        gint64 last_modified = *(gint64 *)value;
        info = g_object_new (SEAFILE_TYPE_FILE_LAST_MODIFIED_INFO,
                             <span class="stringliteral">&quot;file_name&quot;</span>, key,
                             <span class="stringliteral">&quot;last_modified&quot;</span>, last_modified,
                             NULL);
        ret_list = g_list_prepend (ret_list, info);
    }

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <span class="keywordflow">if</span> (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a7e1281cdb47bc1680b9635719d1e417c">last_modified_hash</a>)
        g_hash_table_destroy (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a7e1281cdb47bc1680b9635719d1e417c">last_modified_hash</a>);
    <span class="keywordflow">if</span> (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a702738ebda8b8ec9109a48537c8b91ac">current_file_id_hash</a>)
        g_hash_table_destroy (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a702738ebda8b8ec9109a48537c8b91ac">current_file_id_hash</a>);
    <span class="keywordflow">if</span> (dir)
        <a class="code" href="fs-mgr_8c.html#ae04d3c4669cd7b0fc691cd2da6dc2de1">seaf_dir_free</a> (dir);

    <span class="keywordflow">return</span> g_list_reverse(ret_list);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a88f5fdc80a71e558b5508387eafbb6de"></a><!-- doxytag: member="repo&#45;op.c::seaf_repo_manager_copy_file" ref="a88f5fdc80a71e558b5508387eafbb6de" args="(SeafRepoManager *mgr, const char *src_repo_id, const char *src_path, const char *src_filename, const char *dst_repo_id, const char *dst_path, const char *dst_filename, const char *user, int need_progress, int synchronous, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">SeafileCopyResult* <a class="el" href="repo-op_8c.html#a88f5fdc80a71e558b5508387eafbb6de">seaf_repo_manager_copy_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>src_repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>src_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>src_filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dst_repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dst_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dst_filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>need_progress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>synchronous</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Copy a SeafDirent from a SeafDir to another.</p>
<p>1. When  and  are not the same repo, neither of them should be encrypted.</p>
<p>2. the file being copied must not exist in the dst path of the dst repo. </p>

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l01756">1756</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *src_repo = NULL, *dst_repo = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *src_dent = NULL, *dst_dent = NULL;
    <span class="keywordtype">char</span> *src_canon_path = NULL, *dst_canon_path = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *dst_head_commit = NULL;
    <span class="keywordtype">int</span> ret = 0;
    gboolean background = FALSE;
    <span class="keywordtype">char</span> *task_id = NULL;
    SeafileCopyResult *res= NULL;

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(src_repo, src_repo_id);

    <span class="keywordflow">if</span> (strcmp(src_repo_id, dst_repo_id) != 0) {
        <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(dst_repo, dst_repo_id);

        <span class="keywordflow">if</span> (src_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a> || dst_repo-&gt;encrypted) {
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                         <span class="stringliteral">&quot;Can&#39;t copy files between encrypted repo(s)&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
        
    } <span class="keywordflow">else</span> {
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#ab8f60cbbd6c35ee55ea72acbbd3a1608">seaf_repo_ref</a> (src_repo);
        dst_repo = src_repo;
    }
    
    src_canon_path = get_canonical_path (src_path);
    dst_canon_path = get_canonical_path (dst_path);

    <span class="comment">/* first check whether a file with file_name already exists in destination dir */</span>
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(dst_head_commit,
                       dst_repo-&gt;id, dst_repo-&gt;<a class="code" href="struct__SeafCommit.html#abc83f168ce2b43fa864522bf0ea26d6d">version</a>, 
                       dst_repo-&gt;head-&gt;commit_id);
    
    <a class="code" href="Backups_2repo-op_8c.html#a897aab32c75a36b188922b8726831ccf">FAIL_IF_FILE_EXISTS</a>(dst_repo-&gt;store_id, dst_repo-&gt;version,
                        dst_head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, dst_canon_path, dst_filename, NULL);

    <span class="comment">/* get src dirent */</span>
    src_dent = get_dirent_by_path (src_repo, NULL,
                                   src_canon_path, src_filename, error);
    <span class="keywordflow">if</span> (!src_dent) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (strcmp (src_repo_id, dst_repo_id) == 0 ||
        is_virtual_repo_and_origin (src_repo, dst_repo)) {

        gint64 <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a> = (src_dent-&gt;<a class="code" href="struct__SeafDirent.html#afc58a80e040b009230ce1d3d500e2f1f">version</a> &gt; 0) ? src_dent-&gt;<a class="code" href="struct__SeafDirent.html#abf0e9b6fade594b7897cb9896d370961">size</a> : -1;

        <span class="comment">/* duplicate src dirent with new name */</span>
        dst_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(dst_repo-&gt;version),
                                    src_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>, src_dent-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>, dst_filename,
                                    (gint64)time(NULL), user, <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>);

        <span class="keywordflow">if</span> (put_dirent_and_commit (dst_repo,
                                   dst_canon_path,
                                   dst_dent,
                                   user,
                                   error) &lt; 0) {
            <span class="keywordflow">if</span> (!error)
                g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                             <span class="stringliteral">&quot;failed to put dirent&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }

        <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, dst_repo_id, NULL);

        update_repo_size (dst_repo_id);
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!synchronous) {
        background = TRUE;

        gint64 total_files = -1;
        <span class="keywordflow">if</span> (S_ISDIR(src_dent-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>))
            total_files = <a class="code" href="fs-mgr_8c.html#afa141245d62ac11820ad120fef68d01e">seaf_fs_manager_count_fs_files</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                                          src_repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>,
                                                          src_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                          src_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
        <span class="keywordflow">else</span>
            total_files = 1;
        <span class="keywordflow">if</span> (total_files &lt; 0) {
            seaf_warning (<span class="stringliteral">&quot;Failed to get file count.\n&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }

        <span class="keywordflow">if</span> (!check_file_count_and_size (src_repo, src_dent, total_files, error)) {
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }

        task_id = <a class="code" href="copy-mgr_8c.html#ae731d17024807023ab2689f9ffca5e99">seaf_copy_manager_add_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a1826aa8bcba056a4f41755627b270751">copy_mgr</a>,
                                              src_repo_id,
                                              src_canon_path,
                                              src_filename,
                                              dst_repo_id,
                                              dst_canon_path,
                                              dst_filename,
                                              user,
                                              total_files,
                                              cross_repo_copy,
                                              need_progress);
        <span class="keywordflow">if</span> (need_progress &amp;&amp; !task_id) {
            seaf_warning (<span class="stringliteral">&quot;Failed to start copy task.\n&quot;</span>);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;failed to start copy task&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    } <span class="keywordflow">else</span> {
        <span class="comment">/* Synchronous for cross-repo move */</span>
        <span class="keywordflow">if</span> (cross_repo_copy (src_repo_id,
                             src_canon_path,
                             src_filename,
                             dst_repo_id,
                             dst_canon_path,
                             dst_filename,
                             user,
                             NULL) &lt; 0) {
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;Failed to move&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

out:
    <span class="keywordflow">if</span> (src_repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (src_repo);
    <span class="keywordflow">if</span> (dst_repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (dst_repo);
    <span class="keywordflow">if</span> (dst_head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(dst_head_commit);
    <span class="keywordflow">if</span> (src_canon_path)
        g_free (src_canon_path);
    <span class="keywordflow">if</span> (dst_canon_path)
        g_free (dst_canon_path);
    <span class="keywordflow">if</span> (src_dent)
        <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a>(src_dent);
    <span class="keywordflow">if</span> (dst_dent)
        <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a>(dst_dent);

    <span class="keywordflow">if</span> (ret == 0) {
        res = seafile_copy_result_new ();
        g_object_set (res, <span class="stringliteral">&quot;background&quot;</span>, background, <span class="stringliteral">&quot;task_id&quot;</span>, task_id, NULL);
        g_free (task_id);
    }

    <span class="keywordflow">return</span> res;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad6564c23b0e50d8a34dd425432b80db4"></a><!-- doxytag: member="repo&#45;op.c::seaf_repo_manager_del_file" ref="ad6564c23b0e50d8a34dd425432b80db4" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *file_name, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#ad6564c23b0e50d8a34dd425432b80db4">seaf_repo_manager_del_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l01318">1318</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <span class="keywordtype">int</span> <a class="code" href="index_8h.html#ac1b4d694fc07a39e06900e82872aac7f">mode</a> = 0;
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    <span class="keywordflow">if</span> (!canon_path)
        canon_path = get_canonical_path (parent_dir);
    
    <span class="keywordflow">if</span> (!check_file_exists(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                           head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, file_name, &amp;mode)) {
        seaf_warning (<span class="stringliteral">&quot;[del file] target file %s/%s does not exist, skip\n&quot;</span>,
                      canon_path, file_name);
        <span class="keywordflow">goto</span> out;
    }

    root_id = do_del_file (repo,
                           head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, file_name);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[del file] Failed to del file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to del file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    <span class="keywordflow">if</span> (S_ISDIR(mode)) {
        snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Removed directory \&quot;%s\&quot;&quot;</span>, file_name);
    } <span class="keywordflow">else</span> {
        snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Deleted \&quot;%s\&quot;&quot;</span>, file_name);
    }

    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a1cd4a8c70076d40d2a778dda774a2263">seaf_repo_manager_cleanup_virtual_repos</a> (mgr, repo_id);

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    g_free (root_id);
    g_free (canon_path);

    <span class="keywordflow">if</span> (ret == 0) {
        update_repo_size (repo_id);
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a3bd2aea3b14fe8a45243d175ef86bb61"></a><!-- doxytag: member="repo&#45;op.c::seaf_repo_manager_get_deleted_entries" ref="a3bd2aea3b14fe8a45243d175ef86bb61" args="(SeafRepoManager *mgr, const char *repo_id, int show_days, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="repo-op_8c.html#a3bd2aea3b14fe8a45243d175ef86bb61">seaf_repo_manager_get_deleted_entries</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>show_days</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l04673">4673</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
    gint64 truncate_time, show_time;
    GList *ret = NULL;

    truncate_time = <a class="code" href="server_2Backups_2repo-mgr_8c.html#a774e0a8ea59c07c94dc8014612b3f948">seaf_repo_manager_get_repo_truncate_time</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (truncate_time == 0)
        <span class="keywordflow">return</span> NULL;

    <span class="keywordflow">if</span> (show_days &lt;= 0)
        show_time = -1;
    <span class="keywordflow">else</span>
        show_time = (gint64)time(NULL) - show_days * 24 * 3600;

    repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (!repo) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Invalid repo id&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <a class="code" href="structCollectDelData.html">CollectDelData</a> data = {0};
    GHashTable *entries = g_hash_table_new_full (g_str_hash, g_str_equal,
                                                 g_free, g_object_unref);
    data.<a class="code" href="structCollectDelData.html#a9f4baf8d28352a26145a3eba21de3799">repo</a> = repo;
    data.<a class="code" href="structCollectDelData.html#aa12f02a8698ba507ae308d9a87a33d66">entries</a> = entries;
    data.<a class="code" href="structCollectDelData.html#a68ae2e7913cdf780efc859ec5eb218e9">truncate_time</a> = MAX (show_time, truncate_time);

    <span class="keywordflow">if</span> (!<a class="code" href="commit-mgr_8c.html#ac6547d5546781608b39446d9a2077fed">seaf_commit_manager_traverse_commit_tree</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, 
                                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>,
                                                   collect_deleted,
                                                   &amp;data,
                                                   TRUE))
    {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>,
                     <span class="stringliteral">&quot;Internal error&quot;</span>);
        g_hash_table_destroy (entries);
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="comment">/* Remove entries exist in the current commit.</span>
<span class="comment">     * This is necessary because some files may be added back after deletion.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (filter_out_existing_entries (entries, repo,
                                     repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>) == 0) {
        <span class="comment">// filter success, then add collected result to list</span>
        g_hash_table_foreach_steal (entries, hash_to_list, &amp;ret);
    }

    g_hash_table_destroy (entries);

    <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ab10ffbf8777e16cc18e78a263d7fbb1c"></a><!-- doxytag: member="repo&#45;op.c::seaf_repo_manager_list_file_revisions" ref="ab10ffbf8777e16cc18e78a263d7fbb1c" args="(SeafRepoManager *mgr, const char *repo_id, const char *start_commit_id, const char *path, int max_revision, int limit, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="repo-op_8c.html#ab10ffbf8777e16cc18e78a263d7fbb1c">seaf_repo_manager_list_file_revisions</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>start_commit_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>max_revision</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>limit</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l03990">3990</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    GList *commit_list = NULL, *file_id_list = NULL, *file_size_list = NULL;
    GList *ret = NULL, *ptr;
    <a class="code" href="structCollectRevisionParam.html">CollectRevisionParam</a> data = {0};
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *last_commit = NULL;
    <span class="keyword">const</span> <span class="keywordtype">char</span> *head_id;
    gboolean is_renamed = FALSE;
    <span class="keywordtype">char</span> *parent_id = NULL, *old_path = NULL;
    GList *old_revisions = NULL;

    repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (!repo) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;No such repo %s&quot;</span>, repo_id);
        <span class="keywordflow">goto</span> out;
    }

    data.<a class="code" href="structCollectRevisionParam.html#a07864553b581ce4c6cdbda3f04c09dfe">repo</a> = repo;

    <span class="keywordflow">if</span> (!start_commit_id)
        head_id = repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>;
    <span class="keywordflow">else</span>
        head_id = start_commit_id;

    data.<a class="code" href="structCollectRevisionParam.html#a19382402505c15b32693a3f4c07259fc">path</a> = path;
    data.<a class="code" href="structCollectRevisionParam.html#aa20a18c673b6d2bdeab1475cbadfec05">error</a> = error;
    data.<a class="code" href="structCollectRevisionParam.html#a8f727a17d75f4a2459d65ee3513a319c">max_revision</a> = max_revision;

    data.<a class="code" href="structCollectRevisionParam.html#ac3711b50d3a73a6f766fe2bcaa6d378c">truncate_time</a> = <a class="code" href="server_2Backups_2repo-mgr_8c.html#a774e0a8ea59c07c94dc8014612b3f948">seaf_repo_manager_get_repo_truncate_time</a> (mgr, repo_id);
    data.<a class="code" href="structCollectRevisionParam.html#af9f62ff203010354269f5ae0a3f0659c">wanted_commits</a> = NULL;
    data.<a class="code" href="structCollectRevisionParam.html#a2e9f00e819bc4f0f65c403635b36d0a1">file_id_list</a> = NULL;
    data.<a class="code" href="structCollectRevisionParam.html#a16b7714b3c3327a32c4f1352f8e6be18">file_size_list</a> = NULL;

    <span class="comment">/* A hash table to cache caculated file id of &lt;path&gt; in &lt;commit&gt; */</span>
    data.<a class="code" href="structCollectRevisionParam.html#ac271167b2503f96b7a8d0ead7f34ae5e">file_id_cache</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
                                                g_free, g_free);

    <span class="keywordflow">if</span> (!<a class="code" href="commit-mgr_8c.html#a032f260db46d5566e78dfcbbc4b2859a">seaf_commit_manager_traverse_commit_tree_with_limit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
                                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                              head_id,
                                                              (<a class="code" href="commit-mgr_8h.html#ace73a042fe8571009de1750edb729c83">CommitTraverseFunc</a>)collect_file_revisions,
                                                              limit, &amp;data, TRUE)) {
        g_clear_error (error);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;failed to traverse commit of repo %s&quot;</span>, repo_id);
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (!data.<a class="code" href="structCollectRevisionParam.html#af9f62ff203010354269f5ae0a3f0659c">wanted_commits</a>) {
        g_clear_error (error);
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* commit list in descending commit time order. */</span>
    last_commit = data.<a class="code" href="structCollectRevisionParam.html#af9f62ff203010354269f5ae0a3f0659c">wanted_commits</a>-&gt;data;

    is_renamed = detect_rename_revision (repo,
                                         last_commit, path, &amp;parent_id, &amp;old_path);

    commit_list = g_list_reverse (data.<a class="code" href="structCollectRevisionParam.html#af9f62ff203010354269f5ae0a3f0659c">wanted_commits</a>);
    file_id_list = g_list_reverse (data.<a class="code" href="structCollectRevisionParam.html#a2e9f00e819bc4f0f65c403635b36d0a1">file_id_list</a>);
    file_size_list = g_list_reverse (data.<a class="code" href="structCollectRevisionParam.html#a16b7714b3c3327a32c4f1352f8e6be18">file_size_list</a>);

    ret = convert_rpc_commit_list (commit_list, file_id_list, file_size_list,
                                   is_renamed, old_path);

    <span class="keywordflow">if</span> (is_renamed) {
        <span class="comment">/* Get the revisions of the old path, starting from parent commit. */</span>
        old_revisions = <a class="code" href="Backups_2repo-op_8c.html#ab10ffbf8777e16cc18e78a263d7fbb1c">seaf_repo_manager_list_file_revisions</a> (mgr, repo_id,
                                                               parent_id, old_path,
                                                               -1, -1, error);
        ret = g_list_concat (ret, old_revisions);
        g_free (parent_id);
        g_free (old_path);
    }

    g_clear_error (error);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">for</span> (ptr = commit_list; ptr; ptr = ptr-&gt;next)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> ((<a class="code" href="struct__SeafCommit.html">SeafCommit</a> *)ptr-&gt;data);
    g_list_free (commit_list);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (file_id_list);
    <span class="keywordflow">for</span> (ptr = file_size_list; ptr; ptr = ptr-&gt;next)
        g_free (ptr-&gt;data);
    g_list_free (file_size_list);
    <span class="keywordflow">if</span> (data.<a class="code" href="structCollectRevisionParam.html#ac271167b2503f96b7a8d0ead7f34ae5e">file_id_cache</a>)
        g_hash_table_destroy (data.<a class="code" href="structCollectRevisionParam.html#ac271167b2503f96b7a8d0ead7f34ae5e">file_id_cache</a>);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ac11bd852cc7cc4f30e40123b7bae901e"></a><!-- doxytag: member="repo&#45;op.c::seaf_repo_manager_move_file" ref="ac11bd852cc7cc4f30e40123b7bae901e" args="(SeafRepoManager *mgr, const char *src_repo_id, const char *src_path, const char *src_filename, const char *dst_repo_id, const char *dst_path, const char *dst_filename, const char *user, int need_progress, int synchronous, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">SeafileCopyResult* <a class="el" href="repo-op_8c.html#ac11bd852cc7cc4f30e40123b7bae901e">seaf_repo_manager_move_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>src_repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>src_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>src_filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dst_repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dst_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dst_filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>need_progress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>synchronous</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l02063">2063</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *src_repo = NULL, *dst_repo = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *src_dent = NULL, *dst_dent = NULL;
    <span class="keywordtype">char</span> *src_canon_path = NULL, *dst_canon_path = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *dst_head_commit = NULL;
    <span class="keywordtype">int</span> ret = 0;
    gboolean background = FALSE;
    <span class="keywordtype">char</span> *task_id = NULL;
    SeafileCopyResult *res = NULL;

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(src_repo, src_repo_id);

    <span class="keywordflow">if</span> (strcmp(src_repo_id, dst_repo_id) != 0) {
        <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(dst_repo, dst_repo_id);

        <span class="keywordflow">if</span> (src_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a> || dst_repo-&gt;encrypted) {
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                         <span class="stringliteral">&quot;Can&#39;t copy files between encrypted repo(s)&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
        
    } <span class="keywordflow">else</span> {
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#ab8f60cbbd6c35ee55ea72acbbd3a1608">seaf_repo_ref</a> (src_repo);
        dst_repo = src_repo;
    }
    
    src_canon_path = get_canonical_path (src_path);
    dst_canon_path = get_canonical_path (dst_path);
    <span class="comment">/* first check whether a file with file_name already exists in destination dir */</span>
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(dst_head_commit,
                       dst_repo-&gt;id, dst_repo-&gt;<a class="code" href="struct__SeafCommit.html#abc83f168ce2b43fa864522bf0ea26d6d">version</a>, 
                       dst_repo-&gt;head-&gt;commit_id);
    <a class="code" href="Backups_2repo-op_8c.html#a897aab32c75a36b188922b8726831ccf">FAIL_IF_FILE_EXISTS</a>(dst_repo-&gt;store_id, dst_repo-&gt;version,
                        dst_head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, dst_canon_path, dst_filename, NULL);

    <span class="comment">/* get src dirent */</span>
    src_dent = get_dirent_by_path (src_repo, NULL,
                                   src_canon_path, src_filename, error);
    <span class="keywordflow">if</span> (!src_dent) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    gint64 <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a> = (src_dent-&gt;<a class="code" href="struct__SeafDirent.html#afc58a80e040b009230ce1d3d500e2f1f">version</a> &gt; 0) ? src_dent-&gt;<a class="code" href="struct__SeafDirent.html#abf0e9b6fade594b7897cb9896d370961">size</a> : -1;

    if (src_repo == dst_repo) {
        <span class="comment">/* duplicate src dirent with new name */</span>
        dst_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a> (dst_repo-&gt;version),
                                    src_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>, src_dent-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>, dst_filename,
                                    (gint64)time(NULL), user, file_size);

        <span class="comment">/* move file within the same repo */</span>
        <span class="keywordflow">if</span> (move_file_same_repo (src_repo_id,
                                 src_canon_path, src_dent,
                                 dst_canon_path, dst_dent,
                                 user, error) &lt; 0) {
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }

        <a class="code" href="server_2repo-mgr_8h.html#a1cd4a8c70076d40d2a778dda774a2263">seaf_repo_manager_cleanup_virtual_repos</a> (mgr, src_repo_id);
        <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, src_repo_id, NULL);

        update_repo_size (dst_repo_id);
    } <span class="keywordflow">else</span> {
        <span class="comment">/* move between different repos */</span>

        <span class="keywordflow">if</span> (is_virtual_repo_and_origin (src_repo, dst_repo)) {
            <span class="comment">/* duplicate src dirent with new name */</span>
            dst_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(dst_repo-&gt;version),
                                        src_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>, src_dent-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>, dst_filename,
                                        (gint64)time(NULL), user, file_size);

            <span class="comment">/* add this dirent to dst repo */</span>
            <span class="keywordflow">if</span> (put_dirent_and_commit (dst_repo,
                                       dst_canon_path,
                                       dst_dent,
                                       user,
                                       error) &lt; 0) {
                <span class="keywordflow">if</span> (!error)
                    g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                                 <span class="stringliteral">&quot;failed to put dirent&quot;</span>);
                ret = -1;
                <span class="keywordflow">goto</span> out;
            }

            <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, dst_repo_id, NULL);

            <span class="keywordflow">if</span> (<a class="code" href="Backups_2repo-op_8c.html#ad6564c23b0e50d8a34dd425432b80db4">seaf_repo_manager_del_file</a> (mgr, src_repo_id, src_path,
                                            src_filename, user, error) &lt; 0) {
                ret = -1;
                <span class="keywordflow">goto</span> out;
            }

            <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, src_repo_id, NULL);

            update_repo_size (dst_repo_id);
        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!synchronous) {
            background = TRUE;

            gint64 total_files = -1;
            <span class="keywordflow">if</span> (S_ISDIR(src_dent-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>))
                total_files = <a class="code" href="fs-mgr_8c.html#afa141245d62ac11820ad120fef68d01e">seaf_fs_manager_count_fs_files</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                                              src_repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>,
                                                              src_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                              src_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
            <span class="keywordflow">else</span>
                total_files = 1;
            <span class="keywordflow">if</span> (total_files &lt; 0) {
                seaf_warning (<span class="stringliteral">&quot;Failed to get file count.\n&quot;</span>);
                ret = -1;
                <span class="keywordflow">goto</span> out;
            }

            <span class="keywordflow">if</span> (!check_file_count_and_size (src_repo, src_dent, total_files, error)) {
                ret = -1;
                <span class="keywordflow">goto</span> out;
            }

            task_id = <a class="code" href="copy-mgr_8c.html#ae731d17024807023ab2689f9ffca5e99">seaf_copy_manager_add_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a1826aa8bcba056a4f41755627b270751">copy_mgr</a>,
                                                  src_repo_id,
                                                  src_canon_path,
                                                  src_filename,
                                                  dst_repo_id,
                                                  dst_canon_path,
                                                  dst_filename,
                                                  user,
                                                  total_files,
                                                  cross_repo_move,
                                                  need_progress);
            <span class="keywordflow">if</span> (need_progress &amp;&amp; !task_id) {
                seaf_warning (<span class="stringliteral">&quot;Failed to start copy task.\n&quot;</span>);
                g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                             <span class="stringliteral">&quot;failed to start copy task&quot;</span>);
                ret = -1;
                <span class="keywordflow">goto</span> out;
            }
        } <span class="keywordflow">else</span> {
            <span class="comment">/* Synchronous for cross-repo move */</span>
            <span class="keywordflow">if</span> (cross_repo_move (src_repo_id,
                                 src_canon_path,
                                 src_filename,
                                 dst_repo_id,
                                 dst_canon_path,
                                 dst_filename,
                                 user,
                                 NULL) &lt; 0) {
                g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                             <span class="stringliteral">&quot;Failed to move&quot;</span>);
                ret = -1;
                <span class="keywordflow">goto</span> out;
            }
        }
    }

out:
    <span class="keywordflow">if</span> (src_repo) <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (src_repo);
    <span class="keywordflow">if</span> (dst_repo) <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (dst_repo);

    <span class="keywordflow">if</span> (dst_head_commit) <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(dst_head_commit);
    
    <span class="keywordflow">if</span> (src_canon_path) g_free (src_canon_path);
    <span class="keywordflow">if</span> (dst_canon_path) g_free (dst_canon_path);
    
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a>(src_dent);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a>(dst_dent);

    <span class="keywordflow">if</span> (ret == 0) {
        res = seafile_copy_result_new ();
        g_object_set (res, <span class="stringliteral">&quot;background&quot;</span>, background, <span class="stringliteral">&quot;task_id&quot;</span>, task_id, NULL);
        g_free (task_id);
    }

    <span class="keywordflow">return</span> res;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa870306d94f3e7b16e66229040590138"></a><!-- doxytag: member="repo&#45;op.c::seaf_repo_manager_post_dir" ref="aa870306d94f3e7b16e66229040590138" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *new_dir_name, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#aa870306d94f3e7b16e66229040590138">seaf_repo_manager_post_dir</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new_dir_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l02252">2252</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (new_dir_name, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[post dir] Invalid dir name %s.\n&quot;</span>, new_dir_name);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid dir name&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="Backups_2repo-op_8c.html#a897aab32c75a36b188922b8726831ccf">FAIL_IF_FILE_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                        head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dir_name, NULL);

    <span class="keywordflow">if</span> (!new_dent) {
        new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                    <a class="code" href="seafile-4_81_82_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>, S_IFDIR, new_dir_name,
                                    (gint64)time(NULL), NULL, -1);
    }

    root_id = do_post_file (repo,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[put dir] Failed to put dir.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to put dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Added directory \&quot;%s\&quot;&quot;</span>, new_dir_name);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (root_id);
    g_free (canon_path);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a2e0e32263ad7bbeaa4ab13a62135c46a"></a><!-- doxytag: member="repo&#45;op.c::seaf_repo_manager_post_empty_file" ref="a2e0e32263ad7bbeaa4ab13a62135c46a" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *new_file_name, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a2e0e32263ad7bbeaa4ab13a62135c46a">seaf_repo_manager_post_empty_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new_file_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l02322">2322</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    <span class="keywordflow">if</span> (!canon_path)
        <span class="comment">/* no need to call get_canonical_path again when retry */</span>
        canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (new_file_name, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[post file] Invalid file name %s.\n&quot;</span>, new_file_name);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid file name&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="Backups_2repo-op_8c.html#a897aab32c75a36b188922b8726831ccf">FAIL_IF_FILE_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                        head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_file_name, NULL);

    <span class="keywordflow">if</span> (!new_dent) {
        new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                    <a class="code" href="seafile-4_81_82_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>, <a class="code" href="Backups_2repo-op_8c.html#a68c7bdf3d604f5310c1a353eab98692f">STD_FILE_MODE</a>, new_file_name,
                                    (gint64)time(NULL), user, 0);
    }

    root_id = do_post_file (repo,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[put dir] Failed to create empty file dir.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to put dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Added \&quot;%s\&quot;&quot;</span>, new_file_name);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (root_id);
    g_free (canon_path);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a3128bd2930667427a22976b6a2b85743"></a><!-- doxytag: member="repo&#45;op.c::seaf_repo_manager_post_file" ref="a3128bd2930667427a22976b6a2b85743" args="(SeafRepoManager *mgr, const char *repo_id, const char *temp_file_path, const char *parent_dir, const char *file_name, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a3128bd2930667427a22976b6a2b85743">seaf_repo_manager_post_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>temp_file_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Add a new file in a repo. The content of the file is stored in a temporary file. : id of the repo : path of the temporary file : the directory to add this file : the name of the new file : author of this operation </p>

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l00598">598</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="index_8h.html#a96e76167c968d38441e90ee0488ee4aa">sha1</a>[20];
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    <span class="keywordtype">char</span> hex[41];
    <span class="keywordtype">int</span> ret = 0;

    <span class="keywordflow">if</span> (g_access (temp_file_path, R_OK) != 0) {
        seaf_warning (<span class="stringliteral">&quot;[post file] File %s doesn&#39;t exist or not readable.\n&quot;</span>,
                      temp_file_path);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid input file&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    <span class="keywordflow">if</span> (!canon_path)
        canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (file_name, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[post file] Invalid filename %s.\n&quot;</span>, file_name);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid filename&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (strstr (parent_dir, <span class="stringliteral">&quot;//&quot;</span>) != NULL) {
        seaf_warning (<span class="stringliteral">&quot;[post file] parent_dir cantains // sequence.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid parent dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }
    
    <span class="comment">/* Write blocks. */</span>
    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> key[32], iv[16];
        <span class="keywordflow">if</span> (<a class="code" href="passwd-mgr_8c.html#a4f5b6064abbc55dff4873b288e4ea834">seaf_passwd_manager_get_decrypt_key_raw</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa6154751a20cdaa84110e1a8370c1164">passwd_mgr</a>,
                                                     repo_id, user,
                                                     key, iv) &lt; 0) {
            seaf_warning (<span class="stringliteral">&quot;Passwd for repo %s is not set.\n&quot;</span>, repo_id);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;Passwd is not set&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
        crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>, key, iv);
    }

    gint64 <a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a>;
    <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#af41e85bce809b9f05ed5b20ac5eeb745">seaf_fs_manager_index_blocks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                      repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                      temp_file_path,
                                      sha1, &amp;size, crypt, TRUE) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;failed to index blocks&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to index blocks&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a>(sha1, hex, 20);
    new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                hex, <a class="code" href="Backups_2repo-op_8c.html#a68c7bdf3d604f5310c1a353eab98692f">STD_FILE_MODE</a>, file_name,
                                (gint64)time(NULL), user, size);

    root_id = do_post_file (repo,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[post file] Failed to put file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to put file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Added \&quot;%s\&quot;&quot;</span>, file_name);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (root_id);
    g_free (canon_path);
    g_free (crypt);

    <span class="keywordflow">if</span> (ret == 0)
        update_repo_size(repo_id);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a0d6750947e09a7c4f4eb2146147e9db1"></a><!-- doxytag: member="repo&#45;op.c::seaf_repo_manager_post_file_blocks" ref="a0d6750947e09a7c4f4eb2146147e9db1" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *file_name, const char *blockids_json, const char *paths_json, const char *user, gint64 file_size, int replace_existed, char **new_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a0d6750947e09a7c4f4eb2146147e9db1">seaf_repo_manager_post_file_blocks</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>blockids_json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>paths_json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gint64&#160;</td>
          <td class="paramname"><em>file_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>replace_existed</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>new_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l01099">1099</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="index_8h.html#a96e76167c968d38441e90ee0488ee4aa">sha1</a>[20];
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    GList *blockids = NULL, *paths = NULL, *ptr;
    <span class="keywordtype">char</span> hex[41];
    <span class="keywordtype">int</span> ret = 0;

    blockids = json_to_file_list (blockids_json);
    paths = json_to_file_list (paths_json);
    <span class="keywordflow">if</span> (g_list_length(blockids) != g_list_length(paths)) {
        seaf_warning (<span class="stringliteral">&quot;[post-blks] Invalid blockids or paths.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Invalid files&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">for</span> (ptr = paths; ptr; ptr = ptr-&gt;next) {
        <span class="keywordtype">char</span> *temp_file_path = ptr-&gt;data;
        <span class="keywordflow">if</span> (g_access (temp_file_path, R_OK) != 0) {
            seaf_warning (<span class="stringliteral">&quot;[post-blks] File block %s doesn&#39;t exist or not readable.\n&quot;</span>,
                          temp_file_path);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                         <span class="stringliteral">&quot;Invalid input file&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    <span class="keywordflow">if</span> (!canon_path)
        canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (file_name, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[post-blks] Invalid filename %s.\n&quot;</span>, file_name);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid filename&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (strstr (parent_dir, <span class="stringliteral">&quot;//&quot;</span>) != NULL) {
        seaf_warning (<span class="stringliteral">&quot;[post-blks] parent_dir cantains // sequence.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid parent dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Write blocks. */</span>
    <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#a562e73b605551b411fc8ccd333e26d36">seaf_fs_manager_index_file_blocks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                           repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                           paths,
                                           blockids, sha1, <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;Failed to index file blocks&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to index blocks&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a>(sha1, hex, 20);
    new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                hex, <a class="code" href="Backups_2repo-op_8c.html#a68c7bdf3d604f5310c1a353eab98692f">STD_FILE_MODE</a>, file_name,
                                (gint64)time(NULL), user, <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>);

    root_id = do_post_file_replace (repo, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                    canon_path, replace_existed, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[post-blks] Failed to post file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to put file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    *new_id = g_strdup(hex);
    snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Added \&quot;%s\&quot;&quot;</span>, file_name);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0)
        ret = -1;

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (blockids);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (paths);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (root_id);
    g_free (canon_path);

    <span class="keywordflow">if</span> (ret == 0)
        update_repo_size(repo_id);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae7346d14d7ad21fef1537bf44b50273e"></a><!-- doxytag: member="repo&#45;op.c::seaf_repo_manager_post_multi_files" ref="ae7346d14d7ad21fef1537bf44b50273e" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *filenames_json, const char *paths_json, const char *user, int replace_existed, char **ret_json, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#ae7346d14d7ad21fef1537bf44b50273e">seaf_repo_manager_post_multi_files</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>filenames_json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>paths_json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>replace_existed</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>ret_json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l00950">950</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    GList *filenames = NULL, *paths = NULL, *id_list = NULL, *name_list = NULL,
        *size_list = NULL, *ptr;
    <span class="keywordtype">char</span> *filename, *path;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="index_8h.html#a96e76167c968d38441e90ee0488ee4aa">sha1</a>[20];
    GString *buf = g_string_new (NULL);
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt = NULL;
    <span class="keywordtype">char</span> hex[41];
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    canon_path = get_canonical_path (parent_dir);

    <span class="comment">/* Decode file name and tmp file paths from json. */</span>
    filenames = json_to_file_list (filenames_json);
    paths = json_to_file_list (paths_json);
    <span class="keywordflow">if</span> (!filenames || !paths) {
        seaf_warning (<span class="stringliteral">&quot;[post files] Invalid filenames or paths.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Invalid files&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Check inputs. */</span>
    <span class="keywordflow">for</span> (ptr = filenames; ptr; ptr = ptr-&gt;next) {
        filename = ptr-&gt;data;
        <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (filename, NULL)) {
            seaf_warning (<span class="stringliteral">&quot;[post files] Invalid filename %s.\n&quot;</span>, filename);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile_8h.html#a9bfa592ef51a797800aae08840640fc8">POST_FILE_ERR_FILENAME</a>,
                         <span class="stringliteral">&quot;%s&quot;</span>, filename);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    <span class="keywordflow">if</span> (strstr (parent_dir, <span class="stringliteral">&quot;//&quot;</span>) != NULL) {
        seaf_warning (<span class="stringliteral">&quot;[post file] parent_dir cantains // sequence.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid parent dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Index tmp files and get file id list. */</span>
    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> key[32], iv[16];
        <span class="keywordflow">if</span> (<a class="code" href="passwd-mgr_8c.html#a4f5b6064abbc55dff4873b288e4ea834">seaf_passwd_manager_get_decrypt_key_raw</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa6154751a20cdaa84110e1a8370c1164">passwd_mgr</a>,
                                                     repo_id, user,
                                                     key, iv) &lt; 0) {
            seaf_warning (<span class="stringliteral">&quot;Passwd for repo %s is not set.\n&quot;</span>, repo_id);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;Passwd is not set&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
        crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>, key, iv);
    }

    gint64 *<a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a>;
    <span class="keywordflow">for</span> (ptr = paths; ptr; ptr = ptr-&gt;next) {
        path = ptr-&gt;data;

        size = g_new (gint64, 1);
        <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#af41e85bce809b9f05ed5b20ac5eeb745">seaf_fs_manager_index_blocks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                          repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                          path, sha1, size, crypt, TRUE) &lt; 0) {
            seaf_warning (<span class="stringliteral">&quot;failed to index blocks&quot;</span>);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;Failed to index blocks&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }

        <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a>(sha1, hex, 20);
        id_list = g_list_prepend (id_list, g_strdup(hex));
        size_list = g_list_prepend (size_list, size);
    }
    id_list = g_list_reverse (id_list);
    size_list = g_list_reverse (size_list);

    <span class="comment">/* Add the files to parent dir and commit. */</span>
    root_id = do_post_multi_files (repo, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path,
                                   filenames, id_list, size_list, user,
                                   replace_existed, &amp;name_list);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[post file] Failed to put file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>,
                     <span class="stringliteral">&quot;Failed to put file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    guint len = g_list_length (filenames);
    <span class="keywordflow">if</span> (len &gt; 1)
        g_string_printf (buf, <span class="stringliteral">&quot;Added \&quot;%s\&quot; and %u more files.&quot;</span>,
                         (<span class="keywordtype">char</span> *)(filenames-&gt;data), len - 1);
    <span class="keywordflow">else</span>
        g_string_printf (buf, <span class="stringliteral">&quot;Added \&quot;%s\&quot;.&quot;</span>, (<span class="keywordtype">char</span> *)(filenames-&gt;data));

    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf-&gt;str, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

    <span class="keywordflow">if</span> (ret_json)
        *ret_json = format_json_ret (name_list, id_list, size_list);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (filenames);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (paths);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (id_list);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (name_list);
    <span class="keywordflow">for</span> (ptr = size_list; ptr; ptr = ptr-&gt;next)
        g_free (ptr-&gt;data);
    g_list_free (size_list);
    g_string_free (buf, TRUE);
    g_free (root_id);
    g_free (canon_path);
    g_free (crypt);

    <span class="keywordflow">if</span> (ret == 0)
        update_repo_size(repo_id);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a46c094895964e060809372262c9b9923"></a><!-- doxytag: member="repo&#45;op.c::seaf_repo_manager_put_file" ref="a46c094895964e060809372262c9b9923" args="(SeafRepoManager *mgr, const char *repo_id, const char *temp_file_path, const char *parent_dir, const char *file_name, const char *user, const char *head_id, char **new_file_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a46c094895964e060809372262c9b9923">seaf_repo_manager_put_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>temp_file_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>head_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>new_file_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Update an existing file in a repo : same as seaf_repo_manager_post_file : the commit id for the original file version. It's optional. If it's NULL, the current repo head will be used. : The return location of the new file id </p>

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l02688">2688</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="index_8h.html#a96e76167c968d38441e90ee0488ee4aa">sha1</a>[20];
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    <span class="keywordtype">char</span> hex[41];
    <span class="keywordtype">char</span> *old_file_id = NULL, *fullpath = NULL;
    <span class="keywordtype">int</span> ret = 0;

    <span class="keywordflow">if</span> (g_access (temp_file_path, R_OK) != 0) {
        seaf_warning (<span class="stringliteral">&quot;[put file] File %s doesn&#39;t exist or not readable.\n&quot;</span>,
                      temp_file_path);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid input file&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <span class="keyword">const</span> <span class="keywordtype">char</span> *base = head_id ? head_id : repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>;
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, base);

    <span class="keywordflow">if</span> (!canon_path)
        canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (file_name, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[put file] Invalid filename %s.\n&quot;</span>, file_name);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid filename&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (strstr (parent_dir, <span class="stringliteral">&quot;//&quot;</span>) != NULL) {
        seaf_warning (<span class="stringliteral">&quot;[put file] parent_dir cantains // sequence.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid parent dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }
    
    <a class="code" href="Backups_2repo-op_8c.html#a5b81d4727cc3ed61fabaf57e9ec58fbc">FAIL_IF_FILE_NOT_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, file_name, NULL);

    <span class="comment">/* Write blocks. */</span>
    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> key[32], iv[16];
        <span class="keywordflow">if</span> (<a class="code" href="passwd-mgr_8c.html#a4f5b6064abbc55dff4873b288e4ea834">seaf_passwd_manager_get_decrypt_key_raw</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa6154751a20cdaa84110e1a8370c1164">passwd_mgr</a>,
                                                     repo_id, user,
                                                     key, iv) &lt; 0) {
            seaf_warning (<span class="stringliteral">&quot;Passwd for repo %s is not set.\n&quot;</span>, repo_id);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;Passwd is not set&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
        crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>, key, iv);
    }

    gint64 <a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a>;
    <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#af41e85bce809b9f05ed5b20ac5eeb745">seaf_fs_manager_index_blocks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                      repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                      temp_file_path,
                                      sha1, &amp;size, crypt, TRUE) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;failed to index blocks&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to index blocks&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }
        
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a>(sha1, hex, 20);
    new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                hex, <a class="code" href="Backups_2repo-op_8c.html#a68c7bdf3d604f5310c1a353eab98692f">STD_FILE_MODE</a>, file_name,
                                (gint64)time(NULL), user, size);

    <span class="keywordflow">if</span> (!fullpath)
        fullpath = g_build_filename(parent_dir, file_name, NULL);

    old_file_id = <a class="code" href="fs-mgr_8c.html#a60a96b2445ab49d626baac6b16e75fe9">seaf_fs_manager_path_to_obj_id</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                  head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                                  fullpath, NULL, NULL);

    <span class="keywordflow">if</span> (g_strcmp0(old_file_id, new_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>) == 0) {
        <span class="keywordflow">if</span> (new_file_id)
            *new_file_id = g_strdup(new_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
        <span class="keywordflow">goto</span> out;
    }

    root_id = do_put_file (repo, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[put file] Failed to put file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to put file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Modified \&quot;%s\&quot;&quot;</span>, file_name);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id, user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;       
    }

    <span class="keywordflow">if</span> (new_file_id)
        *new_file_id = g_strdup(new_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (root_id);
    g_free (canon_path);
    g_free (crypt);
    g_free (old_file_id);
    g_free (fullpath);

    <span class="keywordflow">if</span> (ret == 0) {
        update_repo_size (repo_id);
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aad15cfaf3210b47e9f59a481073aafbc"></a><!-- doxytag: member="repo&#45;op.c::seaf_repo_manager_put_file_blocks" ref="aad15cfaf3210b47e9f59a481073aafbc" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *file_name, const char *blockids_json, const char *paths_json, const char *user, const char *head_id, gint64 file_size, char **new_file_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#aad15cfaf3210b47e9f59a481073aafbc">seaf_repo_manager_put_file_blocks</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>blockids_json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>paths_json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>head_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gint64&#160;</td>
          <td class="paramname"><em>file_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>new_file_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l02938">2938</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="index_8h.html#a96e76167c968d38441e90ee0488ee4aa">sha1</a>[20];
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    <span class="keywordtype">char</span> hex[41];
    GList *blockids = NULL, *paths = NULL, *ptr;
    <span class="keywordtype">char</span> *old_file_id = NULL, *fullpath = NULL;
    <span class="keywordtype">int</span> ret = 0;

    blockids = json_to_file_list (blockids_json);
    paths = json_to_file_list (paths_json);
    <span class="keywordflow">if</span> (g_list_length(blockids) != g_list_length(paths)) {
        seaf_warning (<span class="stringliteral">&quot;[put-blks] Invalid blockids or paths.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Invalid files&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }


    <span class="keywordflow">for</span> (ptr = paths; ptr; ptr = ptr-&gt;next) {
        <span class="keywordtype">char</span> *temp_file_path = ptr-&gt;data;
        <span class="keywordflow">if</span> (g_access (temp_file_path, R_OK) != 0) {
            seaf_warning (<span class="stringliteral">&quot;[put-blks] File block %s doesn&#39;t exist or not readable.\n&quot;</span>,
                          temp_file_path);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                         <span class="stringliteral">&quot;Invalid input file&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <span class="keyword">const</span> <span class="keywordtype">char</span> *base = head_id ? head_id : repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>;
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, base);

    <span class="keywordflow">if</span> (!canon_path)
        canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (file_name, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[put-blks] Invalid filename %s.\n&quot;</span>, file_name);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid filename&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (strstr (parent_dir, <span class="stringliteral">&quot;//&quot;</span>) != NULL) {
        seaf_warning (<span class="stringliteral">&quot;[put-blks] parent_dir cantains // sequence.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid parent dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="Backups_2repo-op_8c.html#a5b81d4727cc3ed61fabaf57e9ec58fbc">FAIL_IF_FILE_NOT_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, file_name, NULL);

    <span class="comment">/* Write blocks. */</span>
    <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#a562e73b605551b411fc8ccd333e26d36">seaf_fs_manager_index_file_blocks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                           repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                           paths,
                                           blockids, sha1, <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;failed to index blocks&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to index blocks&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a>(sha1, hex, 20);
    new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                hex, <a class="code" href="Backups_2repo-op_8c.html#a68c7bdf3d604f5310c1a353eab98692f">STD_FILE_MODE</a>, file_name,
                                (gint64)time(NULL), user, <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>);

    <span class="keywordflow">if</span> (!fullpath)
        fullpath = g_build_filename(parent_dir, file_name, NULL);

    old_file_id = <a class="code" href="fs-mgr_8c.html#a60a96b2445ab49d626baac6b16e75fe9">seaf_fs_manager_path_to_obj_id</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                  head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                                  fullpath, NULL, NULL);

    <span class="keywordflow">if</span> (g_strcmp0(old_file_id, new_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>) == 0) {
        <span class="keywordflow">if</span> (new_file_id)
            *new_file_id = g_strdup(new_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
        <span class="keywordflow">goto</span> out;
    }

    root_id = do_put_file (repo, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[put-blks] Failed to put file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to put file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Modified \&quot;%s\&quot;&quot;</span>, file_name);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id, user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (new_file_id)
        *new_file_id = g_strdup(new_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (blockids);
    <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (paths);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (root_id);
    g_free (canon_path);
    g_free (old_file_id);
    g_free (fullpath);

    <span class="keywordflow">if</span> (ret == 0) {
        update_repo_size (repo_id);
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae68e4b6427bb239b697e515c8617cbfb"></a><!-- doxytag: member="repo&#45;op.c::seaf_repo_manager_rename_file" ref="ae68e4b6427bb239b697e515c8617cbfb" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *oldname, const char *newname, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#ae68e4b6427bb239b697e515c8617cbfb">seaf_repo_manager_rename_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>oldname</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>newname</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l02510">2510</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *root_id = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">int</span> <a class="code" href="index_8h.html#ac1b4d694fc07a39e06900e82872aac7f">mode</a> = 0;
    <span class="keywordtype">int</span> ret = 0;

    <span class="keywordflow">if</span> (strcmp(oldname, newname) == 0)
        <span class="keywordflow">return</span> 0;
    
    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
    
    <span class="keywordflow">if</span> (!canon_path)
        canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2Backups_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (newname, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[rename file] Invalid filename %s.\n&quot;</span>, newname);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid filename&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="Backups_2repo-op_8c.html#a5b81d4727cc3ed61fabaf57e9ec58fbc">FAIL_IF_FILE_NOT_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, oldname, &amp;mode);
    <a class="code" href="Backups_2repo-op_8c.html#a897aab32c75a36b188922b8726831ccf">FAIL_IF_FILE_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                        head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, newname, NULL);

    root_id = do_rename_file (repo, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path,
                              oldname, newname);
    <span class="keywordflow">if</span> (!root_id) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;faile to rename file %s&quot;</span>, oldname);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    <span class="keywordflow">if</span> (S_ISDIR(mode)) {
        snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Renamed directory \&quot;%s\&quot;&quot;</span>, oldname);
    } <span class="keywordflow">else</span> {
        snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Renamed \&quot;%s\&quot;&quot;</span>, oldname);
    }

    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a1cd4a8c70076d40d2a778dda774a2263">seaf_repo_manager_cleanup_virtual_repos</a> (mgr, repo_id);
    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (head_commit);
    g_free (canon_path);
    g_free (root_id);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="abf48f3efee4705f32fa8f3a95098921e"></a><!-- doxytag: member="repo&#45;op.c::seaf_repo_manager_revert_dir" ref="abf48f3efee4705f32fa8f3a95098921e" args="(SeafRepoManager *mgr, const char *repo_id, const char *old_commit_id, const char *dir_path, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#abf48f3efee4705f32fa8f3a95098921e">seaf_repo_manager_revert_dir</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>old_commit_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dir_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l03496">3496</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL, *old_commit = NULL;
    <span class="keywordtype">char</span> *parent_dir = NULL, *dirname = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *old_dent = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL, *root_id = NULL;
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    gboolean parent_dir_exist = FALSE;
    gboolean revert_to_root = FALSE;
    gboolean skipped = FALSE;
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    <span class="comment">/* If old_commit_id is head commit, do nothing. */</span>
    <span class="keywordflow">if</span> (strcmp(repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>, old_commit_id) == 0) {
        <a class="code" href="seafile-4_81_82_2lib_2include_8h.html#ae5a5c3cadbc1f6e2363d25fc0fb46084">g_debug</a> (<span class="stringliteral">&quot;[revert dir] commit is head, do nothing\n&quot;</span>);
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (!old_commit) {
        <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(old_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, old_commit_id);
        <span class="keywordflow">if</span> (strcmp(old_commit-&gt;repo_id, repo_id) != 0) {
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a53023377dfe455de5672c199e9f2e831">SEAF_ERR_BAD_COMMIT</a>,
                         <span class="stringliteral">&quot;bad commit id&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    <span class="keywordflow">if</span> (!canon_path) {
        canon_path = get_canonical_path (dir_path);

        parent_dir  = g_path_get_dirname(canon_path);
        dirname = g_path_get_basename(canon_path);

        old_dent = get_dirent_by_path (repo, old_commit-&gt;root_id,
                                       parent_dir, dirname, error);
        <span class="keywordflow">if</span> (*error) {
            seaf_warning (<span class="stringliteral">&quot;[revert dir] error: %s\n&quot;</span>, (*error)-&gt;message);
            g_clear_error (error);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;internal error&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    parent_dir_exist = detect_path_exist (repo,
                                          head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                          parent_dir, error);
    <span class="keywordflow">if</span> (*error) {
        seaf_warning (<span class="stringliteral">&quot;[revert dir] error: %s\n&quot;</span>, (*error)-&gt;message);
        g_clear_error (error);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;internal error&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }
    
    <span class="keywordflow">if</span> (!parent_dir_exist) {
        <span class="comment">/* When parent dir does not exist, revert this file to root dir. */</span>
        revert_to_root = TRUE;
        root_id = revert_dir (repo,
                              head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                              <span class="stringliteral">&quot;/&quot;</span>,
                              old_dent,
                              &amp;skipped, error);
    } <span class="keywordflow">else</span> {
        revert_to_root = FALSE;
        root_id = revert_dir (repo,
                              head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                              parent_dir,
                              old_dent,
                              &amp;skipped, error);
    }

    <span class="keywordflow">if</span> (*error) {
        seaf_warning (<span class="stringliteral">&quot;[revert dir] error: %s\n&quot;</span>, (*error)-&gt;message);
        g_clear_error (error);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;internal error&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (skipped) {
        <span class="keywordflow">goto</span> out;
    }
    
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[revert dir] Failed to revert dir.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to revert dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Recovered deleted directory \&quot;%s\&quot;&quot;</span>, dirname);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (head_commit);
    <span class="keywordflow">if</span> (old_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (old_commit);

    g_free (root_id);
    g_free (parent_dir);
    g_free (dirname);

    g_free (canon_path);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (old_dent);

<span class="preprocessor">#define REVERT_TO_ROOT              0x1</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (ret == 0) {
        <span class="keywordflow">if</span> (revert_to_root)
            ret |= <a class="code" href="Backups_2repo-op_8c.html#a65c9627aee501057c2e4968adbd34c71">REVERT_TO_ROOT</a>;
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a352b05f8d991d13b5d5e1f0ee1b7616c"></a><!-- doxytag: member="repo&#45;op.c::seaf_repo_manager_revert_file" ref="a352b05f8d991d13b5d5e1f0ee1b7616c" args="(SeafRepoManager *mgr, const char *repo_id, const char *old_commit_id, const char *file_path, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a352b05f8d991d13b5d5e1f0ee1b7616c">seaf_repo_manager_revert_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>old_commit_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l03281">3281</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL, *old_commit = NULL;
    <span class="keywordtype">char</span> *parent_dir = NULL, *filename = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *old_dent = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL, *root_id = NULL;
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> time_str[512];
    gboolean parent_dir_exist = FALSE;
    gboolean revert_to_root = FALSE;
    gboolean skipped = FALSE;
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    <span class="comment">/* If old_commit_id is head commit, do nothing. */</span>
    <span class="keywordflow">if</span> (strcmp(repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>, old_commit_id) == 0) {
        <a class="code" href="seafile-4_81_82_2lib_2include_8h.html#ae5a5c3cadbc1f6e2363d25fc0fb46084">g_debug</a> (<span class="stringliteral">&quot;[revert file] commit is head, do nothing\n&quot;</span>);
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (!old_commit) {
        <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(old_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, old_commit_id);
        <span class="keywordflow">if</span> (strcmp(old_commit-&gt;repo_id, repo_id) != 0) {
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a53023377dfe455de5672c199e9f2e831">SEAF_ERR_BAD_COMMIT</a>,
                         <span class="stringliteral">&quot;bad commit id&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    <span class="keywordflow">if</span> (!canon_path) {
        canon_path = get_canonical_path (file_path);
        <span class="keywordflow">if</span> (canon_path[strlen(canon_path) -1 ] == <span class="charliteral">&#39;/&#39;</span>) {
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a53023377dfe455de5672c199e9f2e831">SEAF_ERR_BAD_COMMIT</a>,
                         <span class="stringliteral">&quot;bad target file path&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }

        parent_dir  = g_path_get_dirname(canon_path);
        filename = g_path_get_basename(canon_path);

        old_dent = get_dirent_by_path (repo, old_commit-&gt;root_id,
                                       parent_dir, filename, error);
        <span class="keywordflow">if</span> (*error) {
            seaf_warning (<span class="stringliteral">&quot;[revert file] error: %s\n&quot;</span>, (*error)-&gt;message);
            g_clear_error (error);
            g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;internal error&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    parent_dir_exist = detect_path_exist (repo,
                                          head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                          parent_dir, error);
    <span class="keywordflow">if</span> (*error) {
        seaf_warning (<span class="stringliteral">&quot;[revert file] error: %s\n&quot;</span>, (*error)-&gt;message);
        g_clear_error (error);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;internal error&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }
    
    <span class="keywordflow">if</span> (!parent_dir_exist) {
        <span class="comment">/* When parent dir does not exist, revert this file to root dir. */</span>
        revert_to_root = TRUE;
        root_id = revert_file_to_root (repo,
                                       head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                       old_dent,
                                       &amp;skipped, error);
    } <span class="keywordflow">else</span> {
        revert_to_root = FALSE;
        root_id = revert_file_to_parent_dir (repo,
                                             head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, parent_dir,
                                             old_dent,
                                             &amp;skipped, error);
    }

    <span class="keywordflow">if</span> (*error) {
        seaf_warning (<span class="stringliteral">&quot;[revert file] error: %s\n&quot;</span>, (*error)-&gt;message);
        g_clear_error (error);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;internal error&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (skipped) {
        <span class="keywordflow">goto</span> out;
    }
    
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[revert file] Failed to revert file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to revert file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
<span class="preprocessor">#ifndef WIN32</span>
<span class="preprocessor"></span>    strftime (time_str, <span class="keyword">sizeof</span>(time_str), <span class="stringliteral">&quot;%F %T&quot;</span>,
              localtime((time_t *)(&amp;old_commit-&gt;ctime)));
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>    strftime (time_str, <span class="keyword">sizeof</span>(time_str), <span class="stringliteral">&quot;%Y-%m-%d %H:%M:%S&quot;</span>,
              localtime((time_t *)(&amp;old_commit-&gt;ctime)));
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    snprintf(buf, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Reverted file \&quot;%s\&quot; to status at %s&quot;</span>, filename, time_str);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (head_commit);
    <span class="keywordflow">if</span> (old_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (old_commit);

    g_free (root_id);
    g_free (parent_dir);
    g_free (filename);

    g_free (canon_path);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (old_dent);

<span class="preprocessor">#define REVERT_TO_ROOT              0x1</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (ret == 0) {
        <span class="keywordflow">if</span> (revert_to_root)
            ret |= <a class="code" href="Backups_2repo-op_8c.html#a65c9627aee501057c2e4968adbd34c71">REVERT_TO_ROOT</a>;
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a75071fddf41a1371d4f89be8d2b59b88"></a><!-- doxytag: member="repo&#45;op.c::seaf_repo_manager_revert_on_server" ref="a75071fddf41a1371d4f89be8d2b59b88" args="(SeafRepoManager *mgr, const char *repo_id, const char *commit_id, const char *user_name, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a75071fddf41a1371d4f89be8d2b59b88">seaf_repo_manager_revert_on_server</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>commit_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l04321">4321</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit = NULL, *new_commit = NULL;
    <span class="keywordtype">char</span> desc[512];
    <span class="keywordtype">int</span> ret = 0;

retry:
    repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (!repo) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;No such repo&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    commit = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                             repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, 
                                             commit_id);
    <span class="keywordflow">if</span> (!commit) {
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Commit doesn&#39;t exist&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

<span class="preprocessor">#ifndef WIN32</span>
<span class="preprocessor"></span>    strftime (desc, <span class="keyword">sizeof</span>(desc), <span class="stringliteral">&quot;Reverted repo to status at %F %T.&quot;</span>, 
              localtime((time_t *)(&amp;commit-&gt;<a class="code" href="struct__SeafCommit.html#ae3f1657ab475921889a1e9c74b94e7a2">ctime</a>)));
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>    strftime (desc, <span class="keyword">sizeof</span>(desc), <span class="stringliteral">&quot;Reverted repo to status at %Y-%m-%d %H:%M:%S.&quot;</span>,
              localtime((time_t *)(&amp;commit-&gt;<a class="code" href="struct__SeafCommit.html#ae3f1657ab475921889a1e9c74b94e7a2">ctime</a>)));
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    new_commit = <a class="code" href="commit-mgr_8c.html#afe68dfa15b1bbd8557b044b1b1b58dc2">seaf_commit_new</a> (NULL, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                  user_name, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>,
                                  desc, 0);

    new_commit-&gt;parent_id = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
    <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a39a9a41ffdfc324f3c935251d9e14d51">seaf_repo_to_commit</a> (repo, new_commit);

    <span class="keywordflow">if</span> (<a class="code" href="commit-mgr_8c.html#a7c138604e615440b65741b77e71248c6">seaf_commit_manager_add_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>, new_commit) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="branch-mgr_8c.html#a7a776ebd084d2335050c68d9a2e10c18">seaf_branch_set_commit</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>, new_commit-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
    <span class="keywordflow">if</span> (seaf_branch_manager_test_and_update_branch (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>,
                                                    repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>,
                                                    new_commit-&gt;parent_id) &lt; 0)
    {
        seaf_warning (<span class="stringliteral">&quot;[revert] Concurrent branch update, retry.\n&quot;</span>);
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (new_commit);
        repo = NULL;
        commit = new_commit = NULL;
        <span class="keywordflow">goto</span> retry;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (new_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (new_commit);
    <span class="keywordflow">if</span> (commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);

    <span class="keywordflow">if</span> (ret == 0) {
        update_repo_size (repo_id);
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a3702d0c75995d0221e33b9ba673b99fd"></a><!-- doxytag: member="repo&#45;op.c::seaf_repo_manager_update_dir" ref="a3702d0c75995d0221e33b9ba673b99fd" args="(SeafRepoManager *mgr, const char *repo_id, const char *dir_path, const char *new_dir_id, const char *user, const char *head_id, char *new_commit_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a3702d0c75995d0221e33b9ba673b99fd">seaf_repo_manager_update_dir</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dir_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new_dir_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>head_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>new_commit_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Backups_2repo-op_8c_source.html#l02854">2854</a> of file <a class="el" href="Backups_2repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">char</span> *parent = NULL, *dirname = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    <span class="keywordtype">char</span> *root_id = NULL;
    <span class="keywordtype">char</span> *commit_desc = NULL;
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="Backups_2repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <span class="keyword">const</span> <span class="keywordtype">char</span> *base = head_id ? head_id : repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>;
    <a class="code" href="Backups_2repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, base);

    <span class="comment">/* Are we updating the root? */</span>
    <span class="keywordflow">if</span> (strcmp (dir_path, <span class="stringliteral">&quot;/&quot;</span>) == 0) {
        commit_desc = gen_commit_description (repo, new_dir_id, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>);
        <span class="keywordflow">if</span> (!commit_desc)
            commit_desc = g_strdup(<span class="stringliteral">&quot;Auto merge by system&quot;</span>);

        <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, new_dir_id,
                            user, commit_desc, new_commit_id, error) &lt; 0)
            ret = -1;
        g_free (commit_desc);
        <span class="keywordflow">goto</span> out;
    }

    parent = g_path_get_dirname (dir_path);
    canon_path = get_canonical_path (parent);
    g_free (parent);

    dirname = g_path_get_basename (dir_path);

    <a class="code" href="Backups_2repo-op_8c.html#a5b81d4727cc3ed61fabaf57e9ec58fbc">FAIL_IF_FILE_NOT_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, dirname, NULL);

    new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                new_dir_id, S_IFDIR, dirname,
                                (gint64)time(NULL), NULL, -1);

    root_id = do_put_file (repo, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[update dir] Failed to put file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to update dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    commit_desc = gen_commit_description (repo, root_id, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>);
    <span class="keywordflow">if</span> (!commit_desc)
        commit_desc = g_strdup(<span class="stringliteral">&quot;Auto merge by system&quot;</span>);

    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, commit_desc, new_commit_id, error) &lt; 0) {
        ret = -1;
        g_free (commit_desc);
        <span class="keywordflow">goto</span> out;
    }
    g_free (commit_desc);

out:
    <a class="code" href="fuse_2Backups_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (head_commit);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (canon_path);
    g_free (dirname);
    g_free (root_id);

    <span class="keywordflow">if</span> (ret == 0)
        update_repo_size (repo_id);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a77f4492f1c388625ccf09d84f053913f"></a><!-- doxytag: member="repo&#45;op.c::should_ignore_file" ref="a77f4492f1c388625ccf09d84f053913f" args="(const char *filename, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gboolean <a class="el" href="repo-op_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>data</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2Backups_2repo-mgr_8c_source.html#l00237">237</a> of file <a class="el" href="server_2Backups_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">/* GPatternSpec **spec = ignore_patterns; */</span>

    <span class="keywordflow">if</span> (!g_utf8_validate (filename, -1, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;File name %s contains non-UTF8 characters, skip.\n&quot;</span>, filename);
        <span class="keywordflow">return</span> TRUE;
    }

    <span class="comment">/* Ignore file/dir if its name is too long. */</span>
    <span class="keywordflow">if</span> (strlen(filename) &gt;= <a class="code" href="fs-mgr_8h.html#ae95c413b4d740d94ac0cc8becc46e61e">SEAF_DIR_NAME_LEN</a>)
        <span class="keywordflow">return</span> TRUE;

    <span class="keywordflow">if</span> (strchr (filename, <span class="charliteral">&#39;/&#39;</span>))
        <span class="keywordflow">return</span> TRUE;

    <span class="keywordflow">return</span> FALSE;
}
</pre></div>
</div>
</div>
</div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Wed Aug 19 2015 03:19:57 for My Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
