<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>My Project: seafile-4.1.2/server/seafile-session.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">My Project
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">seafile-4.1.2/server/seafile-session.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="server_2seafile-session_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="preprocessor">#include &quot;common.h&quot;</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;stdint.h&gt;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;dirent.h&gt;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;glib.h&gt;</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;<a class="code" href="cevent_8h.html">ccnet/cevent.h</a>&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;utils.h&quot;</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="server_2seafile-session_8h.html">seafile-session.h</a>&quot;</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="monitor-rpc-wrappers_8h.html">monitor-rpc-wrappers.h</a>&quot;</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="seaf-db_8h.html">seaf-db.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="seaf-utils_8h.html">seaf-utils.h</a>&quot;</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;log.h&quot;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a><a class="code" href="server_2seafile-session_8c.html#a8d84c178a7097e7fb4f914354c777e2e">00031</a> <span class="preprocessor">#define CONNECT_INTERVAL_MSEC 10 * 1000</span>
<a name="l00032"></a>00032 <span class="preprocessor"></span>
<a name="l00033"></a><a class="code" href="server_2seafile-session_8c.html#a1fe6c934fd7ec758c18a80fe2f2fcc7b">00033</a> <span class="preprocessor">#define DEFAULT_THREAD_POOL_SIZE 500</span>
<a name="l00034"></a><a class="code" href="server_2seafile-session_8c.html#ad496b5a85651509c1813bd5d55cef62c">00034</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_RPC_THREAD_POOL_SIZE 50</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span>
<a name="l00036"></a>00036 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00037"></a>00037 load_thread_pool_config (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *<a class="code" href="cluster-mgr_8c.html#af241ba8540cd17c31a02b56c2aaa126c">session</a>);
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <a class="code" href="struct__SeafileSession.html">SeafileSession</a> *
<a name="l00040"></a><a class="code" href="server_2seafile-session_8c.html#a0b798c25bac6e3cf1ae73cd62ac88f61">00040</a> <a class="code" href="daemon_2seafile-session_8c.html#a3eea8fbb412edb5ff72027285edb7c72">seafile_session_new</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *seafile_dir,
<a name="l00041"></a>00041                     <a class="code" href="struct__CcnetClient.html">CcnetClient</a> *ccnet_session)
<a name="l00042"></a>00042 {
<a name="l00043"></a>00043     <span class="keywordtype">char</span> *abs_seafile_dir;
<a name="l00044"></a>00044     <span class="keywordtype">char</span> *tmp_file_dir;
<a name="l00045"></a>00045     <span class="keywordtype">char</span> *config_file_path;
<a name="l00046"></a>00046     GKeyFile *config;
<a name="l00047"></a>00047     <a class="code" href="struct__SeafileSession.html">SeafileSession</a> *<a class="code" href="cluster-mgr_8c.html#af241ba8540cd17c31a02b56c2aaa126c">session</a> = NULL;
<a name="l00048"></a>00048 
<a name="l00049"></a>00049     <span class="keywordflow">if</span> (!ccnet_session)
<a name="l00050"></a>00050         <span class="keywordflow">return</span> NULL;
<a name="l00051"></a>00051 
<a name="l00052"></a>00052     abs_seafile_dir = <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ad52e8a09737b9afc6375f8cee7336d7d">ccnet_expand_path</a> (seafile_dir);
<a name="l00053"></a>00053     tmp_file_dir = g_build_filename (abs_seafile_dir, <span class="stringliteral">&quot;tmpfiles&quot;</span>, NULL);
<a name="l00054"></a>00054     config_file_path = g_build_filename (abs_seafile_dir, <span class="stringliteral">&quot;seafile.conf&quot;</span>, NULL);
<a name="l00055"></a>00055 
<a name="l00056"></a>00056     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ace0bdb78b60b2d088517a3e03a448e8b">checkdir_with_mkdir</a> (abs_seafile_dir) &lt; 0) {
<a name="l00057"></a>00057         g_warning (<span class="stringliteral">&quot;Config dir %s does not exist and is unable to create\n&quot;</span>,
<a name="l00058"></a>00058                    abs_seafile_dir);
<a name="l00059"></a>00059         <span class="keywordflow">goto</span> onerror;
<a name="l00060"></a>00060     }
<a name="l00061"></a>00061 
<a name="l00062"></a>00062     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ace0bdb78b60b2d088517a3e03a448e8b">checkdir_with_mkdir</a> (tmp_file_dir) &lt; 0) {
<a name="l00063"></a>00063         g_warning (<span class="stringliteral">&quot;Temp file dir %s does not exist and is unable to create\n&quot;</span>,
<a name="l00064"></a>00064                    tmp_file_dir);
<a name="l00065"></a>00065         <span class="keywordflow">goto</span> onerror;
<a name="l00066"></a>00066     }
<a name="l00067"></a>00067 
<a name="l00068"></a>00068     GError *error = NULL;
<a name="l00069"></a>00069     config = g_key_file_new ();
<a name="l00070"></a>00070     <span class="keywordflow">if</span> (!g_key_file_load_from_file (config, config_file_path, 
<a name="l00071"></a>00071                                     G_KEY_FILE_NONE, &amp;error)) {
<a name="l00072"></a>00072         g_warning (<span class="stringliteral">&quot;Failed to load config file.\n&quot;</span>);
<a name="l00073"></a>00073         g_key_file_free (config);
<a name="l00074"></a>00074         <span class="keywordflow">goto</span> onerror;
<a name="l00075"></a>00075     }
<a name="l00076"></a>00076 
<a name="l00077"></a>00077     session = g_new0(<a class="code" href="struct__SeafileSession.html">SeafileSession</a>, 1);
<a name="l00078"></a>00078     session-&gt;<a class="code" href="struct__SeafileSession.html#ae4df188e5674e3e4b405f14d0ee1bf9f">seaf_dir</a> = abs_seafile_dir;
<a name="l00079"></a>00079     session-&gt;<a class="code" href="struct__SeafileSession.html#ad97f66e4b34e3568844b9be0e5c5e48a">tmp_file_dir</a> = tmp_file_dir;
<a name="l00080"></a>00080     session-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a> = ccnet_session;
<a name="l00081"></a>00081     session-&gt;<a class="code" href="struct__SeafileSession.html#a71aad27bec82b81e5e6f4fd6d96502ac">config</a> = config;
<a name="l00082"></a>00082 
<a name="l00083"></a>00083     <span class="keywordflow">if</span> (load_database_config (session) &lt; 0) {
<a name="l00084"></a>00084         g_warning (<span class="stringliteral">&quot;Failed to load database config.\n&quot;</span>);
<a name="l00085"></a>00085         <span class="keywordflow">goto</span> onerror;
<a name="l00086"></a>00086     }
<a name="l00087"></a>00087 
<a name="l00088"></a>00088     <span class="keywordflow">if</span> (load_thread_pool_config (session) &lt; 0) {
<a name="l00089"></a>00089         g_warning (<span class="stringliteral">&quot;Failed to load thread pool config.\n&quot;</span>);
<a name="l00090"></a>00090         <span class="keywordflow">goto</span> onerror;
<a name="l00091"></a>00091     }
<a name="l00092"></a>00092 
<a name="l00093"></a>00093     session-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a> = <a class="code" href="fs-mgr_8h.html#ad005159664b100b6ac12ee73d4dad7dd">seaf_fs_manager_new</a> (session, abs_seafile_dir);
<a name="l00094"></a>00094     <span class="keywordflow">if</span> (!session-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>)
<a name="l00095"></a>00095         <span class="keywordflow">goto</span> onerror;
<a name="l00096"></a>00096     session-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a> = <a class="code" href="block-mgr_8c.html#afe7bdd98ee7c90761a36de14c5d89670">seaf_block_manager_new</a> (session, abs_seafile_dir);
<a name="l00097"></a>00097     <span class="keywordflow">if</span> (!session-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>)
<a name="l00098"></a>00098         <span class="keywordflow">goto</span> onerror;
<a name="l00099"></a>00099     session-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a> = <a class="code" href="commit-mgr_8c.html#a17f293cbb4ade7854596f51cebd7248a">seaf_commit_manager_new</a> (session);
<a name="l00100"></a>00100     <span class="keywordflow">if</span> (!session-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>)
<a name="l00101"></a>00101         <span class="keywordflow">goto</span> onerror;
<a name="l00102"></a>00102     session-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a> = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a8f91693d20dfa77546527064cb1097e3">seaf_repo_manager_new</a> (session);
<a name="l00103"></a>00103     <span class="keywordflow">if</span> (!session-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>)
<a name="l00104"></a>00104         <span class="keywordflow">goto</span> onerror;
<a name="l00105"></a>00105     session-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a> = <a class="code" href="branch-mgr_8c.html#af009f1b2d00e44b485bde7f438020655">seaf_branch_manager_new</a> (session);
<a name="l00106"></a>00106     <span class="keywordflow">if</span> (!session-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>)
<a name="l00107"></a>00107         <span class="keywordflow">goto</span> onerror;
<a name="l00108"></a>00108 
<a name="l00109"></a>00109     session-&gt;<a class="code" href="struct__SeafileSession.html#a9cc2837db34836ebc861d8f1f2adf486">cs_mgr</a> = <a class="code" href="chunkserv-mgr_8c.html#a1f67de555d22eb4d654a5607ecfac561">seaf_cs_manager_new</a> (session);
<a name="l00110"></a>00110     <span class="keywordflow">if</span> (!session-&gt;<a class="code" href="struct__SeafileSession.html#a9cc2837db34836ebc861d8f1f2adf486">cs_mgr</a>)
<a name="l00111"></a>00111         <span class="keywordflow">goto</span> onerror;
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     session-&gt;<a class="code" href="struct__SeafileSession.html#a6e57faf2aac503e8b88c8496d638ec3e">share_mgr</a> = <a class="code" href="share-mgr_8c.html#a85276c87b6d9a6825fdfd11c3cbaa7dd">seaf_share_manager_new</a> (session);
<a name="l00114"></a>00114     <span class="keywordflow">if</span> (!session-&gt;<a class="code" href="struct__SeafileSession.html#a6e57faf2aac503e8b88c8496d638ec3e">share_mgr</a>)
<a name="l00115"></a>00115         <span class="keywordflow">goto</span> onerror;
<a name="l00116"></a>00116     
<a name="l00117"></a>00117     session-&gt;<a class="code" href="struct__SeafileSession.html#af249c8aae623d376b24a0d56231e0df1">web_at_mgr</a> = <a class="code" href="web-accesstoken-mgr_8c.html#a3263f9de0c35c27e6dd571bd73d47b4a">seaf_web_at_manager_new</a> (session);
<a name="l00118"></a>00118     <span class="keywordflow">if</span> (!session-&gt;<a class="code" href="struct__SeafileSession.html#af249c8aae623d376b24a0d56231e0df1">web_at_mgr</a>)
<a name="l00119"></a>00119         <span class="keywordflow">goto</span> onerror;
<a name="l00120"></a>00120 
<a name="l00121"></a>00121     session-&gt;<a class="code" href="struct__SeafileSession.html#a488687f0c6d0efb92e701a5bdc276886">token_mgr</a> = <a class="code" href="token-mgr_8c.html#a2b59c9ac63a5d421ebbdf904b12f7429">seaf_token_manager_new</a> (session);
<a name="l00122"></a>00122     <span class="keywordflow">if</span> (!session-&gt;<a class="code" href="struct__SeafileSession.html#a488687f0c6d0efb92e701a5bdc276886">token_mgr</a>)
<a name="l00123"></a>00123         <span class="keywordflow">goto</span> onerror;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125     session-&gt;<a class="code" href="struct__SeafileSession.html#aa6154751a20cdaa84110e1a8370c1164">passwd_mgr</a> = <a class="code" href="passwd-mgr_8c.html#a000ca68f871e6bdc0a9e9c88544ac357">seaf_passwd_manager_new</a> (session);
<a name="l00126"></a>00126     <span class="keywordflow">if</span> (!session-&gt;<a class="code" href="struct__SeafileSession.html#aa6154751a20cdaa84110e1a8370c1164">passwd_mgr</a>)
<a name="l00127"></a>00127         <span class="keywordflow">goto</span> onerror;
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     session-&gt;<a class="code" href="struct__SeafileSession.html#a7e0d063a6d1f9b22380aec6958448efd">quota_mgr</a> = <a class="code" href="quota-mgr_8c.html#a8bfaf6469bb2bae48f217935504e303c">seaf_quota_manager_new</a> (session);
<a name="l00130"></a>00130     <span class="keywordflow">if</span> (!session-&gt;<a class="code" href="struct__SeafileSession.html#a7e0d063a6d1f9b22380aec6958448efd">quota_mgr</a>)
<a name="l00131"></a>00131         <span class="keywordflow">goto</span> onerror;
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     session-&gt;<a class="code" href="struct__SeafileSession.html#a956cb7b17169bd6f62ee0c5c6e90175c">listen_mgr</a> = <a class="code" href="listen-mgr_8c.html#a2e4d4451ca09640620f47dc4024c23ff">seaf_listen_manager_new</a> (session);
<a name="l00134"></a>00134     <span class="keywordflow">if</span> (!session-&gt;<a class="code" href="struct__SeafileSession.html#a956cb7b17169bd6f62ee0c5c6e90175c">listen_mgr</a>)
<a name="l00135"></a>00135         <span class="keywordflow">goto</span> onerror;
<a name="l00136"></a>00136 
<a name="l00137"></a>00137     session-&gt;<a class="code" href="struct__SeafileSession.html#a1826aa8bcba056a4f41755627b270751">copy_mgr</a> = <a class="code" href="copy-mgr_8c.html#a66b2e0887f94f1a1378e3592933b6ba2">seaf_copy_manager_new</a> (session);
<a name="l00138"></a>00138     <span class="keywordflow">if</span> (!session-&gt;<a class="code" href="struct__SeafileSession.html#a1826aa8bcba056a4f41755627b270751">copy_mgr</a>)
<a name="l00139"></a>00139         <span class="keywordflow">goto</span> onerror;
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     session-&gt;<a class="code" href="struct__SeafileSession.html#abcbb9886e315abb16c620ce49808a0b2">job_mgr</a> = <a class="code" href="job-mgr_8h.html#af6f650ef4b54aace587f2e3e4bd1e622">ccnet_job_manager_new</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a227f0b82e19f55c9c1da80ed05d3c09c">sync_thread_pool_size</a>);
<a name="l00142"></a>00142     ccnet_session-&gt;<a class="code" href="struct__CcnetClient.html#a99bc661c207d9958131fb7b23918cdf4">job_mgr</a> = <a class="code" href="job-mgr_8h.html#af6f650ef4b54aace587f2e3e4bd1e622">ccnet_job_manager_new</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a80899d61e2585f35190f5f6b208368d8">rpc_thread_pool_size</a>);
<a name="l00143"></a>00143 
<a name="l00144"></a>00144     session-&gt;<a class="code" href="struct__SeafileSession.html#a5f4ec3d63e85984e1453df4223bab2b2">size_sched</a> = <a class="code" href="size-sched_8c.html#a11daa614b45066c6358f660fb665af9b">size_scheduler_new</a> (session);
<a name="l00145"></a>00145 
<a name="l00146"></a>00146     session-&gt;<a class="code" href="struct__SeafileSession.html#a7321aeb5c752d434ccb1b94bec6c9624">ev_mgr</a> = <a class="code" href="cevent_8h.html#a13bc42b6f1257f8f1d9e64578d456191">cevent_manager_new</a> ();
<a name="l00147"></a>00147     <span class="keywordflow">if</span> (!session-&gt;<a class="code" href="struct__SeafileSession.html#a7321aeb5c752d434ccb1b94bec6c9624">ev_mgr</a>)
<a name="l00148"></a>00148         <span class="keywordflow">goto</span> onerror;
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     session-&gt;<a class="code" href="struct__SeafileSession.html#a89e2a6000f250563b18123661ba9abbd">mq_mgr</a> = <a class="code" href="mq-mgr_8c.html#a0898eaada62e19a0d081a8aaad122ba9">seaf_mq_manager_new</a> (session);
<a name="l00151"></a>00151     <span class="keywordflow">if</span> (!session-&gt;<a class="code" href="struct__SeafileSession.html#a89e2a6000f250563b18123661ba9abbd">mq_mgr</a>)
<a name="l00152"></a>00152         <span class="keywordflow">goto</span> onerror;
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     session-&gt;<a class="code" href="struct__SeafileSession.html#a0309f60018b54c38ec8d3275ee1d6666">http_server</a> = <a class="code" href="Backups_2http-server_8c.html#af79b84fbd5de27ce789bbff6b8b3337e">seaf_http_server_new</a> (session);
<a name="l00155"></a>00155     <span class="keywordflow">if</span> (!session-&gt;<a class="code" href="struct__SeafileSession.html#a0309f60018b54c38ec8d3275ee1d6666">http_server</a>)
<a name="l00156"></a>00156         <span class="keywordflow">goto</span> onerror;
<a name="l00157"></a>00157 
<a name="l00158"></a>00158     <span class="keywordflow">return</span> <a class="code" href="cluster-mgr_8c.html#af241ba8540cd17c31a02b56c2aaa126c">session</a>;
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 onerror:
<a name="l00161"></a>00161     free (abs_seafile_dir);
<a name="l00162"></a>00162     g_free (tmp_file_dir);
<a name="l00163"></a>00163     g_free (config_file_path);
<a name="l00164"></a>00164     g_free (session);
<a name="l00165"></a>00165     <span class="keywordflow">return</span> NULL;    
<a name="l00166"></a>00166 }
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 <span class="keywordtype">int</span>
<a name="l00169"></a><a class="code" href="server_2seafile-session_8c.html#a5dbc4cb373997a756130cfe875b86ce6">00169</a> <a class="code" href="fuse_2seafile-session_8c.html#a5dbc4cb373997a756130cfe875b86ce6">seafile_session_init</a> (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *<a class="code" href="cluster-mgr_8c.html#af241ba8540cd17c31a02b56c2aaa126c">session</a>)
<a name="l00170"></a>00170 {
<a name="l00171"></a>00171     <span class="keywordflow">if</span> (<a class="code" href="commit-mgr_8c.html#ad6fdc75fe20bb5941a19a436742cb696">seaf_commit_manager_init</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>) &lt; 0)
<a name="l00172"></a>00172         <span class="keywordflow">return</span> -1;
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#a91dd774f96fb5cc505f423913ea730fe">seaf_fs_manager_init</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>) &lt; 0)
<a name="l00175"></a>00175         <span class="keywordflow">return</span> -1;
<a name="l00176"></a>00176 
<a name="l00177"></a>00177     <span class="keywordflow">if</span> (<a class="code" href="branch-mgr_8c.html#a51813bc8b0f663d8bed443e878320daa">seaf_branch_manager_init</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>) &lt; 0)
<a name="l00178"></a>00178         <span class="keywordflow">return</span> -1;
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     <span class="keywordflow">if</span> (<a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a8dab773e289d1148e7afec7c8614278a">seaf_repo_manager_init</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>) &lt; 0)
<a name="l00181"></a>00181         <span class="keywordflow">return</span> -1;
<a name="l00182"></a>00182 
<a name="l00183"></a>00183     <span class="keywordflow">if</span> (<a class="code" href="quota-mgr_8c.html#afceaa1bbb546bd5f976bc557c0ba7b87">seaf_quota_manager_init</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a7e0d063a6d1f9b22380aec6958448efd">quota_mgr</a>) &lt; 0)
<a name="l00184"></a>00184         <span class="keywordflow">return</span> -1;
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     <a class="code" href="mq-mgr_8c.html#a96b186740b01126814ea4c9b855742ba">seaf_mq_manager_init</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a89e2a6000f250563b18123661ba9abbd">mq_mgr</a>);
<a name="l00187"></a>00187     <a class="code" href="mq-mgr_8c.html#a46fceb8aa81397a879d6c62818c9db61">seaf_mq_manager_set_heartbeat_name</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a89e2a6000f250563b18123661ba9abbd">mq_mgr</a>,
<a name="l00188"></a>00188                                         <span class="stringliteral">&quot;seaf_server.heartbeat&quot;</span>);
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <span class="keywordflow">return</span> 0;
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 <span class="keywordtype">int</span>
<a name="l00194"></a><a class="code" href="server_2seafile-session_8c.html#afb1838a556e838aea9515780411cf284">00194</a> <a class="code" href="daemon_2seafile-session_8c.html#ae4d67eb6012e42ab5d7893a4a6738225">seafile_session_start</a> (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *<a class="code" href="cluster-mgr_8c.html#af241ba8540cd17c31a02b56c2aaa126c">session</a>)
<a name="l00195"></a>00195 {
<a name="l00196"></a>00196     <span class="keywordflow">if</span> (<a class="code" href="cevent_8h.html#abb4d79de82893bfe62dfe6a30a65fd29">cevent_manager_start</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a7321aeb5c752d434ccb1b94bec6c9624">ev_mgr</a>) &lt; 0) {
<a name="l00197"></a>00197         g_error (<span class="stringliteral">&quot;Failed to start event manager.\n&quot;</span>);
<a name="l00198"></a>00198         <span class="keywordflow">return</span> -1;
<a name="l00199"></a>00199     }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201     <span class="keywordflow">if</span> (<a class="code" href="chunkserv-mgr_8c.html#a9e8addc3c6df51e71a8619d80eb94b4a">seaf_cs_manager_start</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a9cc2837db34836ebc861d8f1f2adf486">cs_mgr</a>) &lt; 0) {
<a name="l00202"></a>00202         g_error (<span class="stringliteral">&quot;Failed to start chunk server manager.\n&quot;</span>);
<a name="l00203"></a>00203         <span class="keywordflow">return</span> -1;
<a name="l00204"></a>00204     }
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     <span class="keywordflow">if</span> (<a class="code" href="share-mgr_8c.html#a6b9afa7b510c43b1b4e856ab7057fbae">seaf_share_manager_start</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a6e57faf2aac503e8b88c8496d638ec3e">share_mgr</a>) &lt; 0) {
<a name="l00207"></a>00207         g_error (<span class="stringliteral">&quot;Failed to start share manager.\n&quot;</span>);
<a name="l00208"></a>00208         <span class="keywordflow">return</span> -1;
<a name="l00209"></a>00209     }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <span class="keywordflow">if</span> (<a class="code" href="web-accesstoken-mgr_8c.html#afba69ea37c995b2b0435ecced759c315">seaf_web_at_manager_start</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#af249c8aae623d376b24a0d56231e0df1">web_at_mgr</a>) &lt; 0) {
<a name="l00212"></a>00212         g_error (<span class="stringliteral">&quot;Failed to start web access check manager.\n&quot;</span>);
<a name="l00213"></a>00213         <span class="keywordflow">return</span> -1;
<a name="l00214"></a>00214     }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="keywordflow">if</span> (<a class="code" href="passwd-mgr_8c.html#a92e852d808e7e8d74801f8c875d12e0a">seaf_passwd_manager_start</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#aa6154751a20cdaa84110e1a8370c1164">passwd_mgr</a>) &lt; 0) {
<a name="l00217"></a>00217         g_error (<span class="stringliteral">&quot;Failed to start password manager.\n&quot;</span>);
<a name="l00218"></a>00218         <span class="keywordflow">return</span> -1;
<a name="l00219"></a>00219     }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     <span class="keywordflow">if</span> (<a class="code" href="mq-mgr_8c.html#a134878f616f816e9215d9227279047ee">seaf_mq_manager_start</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a89e2a6000f250563b18123661ba9abbd">mq_mgr</a>) &lt; 0) {
<a name="l00222"></a>00222         g_error (<span class="stringliteral">&quot;Failed to start mq manager.\n&quot;</span>);
<a name="l00223"></a>00223         <span class="keywordflow">return</span> -1;
<a name="l00224"></a>00224     }
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     <span class="keywordflow">if</span> (<a class="code" href="listen-mgr_8c.html#aa48e5c7e64f4ced1aefab2ae4aadb9bc">seaf_listen_manager_start</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a956cb7b17169bd6f62ee0c5c6e90175c">listen_mgr</a>) &lt; 0) {
<a name="l00227"></a>00227         g_error (<span class="stringliteral">&quot;Failed to start listen manager.\n&quot;</span>);
<a name="l00228"></a>00228         <span class="keywordflow">return</span> -1;
<a name="l00229"></a>00229     }
<a name="l00230"></a>00230 
<a name="l00231"></a>00231     <span class="keywordflow">if</span> (<a class="code" href="size-sched_8c.html#a3589ff389112b9fc50d7b8181c602c25">size_scheduler_start</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a5f4ec3d63e85984e1453df4223bab2b2">size_sched</a>) &lt; 0) {
<a name="l00232"></a>00232         g_error (<span class="stringliteral">&quot;Failed to start size scheduler.\n&quot;</span>);
<a name="l00233"></a>00233         <span class="keywordflow">return</span> -1;
<a name="l00234"></a>00234     }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236     <span class="keywordflow">if</span> (<a class="code" href="copy-mgr_8c.html#a34a31b348a2bacbd0333a5596e2db4cf">seaf_copy_manager_start</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a1826aa8bcba056a4f41755627b270751">copy_mgr</a>) &lt; 0) {
<a name="l00237"></a>00237         g_error (<span class="stringliteral">&quot;Failed to start copy manager.\n&quot;</span>);
<a name="l00238"></a>00238         <span class="keywordflow">return</span> -1;
<a name="l00239"></a>00239     }
<a name="l00240"></a>00240 
<a name="l00241"></a>00241     <span class="keywordflow">if</span> (<a class="code" href="Backups_2http-server_8c.html#af1c09217fc516ad3520c81478048198a">seaf_http_server_start</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a0309f60018b54c38ec8d3275ee1d6666">http_server</a>) &lt; 0) {
<a name="l00242"></a>00242         g_error (<span class="stringliteral">&quot;Failed to start http server thread.\n&quot;</span>);
<a name="l00243"></a>00243         <span class="keywordflow">return</span> -1;
<a name="l00244"></a>00244     }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     <span class="keywordflow">return</span> 0;
<a name="l00247"></a>00247 }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00250"></a>00250 load_thread_pool_config (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *<a class="code" href="cluster-mgr_8c.html#af241ba8540cd17c31a02b56c2aaa126c">session</a>)
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252     <span class="keywordtype">int</span> rpc_tp_size, sync_tp_size;
<a name="l00253"></a>00253 
<a name="l00254"></a>00254     rpc_tp_size = g_key_file_get_integer (session-&gt;<a class="code" href="struct__SeafileSession.html#a71aad27bec82b81e5e6f4fd6d96502ac">config</a>,
<a name="l00255"></a>00255                                           <span class="stringliteral">&quot;thread pool size&quot;</span>, <span class="stringliteral">&quot;rpc&quot;</span>,
<a name="l00256"></a>00256                                           NULL);
<a name="l00257"></a>00257     sync_tp_size = g_key_file_get_integer (session-&gt;<a class="code" href="struct__SeafileSession.html#a71aad27bec82b81e5e6f4fd6d96502ac">config</a>,
<a name="l00258"></a>00258                                            <span class="stringliteral">&quot;thread pool size&quot;</span>, <span class="stringliteral">&quot;sync&quot;</span>,
<a name="l00259"></a>00259                                            NULL);
<a name="l00260"></a>00260 
<a name="l00261"></a>00261     <span class="keywordflow">if</span> (rpc_tp_size &gt; 0)
<a name="l00262"></a>00262         session-&gt;<a class="code" href="struct__SeafileSession.html#a80899d61e2585f35190f5f6b208368d8">rpc_thread_pool_size</a> = rpc_tp_size;
<a name="l00263"></a>00263     <span class="keywordflow">else</span>
<a name="l00264"></a>00264         session-&gt;<a class="code" href="struct__SeafileSession.html#a80899d61e2585f35190f5f6b208368d8">rpc_thread_pool_size</a> = <a class="code" href="server_2seafile-session_8c.html#ad496b5a85651509c1813bd5d55cef62c">DEFAULT_RPC_THREAD_POOL_SIZE</a>;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <span class="keywordflow">if</span> (sync_tp_size &gt; 0)
<a name="l00267"></a>00267         session-&gt;<a class="code" href="struct__SeafileSession.html#a227f0b82e19f55c9c1da80ed05d3c09c">sync_thread_pool_size</a> = sync_tp_size;
<a name="l00268"></a>00268     <span class="keywordflow">else</span>
<a name="l00269"></a>00269         session-&gt;<a class="code" href="struct__SeafileSession.html#a227f0b82e19f55c9c1da80ed05d3c09c">sync_thread_pool_size</a> = <a class="code" href="server_2seafile-session_8c.html#a1fe6c934fd7ec758c18a80fe2f2fcc7b">DEFAULT_THREAD_POOL_SIZE</a>;
<a name="l00270"></a>00270 
<a name="l00271"></a>00271     <span class="keywordflow">return</span> 0;
<a name="l00272"></a>00272 }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274 <span class="keywordtype">char</span> *
<a name="l00275"></a><a class="code" href="server_2seafile-session_8h.html#aa984fa72f934b63897a70e142a91e3da">00275</a> <a class="code" href="server_2seafile-session_8c.html#aa984fa72f934b63897a70e142a91e3da">get_system_default_repo_id</a> (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *session)
<a name="l00276"></a>00276 {
<a name="l00277"></a>00277     <span class="keywordtype">char</span> *sql = <span class="stringliteral">&quot;SELECT info_value FROM SystemInfo WHERE info_key=&#39;default_repo_id&#39;&quot;</span>;
<a name="l00278"></a>00278     <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a7c31e106c977bf8d618336482337c8b6">seaf_db_get_string</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql);
<a name="l00279"></a>00279 }
<a name="l00280"></a>00280 
<a name="l00281"></a>00281 <span class="keywordtype">int</span>
<a name="l00282"></a><a class="code" href="server_2seafile-session_8h.html#aeb913aa60e025bf02e9c9efc7a54c272">00282</a> <a class="code" href="server_2seafile-session_8c.html#aeb913aa60e025bf02e9c9efc7a54c272">set_system_default_repo_id</a> (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *session, <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l00283"></a>00283 {
<a name="l00284"></a>00284     <span class="keywordtype">char</span> sql[256];
<a name="l00285"></a>00285     snprintf (sql, <span class="keyword">sizeof</span>(sql),
<a name="l00286"></a>00286               <span class="stringliteral">&quot;INSERT INTO SystemInfo VALUES (&#39;default_repo_id&#39;, &#39;%s&#39;)&quot;</span>,
<a name="l00287"></a>00287               repo_id);
<a name="l00288"></a>00288     <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql);
<a name="l00289"></a>00289 }
<a name="l00290"></a>00290 
<a name="l00291"></a><a class="code" href="server_2seafile-session_8c.html#a9928c54e89e36a81e12fbdfd02eb4edd">00291</a> <span class="preprocessor">#define DEFAULT_TEMPLATE_DIR &quot;library-template&quot;</span>
<a name="l00292"></a>00292 <span class="preprocessor"></span>
<a name="l00293"></a>00293 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00294"></a>00294 copy_template_files_recursive (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *session,
<a name="l00295"></a>00295                                <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l00296"></a>00296                                <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_dir_path,
<a name="l00297"></a>00297                                <span class="keyword">const</span> <span class="keywordtype">char</span> *dir_path)
<a name="l00298"></a>00298 {
<a name="l00299"></a>00299     GDir *dir;
<a name="l00300"></a>00300     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>;
<a name="l00301"></a>00301     <span class="keywordtype">char</span> *sub_path, *repo_sub_path;
<a name="l00302"></a>00302     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l00303"></a>00303     GError *error = NULL;
<a name="l00304"></a>00304     <span class="keywordtype">int</span> rc;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     dir = g_dir_open (dir_path, 0, &amp;error);
<a name="l00307"></a>00307     <span class="keywordflow">if</span> (!dir) {
<a name="l00308"></a>00308         seaf_warning (<span class="stringliteral">&quot;Failed to open template dir %s: %s.\n&quot;</span>,
<a name="l00309"></a>00309                       dir_path, error-&gt;message);
<a name="l00310"></a>00310         <span class="keywordflow">return</span>;
<a name="l00311"></a>00311     }
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     <span class="keywordflow">while</span> ((name = g_dir_read_name(dir)) != NULL) {
<a name="l00314"></a>00314         sub_path = g_build_filename (dir_path, name, NULL);
<a name="l00315"></a>00315         <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (sub_path, &amp;st) &lt; 0) {
<a name="l00316"></a>00316             seaf_warning (<span class="stringliteral">&quot;Failed to stat %s: %s.\n&quot;</span>, sub_path, strerror(errno));
<a name="l00317"></a>00317             g_free (sub_path);
<a name="l00318"></a>00318             <span class="keywordflow">continue</span>;
<a name="l00319"></a>00319         }
<a name="l00320"></a>00320 
<a name="l00321"></a>00321         <span class="keywordflow">if</span> (S_ISREG(st.st_mode)) {
<a name="l00322"></a>00322             rc = <a class="code" href="Backups_2repo-op_8c.html#a3128bd2930667427a22976b6a2b85743">seaf_repo_manager_post_file</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l00323"></a>00323                                               repo_id,
<a name="l00324"></a>00324                                               sub_path,
<a name="l00325"></a>00325                                               repo_dir_path,
<a name="l00326"></a>00326                                               name,
<a name="l00327"></a>00327                                               <span class="stringliteral">&quot;System&quot;</span>,
<a name="l00328"></a>00328                                               NULL);
<a name="l00329"></a>00329             <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l00330"></a>00330                 seaf_warning (<span class="stringliteral">&quot;Failed to add template file %s.\n&quot;</span>, sub_path);
<a name="l00331"></a>00331         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S_ISDIR(st.st_mode)) {
<a name="l00332"></a>00332             rc = <a class="code" href="Backups_2repo-op_8c.html#aa870306d94f3e7b16e66229040590138">seaf_repo_manager_post_dir</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l00333"></a>00333                                              repo_id,
<a name="l00334"></a>00334                                              repo_dir_path,
<a name="l00335"></a>00335                                              name,
<a name="l00336"></a>00336                                              <span class="stringliteral">&quot;System&quot;</span>,
<a name="l00337"></a>00337                                              NULL);
<a name="l00338"></a>00338             <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l00339"></a>00339                 seaf_warning (<span class="stringliteral">&quot;Failed to add template dir %s.\n&quot;</span>, sub_path);
<a name="l00340"></a>00340                 g_free (sub_path);
<a name="l00341"></a>00341                 <span class="keywordflow">continue</span>;
<a name="l00342"></a>00342             }
<a name="l00343"></a>00343 
<a name="l00344"></a>00344             repo_sub_path = g_build_path (<span class="stringliteral">&quot;/&quot;</span>, repo_dir_path, name, NULL);
<a name="l00345"></a>00345             copy_template_files_recursive (session, repo_id,
<a name="l00346"></a>00346                                            repo_sub_path, sub_path);
<a name="l00347"></a>00347             g_free (repo_sub_path);
<a name="l00348"></a>00348         }
<a name="l00349"></a>00349         g_free (sub_path);
<a name="l00350"></a>00350     }
<a name="l00351"></a>00351 }
<a name="l00352"></a>00352 
<a name="l00353"></a>00353 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l00354"></a>00354 create_system_default_repo (<span class="keywordtype">void</span> *data)
<a name="l00355"></a>00355 {
<a name="l00356"></a>00356     <a class="code" href="struct__SeafileSession.html">SeafileSession</a> *session = data;
<a name="l00357"></a>00357     <span class="keywordtype">char</span> *repo_id;
<a name="l00358"></a>00358     <span class="keywordtype">char</span> *template_path;
<a name="l00359"></a>00359 
<a name="l00360"></a>00360     <span class="comment">/* If it already exists, don&#39;t need to create. */</span>
<a name="l00361"></a>00361     repo_id = <a class="code" href="server_2seafile-session_8c.html#aa984fa72f934b63897a70e142a91e3da">get_system_default_repo_id</a> (session);
<a name="l00362"></a>00362     <span class="keywordflow">if</span> (repo_id != NULL)
<a name="l00363"></a>00363         <span class="keywordflow">return</span> data;
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     repo_id = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ab599ba29e40bdb918ac78060d1165c2d">seaf_repo_manager_create_new_repo</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l00366"></a>00366                                                  <span class="stringliteral">&quot;My Library Template&quot;</span>,
<a name="l00367"></a>00367                                                  <span class="stringliteral">&quot;Template for creating &#39;My Libray&#39; for users&quot;</span>,
<a name="l00368"></a>00368                                                  <span class="stringliteral">&quot;System&quot;</span>,
<a name="l00369"></a>00369                                                  NULL, NULL);
<a name="l00370"></a>00370     <span class="keywordflow">if</span> (!repo_id) {
<a name="l00371"></a>00371         seaf_warning (<span class="stringliteral">&quot;Failed to create system default repo.\n&quot;</span>);
<a name="l00372"></a>00372         <span class="keywordflow">return</span> data;
<a name="l00373"></a>00373     }
<a name="l00374"></a>00374 
<a name="l00375"></a>00375     <a class="code" href="server_2seafile-session_8c.html#aeb913aa60e025bf02e9c9efc7a54c272">set_system_default_repo_id</a> (session, repo_id);
<a name="l00376"></a>00376 
<a name="l00377"></a>00377     template_path = g_build_filename (session-&gt;<a class="code" href="struct__SeafileSession.html#ae4df188e5674e3e4b405f14d0ee1bf9f">seaf_dir</a>, <a class="code" href="server_2seafile-session_8c.html#a9928c54e89e36a81e12fbdfd02eb4edd">DEFAULT_TEMPLATE_DIR</a>, NULL);
<a name="l00378"></a>00378     copy_template_files_recursive (session, repo_id, <span class="stringliteral">&quot;/&quot;</span>, template_path);
<a name="l00379"></a>00379 
<a name="l00380"></a>00380     g_free (repo_id);
<a name="l00381"></a>00381     g_free (template_path);
<a name="l00382"></a>00382     <span class="keywordflow">return</span> data;
<a name="l00383"></a>00383 }
<a name="l00384"></a>00384 
<a name="l00385"></a>00385 <span class="keywordtype">void</span>
<a name="l00386"></a><a class="code" href="server_2seafile-session_8h.html#a747d2b438f6f32b6cfb0f4dc42bcefb8">00386</a> <a class="code" href="server_2seafile-session_8c.html#a747d2b438f6f32b6cfb0f4dc42bcefb8">schedule_create_system_default_repo</a> (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *session)
<a name="l00387"></a>00387 {
<a name="l00388"></a>00388     <span class="keywordtype">char</span> *sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS SystemInfo &quot;</span>
<a name="l00389"></a>00389         <span class="stringliteral">&quot;(info_key VARCHAR(256), info_value VARCHAR(1024))&quot;</span>;
<a name="l00390"></a>00390     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql) &lt; 0)
<a name="l00391"></a>00391         <span class="keywordflow">return</span>;
<a name="l00392"></a>00392 
<a name="l00393"></a>00393     <a class="code" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768">ccnet_job_manager_schedule_job</a> (session-&gt;<a class="code" href="struct__SeafileSession.html#abcbb9886e315abb16c620ce49808a0b2">job_mgr</a>,
<a name="l00394"></a>00394                                     create_system_default_repo,
<a name="l00395"></a>00395                                     NULL, session);
<a name="l00396"></a>00396 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Wed Aug 19 2015 03:19:54 for My Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
