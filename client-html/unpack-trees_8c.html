<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>My Project: seafile-4.1.2/common/unpack-trees.c File Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">My Project
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">seafile-4.1.2/common/unpack-trees.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="seafile-4_81_82_2common_2common_8h_source.html">common.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="seaf-tree-walk_8h_source.html">seaf-tree-walk.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="unpack-trees_8h_source.html">unpack-trees.h</a>&quot;</code><br/>
</div>
<p><a href="unpack-trees_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="unpack-trees_8c.html#a5bfe365644fb33537027e988fb891e08">unpack_trees</a> (unsigned len, struct <a class="el" href="structtree__desc.html">tree_desc</a> *t, struct <a class="el" href="structunpack__trees__options.html">unpack_trees_options</a> *o)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="unpack-trees_8c.html#a6a3a9de82ab6c7def5eac0700ae1f312">threeway_merge</a> (struct <a class="el" href="structcache__entry.html">cache_entry</a> **stages, struct <a class="el" href="structunpack__trees__options.html">unpack_trees_options</a> *o)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="unpack-trees_8c.html#a37f4950a59ff1ce85ed1bf91eeea7054">twoway_merge</a> (struct <a class="el" href="structcache__entry.html">cache_entry</a> **src, struct <a class="el" href="structunpack__trees__options.html">unpack_trees_options</a> *o)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="unpack-trees_8c.html#afc1a414641a3c7c31083a389fcfc5ec6">oneway_merge</a> (struct <a class="el" href="structcache__entry.html">cache_entry</a> **src, struct <a class="el" href="structunpack__trees__options.html">unpack_trees_options</a> *o)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gboolean&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="unpack-trees_8c.html#a795a271a95b2bc0ef892ee87f48a0c62">get_unpack_trees_error_msgs</a> (struct <a class="el" href="structunpack__trees__options.html">unpack_trees_options</a> *o, GString *msgbuf, int opr_type)</td></tr>
</table>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a795a271a95b2bc0ef892ee87f48a0c62"></a><!-- doxytag: member="unpack&#45;trees.c::get_unpack_trees_error_msgs" ref="a795a271a95b2bc0ef892ee87f48a0c62" args="(struct unpack_trees_options *o, GString *msgbuf, int opr_type)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gboolean <a class="el" href="unpack-trees_8h.html#a795a271a95b2bc0ef892ee87f48a0c62">get_unpack_trees_error_msgs</a> </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structunpack__trees__options.html">unpack_trees_options</a> *&#160;</td>
          <td class="paramname"><em>o</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GString *&#160;</td>
          <td class="paramname"><em>msgbuf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>opr_type</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="unpack-trees_8c_source.html#l01333">1333</a> of file <a class="el" href="unpack-trees_8c_source.html">unpack-trees.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> e;
    gboolean has_error = FALSE;
    <span class="keywordflow">for</span> (e = 0; e &lt; <a class="code" href="unpack-trees_8h.html#ad2203a7733606ab3a15e195914f9d90da2762d247410fe30bf9bee28b1091dc92">NB_UNPACK_TREES_ERROR_TYPES</a>; e++) {
        GList *rejects = o-&gt;<a class="code" href="structunpack__trees__options.html#a423e136b07515c8f4736a23e74334b64">unpack_rejects</a>[e];
        GList *rej;
        <span class="keywordflow">if</span> (rejects) {
            has_error = TRUE;
            <span class="keywordflow">for</span> (rej = rejects; rej; rej = rej-&gt;next)
                g_string_append_printf (msgbuf,
                                        unpack_errors[e],
                                        (<span class="keywordtype">char</span> *) (rej-&gt;data),
                                        opr_str[opr_type]);
            <span class="comment">/*</span>
<span class="comment">             * Dont need to free strings in the list.</span>
<span class="comment">             * They&#39;re in ce-&gt;name, which will be freeed later.</span>
<span class="comment">             */</span>
            <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (rejects);
        }
    }
    <span class="keywordflow">return</span> has_error;
}
</pre></div>
</div>
</div>
<a class="anchor" id="afc1a414641a3c7c31083a389fcfc5ec6"></a><!-- doxytag: member="unpack&#45;trees.c::oneway_merge" ref="afc1a414641a3c7c31083a389fcfc5ec6" args="(struct cache_entry **src, struct unpack_trees_options *o)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="unpack-trees_8h.html#afc1a414641a3c7c31083a389fcfc5ec6">oneway_merge</a> </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structcache__entry.html">cache_entry</a> **&#160;</td>
          <td class="paramname"><em>src</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structunpack__trees__options.html">unpack_trees_options</a> *&#160;</td>
          <td class="paramname"><em>o</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="unpack-trees_8c_source.html#l01280">1280</a> of file <a class="el" href="unpack-trees_8c_source.html">unpack-trees.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *old = src[0];
    <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *a = src[1];

    <span class="keywordflow">if</span> (o-&gt;<a class="code" href="structunpack__trees__options.html#a284fdf8bd0576d2999e1e199e1131346">merge_size</a> != 1) {
        g_warning(<span class="stringliteral">&quot;Cannot do a oneway merge of %d trees&quot;</span>,
                  o-&gt;<a class="code" href="structunpack__trees__options.html#a284fdf8bd0576d2999e1e199e1131346">merge_size</a>);
        <span class="keywordflow">return</span> -1;
    }

    <span class="keywordflow">if</span> (!a || a == o-&gt;<a class="code" href="structunpack__trees__options.html#a509025e0763badd0c5ab5240aa7a10fc">df_conflict_entry</a>)
        <span class="keywordflow">return</span> deleted_entry(old, old, o);

    <span class="keywordflow">if</span> (old &amp;&amp; same(old, a)) {
        <span class="keywordtype">int</span> update = 0;
        <span class="keywordflow">if</span> (o-&gt;<a class="code" href="structunpack__trees__options.html#a6f9827ec3a41ca2d74b88eb418ab44ef">reset</a> &amp;&amp; !<a class="code" href="index_8h.html#ad55a581e1adce0475f3b6e044e8b3411">ce_uptodate</a>(old) &amp;&amp; !<a class="code" href="index_8h.html#aa9cb581aaeefbbd01aa6c7997f44a5e4">ce_skip_worktree</a>(old)) {
            <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
            <span class="keywordtype">char</span> full_path[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
            snprintf (full_path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, o-&gt;<a class="code" href="structunpack__trees__options.html#a4a9bd1ef1d5e87af93c7ddce399e6b5f">base</a>, old-&gt;<a class="code" href="structcache__entry.html#a792e4ea24cb16c76abe3229651e414a0">name</a>);
            <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (full_path, &amp;st) ||
                <a class="code" href="index_8c.html#a2a76921da1fbb55b7b33983ca9e8edc4">ie_match_stat</a>(old, &amp;st, <a class="code" href="index_8h.html#a3ecb29f06d046b6a99ed2148f91ae0c3">CE_MATCH_IGNORE_VALID</a>|<a class="code" href="index_8h.html#abd49280eba10dafd6f24cc3a6eab6313">CE_MATCH_IGNORE_SKIP_WORKTREE</a>))
                update |= <a class="code" href="index_8h.html#a1d46becf22e28d6f8bffa8ee949acb45">CE_UPDATE</a>;
        }
        add_entry(o, old, update, 0);
        <span class="keywordflow">return</span> 0;
    }
    <span class="keywordflow">return</span> merged_entry(a, old, o);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a6a3a9de82ab6c7def5eac0700ae1f312"></a><!-- doxytag: member="unpack&#45;trees.c::threeway_merge" ref="a6a3a9de82ab6c7def5eac0700ae1f312" args="(struct cache_entry **stages, struct unpack_trees_options *o)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="unpack-trees_8h.html#a6a3a9de82ab6c7def5eac0700ae1f312">threeway_merge</a> </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structcache__entry.html">cache_entry</a> **&#160;</td>
          <td class="paramname"><em>stages</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structunpack__trees__options.html">unpack_trees_options</a> *&#160;</td>
          <td class="paramname"><em>o</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="unpack-trees_8c_source.html#l01035">1035</a> of file <a class="el" href="unpack-trees_8c_source.html">unpack-trees.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *index;
    <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *head;
    <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *remote = stages[o-&gt;<a class="code" href="structunpack__trees__options.html#ac3c76fcf0737031ee5783304d59c4865">head_idx</a> + 1];
    <span class="keywordtype">int</span> count;
    <span class="keywordtype">int</span> head_match = 0;
    <span class="keywordtype">int</span> remote_match = 0;

    <span class="keywordtype">int</span> df_conflict_head = 0;
    <span class="keywordtype">int</span> df_conflict_remote = 0;

    <span class="keywordtype">int</span> any_anc_missing = 0;
    <span class="keywordtype">int</span> no_anc_exists = 1;
    <span class="keywordtype">int</span> i;

    <span class="keywordflow">for</span> (i = 1; i &lt; o-&gt;<a class="code" href="structunpack__trees__options.html#ac3c76fcf0737031ee5783304d59c4865">head_idx</a>; i++) {
        <span class="keywordflow">if</span> (!stages[i] || stages[i] == o-&gt;<a class="code" href="structunpack__trees__options.html#a509025e0763badd0c5ab5240aa7a10fc">df_conflict_entry</a>)
            any_anc_missing = 1;
        <span class="keywordflow">else</span>
            no_anc_exists = 0;
    }

    index = stages[0];
    head = stages[o-&gt;<a class="code" href="structunpack__trees__options.html#ac3c76fcf0737031ee5783304d59c4865">head_idx</a>];

    <span class="keywordflow">if</span> (head == o-&gt;<a class="code" href="structunpack__trees__options.html#a509025e0763badd0c5ab5240aa7a10fc">df_conflict_entry</a>) {
        df_conflict_head = 1;
        head = NULL;
    }

    <span class="keywordflow">if</span> (remote == o-&gt;<a class="code" href="structunpack__trees__options.html#a509025e0763badd0c5ab5240aa7a10fc">df_conflict_entry</a>) {
        df_conflict_remote = 1;
        remote = NULL;
    }

    <span class="comment">/*</span>
<span class="comment">     * First, if there&#39;s a #16 situation, note that to prevent #13</span>
<span class="comment">     * and #14.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (!same(remote, head)) {
        <span class="keywordflow">for</span> (i = 1; i &lt; o-&gt;<a class="code" href="structunpack__trees__options.html#ac3c76fcf0737031ee5783304d59c4865">head_idx</a>; i++) {
            <span class="keywordflow">if</span> (same(stages[i], head)) {
                head_match = i;
            }
            <span class="keywordflow">if</span> (same(stages[i], remote)) {
                remote_match = i;
            }
        }
    }

    <span class="comment">/*</span>
<span class="comment">     * We start with cases where the index is allowed to match</span>
<span class="comment">     * something other than the head: #14(ALT) and #2ALT, where it</span>
<span class="comment">     * is permitted to match the result instead.</span>
<span class="comment">     */</span>
    <span class="comment">/* #14, #14ALT, #2ALT */</span>
    <span class="keywordflow">if</span> (remote &amp;&amp; !df_conflict_head &amp;&amp; head_match &amp;&amp; !remote_match) {
        <span class="comment">/* if (index &amp;&amp; !same(index, remote) &amp;&amp; !same(index, head)) */</span>
        <span class="comment">/*     return o-&gt;gently ? -1 : reject_merge(index, o); */</span>
        <span class="keywordflow">return</span> merged_entry(remote, index, o);
    }
    <span class="comment">/*</span>
<span class="comment">     * If we have an entry in the index cache, then we want to</span>
<span class="comment">     * make sure that it matches head.</span>
<span class="comment">     */</span>
    <span class="comment">/* if (index &amp;&amp; !same(index, head)) */</span>
    <span class="comment">/*     return o-&gt;gently ? -1 : reject_merge(index, o); */</span>

    <span class="keywordflow">if</span> (head) {
        <span class="comment">/* #5ALT, #15 */</span>
        <span class="keywordflow">if</span> (same(head, remote))
            <span class="keywordflow">return</span> merged_entry(remote, index, o);
        <span class="comment">/* #13, #3ALT */</span>
        <span class="keywordflow">if</span> (!df_conflict_remote &amp;&amp; remote_match &amp;&amp; !head_match)
            <span class="keywordflow">return</span> merged_entry(head, index, o);
    }

    <span class="comment">/* #1 */</span>
    <span class="keywordflow">if</span> (!head &amp;&amp; !remote &amp;&amp; any_anc_missing)
        <span class="keywordflow">return</span> 0;

    <span class="comment">/*</span>
<span class="comment">     * Under the &quot;aggressive&quot; rule, we resolve mostly trivial</span>
<span class="comment">     * cases that we historically had git-merge-one-file resolve.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (o-&gt;<a class="code" href="structunpack__trees__options.html#a5995e2147c2e837d55f32a42fa64b582">aggressive</a>) {
        <span class="keywordtype">int</span> head_deleted = !head;
        <span class="keywordtype">int</span> remote_deleted = !remote;
        <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *ce = NULL;

        <span class="keywordflow">if</span> (index)
            ce = index;
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (head)
            ce = head;
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (remote)
            ce = remote;
        <span class="keywordflow">else</span> {
            <span class="keywordflow">for</span> (i = 1; i &lt; o-&gt;<a class="code" href="structunpack__trees__options.html#ac3c76fcf0737031ee5783304d59c4865">head_idx</a>; i++) {
                <span class="keywordflow">if</span> (stages[i] &amp;&amp; stages[i] != o-&gt;<a class="code" href="structunpack__trees__options.html#a509025e0763badd0c5ab5240aa7a10fc">df_conflict_entry</a>) {
                    ce = stages[i];
                    <span class="keywordflow">break</span>;
                }
            }
        }

        <span class="comment">/*</span>
<span class="comment">         * Deleted in both.</span>
<span class="comment">         * Deleted in one and unchanged in the other.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> ((head_deleted &amp;&amp; remote_deleted) ||
            (head_deleted &amp;&amp; remote &amp;&amp; remote_match) ||
            (remote_deleted &amp;&amp; head &amp;&amp; head_match)) {
            <span class="keywordflow">if</span> (index)
                <span class="keywordflow">return</span> deleted_entry(index, index, o);
            <span class="keywordflow">if</span> (ce &amp;&amp; !head_deleted) {
                <span class="keywordflow">if</span> (verify_absent(ce, <a class="code" href="unpack-trees_8h.html#ad2203a7733606ab3a15e195914f9d90da4d8b523966bd36035e1d16c618720399">ERROR_WOULD_LOSE_UNTRACKED_REMOVED</a>, o))
                    <span class="keywordflow">return</span> -1;
            }
            <span class="keywordflow">return</span> 0;
        }
        <span class="comment">/*</span>
<span class="comment">         * Added in both, identically.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> (no_anc_exists &amp;&amp; head &amp;&amp; remote &amp;&amp; same(head, remote))
            <span class="keywordflow">return</span> merged_entry(head, index, o);

    }

    <span class="comment">/* Below are &quot;no merge&quot; cases, which require that the index be</span>
<span class="comment">     * up-to-date to avoid the files getting overwritten with</span>
<span class="comment">     * conflict resolution files.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (index) {
        <span class="keywordflow">if</span> (verify_uptodate(index, o))
            <span class="keywordflow">return</span> -1;
    }

    o-&gt;<a class="code" href="structunpack__trees__options.html#a8b7cd690b47d941150a44a40164370bb">nontrivial_merge</a> = 1;

    <span class="comment">/* #2, #3, #4, #6, #7, #9, #10, #11. */</span>
    count = 0;
    <span class="keywordflow">if</span> (!head_match || !remote_match) {
        <span class="keywordflow">for</span> (i = 1; i &lt; o-&gt;<a class="code" href="structunpack__trees__options.html#ac3c76fcf0737031ee5783304d59c4865">head_idx</a>; i++) {
            <span class="keywordflow">if</span> (stages[i] &amp;&amp; stages[i] != o-&gt;<a class="code" href="structunpack__trees__options.html#a509025e0763badd0c5ab5240aa7a10fc">df_conflict_entry</a>) {
                keep_entry(stages[i], o);
                count++;
                <span class="keywordflow">break</span>;
            }
        }
    }
<span class="preprocessor">#if DBRT_DEBUG</span>
<span class="preprocessor"></span>    <span class="keywordflow">else</span> {
        fprintf(stderr, <span class="stringliteral">&quot;read-tree: warning #16 detected\n&quot;</span>);
        show_stage_entry(stderr, <span class="stringliteral">&quot;head   &quot;</span>, stages[head_match]);
        show_stage_entry(stderr, <span class="stringliteral">&quot;remote &quot;</span>, stages[remote_match]);
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="comment">/* We need ctime and mtime of index to handle worktree conflict later. */</span>
    <span class="keywordflow">if</span> (head &amp;&amp; index) {
        head-&gt;<a class="code" href="structcache__entry.html#a75bbadf64b037b9a17fc1be53b1d1bea">current_mtime</a> = index-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a>;
    }

    <span class="keywordflow">if</span> (head) { count += keep_entry(head, o); }
    <span class="keywordflow">if</span> (remote) { count += keep_entry(remote, o); }
    <span class="keywordflow">return</span> count;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a37f4950a59ff1ce85ed1bf91eeea7054"></a><!-- doxytag: member="unpack&#45;trees.c::twoway_merge" ref="a37f4950a59ff1ce85ed1bf91eeea7054" args="(struct cache_entry **src, struct unpack_trees_options *o)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="unpack-trees_8h.html#a37f4950a59ff1ce85ed1bf91eeea7054">twoway_merge</a> </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structcache__entry.html">cache_entry</a> **&#160;</td>
          <td class="paramname"><em>src</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structunpack__trees__options.html">unpack_trees_options</a> *&#160;</td>
          <td class="paramname"><em>o</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="unpack-trees_8c_source.html#l01213">1213</a> of file <a class="el" href="unpack-trees_8c_source.html">unpack-trees.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *current = src[0];
    <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *oldtree = src[1];
    <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *newtree = src[2];

    <span class="keywordflow">if</span> (o-&gt;<a class="code" href="structunpack__trees__options.html#a284fdf8bd0576d2999e1e199e1131346">merge_size</a> != 2) {
        g_warning (<span class="stringliteral">&quot;Cannot do a twoway merge of %d trees&quot;</span>, o-&gt;<a class="code" href="structunpack__trees__options.html#a284fdf8bd0576d2999e1e199e1131346">merge_size</a>);
        <span class="keywordflow">return</span> -1;
    }

    <span class="keywordflow">if</span> (oldtree == o-&gt;<a class="code" href="structunpack__trees__options.html#a509025e0763badd0c5ab5240aa7a10fc">df_conflict_entry</a>)
        oldtree = NULL;
    <span class="keywordflow">if</span> (newtree == o-&gt;<a class="code" href="structunpack__trees__options.html#a509025e0763badd0c5ab5240aa7a10fc">df_conflict_entry</a>)
        newtree = NULL;

    <span class="keywordflow">if</span> (current) {
        <span class="keywordflow">if</span> ((!oldtree &amp;&amp; !newtree) || <span class="comment">/* 4 and 5 */</span>
            (!oldtree &amp;&amp; newtree &amp;&amp;
             same(current, newtree)) || <span class="comment">/* 6 and 7 */</span>
            (oldtree &amp;&amp; newtree &amp;&amp;
             same(oldtree, newtree)) || <span class="comment">/* 14 and 15 */</span>
            (oldtree &amp;&amp; newtree &amp;&amp;
             !same(oldtree, newtree) &amp;&amp; <span class="comment">/* 18 and 19 */</span>
             same(current, newtree))) {
            <span class="keywordflow">return</span> keep_entry(current, o);
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (oldtree &amp;&amp; !newtree &amp;&amp; same(current, oldtree)) {
            <span class="comment">/* 10 or 11 */</span>
            <span class="keywordflow">return</span> deleted_entry(oldtree, current, o);
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (oldtree &amp;&amp; newtree &amp;&amp;
                 same(current, oldtree) &amp;&amp; !same(current, newtree)) {
            <span class="comment">/* 20 or 21 */</span>
            <span class="keywordflow">return</span> merged_entry(newtree, current, o);
        }
        <span class="keywordflow">else</span> {
            <span class="comment">/* all other failures */</span>
            <span class="keywordflow">if</span> (oldtree)
                <span class="keywordflow">return</span> o-&gt;<a class="code" href="structunpack__trees__options.html#a41e304e12d552f063099ac1fb1e9a7f3">gently</a> ? -1 : reject_merge(oldtree, o);
            <span class="keywordflow">if</span> (current)
                <span class="keywordflow">return</span> o-&gt;<a class="code" href="structunpack__trees__options.html#a41e304e12d552f063099ac1fb1e9a7f3">gently</a> ? -1 : reject_merge(current, o);
            <span class="keywordflow">if</span> (newtree)
                <span class="keywordflow">return</span> o-&gt;<a class="code" href="structunpack__trees__options.html#a41e304e12d552f063099ac1fb1e9a7f3">gently</a> ? -1 : reject_merge(newtree, o);
            <span class="keywordflow">return</span> -1;
        }
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (newtree) {
        <span class="keywordflow">if</span> (oldtree &amp;&amp; !o-&gt;<a class="code" href="structunpack__trees__options.html#ab6aee2819c20555d29c0e7f18b4a3df3">initial_checkout</a>) {
            <span class="comment">/*</span>
<span class="comment">             * deletion of the path was staged;</span>
<span class="comment">             */</span>
            <span class="keywordflow">if</span> (same(oldtree, newtree))
                <span class="keywordflow">return</span> 1;
            <span class="keywordflow">return</span> reject_merge(oldtree, o);
        }
        <span class="keywordflow">return</span> merged_entry(newtree, current, o);
    }
    <span class="keywordflow">return</span> deleted_entry(oldtree, current, o);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a5bfe365644fb33537027e988fb891e08"></a><!-- doxytag: member="unpack&#45;trees.c::unpack_trees" ref="a5bfe365644fb33537027e988fb891e08" args="(unsigned len, struct tree_desc *t, struct unpack_trees_options *o)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="unpack-trees_8h.html#a1a4c235391bb5c3b6448a70e627a5101">unpack_trees</a> </td>
          <td>(</td>
          <td class="paramtype">unsigned&#160;</td>
          <td class="paramname"><em>len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structtree__desc.html">tree_desc</a> *&#160;</td>
          <td class="paramname"><em>t</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structunpack__trees__options.html">unpack_trees_options</a> *&#160;</td>
          <td class="paramname"><em>o</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="unpack-trees_8c_source.html#l00650">650</a> of file <a class="el" href="unpack-trees_8c_source.html">unpack-trees.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> ret = 0;
    <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *dfc;

    memset(&amp;o-&gt;<a class="code" href="structunpack__trees__options.html#a091d6e59892b9009809e45dfb38c24da">result</a>, 0, <span class="keyword">sizeof</span>(o-&gt;<a class="code" href="structunpack__trees__options.html#a091d6e59892b9009809e45dfb38c24da">result</a>));
    o-&gt;<a class="code" href="structunpack__trees__options.html#a091d6e59892b9009809e45dfb38c24da">result</a>.<a class="code" href="structindex__state.html#a013bd6f4d9c68a7b25db32c15d29c7e2">initialized</a> = 1;
    o-&gt;<a class="code" href="structunpack__trees__options.html#a091d6e59892b9009809e45dfb38c24da">result</a>.<a class="code" href="structindex__state.html#a0fb0d6a2dabae448b68f04e75ffc1612">version</a> = o-&gt;<a class="code" href="structunpack__trees__options.html#a5781bfdf9479b84caf218a475e48476c">src_index</a>-&gt;<a class="code" href="structindex__state.html#a0fb0d6a2dabae448b68f04e75ffc1612">version</a>;
    o-&gt;<a class="code" href="structunpack__trees__options.html#a091d6e59892b9009809e45dfb38c24da">result</a>.<a class="code" href="structindex__state.html#ac5f843973ed4eba3c6370ae193ac97a9">has_modifier</a> = o-&gt;<a class="code" href="structunpack__trees__options.html#a5781bfdf9479b84caf218a475e48476c">src_index</a>-&gt;<a class="code" href="structindex__state.html#ac5f843973ed4eba3c6370ae193ac97a9">has_modifier</a>;
    o-&gt;<a class="code" href="structunpack__trees__options.html#a091d6e59892b9009809e45dfb38c24da">result</a>.<a class="code" href="structindex__state.html#aba21746d004309949f3af631aced813a">timestamp</a>.<a class="code" href="structcache__time.html#ad79ea7590f31a5cc560ab4809d31562d">sec</a> = o-&gt;<a class="code" href="structunpack__trees__options.html#a5781bfdf9479b84caf218a475e48476c">src_index</a>-&gt;<a class="code" href="structindex__state.html#aba21746d004309949f3af631aced813a">timestamp</a>.<a class="code" href="structcache__time.html#ad79ea7590f31a5cc560ab4809d31562d">sec</a>;
    o-&gt;<a class="code" href="structunpack__trees__options.html#a091d6e59892b9009809e45dfb38c24da">result</a>.<a class="code" href="structindex__state.html#aba21746d004309949f3af631aced813a">timestamp</a>.<a class="code" href="structcache__time.html#acb016b82c22470ffc173985cd88d1389">nsec</a> = o-&gt;<a class="code" href="structunpack__trees__options.html#a5781bfdf9479b84caf218a475e48476c">src_index</a>-&gt;<a class="code" href="structindex__state.html#aba21746d004309949f3af631aced813a">timestamp</a>.<a class="code" href="structcache__time.html#acb016b82c22470ffc173985cd88d1389">nsec</a>;
    o-&gt;<a class="code" href="structunpack__trees__options.html#a284fdf8bd0576d2999e1e199e1131346">merge_size</a> = len;
    <a class="code" href="index_8c.html#a1bcae1e686ad516d8b562a214c9e2cd8">mark_all_ce_unused</a>(o-&gt;<a class="code" href="structunpack__trees__options.html#a5781bfdf9479b84caf218a475e48476c">src_index</a>);

    <span class="keywordflow">if</span> (!dfc)
        dfc = calloc(1, <a class="code" href="index_8h.html#a07a18158c879287d1606ceec992ba702">cache_entry_size</a>(0));
    o-&gt;<a class="code" href="structunpack__trees__options.html#a509025e0763badd0c5ab5240aa7a10fc">df_conflict_entry</a> = dfc;

    <span class="keywordflow">if</span> (len) {
        <span class="keyword">struct </span><a class="code" href="structtraverse__info.html">traverse_info</a> info;

        setup_traverse_info(&amp;info, <span class="stringliteral">&quot;&quot;</span>);
        info.fn = unpack_callback;
        info.data = o;
        info.<a class="code" href="structunpack__trees__options.html#aa7533a743ff33a599d0c5d1100754fcf">show_all_errors</a> = o-&gt;<a class="code" href="structunpack__trees__options.html#aa7533a743ff33a599d0c5d1100754fcf">show_all_errors</a>;

        <span class="keywordflow">if</span> (<a class="code" href="seaf-tree-walk_8c.html#a7d985aeab97fb8c4c5fecaede41fcc29">traverse_trees</a>(len, t, &amp;info) &lt; 0)
            <span class="keywordflow">goto</span> return_failed;
    }

    <span class="comment">/* Any left-over entries in the index? */</span>
    <span class="keywordflow">if</span> (o-&gt;<a class="code" href="structunpack__trees__options.html#a3173b72b67869712cae670d071a73d44">merge</a>) {
        <span class="keywordflow">while</span> (1) {
            <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *ce = next_cache_entry(o);
            <span class="keywordflow">if</span> (!ce)
                <span class="keywordflow">break</span>;
            <span class="keywordflow">if</span> (unpack_index_entry(ce, o) &lt; 0)
                <span class="keywordflow">goto</span> return_failed;
        }
    }
    <a class="code" href="index_8c.html#a1bcae1e686ad516d8b562a214c9e2cd8">mark_all_ce_unused</a>(o-&gt;<a class="code" href="structunpack__trees__options.html#a5781bfdf9479b84caf218a475e48476c">src_index</a>);

    <span class="keywordflow">if</span> (o-&gt;<a class="code" href="structunpack__trees__options.html#a8ce95a4dc6e80d2f4307043931095d7a">trivial_merges_only</a> &amp;&amp; o-&gt;<a class="code" href="structunpack__trees__options.html#a8b7cd690b47d941150a44a40164370bb">nontrivial_merge</a>) {
        ret = -1;
    }

    <span class="comment">/* o-&gt;src_index = NULL; */</span>
    <span class="comment">/* ret = check_updates(o) ? (-2) : 0; */</span>
    <span class="comment">/* if (o-&gt;dst_index) */</span>
    <span class="comment">/*      *o-&gt;dst_index = o-&gt;result; */</span>

done:
    <span class="keywordflow">return</span> ret;

return_failed:
    <span class="comment">/* if (o-&gt;show_all_errors) */</span>
    <span class="comment">/*      display_error_msgs(o); */</span>
    <a class="code" href="index_8c.html#a1bcae1e686ad516d8b562a214c9e2cd8">mark_all_ce_unused</a>(o-&gt;<a class="code" href="structunpack__trees__options.html#a5781bfdf9479b84caf218a475e48476c">src_index</a>);
    ret = -1;
    <span class="keywordflow">goto</span> done;
}
</pre></div>
</div>
</div>
</div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Wed Aug 19 2015 02:52:52 for My Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
