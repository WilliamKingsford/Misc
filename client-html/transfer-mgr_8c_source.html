<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>My Project: seafile-4.1.2/daemon/transfer-mgr.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">My Project
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">seafile-4.1.2/daemon/transfer-mgr.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="transfer-mgr_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="preprocessor">#include &quot;common.h&quot;</span>
<a name="l00004"></a>00004 
<a name="l00005"></a><a class="code" href="transfer-mgr_8c.html#a05d1af42442c934b555896d3fe55c79e">00005</a> <span class="preprocessor">#define DEBUG_FLAG SEAFILE_DEBUG_TRANSFER</span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor">#include &quot;log.h&quot;</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;limits.h&gt;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;<a class="code" href="ccnet_8h.html">ccnet.h</a>&gt;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;utils.h&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;db.h&quot;</span>
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;openssl/rand.h&gt;</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="daemon_2seafile-session_8h.html">seafile-session.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="transfer-mgr_8h.html">transfer-mgr.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="commit-mgr_8h.html">commit-mgr.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="fs-mgr_8h.html">fs-mgr.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="block-mgr_8h.html">block-mgr.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="seafile-error_8h.html">seafile-error.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="vc-common_8h.html">vc-common.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="merge_8h.html">merge.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="sync-mgr_8h.html">sync-mgr.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="clone-mgr_8h.html">clone-mgr.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="vc-utils_8h.html">vc-utils.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="mq-mgr_8h.html">mq-mgr.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="seafile-config_8h.html">seafile-config.h</a>&quot;</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="check-tx-v2-proc_8h.html">processors/check-tx-v2-proc.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="check-tx-v3-proc_8h.html">processors/check-tx-v3-proc.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="sendfs-proc_8h.html">processors/sendfs-proc.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="getfs-proc_8h.html">processors/getfs-proc.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="getcs-proc_8h.html">processors/getcs-proc.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="sendbranch-proc_8h.html">processors/sendbranch-proc.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="getcommit-v2-proc_8h.html">processors/getcommit-v2-proc.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="getcommit-v3-proc_8h.html">processors/getcommit-v3-proc.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="sendcommit-v3-proc_8h.html">processors/sendcommit-v3-proc.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="sendcommit-v3-new-proc_8h.html">processors/sendcommit-v3-new-proc.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;processors/checkbl-proc.h&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="getcs-v2-proc_8h.html">processors/getcs-v2-proc.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="sendcommit-v4-proc_8h.html">processors/sendcommit-v4-proc.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="sendfs-v2-proc_8h.html">processors/sendfs-v2-proc.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="getfs-v2-proc_8h.html">processors/getfs-v2-proc.h</a>&quot;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="block-tx-client_8h.html">block-tx-client.h</a>&quot;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="diff-simple_8h.html">diff-simple.h</a>&quot;</span>
<a name="l00051"></a>00051 
<a name="l00052"></a><a class="code" href="transfer-mgr_8c.html#a529594214418a26d6770d7e25a22200a">00052</a> <span class="preprocessor">#define TRANSFER_DB &quot;transfer.db&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span>
<a name="l00054"></a><a class="code" href="transfer-mgr_8c.html#af66ade775b3232f46645be3b78ac46de">00054</a> <span class="preprocessor">#define SCHEDULE_INTERVAL   1   </span><span class="comment">/* 1s */</span>
<a name="l00055"></a><a class="code" href="transfer-mgr_8c.html#a28d5f3ddf3a19390b17e3b2382cd6bab">00055</a> <span class="preprocessor">#define MAX_QUEUED_BLOCKS   50</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span>
<a name="l00057"></a><a class="code" href="transfer-mgr_8c.html#ac42c901b241f3189fb2451bfea993e1a">00057</a> <span class="preprocessor">#define DEFAULT_BLOCK_SIZE  (1 &lt;&lt; 20)</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>
<a name="l00059"></a>00059 <span class="keyword">static</span> <span class="keywordtype">int</span> schedule_task_pulse (<span class="keywordtype">void</span> *vmanager);
<a name="l00060"></a>00060 <span class="keyword">static</span> <span class="keywordtype">void</span> state_machine_tick (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task);
<a name="l00061"></a>00061 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00062"></a>00062 transition_state (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task, <span class="keywordtype">int</span> state, <span class="keywordtype">int</span> rt_state);
<a name="l00063"></a>00063 
<a name="l00104"></a>00104 <span class="comment">/*</span>
<a name="l00105"></a>00105 <span class="comment"> * Transfer Task.</span>
<a name="l00106"></a>00106 <span class="comment"> */</span>
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *transfer_task_state_str[] = {
<a name="l00109"></a>00109     <span class="stringliteral">&quot;normal&quot;</span>,
<a name="l00110"></a>00110     <span class="stringliteral">&quot;canceled&quot;</span>,
<a name="l00111"></a>00111     <span class="stringliteral">&quot;finished&quot;</span>,
<a name="l00112"></a>00112     <span class="stringliteral">&quot;error&quot;</span>,
<a name="l00113"></a>00113 };
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *transfer_task_rt_state_str[] = {
<a name="l00116"></a>00116     <span class="stringliteral">&quot;init&quot;</span>,
<a name="l00117"></a>00117     <span class="stringliteral">&quot;check&quot;</span>,
<a name="l00118"></a>00118     <span class="stringliteral">&quot;commit&quot;</span>,
<a name="l00119"></a>00119     <span class="stringliteral">&quot;fs&quot;</span>,
<a name="l00120"></a>00120     <span class="stringliteral">&quot;check-blocks&quot;</span>,
<a name="l00121"></a>00121     <span class="stringliteral">&quot;get-chunk-server&quot;</span>,
<a name="l00122"></a>00122     <span class="stringliteral">&quot;data&quot;</span>,
<a name="l00123"></a>00123     <span class="stringliteral">&quot;update-branch&quot;</span>,
<a name="l00124"></a>00124     <span class="stringliteral">&quot;finished&quot;</span>,
<a name="l00125"></a>00125     <span class="stringliteral">&quot;netdown&quot;</span>,
<a name="l00126"></a>00126 };
<a name="l00127"></a>00127 
<a name="l00128"></a>00128 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *transfer_task_error_strs[] = {
<a name="l00129"></a>00129     <span class="stringliteral">&quot;Successful&quot;</span>,
<a name="l00130"></a>00130     <span class="stringliteral">&quot;Unknown error&quot;</span>,
<a name="l00131"></a>00131     <span class="stringliteral">&quot;Service on remote server is not available&quot;</span>,
<a name="l00132"></a>00132     <span class="stringliteral">&quot;Access denied to service. Please check your registration on server.&quot;</span>,
<a name="l00133"></a>00133     <span class="stringliteral">&quot;Internal error when preparing upload&quot;</span>,
<a name="l00134"></a>00134     <span class="stringliteral">&quot;Internal error when preparing download&quot;</span>,
<a name="l00135"></a>00135     <span class="stringliteral">&quot;No permission to access remote library&quot;</span>,
<a name="l00136"></a>00136     <span class="stringliteral">&quot;Library doesn&#39;t exist on the remote end&quot;</span>,
<a name="l00137"></a>00137     <span class="stringliteral">&quot;Internal error when starting to send revision information&quot;</span>,
<a name="l00138"></a>00138     <span class="stringliteral">&quot;Internal error when starting to get revision information&quot;</span>,
<a name="l00139"></a>00139     <span class="stringliteral">&quot;Failed to upload revision information to remote library&quot;</span>,
<a name="l00140"></a>00140     <span class="stringliteral">&quot;Failed to get revision information from remote library&quot;</span>,
<a name="l00141"></a>00141     <span class="stringliteral">&quot;Internal error when starting to send file information&quot;</span>,
<a name="l00142"></a>00142     <span class="stringliteral">&quot;Internal error when starting to get file information&quot;</span>,
<a name="l00143"></a>00143     <span class="stringliteral">&quot;Incomplete file information in the local library&quot;</span>,
<a name="l00144"></a>00144     <span class="stringliteral">&quot;Failed to upload file information to remote library&quot;</span>,
<a name="l00145"></a>00145     <span class="stringliteral">&quot;Failed to get file information from remote library&quot;</span>,
<a name="l00146"></a>00146     <span class="stringliteral">&quot;Incomplete file information in the local library&quot;</span>,
<a name="l00147"></a>00147     <span class="stringliteral">&quot;Internal error when starting to update remote library&quot;</span>,
<a name="l00148"></a>00148     <span class="stringliteral">&quot;Others have concurrent updates to the remote library. You need to sync again.&quot;</span>,
<a name="l00149"></a>00149     <span class="stringliteral">&quot;Storage quota full&quot;</span>,
<a name="l00150"></a>00150     <span class="stringliteral">&quot;Server failed to check storage quota&quot;</span>,
<a name="l00151"></a>00151     <span class="stringliteral">&quot;Transfer protocol outdated. You need to upgrade seafile.&quot;</span>,
<a name="l00152"></a>00152     <span class="stringliteral">&quot;Incomplete revision information in the local library&quot;</span>,
<a name="l00153"></a>00153     <span class="stringliteral">&quot;Failed to compare data to server.&quot;</span>,
<a name="l00154"></a>00154     <span class="stringliteral">&quot;Failed to get block server list.&quot;</span>,
<a name="l00155"></a>00155     <span class="stringliteral">&quot;Failed to start block transfer client.&quot;</span>,
<a name="l00156"></a>00156     <span class="stringliteral">&quot;Failed to upload blocks.&quot;</span>,
<a name="l00157"></a>00157     <span class="stringliteral">&quot;Failed to download blocks.&quot;</span>,
<a name="l00158"></a>00158     <span class="stringliteral">&quot;Server version is too old.&quot;</span>
<a name="l00159"></a>00159     <span class="stringliteral">&quot;Files are locked by other application.&quot;</span>,
<a name="l00160"></a>00160 };
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00163"></a><a class="code" href="transfer-mgr_8h.html#a0098cc10b37b69db93ebbfa7f4e3349c">00163</a> <a class="code" href="transfer-mgr_8c.html#a0098cc10b37b69db93ebbfa7f4e3349c">task_state_to_str</a> (<span class="keywordtype">int</span> state)
<a name="l00164"></a>00164 {
<a name="l00165"></a>00165     <span class="keywordflow">return</span> transfer_task_state_str[state];
<a name="l00166"></a>00166 }
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00169"></a><a class="code" href="transfer-mgr_8h.html#a96cf9064a8fc0abfbaa59549fd45bfae">00169</a> <a class="code" href="transfer-mgr_8c.html#a96cf9064a8fc0abfbaa59549fd45bfae">task_rt_state_to_str</a> (<span class="keywordtype">int</span> rt_state)
<a name="l00170"></a>00170 {
<a name="l00171"></a>00171     <span class="keywordflow">return</span> transfer_task_rt_state_str[rt_state];
<a name="l00172"></a>00172 }
<a name="l00173"></a>00173 
<a name="l00174"></a>00174 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00175"></a><a class="code" href="transfer-mgr_8h.html#a14c6953965c8d47be9ca6bea93c9e0bf">00175</a> <a class="code" href="transfer-mgr_8c.html#a14c6953965c8d47be9ca6bea93c9e0bf">task_error_str</a> (<span class="keywordtype">int</span> task_errno)
<a name="l00176"></a>00176 {
<a name="l00177"></a>00177     <span class="keywordflow">return</span> transfer_task_error_strs[task_errno];
<a name="l00178"></a>00178 }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 <span class="keyword">static</span> <a class="code" href="struct__TransferTask.html">TransferTask</a> *
<a name="l00181"></a>00181 seaf_transfer_task_new (<a class="code" href="struct__SeafTransferManager.html">SeafTransferManager</a> *manager,
<a name="l00182"></a>00182                         <span class="keyword">const</span> <span class="keywordtype">char</span> *tx_id,
<a name="l00183"></a>00183                         <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l00184"></a>00184                         <span class="keyword">const</span> <span class="keywordtype">char</span> *dest_id,
<a name="l00185"></a>00185                         <span class="keyword">const</span> <span class="keywordtype">char</span> *from_branch,
<a name="l00186"></a>00186                         <span class="keyword">const</span> <span class="keywordtype">char</span> *to_branch,
<a name="l00187"></a>00187                         <span class="keyword">const</span> <span class="keywordtype">char</span> *token,
<a name="l00188"></a>00188                         <span class="keywordtype">int</span> task_type)
<a name="l00189"></a>00189 {
<a name="l00190"></a>00190     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task;
<a name="l00191"></a>00191     <span class="keywordtype">char</span> *uuid;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193     g_return_val_if_fail (repo_id != NULL, NULL);
<a name="l00194"></a>00194     g_return_val_if_fail (from_branch != NULL, NULL);
<a name="l00195"></a>00195     g_return_val_if_fail (to_branch != NULL, NULL);
<a name="l00196"></a>00196     g_return_val_if_fail (token != NULL, NULL);
<a name="l00197"></a>00197 
<a name="l00198"></a>00198     task = g_new0 (<a class="code" href="struct__TransferTask.html">TransferTask</a>, 1);
<a name="l00199"></a>00199     task-&gt;<a class="code" href="struct__TransferTask.html#ab610571197cd7205affa183c5059c4bb">manager</a> = manager;
<a name="l00200"></a>00200     memcpy (task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, repo_id, 37);
<a name="l00201"></a>00201     task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>[36] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00202"></a>00202     task-&gt;<a class="code" href="struct__TransferTask.html#a5cb264f2074f78b92ac005633f412c24">type</a> = task_type;
<a name="l00203"></a>00203     task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> = <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a27c8f8580beaf1e17a371eacafb2a305">TASK_RT_STATE_INIT</a>;
<a name="l00204"></a>00204     task-&gt;<a class="code" href="struct__TransferTask.html#a216de4014eaaa57a569f87ba597084fb">from_branch</a> = g_strdup(from_branch);
<a name="l00205"></a>00205     task-&gt;<a class="code" href="struct__TransferTask.html#a23b10e76331142cf8309bac0fc8ffd6f">to_branch</a> = g_strdup(to_branch);
<a name="l00206"></a>00206     task-&gt;<a class="code" href="struct__TransferTask.html#a90dbcd2a5a382282c910c9571241d45e">token</a> = g_strdup(token);
<a name="l00207"></a>00207     <span class="keywordflow">if</span> (!tx_id) {
<a name="l00208"></a>00208         uuid = <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af64020f0be33abde6a2a076ff9808809">gen_uuid</a>();
<a name="l00209"></a>00209         memcpy (task-&gt;<a class="code" href="struct__TransferTask.html#a4de0996bdefbbba5fa9d89f9c452b16e">tx_id</a>, uuid, 37);
<a name="l00210"></a>00210         g_free (uuid);
<a name="l00211"></a>00211     } <span class="keywordflow">else</span> {
<a name="l00212"></a>00212         memcpy (task-&gt;<a class="code" href="struct__TransferTask.html#a4de0996bdefbbba5fa9d89f9c452b16e">tx_id</a>, tx_id, 37);
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     <span class="keywordflow">if</span> (dest_id)
<a name="l00216"></a>00216         task-&gt;<a class="code" href="struct__TransferTask.html#acca26edf8ec374118bbd917e93765f52">dest_id</a> = g_strdup(dest_id);
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     task-&gt;<a class="code" href="struct__TransferTask.html#a42affb9eda2633dd1783d28bfa7a18d9">rsize</a> = -1;
<a name="l00219"></a>00219     task-&gt;<a class="code" href="struct__TransferTask.html#a296a35b5be74665d5cb456259ba35fac">dsize</a> = 0;
<a name="l00220"></a>00220     <span class="keywordflow">return</span> task;
<a name="l00221"></a>00221 }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00224"></a>00224 free_block_id (gpointer data, gpointer user_data)
<a name="l00225"></a>00225 {
<a name="l00226"></a>00226     g_free (data);
<a name="l00227"></a>00227 }
<a name="l00228"></a>00228 
<a name="l00229"></a>00229 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00230"></a>00230 free_chunk_server (gpointer data, gpointer user_data)
<a name="l00231"></a>00231 {
<a name="l00232"></a>00232     <a class="code" href="structChunkServer.html">ChunkServer</a> *cs = data;
<a name="l00233"></a>00233     g_free (cs-&gt;<a class="code" href="structChunkServer.html#a09a54f9a29127f6608cd4778d58d853e">addr</a>);
<a name="l00234"></a>00234     g_free (cs);
<a name="l00235"></a>00235 }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00238"></a>00238 seaf_transfer_task_free (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l00239"></a>00239 {
<a name="l00240"></a>00240     g_free (task-&gt;<a class="code" href="struct__TransferTask.html#aa13c238f263454f4f4e8efa7f6c8281b">session_token</a>);
<a name="l00241"></a>00241     g_free (task-&gt;<a class="code" href="struct__TransferTask.html#acca26edf8ec374118bbd917e93765f52">dest_id</a>);
<a name="l00242"></a>00242     g_free (task-&gt;<a class="code" href="struct__TransferTask.html#a216de4014eaaa57a569f87ba597084fb">from_branch</a>);
<a name="l00243"></a>00243     g_free (task-&gt;<a class="code" href="struct__TransferTask.html#a23b10e76331142cf8309bac0fc8ffd6f">to_branch</a>);
<a name="l00244"></a>00244     g_free (task-&gt;<a class="code" href="struct__TransferTask.html#a90dbcd2a5a382282c910c9571241d45e">token</a>);
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#adfb9ac7568777e286b4b61bb263a11eb">fs_roots</a>)
<a name="l00247"></a>00247         <a class="code" href="object-list_8c.html#ab21e5da0e11d8eb8aab75f46f924b100">object_list_free</a> (task-&gt;<a class="code" href="struct__TransferTask.html#adfb9ac7568777e286b4b61bb263a11eb">fs_roots</a>);
<a name="l00248"></a>00248 
<a name="l00249"></a>00249     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#aa9363a1d47f47572fbe229efd7a3f637">commits</a>)
<a name="l00250"></a>00250         <a class="code" href="object-list_8c.html#ab21e5da0e11d8eb8aab75f46f924b100">object_list_free</a> (task-&gt;<a class="code" href="struct__TransferTask.html#aa9363a1d47f47572fbe229efd7a3f637">commits</a>);
<a name="l00251"></a>00251 
<a name="l00252"></a>00252     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> &lt; 7 &amp;&amp; task-&gt;<a class="code" href="struct__TransferTask.html#a1617756a21ea8da9bbb6795347df9b9f">block_ids</a>) {
<a name="l00253"></a>00253         g_queue_foreach (task-&gt;<a class="code" href="struct__TransferTask.html#a1617756a21ea8da9bbb6795347df9b9f">block_ids</a>, free_block_id, NULL);
<a name="l00254"></a>00254         g_queue_free (task-&gt;<a class="code" href="struct__TransferTask.html#a1617756a21ea8da9bbb6795347df9b9f">block_ids</a>);
<a name="l00255"></a>00255     }
<a name="l00256"></a>00256 
<a name="l00257"></a>00257     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> &gt;= 4) {
<a name="l00258"></a>00258         g_list_foreach (task-&gt;<a class="code" href="struct__TransferTask.html#a8f3d6d48752b55784c707019c4d21be3">chunk_servers</a>, free_chunk_server, NULL);
<a name="l00259"></a>00259         g_list_free (task-&gt;<a class="code" href="struct__TransferTask.html#a8f3d6d48752b55784c707019c4d21be3">chunk_servers</a>);
<a name="l00260"></a>00260         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a9baa45e64248034aa15eed4f2a57ff70">block_list</a>)
<a name="l00261"></a>00261             <a class="code" href="fs-mgr_8c.html#a222764a7a6dc477fe04d6b5e267551cc">block_list_free</a> (task-&gt;<a class="code" href="struct__TransferTask.html#a9baa45e64248034aa15eed4f2a57ff70">block_list</a>);
<a name="l00262"></a>00262     }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264     g_free (task);
<a name="l00265"></a>00265 }
<a name="l00266"></a>00266 
<a name="l00267"></a>00267 <span class="keywordtype">int</span>
<a name="l00268"></a><a class="code" href="transfer-mgr_8h.html#a02a3fa3f098edcc60cd0bd1340fa80e9">00268</a> <a class="code" href="transfer-mgr_8c.html#a02a3fa3f098edcc60cd0bd1340fa80e9">transfer_task_get_rate</a> (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l00269"></a>00269 {
<a name="l00270"></a>00270     <span class="keywordflow">return</span> task-&gt;<a class="code" href="struct__TransferTask.html#af25039ef5e482429ae696c886a1c9734">last_tx_bytes</a>;
<a name="l00271"></a>00271 }
<a name="l00272"></a>00272 
<a name="l00273"></a>00273 <span class="keywordtype">int</span>
<a name="l00274"></a><a class="code" href="transfer-mgr_8h.html#ae1ab298e05c15d5b64ec741eac2404b3">00274</a> <a class="code" href="transfer-mgr_8c.html#ae1ab298e05c15d5b64ec741eac2404b3">transfer_task_get_done_blocks</a> (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l00275"></a>00275 {
<a name="l00276"></a>00276     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> != <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a6a546bd2f8de1f5a74956a45d58aba24">TASK_RT_STATE_DATA</a>)
<a name="l00277"></a>00277         <span class="keywordflow">return</span> 0;
<a name="l00278"></a>00278 
<a name="l00279"></a>00279     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> &gt;= 7 &amp;&amp; task-&gt;<a class="code" href="struct__TransferTask.html#a5cb264f2074f78b92ac005633f412c24">type</a> == <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa68841d8280724b9623db3dea4a78dde5">TASK_TYPE_DOWNLOAD</a>)
<a name="l00280"></a>00280         <span class="keywordflow">return</span> task-&gt;<a class="code" href="struct__TransferTask.html#a70063517880957e979f6f222bec67220">n_downloaded</a>;
<a name="l00281"></a>00281 
<a name="l00282"></a>00282     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> &gt;= 4) {
<a name="l00283"></a>00283         <span class="keywordtype">int</span> n_left = g_queue_get_length (task-&gt;<a class="code" href="struct__TransferTask.html#a1617756a21ea8da9bbb6795347df9b9f">block_ids</a>);
<a name="l00284"></a>00284         <span class="keywordflow">return</span> task-&gt;<a class="code" href="struct__TransferTask.html#a9baa45e64248034aa15eed4f2a57ff70">block_list</a>-&gt;<a class="code" href="structBlockList.html#a2ca09d61d434980fabd07ad6668ced3a">n_blocks</a> - n_left;
<a name="l00285"></a>00285     }
<a name="l00286"></a>00286 
<a name="l00287"></a>00287     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a5cb264f2074f78b92ac005633f412c24">type</a> == <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa800672fa26f828e725e4f6efe3dd7a67">TASK_TYPE_UPLOAD</a>)
<a name="l00288"></a>00288         <span class="keywordflow">return</span> task-&gt;<a class="code" href="struct__TransferTask.html#a18f81c0ae781b272104067d203f37e1d">n_uploaded</a>;
<a name="l00289"></a>00289     <span class="keywordflow">else</span>
<a name="l00290"></a>00290         <span class="keywordflow">return</span> task-&gt;<a class="code" href="struct__TransferTask.html#a9baa45e64248034aa15eed4f2a57ff70">block_list</a>-&gt;<a class="code" href="structBlockList.html#a76325e5df08ad225178eb403f8812a69">n_valid_blocks</a>;
<a name="l00291"></a>00291 }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00294"></a>00294 emit_transfer_done_signal (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l00295"></a>00295 {
<a name="l00296"></a>00296     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a5cb264f2074f78b92ac005633f412c24">type</a> == <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa68841d8280724b9623db3dea4a78dde5">TASK_TYPE_DOWNLOAD</a>)
<a name="l00297"></a>00297         g_signal_emit_by_name (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>, <span class="stringliteral">&quot;repo-fetched&quot;</span>, task);
<a name="l00298"></a>00298     <span class="keywordflow">else</span>
<a name="l00299"></a>00299         g_signal_emit_by_name (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>, <span class="stringliteral">&quot;repo-uploaded&quot;</span>, task);
<a name="l00300"></a>00300 }
<a name="l00301"></a>00301 
<a name="l00302"></a>00302 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00303"></a>00303 transition_state (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task, <span class="keywordtype">int</span> state, <span class="keywordtype">int</span> rt_state)
<a name="l00304"></a>00304 {
<a name="l00305"></a>00305     seaf_message (<span class="stringliteral">&quot;Transfer repo &#39;%.8s&#39;: (&#39;%s&#39;, &#39;%s&#39;) --&gt; (&#39;%s&#39;, &#39;%s&#39;)\n&quot;</span>,
<a name="l00306"></a>00306                   task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>,
<a name="l00307"></a>00307                   <a class="code" href="transfer-mgr_8c.html#a0098cc10b37b69db93ebbfa7f4e3349c">task_state_to_str</a>(task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>),
<a name="l00308"></a>00308                   <a class="code" href="transfer-mgr_8c.html#a96cf9064a8fc0abfbaa59549fd45bfae">task_rt_state_to_str</a>(task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a>),
<a name="l00309"></a>00309                   <a class="code" href="transfer-mgr_8c.html#a0098cc10b37b69db93ebbfa7f4e3349c">task_state_to_str</a>(state),
<a name="l00310"></a>00310                   <a class="code" href="transfer-mgr_8c.html#a96cf9064a8fc0abfbaa59549fd45bfae">task_rt_state_to_str</a>(rt_state));
<a name="l00311"></a>00311 
<a name="l00312"></a>00312     task-&gt;<a class="code" href="struct__TransferTask.html#a13bb5199500880d4c519fc1ac53312c7">last_runtime_state</a> = task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a>;
<a name="l00313"></a>00313 
<a name="l00314"></a>00314     <span class="keywordflow">if</span> (rt_state == <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>) {
<a name="l00315"></a>00315         <span class="comment">/* Clear download head info. */</span>
<a name="l00316"></a>00316         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> &gt;= 7 &amp;&amp; task-&gt;<a class="code" href="struct__TransferTask.html#a5cb264f2074f78b92ac005633f412c24">type</a> == <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa68841d8280724b9623db3dea4a78dde5">TASK_TYPE_DOWNLOAD</a> &amp;&amp;
<a name="l00317"></a>00317             state == <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bcea407d72c040f282acb88e904361c217a2">TASK_STATE_FINISHED</a>)
<a name="l00318"></a>00318             <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l00319"></a>00319                                                  task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>,
<a name="l00320"></a>00320                                                  <a class="code" href="daemon_2repo-mgr_8h.html#a1d90660156a493f14023ca76013acd64">REPO_PROP_DOWNLOAD_HEAD</a>,
<a name="l00321"></a>00321                                                  <a class="code" href="seafile-4_81_82_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>);
<a name="l00322"></a>00322 
<a name="l00323"></a>00323         task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> = state;
<a name="l00324"></a>00324         task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> = rt_state;
<a name="l00325"></a>00325 
<a name="l00326"></a>00326         emit_transfer_done_signal (task);
<a name="l00327"></a>00327 
<a name="l00328"></a>00328         <span class="keywordflow">return</span>;
<a name="l00329"></a>00329     }
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     <span class="keywordflow">if</span> (state != task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>)
<a name="l00332"></a>00332         task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> = state;
<a name="l00333"></a>00333     task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> = rt_state;
<a name="l00334"></a>00334 }
<a name="l00335"></a>00335 
<a name="l00336"></a>00336 <span class="keywordtype">void</span>
<a name="l00337"></a><a class="code" href="transfer-mgr_8h.html#af268f694f35d04d51f38ab6bcb2b4d86">00337</a> <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task, <span class="keywordtype">int</span> task_errno)
<a name="l00338"></a>00338 {
<a name="l00339"></a>00339     g_return_if_fail (task_errno != 0);
<a name="l00340"></a>00340 
<a name="l00341"></a>00341     seaf_message (<span class="stringliteral">&quot;Transfer repo &#39;%.8s&#39;: (&#39;%s&#39;, &#39;%s&#39;) --&gt; (&#39;%s&#39;, &#39;%s&#39;): %s\n&quot;</span>,
<a name="l00342"></a>00342                   task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>,
<a name="l00343"></a>00343                   <a class="code" href="transfer-mgr_8c.html#a0098cc10b37b69db93ebbfa7f4e3349c">task_state_to_str</a>(task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>),
<a name="l00344"></a>00344                   <a class="code" href="transfer-mgr_8c.html#a96cf9064a8fc0abfbaa59549fd45bfae">task_rt_state_to_str</a>(task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a>),
<a name="l00345"></a>00345                   <a class="code" href="transfer-mgr_8c.html#a0098cc10b37b69db93ebbfa7f4e3349c">task_state_to_str</a>(<a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaeef2d65ee28a06d4dad01ed46ab8c213">TASK_STATE_ERROR</a>),
<a name="l00346"></a>00346                   <a class="code" href="transfer-mgr_8c.html#a96cf9064a8fc0abfbaa59549fd45bfae">task_rt_state_to_str</a>(<a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>),
<a name="l00347"></a>00347                   <a class="code" href="transfer-mgr_8c.html#a14c6953965c8d47be9ca6bea93c9e0bf">task_error_str</a>(task_errno));
<a name="l00348"></a>00348 
<a name="l00349"></a>00349     task-&gt;<a class="code" href="struct__TransferTask.html#a13bb5199500880d4c519fc1ac53312c7">last_runtime_state</a> = task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a>;
<a name="l00350"></a>00350 
<a name="l00351"></a>00351     task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> = <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaeef2d65ee28a06d4dad01ed46ab8c213">TASK_STATE_ERROR</a>;
<a name="l00352"></a>00352     task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> = <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>;
<a name="l00353"></a>00353     task-&gt;<a class="code" href="struct__TransferTask.html#a9f76a7a029f2b7103127167a03be025e">error</a> = task_errno;
<a name="l00354"></a>00354 
<a name="l00355"></a>00355     emit_transfer_done_signal (task);
<a name="l00356"></a>00356 }
<a name="l00357"></a>00357 
<a name="l00358"></a>00358 <span class="keywordtype">void</span>
<a name="l00359"></a><a class="code" href="transfer-mgr_8h.html#a3c99cd5104dac75aa73ed81fd1df2b9e">00359</a> <a class="code" href="transfer-mgr_8c.html#a3c99cd5104dac75aa73ed81fd1df2b9e">transfer_task_set_error</a> (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task, <span class="keywordtype">int</span> error)
<a name="l00360"></a>00360 {
<a name="l00361"></a>00361     <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, error);
<a name="l00362"></a>00362 }
<a name="l00363"></a>00363 
<a name="l00364"></a>00364 <span class="keywordtype">void</span>
<a name="l00365"></a><a class="code" href="transfer-mgr_8h.html#ae337827e1d8f663486c0fb3bab156610">00365</a> <a class="code" href="transfer-mgr_8c.html#ae337827e1d8f663486c0fb3bab156610">transfer_task_set_netdown</a> (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l00366"></a>00366 {
<a name="l00367"></a>00367     g_return_if_fail (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> == <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceac3efc29c1793f3f902e002589c600b33">TASK_STATE_NORMAL</a>);
<a name="l00368"></a>00368     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> == <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300abee3bb533aa834941c0ef1820a0aeec7">TASK_RT_STATE_NETDOWN</a>)
<a name="l00369"></a>00369         <span class="keywordflow">return</span>;
<a name="l00370"></a>00370     transition_state (task, <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceac3efc29c1793f3f902e002589c600b33">TASK_STATE_NORMAL</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300abee3bb533aa834941c0ef1820a0aeec7">TASK_RT_STATE_NETDOWN</a>);
<a name="l00371"></a>00371 }
<a name="l00372"></a>00372 
<a name="l00373"></a>00373 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00374"></a>00374 transfer_task_with_proc_failure (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task,
<a name="l00375"></a>00375                                  <a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *proc,
<a name="l00376"></a>00376                                  <span class="keywordtype">int</span> defalut_error)
<a name="l00377"></a>00377 {
<a name="l00378"></a>00378     seaf_debug (<span class="stringliteral">&quot;Transfer repo &#39;%.8s&#39;: proc %s(%d) failure: %d\n&quot;</span>,
<a name="l00379"></a>00379                 task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>,
<a name="l00380"></a>00380                 <a class="code" href="include_2ccnet_2processor_8h.html#aacdda6e13fc0803e50e41e9dea57ab29">GET_PNAME</a>(proc), <a class="code" href="include_2ccnet_2processor_8h.html#af1544354d74c568d3753f15b2f297366">PRINT_ID</a>(proc-&gt;<a class="code" href="struct__CcnetProcessor.html#a06e48c502b93f4b8f50600ef9bba40af">id</a>),
<a name="l00381"></a>00381                 proc-&gt;<a class="code" href="struct__CcnetProcessor.html#a044d12f3870190314e8fe43d636fd823">failure</a>);
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <span class="keywordflow">switch</span> (proc-&gt;<a class="code" href="struct__CcnetProcessor.html#a044d12f3870190314e8fe43d636fd823">failure</a>) {
<a name="l00384"></a>00384     <span class="keywordflow">case</span> <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260a356349f5c99d03c7721d011d08ccd624">PROC_DONE</a>:
<a name="l00385"></a>00385         <span class="comment">/* It can never happen */</span>
<a name="l00386"></a>00386         g_return_if_reached ();
<a name="l00387"></a>00387     <span class="keywordflow">case</span> <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260a3034ea6f6eb7c4ecc98d1d4b45aabcdf">PROC_REMOTE_DEAD</a>:
<a name="l00388"></a>00388         seaf_warning (<span class="stringliteral">&quot;[tr-mgr] Shutdown processor with failure %d\n&quot;</span>,
<a name="l00389"></a>00389                    proc-&gt;<a class="code" href="struct__CcnetProcessor.html#a044d12f3870190314e8fe43d636fd823">failure</a>);
<a name="l00390"></a>00390         <a class="code" href="transfer-mgr_8c.html#ae337827e1d8f663486c0fb3bab156610">transfer_task_set_netdown</a> (task);
<a name="l00391"></a>00391         <span class="keywordflow">break</span>;
<a name="l00392"></a>00392     <span class="keywordflow">case</span> <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260a32e3732cd459464942237b9963e3cfa7">PROC_NO_SERVICE</a>:
<a name="l00393"></a>00393         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a0ad004149307d79067d3d96b530d85fa">TASK_ERR_NO_SERVICE</a>);
<a name="l00394"></a>00394         <span class="keywordflow">break</span>;
<a name="l00395"></a>00395     <span class="keywordflow">case</span> <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260aab69eea021cf87799528c363e8a6e88c">PROC_PERM_ERR</a>:
<a name="l00396"></a>00396         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a4d69917e55bc30a915f0b93ac909e366">TASK_ERR_PROC_PERM_ERR</a>);
<a name="l00397"></a>00397         <span class="keywordflow">break</span>;
<a name="l00398"></a>00398     <span class="keywordflow">case</span> <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260a78f0f66889520ef72e7ff02d7bb6d283">PROC_BAD_RESP</a>:
<a name="l00399"></a>00399     <span class="keywordflow">case</span> <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260a446522776dda7bc0ec1ac63acf582f53">PROC_NOTSET</a>:
<a name="l00400"></a>00400     <span class="keywordflow">default</span>:
<a name="l00401"></a>00401         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, defalut_error);
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403 }
<a name="l00404"></a>00404 
<a name="l00405"></a>00405 <span class="keyword">inline</span> <span class="keyword">static</span> gboolean is_peer_relay (<span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id)
<a name="l00406"></a>00406 {
<a name="l00407"></a>00407     <a class="code" href="struct__CcnetPeer.html">CcnetPeer</a> *peer = <a class="code" href="ccnet_8h.html#a136915227534e9204ffca3d7dc4d331e">ccnet_get_peer</a>(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#add541d96cca483ad72ff56ad061d1d32">ccnetrpc_client</a>, peer_id);
<a name="l00408"></a>00408 
<a name="l00409"></a>00409     <span class="keywordflow">if</span> (!peer)
<a name="l00410"></a>00410         <span class="keywordflow">return</span> FALSE;
<a name="l00411"></a>00411 
<a name="l00412"></a>00412     gboolean is_relay = <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a38f449c218477960cf9dc2136453db10">string_list_is_exists</a>(peer-&gt;<a class="code" href="struct__CcnetPeer.html#ada3797a08ba0f1cc321661a288f2c8df">role_list</a>, <span class="stringliteral">&quot;MyRelay&quot;</span>);
<a name="l00413"></a>00413     g_object_unref (peer);
<a name="l00414"></a>00414     <span class="keywordflow">return</span> is_relay;
<a name="l00415"></a>00415 }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417 <span class="comment">/*</span>
<a name="l00418"></a>00418 <span class="comment"> * Transfer Manager.</span>
<a name="l00419"></a>00419 <span class="comment"> */</span>
<a name="l00420"></a>00420 
<a name="l00421"></a>00421 <a class="code" href="struct__SeafTransferManager.html">SeafTransferManager</a>*
<a name="l00422"></a><a class="code" href="transfer-mgr_8h.html#a451893cddac6898ab70008a69b8fceae">00422</a> <a class="code" href="transfer-mgr_8c.html#a451893cddac6898ab70008a69b8fceae">seaf_transfer_manager_new</a> (<span class="keyword">struct</span> <a class="code" href="struct__SeafileSession.html">_SeafileSession</a> *<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>)
<a name="l00423"></a>00423 {
<a name="l00424"></a>00424     <a class="code" href="struct__SeafTransferManager.html">SeafTransferManager</a> *mgr = g_new0 (<a class="code" href="struct__SeafTransferManager.html">SeafTransferManager</a>, 1);
<a name="l00425"></a>00425 
<a name="l00426"></a>00426     mgr-&gt;<a class="code" href="struct__SeafTransferManager.html#a6bf9794fb2f726d6ab7d797874a346ca">seaf</a> = <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>;
<a name="l00427"></a>00427     mgr-&gt;<a class="code" href="struct__SeafTransferManager.html#a1c7de7270fc3d95c7df34cba0959c925">download_tasks</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
<a name="l00428"></a>00428                                                  (GDestroyNotify) g_free,
<a name="l00429"></a>00429                                                  (GDestroyNotify) seaf_transfer_task_free);
<a name="l00430"></a>00430     mgr-&gt;<a class="code" href="struct__SeafTransferManager.html#a12c3a28fb3a2802585dd1427aa83c8b5">upload_tasks</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
<a name="l00431"></a>00431                                                (GDestroyNotify) g_free,
<a name="l00432"></a>00432                                                (GDestroyNotify) seaf_transfer_task_free);
<a name="l00433"></a>00433 
<a name="l00434"></a>00434     <span class="keywordtype">char</span> *db_path = g_build_path (<a class="code" href="vc-utils_8h.html#aa7da4cdc6796b13fca1a4b263488dfdd">PATH_SEPERATOR</a>, seaf-&gt;<a class="code" href="struct__SeafileSession.html#ae4df188e5674e3e4b405f14d0ee1bf9f">seaf_dir</a>, <a class="code" href="transfer-mgr_8c.html#a529594214418a26d6770d7e25a22200a">TRANSFER_DB</a>, NULL);
<a name="l00435"></a>00435     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#af6e9a0e79db923d4a7df37bc5588400a">sqlite_open_db</a> (db_path, &amp;mgr-&gt;<a class="code" href="struct__SeafTransferManager.html#a63927924e19615f35fb5483a48a2143f">db</a>) &lt; 0) {
<a name="l00436"></a>00436         g_critical (<span class="stringliteral">&quot;[Transfer mgr] Failed to open transfer db\n&quot;</span>);
<a name="l00437"></a>00437         g_free (db_path);
<a name="l00438"></a>00438         g_free (mgr);
<a name="l00439"></a>00439         <span class="keywordflow">return</span> NULL;
<a name="l00440"></a>00440     }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442     <span class="keywordflow">return</span> mgr;
<a name="l00443"></a>00443 }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445 <span class="keyword">static</span> <span class="keywordtype">void</span> register_processors (<a class="code" href="struct__CcnetClient.html">CcnetClient</a> *<a class="code" href="monitor-tool_8c.html#ae6c1fa423e7fbf3f8de619294cb6b4b3">client</a>)
<a name="l00446"></a>00446 {
<a name="l00447"></a>00447     <a class="code" href="include_2ccnet_2proc-factory_8h.html#aa8eba73e6627b33e2cb2d91fd0ea9922">ccnet_proc_factory_register_processor</a> (client-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>,
<a name="l00448"></a>00448                                            <span class="stringliteral">&quot;seafile-check-tx-v2&quot;</span>,
<a name="l00449"></a>00449                                            <a class="code" href="check-tx-v2-proc_8h.html#ae8138cdc0b6462e1ea24d0ac96936e10">SEAFILE_TYPE_CHECK_TX_V2_PROC</a>);
<a name="l00450"></a>00450 
<a name="l00451"></a>00451     <a class="code" href="include_2ccnet_2proc-factory_8h.html#aa8eba73e6627b33e2cb2d91fd0ea9922">ccnet_proc_factory_register_processor</a> (client-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>,
<a name="l00452"></a>00452                                            <span class="stringliteral">&quot;seafile-check-tx-v3&quot;</span>,
<a name="l00453"></a>00453                                            <a class="code" href="check-tx-v3-proc_8h.html#a21aadc8de21d1fba0f1da1fd123bf567">SEAFILE_TYPE_CHECK_TX_V3_PROC</a>);
<a name="l00454"></a>00454 
<a name="l00455"></a>00455     <a class="code" href="include_2ccnet_2proc-factory_8h.html#aa8eba73e6627b33e2cb2d91fd0ea9922">ccnet_proc_factory_register_processor</a> (client-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>,
<a name="l00456"></a>00456                                            <span class="stringliteral">&quot;seafile-sendfs&quot;</span>,
<a name="l00457"></a>00457                                            <a class="code" href="sendfs-proc_8h.html#aa0871a217428c8942d26d39df2bb94f2">SEAFILE_TYPE_SENDFS_PROC</a>);
<a name="l00458"></a>00458 
<a name="l00459"></a>00459     <a class="code" href="include_2ccnet_2proc-factory_8h.html#aa8eba73e6627b33e2cb2d91fd0ea9922">ccnet_proc_factory_register_processor</a> (client-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>,
<a name="l00460"></a>00460                                            <span class="stringliteral">&quot;seafile-getfs&quot;</span>,
<a name="l00461"></a>00461                                            <a class="code" href="getfs-proc_8h.html#ad782d64cad000d4ee6cc68132fcf0538">SEAFILE_TYPE_GETFS_PROC</a>);
<a name="l00462"></a>00462 
<a name="l00463"></a>00463     <a class="code" href="include_2ccnet_2proc-factory_8h.html#aa8eba73e6627b33e2cb2d91fd0ea9922">ccnet_proc_factory_register_processor</a> (client-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>,
<a name="l00464"></a>00464                                            <span class="stringliteral">&quot;seafile-sendbranch&quot;</span>,
<a name="l00465"></a>00465                                            <a class="code" href="sendbranch-proc_8h.html#a4d205e9eaeb16daebfb5815036652cf2">SEAFILE_TYPE_SENDBRANCH_PROC</a>);
<a name="l00466"></a>00466 
<a name="l00467"></a>00467     <a class="code" href="include_2ccnet_2proc-factory_8h.html#aa8eba73e6627b33e2cb2d91fd0ea9922">ccnet_proc_factory_register_processor</a> (client-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>,
<a name="l00468"></a>00468                                            <span class="stringliteral">&quot;seafile-getcs&quot;</span>,
<a name="l00469"></a>00469                                            <a class="code" href="getcs-proc_8h.html#a1b7f193e0fb0611a1398edcaa8a3d6b0">SEAFILE_TYPE_GETCS_PROC</a>);
<a name="l00470"></a>00470 
<a name="l00471"></a>00471     <a class="code" href="include_2ccnet_2proc-factory_8h.html#aa8eba73e6627b33e2cb2d91fd0ea9922">ccnet_proc_factory_register_processor</a> (client-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>,
<a name="l00472"></a>00472                                            <span class="stringliteral">&quot;seafile-getcommit-v2&quot;</span>,
<a name="l00473"></a>00473                                            <a class="code" href="getcommit-v2-proc_8h.html#afce3e5f3514b23f2d07c0cf350c45865">SEAFILE_TYPE_GETCOMMIT_V2_PROC</a>);
<a name="l00474"></a>00474 
<a name="l00475"></a>00475     <a class="code" href="include_2ccnet_2proc-factory_8h.html#aa8eba73e6627b33e2cb2d91fd0ea9922">ccnet_proc_factory_register_processor</a> (client-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>,
<a name="l00476"></a>00476                                            <span class="stringliteral">&quot;seafile-getcommit-v3&quot;</span>,
<a name="l00477"></a>00477                                            <a class="code" href="getcommit-v3-proc_8h.html#a9fc7ad167cfec8bebe3d1b640ffd91ae">SEAFILE_TYPE_GETCOMMIT_V3_PROC</a>);
<a name="l00478"></a>00478 
<a name="l00479"></a>00479     <a class="code" href="include_2ccnet_2proc-factory_8h.html#aa8eba73e6627b33e2cb2d91fd0ea9922">ccnet_proc_factory_register_processor</a> (client-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>,
<a name="l00480"></a>00480                                            <span class="stringliteral">&quot;seafile-sendcommit-v3&quot;</span>,
<a name="l00481"></a>00481                                            <a class="code" href="sendcommit-v3-proc_8h.html#a4996a50bef9201955e484e9794b27eae">SEAFILE_TYPE_SENDCOMMIT_V3_PROC</a>);
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     <a class="code" href="include_2ccnet_2proc-factory_8h.html#aa8eba73e6627b33e2cb2d91fd0ea9922">ccnet_proc_factory_register_processor</a> (client-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>,
<a name="l00484"></a>00484                                            <span class="stringliteral">&quot;seafile-sendcommit-v3-new&quot;</span>,
<a name="l00485"></a>00485                                            <a class="code" href="sendcommit-v3-new-proc_8h.html#af33b3e9193cf34761a7184004fde5aa7">SEAFILE_TYPE_SENDCOMMIT_V3_NEW_PROC</a>);
<a name="l00486"></a>00486 
<a name="l00487"></a>00487     <a class="code" href="include_2ccnet_2proc-factory_8h.html#aa8eba73e6627b33e2cb2d91fd0ea9922">ccnet_proc_factory_register_processor</a> (client-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>,
<a name="l00488"></a>00488                                            <span class="stringliteral">&quot;seafile-checkbl&quot;</span>,
<a name="l00489"></a>00489                                            <a class="code" href="daemon_2processors_2checkbl-proc_8h.html#a16be113d11bd26f846655f65b76fbb88">SEAFILE_TYPE_CHECKBL_PROC</a>);
<a name="l00490"></a>00490     <a class="code" href="include_2ccnet_2proc-factory_8h.html#aa8eba73e6627b33e2cb2d91fd0ea9922">ccnet_proc_factory_register_processor</a> (client-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>,
<a name="l00491"></a>00491                                            <span class="stringliteral">&quot;seafile-getcs-v2&quot;</span>,
<a name="l00492"></a>00492                                            <a class="code" href="getcs-v2-proc_8h.html#a2e817458a1d794169ad81214e191b7d4">SEAFILE_TYPE_GETCS_V2_PROC</a>);
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     <a class="code" href="include_2ccnet_2proc-factory_8h.html#aa8eba73e6627b33e2cb2d91fd0ea9922">ccnet_proc_factory_register_processor</a> (client-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>,
<a name="l00495"></a>00495                                            <span class="stringliteral">&quot;seafile-sendcommit-v4&quot;</span>,
<a name="l00496"></a>00496                                            <a class="code" href="sendcommit-v4-proc_8h.html#a658aed8d907a33bb52e6479063c551ca">SEAFILE_TYPE_SENDCOMMIT_V4_PROC</a>);
<a name="l00497"></a>00497     <a class="code" href="include_2ccnet_2proc-factory_8h.html#aa8eba73e6627b33e2cb2d91fd0ea9922">ccnet_proc_factory_register_processor</a> (client-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>,
<a name="l00498"></a>00498                                            <span class="stringliteral">&quot;seafile-sendfs-v2&quot;</span>,
<a name="l00499"></a>00499                                            <a class="code" href="sendfs-v2-proc_8h.html#ad4fb1c9469b362cbd5d0992e30b0f533">SEAFILE_TYPE_SENDFS_V2_PROC</a>);
<a name="l00500"></a>00500     <a class="code" href="include_2ccnet_2proc-factory_8h.html#aa8eba73e6627b33e2cb2d91fd0ea9922">ccnet_proc_factory_register_processor</a> (client-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>,
<a name="l00501"></a>00501                                            <span class="stringliteral">&quot;seafile-getfs-v2&quot;</span>,
<a name="l00502"></a>00502                                            <a class="code" href="getfs-v2-proc_8h.html#ab31460f938e19d4f2bb5313885f61c20">SEAFILE_TYPE_GETFS_V2_PROC</a>);
<a name="l00503"></a>00503 }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505 <span class="keywordtype">int</span>
<a name="l00506"></a><a class="code" href="transfer-mgr_8h.html#a624e73788448eb5afc0041fbb4db38c9">00506</a> <a class="code" href="transfer-mgr_8c.html#a624e73788448eb5afc0041fbb4db38c9">seaf_transfer_manager_start</a> (<a class="code" href="struct__SeafTransferManager.html">SeafTransferManager</a> *manager)
<a name="l00507"></a>00507 {
<a name="l00508"></a>00508     <span class="keyword">const</span> <span class="keywordtype">char</span> *sql;
<a name="l00509"></a>00509 
<a name="l00510"></a>00510     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS CloneHeads &quot;</span>
<a name="l00511"></a>00511         <span class="stringliteral">&quot;(repo_id TEXT PRIMARY KEY, head TEXT);&quot;</span>;
<a name="l00512"></a>00512     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (manager-&gt;<a class="code" href="struct__SeafTransferManager.html#a63927924e19615f35fb5483a48a2143f">db</a>, sql) &lt; 0)
<a name="l00513"></a>00513         <span class="keywordflow">return</span> -1;
<a name="l00514"></a>00514 
<a name="l00515"></a>00515     register_processors (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>);
<a name="l00516"></a>00516 
<a name="l00517"></a>00517     manager-&gt;<a class="code" href="struct__SeafTransferManager.html#acdbc04428ac240eb1027a22ac62ef30b">schedule_timer</a> = <a class="code" href="timer_8h.html#a68b6afb704a7f56b625ed78146691b7c">ccnet_timer_new</a> (schedule_task_pulse, manager,
<a name="l00518"></a>00518                                                <a class="code" href="transfer-mgr_8c.html#af66ade775b3232f46645be3b78ac46de">SCHEDULE_INTERVAL</a> * 1000);
<a name="l00519"></a>00519 
<a name="l00520"></a>00520     <span class="keywordflow">return</span> 0;
<a name="l00521"></a>00521 }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523 <span class="comment">/*</span>
<a name="l00524"></a>00524 <span class="comment"> * We don&#39;t want to have two tasks for the same repo to run</span>
<a name="l00525"></a>00525 <span class="comment"> * simultaneously.</span>
<a name="l00526"></a>00526 <span class="comment"> */</span>
<a name="l00527"></a>00527 <span class="keyword">static</span> gboolean
<a name="l00528"></a>00528 is_duplicate_task (<a class="code" href="struct__SeafTransferManager.html">SeafTransferManager</a> *manager,
<a name="l00529"></a>00529                    <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l00530"></a>00530 {
<a name="l00531"></a>00531     GHashTableIter iter;
<a name="l00532"></a>00532     gpointer key, value;
<a name="l00533"></a>00533     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535     g_hash_table_iter_init (&amp;iter, manager-&gt;<a class="code" href="struct__SeafTransferManager.html#a1c7de7270fc3d95c7df34cba0959c925">download_tasks</a>);
<a name="l00536"></a>00536     <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
<a name="l00537"></a>00537         task = value;
<a name="l00538"></a>00538         <span class="keywordflow">if</span> (strcmp(task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, repo_id) == 0 &amp;&amp;
<a name="l00539"></a>00539             task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> != <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>)
<a name="l00540"></a>00540             <span class="keywordflow">return</span> TRUE;
<a name="l00541"></a>00541     }
<a name="l00542"></a>00542 
<a name="l00543"></a>00543     g_hash_table_iter_init (&amp;iter, manager-&gt;<a class="code" href="struct__SeafTransferManager.html#a12c3a28fb3a2802585dd1427aa83c8b5">upload_tasks</a>);
<a name="l00544"></a>00544     <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
<a name="l00545"></a>00545         task = value;
<a name="l00546"></a>00546         <span class="keywordflow">if</span> (strcmp(task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, repo_id) == 0 &amp;&amp;
<a name="l00547"></a>00547             task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> != <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>)
<a name="l00548"></a>00548             <span class="keywordflow">return</span> TRUE;
<a name="l00549"></a>00549     }
<a name="l00550"></a>00550 
<a name="l00551"></a>00551     <span class="keywordflow">return</span> FALSE;
<a name="l00552"></a>00552 }
<a name="l00553"></a>00553 
<a name="l00554"></a>00554 <span class="keyword">static</span> gboolean
<a name="l00555"></a>00555 remove_task_help (gpointer key, gpointer value, gpointer user_data)
<a name="l00556"></a>00556 {
<a name="l00557"></a>00557     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task = value;
<a name="l00558"></a>00558     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id = user_data;
<a name="l00559"></a>00559 
<a name="l00560"></a>00560     <span class="keywordflow">if</span> (strcmp(task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, repo_id) != 0)
<a name="l00561"></a>00561         <span class="keywordflow">return</span> FALSE;
<a name="l00562"></a>00562 
<a name="l00563"></a>00563     <span class="keywordflow">return</span> TRUE;
<a name="l00564"></a>00564 }
<a name="l00565"></a>00565 
<a name="l00566"></a>00566 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00567"></a>00567 clean_tasks_for_repo (<a class="code" href="struct__SeafTransferManager.html">SeafTransferManager</a> *manager,
<a name="l00568"></a>00568                       <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l00569"></a>00569 {
<a name="l00570"></a>00570     g_hash_table_foreach_remove (manager-&gt;<a class="code" href="struct__SeafTransferManager.html#a1c7de7270fc3d95c7df34cba0959c925">download_tasks</a>,
<a name="l00571"></a>00571                                  remove_task_help, (gpointer)repo_id);
<a name="l00572"></a>00572 
<a name="l00573"></a>00573     g_hash_table_foreach_remove (manager-&gt;<a class="code" href="struct__SeafTransferManager.html#a12c3a28fb3a2802585dd1427aa83c8b5">upload_tasks</a>,
<a name="l00574"></a>00574                                  remove_task_help, (gpointer)repo_id);
<a name="l00575"></a>00575 }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577 <span class="keywordtype">char</span> *
<a name="l00578"></a><a class="code" href="transfer-mgr_8h.html#a7c1421651b69da119fab63e9f1d5bf55">00578</a> <a class="code" href="transfer-mgr_8c.html#a7c1421651b69da119fab63e9f1d5bf55">seaf_transfer_manager_add_download</a> (<a class="code" href="struct__SeafTransferManager.html">SeafTransferManager</a> *manager,
<a name="l00579"></a>00579                                     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l00580"></a>00580                                     <span class="keywordtype">int</span> repo_version,
<a name="l00581"></a>00581                                     <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id,
<a name="l00582"></a>00582                                     <span class="keyword">const</span> <span class="keywordtype">char</span> *from_branch,
<a name="l00583"></a>00583                                     <span class="keyword">const</span> <span class="keywordtype">char</span> *to_branch,
<a name="l00584"></a>00584                                     <span class="keyword">const</span> <span class="keywordtype">char</span> *token,
<a name="l00585"></a>00585                                     gboolean server_side_merge,
<a name="l00586"></a>00586                                     <span class="keyword">const</span> <span class="keywordtype">char</span> *passwd,
<a name="l00587"></a>00587                                     <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree,
<a name="l00588"></a>00588                                     GError **error)
<a name="l00589"></a>00589 {
<a name="l00590"></a>00590     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task;
<a name="l00591"></a>00591 
<a name="l00592"></a>00592     <span class="keywordflow">if</span> (!repo_id || !from_branch || !to_branch || !token) {
<a name="l00593"></a>00593         g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Empty argument(s)&quot;</span>);
<a name="l00594"></a>00594         <span class="keywordflow">return</span> NULL;
<a name="l00595"></a>00595     }
<a name="l00596"></a>00596 
<a name="l00597"></a>00597     <span class="keywordflow">if</span> (is_duplicate_task (manager, repo_id)) {
<a name="l00598"></a>00598         g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;Task is already in progress&quot;</span>);
<a name="l00599"></a>00599         <span class="keywordflow">return</span> NULL;
<a name="l00600"></a>00600     }
<a name="l00601"></a>00601     clean_tasks_for_repo (manager, repo_id);
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     task = seaf_transfer_task_new (manager, NULL, repo_id, peer_id,
<a name="l00604"></a>00604                                    from_branch, to_branch, token,
<a name="l00605"></a>00605                                    <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa68841d8280724b9623db3dea4a78dde5">TASK_TYPE_DOWNLOAD</a>);
<a name="l00606"></a>00606     task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> = <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceac3efc29c1793f3f902e002589c600b33">TASK_STATE_NORMAL</a>;
<a name="l00607"></a>00607     task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a> = repo_version;
<a name="l00608"></a>00608 
<a name="l00609"></a>00609     task-&gt;<a class="code" href="struct__TransferTask.html#ab3092ff84d739c89ae1211670ac73362">server_side_merge</a> = server_side_merge;
<a name="l00610"></a>00610 
<a name="l00611"></a>00611     <span class="comment">/* Mark task &quot;clone&quot; if it&#39;s a new repo. */</span>
<a name="l00612"></a>00612     <span class="keywordflow">if</span> (!<a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a4b2497e6cdde50c4ce3cb642370e06eb">seaf_repo_manager_repo_exists</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id))
<a name="l00613"></a>00613         task-&gt;<a class="code" href="struct__TransferTask.html#a4462883da6780feae2b41060e5b48456">is_clone</a> = TRUE;
<a name="l00614"></a>00614 
<a name="l00615"></a>00615     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a4462883da6780feae2b41060e5b48456">is_clone</a>) {
<a name="l00616"></a>00616         task-&gt;<a class="code" href="struct__TransferTask.html#a5d04ab09b9dd283c65cb78d1918164b2">passwd</a> = g_strdup(passwd);
<a name="l00617"></a>00617         task-&gt;<a class="code" href="struct__TransferTask.html#a0a8e92f99b30194a9e2315f3b70b5c13">worktree</a> = g_strdup(worktree);
<a name="l00618"></a>00618     }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620     g_hash_table_insert (manager-&gt;<a class="code" href="struct__SeafTransferManager.html#a1c7de7270fc3d95c7df34cba0959c925">download_tasks</a>,
<a name="l00621"></a>00621                          g_strdup(task-&gt;<a class="code" href="struct__TransferTask.html#a4de0996bdefbbba5fa9d89f9c452b16e">tx_id</a>),
<a name="l00622"></a>00622                          task);
<a name="l00623"></a>00623 
<a name="l00624"></a>00624     <span class="keywordflow">return</span> g_strdup(task-&gt;<a class="code" href="struct__TransferTask.html#a4de0996bdefbbba5fa9d89f9c452b16e">tx_id</a>);
<a name="l00625"></a>00625 }
<a name="l00626"></a>00626 
<a name="l00627"></a>00627 <span class="keywordtype">char</span> *
<a name="l00628"></a><a class="code" href="transfer-mgr_8h.html#a084f2ccd845f2ff514aa3fd6a4a7b697">00628</a> <a class="code" href="transfer-mgr_8c.html#a084f2ccd845f2ff514aa3fd6a4a7b697">seaf_transfer_manager_add_upload</a> (<a class="code" href="struct__SeafTransferManager.html">SeafTransferManager</a> *manager,
<a name="l00629"></a>00629                                   <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l00630"></a>00630                                   <span class="keywordtype">int</span> repo_version,
<a name="l00631"></a>00631                                   <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id,
<a name="l00632"></a>00632                                   <span class="keyword">const</span> <span class="keywordtype">char</span> *from_branch,
<a name="l00633"></a>00633                                   <span class="keyword">const</span> <span class="keywordtype">char</span> *to_branch,
<a name="l00634"></a>00634                                   <span class="keyword">const</span> <span class="keywordtype">char</span> *token,
<a name="l00635"></a>00635                                   gboolean server_side_merge,
<a name="l00636"></a>00636                                   GError **error)
<a name="l00637"></a>00637 {
<a name="l00638"></a>00638     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task;
<a name="l00639"></a>00639     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l00640"></a>00640 
<a name="l00641"></a>00641     <span class="keywordflow">if</span> (!repo_id || !from_branch || !to_branch || !token) {
<a name="l00642"></a>00642         g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Empty argument(s)&quot;</span>);
<a name="l00643"></a>00643         <span class="keywordflow">return</span> NULL;
<a name="l00644"></a>00644     }
<a name="l00645"></a>00645 
<a name="l00646"></a>00646     repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id);
<a name="l00647"></a>00647     <span class="keywordflow">if</span> (!repo) {
<a name="l00648"></a>00648         g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Repo not found&quot;</span>);
<a name="l00649"></a>00649         <span class="keywordflow">return</span> NULL;
<a name="l00650"></a>00650     }
<a name="l00651"></a>00651 
<a name="l00652"></a>00652     <span class="keywordflow">if</span> (is_duplicate_task (manager, repo_id)) {
<a name="l00653"></a>00653         g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;Task is already in progress&quot;</span>);
<a name="l00654"></a>00654         <span class="keywordflow">return</span> NULL;
<a name="l00655"></a>00655     }
<a name="l00656"></a>00656     clean_tasks_for_repo (manager, repo_id);
<a name="l00657"></a>00657 
<a name="l00658"></a>00658     task = seaf_transfer_task_new (manager, NULL, repo_id, peer_id,
<a name="l00659"></a>00659                                    from_branch, to_branch, token,
<a name="l00660"></a>00660                                    <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa800672fa26f828e725e4f6efe3dd7a67">TASK_TYPE_UPLOAD</a>);
<a name="l00661"></a>00661     task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> = <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceac3efc29c1793f3f902e002589c600b33">TASK_STATE_NORMAL</a>;
<a name="l00662"></a>00662     task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a> = repo_version;
<a name="l00663"></a>00663     task-&gt;<a class="code" href="struct__TransferTask.html#ab3092ff84d739c89ae1211670ac73362">server_side_merge</a> = server_side_merge;
<a name="l00664"></a>00664 
<a name="l00665"></a>00665     g_hash_table_insert (manager-&gt;<a class="code" href="struct__SeafTransferManager.html#a12c3a28fb3a2802585dd1427aa83c8b5">upload_tasks</a>,
<a name="l00666"></a>00666                          g_strdup(task-&gt;<a class="code" href="struct__TransferTask.html#a4de0996bdefbbba5fa9d89f9c452b16e">tx_id</a>),
<a name="l00667"></a>00667                          task);
<a name="l00668"></a>00668 
<a name="l00669"></a>00669     <span class="keywordflow">return</span> g_strdup(task-&gt;<a class="code" href="struct__TransferTask.html#a4de0996bdefbbba5fa9d89f9c452b16e">tx_id</a>);
<a name="l00670"></a>00670 }
<a name="l00671"></a>00671 
<a name="l00672"></a>00672 <span class="comment">/* find running tranfer of a repo */</span>
<a name="l00673"></a>00673 <a class="code" href="struct__TransferTask.html">TransferTask</a>*
<a name="l00674"></a><a class="code" href="transfer-mgr_8h.html#a98142e3db29c901beff0fc71bbba601e">00674</a> <a class="code" href="transfer-mgr_8c.html#a98142e3db29c901beff0fc71bbba601e">seaf_transfer_manager_find_transfer_by_repo</a> (<a class="code" href="struct__SeafTransferManager.html">SeafTransferManager</a> *manager,
<a name="l00675"></a>00675                                              <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l00676"></a>00676 {
<a name="l00677"></a>00677     GHashTableIter iter;
<a name="l00678"></a>00678     gpointer key, value;
<a name="l00679"></a>00679     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task;
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     g_hash_table_iter_init (&amp;iter, manager-&gt;<a class="code" href="struct__SeafTransferManager.html#a1c7de7270fc3d95c7df34cba0959c925">download_tasks</a>);
<a name="l00682"></a>00682     <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
<a name="l00683"></a>00683         task = value;
<a name="l00684"></a>00684         <span class="keywordflow">if</span> (strcmp(task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, repo_id) == 0 &amp;&amp;
<a name="l00685"></a>00685             task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> != <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bcea407d72c040f282acb88e904361c217a2">TASK_STATE_FINISHED</a>)
<a name="l00686"></a>00686             <span class="keywordflow">return</span> task;
<a name="l00687"></a>00687     }
<a name="l00688"></a>00688 
<a name="l00689"></a>00689     g_hash_table_iter_init (&amp;iter, manager-&gt;<a class="code" href="struct__SeafTransferManager.html#a12c3a28fb3a2802585dd1427aa83c8b5">upload_tasks</a>);
<a name="l00690"></a>00690     <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
<a name="l00691"></a>00691         task = value;
<a name="l00692"></a>00692         <span class="keywordflow">if</span> (strcmp(task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, repo_id) == 0 &amp;&amp;
<a name="l00693"></a>00693             task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> != <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bcea407d72c040f282acb88e904361c217a2">TASK_STATE_FINISHED</a>)
<a name="l00694"></a>00694             <span class="keywordflow">return</span> task;
<a name="l00695"></a>00695     }
<a name="l00696"></a>00696 
<a name="l00697"></a>00697     <span class="keywordflow">return</span> NULL;
<a name="l00698"></a>00698 }
<a name="l00699"></a>00699 
<a name="l00700"></a>00700 
<a name="l00701"></a>00701 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00702"></a>00702 remove_task(<a class="code" href="struct__SeafTransferManager.html">SeafTransferManager</a> *manager, <a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l00703"></a>00703 {
<a name="l00704"></a>00704     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a5cb264f2074f78b92ac005633f412c24">type</a> == <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa68841d8280724b9623db3dea4a78dde5">TASK_TYPE_DOWNLOAD</a>) {
<a name="l00705"></a>00705         g_hash_table_remove (manager-&gt;<a class="code" href="struct__SeafTransferManager.html#a1c7de7270fc3d95c7df34cba0959c925">download_tasks</a>, task-&gt;<a class="code" href="struct__TransferTask.html#a4de0996bdefbbba5fa9d89f9c452b16e">tx_id</a>);
<a name="l00706"></a>00706     } <span class="keywordflow">else</span> {
<a name="l00707"></a>00707         g_hash_table_remove (manager-&gt;<a class="code" href="struct__SeafTransferManager.html#a12c3a28fb3a2802585dd1427aa83c8b5">upload_tasks</a>, task-&gt;<a class="code" href="struct__TransferTask.html#a4de0996bdefbbba5fa9d89f9c452b16e">tx_id</a>);
<a name="l00708"></a>00708     }
<a name="l00709"></a>00709 }
<a name="l00710"></a>00710 
<a name="l00711"></a>00711 <span class="keywordtype">void</span>
<a name="l00712"></a><a class="code" href="transfer-mgr_8h.html#ad58e56f4396d154be75bdb37bf4a53ae">00712</a> <a class="code" href="transfer-mgr_8c.html#ad58e56f4396d154be75bdb37bf4a53ae">seaf_transfer_manager_remove_task</a> (<a class="code" href="struct__SeafTransferManager.html">SeafTransferManager</a> *manager,
<a name="l00713"></a>00713                                     <span class="keyword">const</span> <span class="keywordtype">char</span> *tx_id,
<a name="l00714"></a>00714                                     <span class="keywordtype">int</span> task_type)
<a name="l00715"></a>00715 {
<a name="l00716"></a>00716     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task = NULL;
<a name="l00717"></a>00717 
<a name="l00718"></a>00718     <span class="keywordflow">if</span> (task_type == <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa68841d8280724b9623db3dea4a78dde5">TASK_TYPE_DOWNLOAD</a>)
<a name="l00719"></a>00719         task = g_hash_table_lookup (manager-&gt;<a class="code" href="struct__SeafTransferManager.html#a1c7de7270fc3d95c7df34cba0959c925">download_tasks</a>, tx_id);
<a name="l00720"></a>00720     <span class="keywordflow">else</span>
<a name="l00721"></a>00721         task = g_hash_table_lookup (manager-&gt;<a class="code" href="struct__SeafTransferManager.html#a12c3a28fb3a2802585dd1427aa83c8b5">upload_tasks</a>, tx_id);
<a name="l00722"></a>00722 
<a name="l00723"></a>00723     <span class="keywordflow">if</span> (!task)
<a name="l00724"></a>00724         <span class="keywordflow">return</span>;
<a name="l00725"></a>00725 
<a name="l00726"></a>00726     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> != <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>) {
<a name="l00727"></a>00727         seaf_warning (<span class="stringliteral">&quot;[tr-mgr] Try to remove running task!\n&quot;</span>);
<a name="l00728"></a>00728         <span class="keywordflow">return</span>;
<a name="l00729"></a>00729     }
<a name="l00730"></a>00730 
<a name="l00731"></a>00731     remove_task (manager, task);
<a name="l00732"></a>00732 }
<a name="l00733"></a>00733 
<a name="l00734"></a>00734 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00735"></a>00735 cancel_task (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l00736"></a>00736 {
<a name="l00737"></a>00737     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> == <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300abee3bb533aa834941c0ef1820a0aeec7">TASK_RT_STATE_NETDOWN</a> ||
<a name="l00738"></a>00738         task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> == <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a27c8f8580beaf1e17a371eacafb2a305">TASK_RT_STATE_INIT</a>) {
<a name="l00739"></a>00739         transition_state (task, <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaae36dd6c8f3e2e25e7946660ec15cf7d">TASK_STATE_CANCELED</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l00740"></a>00740     } <span class="keywordflow">else</span> {
<a name="l00741"></a>00741         <span class="comment">/*</span>
<a name="l00742"></a>00742 <span class="comment">         * Only transition state, not runtime state.</span>
<a name="l00743"></a>00743 <span class="comment">         * Runtime state transition is handled asynchronously.</span>
<a name="l00744"></a>00744 <span class="comment">         */</span>
<a name="l00745"></a>00745         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> &gt;= 4 &amp;&amp;
<a name="l00746"></a>00746             task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> == <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a6a546bd2f8de1f5a74956a45d58aba24">TASK_RT_STATE_DATA</a>)
<a name="l00747"></a>00747             <a class="code" href="block-tx-client_8c.html#a3b498db84c3dbe3392253ddd283ac7f3">block_tx_client_run_command</a> (task-&gt;<a class="code" href="struct__TransferTask.html#ac4c6a9314d3fb534c927d1ef89dae337">tx_info</a>, <a class="code" href="block-tx-client_8h.html#abc5c98fcc1211af2b80116dd6e0a035dad85f75e94b518092eb89dacbd18351b7">BLOCK_CLIENT_CMD_CANCEL</a>);
<a name="l00748"></a>00748         transition_state (task, <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaae36dd6c8f3e2e25e7946660ec15cf7d">TASK_STATE_CANCELED</a>, task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a>);
<a name="l00749"></a>00749     }
<a name="l00750"></a>00750 }
<a name="l00751"></a>00751 
<a name="l00752"></a>00752 <span class="keywordtype">void</span>
<a name="l00753"></a><a class="code" href="transfer-mgr_8h.html#af834de917c22d13996383431bef032a0">00753</a> <a class="code" href="transfer-mgr_8c.html#af834de917c22d13996383431bef032a0">seaf_transfer_manager_cancel_task</a> (<a class="code" href="struct__SeafTransferManager.html">SeafTransferManager</a> *manager,
<a name="l00754"></a>00754                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *tx_id,
<a name="l00755"></a>00755                                    <span class="keywordtype">int</span> task_type)
<a name="l00756"></a>00756 {
<a name="l00757"></a>00757     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task = NULL;
<a name="l00758"></a>00758 
<a name="l00759"></a>00759     <span class="keywordflow">if</span> (task_type == <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa68841d8280724b9623db3dea4a78dde5">TASK_TYPE_DOWNLOAD</a>)
<a name="l00760"></a>00760         task = g_hash_table_lookup (manager-&gt;<a class="code" href="struct__SeafTransferManager.html#a1c7de7270fc3d95c7df34cba0959c925">download_tasks</a>, tx_id);
<a name="l00761"></a>00761     <span class="keywordflow">else</span>
<a name="l00762"></a>00762         task = g_hash_table_lookup (manager-&gt;<a class="code" href="struct__SeafTransferManager.html#a12c3a28fb3a2802585dd1427aa83c8b5">upload_tasks</a>, tx_id);
<a name="l00763"></a>00763 
<a name="l00764"></a>00764     <span class="keywordflow">if</span> (!task)
<a name="l00765"></a>00765         <span class="keywordflow">return</span>;
<a name="l00766"></a>00766 
<a name="l00767"></a>00767     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> != <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceac3efc29c1793f3f902e002589c600b33">TASK_STATE_NORMAL</a>) {
<a name="l00768"></a>00768         seaf_warning (<span class="stringliteral">&quot;Task cannot be canceled!\n&quot;</span>);
<a name="l00769"></a>00769         <span class="keywordflow">return</span>;
<a name="l00770"></a>00770     }
<a name="l00771"></a>00771 
<a name="l00772"></a>00772     cancel_task (task);
<a name="l00773"></a>00773 }
<a name="l00774"></a>00774 
<a name="l00775"></a>00775 
<a name="l00776"></a>00776 GList*
<a name="l00777"></a><a class="code" href="transfer-mgr_8h.html#ab45ac6ab5c091d45224f57b0aa1f6452">00777</a> <a class="code" href="transfer-mgr_8c.html#ab45ac6ab5c091d45224f57b0aa1f6452">seaf_transfer_manager_get_upload_tasks</a> (<a class="code" href="struct__SeafTransferManager.html">SeafTransferManager</a> *manager)
<a name="l00778"></a>00778 {
<a name="l00779"></a>00779     <span class="keywordflow">return</span> g_hash_table_get_values (manager-&gt;<a class="code" href="struct__SeafTransferManager.html#a12c3a28fb3a2802585dd1427aa83c8b5">upload_tasks</a>);
<a name="l00780"></a>00780 }
<a name="l00781"></a>00781 
<a name="l00782"></a>00782 GList*
<a name="l00783"></a><a class="code" href="transfer-mgr_8h.html#acb8e9fc3a0648f40f6018c7f25d5b36f">00783</a> <a class="code" href="transfer-mgr_8c.html#acb8e9fc3a0648f40f6018c7f25d5b36f">seaf_transfer_manager_get_download_tasks</a> (<a class="code" href="struct__SeafTransferManager.html">SeafTransferManager</a> *manager)
<a name="l00784"></a>00784 {
<a name="l00785"></a>00785     <span class="keywordflow">return</span> g_hash_table_get_values (manager-&gt;<a class="code" href="struct__SeafTransferManager.html#a1c7de7270fc3d95c7df34cba0959c925">download_tasks</a>);
<a name="l00786"></a>00786 }
<a name="l00787"></a>00787 
<a name="l00788"></a>00788 <span class="keywordtype">int</span>
<a name="l00789"></a><a class="code" href="transfer-mgr_8h.html#a760b69b5aa68dcb74c3020f091d1fc6c">00789</a> <a class="code" href="transfer-mgr_8c.html#a760b69b5aa68dcb74c3020f091d1fc6c">seaf_transfer_manager_download_file_blocks</a> (<a class="code" href="struct__SeafTransferManager.html">SeafTransferManager</a> *manager,
<a name="l00790"></a>00790                                             <a class="code" href="struct__TransferTask.html">TransferTask</a> *task,
<a name="l00791"></a>00791                                             <span class="keyword">const</span> <span class="keywordtype">char</span> *file_id)
<a name="l00792"></a>00792 {
<a name="l00793"></a>00793     <a class="code" href="struct__Seafile.html">Seafile</a> *file;
<a name="l00794"></a>00794 
<a name="l00795"></a>00795     file = <a class="code" href="fs-mgr_8c.html#a029c16e2ecdf6eafd96edb2ee4e6beac">seaf_fs_manager_get_seafile</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
<a name="l00796"></a>00796                                         task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>,
<a name="l00797"></a>00797                                         task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>,
<a name="l00798"></a>00798                                         file_id);
<a name="l00799"></a>00799     <span class="keywordflow">if</span> (!file) {
<a name="l00800"></a>00800         seaf_warning (<span class="stringliteral">&quot;Failed to find seafile object %s in repo %.8s.\n&quot;</span>,
<a name="l00801"></a>00801                       file_id, task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>);
<a name="l00802"></a>00802         <span class="keywordflow">return</span> -1;
<a name="l00803"></a>00803     }
<a name="l00804"></a>00804 
<a name="l00805"></a>00805     <span class="keywordtype">int</span> i;
<a name="l00806"></a>00806     <span class="keywordtype">char</span> *<a class="code" href="block-tx-utils_8h.html#a2d616e1f81d11995c8b388444be651ef">block_id</a>;
<a name="l00807"></a>00807     <span class="keywordflow">for</span> (i = 0; i &lt; file-&gt;<a class="code" href="struct__Seafile.html#af2d5c5e5bb56d38122dead42128b9c20">n_blocks</a>; ++i) {
<a name="l00808"></a>00808         block_id = file-&gt;<a class="code" href="struct__Seafile.html#aacaedff2674132faf3d522ba8df6e268">blk_sha1s</a>[i];
<a name="l00809"></a>00809         <span class="keywordflow">if</span> (!<a class="code" href="block-mgr_8c.html#acc8d899bbbf17d0db6d07c9eda67fd0c">seaf_block_manager_block_exists</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>,
<a name="l00810"></a>00810                                               task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>,
<a name="l00811"></a>00811                                               task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>,
<a name="l00812"></a>00812                                               block_id))
<a name="l00813"></a>00813             g_queue_push_tail (task-&gt;<a class="code" href="struct__TransferTask.html#a1617756a21ea8da9bbb6795347df9b9f">block_ids</a>, g_strdup(block_id));
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815 
<a name="l00816"></a>00816     <a class="code" href="fs-mgr_8c.html#a0a491c647769cf7bd09d5092ab84b85a">seafile_unref</a> (file);
<a name="l00817"></a>00817 
<a name="l00818"></a>00818     <a class="code" href="struct__BlockTxInfo.html">BlockTxInfo</a> *info = task-&gt;<a class="code" href="struct__TransferTask.html#ac4c6a9314d3fb534c927d1ef89dae337">tx_info</a>;
<a name="l00819"></a>00819     <span class="keywordtype">int</span> rsp;
<a name="l00820"></a>00820 
<a name="l00821"></a>00821 retry:
<a name="l00822"></a>00822     <span class="keywordflow">if</span> (g_queue_get_length (task-&gt;<a class="code" href="struct__TransferTask.html#a1617756a21ea8da9bbb6795347df9b9f">block_ids</a>) == 0)
<a name="l00823"></a>00823         <span class="keywordflow">return</span> <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87edda66f4cf8f7807f8038262d56bc42c61df">BLOCK_CLIENT_SUCCESS</a>;
<a name="l00824"></a>00824 
<a name="l00825"></a>00825     <a class="code" href="block-tx-client_8c.html#a3b498db84c3dbe3392253ddd283ac7f3">block_tx_client_run_command</a> (info, <a class="code" href="block-tx-client_8h.html#abc5c98fcc1211af2b80116dd6e0a035da69efcb91bbae78a1895b23642d85ce6e">BLOCK_CLIENT_CMD_TRANSFER</a>);
<a name="l00826"></a>00826 
<a name="l00827"></a>00827     <span class="comment">/* Wait until block download is done. */</span>
<a name="l00828"></a>00828     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#ab4c7c5fbaad73e7853c2818f1611bf42">piperead</a> (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a385af5452c748c9a2387461440e0c422">done_pipe</a>[0], &amp;rsp, <span class="keyword">sizeof</span>(rsp));
<a name="l00829"></a>00829 
<a name="l00830"></a>00830     <span class="comment">/* The server closes the socket after 30 seconds without data,</span>
<a name="l00831"></a>00831 <span class="comment">     * so just retry if we encounter network error.</span>
<a name="l00832"></a>00832 <span class="comment">     */</span>
<a name="l00833"></a>00833     <span class="keywordflow">if</span> (rsp == <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87edda77daa389ab8b27e7dfb05e61b181c643">BLOCK_CLIENT_NET_ERROR</a>) {
<a name="l00834"></a>00834         <a class="code" href="block-tx-client_8c.html#a3b498db84c3dbe3392253ddd283ac7f3">block_tx_client_run_command</a> (info, <a class="code" href="block-tx-client_8h.html#abc5c98fcc1211af2b80116dd6e0a035daacfc9210b87af8d0d9fa1ad47d11f7d3">BLOCK_CLIENT_CMD_RESTART</a>);
<a name="l00835"></a>00835 
<a name="l00836"></a>00836         <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#ab4c7c5fbaad73e7853c2818f1611bf42">piperead</a> (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a385af5452c748c9a2387461440e0c422">done_pipe</a>[0], &amp;rsp, <span class="keyword">sizeof</span>(rsp));
<a name="l00837"></a>00837         <span class="keywordflow">if</span> (rsp == <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87eddae82f0760241f8b8e6f36e78f281899ef">BLOCK_CLIENT_READY</a>)
<a name="l00838"></a>00838             <span class="keywordflow">goto</span> retry;
<a name="l00839"></a>00839     }
<a name="l00840"></a>00840 
<a name="l00841"></a>00841     <span class="keywordflow">while</span> ((block_id = g_queue_pop_head(task-&gt;<a class="code" href="struct__TransferTask.html#a1617756a21ea8da9bbb6795347df9b9f">block_ids</a>)) != NULL)
<a name="l00842"></a>00842         g_free (block_id);
<a name="l00843"></a>00843 
<a name="l00844"></a>00844     <span class="keywordflow">return</span> rsp;
<a name="l00845"></a>00845 }
<a name="l00846"></a>00846 
<a name="l00847"></a>00847 <span class="comment">/* Utility functions. */</span>
<a name="l00848"></a>00848 
<a name="l00849"></a>00849 <span class="keyword">static</span> <a class="code" href="structBlockList.html">BlockList</a> *
<a name="l00850"></a>00850 load_blocklist_with_local_history (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l00851"></a>00851 {
<a name="l00852"></a>00852     <a class="code" href="structBlockList.html">BlockList</a> *bl1, *bl2, *bl = NULL;
<a name="l00853"></a>00853     <span class="keywordtype">int</span> i;
<a name="l00854"></a>00854     <a class="code" href="structObjectList.html">ObjectList</a> *commits = task-&gt;<a class="code" href="struct__TransferTask.html#aa9363a1d47f47572fbe229efd7a3f637">commits</a>;
<a name="l00855"></a>00855     <span class="keywordtype">char</span> *commit_id;
<a name="l00856"></a>00856     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit;
<a name="l00857"></a>00857     GList *parents = NULL;
<a name="l00858"></a>00858 
<a name="l00859"></a>00859     <span class="comment">/* Upload the blocks pointed by new commits, excluding</span>
<a name="l00860"></a>00860 <span class="comment">     * blocks that have been uploaded before.</span>
<a name="l00861"></a>00861 <span class="comment">     */</span>
<a name="l00862"></a>00862 
<a name="l00863"></a>00863     bl1 = <a class="code" href="fs-mgr_8c.html#a4ac91596236cf21856f9cf12d0e33ffa">block_list_new</a> ();
<a name="l00864"></a>00864 
<a name="l00865"></a>00865     <span class="keywordflow">for</span> (i = 0; i &lt; commits-&gt;<a class="code" href="structObjectList.html#a9765403eee5eb8c3d3b6ee1e1e7bcc29">obj_ids</a>-&gt;len; ++i) {
<a name="l00866"></a>00866         commit_id = g_ptr_array_index (commits-&gt;<a class="code" href="structObjectList.html#a9765403eee5eb8c3d3b6ee1e1e7bcc29">obj_ids</a>, i);
<a name="l00867"></a>00867         commit = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l00868"></a>00868                                                  task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>,
<a name="l00869"></a>00869                                                  task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>,
<a name="l00870"></a>00870                                                  commit_id);
<a name="l00871"></a>00871         <span class="keywordflow">if</span> (!commit) {
<a name="l00872"></a>00872             seaf_warning (<span class="stringliteral">&quot;Failed to get commit %s.\n&quot;</span>, commit_id);
<a name="l00873"></a>00873             <a class="code" href="fs-mgr_8c.html#a222764a7a6dc477fe04d6b5e267551cc">block_list_free</a> (bl1);
<a name="l00874"></a>00874             <span class="keywordflow">return</span> NULL;
<a name="l00875"></a>00875         }
<a name="l00876"></a>00876 
<a name="l00877"></a>00877         <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#ab1cd5c89e6d5b47b828c3de9bff87d88">seaf_fs_manager_populate_blocklist</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
<a name="l00878"></a>00878                                                 task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>,
<a name="l00879"></a>00879                                                 task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>,
<a name="l00880"></a>00880                                                 commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
<a name="l00881"></a>00881                                                 bl1) &lt; 0) {
<a name="l00882"></a>00882             <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
<a name="l00883"></a>00883             <a class="code" href="fs-mgr_8c.html#a222764a7a6dc477fe04d6b5e267551cc">block_list_free</a> (bl1);
<a name="l00884"></a>00884             <span class="keywordflow">return</span> NULL;
<a name="l00885"></a>00885         }
<a name="l00886"></a>00886 
<a name="l00887"></a>00887         <span class="keywordflow">if</span> (commit-&gt;<a class="code" href="struct__SeafCommit.html#a24518f58c804153742e9976049da8512">parent_id</a> &amp;&amp; !object_list_exists (commits, commit-&gt;<a class="code" href="struct__SeafCommit.html#a24518f58c804153742e9976049da8512">parent_id</a>))
<a name="l00888"></a>00888             parents = g_list_prepend (parents, g_strdup(commit-&gt;<a class="code" href="struct__SeafCommit.html#a24518f58c804153742e9976049da8512">parent_id</a>));
<a name="l00889"></a>00889 
<a name="l00890"></a>00890         <span class="keywordflow">if</span> (commit-&gt;<a class="code" href="struct__SeafCommit.html#aad2ebe1498cc25f837554456cbcd31f5">second_parent_id</a> &amp;&amp;
<a name="l00891"></a>00891             !object_list_exists (commits, commit-&gt;<a class="code" href="struct__SeafCommit.html#aad2ebe1498cc25f837554456cbcd31f5">second_parent_id</a>))
<a name="l00892"></a>00892             parents = g_list_prepend (parents, g_strdup(commit-&gt;<a class="code" href="struct__SeafCommit.html#aad2ebe1498cc25f837554456cbcd31f5">second_parent_id</a>));
<a name="l00893"></a>00893 
<a name="l00894"></a>00894         <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
<a name="l00895"></a>00895     }
<a name="l00896"></a>00896 
<a name="l00897"></a>00897     GList *p;
<a name="l00898"></a>00898     <span class="keywordtype">char</span> *parent_id;
<a name="l00899"></a>00899     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *parent;
<a name="l00900"></a>00900 
<a name="l00901"></a>00901     <span class="keywordflow">for</span> (p = parents; p; p = p-&gt;next) {
<a name="l00902"></a>00902         parent_id = p-&gt;data;
<a name="l00903"></a>00903         parent = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l00904"></a>00904                                                  task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>,
<a name="l00905"></a>00905                                                  task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>,
<a name="l00906"></a>00906                                                  parent_id);
<a name="l00907"></a>00907         <span class="keywordflow">if</span> (!parent) {
<a name="l00908"></a>00908             <a class="code" href="fs-mgr_8c.html#a222764a7a6dc477fe04d6b5e267551cc">block_list_free</a> (bl1);
<a name="l00909"></a>00909             <span class="keywordflow">return</span> NULL;
<a name="l00910"></a>00910         }
<a name="l00911"></a>00911 
<a name="l00912"></a>00912         bl2 = <a class="code" href="fs-mgr_8c.html#a4ac91596236cf21856f9cf12d0e33ffa">block_list_new</a> ();
<a name="l00913"></a>00913         <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#ab1cd5c89e6d5b47b828c3de9bff87d88">seaf_fs_manager_populate_blocklist</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
<a name="l00914"></a>00914                                                 task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>,
<a name="l00915"></a>00915                                                 task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>,
<a name="l00916"></a>00916                                                 parent-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, bl2) &lt; 0) {
<a name="l00917"></a>00917             <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (parent);
<a name="l00918"></a>00918             <a class="code" href="fs-mgr_8c.html#a222764a7a6dc477fe04d6b5e267551cc">block_list_free</a> (bl1);
<a name="l00919"></a>00919             <a class="code" href="fs-mgr_8c.html#a222764a7a6dc477fe04d6b5e267551cc">block_list_free</a> (bl2);
<a name="l00920"></a>00920             <span class="keywordflow">return</span> NULL;
<a name="l00921"></a>00921         }
<a name="l00922"></a>00922 
<a name="l00923"></a>00923         bl = <a class="code" href="fs-mgr_8c.html#a4de2ed795d3ad88266f347a245c8bd5c">block_list_difference</a> (bl1, bl2);
<a name="l00924"></a>00924         <a class="code" href="fs-mgr_8c.html#a222764a7a6dc477fe04d6b5e267551cc">block_list_free</a> (bl1);
<a name="l00925"></a>00925         bl1 = bl;
<a name="l00926"></a>00926 
<a name="l00927"></a>00927         <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (parent);
<a name="l00928"></a>00928         <a class="code" href="fs-mgr_8c.html#a222764a7a6dc477fe04d6b5e267551cc">block_list_free</a> (bl2);
<a name="l00929"></a>00929     }
<a name="l00930"></a>00930 
<a name="l00931"></a>00931     seaf_debug (<span class="stringliteral">&quot;Uploading %u blocks.\n&quot;</span>, bl1-&gt;<a class="code" href="structBlockList.html#a2ca09d61d434980fabd07ad6668ced3a">n_blocks</a>);
<a name="l00932"></a>00932 
<a name="l00933"></a>00933     <span class="keywordflow">return</span> bl1;
<a name="l00934"></a>00934 }
<a name="l00935"></a>00935 
<a name="l00936"></a>00936 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00937"></a>00937 seaf_transfer_task_load_blocklist (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l00938"></a>00938 {
<a name="l00939"></a>00939     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l00940"></a>00940     <a class="code" href="structBlockList.html">BlockList</a> *bl;
<a name="l00941"></a>00941 
<a name="l00942"></a>00942     repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>);
<a name="l00943"></a>00943     <span class="keywordflow">if</span> (!repo &amp;&amp; !task-&gt;<a class="code" href="struct__TransferTask.html#a4462883da6780feae2b41060e5b48456">is_clone</a>)
<a name="l00944"></a>00944         <span class="keywordflow">return</span> -1;
<a name="l00945"></a>00945 
<a name="l00946"></a>00946     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a5cb264f2074f78b92ac005633f412c24">type</a> == <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa800672fa26f828e725e4f6efe3dd7a67">TASK_TYPE_UPLOAD</a>) {
<a name="l00947"></a>00947         bl = load_blocklist_with_local_history (task);
<a name="l00948"></a>00948         <span class="keywordflow">if</span> (!bl) {
<a name="l00949"></a>00949             seaf_warning (<span class="stringliteral">&quot;[tr-mgr]Failed to populate blocklist.\n&quot;</span>);
<a name="l00950"></a>00950             <span class="keywordflow">return</span> -1;
<a name="l00951"></a>00951         }
<a name="l00952"></a>00952     } <span class="keywordflow">else</span> {
<a name="l00953"></a>00953         <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *remote;
<a name="l00954"></a>00954 
<a name="l00955"></a>00955         remote = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l00956"></a>00956                                                  task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>,
<a name="l00957"></a>00957                                                  task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>,
<a name="l00958"></a>00958                                                  task-&gt;<a class="code" href="struct__TransferTask.html#a1c9929f6b7f819e950b3738e676d82db">head</a>);
<a name="l00959"></a>00959         <span class="keywordflow">if</span> (!remote) {
<a name="l00960"></a>00960             seaf_warning (<span class="stringliteral">&quot;[tr-mgr] Failed to find commit %s.\n&quot;</span>, task-&gt;<a class="code" href="struct__TransferTask.html#a1c9929f6b7f819e950b3738e676d82db">head</a>);
<a name="l00961"></a>00961             <span class="keywordflow">return</span> -1;
<a name="l00962"></a>00962         }
<a name="l00963"></a>00963 
<a name="l00964"></a>00964         <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__TransferTask.html#a4462883da6780feae2b41060e5b48456">is_clone</a>) {
<a name="l00965"></a>00965             <span class="comment">/* If we&#39;re merging, only get new blocks that need to be checked out.</span>
<a name="l00966"></a>00966 <span class="comment">             */</span>
<a name="l00967"></a>00967             <span class="keywordflow">if</span> (<a class="code" href="merge_8c.html#ac3f5848ac9c0667d6740ac3592ec8909">merge_get_new_block_list</a> (repo, remote, &amp;bl) &lt; 0) {
<a name="l00968"></a>00968                 seaf_warning (<span class="stringliteral">&quot;[tr-mgr] Failed to get new blocks for merge.\n&quot;</span>);
<a name="l00969"></a>00969                 <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (remote);
<a name="l00970"></a>00970                 <span class="keywordflow">return</span> -1;
<a name="l00971"></a>00971             }
<a name="l00972"></a>00972         } <span class="keywordflow">else</span> {
<a name="l00973"></a>00973             <span class="comment">/* If we&#39;re cloning, only get blocks pointed by the lastest commit.</span>
<a name="l00974"></a>00974 <span class="comment">             */</span>
<a name="l00975"></a>00975             bl = <a class="code" href="fs-mgr_8c.html#a4ac91596236cf21856f9cf12d0e33ffa">block_list_new</a> ();
<a name="l00976"></a>00976             <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#ab1cd5c89e6d5b47b828c3de9bff87d88">seaf_fs_manager_populate_blocklist</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
<a name="l00977"></a>00977                                                     task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>,
<a name="l00978"></a>00978                                                     task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>,
<a name="l00979"></a>00979                                                     remote-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
<a name="l00980"></a>00980                                                     bl) &lt; 0) {
<a name="l00981"></a>00981                 seaf_warning (<span class="stringliteral">&quot;[tr-mgr] Failed to get blocks of commit %s.\n&quot;</span>,
<a name="l00982"></a>00982                            remote-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>);
<a name="l00983"></a>00983                 <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (remote);
<a name="l00984"></a>00984                 <span class="keywordflow">return</span> -1;
<a name="l00985"></a>00985             }
<a name="l00986"></a>00986         }
<a name="l00987"></a>00987         <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (remote);
<a name="l00988"></a>00988 
<a name="l00989"></a>00989         g_return_val_if_fail (bl != NULL, -1);
<a name="l00990"></a>00990     }
<a name="l00991"></a>00991 
<a name="l00992"></a>00992     task-&gt;<a class="code" href="struct__TransferTask.html#a9baa45e64248034aa15eed4f2a57ff70">block_list</a> = bl;
<a name="l00993"></a>00993 
<a name="l00994"></a>00994     <span class="keywordflow">return</span> 0;
<a name="l00995"></a>00995 }
<a name="l00996"></a>00996 
<a name="l00997"></a><a class="code" href="structDiffTreesData.html">00997</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structDiffTreesData.html">DiffTreesData</a> {
<a name="l00998"></a><a class="code" href="structDiffTreesData.html#a29c19e62afe3de7c90c89375dbf42f20">00998</a>     <a class="code" href="structBlockList.html">BlockList</a> *<a class="code" href="structDiffTreesData.html#a29c19e62afe3de7c90c89375dbf42f20">bl</a>;
<a name="l00999"></a><a class="code" href="structDiffTreesData.html#af9bffeb8d9fd25dc872b3aaca81eac0a">00999</a>     <a class="code" href="struct__TransferTask.html">TransferTask</a> *<a class="code" href="structDiffTreesData.html#af9bffeb8d9fd25dc872b3aaca81eac0a">task</a>;
<a name="l01000"></a>01000 } <a class="code" href="transfer-mgr_8c.html#a864fdf66a180e9297f74d0a6b123e6d0">DiffTreesData</a>;
<a name="l01001"></a>01001 
<a name="l01002"></a>01002 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01003"></a>01003 diff_files (<span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">char</span> *basedir, <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *files[], <span class="keywordtype">void</span> *vdata)
<a name="l01004"></a>01004 {
<a name="l01005"></a>01005     <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *file1 = files[0];
<a name="l01006"></a>01006     <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *file2 = files[1];
<a name="l01007"></a>01007     <a class="code" href="structDiffTreesData.html">DiffTreesData</a> *data = vdata;
<a name="l01008"></a>01008     <a class="code" href="structBlockList.html">BlockList</a> *bl = data-&gt;<a class="code" href="structDiffTreesData.html#a29c19e62afe3de7c90c89375dbf42f20">bl</a>;
<a name="l01009"></a>01009     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task = data-&gt;<a class="code" href="structDiffTreesData.html#af9bffeb8d9fd25dc872b3aaca81eac0a">task</a>;
<a name="l01010"></a>01010     <a class="code" href="struct__Seafile.html">Seafile</a> *f1 = NULL, *f2 = NULL;
<a name="l01011"></a>01011     <span class="keywordtype">int</span> i;
<a name="l01012"></a>01012 
<a name="l01013"></a>01013     <span class="keywordflow">if</span> (file1 &amp;&amp; strcmp (file1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>) != 0) {
<a name="l01014"></a>01014         <span class="keywordflow">if</span> (!file2) {
<a name="l01015"></a>01015             f1 = <a class="code" href="fs-mgr_8c.html#a029c16e2ecdf6eafd96edb2ee4e6beac">seaf_fs_manager_get_seafile</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
<a name="l01016"></a>01016                                               task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>,
<a name="l01017"></a>01017                                               file1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
<a name="l01018"></a>01018             <span class="keywordflow">if</span> (!f1) {
<a name="l01019"></a>01019                 seaf_warning (<span class="stringliteral">&quot;Failed to get seafile object %s.\n&quot;</span>, file1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
<a name="l01020"></a>01020                 <span class="keywordflow">return</span> -1;
<a name="l01021"></a>01021             }
<a name="l01022"></a>01022             <span class="keywordflow">for</span> (i = 0; i &lt; f1-&gt;<a class="code" href="struct__Seafile.html#af2d5c5e5bb56d38122dead42128b9c20">n_blocks</a>; ++i)
<a name="l01023"></a>01023                 <a class="code" href="fs-mgr_8c.html#a8dda70e7563d2ae6a19e7407e67dc38e">block_list_insert</a> (bl, f1-&gt;<a class="code" href="struct__Seafile.html#aacaedff2674132faf3d522ba8df6e268">blk_sha1s</a>[i]);
<a name="l01024"></a>01024             <a class="code" href="fs-mgr_8c.html#a0a491c647769cf7bd09d5092ab84b85a">seafile_unref</a> (f1);
<a name="l01025"></a>01025         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp (file1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>, file2-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>) != 0) {
<a name="l01026"></a>01026             f1 = <a class="code" href="fs-mgr_8c.html#a029c16e2ecdf6eafd96edb2ee4e6beac">seaf_fs_manager_get_seafile</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
<a name="l01027"></a>01027                                               task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>,
<a name="l01028"></a>01028                                               file1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
<a name="l01029"></a>01029             <span class="keywordflow">if</span> (!f1) {
<a name="l01030"></a>01030                 seaf_warning (<span class="stringliteral">&quot;Failed to get seafile object %s.\n&quot;</span>, file1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
<a name="l01031"></a>01031                 <span class="keywordflow">return</span> -1;
<a name="l01032"></a>01032             }
<a name="l01033"></a>01033             f2 = <a class="code" href="fs-mgr_8c.html#a029c16e2ecdf6eafd96edb2ee4e6beac">seaf_fs_manager_get_seafile</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
<a name="l01034"></a>01034                                               task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>,
<a name="l01035"></a>01035                                               file2-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
<a name="l01036"></a>01036             <span class="keywordflow">if</span> (!f2) {
<a name="l01037"></a>01037                 <a class="code" href="fs-mgr_8c.html#a0a491c647769cf7bd09d5092ab84b85a">seafile_unref</a> (f1);
<a name="l01038"></a>01038                 seaf_warning (<span class="stringliteral">&quot;Failed to get seafile object %s.\n&quot;</span>, file2-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
<a name="l01039"></a>01039                 <span class="keywordflow">return</span> -1;
<a name="l01040"></a>01040             }
<a name="l01041"></a>01041 
<a name="l01042"></a>01042             GHashTable *h = g_hash_table_new (g_str_hash, g_str_equal);
<a name="l01043"></a>01043             <span class="keywordtype">int</span> dummy;
<a name="l01044"></a>01044             <span class="keywordflow">for</span> (i = 0; i &lt; f2-&gt;n_blocks; ++i)
<a name="l01045"></a>01045                 g_hash_table_insert (h, f2-&gt;blk_sha1s[i], &amp;dummy);
<a name="l01046"></a>01046 
<a name="l01047"></a>01047             <span class="keywordflow">for</span> (i = 0; i &lt; f1-&gt;<a class="code" href="struct__Seafile.html#af2d5c5e5bb56d38122dead42128b9c20">n_blocks</a>; ++i)
<a name="l01048"></a>01048                 <span class="keywordflow">if</span> (!g_hash_table_lookup (h, f1-&gt;<a class="code" href="struct__Seafile.html#aacaedff2674132faf3d522ba8df6e268">blk_sha1s</a>[i]))
<a name="l01049"></a>01049                     <a class="code" href="fs-mgr_8c.html#a8dda70e7563d2ae6a19e7407e67dc38e">block_list_insert</a> (bl, f1-&gt;<a class="code" href="struct__Seafile.html#aacaedff2674132faf3d522ba8df6e268">blk_sha1s</a>[i]);
<a name="l01050"></a>01050 
<a name="l01051"></a>01051             <a class="code" href="fs-mgr_8c.html#a0a491c647769cf7bd09d5092ab84b85a">seafile_unref</a> (f1);
<a name="l01052"></a>01052             <a class="code" href="fs-mgr_8c.html#a0a491c647769cf7bd09d5092ab84b85a">seafile_unref</a> (f2);
<a name="l01053"></a>01053             g_hash_table_destroy (h);
<a name="l01054"></a>01054         }
<a name="l01055"></a>01055     }
<a name="l01056"></a>01056 
<a name="l01057"></a>01057     <span class="keywordflow">return</span> 0;
<a name="l01058"></a>01058 }
<a name="l01059"></a>01059 
<a name="l01060"></a>01060 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01061"></a>01061 diff_dirs (<span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">char</span> *basedir, <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *dirs[], <span class="keywordtype">void</span> *data,
<a name="l01062"></a>01062            gboolean *recurse)
<a name="l01063"></a>01063 {
<a name="l01064"></a>01064     <span class="comment">/* Do nothing */</span>
<a name="l01065"></a>01065     <span class="keywordflow">return</span> 0;
<a name="l01066"></a>01066 }
<a name="l01067"></a>01067 
<a name="l01068"></a>01068 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01069"></a>01069 load_blocklist_v2 (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l01070"></a>01070 {
<a name="l01071"></a>01071     <span class="keywordtype">int</span> ret = 0;
<a name="l01072"></a>01072 
<a name="l01073"></a>01073     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *local = NULL, *master = NULL;
<a name="l01074"></a>01074     local = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, <span class="stringliteral">&quot;local&quot;</span>);
<a name="l01075"></a>01075     <span class="keywordflow">if</span> (!local) {
<a name="l01076"></a>01076         seaf_warning (<span class="stringliteral">&quot;Branch local not found for repo %.8s.\n&quot;</span>, task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>);
<a name="l01077"></a>01077         ret = -1;
<a name="l01078"></a>01078         <span class="keywordflow">goto</span> out;
<a name="l01079"></a>01079     }
<a name="l01080"></a>01080     master = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, <span class="stringliteral">&quot;master&quot;</span>);
<a name="l01081"></a>01081     <span class="keywordflow">if</span> (!master) {
<a name="l01082"></a>01082         seaf_warning (<span class="stringliteral">&quot;Branch master not found for repo %.8s.\n&quot;</span>, task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>);
<a name="l01083"></a>01083         ret = -1;
<a name="l01084"></a>01084         <span class="keywordflow">goto</span> out;
<a name="l01085"></a>01085     }
<a name="l01086"></a>01086 
<a name="l01087"></a>01087     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *local_head = NULL, *master_head = NULL;
<a name="l01088"></a>01088     local_head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l01089"></a>01089                                                  task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>,
<a name="l01090"></a>01090                                                  local-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l01091"></a>01091     <span class="keywordflow">if</span> (!local_head) {
<a name="l01092"></a>01092         seaf_warning (<span class="stringliteral">&quot;Local head commit not found for repo %.8s.\n&quot;</span>,
<a name="l01093"></a>01093                       task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>);
<a name="l01094"></a>01094         ret = -1;
<a name="l01095"></a>01095         <span class="keywordflow">goto</span> out;
<a name="l01096"></a>01096     }
<a name="l01097"></a>01097     master_head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l01098"></a>01098                                                  task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>,
<a name="l01099"></a>01099                                                  master-&gt;commit_id);
<a name="l01100"></a>01100     <span class="keywordflow">if</span> (!master_head) {
<a name="l01101"></a>01101         seaf_warning (<span class="stringliteral">&quot;Master head commit not found for repo %.8s.\n&quot;</span>,
<a name="l01102"></a>01102                       task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>);
<a name="l01103"></a>01103         ret = -1;
<a name="l01104"></a>01104         <span class="keywordflow">goto</span> out;
<a name="l01105"></a>01105     }
<a name="l01106"></a>01106 
<a name="l01107"></a>01107     <a class="code" href="structBlockList.html">BlockList</a> *bl = <a class="code" href="fs-mgr_8c.html#a4ac91596236cf21856f9cf12d0e33ffa">block_list_new</a> ();
<a name="l01108"></a>01108     <a class="code" href="structDiffTreesData.html">DiffTreesData</a> data;
<a name="l01109"></a>01109     data.<a class="code" href="structDiffTreesData.html#a29c19e62afe3de7c90c89375dbf42f20">bl</a> = bl;
<a name="l01110"></a>01110     data.<a class="code" href="structDiffTreesData.html#af9bffeb8d9fd25dc872b3aaca81eac0a">task</a> = task;
<a name="l01111"></a>01111 
<a name="l01112"></a>01112     <a class="code" href="structDiffOptions.html">DiffOptions</a> opts;
<a name="l01113"></a>01113     memset (&amp;opts, 0, <span class="keyword">sizeof</span>(opts));
<a name="l01114"></a>01114     memcpy (opts.<a class="code" href="structDiffOptions.html#a2f9324e06d0355964eb248315056d65c">store_id</a>, task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, 36);
<a name="l01115"></a>01115     opts.<a class="code" href="structDiffOptions.html#a2a919ea52308ada77775f78787df38f8">version</a> = task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>;
<a name="l01116"></a>01116     opts.<a class="code" href="structDiffOptions.html#a879b904244a3b1cf5ca46b6951d068c3">file_cb</a> = diff_files;
<a name="l01117"></a>01117     opts.<a class="code" href="structDiffOptions.html#ac522b82b0271d69292cdaa84cb545b2b">dir_cb</a> = diff_dirs;
<a name="l01118"></a>01118     opts.<a class="code" href="structDiffOptions.html#aa922b39e312c25c075d5ed452d400b83">data</a> = &amp;data;
<a name="l01119"></a>01119 
<a name="l01120"></a>01120     <span class="keyword">const</span> <span class="keywordtype">char</span> *trees[2];
<a name="l01121"></a>01121     trees[0] = local_head-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>;
<a name="l01122"></a>01122     trees[1] = master_head-&gt;root_id;
<a name="l01123"></a>01123     <span class="keywordflow">if</span> (<a class="code" href="diff-simple_8c.html#aad681f9b9d7dbc7586efaa4cd0b254e6">diff_trees</a> (2, trees, &amp;opts) &lt; 0) {
<a name="l01124"></a>01124         seaf_warning (<span class="stringliteral">&quot;Failed to diff local and master head for repo %.8s.\n&quot;</span>,
<a name="l01125"></a>01125                       task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>);
<a name="l01126"></a>01126         ret = -1;
<a name="l01127"></a>01127         <span class="keywordflow">goto</span> out;
<a name="l01128"></a>01128     }
<a name="l01129"></a>01129 
<a name="l01130"></a>01130     task-&gt;<a class="code" href="struct__TransferTask.html#a9baa45e64248034aa15eed4f2a57ff70">block_list</a> = bl;
<a name="l01131"></a>01131 
<a name="l01132"></a>01132 out:
<a name="l01133"></a>01133     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (local);
<a name="l01134"></a>01134     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (master);
<a name="l01135"></a>01135     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (local_head);
<a name="l01136"></a>01136     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (master_head);
<a name="l01137"></a>01137     <span class="keywordflow">return</span> ret;
<a name="l01138"></a>01138 }
<a name="l01139"></a>01139 
<a name="l01140"></a>01140 <span class="comment">/*</span>
<a name="l01141"></a>01141 <span class="comment"> * Loading block list may take a lot of disk I/O, so do it in a thread.</span>
<a name="l01142"></a>01142 <span class="comment"> */</span>
<a name="l01143"></a>01143 
<a name="l01144"></a><a class="code" href="transfer-mgr_8c.html#a546842e1e57436efff3636d1b0341c4f">01144</a> <span class="keyword">typedef</span> void (*<a class="code" href="transfer-mgr_8c.html#a546842e1e57436efff3636d1b0341c4f">LoadBLCB</a>) (<a class="code" href="struct__TransferTask.html">TransferTask</a> *); 
<a name="l01145"></a>01145 
<a name="l01146"></a><a class="code" href="structLoadBLData.html">01146</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structLoadBLData.html">LoadBLData</a> {
<a name="l01147"></a><a class="code" href="structLoadBLData.html#ac20a93f69d96ccd00678aefd7e581e01">01147</a>     <a class="code" href="struct__TransferTask.html">TransferTask</a> *<a class="code" href="structLoadBLData.html#ac20a93f69d96ccd00678aefd7e581e01">task</a>;
<a name="l01148"></a><a class="code" href="structLoadBLData.html#a795277af31402f7b42bae04ee1640b21">01148</a>     gboolean <a class="code" href="structLoadBLData.html#a795277af31402f7b42bae04ee1640b21">success</a>;
<a name="l01149"></a><a class="code" href="structLoadBLData.html#a7eb3c81de7896f2f368f4e0e5851271c">01149</a>     <a class="code" href="transfer-mgr_8c.html#a546842e1e57436efff3636d1b0341c4f">LoadBLCB</a> <a class="code" href="structLoadBLData.html#a7eb3c81de7896f2f368f4e0e5851271c">callback</a>;
<a name="l01150"></a>01150 } <a class="code" href="transfer-mgr_8c.html#a6fa7423556a6b93cb3bd267fb013b5a2">LoadBLData</a>;
<a name="l01151"></a>01151 
<a name="l01152"></a>01152 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01153"></a>01153 load_block_list_done (<span class="keywordtype">void</span> *vdata)
<a name="l01154"></a>01154 {
<a name="l01155"></a>01155     <a class="code" href="structLoadBLData.html">LoadBLData</a> *data = vdata;
<a name="l01156"></a>01156     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task = data-&gt;<a class="code" href="structLoadBLData.html#ac20a93f69d96ccd00678aefd7e581e01">task</a>;
<a name="l01157"></a>01157 
<a name="l01158"></a>01158     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> == <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaae36dd6c8f3e2e25e7946660ec15cf7d">TASK_STATE_CANCELED</a>) {
<a name="l01159"></a>01159         transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l01160"></a>01160         g_free (data);
<a name="l01161"></a>01161         <span class="keywordflow">return</span>;
<a name="l01162"></a>01162     }
<a name="l01163"></a>01163 
<a name="l01164"></a>01164     <span class="keywordflow">if</span> (data-&gt;<a class="code" href="structLoadBLData.html#a795277af31402f7b42bae04ee1640b21">success</a>)
<a name="l01165"></a>01165         data-&gt;<a class="code" href="structLoadBLData.html#a7eb3c81de7896f2f368f4e0e5851271c">callback</a> (task);
<a name="l01166"></a>01166     <span class="keywordflow">else</span>
<a name="l01167"></a>01167         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a5e5c8de63772392c4d1d7601eb247f4a">TASK_ERR_LOAD_BLOCK_LIST</a>);
<a name="l01168"></a>01168 
<a name="l01169"></a>01169     g_free (data);
<a name="l01170"></a>01170 }
<a name="l01171"></a>01171 
<a name="l01172"></a>01172 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l01173"></a>01173 load_block_list_thread (<span class="keywordtype">void</span> *vdata)
<a name="l01174"></a>01174 {
<a name="l01175"></a>01175     <a class="code" href="structLoadBLData.html">LoadBLData</a> *data = vdata;
<a name="l01176"></a>01176     <span class="keywordtype">int</span> ret = 0;
<a name="l01177"></a>01177 
<a name="l01178"></a>01178     <span class="keywordflow">if</span> (data-&gt;<a class="code" href="structLoadBLData.html#ac20a93f69d96ccd00678aefd7e581e01">task</a>-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> &gt;= 7 &amp;&amp;
<a name="l01179"></a>01179         data-&gt;<a class="code" href="structLoadBLData.html#ac20a93f69d96ccd00678aefd7e581e01">task</a>-&gt;<a class="code" href="struct__TransferTask.html#a5cb264f2074f78b92ac005633f412c24">type</a> == <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa800672fa26f828e725e4f6efe3dd7a67">TASK_TYPE_UPLOAD</a>)
<a name="l01180"></a>01180         ret = load_blocklist_v2 (data-&gt;<a class="code" href="structLoadBLData.html#ac20a93f69d96ccd00678aefd7e581e01">task</a>);
<a name="l01181"></a>01181     <span class="keywordflow">else</span>
<a name="l01182"></a>01182         ret = seaf_transfer_task_load_blocklist (data-&gt;<a class="code" href="structLoadBLData.html#ac20a93f69d96ccd00678aefd7e581e01">task</a>);
<a name="l01183"></a>01183 
<a name="l01184"></a>01184     <span class="keywordflow">if</span> (ret &lt; 0)
<a name="l01185"></a>01185         data-&gt;<a class="code" href="structLoadBLData.html#a795277af31402f7b42bae04ee1640b21">success</a> = FALSE;
<a name="l01186"></a>01186     <span class="keywordflow">else</span>
<a name="l01187"></a>01187         data-&gt;<a class="code" href="structLoadBLData.html#a795277af31402f7b42bae04ee1640b21">success</a> = TRUE;
<a name="l01188"></a>01188 
<a name="l01189"></a>01189     <span class="keywordflow">return</span> data;
<a name="l01190"></a>01190 }
<a name="l01191"></a>01191 
<a name="l01192"></a>01192 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01193"></a>01193 start_load_block_list_thread (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task, <a class="code" href="transfer-mgr_8c.html#a546842e1e57436efff3636d1b0341c4f">LoadBLCB</a> callback)
<a name="l01194"></a>01194 {
<a name="l01195"></a>01195     <a class="code" href="structLoadBLData.html">LoadBLData</a> *data = g_new0 (<a class="code" href="structLoadBLData.html">LoadBLData</a>, 1);
<a name="l01196"></a>01196     data-&gt;<a class="code" href="structLoadBLData.html#ac20a93f69d96ccd00678aefd7e581e01">task</a> = task;
<a name="l01197"></a>01197     data-&gt;<a class="code" href="structLoadBLData.html#a7eb3c81de7896f2f368f4e0e5851271c">callback</a> = callback;
<a name="l01198"></a>01198 
<a name="l01199"></a>01199     <span class="keywordflow">return</span> <a class="code" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768">ccnet_job_manager_schedule_job</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#abcbb9886e315abb16c620ce49808a0b2">job_mgr</a>,
<a name="l01200"></a>01200                                            load_block_list_thread,
<a name="l01201"></a>01201                                            load_block_list_done,
<a name="l01202"></a>01202                                            data);
<a name="l01203"></a>01203 }
<a name="l01204"></a>01204 
<a name="l01205"></a>01205 <span class="keyword">static</span> gboolean
<a name="l01206"></a>01206 fs_root_collector (<a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit, <span class="keywordtype">void</span> *data, gboolean *stop)
<a name="l01207"></a>01207 {
<a name="l01208"></a>01208     <a class="code" href="structObjectList.html">ObjectList</a> *ol = data;
<a name="l01209"></a>01209 
<a name="l01210"></a>01210     <span class="keywordflow">if</span> (strcmp(commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>) != 0)
<a name="l01211"></a>01211         <a class="code" href="object-list_8c.html#a6adb15d74266af46eca29a5fdb98b490">object_list_insert</a> (ol, commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>);
<a name="l01212"></a>01212 
<a name="l01213"></a>01213     <span class="keywordflow">return</span> TRUE;
<a name="l01214"></a>01214 }
<a name="l01215"></a>01215 
<a name="l01216"></a>01216 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01217"></a>01217 generate_session_key (<a class="code" href="struct__BlockTxInfo.html">BlockTxInfo</a> *info, <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id)
<a name="l01218"></a>01218 {
<a name="l01219"></a>01219     <span class="keywordtype">char</span> *sk_base64, *sk_enc_base64;
<a name="l01220"></a>01220     gsize enc_key_len;
<a name="l01221"></a>01221 
<a name="l01222"></a>01222     <span class="keywordflow">if</span> (RAND_bytes (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a56046b61479e84d1b4d84a389f6c691b">session_key</a>, <span class="keyword">sizeof</span>(info-&gt;<a class="code" href="struct__BlockTxInfo.html#a56046b61479e84d1b4d84a389f6c691b">session_key</a>)) != 1) {
<a name="l01223"></a>01223         seaf_warning (<span class="stringliteral">&quot;Failed to generate random session key with RAND_bytes(), &quot;</span>
<a name="l01224"></a>01224                       <span class="stringliteral">&quot;switch to RAND_pseudo_bytes().\n&quot;</span>);
<a name="l01225"></a>01225         RAND_pseudo_bytes (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a56046b61479e84d1b4d84a389f6c691b">session_key</a>, <span class="keyword">sizeof</span>(info-&gt;<a class="code" href="struct__BlockTxInfo.html#a56046b61479e84d1b4d84a389f6c691b">session_key</a>));
<a name="l01226"></a>01226     }
<a name="l01227"></a>01227 
<a name="l01228"></a>01228     sk_base64 = g_base64_encode (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a56046b61479e84d1b4d84a389f6c691b">session_key</a>, <span class="keyword">sizeof</span>(info-&gt;<a class="code" href="struct__BlockTxInfo.html#a56046b61479e84d1b4d84a389f6c691b">session_key</a>));
<a name="l01229"></a>01229     sk_enc_base64 = <a class="code" href="ccnet_8h.html#a7d2d1774d225ce56e0e545b733c25890">ccnet_pubkey_encrypt</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#add541d96cca483ad72ff56ad061d1d32">ccnetrpc_client</a>,
<a name="l01230"></a>01230                                           sk_base64, peer_id);
<a name="l01231"></a>01231     info-&gt;<a class="code" href="struct__BlockTxInfo.html#abf72eb5db6ced1dfebe109fe29b52f86">enc_session_key</a> = g_base64_decode (sk_enc_base64, &amp;enc_key_len);
<a name="l01232"></a>01232     info-&gt;<a class="code" href="struct__BlockTxInfo.html#a4059a5c11fa68f350ca30cd0d8e7b5df">enc_key_len</a> = (int)enc_key_len;
<a name="l01233"></a>01233 
<a name="l01234"></a>01234     g_free (sk_base64);
<a name="l01235"></a>01235     g_free (sk_enc_base64);
<a name="l01236"></a>01236     <span class="keywordflow">return</span> 0;
<a name="l01237"></a>01237 }
<a name="l01238"></a>01238 
<a name="l01239"></a>01239 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01240"></a>01240 update_remote_branch (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task);
<a name="l01241"></a>01241 
<a name="l01242"></a>01242 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01243"></a>01243 update_local_repo (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task);
<a name="l01244"></a>01244 
<a name="l01245"></a>01245 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01246"></a>01246 block_tx_client_once_mode_done_cb (<a class="code" href="struct__BlockTxInfo.html">BlockTxInfo</a> *info)
<a name="l01247"></a>01247 {
<a name="l01248"></a>01248     <span class="keywordflow">switch</span> (info-&gt;<a class="code" href="struct__BlockTxInfo.html#afe3d0e422d3eab0582badcd1b029e22c">result</a>) {
<a name="l01249"></a>01249     <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87edda66f4cf8f7807f8038262d56bc42c61df">BLOCK_CLIENT_SUCCESS</a>:
<a name="l01250"></a>01250         <span class="keywordflow">if</span> (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a2500d4464a3cd66a362608a23848e936">task</a>-&gt;<a class="code" href="struct__TransferTask.html#a5cb264f2074f78b92ac005633f412c24">type</a> == <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa800672fa26f828e725e4f6efe3dd7a67">TASK_TYPE_UPLOAD</a>)
<a name="l01251"></a>01251             update_remote_branch (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a2500d4464a3cd66a362608a23848e936">task</a>);
<a name="l01252"></a>01252         <span class="keywordflow">else</span> {
<a name="l01253"></a>01253             <span class="keywordflow">if</span> (update_local_repo (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a2500d4464a3cd66a362608a23848e936">task</a>) == 0)
<a name="l01254"></a>01254                 transition_state (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a2500d4464a3cd66a362608a23848e936">task</a>, <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bcea407d72c040f282acb88e904361c217a2">TASK_STATE_FINISHED</a>,
<a name="l01255"></a>01255                                   <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l01256"></a>01256         }
<a name="l01257"></a>01257         <span class="keywordflow">break</span>;
<a name="l01258"></a>01258     <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87eddab6ee07e1f93fd060c972725c7a5642a0">BLOCK_CLIENT_FAILED</a>:
<a name="l01259"></a>01259     <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87edda961f855d617f8d1c95ffbe88a1729b23">BLOCK_CLIENT_UNKNOWN</a>:
<a name="l01260"></a>01260         <span class="keywordflow">if</span> (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a2500d4464a3cd66a362608a23848e936">task</a>-&gt;<a class="code" href="struct__TransferTask.html#a5cb264f2074f78b92ac005633f412c24">type</a> == <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa800672fa26f828e725e4f6efe3dd7a67">TASK_TYPE_UPLOAD</a>)
<a name="l01261"></a>01261             <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a2500d4464a3cd66a362608a23848e936">task</a>, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a39fa4f3087090cda71bfda6e8ce22f2e">TASK_ERR_UPLOAD_BLOCKS</a>);
<a name="l01262"></a>01262         <span class="keywordflow">else</span>
<a name="l01263"></a>01263             <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a2500d4464a3cd66a362608a23848e936">task</a>, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a7a2520dcf3ec32c8ff675716d78b809c">TASK_ERR_DOWNLOAD_BLOCKS</a>);
<a name="l01264"></a>01264         <span class="keywordflow">break</span>;
<a name="l01265"></a>01265     <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87edda5176a3efc074d82147f6ad9aee27702b">BLOCK_CLIENT_CANCELED</a>:
<a name="l01266"></a>01266         transition_state (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a2500d4464a3cd66a362608a23848e936">task</a>, <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaae36dd6c8f3e2e25e7946660ec15cf7d">TASK_STATE_CANCELED</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l01267"></a>01267         <span class="keywordflow">break</span>;
<a name="l01268"></a>01268     <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87edda77daa389ab8b27e7dfb05e61b181c643">BLOCK_CLIENT_NET_ERROR</a>:
<a name="l01269"></a>01269     <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87edda879e124929511a9dbbcbba1efb527900">BLOCK_CLIENT_SERVER_ERROR</a>:
<a name="l01270"></a>01270         <span class="keywordflow">if</span> (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a2500d4464a3cd66a362608a23848e936">task</a>-&gt;<a class="code" href="struct__TransferTask.html#a5cb264f2074f78b92ac005633f412c24">type</a> == <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa800672fa26f828e725e4f6efe3dd7a67">TASK_TYPE_UPLOAD</a>)
<a name="l01271"></a>01271             <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a2500d4464a3cd66a362608a23848e936">task</a>, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a39fa4f3087090cda71bfda6e8ce22f2e">TASK_ERR_UPLOAD_BLOCKS</a>);
<a name="l01272"></a>01272         <span class="keywordflow">else</span>
<a name="l01273"></a>01273             <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a2500d4464a3cd66a362608a23848e936">task</a>, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a7a2520dcf3ec32c8ff675716d78b809c">TASK_ERR_DOWNLOAD_BLOCKS</a>);
<a name="l01274"></a>01274         <span class="keywordflow">break</span>;
<a name="l01275"></a>01275     }
<a name="l01276"></a>01276 
<a name="l01277"></a>01277     g_free (info-&gt;<a class="code" href="struct__BlockTxInfo.html#abf72eb5db6ced1dfebe109fe29b52f86">enc_session_key</a>);
<a name="l01278"></a>01278     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a597da6cd8fcd52017eb622068a9538dc">pipeclose</a> (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a0450c17d797ca9998063bcec22d49025">cmd_pipe</a>[0]);
<a name="l01279"></a>01279     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a597da6cd8fcd52017eb622068a9538dc">pipeclose</a> (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a0450c17d797ca9998063bcec22d49025">cmd_pipe</a>[1]);
<a name="l01280"></a>01280     g_free (info);
<a name="l01281"></a>01281 }
<a name="l01282"></a>01282 
<a name="l01283"></a>01283 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01284"></a>01284 start_block_tx_client_run_once (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l01285"></a>01285 {
<a name="l01286"></a>01286     <a class="code" href="struct__BlockTxInfo.html">BlockTxInfo</a> *info;
<a name="l01287"></a>01287 
<a name="l01288"></a>01288     info = g_new0 (<a class="code" href="struct__BlockTxInfo.html">BlockTxInfo</a>, 1);
<a name="l01289"></a>01289 
<a name="l01290"></a>01290     info-&gt;<a class="code" href="struct__BlockTxInfo.html#a2500d4464a3cd66a362608a23848e936">task</a> = task;
<a name="l01291"></a>01291     <span class="comment">/* Only use the first chunk server. */</span>
<a name="l01292"></a>01292     info-&gt;<a class="code" href="struct__BlockTxInfo.html#aae08647e41181ac479ba1badbe4433e5">cs</a> = task-&gt;<a class="code" href="struct__TransferTask.html#a8f3d6d48752b55784c707019c4d21be3">chunk_servers</a>-&gt;data;
<a name="l01293"></a>01293 
<a name="l01294"></a>01294     <span class="keywordflow">if</span> (generate_session_key (info, task-&gt;<a class="code" href="struct__TransferTask.html#acca26edf8ec374118bbd917e93765f52">dest_id</a>) &lt; 0) {
<a name="l01295"></a>01295         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a77aa1bf0c5eeeb9ead5b9a6778b03970">TASK_ERR_START_BLOCK_CLIENT</a>);
<a name="l01296"></a>01296         <span class="keywordflow">return</span>;
<a name="l01297"></a>01297     }
<a name="l01298"></a>01298 
<a name="l01299"></a>01299     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a316a8da8d8eac0625b051bf2155bdc58">ccnet_pipe</a> (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a0450c17d797ca9998063bcec22d49025">cmd_pipe</a>) &lt; 0) {
<a name="l01300"></a>01300         seaf_warning (<span class="stringliteral">&quot;Failed to create command pipe: %s.\n&quot;</span>, strerror(errno));
<a name="l01301"></a>01301         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a77aa1bf0c5eeeb9ead5b9a6778b03970">TASK_ERR_START_BLOCK_CLIENT</a>);
<a name="l01302"></a>01302         <span class="keywordflow">return</span>;
<a name="l01303"></a>01303     }
<a name="l01304"></a>01304 
<a name="l01305"></a>01305     <span class="comment">/* For old syncing protocol, set block-tx-client to run-once mode. */</span>
<a name="l01306"></a>01306     info-&gt;<a class="code" href="struct__BlockTxInfo.html#a8b6117c43ddb5cbf3771424fb46f73f8">transfer_once</a> = TRUE;
<a name="l01307"></a>01307 
<a name="l01308"></a>01308     task-&gt;<a class="code" href="struct__TransferTask.html#ac4c6a9314d3fb534c927d1ef89dae337">tx_info</a> = info;
<a name="l01309"></a>01309 
<a name="l01310"></a>01310     <span class="keywordflow">if</span> (<a class="code" href="block-tx-client_8c.html#a654f06a1b4f80dd503445dd803615fd0">block_tx_client_start</a> (info, block_tx_client_once_mode_done_cb) &lt; 0) {
<a name="l01311"></a>01311         seaf_warning (<span class="stringliteral">&quot;Failed to start block tx client.\n&quot;</span>);
<a name="l01312"></a>01312         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a77aa1bf0c5eeeb9ead5b9a6778b03970">TASK_ERR_START_BLOCK_CLIENT</a>);
<a name="l01313"></a>01313         <span class="keywordflow">return</span>;
<a name="l01314"></a>01314     }
<a name="l01315"></a>01315 
<a name="l01316"></a>01316     transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a6a546bd2f8de1f5a74956a45d58aba24">TASK_RT_STATE_DATA</a>);
<a name="l01317"></a>01317 }
<a name="l01318"></a>01318 
<a name="l01319"></a>01319 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01320"></a>01320 block_tx_client_interactive_done_cb (<a class="code" href="struct__BlockTxInfo.html">BlockTxInfo</a> *info)
<a name="l01321"></a>01321 {
<a name="l01322"></a>01322 
<a name="l01323"></a>01323 }
<a name="l01324"></a>01324 
<a name="l01325"></a>01325 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01326"></a>01326 start_block_tx_client_interactive (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l01327"></a>01327 {
<a name="l01328"></a>01328     <a class="code" href="struct__BlockTxInfo.html">BlockTxInfo</a> *info;
<a name="l01329"></a>01329 
<a name="l01330"></a>01330     info = g_new0 (<a class="code" href="struct__BlockTxInfo.html">BlockTxInfo</a>, 1);
<a name="l01331"></a>01331 
<a name="l01332"></a>01332     info-&gt;<a class="code" href="struct__BlockTxInfo.html#a2500d4464a3cd66a362608a23848e936">task</a> = task;
<a name="l01333"></a>01333     <span class="comment">/* Only use the first chunk server. */</span>
<a name="l01334"></a>01334     info-&gt;<a class="code" href="struct__BlockTxInfo.html#aae08647e41181ac479ba1badbe4433e5">cs</a> = task-&gt;<a class="code" href="struct__TransferTask.html#a8f3d6d48752b55784c707019c4d21be3">chunk_servers</a>-&gt;data;
<a name="l01335"></a>01335 
<a name="l01336"></a>01336     task-&gt;<a class="code" href="struct__TransferTask.html#a1617756a21ea8da9bbb6795347df9b9f">block_ids</a> = g_queue_new();
<a name="l01337"></a>01337 
<a name="l01338"></a>01338     <span class="keywordflow">if</span> (generate_session_key (info, task-&gt;<a class="code" href="struct__TransferTask.html#acca26edf8ec374118bbd917e93765f52">dest_id</a>) &lt; 0) {
<a name="l01339"></a>01339         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a77aa1bf0c5eeeb9ead5b9a6778b03970">TASK_ERR_START_BLOCK_CLIENT</a>);
<a name="l01340"></a>01340         <span class="keywordflow">return</span>;
<a name="l01341"></a>01341     }
<a name="l01342"></a>01342 
<a name="l01343"></a>01343     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a316a8da8d8eac0625b051bf2155bdc58">ccnet_pipe</a> (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a0450c17d797ca9998063bcec22d49025">cmd_pipe</a>) &lt; 0) {
<a name="l01344"></a>01344         seaf_warning (<span class="stringliteral">&quot;Failed to create command pipe: %s.\n&quot;</span>, strerror(errno));
<a name="l01345"></a>01345         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a77aa1bf0c5eeeb9ead5b9a6778b03970">TASK_ERR_START_BLOCK_CLIENT</a>);
<a name="l01346"></a>01346         <span class="keywordflow">return</span>;
<a name="l01347"></a>01347     }
<a name="l01348"></a>01348 
<a name="l01349"></a>01349     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a316a8da8d8eac0625b051bf2155bdc58">ccnet_pipe</a> (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a385af5452c748c9a2387461440e0c422">done_pipe</a>) &lt; 0) {
<a name="l01350"></a>01350         seaf_warning (<span class="stringliteral">&quot;Failed to create done pipe: %s.\n&quot;</span>, strerror(errno));
<a name="l01351"></a>01351         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a77aa1bf0c5eeeb9ead5b9a6778b03970">TASK_ERR_START_BLOCK_CLIENT</a>);
<a name="l01352"></a>01352         <span class="keywordflow">return</span>;
<a name="l01353"></a>01353     }
<a name="l01354"></a>01354 
<a name="l01355"></a>01355     task-&gt;<a class="code" href="struct__TransferTask.html#ac4c6a9314d3fb534c927d1ef89dae337">tx_info</a> = info;
<a name="l01356"></a>01356 
<a name="l01357"></a>01357     <span class="keywordflow">if</span> (<a class="code" href="block-tx-client_8c.html#a654f06a1b4f80dd503445dd803615fd0">block_tx_client_start</a> (info, block_tx_client_interactive_done_cb) &lt; 0) {
<a name="l01358"></a>01358         seaf_warning (<span class="stringliteral">&quot;Failed to start block tx client.\n&quot;</span>);
<a name="l01359"></a>01359         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a77aa1bf0c5eeeb9ead5b9a6778b03970">TASK_ERR_START_BLOCK_CLIENT</a>);
<a name="l01360"></a>01360         <span class="keywordflow">return</span>;
<a name="l01361"></a>01361     }
<a name="l01362"></a>01362 
<a name="l01363"></a>01363     transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a6a546bd2f8de1f5a74956a45d58aba24">TASK_RT_STATE_DATA</a>);
<a name="l01364"></a>01364 }
<a name="l01365"></a>01365 
<a name="l01366"></a><a class="code" href="structDownloadFilesData.html">01366</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structDownloadFilesData.html">DownloadFilesData</a> {
<a name="l01367"></a><a class="code" href="structDownloadFilesData.html#a60a7c3c1bfd45cee08ddc0f74b1b798b">01367</a>     <a class="code" href="struct__TransferTask.html">TransferTask</a> *<a class="code" href="structDownloadFilesData.html#a60a7c3c1bfd45cee08ddc0f74b1b798b">task</a>;
<a name="l01368"></a><a class="code" href="structDownloadFilesData.html#a0704bad4c1d15eb91b1fca9d70b25938">01368</a>     <span class="keywordtype">int</span> <a class="code" href="structDownloadFilesData.html#a0704bad4c1d15eb91b1fca9d70b25938">status</a>;
<a name="l01369"></a>01369 } <a class="code" href="transfer-mgr_8c.html#aa0f576da591c2d0e57aa197d0a79c35a">DownloadFilesData</a>;
<a name="l01370"></a>01370 
<a name="l01371"></a>01371 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l01372"></a>01372 download_and_checkout_files_thread (<span class="keywordtype">void</span> *vdata)
<a name="l01373"></a>01373 {
<a name="l01374"></a>01374     <a class="code" href="structDownloadFilesData.html">DownloadFilesData</a> *data = vdata;
<a name="l01375"></a>01375     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task = data-&gt;<a class="code" href="structDownloadFilesData.html#a60a7c3c1bfd45cee08ddc0f74b1b798b">task</a>;
<a name="l01376"></a>01376     <span class="keywordtype">int</span> rsp;
<a name="l01377"></a>01377 
<a name="l01378"></a>01378     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#ab4c7c5fbaad73e7853c2818f1611bf42">piperead</a> (task-&gt;<a class="code" href="struct__TransferTask.html#ac4c6a9314d3fb534c927d1ef89dae337">tx_info</a>-&gt;<a class="code" href="struct__BlockTxInfo.html#a385af5452c748c9a2387461440e0c422">done_pipe</a>[0], &amp;rsp, <span class="keyword">sizeof</span>(rsp));
<a name="l01379"></a>01379 
<a name="l01380"></a>01380     <span class="keywordflow">if</span> (rsp == <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87eddae82f0760241f8b8e6f36e78f281899ef">BLOCK_CLIENT_READY</a>) {
<a name="l01381"></a>01381         data-&gt;<a class="code" href="structDownloadFilesData.html#a0704bad4c1d15eb91b1fca9d70b25938">status</a> = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a3ae125d7fd328d8d141dc38710ffd24e">seaf_repo_fetch_and_checkout</a> (task, NULL, FALSE, task-&gt;<a class="code" href="struct__TransferTask.html#a1c9929f6b7f819e950b3738e676d82db">head</a>);
<a name="l01382"></a>01382 
<a name="l01383"></a>01383         <a class="code" href="block-tx-client_8c.html#a3b498db84c3dbe3392253ddd283ac7f3">block_tx_client_run_command</a> (task-&gt;<a class="code" href="struct__TransferTask.html#ac4c6a9314d3fb534c927d1ef89dae337">tx_info</a>, <a class="code" href="block-tx-client_8h.html#abc5c98fcc1211af2b80116dd6e0a035da168d47e95a6309c04eeef267ff0dd891">BLOCK_CLIENT_CMD_END</a>);
<a name="l01384"></a>01384 
<a name="l01385"></a>01385         <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#ab4c7c5fbaad73e7853c2818f1611bf42">piperead</a> (task-&gt;<a class="code" href="struct__TransferTask.html#ac4c6a9314d3fb534c927d1ef89dae337">tx_info</a>-&gt;<a class="code" href="struct__BlockTxInfo.html#a385af5452c748c9a2387461440e0c422">done_pipe</a>[0], &amp;rsp, <span class="keyword">sizeof</span>(rsp));
<a name="l01386"></a>01386     } <span class="keywordflow">else</span>
<a name="l01387"></a>01387         <span class="comment">/* block-tx-client thread should have exited. */</span>
<a name="l01388"></a>01388         data-&gt;<a class="code" href="structDownloadFilesData.html#a0704bad4c1d15eb91b1fca9d70b25938">status</a> = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;
<a name="l01389"></a>01389 
<a name="l01390"></a>01390     <span class="keywordflow">return</span> vdata;
<a name="l01391"></a>01391 }
<a name="l01392"></a>01392 
<a name="l01393"></a>01393 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01394"></a>01394 download_and_checkout_files_done (<span class="keywordtype">void</span> *vdata)
<a name="l01395"></a>01395 {
<a name="l01396"></a>01396     <a class="code" href="structDownloadFilesData.html">DownloadFilesData</a> *data = vdata;
<a name="l01397"></a>01397     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task = data-&gt;<a class="code" href="structDownloadFilesData.html#a60a7c3c1bfd45cee08ddc0f74b1b798b">task</a>;
<a name="l01398"></a>01398     <a class="code" href="struct__BlockTxInfo.html">BlockTxInfo</a> *info = task-&gt;<a class="code" href="struct__TransferTask.html#ac4c6a9314d3fb534c927d1ef89dae337">tx_info</a>;
<a name="l01399"></a>01399 
<a name="l01400"></a>01400     g_free (info-&gt;<a class="code" href="struct__BlockTxInfo.html#abf72eb5db6ced1dfebe109fe29b52f86">enc_session_key</a>);
<a name="l01401"></a>01401     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a597da6cd8fcd52017eb622068a9538dc">pipeclose</a> (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a0450c17d797ca9998063bcec22d49025">cmd_pipe</a>[0]);
<a name="l01402"></a>01402     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a597da6cd8fcd52017eb622068a9538dc">pipeclose</a> (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a0450c17d797ca9998063bcec22d49025">cmd_pipe</a>[1]);
<a name="l01403"></a>01403     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a597da6cd8fcd52017eb622068a9538dc">pipeclose</a> (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a385af5452c748c9a2387461440e0c422">done_pipe</a>[0]);
<a name="l01404"></a>01404     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a597da6cd8fcd52017eb622068a9538dc">pipeclose</a> (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a385af5452c748c9a2387461440e0c422">done_pipe</a>[1]);
<a name="l01405"></a>01405     g_queue_free (info-&gt;<a class="code" href="struct__BlockTxInfo.html#a2500d4464a3cd66a362608a23848e936">task</a>-&gt;<a class="code" href="struct__TransferTask.html#a1617756a21ea8da9bbb6795347df9b9f">block_ids</a>);
<a name="l01406"></a>01406     g_free (info);
<a name="l01407"></a>01407 
<a name="l01408"></a>01408     <span class="keywordflow">switch</span> (data-&gt;<a class="code" href="structDownloadFilesData.html#a0704bad4c1d15eb91b1fca9d70b25938">status</a>) {
<a name="l01409"></a>01409     <span class="keywordflow">case</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>:
<a name="l01410"></a>01410         <span class="keywordflow">if</span> (update_local_repo (task) == 0)
<a name="l01411"></a>01411             transition_state (task, <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bcea407d72c040f282acb88e904361c217a2">TASK_STATE_FINISHED</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l01412"></a>01412         <span class="keywordflow">break</span>;
<a name="l01413"></a>01413     <span class="keywordflow">case</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>:
<a name="l01414"></a>01414     <span class="keywordflow">case</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a4a1718c70eba70651160111e48589161">FETCH_CHECKOUT_TRANSFER_ERROR</a>:
<a name="l01415"></a>01415         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a7a2520dcf3ec32c8ff675716d78b809c">TASK_ERR_DOWNLOAD_BLOCKS</a>);
<a name="l01416"></a>01416         <span class="keywordflow">break</span>;
<a name="l01417"></a>01417     <span class="keywordflow">case</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ae2a1e8d995b67343e5162cdb29513380">FETCH_CHECKOUT_CANCELED</a>:
<a name="l01418"></a>01418         transition_state (task, <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaae36dd6c8f3e2e25e7946660ec15cf7d">TASK_STATE_CANCELED</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l01419"></a>01419         <span class="keywordflow">break</span>;
<a name="l01420"></a>01420     <span class="keywordflow">case</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a662e1ae03ecdd8c6d02c7195e332d3ce">FETCH_CHECKOUT_LOCKED</a>:
<a name="l01421"></a>01421         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7abe38610c980c565069b26a2dcc63508d">TASK_ERR_FILES_LOCKED</a>);
<a name="l01422"></a>01422         <span class="keywordflow">break</span>;
<a name="l01423"></a>01423     }
<a name="l01424"></a>01424 
<a name="l01425"></a>01425     g_free (vdata);
<a name="l01426"></a>01426 }
<a name="l01427"></a>01427 
<a name="l01428"></a>01428 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01429"></a>01429 on_getcs_v2_done (<a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor, gboolean success, <span class="keywordtype">void</span> *data)
<a name="l01430"></a>01430 {
<a name="l01431"></a>01431     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task = data;
<a name="l01432"></a>01432 
<a name="l01433"></a>01433     <span class="comment">/* if the user stopped or canceled this task, stop processing. */</span>
<a name="l01434"></a>01434     <span class="comment">/* state #6, #10 */</span>
<a name="l01435"></a>01435     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> == <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaae36dd6c8f3e2e25e7946660ec15cf7d">TASK_STATE_CANCELED</a>) {
<a name="l01436"></a>01436         transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l01437"></a>01437         <span class="keywordflow">goto</span> out;
<a name="l01438"></a>01438     }
<a name="l01439"></a>01439 
<a name="l01440"></a>01440     <span class="keywordflow">if</span> (success) {
<a name="l01441"></a>01441         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a5cb264f2074f78b92ac005633f412c24">type</a> == <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa68841d8280724b9623db3dea4a78dde5">TASK_TYPE_DOWNLOAD</a> &amp;&amp; task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> &gt;= 7) {
<a name="l01442"></a>01442             <span class="comment">/* Record download head commit id, so that we can resume download</span>
<a name="l01443"></a>01443 <span class="comment">             * if this download is interrupted.</span>
<a name="l01444"></a>01444 <span class="comment">             */</span>
<a name="l01445"></a>01445             <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l01446"></a>01446                                                  task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>,
<a name="l01447"></a>01447                                                  <a class="code" href="daemon_2repo-mgr_8h.html#a1d90660156a493f14023ca76013acd64">REPO_PROP_DOWNLOAD_HEAD</a>,
<a name="l01448"></a>01448                                                  task-&gt;<a class="code" href="struct__TransferTask.html#a1c9929f6b7f819e950b3738e676d82db">head</a>);
<a name="l01449"></a>01449 
<a name="l01450"></a>01450             start_block_tx_client_interactive (task);
<a name="l01451"></a>01451 
<a name="l01452"></a>01452             <a class="code" href="structDownloadFilesData.html">DownloadFilesData</a> *data = g_new0 (<a class="code" href="structDownloadFilesData.html">DownloadFilesData</a>, 1);
<a name="l01453"></a>01453             data-&gt;<a class="code" href="structDownloadFilesData.html#a60a7c3c1bfd45cee08ddc0f74b1b798b">task</a> = task;
<a name="l01454"></a>01454 
<a name="l01455"></a>01455             <span class="comment">/* This thread uses block-tx-client thread to download blocks. */</span>
<a name="l01456"></a>01456             <a class="code" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768">ccnet_job_manager_schedule_job</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#abcbb9886e315abb16c620ce49808a0b2">job_mgr</a>,
<a name="l01457"></a>01457                                             download_and_checkout_files_thread,
<a name="l01458"></a>01458                                             download_and_checkout_files_done,
<a name="l01459"></a>01459                                             data);
<a name="l01460"></a>01460         } <span class="keywordflow">else</span> 
<a name="l01461"></a>01461             start_block_tx_client_run_once (task);
<a name="l01462"></a>01462     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> != <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaeef2d65ee28a06d4dad01ed46ab8c213">TASK_STATE_ERROR</a>) {
<a name="l01463"></a>01463         transfer_task_with_proc_failure (
<a name="l01464"></a>01464             task, processor, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a7d4e44fc675e8a31ac743619b994c44d">TASK_ERR_GET_CHUNK_SERVER</a>);
<a name="l01465"></a>01465     }
<a name="l01466"></a>01466 
<a name="l01467"></a>01467 out:
<a name="l01468"></a>01468     g_signal_handlers_disconnect_by_func (processor, on_getcs_v2_done, data);
<a name="l01469"></a>01469 }
<a name="l01470"></a>01470 
<a name="l01471"></a>01471 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01472"></a>01472 get_chunk_server_address (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l01473"></a>01473 {
<a name="l01474"></a>01474     <a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor;
<a name="l01475"></a>01475 
<a name="l01476"></a>01476     processor = <a class="code" href="include_2ccnet_2proc-factory_8h.html#a4e77de8f2768695e93845129041759c7">ccnet_proc_factory_create_remote_master_processor</a> (
<a name="l01477"></a>01477                 <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>, <span class="stringliteral">&quot;seafile-getcs-v2&quot;</span>, task-&gt;<a class="code" href="struct__TransferTask.html#acca26edf8ec374118bbd917e93765f52">dest_id</a>);
<a name="l01478"></a>01478     ((<a class="code" href="struct__SeafileGetcsV2Proc.html">SeafileGetcsV2Proc</a> *)processor)-&gt;task = task;
<a name="l01479"></a>01479     g_signal_connect (processor, <span class="stringliteral">&quot;done&quot;</span>, (GCallback)on_getcs_v2_done, task);
<a name="l01480"></a>01480 
<a name="l01481"></a>01481     <span class="keywordflow">if</span> (<a class="code" href="include_2ccnet_2processor_8h.html#ae2bb4b51c8e7dd43366b777ca9b00cf6">ccnet_processor_startl</a> (processor, NULL) &lt; 0) {
<a name="l01482"></a>01482         seaf_warning (<span class="stringliteral">&quot;failed to start getcs-v2 proc.\n&quot;</span>);
<a name="l01483"></a>01483         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a7d4e44fc675e8a31ac743619b994c44d">TASK_ERR_GET_CHUNK_SERVER</a>);
<a name="l01484"></a>01484     }
<a name="l01485"></a>01485 
<a name="l01486"></a>01486     transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a5e9d30b571a028283a4c3cb9c880377a">TASK_RT_STATE_CHUNK_SERVER</a>);
<a name="l01487"></a>01487 }
<a name="l01488"></a>01488 
<a name="l01489"></a>01489 <span class="comment">/* -------- download -------- */</span>
<a name="l01490"></a>01490 
<a name="l01491"></a>01491 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01492"></a>01492 start_getcommit_proc (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task, <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id, GCallback done_cb)
<a name="l01493"></a>01493 {
<a name="l01494"></a>01494     <a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor;
<a name="l01495"></a>01495 
<a name="l01496"></a>01496     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> &lt;= 5)
<a name="l01497"></a>01497         processor = <a class="code" href="include_2ccnet_2proc-factory_8h.html#a4e77de8f2768695e93845129041759c7">ccnet_proc_factory_create_remote_master_processor</a> (
<a name="l01498"></a>01498                     <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>, <span class="stringliteral">&quot;seafile-getcommit-v2&quot;</span>, peer_id);
<a name="l01499"></a>01499     <span class="keywordflow">else</span>
<a name="l01500"></a>01500         processor = <a class="code" href="include_2ccnet_2proc-factory_8h.html#a4e77de8f2768695e93845129041759c7">ccnet_proc_factory_create_remote_master_processor</a> (
<a name="l01501"></a>01501                     <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>, <span class="stringliteral">&quot;seafile-getcommit-v3&quot;</span>, peer_id);
<a name="l01502"></a>01502     <span class="keywordflow">if</span> (!processor) {
<a name="l01503"></a>01503         seaf_warning (<span class="stringliteral">&quot;failed to create getcommit proc.\n&quot;</span>);
<a name="l01504"></a>01504         <span class="keywordflow">return</span> -1;
<a name="l01505"></a>01505     }
<a name="l01506"></a>01506 
<a name="l01507"></a>01507     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> &lt;= 5)
<a name="l01508"></a>01508         ((<a class="code" href="struct__SeafileGetcommitV2Proc.html">SeafileGetcommitV2Proc</a> *)processor)-&gt;tx_task = task;
<a name="l01509"></a>01509     <span class="keywordflow">else</span>
<a name="l01510"></a>01510         ((<a class="code" href="struct__SeafileGetcommitV3Proc.html">SeafileGetcommitV3Proc</a> *)processor)-&gt;tx_task = task;
<a name="l01511"></a>01511     g_signal_connect (processor, <span class="stringliteral">&quot;done&quot;</span>, done_cb, task);
<a name="l01512"></a>01512 
<a name="l01513"></a>01513     <span class="keywordflow">if</span> (<a class="code" href="include_2ccnet_2processor_8h.html#ae2bb4b51c8e7dd43366b777ca9b00cf6">ccnet_processor_startl</a> (processor, NULL) &lt; 0) {
<a name="l01514"></a>01514         seaf_warning (<span class="stringliteral">&quot;failed to start getcommit proc.\n&quot;</span>);
<a name="l01515"></a>01515         <span class="keywordflow">return</span> -1;
<a name="l01516"></a>01516     }
<a name="l01517"></a>01517 
<a name="l01518"></a>01518     <span class="keywordflow">return</span> 0;
<a name="l01519"></a>01519 }
<a name="l01520"></a>01520 
<a name="l01521"></a>01521 
<a name="l01522"></a>01522 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01523"></a>01523 start_getfs_proc (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task, <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id, GCallback done_cb)
<a name="l01524"></a>01524 {
<a name="l01525"></a>01525     <a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor;
<a name="l01526"></a>01526 
<a name="l01527"></a>01527     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> &lt;= 6)
<a name="l01528"></a>01528         processor = <a class="code" href="include_2ccnet_2proc-factory_8h.html#a4e77de8f2768695e93845129041759c7">ccnet_proc_factory_create_remote_master_processor</a> (
<a name="l01529"></a>01529             <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>, <span class="stringliteral">&quot;seafile-getfs&quot;</span>, peer_id);
<a name="l01530"></a>01530     <span class="keywordflow">else</span>
<a name="l01531"></a>01531         processor = <a class="code" href="include_2ccnet_2proc-factory_8h.html#a4e77de8f2768695e93845129041759c7">ccnet_proc_factory_create_remote_master_processor</a> (
<a name="l01532"></a>01532             <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>, <span class="stringliteral">&quot;seafile-getfs-v2&quot;</span>, peer_id);
<a name="l01533"></a>01533     <span class="keywordflow">if</span> (!processor) {
<a name="l01534"></a>01534         seaf_warning (<span class="stringliteral">&quot;failed to create getfs proc.\n&quot;</span>);
<a name="l01535"></a>01535         <span class="keywordflow">return</span> -1;
<a name="l01536"></a>01536     }
<a name="l01537"></a>01537 
<a name="l01538"></a>01538     ((<a class="code" href="struct__SeafileGetfsProc.html">SeafileGetfsProc</a> *)processor)-&gt;tx_task = task;
<a name="l01539"></a>01539     g_signal_connect (processor, <span class="stringliteral">&quot;done&quot;</span>, done_cb, task);
<a name="l01540"></a>01540 
<a name="l01541"></a>01541     <span class="keywordflow">if</span> (<a class="code" href="include_2ccnet_2processor_8h.html#ae2bb4b51c8e7dd43366b777ca9b00cf6">ccnet_processor_startl</a> (processor, NULL) &lt; 0) {
<a name="l01542"></a>01542         seaf_warning (<span class="stringliteral">&quot;failed to start getfs proc.\n&quot;</span>);
<a name="l01543"></a>01543         <span class="keywordflow">return</span> -1;
<a name="l01544"></a>01544     }
<a name="l01545"></a>01545 
<a name="l01546"></a>01546     <span class="keywordflow">return</span> 0;
<a name="l01547"></a>01547 }
<a name="l01548"></a>01548 
<a name="l01549"></a>01549 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01550"></a>01550 check_block_ids_for_download (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l01551"></a>01551 {
<a name="l01552"></a>01552     <span class="keywordtype">int</span> i;
<a name="l01553"></a>01553     <a class="code" href="structBlockList.html">BlockList</a> *bl = task-&gt;<a class="code" href="struct__TransferTask.html#a9baa45e64248034aa15eed4f2a57ff70">block_list</a>;
<a name="l01554"></a>01554     <span class="keywordtype">char</span> *<a class="code" href="block-tx-utils_8h.html#a2d616e1f81d11995c8b388444be651ef">block_id</a>;
<a name="l01555"></a>01555 
<a name="l01556"></a>01556     task-&gt;<a class="code" href="struct__TransferTask.html#a1617756a21ea8da9bbb6795347df9b9f">block_ids</a> = g_queue_new ();
<a name="l01557"></a>01557 
<a name="l01558"></a>01558     <span class="comment">/* Add all blocks we don&#39;t have into task-&gt;block_ids. */</span>
<a name="l01559"></a>01559     <span class="keywordflow">for</span> (i = 0; i &lt; bl-&gt;<a class="code" href="structBlockList.html#a2ca09d61d434980fabd07ad6668ced3a">n_blocks</a>; ++i) {
<a name="l01560"></a>01560         block_id = g_ptr_array_index (bl-&gt;<a class="code" href="structBlockList.html#a11da65abdf8aff4a0161c28ded3ccaad">block_ids</a>, i);
<a name="l01561"></a>01561         <span class="keywordflow">if</span> (!<a class="code" href="block-mgr_8c.html#acc8d899bbbf17d0db6d07c9eda67fd0c">seaf_block_manager_block_exists</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>,
<a name="l01562"></a>01562                                               task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>,
<a name="l01563"></a>01563                                               block_id))
<a name="l01564"></a>01564             g_queue_push_tail (task-&gt;<a class="code" href="struct__TransferTask.html#a1617756a21ea8da9bbb6795347df9b9f">block_ids</a>, g_strdup(block_id));
<a name="l01565"></a>01565         <span class="keywordflow">else</span>
<a name="l01566"></a>01566             ++bl-&gt;<a class="code" href="structBlockList.html#a76325e5df08ad225178eb403f8812a69">n_valid_blocks</a>;
<a name="l01567"></a>01567     }
<a name="l01568"></a>01568 }
<a name="l01569"></a>01569 
<a name="l01570"></a>01570 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01571"></a>01571 start_block_download (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l01572"></a>01572 {
<a name="l01573"></a>01573     check_block_ids_for_download (task);
<a name="l01574"></a>01574 
<a name="l01575"></a>01575     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a9baa45e64248034aa15eed4f2a57ff70">block_list</a>-&gt;<a class="code" href="structBlockList.html#a2ca09d61d434980fabd07ad6668ced3a">n_blocks</a> == task-&gt;<a class="code" href="struct__TransferTask.html#a9baa45e64248034aa15eed4f2a57ff70">block_list</a>-&gt;<a class="code" href="structBlockList.html#a76325e5df08ad225178eb403f8812a69">n_valid_blocks</a>) {
<a name="l01576"></a>01576         seaf_debug (<span class="stringliteral">&quot;No block to download.\n&quot;</span>);
<a name="l01577"></a>01577         <span class="keywordflow">if</span> (update_local_repo (task) == 0)
<a name="l01578"></a>01578             transition_state (task, <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bcea407d72c040f282acb88e904361c217a2">TASK_STATE_FINISHED</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l01579"></a>01579     } <span class="keywordflow">else</span> {
<a name="l01580"></a>01580         get_chunk_server_address (task);
<a name="l01581"></a>01581     }
<a name="l01582"></a>01582 }
<a name="l01583"></a>01583 
<a name="l01584"></a>01584 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01585"></a>01585 on_fs_downloaded (<a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor, gboolean success, <span class="keywordtype">void</span> *data)
<a name="l01586"></a>01586 {
<a name="l01587"></a>01587     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task = data;
<a name="l01588"></a>01588 
<a name="l01589"></a>01589     <span class="comment">/* if the user stopped or canceled this task, stop processing. */</span>
<a name="l01590"></a>01590     <span class="comment">/* state #6, #10 */</span>
<a name="l01591"></a>01591     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> == <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaae36dd6c8f3e2e25e7946660ec15cf7d">TASK_STATE_CANCELED</a>) {
<a name="l01592"></a>01592         transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l01593"></a>01593         <span class="keywordflow">goto</span> out;
<a name="l01594"></a>01594     }
<a name="l01595"></a>01595 
<a name="l01596"></a>01596     <span class="keywordflow">if</span> (success) {
<a name="l01597"></a>01597         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> &lt;= 6)
<a name="l01598"></a>01598             start_load_block_list_thread (task, start_block_download);
<a name="l01599"></a>01599         <span class="keywordflow">else</span>
<a name="l01600"></a>01600             get_chunk_server_address (task);
<a name="l01601"></a>01601     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> != <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaeef2d65ee28a06d4dad01ed46ab8c213">TASK_STATE_ERROR</a>
<a name="l01602"></a>01602                &amp;&amp; task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> == <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a78a8dea2e0a27c2a1987abc1adb9a668">TASK_RT_STATE_FS</a>) {
<a name="l01603"></a>01603         transfer_task_with_proc_failure (
<a name="l01604"></a>01604             task, processor, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a7bdbb0c8d5d78d3cecfee69539afaabc">TASK_ERR_DOWNLOAD_FS</a>);
<a name="l01605"></a>01605     }
<a name="l01606"></a>01606 
<a name="l01607"></a>01607 out:
<a name="l01608"></a>01608     g_signal_handlers_disconnect_by_func (processor, on_fs_downloaded, data);
<a name="l01609"></a>01609 }
<a name="l01610"></a>01610 
<a name="l01611"></a>01611 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01612"></a>01612 start_fs_download (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task, <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id)
<a name="l01613"></a>01613 {
<a name="l01614"></a>01614     <span class="keywordtype">int</span> ret;
<a name="l01615"></a>01615     <a class="code" href="structObjectList.html">ObjectList</a> *ol;
<a name="l01616"></a>01616 
<a name="l01617"></a>01617     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> == 1) {
<a name="l01618"></a>01618         ol = <a class="code" href="object-list_8c.html#a30e746b909bc0e0c344cc7e35fbb36a9">object_list_new</a> ();
<a name="l01619"></a>01619         ret = <a class="code" href="commit-mgr_8c.html#ac6547d5546781608b39446d9a2077fed">seaf_commit_manager_traverse_commit_tree</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l01620"></a>01620                                                         task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>,
<a name="l01621"></a>01621                                                         task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>,
<a name="l01622"></a>01622                                                         task-&gt;<a class="code" href="struct__TransferTask.html#a1c9929f6b7f819e950b3738e676d82db">head</a>,
<a name="l01623"></a>01623                                                         fs_root_collector,
<a name="l01624"></a>01624                                                         ol, FALSE);
<a name="l01625"></a>01625         <span class="keywordflow">if</span> (ret == FALSE) {
<a name="l01626"></a>01626             <a class="code" href="object-list_8c.html#ab21e5da0e11d8eb8aab75f46f924b100">object_list_free</a> (ol);
<a name="l01627"></a>01627             <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a62a7c6fbff2cfbef157cb8385f8b5f56">TASK_ERR_LOAD_FS</a>);
<a name="l01628"></a>01628             <span class="keywordflow">return</span>;
<a name="l01629"></a>01629         }
<a name="l01630"></a>01630         task-&gt;<a class="code" href="struct__TransferTask.html#adfb9ac7568777e286b4b61bb263a11eb">fs_roots</a> = ol;
<a name="l01631"></a>01631     }
<a name="l01632"></a>01632 
<a name="l01633"></a>01633     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> &lt;= 6 &amp;&amp;
<a name="l01634"></a>01634         object_list_length(task-&gt;<a class="code" href="struct__TransferTask.html#adfb9ac7568777e286b4b61bb263a11eb">fs_roots</a>) == 0) {
<a name="l01635"></a>01635         <span class="keywordflow">if</span> (update_local_repo (task) == 0)
<a name="l01636"></a>01636             transition_state (task, <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bcea407d72c040f282acb88e904361c217a2">TASK_STATE_FINISHED</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l01637"></a>01637         <span class="keywordflow">return</span>;
<a name="l01638"></a>01638     }
<a name="l01639"></a>01639 
<a name="l01640"></a>01640     <span class="keywordflow">if</span> (start_getfs_proc (task, peer_id, (GCallback)on_fs_downloaded) &lt; 0)
<a name="l01641"></a>01641         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7aa54b10a15d5b52bb7fb90591954499ca">TASK_ERR_DOWNLOAD_FS_START</a>);
<a name="l01642"></a>01642     <span class="keywordflow">else</span>
<a name="l01643"></a>01643         transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a78a8dea2e0a27c2a1987abc1adb9a668">TASK_RT_STATE_FS</a>);
<a name="l01644"></a>01644 }
<a name="l01645"></a>01645 
<a name="l01646"></a>01646 <span class="keyword">static</span> <span class="keywordtype">int</span> start_download (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task);
<a name="l01647"></a>01647 <span class="keyword">static</span> <span class="keywordtype">int</span> start_commit_download (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task);
<a name="l01648"></a>01648 
<a name="l01649"></a>01649 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01650"></a>01650 on_commit_downloaded (<a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor, gboolean success, <span class="keywordtype">void</span> *data)
<a name="l01651"></a>01651 {
<a name="l01652"></a>01652     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task = data;
<a name="l01653"></a>01653 
<a name="l01654"></a>01654     <span class="comment">/* if the user stopped or canceled this task, stop processing. */</span>
<a name="l01655"></a>01655     <span class="comment">/* state #5, #9 */</span>
<a name="l01656"></a>01656     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> == <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaae36dd6c8f3e2e25e7946660ec15cf7d">TASK_STATE_CANCELED</a>) {
<a name="l01657"></a>01657         transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l01658"></a>01658         <span class="keywordflow">goto</span> out;
<a name="l01659"></a>01659     }
<a name="l01660"></a>01660 
<a name="l01661"></a>01661     <span class="keywordflow">if</span> (success) {
<a name="l01662"></a>01662         start_fs_download (task, processor-&gt;<a class="code" href="struct__CcnetProcessor.html#ab9b1e96d5681f0880e23e66400effa50">peer_id</a>);
<a name="l01663"></a>01663     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> != <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaeef2d65ee28a06d4dad01ed46ab8c213">TASK_STATE_ERROR</a>
<a name="l01664"></a>01664                &amp;&amp; task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> == <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a6e85ffea848b0c583a0ce776393ff7e0">TASK_RT_STATE_COMMIT</a>) {
<a name="l01665"></a>01665         <span class="comment">/* The task state will be transfered to error                  */</span>
<a name="l01666"></a>01666         <span class="comment">/* if a error occurred in getcommit-proc, otherwise, it means  */</span>
<a name="l01667"></a>01667         <span class="comment">/* the processor is shutdown and the reason is recorded in     */</span>
<a name="l01668"></a>01668         <span class="comment">/* processor-&gt;failure.     */</span>
<a name="l01669"></a>01669         transfer_task_with_proc_failure (
<a name="l01670"></a>01670             task, processor, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7af385c2ddd50c7fc6102129e98aacf703">TASK_ERR_DOWNLOAD_COMMIT</a>);
<a name="l01671"></a>01671     }
<a name="l01672"></a>01672 
<a name="l01673"></a>01673 out:
<a name="l01674"></a>01674     g_signal_handlers_disconnect_by_func (processor, on_commit_downloaded, data);
<a name="l01675"></a>01675 }
<a name="l01676"></a>01676 
<a name="l01677"></a>01677 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01678"></a>01678 start_commit_download (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l01679"></a>01679 {
<a name="l01680"></a>01680     <span class="keyword">const</span> <span class="keywordtype">char</span> *dest_id = task-&gt;<a class="code" href="struct__TransferTask.html#acca26edf8ec374118bbd917e93765f52">dest_id</a>;
<a name="l01681"></a>01681 
<a name="l01682"></a>01682     task-&gt;<a class="code" href="struct__TransferTask.html#a42affb9eda2633dd1783d28bfa7a18d9">rsize</a> = -1;
<a name="l01683"></a>01683     task-&gt;<a class="code" href="struct__TransferTask.html#a296a35b5be74665d5cb456259ba35fac">dsize</a> = 0;
<a name="l01684"></a>01684 
<a name="l01685"></a>01685     <span class="comment">/* Also get the head id of the destination branch and store at task-&gt;head. */</span>
<a name="l01686"></a>01686     <span class="keywordflow">if</span> (start_getcommit_proc (task, dest_id, (GCallback)on_commit_downloaded) &lt; 0) {
<a name="l01687"></a>01687         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7ada4e962bf084ab400be7b90fbf42ced0">TASK_ERR_DOWNLOAD_COMMIT_START</a>);
<a name="l01688"></a>01688         <span class="keywordflow">return</span> -1;
<a name="l01689"></a>01689     }
<a name="l01690"></a>01690     transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a6e85ffea848b0c583a0ce776393ff7e0">TASK_RT_STATE_COMMIT</a>);
<a name="l01691"></a>01691 
<a name="l01692"></a>01692     <span class="keywordflow">return</span> 0;
<a name="l01693"></a>01693 }
<a name="l01694"></a>01694 
<a name="l01695"></a>01695 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01696"></a>01696 check_download_cb (<a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor, gboolean success, <span class="keywordtype">void</span> *data)
<a name="l01697"></a>01697 {
<a name="l01698"></a>01698     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task = data;
<a name="l01699"></a>01699 
<a name="l01700"></a>01700     <span class="comment">/* if the user stopped or canceled this task, stop processing. */</span>
<a name="l01701"></a>01701     <span class="comment">/* state #5, #9 */</span>
<a name="l01702"></a>01702     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> == <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaae36dd6c8f3e2e25e7946660ec15cf7d">TASK_STATE_CANCELED</a>) {
<a name="l01703"></a>01703         transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l01704"></a>01704         <span class="keywordflow">goto</span> out;
<a name="l01705"></a>01705     }
<a name="l01706"></a>01706 
<a name="l01707"></a>01707     <span class="keywordflow">if</span> (success) {
<a name="l01708"></a>01708         start_commit_download (task);
<a name="l01709"></a>01709     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> != <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaeef2d65ee28a06d4dad01ed46ab8c213">TASK_STATE_ERROR</a>
<a name="l01710"></a>01710                &amp;&amp; task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> == <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a05b753592e88d5139ac1c856015f535f">TASK_RT_STATE_CHECK</a>) {
<a name="l01711"></a>01711         transfer_task_with_proc_failure (
<a name="l01712"></a>01712             task, processor, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a695e3c94d11a9b25abe454d5ef029283">TASK_ERR_UNKNOWN</a>);
<a name="l01713"></a>01713     }
<a name="l01714"></a>01714 
<a name="l01715"></a>01715     <span class="comment">/* Errors have been processed in the processor. */</span>
<a name="l01716"></a>01716 
<a name="l01717"></a>01717 out:
<a name="l01718"></a>01718     g_signal_handlers_disconnect_by_func (processor, check_download_cb, data);
<a name="l01719"></a>01719 }
<a name="l01720"></a>01720 
<a name="l01721"></a>01721 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01722"></a>01722 start_download (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l01723"></a>01723 {
<a name="l01724"></a>01724     <span class="keyword">const</span> <span class="keywordtype">char</span> *dest_id = task-&gt;<a class="code" href="struct__TransferTask.html#acca26edf8ec374118bbd917e93765f52">dest_id</a>;
<a name="l01725"></a>01725     <a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor;
<a name="l01726"></a>01726 
<a name="l01727"></a>01727     <span class="keywordflow">if</span> (!dest_id)
<a name="l01728"></a>01728         <span class="keywordflow">return</span> -1;
<a name="l01729"></a>01729 
<a name="l01730"></a>01730     <span class="keywordflow">if</span> (!<a class="code" href="ccnet_8h.html#aaf2e8f3b63d6ad9fb1012b23d4e242b0">ccnet_peer_is_ready</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#add541d96cca483ad72ff56ad061d1d32">ccnetrpc_client</a>, dest_id))
<a name="l01731"></a>01731         <span class="keywordflow">return</span> -1;
<a name="l01732"></a>01732 
<a name="l01733"></a>01733     processor = <a class="code" href="include_2ccnet_2proc-factory_8h.html#a4e77de8f2768695e93845129041759c7">ccnet_proc_factory_create_remote_master_processor</a> (
<a name="l01734"></a>01734         <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>, <span class="stringliteral">&quot;seafile-check-tx-v3&quot;</span>, dest_id);
<a name="l01735"></a>01735     <span class="keywordflow">if</span> (!processor) {
<a name="l01736"></a>01736         seaf_warning (<span class="stringliteral">&quot;failed to create check-tx proc for download.\n&quot;</span>);
<a name="l01737"></a>01737         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7ab08f1c1f4f2e519f7c8b513cf981cfc7">TASK_ERR_CHECK_DOWNLOAD_START</a>);
<a name="l01738"></a>01738         <span class="keywordflow">return</span> -1;
<a name="l01739"></a>01739     }
<a name="l01740"></a>01740 
<a name="l01741"></a>01741     g_signal_connect (processor, <span class="stringliteral">&quot;done&quot;</span>, (GCallback)check_download_cb, task);
<a name="l01742"></a>01742 
<a name="l01743"></a>01743     ((<a class="code" href="struct__SeafileCheckTxV3Proc.html">SeafileCheckTxV3Proc</a> *)processor)-&gt;task = task;
<a name="l01744"></a>01744     <span class="keywordflow">if</span> (<a class="code" href="include_2ccnet_2processor_8h.html#ae2bb4b51c8e7dd43366b777ca9b00cf6">ccnet_processor_startl</a> (processor, <span class="stringliteral">&quot;download&quot;</span>, NULL) &lt; 0) {
<a name="l01745"></a>01745         seaf_warning (<span class="stringliteral">&quot;failed to start check-tx proc for download.\n&quot;</span>);
<a name="l01746"></a>01746         <span class="keywordflow">return</span> -1;
<a name="l01747"></a>01747     }
<a name="l01748"></a>01748 
<a name="l01749"></a>01749     transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a05b753592e88d5139ac1c856015f535f">TASK_RT_STATE_CHECK</a>);
<a name="l01750"></a>01750     <span class="keywordflow">return</span> 0;
<a name="l01751"></a>01751 }
<a name="l01752"></a>01752 
<a name="l01753"></a>01753 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01754"></a>01754 update_local_repo (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l01755"></a>01755 {
<a name="l01756"></a>01756     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l01757"></a>01757     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *new_head;
<a name="l01758"></a>01758     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch;
<a name="l01759"></a>01759     <span class="keywordtype">int</span> ret = 0;
<a name="l01760"></a>01760 
<a name="l01761"></a>01761     new_head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l01762"></a>01762                                                task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>,
<a name="l01763"></a>01763                                                task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>,
<a name="l01764"></a>01764                                                task-&gt;<a class="code" href="struct__TransferTask.html#a1c9929f6b7f819e950b3738e676d82db">head</a>);
<a name="l01765"></a>01765     <span class="keywordflow">if</span> (!new_head) {
<a name="l01766"></a>01766         seaf_warning (<span class="stringliteral">&quot;Failed to get commit %s.\n&quot;</span>, task-&gt;<a class="code" href="struct__TransferTask.html#a1c9929f6b7f819e950b3738e676d82db">head</a>);
<a name="l01767"></a>01767         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a695e3c94d11a9b25abe454d5ef029283">TASK_ERR_UNKNOWN</a>);
<a name="l01768"></a>01768         <span class="keywordflow">return</span> -1;
<a name="l01769"></a>01769     }
<a name="l01770"></a>01770 
<a name="l01771"></a>01771     <span class="comment">/* If repo doesn&#39;t exist, create it.</span>
<a name="l01772"></a>01772 <span class="comment">     * Note that branch doesn&#39;t exist either in this case.</span>
<a name="l01773"></a>01773 <span class="comment">     */</span>
<a name="l01774"></a>01774     repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, new_head-&gt;<a class="code" href="struct__SeafCommit.html#af9c51057516029191941d47985df7f5f">repo_id</a>);
<a name="l01775"></a>01775     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a4462883da6780feae2b41060e5b48456">is_clone</a>) {
<a name="l01776"></a>01776         <span class="keywordflow">if</span> (repo != NULL)
<a name="l01777"></a>01777             <span class="keywordflow">goto</span> out;
<a name="l01778"></a>01778 
<a name="l01779"></a>01779         repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a63ab9fe4694e3d967376c911cbe2c655">seaf_repo_new</a> (new_head-&gt;<a class="code" href="struct__SeafCommit.html#af9c51057516029191941d47985df7f5f">repo_id</a>, NULL, NULL);
<a name="l01780"></a>01780         <span class="keywordflow">if</span> (repo == NULL) {
<a name="l01781"></a>01781             <span class="comment">/* create repo failed */</span>
<a name="l01782"></a>01782             <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a695e3c94d11a9b25abe454d5ef029283">TASK_ERR_UNKNOWN</a>);
<a name="l01783"></a>01783             ret = -1;
<a name="l01784"></a>01784             <span class="keywordflow">goto</span> out;
<a name="l01785"></a>01785         }
<a name="l01786"></a>01786 
<a name="l01787"></a>01787         <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a9c8ead9892374c87ece888d76e810197">seaf_repo_from_commit</a> (repo, new_head);
<a name="l01788"></a>01788 
<a name="l01789"></a>01789         <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a140616a89d5a02935665f86cf3bb744c">seaf_repo_manager_add_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo);
<a name="l01790"></a>01790 
<a name="l01791"></a>01791         <span class="comment">/* If it&#39;s a new repo, create &#39;local&#39; and &#39;master&#39; branch */</span>
<a name="l01792"></a>01792         branch = <a class="code" href="branch-mgr_8c.html#a4d213520d8a22d5191051715ccbfd1dd">seaf_branch_new</a> (<span class="stringliteral">&quot;local&quot;</span>, task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, task-&gt;<a class="code" href="struct__TransferTask.html#a1c9929f6b7f819e950b3738e676d82db">head</a>);
<a name="l01793"></a>01793         <a class="code" href="branch-mgr_8c.html#ab67819118ec82d96e51f6c2cadd7a632">seaf_branch_manager_add_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, branch);
<a name="l01794"></a>01794         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l01795"></a>01795 
<a name="l01796"></a>01796         branch = <a class="code" href="branch-mgr_8c.html#a4d213520d8a22d5191051715ccbfd1dd">seaf_branch_new</a> (<span class="stringliteral">&quot;master&quot;</span>, task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, task-&gt;<a class="code" href="struct__TransferTask.html#a1c9929f6b7f819e950b3738e676d82db">head</a>);
<a name="l01797"></a>01797         <a class="code" href="branch-mgr_8c.html#ab67819118ec82d96e51f6c2cadd7a632">seaf_branch_manager_add_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, branch);
<a name="l01798"></a>01798         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l01799"></a>01799     } <span class="keywordflow">else</span> {
<a name="l01800"></a>01800         <span class="keywordflow">if</span> (!repo) {
<a name="l01801"></a>01801             <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a695e3c94d11a9b25abe454d5ef029283">TASK_ERR_UNKNOWN</a>);
<a name="l01802"></a>01802             ret = -1;
<a name="l01803"></a>01803             <span class="keywordflow">goto</span> out;
<a name="l01804"></a>01804         }
<a name="l01805"></a>01805 
<a name="l01806"></a>01806         branch = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, 
<a name="l01807"></a>01807                                                  task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>,
<a name="l01808"></a>01808                                                  <span class="stringliteral">&quot;master&quot;</span>);
<a name="l01809"></a>01809         <span class="keywordflow">if</span> (!branch) {
<a name="l01810"></a>01810             seaf_warning (<span class="stringliteral">&quot;Branch master not found for repo %.8s.\n&quot;</span>, task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>);
<a name="l01811"></a>01811             <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a695e3c94d11a9b25abe454d5ef029283">TASK_ERR_UNKNOWN</a>);
<a name="l01812"></a>01812             ret = -1;
<a name="l01813"></a>01813             <span class="keywordflow">goto</span> out;
<a name="l01814"></a>01814         }
<a name="l01815"></a>01815         <a class="code" href="branch-mgr_8c.html#a7a776ebd084d2335050c68d9a2e10c18">seaf_branch_set_commit</a> (branch, new_head-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>);
<a name="l01816"></a>01816         <a class="code" href="branch-mgr_8c.html#aab1588f5228eaf4405efb239a9ed5680">seaf_branch_manager_update_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, branch);
<a name="l01817"></a>01817         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l01818"></a>01818 
<a name="l01819"></a>01819         <span class="comment">/* Update repo head branch. */</span>
<a name="l01820"></a>01820         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> &gt;= 7) {
<a name="l01821"></a>01821             <a class="code" href="branch-mgr_8c.html#a7a776ebd084d2335050c68d9a2e10c18">seaf_branch_set_commit</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>, new_head-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>);
<a name="l01822"></a>01822             <a class="code" href="branch-mgr_8c.html#aab1588f5228eaf4405efb239a9ed5680">seaf_branch_manager_update_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>);
<a name="l01823"></a>01823         }
<a name="l01824"></a>01824     }
<a name="l01825"></a>01825 
<a name="l01826"></a>01826 out:
<a name="l01827"></a>01827     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (new_head);
<a name="l01828"></a>01828     <span class="keywordflow">return</span> ret;
<a name="l01829"></a>01829 }
<a name="l01830"></a>01830 
<a name="l01831"></a>01831 
<a name="l01832"></a>01832 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01833"></a>01833 schedule_download_task (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l01834"></a>01834 {
<a name="l01835"></a>01835     <span class="comment">/* This can happen when:</span>
<a name="l01836"></a>01836 <span class="comment">     * 1. A repo was deleted, but we&#39;re also syncing that repo;</span>
<a name="l01837"></a>01837 <span class="comment">     * 2. So we just mark the repo as deleted.</span>
<a name="l01838"></a>01838 <span class="comment">     * 3. Before the repo is actually deleted, the user clones</span>
<a name="l01839"></a>01839 <span class="comment">     *    the same repo.</span>
<a name="l01840"></a>01840 <span class="comment">     */</span>
<a name="l01841"></a>01841     <a class="code" href="struct__SyncInfo.html">SyncInfo</a> *s_info = <a class="code" href="sync-mgr_8c.html#afb758dbde64ac4505ad259f95601d45e">seaf_sync_manager_get_sync_info</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a6b2a5e1e723955885f9fb27c5f064df4">sync_mgr</a>,
<a name="l01842"></a>01842                                                         task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>);
<a name="l01843"></a>01843     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a4462883da6780feae2b41060e5b48456">is_clone</a> &amp;&amp; s_info != NULL &amp;&amp; s_info-&gt;<a class="code" href="struct__SyncInfo.html#ad0f77a2b8e799b3a0abc417fce88843a">in_sync</a>)
<a name="l01844"></a>01844         <span class="keywordflow">return</span>;
<a name="l01845"></a>01845 
<a name="l01846"></a>01846     <span class="keywordflow">switch</span> (task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a>) {
<a name="l01847"></a>01847     <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a27c8f8580beaf1e17a371eacafb2a305">TASK_RT_STATE_INIT</a>:
<a name="l01848"></a>01848         start_download (task);
<a name="l01849"></a>01849         <span class="keywordflow">break</span>;
<a name="l01850"></a>01850     <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a6a546bd2f8de1f5a74956a45d58aba24">TASK_RT_STATE_DATA</a>:
<a name="l01851"></a>01851         <span class="keywordflow">break</span>;
<a name="l01852"></a>01852     <span class="keywordflow">default</span>:
<a name="l01853"></a>01853         <span class="keywordflow">break</span>;
<a name="l01854"></a>01854     }
<a name="l01855"></a>01855 }
<a name="l01856"></a>01856 
<a name="l01857"></a>01857 <span class="comment">/* -------- upload -------- */</span>
<a name="l01858"></a>01858 
<a name="l01859"></a>01859 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01860"></a>01860 start_sendfs_proc (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task, <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id, GCallback done_cb)
<a name="l01861"></a>01861 {
<a name="l01862"></a>01862     <a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor;
<a name="l01863"></a>01863 
<a name="l01864"></a>01864     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> &lt;= 6)
<a name="l01865"></a>01865         processor = <a class="code" href="include_2ccnet_2proc-factory_8h.html#a4e77de8f2768695e93845129041759c7">ccnet_proc_factory_create_remote_master_processor</a> (
<a name="l01866"></a>01866             <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>, <span class="stringliteral">&quot;seafile-sendfs&quot;</span>, peer_id);
<a name="l01867"></a>01867     <span class="keywordflow">else</span>
<a name="l01868"></a>01868         processor = <a class="code" href="include_2ccnet_2proc-factory_8h.html#a4e77de8f2768695e93845129041759c7">ccnet_proc_factory_create_remote_master_processor</a> (
<a name="l01869"></a>01869             <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>, <span class="stringliteral">&quot;seafile-sendfs-v2&quot;</span>, peer_id);
<a name="l01870"></a>01870     <span class="keywordflow">if</span> (!processor) {
<a name="l01871"></a>01871         seaf_warning (<span class="stringliteral">&quot;failed to create sendfs proc.\n&quot;</span>);
<a name="l01872"></a>01872         <span class="keywordflow">return</span> -1;
<a name="l01873"></a>01873     }
<a name="l01874"></a>01874 
<a name="l01875"></a>01875     ((<a class="code" href="struct__SeafileSendfsProc.html">SeafileSendfsProc</a> *)processor)-&gt;tx_task = task;
<a name="l01876"></a>01876     g_signal_connect (processor, <span class="stringliteral">&quot;done&quot;</span>, done_cb, task);
<a name="l01877"></a>01877 
<a name="l01878"></a>01878     <span class="keywordflow">if</span> (<a class="code" href="include_2ccnet_2processor_8h.html#ae2bb4b51c8e7dd43366b777ca9b00cf6">ccnet_processor_startl</a> (processor, NULL) &lt; 0) {
<a name="l01879"></a>01879         seaf_warning (<span class="stringliteral">&quot;failed to start sendfs proc.\n&quot;</span>);
<a name="l01880"></a>01880         <span class="keywordflow">return</span> -1;
<a name="l01881"></a>01881     }
<a name="l01882"></a>01882 
<a name="l01883"></a>01883     <span class="keywordflow">return</span> 0;
<a name="l01884"></a>01884 }
<a name="l01885"></a>01885 
<a name="l01886"></a>01886 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01887"></a>01887 start_sendcommit_proc (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task, <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id, GCallback done_cb)
<a name="l01888"></a>01888 {
<a name="l01889"></a>01889     <a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor;
<a name="l01890"></a>01890 
<a name="l01891"></a>01891     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> &lt;= 5)
<a name="l01892"></a>01892         processor = <a class="code" href="include_2ccnet_2proc-factory_8h.html#a4e77de8f2768695e93845129041759c7">ccnet_proc_factory_create_remote_master_processor</a> (
<a name="l01893"></a>01893                     <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>, <span class="stringliteral">&quot;seafile-sendcommit-v3&quot;</span>, peer_id);
<a name="l01894"></a>01894     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> == 6)
<a name="l01895"></a>01895         processor = <a class="code" href="include_2ccnet_2proc-factory_8h.html#a4e77de8f2768695e93845129041759c7">ccnet_proc_factory_create_remote_master_processor</a> (
<a name="l01896"></a>01896                     <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>, <span class="stringliteral">&quot;seafile-sendcommit-v3-new&quot;</span>, peer_id);
<a name="l01897"></a>01897     <span class="keywordflow">else</span>
<a name="l01898"></a>01898         processor = <a class="code" href="include_2ccnet_2proc-factory_8h.html#a4e77de8f2768695e93845129041759c7">ccnet_proc_factory_create_remote_master_processor</a> (
<a name="l01899"></a>01899                     <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>, <span class="stringliteral">&quot;seafile-sendcommit-v4&quot;</span>, peer_id);
<a name="l01900"></a>01900     <span class="keywordflow">if</span> (!processor) {
<a name="l01901"></a>01901         seaf_warning (<span class="stringliteral">&quot;failed to create sendcommit proc.\n&quot;</span>);
<a name="l01902"></a>01902         <span class="keywordflow">return</span> -1;
<a name="l01903"></a>01903     }
<a name="l01904"></a>01904 
<a name="l01905"></a>01905     ((<a class="code" href="struct__SeafileSendcommitV3Proc.html">SeafileSendcommitV3Proc</a> *)processor)-&gt;tx_task = task;
<a name="l01906"></a>01906     g_signal_connect (processor, <span class="stringliteral">&quot;done&quot;</span>, done_cb, task);
<a name="l01907"></a>01907 
<a name="l01908"></a>01908     <span class="keywordflow">if</span> (<a class="code" href="include_2ccnet_2processor_8h.html#ae2bb4b51c8e7dd43366b777ca9b00cf6">ccnet_processor_startl</a> (processor, NULL) &lt; 0) {
<a name="l01909"></a>01909         seaf_warning (<span class="stringliteral">&quot;failed to start sendcommit proc.\n&quot;</span>);
<a name="l01910"></a>01910         <span class="keywordflow">return</span> -1;
<a name="l01911"></a>01911     }
<a name="l01912"></a>01912 
<a name="l01913"></a>01913     <span class="keywordflow">return</span> 0;
<a name="l01914"></a>01914 }
<a name="l01915"></a>01915 
<a name="l01916"></a>01916 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01917"></a>01917 update_branch_cb (<a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor, gboolean success, <span class="keywordtype">void</span> *data)
<a name="l01918"></a>01918 {
<a name="l01919"></a>01919     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task = data;
<a name="l01920"></a>01920 
<a name="l01921"></a>01921     <span class="keywordflow">if</span> (success) {
<a name="l01922"></a>01922         transition_state (task, <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bcea407d72c040f282acb88e904361c217a2">TASK_STATE_FINISHED</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l01923"></a>01923 
<a name="l01924"></a>01924         <span class="comment">/* update local master branch in our usage model */</span>
<a name="l01925"></a>01925         <span class="keywordflow">if</span> (strcmp(task-&gt;<a class="code" href="struct__TransferTask.html#a216de4014eaaa57a569f87ba597084fb">from_branch</a>, <span class="stringliteral">&quot;local&quot;</span>) == 0 &amp;&amp;
<a name="l01926"></a>01926             strcmp(task-&gt;<a class="code" href="struct__TransferTask.html#a23b10e76331142cf8309bac0fc8ffd6f">to_branch</a>, <span class="stringliteral">&quot;master&quot;</span>) == 0)
<a name="l01927"></a>01927         {
<a name="l01928"></a>01928             <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch;
<a name="l01929"></a>01929             branch = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>,
<a name="l01930"></a>01930                                                      task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>,
<a name="l01931"></a>01931                                                      <span class="stringliteral">&quot;master&quot;</span>);
<a name="l01932"></a>01932             <span class="keywordflow">if</span> (!branch) {
<a name="l01933"></a>01933                 branch = <a class="code" href="branch-mgr_8c.html#a4d213520d8a22d5191051715ccbfd1dd">seaf_branch_new</a> (<span class="stringliteral">&quot;master&quot;</span>, task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, task-&gt;<a class="code" href="struct__TransferTask.html#a1c9929f6b7f819e950b3738e676d82db">head</a>);
<a name="l01934"></a>01934                 <a class="code" href="branch-mgr_8c.html#ab67819118ec82d96e51f6c2cadd7a632">seaf_branch_manager_add_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, branch);
<a name="l01935"></a>01935                 <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l01936"></a>01936             } <span class="keywordflow">else</span> {
<a name="l01937"></a>01937                 <a class="code" href="branch-mgr_8c.html#a7a776ebd084d2335050c68d9a2e10c18">seaf_branch_set_commit</a> (branch, task-&gt;<a class="code" href="struct__TransferTask.html#a1c9929f6b7f819e950b3738e676d82db">head</a>);
<a name="l01938"></a>01938                 <a class="code" href="branch-mgr_8c.html#aab1588f5228eaf4405efb239a9ed5680">seaf_branch_manager_update_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, branch);
<a name="l01939"></a>01939                 <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l01940"></a>01940             }
<a name="l01941"></a>01941         }
<a name="l01942"></a>01942     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> != <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaeef2d65ee28a06d4dad01ed46ab8c213">TASK_STATE_ERROR</a>
<a name="l01943"></a>01943                &amp;&amp; task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> == <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a60653bda4f2d243e01dcf3afaeff7577">TASK_RT_STATE_UPDATE_BRANCH</a>) {
<a name="l01944"></a>01944         transfer_task_with_proc_failure (
<a name="l01945"></a>01945             task, processor, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a695e3c94d11a9b25abe454d5ef029283">TASK_ERR_UNKNOWN</a>);
<a name="l01946"></a>01946     }
<a name="l01947"></a>01947     <span class="comment">/* Errors have been processed in the processor. */</span>
<a name="l01948"></a>01948 }
<a name="l01949"></a>01949 
<a name="l01950"></a>01950 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01951"></a>01951 update_remote_branch (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l01952"></a>01952 {
<a name="l01953"></a>01953     <a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor;
<a name="l01954"></a>01954 
<a name="l01955"></a>01955     processor = <a class="code" href="include_2ccnet_2proc-factory_8h.html#a4e77de8f2768695e93845129041759c7">ccnet_proc_factory_create_remote_master_processor</a> (
<a name="l01956"></a>01956         <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>, <span class="stringliteral">&quot;seafile-sendbranch&quot;</span>, task-&gt;<a class="code" href="struct__TransferTask.html#acca26edf8ec374118bbd917e93765f52">dest_id</a>);
<a name="l01957"></a>01957     <span class="keywordflow">if</span> (!processor) {
<a name="l01958"></a>01958         seaf_warning (<span class="stringliteral">&quot;failed to create sendbranch proc.\n&quot;</span>);
<a name="l01959"></a>01959         <span class="keywordflow">goto</span> fail;
<a name="l01960"></a>01960     }
<a name="l01961"></a>01961 
<a name="l01962"></a>01962     g_signal_connect (processor, <span class="stringliteral">&quot;done&quot;</span>, (GCallback)update_branch_cb, task);
<a name="l01963"></a>01963 
<a name="l01964"></a>01964     ((<a class="code" href="struct__SeafileSendbranchProc.html">SeafileSendbranchProc</a> *)processor)-&gt;task = task;
<a name="l01965"></a>01965     <span class="keywordflow">if</span> (<a class="code" href="include_2ccnet_2processor_8h.html#ae2bb4b51c8e7dd43366b777ca9b00cf6">ccnet_processor_startl</a> (processor, task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, 
<a name="l01966"></a>01966                                 task-&gt;<a class="code" href="struct__TransferTask.html#a23b10e76331142cf8309bac0fc8ffd6f">to_branch</a>, task-&gt;<a class="code" href="struct__TransferTask.html#a1c9929f6b7f819e950b3738e676d82db">head</a>, NULL) &lt; 0)
<a name="l01967"></a>01967     {
<a name="l01968"></a>01968         seaf_warning (<span class="stringliteral">&quot;failed to start sendbranch proc.\n&quot;</span>);
<a name="l01969"></a>01969         <span class="keywordflow">goto</span> fail;
<a name="l01970"></a>01970     }
<a name="l01971"></a>01971 
<a name="l01972"></a>01972     transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a60653bda4f2d243e01dcf3afaeff7577">TASK_RT_STATE_UPDATE_BRANCH</a>);
<a name="l01973"></a>01973     <span class="keywordflow">return</span> 0;
<a name="l01974"></a>01974 
<a name="l01975"></a>01975 fail:
<a name="l01976"></a>01976     <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a99af3c2467b906959940698edff79253">TASK_ERR_START_UPDATE_BRANCH</a>);
<a name="l01977"></a>01977     <span class="keywordflow">return</span> -1;
<a name="l01978"></a>01978 }
<a name="l01979"></a>01979 
<a name="l01980"></a>01980 
<a name="l01981"></a>01981 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01982"></a>01982 on_checkbl_done (<a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor, gboolean success, <span class="keywordtype">void</span> *data)
<a name="l01983"></a>01983 {
<a name="l01984"></a>01984     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task = data;
<a name="l01985"></a>01985 
<a name="l01986"></a>01986     <span class="comment">/* if the user stopped or canceled this task, stop processing. */</span>
<a name="l01987"></a>01987     <span class="comment">/* state #6, #10 */</span>
<a name="l01988"></a>01988     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> == <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaae36dd6c8f3e2e25e7946660ec15cf7d">TASK_STATE_CANCELED</a>) {
<a name="l01989"></a>01989         transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l01990"></a>01990         <span class="keywordflow">goto</span> out;
<a name="l01991"></a>01991     }
<a name="l01992"></a>01992 
<a name="l01993"></a>01993     <span class="keywordflow">if</span> (success) {
<a name="l01994"></a>01994         <span class="keywordflow">if</span> (g_queue_get_length (task-&gt;<a class="code" href="struct__TransferTask.html#a1617756a21ea8da9bbb6795347df9b9f">block_ids</a>) == 0) {
<a name="l01995"></a>01995             seaf_debug (<span class="stringliteral">&quot;All blocks are on server already.\n&quot;</span>);
<a name="l01996"></a>01996             update_remote_branch (task);
<a name="l01997"></a>01997             <span class="keywordflow">goto</span> out;
<a name="l01998"></a>01998         }
<a name="l01999"></a>01999 
<a name="l02000"></a>02000         get_chunk_server_address (task);
<a name="l02001"></a>02001     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> != <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaeef2d65ee28a06d4dad01ed46ab8c213">TASK_STATE_ERROR</a>) {
<a name="l02002"></a>02002         transfer_task_with_proc_failure (
<a name="l02003"></a>02003             task, processor, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a137b41b7c16e8d3b02246f013f5d4aeb">TASK_ERR_CHECK_BLOCK_LIST</a>);
<a name="l02004"></a>02004     }
<a name="l02005"></a>02005 
<a name="l02006"></a>02006 out:
<a name="l02007"></a>02007     g_signal_handlers_disconnect_by_func (processor, on_checkbl_done, data);
<a name="l02008"></a>02008 }
<a name="l02009"></a>02009 
<a name="l02010"></a>02010 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02011"></a>02011 start_check_block_list_proc (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l02012"></a>02012 {
<a name="l02013"></a>02013     <a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor;
<a name="l02014"></a>02014 
<a name="l02015"></a>02015     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1617756a21ea8da9bbb6795347df9b9f">block_ids</a>) {
<a name="l02016"></a>02016         g_queue_foreach (task-&gt;<a class="code" href="struct__TransferTask.html#a1617756a21ea8da9bbb6795347df9b9f">block_ids</a>, free_block_id, NULL);
<a name="l02017"></a>02017         g_queue_free (task-&gt;<a class="code" href="struct__TransferTask.html#a1617756a21ea8da9bbb6795347df9b9f">block_ids</a>);
<a name="l02018"></a>02018     }
<a name="l02019"></a>02019     task-&gt;<a class="code" href="struct__TransferTask.html#a1617756a21ea8da9bbb6795347df9b9f">block_ids</a> = g_queue_new ();
<a name="l02020"></a>02020 
<a name="l02021"></a>02021     processor = <a class="code" href="include_2ccnet_2proc-factory_8h.html#a4e77de8f2768695e93845129041759c7">ccnet_proc_factory_create_remote_master_processor</a> (
<a name="l02022"></a>02022                 <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>, <span class="stringliteral">&quot;seafile-checkbl&quot;</span>, task-&gt;<a class="code" href="struct__TransferTask.html#acca26edf8ec374118bbd917e93765f52">dest_id</a>);
<a name="l02023"></a>02023     ((<a class="code" href="struct__SeafileCheckblProc.html">SeafileCheckblProc</a> *)processor)-&gt;task = task;
<a name="l02024"></a>02024     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> &lt; 6)
<a name="l02025"></a>02025         ((<a class="code" href="struct__SeafileCheckblProc.html">SeafileCheckblProc</a> *)processor)-&gt;send_session_token = FALSE;
<a name="l02026"></a>02026     <span class="keywordflow">else</span>
<a name="l02027"></a>02027         ((<a class="code" href="struct__SeafileCheckblProc.html">SeafileCheckblProc</a> *)processor)-&gt;send_session_token = TRUE;
<a name="l02028"></a>02028     g_signal_connect (processor, <span class="stringliteral">&quot;done&quot;</span>, (GCallback)on_checkbl_done, task);
<a name="l02029"></a>02029 
<a name="l02030"></a>02030     <span class="keywordflow">if</span> (<a class="code" href="include_2ccnet_2processor_8h.html#ae2bb4b51c8e7dd43366b777ca9b00cf6">ccnet_processor_startl</a> (processor, NULL) &lt; 0) {
<a name="l02031"></a>02031         seaf_warning (<span class="stringliteral">&quot;failed to start checkbl proc.\n&quot;</span>);
<a name="l02032"></a>02032         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a137b41b7c16e8d3b02246f013f5d4aeb">TASK_ERR_CHECK_BLOCK_LIST</a>);
<a name="l02033"></a>02033     }
<a name="l02034"></a>02034 
<a name="l02035"></a>02035     transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a0235b59b5a2d068884a3fceffab7af2e">TASK_RT_STATE_CHECK_BLOCKS</a>);
<a name="l02036"></a>02036 }
<a name="l02037"></a>02037 
<a name="l02038"></a>02038 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02039"></a>02039 start_block_upload (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l02040"></a>02040 {
<a name="l02041"></a>02041 <span class="preprocessor">#if 0</span>
<a name="l02042"></a>02042 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a9baa45e64248034aa15eed4f2a57ff70">block_list</a>-&gt;<a class="code" href="structBlockList.html#a76325e5df08ad225178eb403f8812a69">n_valid_blocks</a> != task-&gt;<a class="code" href="struct__TransferTask.html#a9baa45e64248034aa15eed4f2a57ff70">block_list</a>-&gt;<a class="code" href="structBlockList.html#a2ca09d61d434980fabd07ad6668ced3a">n_blocks</a>) {
<a name="l02043"></a>02043         seaf_warning (<span class="stringliteral">&quot;Some blocks are missing locally, stop upload.\n&quot;</span>);
<a name="l02044"></a>02044         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a5e5c8de63772392c4d1d7601eb247f4a">TASK_ERR_LOAD_BLOCK_LIST</a>); 
<a name="l02045"></a>02045         <span class="keywordflow">return</span>;
<a name="l02046"></a>02046     }
<a name="l02047"></a>02047 <span class="preprocessor">#endif</span>
<a name="l02048"></a>02048 <span class="preprocessor"></span>
<a name="l02049"></a>02049     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a9baa45e64248034aa15eed4f2a57ff70">block_list</a>-&gt;<a class="code" href="structBlockList.html#a2ca09d61d434980fabd07ad6668ced3a">n_blocks</a> == 0) {
<a name="l02050"></a>02050         seaf_debug (<span class="stringliteral">&quot;No block to upload.\n&quot;</span>);
<a name="l02051"></a>02051         update_remote_branch (task);
<a name="l02052"></a>02052     } <span class="keywordflow">else</span>
<a name="l02053"></a>02053         start_check_block_list_proc (task);
<a name="l02054"></a>02054 }
<a name="l02055"></a>02055 
<a name="l02056"></a>02056 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02057"></a>02057 on_fs_uploaded (<a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor, gboolean success, <span class="keywordtype">void</span> *data)
<a name="l02058"></a>02058 {
<a name="l02059"></a>02059     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task = data;
<a name="l02060"></a>02060 
<a name="l02061"></a>02061     <span class="comment">/* if the user stopped or canceled this task, stop processing. */</span>
<a name="l02062"></a>02062     <span class="comment">/* state #6, #10 */</span>
<a name="l02063"></a>02063     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> == <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaae36dd6c8f3e2e25e7946660ec15cf7d">TASK_STATE_CANCELED</a>) {
<a name="l02064"></a>02064         transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l02065"></a>02065         <span class="keywordflow">goto</span> out;
<a name="l02066"></a>02066     }
<a name="l02067"></a>02067 
<a name="l02068"></a>02068     <span class="keywordflow">if</span> (success) {
<a name="l02069"></a>02069         start_load_block_list_thread (task, start_block_upload);
<a name="l02070"></a>02070     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> != <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaeef2d65ee28a06d4dad01ed46ab8c213">TASK_STATE_ERROR</a>
<a name="l02071"></a>02071                &amp;&amp; task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> == <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a78a8dea2e0a27c2a1987abc1adb9a668">TASK_RT_STATE_FS</a>) {
<a name="l02072"></a>02072         transfer_task_with_proc_failure (
<a name="l02073"></a>02073             task, processor, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a133569f240f1d7f7f3f11c1d5f4d7e78">TASK_ERR_UPLOAD_FS</a>);
<a name="l02074"></a>02074     }
<a name="l02075"></a>02075 
<a name="l02076"></a>02076 out:
<a name="l02077"></a>02077     g_signal_handlers_disconnect_by_func (processor, on_fs_uploaded, data);
<a name="l02078"></a>02078 }
<a name="l02079"></a>02079 
<a name="l02080"></a>02080 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02081"></a>02081 start_fs_upload (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task, <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id)
<a name="l02082"></a>02082 {
<a name="l02083"></a>02083     <span class="keywordtype">int</span> ret;
<a name="l02084"></a>02084     <a class="code" href="structObjectList.html">ObjectList</a> *ol;
<a name="l02085"></a>02085 
<a name="l02086"></a>02086     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> == 1) {
<a name="l02087"></a>02087         ol = <a class="code" href="object-list_8c.html#a30e746b909bc0e0c344cc7e35fbb36a9">object_list_new</a> ();
<a name="l02088"></a>02088         ret = <a class="code" href="commit-mgr_8c.html#ac6547d5546781608b39446d9a2077fed">seaf_commit_manager_traverse_commit_tree</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l02089"></a>02089                                                         task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>,
<a name="l02090"></a>02090                                                         task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>,
<a name="l02091"></a>02091                                                         task-&gt;<a class="code" href="struct__TransferTask.html#a1c9929f6b7f819e950b3738e676d82db">head</a>,
<a name="l02092"></a>02092                                                         fs_root_collector,
<a name="l02093"></a>02093                                                         ol, FALSE);
<a name="l02094"></a>02094         <span class="keywordflow">if</span> (ret == FALSE) {
<a name="l02095"></a>02095             <a class="code" href="object-list_8c.html#ab21e5da0e11d8eb8aab75f46f924b100">object_list_free</a> (ol);
<a name="l02096"></a>02096             <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a62a7c6fbff2cfbef157cb8385f8b5f56">TASK_ERR_LOAD_FS</a>);
<a name="l02097"></a>02097             <span class="keywordflow">return</span>;
<a name="l02098"></a>02098         }
<a name="l02099"></a>02099         task-&gt;<a class="code" href="struct__TransferTask.html#adfb9ac7568777e286b4b61bb263a11eb">fs_roots</a> = ol;
<a name="l02100"></a>02100     }
<a name="l02101"></a>02101 
<a name="l02102"></a>02102     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a70203e978b76c28101f866f86794b182">protocol_version</a> &lt;= 6 &amp;&amp;
<a name="l02103"></a>02103         object_list_length(task-&gt;<a class="code" href="struct__TransferTask.html#adfb9ac7568777e286b4b61bb263a11eb">fs_roots</a>) == 0) {
<a name="l02104"></a>02104         update_remote_branch (task);
<a name="l02105"></a>02105         <span class="keywordflow">return</span>;
<a name="l02106"></a>02106     }
<a name="l02107"></a>02107 
<a name="l02108"></a>02108     <span class="keywordflow">if</span> (start_sendfs_proc (task, peer_id, (GCallback)on_fs_uploaded) &lt; 0)
<a name="l02109"></a>02109         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7aeccd2886a80370d0a49c6d0d26dd47f9">TASK_ERR_UPLOAD_FS_START</a>);
<a name="l02110"></a>02110     <span class="keywordflow">else</span>
<a name="l02111"></a>02111         transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a78a8dea2e0a27c2a1987abc1adb9a668">TASK_RT_STATE_FS</a>);
<a name="l02112"></a>02112 }
<a name="l02113"></a>02113 
<a name="l02114"></a>02114 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02115"></a>02115 on_commit_uploaded (<a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor, gboolean success, <span class="keywordtype">void</span> *data)
<a name="l02116"></a>02116 {
<a name="l02117"></a>02117     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task = data;
<a name="l02118"></a>02118 
<a name="l02119"></a>02119     <span class="comment">/* if the user stopped or canceled this task, stop processing. */</span>
<a name="l02120"></a>02120     <span class="comment">/* state #5, #9 */</span>
<a name="l02121"></a>02121     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> == <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaae36dd6c8f3e2e25e7946660ec15cf7d">TASK_STATE_CANCELED</a>) {
<a name="l02122"></a>02122         transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l02123"></a>02123         <span class="keywordflow">goto</span> out;
<a name="l02124"></a>02124     }
<a name="l02125"></a>02125 
<a name="l02126"></a>02126     <span class="keywordflow">if</span> (success) {
<a name="l02127"></a>02127         start_fs_upload (task, processor-&gt;<a class="code" href="struct__CcnetProcessor.html#ab9b1e96d5681f0880e23e66400effa50">peer_id</a>);
<a name="l02128"></a>02128     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> != <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaeef2d65ee28a06d4dad01ed46ab8c213">TASK_STATE_ERROR</a>
<a name="l02129"></a>02129                &amp;&amp; task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> == <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a6e85ffea848b0c583a0ce776393ff7e0">TASK_RT_STATE_COMMIT</a>) {
<a name="l02130"></a>02130         transfer_task_with_proc_failure (
<a name="l02131"></a>02131             task, processor, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a97608a00fedc7335e3aa39c840200b57">TASK_ERR_UPLOAD_COMMIT</a>);
<a name="l02132"></a>02132     }
<a name="l02133"></a>02133 
<a name="l02134"></a>02134 out:
<a name="l02135"></a>02135     g_signal_handlers_disconnect_by_func (processor, on_commit_uploaded, data);
<a name="l02136"></a>02136 }
<a name="l02137"></a>02137 
<a name="l02138"></a>02138 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02139"></a>02139 start_commit_upload (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l02140"></a>02140 {
<a name="l02141"></a>02141     task-&gt;<a class="code" href="struct__TransferTask.html#a42affb9eda2633dd1783d28bfa7a18d9">rsize</a> = -1;
<a name="l02142"></a>02142     task-&gt;<a class="code" href="struct__TransferTask.html#a296a35b5be74665d5cb456259ba35fac">dsize</a> = 0;
<a name="l02143"></a>02143 
<a name="l02144"></a>02144     <span class="keywordflow">if</span> (start_sendcommit_proc (task, task-&gt;<a class="code" href="struct__TransferTask.html#acca26edf8ec374118bbd917e93765f52">dest_id</a>, (GCallback)on_commit_uploaded) &lt; 0) {
<a name="l02145"></a>02145         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7afeba17c50d25d1568b2fce57edfec359">TASK_ERR_UPLOAD_COMMIT_START</a>);
<a name="l02146"></a>02146         <span class="keywordflow">return</span> -1;
<a name="l02147"></a>02147     }
<a name="l02148"></a>02148     transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a6e85ffea848b0c583a0ce776393ff7e0">TASK_RT_STATE_COMMIT</a>);
<a name="l02149"></a>02149 
<a name="l02150"></a>02150     <span class="keywordflow">return</span> 0;
<a name="l02151"></a>02151 }
<a name="l02152"></a>02152 
<a name="l02153"></a>02153 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02154"></a>02154 check_upload_cb (<a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor, gboolean success, <span class="keywordtype">void</span> *data)
<a name="l02155"></a>02155 {
<a name="l02156"></a>02156     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task = data;
<a name="l02157"></a>02157 
<a name="l02158"></a>02158     <span class="comment">/* if the user stopped or canceled this task, stop processing. */</span>
<a name="l02159"></a>02159     <span class="comment">/* state #5, #9 */</span>
<a name="l02160"></a>02160     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> == <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaae36dd6c8f3e2e25e7946660ec15cf7d">TASK_STATE_CANCELED</a>) {
<a name="l02161"></a>02161         transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l02162"></a>02162         <span class="keywordflow">goto</span> out;
<a name="l02163"></a>02163     }
<a name="l02164"></a>02164 
<a name="l02165"></a>02165     <span class="keywordflow">if</span> (success) {
<a name="l02166"></a>02166         start_commit_upload (task);
<a name="l02167"></a>02167     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> != <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaeef2d65ee28a06d4dad01ed46ab8c213">TASK_STATE_ERROR</a>
<a name="l02168"></a>02168                &amp;&amp; task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> == <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a05b753592e88d5139ac1c856015f535f">TASK_RT_STATE_CHECK</a>) {
<a name="l02169"></a>02169         transfer_task_with_proc_failure (
<a name="l02170"></a>02170             task, processor, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a695e3c94d11a9b25abe454d5ef029283">TASK_ERR_UNKNOWN</a>);
<a name="l02171"></a>02171     }
<a name="l02172"></a>02172     <span class="comment">/* Errors have been processed in the processor. */</span>
<a name="l02173"></a>02173 
<a name="l02174"></a>02174 out:
<a name="l02175"></a>02175     g_signal_handlers_disconnect_by_func (processor, check_upload_cb, data);
<a name="l02176"></a>02176 }
<a name="l02177"></a>02177 
<a name="l02178"></a>02178 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02179"></a>02179 start_upload (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l02180"></a>02180 {
<a name="l02181"></a>02181     <span class="keyword">const</span> <span class="keywordtype">char</span> *dest_id = task-&gt;<a class="code" href="struct__TransferTask.html#acca26edf8ec374118bbd917e93765f52">dest_id</a>;
<a name="l02182"></a>02182     <a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor;
<a name="l02183"></a>02183     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch;
<a name="l02184"></a>02184 
<a name="l02185"></a>02185     <span class="keywordflow">if</span> (!dest_id)
<a name="l02186"></a>02186         <span class="keywordflow">return</span> -1;
<a name="l02187"></a>02187 
<a name="l02188"></a>02188     <span class="keywordflow">if</span> (!<a class="code" href="ccnet_8h.html#aaf2e8f3b63d6ad9fb1012b23d4e242b0">ccnet_peer_is_ready</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#add541d96cca483ad72ff56ad061d1d32">ccnetrpc_client</a>, dest_id))
<a name="l02189"></a>02189         <span class="keywordflow">return</span> -1;
<a name="l02190"></a>02190 
<a name="l02191"></a>02191     branch = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, 
<a name="l02192"></a>02192                                              task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, 
<a name="l02193"></a>02193                                              task-&gt;<a class="code" href="struct__TransferTask.html#a216de4014eaaa57a569f87ba597084fb">from_branch</a>);
<a name="l02194"></a>02194     <span class="keywordflow">if</span> (!branch) {
<a name="l02195"></a>02195         seaf_warning (<span class="stringliteral">&quot;[Upload] Bad source branch %s.\n&quot;</span>, task-&gt;<a class="code" href="struct__TransferTask.html#a216de4014eaaa57a569f87ba597084fb">from_branch</a>);
<a name="l02196"></a>02196         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a447ef6afe603b87b69a0b89baea44b3f">TASK_ERR_BAD_LOCAL_BRANCH</a>);
<a name="l02197"></a>02197         <span class="keywordflow">return</span> -1;
<a name="l02198"></a>02198     }
<a name="l02199"></a>02199     memcpy (task-&gt;<a class="code" href="struct__TransferTask.html#a1c9929f6b7f819e950b3738e676d82db">head</a>, branch-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>, 41);
<a name="l02200"></a>02200     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l02201"></a>02201 
<a name="l02202"></a>02202     processor = <a class="code" href="include_2ccnet_2proc-factory_8h.html#a4e77de8f2768695e93845129041759c7">ccnet_proc_factory_create_remote_master_processor</a> (
<a name="l02203"></a>02203         <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>, <span class="stringliteral">&quot;seafile-check-tx-v3&quot;</span>, dest_id);
<a name="l02204"></a>02204     <span class="keywordflow">if</span> (!processor) {
<a name="l02205"></a>02205         seaf_warning (<span class="stringliteral">&quot;failed to create check-tx-v3 proc for upload.\n&quot;</span>);
<a name="l02206"></a>02206         <a class="code" href="transfer-mgr_8c.html#af268f694f35d04d51f38ab6bcb2b4d86">transition_state_to_error</a> (task, <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a92c58e1bbbd522643b51e3d66f0444df">TASK_ERR_CHECK_UPLOAD_START</a>);
<a name="l02207"></a>02207         <span class="keywordflow">return</span> -1;
<a name="l02208"></a>02208     }
<a name="l02209"></a>02209 
<a name="l02210"></a>02210     g_signal_connect (processor, <span class="stringliteral">&quot;done&quot;</span>, (GCallback)check_upload_cb, task);
<a name="l02211"></a>02211 
<a name="l02212"></a>02212     ((<a class="code" href="struct__SeafileCheckTxV3Proc.html">SeafileCheckTxV3Proc</a> *)processor)-&gt;task = task;
<a name="l02213"></a>02213     <span class="keywordflow">if</span> (<a class="code" href="include_2ccnet_2processor_8h.html#ae2bb4b51c8e7dd43366b777ca9b00cf6">ccnet_processor_startl</a> (processor, <span class="stringliteral">&quot;upload&quot;</span>, NULL) &lt; 0)
<a name="l02214"></a>02214     {
<a name="l02215"></a>02215         seaf_warning (<span class="stringliteral">&quot;failed to start check-tx-v3 proc for upload.\n&quot;</span>);
<a name="l02216"></a>02216         <span class="keywordflow">return</span> -1;
<a name="l02217"></a>02217     }
<a name="l02218"></a>02218 
<a name="l02219"></a>02219     transition_state (task, task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a05b753592e88d5139ac1c856015f535f">TASK_RT_STATE_CHECK</a>);
<a name="l02220"></a>02220     <span class="keywordflow">return</span> 0;
<a name="l02221"></a>02221 }
<a name="l02222"></a>02222 
<a name="l02223"></a>02223 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02224"></a>02224 schedule_upload_task (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l02225"></a>02225 {
<a name="l02226"></a>02226     <span class="keywordflow">switch</span> (task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a>) {
<a name="l02227"></a>02227     <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a27c8f8580beaf1e17a371eacafb2a305">TASK_RT_STATE_INIT</a>:
<a name="l02228"></a>02228         start_upload (task);
<a name="l02229"></a>02229         <span class="keywordflow">break</span>;
<a name="l02230"></a>02230     <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a6a546bd2f8de1f5a74956a45d58aba24">TASK_RT_STATE_DATA</a>:
<a name="l02231"></a>02231         <span class="keywordflow">break</span>;
<a name="l02232"></a>02232     <span class="keywordflow">default</span>:
<a name="l02233"></a>02233         <span class="keywordflow">break</span>;
<a name="l02234"></a>02234     }
<a name="l02235"></a>02235 }
<a name="l02236"></a>02236 
<a name="l02237"></a>02237 
<a name="l02238"></a>02238 <span class="comment">/* -------- schedule -------- */</span>
<a name="l02239"></a>02239 
<a name="l02240"></a>02240 <span class="keyword">static</span> <span class="keywordtype">void</span> resume_task_from_netdown(<a class="code" href="struct__TransferTask.html">TransferTask</a> *task, <span class="keyword">const</span> <span class="keywordtype">char</span> *dest_id)
<a name="l02241"></a>02241 {
<a name="l02242"></a>02242     <span class="keywordflow">if</span> (!task || !dest_id)
<a name="l02243"></a>02243         <span class="keywordflow">return</span>;
<a name="l02244"></a>02244 
<a name="l02245"></a>02245     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> == <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300abee3bb533aa834941c0ef1820a0aeec7">TASK_RT_STATE_NETDOWN</a>) {
<a name="l02246"></a>02246         <span class="keywordflow">switch</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a13bb5199500880d4c519fc1ac53312c7">last_runtime_state</a>) {
<a name="l02247"></a>02247         <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a05b753592e88d5139ac1c856015f535f">TASK_RT_STATE_CHECK</a>:
<a name="l02248"></a>02248             <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a5cb264f2074f78b92ac005633f412c24">type</a> == <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa68841d8280724b9623db3dea4a78dde5">TASK_TYPE_DOWNLOAD</a>)
<a name="l02249"></a>02249                 start_download(task);
<a name="l02250"></a>02250             <span class="keywordflow">else</span>
<a name="l02251"></a>02251                 start_upload(task);
<a name="l02252"></a>02252             <span class="keywordflow">break</span>;
<a name="l02253"></a>02253         <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a6e85ffea848b0c583a0ce776393ff7e0">TASK_RT_STATE_COMMIT</a>:
<a name="l02254"></a>02254             <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a5cb264f2074f78b92ac005633f412c24">type</a> == <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa68841d8280724b9623db3dea4a78dde5">TASK_TYPE_DOWNLOAD</a>)
<a name="l02255"></a>02255                 start_commit_download(task);
<a name="l02256"></a>02256             <span class="keywordflow">else</span>
<a name="l02257"></a>02257                 start_commit_upload(task);
<a name="l02258"></a>02258             <span class="keywordflow">break</span>;
<a name="l02259"></a>02259         <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a78a8dea2e0a27c2a1987abc1adb9a668">TASK_RT_STATE_FS</a>:
<a name="l02260"></a>02260             <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a5cb264f2074f78b92ac005633f412c24">type</a> == <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa68841d8280724b9623db3dea4a78dde5">TASK_TYPE_DOWNLOAD</a>)
<a name="l02261"></a>02261                 start_fs_download(task, dest_id);
<a name="l02262"></a>02262             <span class="keywordflow">else</span>
<a name="l02263"></a>02263                 start_fs_upload(task, dest_id);
<a name="l02264"></a>02264             <span class="keywordflow">break</span>;
<a name="l02265"></a>02265         <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a0235b59b5a2d068884a3fceffab7af2e">TASK_RT_STATE_CHECK_BLOCKS</a>:
<a name="l02266"></a>02266             g_return_if_fail (task-&gt;<a class="code" href="struct__TransferTask.html#a5cb264f2074f78b92ac005633f412c24">type</a> == <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa800672fa26f828e725e4f6efe3dd7a67">TASK_TYPE_UPLOAD</a>);
<a name="l02267"></a>02267             start_check_block_list_proc (task);
<a name="l02268"></a>02268             <span class="keywordflow">break</span>;
<a name="l02269"></a>02269         <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a5e9d30b571a028283a4c3cb9c880377a">TASK_RT_STATE_CHUNK_SERVER</a>:
<a name="l02270"></a>02270             get_chunk_server_address (task);
<a name="l02271"></a>02271             <span class="keywordflow">break</span>;
<a name="l02272"></a>02272         <span class="keywordflow">default</span>:
<a name="l02273"></a>02273             break ;
<a name="l02274"></a>02274         }
<a name="l02275"></a>02275     }
<a name="l02276"></a>02276 }
<a name="l02277"></a>02277 
<a name="l02278"></a>02278 
<a name="l02279"></a>02279 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02280"></a>02280 state_machine_tick (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task)
<a name="l02281"></a>02281 {
<a name="l02282"></a>02282     <span class="keywordflow">switch</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a>) {
<a name="l02283"></a>02283     <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceac3efc29c1793f3f902e002589c600b33">TASK_STATE_NORMAL</a>:
<a name="l02284"></a>02284         <span class="comment">/* If repo was deleted, cancel any transfer task for it.</span>
<a name="l02285"></a>02285 <span class="comment">         * Also note that the repo doesn&#39;t exist if we&#39;re cloning it.</span>
<a name="l02286"></a>02286 <span class="comment">         */</span>
<a name="l02287"></a>02287         <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__TransferTask.html#a4462883da6780feae2b41060e5b48456">is_clone</a> &amp;&amp;
<a name="l02288"></a>02288             !<a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a4b2497e6cdde50c4ce3cb642370e06eb">seaf_repo_manager_repo_exists</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>)) {
<a name="l02289"></a>02289             cancel_task (task);
<a name="l02290"></a>02290             <span class="keywordflow">break</span>;
<a name="l02291"></a>02291         }
<a name="l02292"></a>02292 
<a name="l02293"></a>02293         <span class="comment">/* state #1, #2, #3, #4 */</span>
<a name="l02294"></a>02294         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> == <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300abee3bb533aa834941c0ef1820a0aeec7">TASK_RT_STATE_NETDOWN</a>) {
<a name="l02295"></a>02295             <span class="keyword">const</span> <span class="keywordtype">char</span> *dest_id = task-&gt;<a class="code" href="struct__TransferTask.html#acca26edf8ec374118bbd917e93765f52">dest_id</a>;
<a name="l02296"></a>02296             <span class="keywordflow">if</span> (dest_id &amp;&amp; <a class="code" href="ccnet_8h.html#aaf2e8f3b63d6ad9fb1012b23d4e242b0">ccnet_peer_is_ready</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#add541d96cca483ad72ff56ad061d1d32">ccnetrpc_client</a>, dest_id))
<a name="l02297"></a>02297             {
<a name="l02298"></a>02298                 seaf_debug (<span class="stringliteral">&quot;[tr-mgr] Resume transfer repo %.8s when &quot;</span>
<a name="l02299"></a>02299                             <span class="stringliteral">&quot;peer %.10s is reconnected\n&quot;</span>,
<a name="l02300"></a>02300                             task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>, dest_id);
<a name="l02301"></a>02301                 g_return_if_fail (task-&gt;<a class="code" href="struct__TransferTask.html#a13bb5199500880d4c519fc1ac53312c7">last_runtime_state</a> != <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300abee3bb533aa834941c0ef1820a0aeec7">TASK_RT_STATE_NETDOWN</a>
<a name="l02302"></a>02302                           &amp;&amp; task-&gt;<a class="code" href="struct__TransferTask.html#a13bb5199500880d4c519fc1ac53312c7">last_runtime_state</a> != <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l02303"></a>02303                 resume_task_from_netdown(task, dest_id);
<a name="l02304"></a>02304             }
<a name="l02305"></a>02305         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> != <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>) {
<a name="l02306"></a>02306             <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a5cb264f2074f78b92ac005633f412c24">type</a> == <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa68841d8280724b9623db3dea4a78dde5">TASK_TYPE_DOWNLOAD</a>)
<a name="l02307"></a>02307                 schedule_download_task (task);
<a name="l02308"></a>02308             <span class="keywordflow">else</span>
<a name="l02309"></a>02309                 schedule_upload_task (task);
<a name="l02310"></a>02310         } <span class="keywordflow">else</span> {
<a name="l02311"></a>02311             <span class="comment">/* normal &amp;&amp; finish, can&#39;t happen */</span>
<a name="l02312"></a>02312             g_return_if_reached ();
<a name="l02313"></a>02313         }
<a name="l02314"></a>02314         <span class="keywordflow">break</span>;
<a name="l02315"></a>02315     <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bcea407d72c040f282acb88e904361c217a2">TASK_STATE_FINISHED</a>:
<a name="l02316"></a>02316         <span class="comment">/* state #13 */</span>
<a name="l02317"></a>02317         g_return_if_fail (task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> == <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l02318"></a>02318         <span class="keywordflow">break</span>;
<a name="l02319"></a>02319     <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaae36dd6c8f3e2e25e7946660ec15cf7d">TASK_STATE_CANCELED</a>:
<a name="l02320"></a>02320         <span class="comment">/* state #11 */</span>
<a name="l02321"></a>02321         <span class="keywordflow">break</span>;
<a name="l02322"></a>02322     <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaeef2d65ee28a06d4dad01ed46ab8c213">TASK_STATE_ERROR</a>:
<a name="l02323"></a>02323         <span class="comment">/* state #14 */</span>
<a name="l02324"></a>02324         g_return_if_fail (task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> == <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l02325"></a>02325         <span class="keywordflow">break</span>;
<a name="l02326"></a>02326     <span class="keywordflow">default</span>:
<a name="l02327"></a>02327         g_return_if_reached ();
<a name="l02328"></a>02328     }
<a name="l02329"></a>02329 }
<a name="l02330"></a>02330 
<a name="l02331"></a>02331 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02332"></a>02332 schedule_task_pulse (<span class="keywordtype">void</span> *vmanager)
<a name="l02333"></a>02333 {
<a name="l02334"></a>02334     <a class="code" href="struct__SeafTransferManager.html">SeafTransferManager</a> *mgr = vmanager;
<a name="l02335"></a>02335     GHashTableIter iter;
<a name="l02336"></a>02336     gpointer key, value;
<a name="l02337"></a>02337     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task;
<a name="l02338"></a>02338 
<a name="l02339"></a>02339     g_hash_table_iter_init (&amp;iter, mgr-&gt;<a class="code" href="struct__SeafTransferManager.html#a1c7de7270fc3d95c7df34cba0959c925">download_tasks</a>);
<a name="l02340"></a>02340     <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
<a name="l02341"></a>02341         task = value;
<a name="l02342"></a>02342         state_machine_tick (task);
<a name="l02343"></a>02343     }
<a name="l02344"></a>02344 
<a name="l02345"></a>02345     g_hash_table_iter_init (&amp;iter, mgr-&gt;<a class="code" href="struct__SeafTransferManager.html#a12c3a28fb3a2802585dd1427aa83c8b5">upload_tasks</a>);
<a name="l02346"></a>02346     <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
<a name="l02347"></a>02347         task = value;
<a name="l02348"></a>02348         state_machine_tick (task);
<a name="l02349"></a>02349     }
<a name="l02350"></a>02350 
<a name="l02351"></a>02351     <span class="keywordflow">return</span> TRUE;
<a name="l02352"></a>02352 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Wed Aug 19 2015 03:19:54 for My Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
