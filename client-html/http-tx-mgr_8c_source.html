<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>My Project: seafile-4.1.2/daemon/http-tx-mgr.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">My Project
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">seafile-4.1.2/daemon/http-tx-mgr.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="http-tx-mgr_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &quot;common.h&quot;</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;curl/curl.h&gt;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;jansson.h&gt;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;event2/buffer.h&gt;</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;<a class="code" href="ccnet-client_8h.html">ccnet/ccnet-client.h</a>&gt;</span>
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 <span class="preprocessor">#include &quot;<a class="code" href="seafile-config_8h.html">seafile-config.h</a>&quot;</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="daemon_2seafile-session_8h.html">seafile-session.h</a>&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="http-tx-mgr_8h.html">http-tx-mgr.h</a>&quot;</span>
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;<a class="code" href="seafile-error_8h.html">seafile-error.h</a>&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;utils.h&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="diff-simple_8h.html">diff-simple.h</a>&quot;</span>
<a name="l00018"></a>00018 
<a name="l00019"></a><a class="code" href="http-tx-mgr_8c.html#a05d1af42442c934b555896d3fe55c79e">00019</a> <span class="preprocessor">#define DEBUG_FLAG SEAFILE_DEBUG_TRANSFER</span>
<a name="l00020"></a>00020 <span class="preprocessor"></span><span class="preprocessor">#include &quot;log.h&quot;</span>
<a name="l00021"></a>00021 
<a name="l00022"></a><a class="code" href="http-tx-mgr_8c.html#a02e6d59009dee759528ec81fc9a8eeff">00022</a> <span class="preprocessor">#define HTTP_OK 200</span>
<a name="l00023"></a><a class="code" href="http-tx-mgr_8c.html#a0c1fdbbb10800664989907cbd3a5a023">00023</a> <span class="preprocessor"></span><span class="preprocessor">#define HTTP_BAD_REQUEST 400</span>
<a name="l00024"></a><a class="code" href="http-tx-mgr_8c.html#a92646f876056a1e5013e0050496dc04d">00024</a> <span class="preprocessor"></span><span class="preprocessor">#define HTTP_FORBIDDEN 403</span>
<a name="l00025"></a><a class="code" href="http-tx-mgr_8c.html#abd505b5244bd18ae61c581484b4bc5a0">00025</a> <span class="preprocessor"></span><span class="preprocessor">#define HTTP_NOT_FOUND 404</span>
<a name="l00026"></a><a class="code" href="http-tx-mgr_8c.html#a71f74422b67ea7e609f97f035e8732ea">00026</a> <span class="preprocessor"></span><span class="preprocessor">#define HTTP_NO_QUOTA 443</span>
<a name="l00027"></a><a class="code" href="http-tx-mgr_8c.html#abf97213d568ebd9edd3597704d29f7f1">00027</a> <span class="preprocessor"></span><span class="preprocessor">#define HTTP_REPO_DELETED 444</span>
<a name="l00028"></a><a class="code" href="http-tx-mgr_8c.html#a5d9777e02c26063c2985e39ef71091d2">00028</a> <span class="preprocessor"></span><span class="preprocessor">#define HTTP_INTERNAL_SERVER_ERROR 500</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span>
<a name="l00030"></a><a class="code" href="http-tx-mgr_8c.html#ab37eef8c7539cecfc5de8723088a38d7">00030</a> <span class="preprocessor">#define RESET_BYTES_INTERVAL_MSEC 1000</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span>
<a name="l00032"></a><a class="code" href="struct__Connection.html">00032</a> <span class="keyword">struct </span><a class="code" href="struct__Connection.html">_Connection</a> {
<a name="l00033"></a><a class="code" href="struct__Connection.html#af8b983fae165a24c7f9cc24e47361d57">00033</a>     CURL *<a class="code" href="struct__Connection.html#af8b983fae165a24c7f9cc24e47361d57">curl</a>;
<a name="l00034"></a><a class="code" href="struct__Connection.html#aa7293de74b28aa0eb08dc782e46b4c98">00034</a>     gint64 <a class="code" href="struct__Connection.html#aa7293de74b28aa0eb08dc782e46b4c98">ctime</a>;               <span class="comment">/* Used to clean up unused connection. */</span>
<a name="l00035"></a>00035 };
<a name="l00036"></a><a class="code" href="http-tx-mgr_8c.html#af241e6d0ce6d580ee96096edbbda6b60">00036</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__Connection.html">_Connection</a> <a class="code" href="struct__Connection.html">Connection</a>;
<a name="l00037"></a>00037 
<a name="l00038"></a><a class="code" href="struct__ConnectionPool.html">00038</a> <span class="keyword">struct </span><a class="code" href="struct__ConnectionPool.html">_ConnectionPool</a> {
<a name="l00039"></a><a class="code" href="struct__ConnectionPool.html#a657e93fbe1662201f1340a76f4cf6e0e">00039</a>     <span class="keywordtype">char</span> *<a class="code" href="struct__ConnectionPool.html#a657e93fbe1662201f1340a76f4cf6e0e">host</a>;
<a name="l00040"></a><a class="code" href="struct__ConnectionPool.html#a1ca8137e443aa54c99dca735e3510833">00040</a>     GQueue *<a class="code" href="struct__ConnectionPool.html#a1ca8137e443aa54c99dca735e3510833">queue</a>;
<a name="l00041"></a><a class="code" href="struct__ConnectionPool.html#affcb92f3c39abef8af33205258b20a4c">00041</a>     pthread_mutex_t <a class="code" href="struct__ConnectionPool.html#affcb92f3c39abef8af33205258b20a4c">lock</a>;
<a name="l00042"></a>00042 };
<a name="l00043"></a><a class="code" href="http-tx-mgr_8c.html#ab0dd327fd8279a69af9cee0403701095">00043</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__ConnectionPool.html">_ConnectionPool</a> <a class="code" href="struct__ConnectionPool.html">ConnectionPool</a>;
<a name="l00044"></a>00044 
<a name="l00045"></a><a class="code" href="struct__HttpTxPriv.html">00045</a> <span class="keyword">struct </span><a class="code" href="struct__HttpTxPriv.html">_HttpTxPriv</a> {
<a name="l00046"></a><a class="code" href="struct__HttpTxPriv.html#a054e2539c8af97620bcc0ab412398edf">00046</a>     GHashTable *<a class="code" href="struct__HttpTxPriv.html#a054e2539c8af97620bcc0ab412398edf">download_tasks</a>;
<a name="l00047"></a><a class="code" href="struct__HttpTxPriv.html#a791e15c45420b177bfc87284015ac9db">00047</a>     GHashTable *<a class="code" href="struct__HttpTxPriv.html#a791e15c45420b177bfc87284015ac9db">upload_tasks</a>;
<a name="l00048"></a>00048 
<a name="l00049"></a><a class="code" href="struct__HttpTxPriv.html#a55f095d958fe9573451cca5af1e80b36">00049</a>     GHashTable *<a class="code" href="struct__HttpTxPriv.html#a55f095d958fe9573451cca5af1e80b36">connection_pools</a>; <span class="comment">/* host -&gt; connection pool */</span>
<a name="l00050"></a><a class="code" href="struct__HttpTxPriv.html#a2ebdb95274bdc8f807bbf479a6e382c3">00050</a>     pthread_mutex_t <a class="code" href="struct__HttpTxPriv.html#a2ebdb95274bdc8f807bbf479a6e382c3">pools_lock</a>;
<a name="l00051"></a>00051 
<a name="l00052"></a><a class="code" href="struct__HttpTxPriv.html#af018ae2712ad3a0ea19d3d22b7ea28c6">00052</a>     <a class="code" href="structCcnetTimer.html">CcnetTimer</a> *<a class="code" href="struct__HttpTxPriv.html#af018ae2712ad3a0ea19d3d22b7ea28c6">reset_bytes_timer</a>;
<a name="l00053"></a>00053 };
<a name="l00054"></a><a class="code" href="http-tx-mgr_8c.html#a42765376cd3e90c86cec3c4a32431334">00054</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__HttpTxPriv.html">_HttpTxPriv</a> <a class="code" href="struct__HttpTxPriv.html">HttpTxPriv</a>;
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="comment">/* Http Tx Task */</span>
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="keyword">static</span> <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *
<a name="l00059"></a>00059 http_tx_task_new (<a class="code" href="struct__HttpTxManager.html">HttpTxManager</a> *mgr,
<a name="l00060"></a>00060                   <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l00061"></a>00061                   <span class="keywordtype">int</span> repo_version,
<a name="l00062"></a>00062                   <span class="keywordtype">int</span> <a class="code" href="fs-mgr_8c.html#a65cfc9e13d3352fd9099a0408cba715c">type</a>,
<a name="l00063"></a>00063                   gboolean is_clone,
<a name="l00064"></a>00064                   <span class="keyword">const</span> <span class="keywordtype">char</span> *host,
<a name="l00065"></a>00065                   <span class="keyword">const</span> <span class="keywordtype">char</span> *token,
<a name="l00066"></a>00066                   <span class="keyword">const</span> <span class="keywordtype">char</span> *passwd,
<a name="l00067"></a>00067                   <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree)
<a name="l00068"></a>00068 {
<a name="l00069"></a>00069     <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task = g_new0 (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a>, 1);
<a name="l00070"></a>00070 
<a name="l00071"></a>00071     task-&gt;<a class="code" href="struct__HttpTxTask.html#aba6b45acc9ad1fc1f54805b72dbc6ec1">manager</a> = mgr;
<a name="l00072"></a>00072     memcpy (task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, repo_id, 36);
<a name="l00073"></a>00073     task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a> = repo_version;
<a name="l00074"></a>00074     task-&gt;<a class="code" href="struct__HttpTxTask.html#ad954a300aab26e22dcd2100b2c5e248a">type</a> = <a class="code" href="fs-mgr_8c.html#a65cfc9e13d3352fd9099a0408cba715c">type</a>;
<a name="l00075"></a>00075     task-&gt;<a class="code" href="struct__HttpTxTask.html#a8dc7ba305c249ab73ce9424725776d41">is_clone</a> = is_clone;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077     task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a> = g_strdup(host);
<a name="l00078"></a>00078     task-&gt;<a class="code" href="struct__HttpTxTask.html#a7efdacb9425ad03ba280b6435b0e6ba6">token</a> = g_strdup(token);
<a name="l00079"></a>00079 
<a name="l00080"></a>00080     <span class="keywordflow">if</span> (passwd)
<a name="l00081"></a>00081         task-&gt;<a class="code" href="struct__HttpTxTask.html#a1a4bf0844a0d15f8128fbaa521e649f1">passwd</a> = g_strdup(passwd);
<a name="l00082"></a>00082     <span class="keywordflow">if</span> (worktree)
<a name="l00083"></a>00083         task-&gt;<a class="code" href="struct__HttpTxTask.html#aa3f98febcc990a1b3ac304baa0f7d800">worktree</a> = g_strdup(worktree);
<a name="l00084"></a>00084 
<a name="l00085"></a>00085     <span class="keywordflow">return</span> task;
<a name="l00086"></a>00086 }
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00089"></a>00089 http_tx_task_free (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task)
<a name="l00090"></a>00090 {
<a name="l00091"></a>00091     g_free (task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>);
<a name="l00092"></a>00092     g_free (task-&gt;<a class="code" href="struct__HttpTxTask.html#a7efdacb9425ad03ba280b6435b0e6ba6">token</a>);
<a name="l00093"></a>00093     g_free (task-&gt;<a class="code" href="struct__HttpTxTask.html#a1a4bf0844a0d15f8128fbaa521e649f1">passwd</a>);
<a name="l00094"></a>00094     g_free (task-&gt;<a class="code" href="struct__HttpTxTask.html#aa3f98febcc990a1b3ac304baa0f7d800">worktree</a>);
<a name="l00095"></a>00095     g_free (task);
<a name="l00096"></a>00096 }
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *http_task_state_str[] = {
<a name="l00099"></a>00099     <span class="stringliteral">&quot;normal&quot;</span>,
<a name="l00100"></a>00100     <span class="stringliteral">&quot;canceled&quot;</span>,
<a name="l00101"></a>00101     <span class="stringliteral">&quot;finished&quot;</span>,
<a name="l00102"></a>00102     <span class="stringliteral">&quot;error&quot;</span>,
<a name="l00103"></a>00103 };
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *http_task_rt_state_str[] = {
<a name="l00106"></a>00106     <span class="stringliteral">&quot;init&quot;</span>,
<a name="l00107"></a>00107     <span class="stringliteral">&quot;check&quot;</span>,
<a name="l00108"></a>00108     <span class="stringliteral">&quot;commit&quot;</span>,
<a name="l00109"></a>00109     <span class="stringliteral">&quot;fs&quot;</span>,
<a name="l00110"></a>00110     <span class="stringliteral">&quot;data&quot;</span>,
<a name="l00111"></a>00111     <span class="stringliteral">&quot;update-branch&quot;</span>,
<a name="l00112"></a>00112     <span class="stringliteral">&quot;finished&quot;</span>,
<a name="l00113"></a>00113 };
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *http_task_error_strs[] = {
<a name="l00116"></a>00116     <span class="stringliteral">&quot;Successful&quot;</span>,
<a name="l00117"></a>00117     <span class="stringliteral">&quot;Permission denied&quot;</span>,
<a name="l00118"></a>00118     <span class="stringliteral">&quot;Network error&quot;</span>,
<a name="l00119"></a>00119     <span class="stringliteral">&quot;Server error&quot;</span>,
<a name="l00120"></a>00120     <span class="stringliteral">&quot;Bad request&quot;</span>,
<a name="l00121"></a>00121     <span class="stringliteral">&quot;Internal data corrupt on the client&quot;</span>,
<a name="l00122"></a>00122     <span class="stringliteral">&quot;Not enough memory&quot;</span>,
<a name="l00123"></a>00123     <span class="stringliteral">&quot;Failed to write data on the client&quot;</span>,
<a name="l00124"></a>00124     <span class="stringliteral">&quot;Storage quota full&quot;</span>,
<a name="l00125"></a>00125     <span class="stringliteral">&quot;Files are locked by other application&quot;</span>,
<a name="l00126"></a>00126     <span class="stringliteral">&quot;Unknown error&quot;</span>,
<a name="l00127"></a>00127 };
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 <span class="comment">/* Http connection and connection pool. */</span>
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 <span class="keyword">static</span> <a class="code" href="struct__Connection.html">Connection</a> *
<a name="l00132"></a>00132 connection_new ()
<a name="l00133"></a>00133 {
<a name="l00134"></a>00134     <a class="code" href="struct__Connection.html">Connection</a> *conn = g_new0 (<a class="code" href="struct__Connection.html">Connection</a>, 1);
<a name="l00135"></a>00135 
<a name="l00136"></a>00136     conn-&gt;<a class="code" href="struct__Connection.html#af8b983fae165a24c7f9cc24e47361d57">curl</a> = curl_easy_init();
<a name="l00137"></a>00137     conn-&gt;<a class="code" href="struct__Connection.html#aa7293de74b28aa0eb08dc782e46b4c98">ctime</a> = (gint64)time(NULL);
<a name="l00138"></a>00138 
<a name="l00139"></a>00139     <span class="keywordflow">return</span> conn;
<a name="l00140"></a>00140 }
<a name="l00141"></a>00141 
<a name="l00142"></a>00142 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00143"></a>00143 connection_free (<a class="code" href="struct__Connection.html">Connection</a> *conn)
<a name="l00144"></a>00144 {
<a name="l00145"></a>00145     curl_easy_cleanup (conn-&gt;<a class="code" href="struct__Connection.html#af8b983fae165a24c7f9cc24e47361d57">curl</a>);
<a name="l00146"></a>00146     g_free (conn);
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="keyword">static</span> <a class="code" href="struct__ConnectionPool.html">ConnectionPool</a> *
<a name="l00150"></a>00150 connection_pool_new (<span class="keyword">const</span> <span class="keywordtype">char</span> *host)
<a name="l00151"></a>00151 {
<a name="l00152"></a>00152     <a class="code" href="struct__ConnectionPool.html">ConnectionPool</a> *pool = g_new0 (<a class="code" href="struct__ConnectionPool.html">ConnectionPool</a>, 1);
<a name="l00153"></a>00153     pool-&gt;<a class="code" href="struct__ConnectionPool.html#a657e93fbe1662201f1340a76f4cf6e0e">host</a> = g_strdup(host);
<a name="l00154"></a>00154     pool-&gt;<a class="code" href="struct__ConnectionPool.html#a1ca8137e443aa54c99dca735e3510833">queue</a> = g_queue_new ();
<a name="l00155"></a>00155     pthread_mutex_init (&amp;pool-&gt;<a class="code" href="struct__ConnectionPool.html#affcb92f3c39abef8af33205258b20a4c">lock</a>, NULL);
<a name="l00156"></a>00156     <span class="keywordflow">return</span> pool;
<a name="l00157"></a>00157 }
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 <span class="keyword">static</span> <a class="code" href="struct__ConnectionPool.html">ConnectionPool</a> *
<a name="l00160"></a>00160 find_connection_pool (<a class="code" href="struct__HttpTxPriv.html">HttpTxPriv</a> *<a class="code" href="monitor-tool_8c.html#a694b59386a408403dbb70994ed5beaa1">priv</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *host)
<a name="l00161"></a>00161 {
<a name="l00162"></a>00162     <a class="code" href="struct__ConnectionPool.html">ConnectionPool</a> *pool;
<a name="l00163"></a>00163 
<a name="l00164"></a>00164     pthread_mutex_lock (&amp;priv-&gt;<a class="code" href="struct__HttpTxPriv.html#a2ebdb95274bdc8f807bbf479a6e382c3">pools_lock</a>);
<a name="l00165"></a>00165     pool = g_hash_table_lookup (priv-&gt;<a class="code" href="struct__HttpTxPriv.html#a55f095d958fe9573451cca5af1e80b36">connection_pools</a>, host);
<a name="l00166"></a>00166     <span class="keywordflow">if</span> (!pool) {
<a name="l00167"></a>00167         pool = connection_pool_new (host);
<a name="l00168"></a>00168         g_hash_table_insert (priv-&gt;<a class="code" href="struct__HttpTxPriv.html#a55f095d958fe9573451cca5af1e80b36">connection_pools</a>, g_strdup(host), pool);
<a name="l00169"></a>00169     }
<a name="l00170"></a>00170     pthread_mutex_unlock (&amp;priv-&gt;<a class="code" href="struct__HttpTxPriv.html#a2ebdb95274bdc8f807bbf479a6e382c3">pools_lock</a>);
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     <span class="keywordflow">return</span> pool;
<a name="l00173"></a>00173 }
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 <span class="keyword">static</span> <a class="code" href="struct__Connection.html">Connection</a> *
<a name="l00176"></a>00176 connection_pool_get_connection (<a class="code" href="struct__ConnectionPool.html">ConnectionPool</a> *pool)
<a name="l00177"></a>00177 {
<a name="l00178"></a>00178     <a class="code" href="struct__Connection.html">Connection</a> *conn = NULL;
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     pthread_mutex_lock (&amp;pool-&gt;<a class="code" href="struct__ConnectionPool.html#affcb92f3c39abef8af33205258b20a4c">lock</a>);
<a name="l00181"></a>00181     conn = g_queue_pop_head (pool-&gt;<a class="code" href="struct__ConnectionPool.html#a1ca8137e443aa54c99dca735e3510833">queue</a>);
<a name="l00182"></a>00182     <span class="keywordflow">if</span> (!conn) {
<a name="l00183"></a>00183         conn = connection_new ();
<a name="l00184"></a>00184     }
<a name="l00185"></a>00185     pthread_mutex_unlock (&amp;pool-&gt;<a class="code" href="struct__ConnectionPool.html#affcb92f3c39abef8af33205258b20a4c">lock</a>);
<a name="l00186"></a>00186 
<a name="l00187"></a>00187     <span class="keywordflow">return</span> conn;
<a name="l00188"></a>00188 }
<a name="l00189"></a>00189 
<a name="l00190"></a>00190 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00191"></a>00191 connection_pool_return_connection (<a class="code" href="struct__ConnectionPool.html">ConnectionPool</a> *pool, <a class="code" href="struct__Connection.html">Connection</a> *conn)
<a name="l00192"></a>00192 {
<a name="l00193"></a>00193     <span class="keywordflow">if</span> (!conn)
<a name="l00194"></a>00194         <span class="keywordflow">return</span>;
<a name="l00195"></a>00195 
<a name="l00196"></a>00196     curl_easy_reset (conn-&gt;<a class="code" href="struct__Connection.html#af8b983fae165a24c7f9cc24e47361d57">curl</a>);
<a name="l00197"></a>00197 
<a name="l00198"></a>00198     pthread_mutex_lock (&amp;pool-&gt;<a class="code" href="struct__ConnectionPool.html#affcb92f3c39abef8af33205258b20a4c">lock</a>);
<a name="l00199"></a>00199     g_queue_push_tail (pool-&gt;<a class="code" href="struct__ConnectionPool.html#a1ca8137e443aa54c99dca735e3510833">queue</a>, conn);
<a name="l00200"></a>00200     pthread_mutex_unlock (&amp;pool-&gt;<a class="code" href="struct__ConnectionPool.html#affcb92f3c39abef8af33205258b20a4c">lock</a>);
<a name="l00201"></a>00201 }
<a name="l00202"></a>00202 
<a name="l00203"></a>00203 <a class="code" href="struct__HttpTxManager.html">HttpTxManager</a> *
<a name="l00204"></a><a class="code" href="http-tx-mgr_8h.html#a77c5dd6ef56236186f97a78e089235f4">00204</a> <a class="code" href="http-tx-mgr_8c.html#a77c5dd6ef56236186f97a78e089235f4">http_tx_manager_new</a> (<span class="keyword">struct</span> <a class="code" href="struct__SeafileSession.html">_SeafileSession</a> *<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>)
<a name="l00205"></a>00205 {
<a name="l00206"></a>00206     <a class="code" href="struct__HttpTxManager.html">HttpTxManager</a> *mgr = g_new0 (<a class="code" href="struct__HttpTxManager.html">HttpTxManager</a>, 1);
<a name="l00207"></a>00207     <a class="code" href="struct__HttpTxPriv.html">HttpTxPriv</a> *priv = g_new0 (<a class="code" href="struct__HttpTxPriv.html">HttpTxPriv</a>, 1);
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     mgr-&gt;<a class="code" href="struct__HttpTxManager.html#ad5c870a6f4bb5650395080acc7bbf6fe">seaf</a> = <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>;
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     priv-&gt;<a class="code" href="struct__HttpTxPriv.html#a054e2539c8af97620bcc0ab412398edf">download_tasks</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
<a name="l00212"></a>00212                                                   g_free,
<a name="l00213"></a>00213                                                   (GDestroyNotify)http_tx_task_free);
<a name="l00214"></a>00214     priv-&gt;<a class="code" href="struct__HttpTxPriv.html#a791e15c45420b177bfc87284015ac9db">upload_tasks</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
<a name="l00215"></a>00215                                                 g_free,
<a name="l00216"></a>00216                                                 (GDestroyNotify)http_tx_task_free);
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     priv-&gt;<a class="code" href="struct__HttpTxPriv.html#a55f095d958fe9573451cca5af1e80b36">connection_pools</a> = g_hash_table_new (g_str_hash, g_str_equal);
<a name="l00219"></a>00219     pthread_mutex_init (&amp;priv-&gt;<a class="code" href="struct__HttpTxPriv.html#a2ebdb95274bdc8f807bbf479a6e382c3">pools_lock</a>, NULL);
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     mgr-&gt;<a class="code" href="struct__HttpTxManager.html#a3e124361f6d9812dd9e4fb15e7ea41e7">priv</a> = <a class="code" href="monitor-tool_8c.html#a694b59386a408403dbb70994ed5beaa1">priv</a>;
<a name="l00222"></a>00222 
<a name="l00223"></a>00223     <span class="keywordflow">return</span> mgr;
<a name="l00224"></a>00224 }
<a name="l00225"></a>00225 
<a name="l00226"></a>00226 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00227"></a>00227 reset_bytes (<span class="keywordtype">void</span> *vdata)
<a name="l00228"></a>00228 {
<a name="l00229"></a>00229     <a class="code" href="struct__HttpTxManager.html">HttpTxManager</a> *mgr = vdata;
<a name="l00230"></a>00230     <a class="code" href="struct__HttpTxPriv.html">HttpTxPriv</a> *priv = mgr-&gt;<a class="code" href="struct__HttpTxManager.html#a3e124361f6d9812dd9e4fb15e7ea41e7">priv</a>;
<a name="l00231"></a>00231     GHashTableIter iter;
<a name="l00232"></a>00232     gpointer key, value;
<a name="l00233"></a>00233     <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task;
<a name="l00234"></a>00234 
<a name="l00235"></a>00235     g_hash_table_iter_init (&amp;iter, priv-&gt;<a class="code" href="struct__HttpTxPriv.html#a054e2539c8af97620bcc0ab412398edf">download_tasks</a>);
<a name="l00236"></a>00236     <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
<a name="l00237"></a>00237         task = value;
<a name="l00238"></a>00238         task-&gt;<a class="code" href="struct__HttpTxTask.html#a651e7b5f81850c38468bbb102a18d878">last_tx_bytes</a> = g_atomic_int_get (&amp;task-&gt;<a class="code" href="struct__HttpTxTask.html#af184cfdb28c7cafac145353d84256a8b">tx_bytes</a>);
<a name="l00239"></a>00239         g_atomic_int_set (&amp;task-&gt;<a class="code" href="struct__HttpTxTask.html#af184cfdb28c7cafac145353d84256a8b">tx_bytes</a>, 0);
<a name="l00240"></a>00240     }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     g_hash_table_iter_init (&amp;iter, priv-&gt;<a class="code" href="struct__HttpTxPriv.html#a791e15c45420b177bfc87284015ac9db">upload_tasks</a>);
<a name="l00243"></a>00243     <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
<a name="l00244"></a>00244         task = value;
<a name="l00245"></a>00245         task-&gt;<a class="code" href="struct__HttpTxTask.html#a651e7b5f81850c38468bbb102a18d878">last_tx_bytes</a> = g_atomic_int_get (&amp;task-&gt;<a class="code" href="struct__HttpTxTask.html#af184cfdb28c7cafac145353d84256a8b">tx_bytes</a>);
<a name="l00246"></a>00246         g_atomic_int_set (&amp;task-&gt;<a class="code" href="struct__HttpTxTask.html#af184cfdb28c7cafac145353d84256a8b">tx_bytes</a>, 0);
<a name="l00247"></a>00247     }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249     <span class="keywordflow">return</span> 1;
<a name="l00250"></a>00250 }
<a name="l00251"></a>00251 
<a name="l00252"></a>00252 <span class="keywordtype">int</span>
<a name="l00253"></a><a class="code" href="http-tx-mgr_8h.html#af7268908c8fb9bdafab495f92ea07f86">00253</a> <a class="code" href="http-tx-mgr_8c.html#af7268908c8fb9bdafab495f92ea07f86">http_tx_manager_start</a> (<a class="code" href="struct__HttpTxManager.html">HttpTxManager</a> *mgr)
<a name="l00254"></a>00254 {
<a name="l00255"></a>00255     curl_global_init (CURL_GLOBAL_ALL);
<a name="l00256"></a>00256 
<a name="l00257"></a>00257     <span class="comment">/* TODO: add a timer to clean up unused Http connections. */</span>
<a name="l00258"></a>00258 
<a name="l00259"></a>00259     mgr-&gt;<a class="code" href="struct__HttpTxManager.html#a3e124361f6d9812dd9e4fb15e7ea41e7">priv</a>-&gt;<a class="code" href="struct__HttpTxPriv.html#af018ae2712ad3a0ea19d3d22b7ea28c6">reset_bytes_timer</a> = <a class="code" href="timer_8h.html#a68b6afb704a7f56b625ed78146691b7c">ccnet_timer_new</a> (reset_bytes,
<a name="l00260"></a>00260                                                     mgr,
<a name="l00261"></a>00261                                                     <a class="code" href="http-tx-mgr_8c.html#ab37eef8c7539cecfc5de8723088a38d7">RESET_BYTES_INTERVAL_MSEC</a>);
<a name="l00262"></a>00262 
<a name="l00263"></a>00263     <span class="keywordflow">return</span> 0;
<a name="l00264"></a>00264 }
<a name="l00265"></a>00265 
<a name="l00266"></a>00266 <span class="comment">/* Common Utility Functions. */</span>
<a name="l00267"></a>00267 
<a name="l00268"></a>00268 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00269"></a>00269 set_proxy (CURL *curl, gboolean is_https)
<a name="l00270"></a>00270 {
<a name="l00271"></a>00271     <span class="keywordflow">if</span> (!<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#af8094c4e3b2e8b393348f19ff0086e52">use_http_proxy</a> || !<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a82b4f4dfc602a5fc726c63e644e1890a">http_proxy_type</a> || !<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a90ca51d540726fb6294e03175df5eef7">http_proxy_addr</a>)
<a name="l00272"></a>00272         <span class="keywordflow">return</span>;
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <span class="keywordflow">if</span> (g_strcmp0(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a82b4f4dfc602a5fc726c63e644e1890a">http_proxy_type</a>, <a class="code" href="seafile-config_8h.html#a339fc7d5d597a38c1e16d30b981cc4c2">PROXY_TYPE_HTTP</a>) == 0) {
<a name="l00275"></a>00275         curl_easy_setopt(curl, CURLOPT_PROXYTYPE, CURLPROXY_HTTP);
<a name="l00276"></a>00276         <span class="comment">/* Use CONNECT method create a SSL tunnel if https is used. */</span>
<a name="l00277"></a>00277         <span class="keywordflow">if</span> (is_https)
<a name="l00278"></a>00278             curl_easy_setopt(curl, CURLOPT_HTTPPROXYTUNNEL, 1L);
<a name="l00279"></a>00279         curl_easy_setopt(curl, CURLOPT_PROXY, <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a90ca51d540726fb6294e03175df5eef7">http_proxy_addr</a>);
<a name="l00280"></a>00280         curl_easy_setopt(curl, CURLOPT_PROXYPORT,
<a name="l00281"></a>00281                          <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa224c2327aebda850ec69a511e9116f0">http_proxy_port</a> &gt; 0 ? <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa224c2327aebda850ec69a511e9116f0">http_proxy_port</a> : 80);
<a name="l00282"></a>00282         <span class="keywordflow">if</span> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa3bf654264aeca5da13ac0db84d84ee8">http_proxy_username</a> &amp;&amp; <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a35ea25c84aba44bf13391d46394c4964">http_proxy_password</a>) {
<a name="l00283"></a>00283             curl_easy_setopt(curl, CURLOPT_PROXYAUTH,
<a name="l00284"></a>00284                              CURLAUTH_BASIC |
<a name="l00285"></a>00285                              CURLAUTH_DIGEST |
<a name="l00286"></a>00286                              CURLAUTH_DIGEST_IE |
<a name="l00287"></a>00287                              CURLAUTH_GSSNEGOTIATE |
<a name="l00288"></a>00288                              CURLAUTH_NTLM);
<a name="l00289"></a>00289             curl_easy_setopt(curl, CURLOPT_PROXYUSERNAME, <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa3bf654264aeca5da13ac0db84d84ee8">http_proxy_username</a>);
<a name="l00290"></a>00290             curl_easy_setopt(curl, CURLOPT_PROXYPASSWORD, <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a35ea25c84aba44bf13391d46394c4964">http_proxy_password</a>);
<a name="l00291"></a>00291         }
<a name="l00292"></a>00292     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (g_strcmp0(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a82b4f4dfc602a5fc726c63e644e1890a">http_proxy_type</a>, <a class="code" href="seafile-config_8h.html#a8b3a6e1626fc6612c595919232ddf982">PROXY_TYPE_SOCKS</a>) == 0) {
<a name="l00293"></a>00293         <span class="keywordflow">if</span> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa224c2327aebda850ec69a511e9116f0">http_proxy_port</a> &lt; 0)
<a name="l00294"></a>00294             <span class="keywordflow">return</span>;
<a name="l00295"></a>00295         curl_easy_setopt(curl, CURLOPT_PROXYTYPE, CURLPROXY_SOCKS5);
<a name="l00296"></a>00296         curl_easy_setopt(curl, CURLOPT_PROXY, <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a90ca51d540726fb6294e03175df5eef7">http_proxy_addr</a>);
<a name="l00297"></a>00297         curl_easy_setopt(curl, CURLOPT_PROXYPORT, <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa224c2327aebda850ec69a511e9116f0">http_proxy_port</a>);
<a name="l00298"></a>00298     }
<a name="l00299"></a>00299 }
<a name="l00300"></a>00300 
<a name="l00301"></a><a class="code" href="struct__HttpResponse.html">00301</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__HttpResponse.html">_HttpResponse</a> {
<a name="l00302"></a><a class="code" href="struct__HttpResponse.html#a304c62b1c80c9858b76172e292263162">00302</a>     <span class="keywordtype">char</span> *<a class="code" href="struct__HttpResponse.html#a304c62b1c80c9858b76172e292263162">content</a>;
<a name="l00303"></a><a class="code" href="struct__HttpResponse.html#a68f086a14de6180ee50bebbc66cc7d70">00303</a>     <span class="keywordtype">size_t</span> <a class="code" href="struct__HttpResponse.html#a68f086a14de6180ee50bebbc66cc7d70">size</a>;
<a name="l00304"></a>00304 } <a class="code" href="http-tx-mgr_8c.html#a44d07c806661acc0907d528d7bdce04c">HttpResponse</a>;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306 <span class="keyword">static</span> <span class="keywordtype">size_t</span>
<a name="l00307"></a>00307 recv_response (<span class="keywordtype">void</span> *contents, <span class="keywordtype">size_t</span> <a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a>, <span class="keywordtype">size_t</span> nmemb, <span class="keywordtype">void</span> *userp)
<a name="l00308"></a>00308 {
<a name="l00309"></a>00309     <span class="keywordtype">size_t</span> realsize = size * nmemb;
<a name="l00310"></a>00310     <a class="code" href="struct__HttpResponse.html">HttpResponse</a> *rsp = userp;
<a name="l00311"></a>00311 
<a name="l00312"></a>00312     rsp-&gt;<a class="code" href="struct__HttpResponse.html#a304c62b1c80c9858b76172e292263162">content</a> = g_realloc (rsp-&gt;<a class="code" href="struct__HttpResponse.html#a304c62b1c80c9858b76172e292263162">content</a>, rsp-&gt;<a class="code" href="struct__HttpResponse.html#a68f086a14de6180ee50bebbc66cc7d70">size</a> + realsize);
<a name="l00313"></a>00313     <span class="keywordflow">if</span> (!rsp-&gt;<a class="code" href="struct__HttpResponse.html#a304c62b1c80c9858b76172e292263162">content</a>) {
<a name="l00314"></a>00314         seaf_warning (<span class="stringliteral">&quot;Not enough memory.\n&quot;</span>);
<a name="l00315"></a>00315         <span class="comment">/* return a value other than realsize to signify an error. */</span>
<a name="l00316"></a>00316         <span class="keywordflow">return</span> 0;
<a name="l00317"></a>00317     }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319     memcpy (rsp-&gt;<a class="code" href="struct__HttpResponse.html#a304c62b1c80c9858b76172e292263162">content</a> + rsp-&gt;<a class="code" href="struct__HttpResponse.html#a68f086a14de6180ee50bebbc66cc7d70">size</a>, contents, realsize);
<a name="l00320"></a>00320     rsp-&gt;<a class="code" href="struct__HttpResponse.html#a68f086a14de6180ee50bebbc66cc7d70">size</a> += realsize;
<a name="l00321"></a>00321 
<a name="l00322"></a>00322     <span class="keywordflow">return</span> realsize;
<a name="l00323"></a>00323 }
<a name="l00324"></a>00324 
<a name="l00325"></a><a class="code" href="http-tx-mgr_8c.html#acfc6c1ddecc516b7075c03f945c5cee9">00325</a> <span class="preprocessor">#define HTTP_TIMEOUT_SEC 45</span>
<a name="l00326"></a>00326 <span class="preprocessor"></span>
<a name="l00327"></a><a class="code" href="http-tx-mgr_8c.html#aa553e8c85e0ea84d6de8365d1561756a">00327</a> <span class="keyword">typedef</span> size_t (*<a class="code" href="http-tx-mgr_8c.html#aa553e8c85e0ea84d6de8365d1561756a">HttpRecvCallback</a>) (<span class="keywordtype">void</span> *, size_t, size_t, <span class="keywordtype">void</span> *);
<a name="l00328"></a>00328 
<a name="l00329"></a>00329 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00330"></a>00330 http_get (CURL *curl, <span class="keyword">const</span> <span class="keywordtype">char</span> *url, <span class="keyword">const</span> <span class="keywordtype">char</span> *token,
<a name="l00331"></a>00331           <span class="keywordtype">int</span> *rsp_status, <span class="keywordtype">char</span> **rsp_content, gint64 *rsp_size,
<a name="l00332"></a>00332           <a class="code" href="http-tx-mgr_8c.html#aa553e8c85e0ea84d6de8365d1561756a">HttpRecvCallback</a> callback, <span class="keywordtype">void</span> *cb_data)
<a name="l00333"></a>00333 {
<a name="l00334"></a>00334     <span class="keywordtype">char</span> *token_header;
<a name="l00335"></a>00335     <span class="keyword">struct </span>curl_slist *headers = NULL;
<a name="l00336"></a>00336     <span class="keywordtype">int</span> ret = 0;
<a name="l00337"></a>00337 
<a name="l00338"></a>00338     <span class="keywordflow">if</span> (token) {
<a name="l00339"></a>00339         token_header = g_strdup_printf (<span class="stringliteral">&quot;Seafile-Repo-Token: %s&quot;</span>, token);
<a name="l00340"></a>00340         headers = curl_slist_append (headers, token_header);
<a name="l00341"></a>00341         g_free (token_header);
<a name="l00342"></a>00342         curl_easy_setopt(curl, CURLOPT_HTTPHEADER, headers);
<a name="l00343"></a>00343     }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345     curl_easy_setopt(curl, CURLOPT_URL, url);
<a name="l00346"></a>00346     curl_easy_setopt(curl, CURLOPT_NOSIGNAL, 1L);
<a name="l00347"></a>00347 
<a name="l00348"></a>00348     <span class="comment">/* Set low speed limit to 1 bytes. This effectively means no data. */</span>
<a name="l00349"></a>00349     curl_easy_setopt(curl, CURLOPT_LOW_SPEED_LIMIT, 1);
<a name="l00350"></a>00350     curl_easy_setopt(curl, CURLOPT_LOW_SPEED_TIME, <a class="code" href="http-tx-mgr_8c.html#acfc6c1ddecc516b7075c03f945c5cee9">HTTP_TIMEOUT_SEC</a>);
<a name="l00351"></a>00351 
<a name="l00352"></a>00352     <span class="keywordflow">if</span> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a9810d1dadf63c55d4a27f077683965a5">disable_verify_certificate</a>) {
<a name="l00353"></a>00353         curl_easy_setopt (curl, CURLOPT_SSL_VERIFYPEER, 0L);
<a name="l00354"></a>00354         curl_easy_setopt (curl, CURLOPT_SSL_VERIFYHOST, 0L);
<a name="l00355"></a>00355     }
<a name="l00356"></a>00356 
<a name="l00357"></a>00357     <a class="code" href="struct__HttpResponse.html">HttpResponse</a> rsp;
<a name="l00358"></a>00358     memset (&amp;rsp, 0, <span class="keyword">sizeof</span>(rsp));
<a name="l00359"></a>00359     <span class="keywordflow">if</span> (rsp_content) {
<a name="l00360"></a>00360         curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, recv_response);
<a name="l00361"></a>00361         curl_easy_setopt(curl, CURLOPT_WRITEDATA, &amp;rsp);
<a name="l00362"></a>00362     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (callback) {
<a name="l00363"></a>00363         curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, callback);
<a name="l00364"></a>00364         curl_easy_setopt(curl, CURLOPT_WRITEDATA, cb_data);
<a name="l00365"></a>00365     }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367     gboolean is_https = (strncasecmp(url, <span class="stringliteral">&quot;https&quot;</span>, strlen(<span class="stringliteral">&quot;https&quot;</span>)) == 0);
<a name="l00368"></a>00368     set_proxy (curl, is_https);
<a name="l00369"></a>00369 
<a name="l00370"></a>00370     curl_easy_setopt(curl, CURLOPT_FOLLOWLOCATION, 1L);
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     <span class="keywordtype">int</span> rc = curl_easy_perform (curl);
<a name="l00373"></a>00373     <span class="keywordflow">if</span> (rc != 0) {
<a name="l00374"></a>00374         seaf_warning (<span class="stringliteral">&quot;libcurl failed to GET %s: %s.\n&quot;</span>,
<a name="l00375"></a>00375                       url, curl_easy_strerror(rc));
<a name="l00376"></a>00376         ret = -1;
<a name="l00377"></a>00377         <span class="keywordflow">goto</span> out;
<a name="l00378"></a>00378     }
<a name="l00379"></a>00379 
<a name="l00380"></a>00380     <span class="keywordtype">long</span> <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l00381"></a>00381     rc = curl_easy_getinfo (curl, CURLINFO_RESPONSE_CODE, &amp;status);
<a name="l00382"></a>00382     <span class="keywordflow">if</span> (rc != CURLE_OK) {
<a name="l00383"></a>00383         seaf_warning (<span class="stringliteral">&quot;Failed to get status code for GET %s.\n&quot;</span>, url);
<a name="l00384"></a>00384         ret = -1;
<a name="l00385"></a>00385         <span class="keywordflow">goto</span> out;
<a name="l00386"></a>00386     }
<a name="l00387"></a>00387 
<a name="l00388"></a>00388     *rsp_status = <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l00389"></a>00389 
<a name="l00390"></a>00390     <span class="keywordflow">if</span> (rsp_content) {
<a name="l00391"></a>00391         *rsp_content = rsp.<a class="code" href="struct__HttpResponse.html#a304c62b1c80c9858b76172e292263162">content</a>;
<a name="l00392"></a>00392         *rsp_size = rsp.<a class="code" href="struct__HttpResponse.html#a68f086a14de6180ee50bebbc66cc7d70">size</a>;
<a name="l00393"></a>00393     }
<a name="l00394"></a>00394 
<a name="l00395"></a>00395 out:
<a name="l00396"></a>00396     <span class="keywordflow">if</span> (ret &lt; 0)
<a name="l00397"></a>00397         g_free (rsp.<a class="code" href="struct__HttpResponse.html#a304c62b1c80c9858b76172e292263162">content</a>);
<a name="l00398"></a>00398     curl_slist_free_all (headers);
<a name="l00399"></a>00399     <span class="keywordflow">return</span> ret;
<a name="l00400"></a>00400 }
<a name="l00401"></a>00401 
<a name="l00402"></a><a class="code" href="struct__HttpRequest.html">00402</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__HttpRequest.html">_HttpRequest</a> {
<a name="l00403"></a><a class="code" href="struct__HttpRequest.html#ad418ba313e39eb93e1fbc72b9ffc9cb8">00403</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="struct__HttpRequest.html#ad418ba313e39eb93e1fbc72b9ffc9cb8">content</a>;
<a name="l00404"></a><a class="code" href="struct__HttpRequest.html#ab4a54ed927873962a0dabbeeea6ab80d">00404</a>     <span class="keywordtype">size_t</span> <a class="code" href="struct__HttpRequest.html#ab4a54ed927873962a0dabbeeea6ab80d">size</a>;
<a name="l00405"></a>00405 } <a class="code" href="http-tx-mgr_8c.html#ae46215715e608f9a808dc8ce335acca5">HttpRequest</a>;
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 <span class="keyword">static</span> <span class="keywordtype">size_t</span>
<a name="l00408"></a>00408 send_request (<span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> <a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a>, <span class="keywordtype">size_t</span> nmemb, <span class="keywordtype">void</span> *userp)
<a name="l00409"></a>00409 {
<a name="l00410"></a>00410     <span class="keywordtype">size_t</span> realsize = size *nmemb;
<a name="l00411"></a>00411     <span class="keywordtype">size_t</span> copy_size;
<a name="l00412"></a>00412     <a class="code" href="struct__HttpRequest.html">HttpRequest</a> *req = userp;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414     <span class="keywordflow">if</span> (req-&gt;<a class="code" href="struct__HttpRequest.html#ab4a54ed927873962a0dabbeeea6ab80d">size</a> == 0)
<a name="l00415"></a>00415         <span class="keywordflow">return</span> 0;
<a name="l00416"></a>00416 
<a name="l00417"></a>00417     copy_size = MIN(req-&gt;<a class="code" href="struct__HttpRequest.html#ab4a54ed927873962a0dabbeeea6ab80d">size</a>, realsize);
<a name="l00418"></a>00418     memcpy (ptr, req-&gt;<a class="code" href="struct__HttpRequest.html#ad418ba313e39eb93e1fbc72b9ffc9cb8">content</a>, copy_size);
<a name="l00419"></a>00419     req-&gt;<a class="code" href="struct__HttpRequest.html#ab4a54ed927873962a0dabbeeea6ab80d">size</a> -= copy_size;
<a name="l00420"></a>00420     req-&gt;<a class="code" href="struct__HttpRequest.html#ad418ba313e39eb93e1fbc72b9ffc9cb8">content</a> = req-&gt;<a class="code" href="struct__HttpRequest.html#ad418ba313e39eb93e1fbc72b9ffc9cb8">content</a> + copy_size;
<a name="l00421"></a>00421 
<a name="l00422"></a>00422     <span class="keywordflow">return</span> copy_size;
<a name="l00423"></a>00423 }
<a name="l00424"></a>00424 
<a name="l00425"></a><a class="code" href="http-tx-mgr_8c.html#a76020409d5fb99a0f728eed9102d6afb">00425</a> <span class="keyword">typedef</span> size_t (*<a class="code" href="http-tx-mgr_8c.html#a76020409d5fb99a0f728eed9102d6afb">HttpSendCallback</a>) (<span class="keywordtype">void</span> *, size_t, size_t, <span class="keywordtype">void</span> *);
<a name="l00426"></a>00426 
<a name="l00427"></a>00427 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00428"></a>00428 http_put (CURL *curl, <span class="keyword">const</span> <span class="keywordtype">char</span> *url, <span class="keyword">const</span> <span class="keywordtype">char</span> *token,
<a name="l00429"></a>00429           <span class="keyword">const</span> <span class="keywordtype">char</span> *req_content, gint64 req_size,
<a name="l00430"></a>00430           <a class="code" href="http-tx-mgr_8c.html#a76020409d5fb99a0f728eed9102d6afb">HttpSendCallback</a> callback, <span class="keywordtype">void</span> *cb_data,
<a name="l00431"></a>00431           <span class="keywordtype">int</span> *rsp_status, <span class="keywordtype">char</span> **rsp_content, gint64 *rsp_size)
<a name="l00432"></a>00432 {
<a name="l00433"></a>00433     <span class="keywordtype">char</span> *token_header;
<a name="l00434"></a>00434     <span class="keyword">struct </span>curl_slist *headers = NULL;
<a name="l00435"></a>00435     <span class="keywordtype">int</span> ret = 0;
<a name="l00436"></a>00436 
<a name="l00437"></a>00437     <span class="keywordflow">if</span> (token) {
<a name="l00438"></a>00438         token_header = g_strdup_printf (<span class="stringliteral">&quot;Seafile-Repo-Token: %s&quot;</span>, token);
<a name="l00439"></a>00439         headers = curl_slist_append (headers, token_header);
<a name="l00440"></a>00440         g_free (token_header);
<a name="l00441"></a>00441         curl_easy_setopt(curl, CURLOPT_HTTPHEADER, headers);
<a name="l00442"></a>00442     }
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     curl_easy_setopt(curl, CURLOPT_URL, url);
<a name="l00445"></a>00445     curl_easy_setopt(curl, CURLOPT_UPLOAD, 1L);
<a name="l00446"></a>00446 
<a name="l00447"></a>00447     <span class="comment">/* Set low speed limit to 1 bytes. This effectively means no data. */</span>
<a name="l00448"></a>00448     curl_easy_setopt(curl, CURLOPT_LOW_SPEED_LIMIT, 1);
<a name="l00449"></a>00449     curl_easy_setopt(curl, CURLOPT_LOW_SPEED_TIME, <a class="code" href="http-tx-mgr_8c.html#acfc6c1ddecc516b7075c03f945c5cee9">HTTP_TIMEOUT_SEC</a>);
<a name="l00450"></a>00450 
<a name="l00451"></a>00451     <span class="keywordflow">if</span> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a9810d1dadf63c55d4a27f077683965a5">disable_verify_certificate</a>) {
<a name="l00452"></a>00452         curl_easy_setopt (curl, CURLOPT_SSL_VERIFYPEER, 0L);
<a name="l00453"></a>00453         curl_easy_setopt (curl, CURLOPT_SSL_VERIFYHOST, 0L);
<a name="l00454"></a>00454     }
<a name="l00455"></a>00455 
<a name="l00456"></a>00456     <a class="code" href="struct__HttpRequest.html">HttpRequest</a> req;
<a name="l00457"></a>00457     <span class="keywordflow">if</span> (req_content) {
<a name="l00458"></a>00458         memset (&amp;req, 0, <span class="keyword">sizeof</span>(req));
<a name="l00459"></a>00459         req.<a class="code" href="struct__HttpRequest.html#ad418ba313e39eb93e1fbc72b9ffc9cb8">content</a> = req_content;
<a name="l00460"></a>00460         req.<a class="code" href="struct__HttpRequest.html#ab4a54ed927873962a0dabbeeea6ab80d">size</a> = req_size;
<a name="l00461"></a>00461         curl_easy_setopt(curl, CURLOPT_READFUNCTION, send_request);
<a name="l00462"></a>00462         curl_easy_setopt(curl, CURLOPT_READDATA, &amp;req);
<a name="l00463"></a>00463         curl_easy_setopt(curl, CURLOPT_INFILESIZE_LARGE, (curl_off_t)req_size);
<a name="l00464"></a>00464     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (callback != NULL) {
<a name="l00465"></a>00465         curl_easy_setopt(curl, CURLOPT_READFUNCTION, callback);
<a name="l00466"></a>00466         curl_easy_setopt(curl, CURLOPT_READDATA, cb_data);
<a name="l00467"></a>00467         curl_easy_setopt(curl, CURLOPT_INFILESIZE_LARGE, (curl_off_t)req_size);
<a name="l00468"></a>00468     } <span class="keywordflow">else</span> {
<a name="l00469"></a>00469         curl_easy_setopt (curl, CURLOPT_INFILESIZE_LARGE, (curl_off_t)0);
<a name="l00470"></a>00470     }
<a name="l00471"></a>00471 
<a name="l00472"></a>00472     curl_easy_setopt(curl, CURLOPT_NOSIGNAL, 1L);
<a name="l00473"></a>00473 
<a name="l00474"></a>00474     <a class="code" href="struct__HttpResponse.html">HttpResponse</a> rsp;
<a name="l00475"></a>00475     memset (&amp;rsp, 0, <span class="keyword">sizeof</span>(rsp));
<a name="l00476"></a>00476     <span class="keywordflow">if</span> (rsp_content) {
<a name="l00477"></a>00477         curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, recv_response);
<a name="l00478"></a>00478         curl_easy_setopt(curl, CURLOPT_WRITEDATA, &amp;rsp);
<a name="l00479"></a>00479     }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481     gboolean is_https = (strncasecmp(url, <span class="stringliteral">&quot;https&quot;</span>, strlen(<span class="stringliteral">&quot;https&quot;</span>)) == 0);
<a name="l00482"></a>00482     set_proxy (curl, is_https);
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     curl_easy_setopt(curl, CURLOPT_FOLLOWLOCATION, 1L);
<a name="l00485"></a>00485 
<a name="l00486"></a>00486     <span class="keywordtype">int</span> rc = curl_easy_perform (curl);
<a name="l00487"></a>00487     <span class="keywordflow">if</span> (rc != 0) {
<a name="l00488"></a>00488         seaf_warning (<span class="stringliteral">&quot;libcurl failed to PUT %s: %s.\n&quot;</span>,
<a name="l00489"></a>00489                       url, curl_easy_strerror(rc));
<a name="l00490"></a>00490         ret = -1;
<a name="l00491"></a>00491         <span class="keywordflow">goto</span> out;
<a name="l00492"></a>00492     }
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     <span class="keywordtype">long</span> <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l00495"></a>00495     rc = curl_easy_getinfo (curl, CURLINFO_RESPONSE_CODE, &amp;status);
<a name="l00496"></a>00496     <span class="keywordflow">if</span> (rc != CURLE_OK) {
<a name="l00497"></a>00497         seaf_warning (<span class="stringliteral">&quot;Failed to get status code for PUT %s.\n&quot;</span>, url);
<a name="l00498"></a>00498         ret = -1;
<a name="l00499"></a>00499         <span class="keywordflow">goto</span> out;
<a name="l00500"></a>00500     }
<a name="l00501"></a>00501 
<a name="l00502"></a>00502     *rsp_status = <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l00503"></a>00503 
<a name="l00504"></a>00504     <span class="keywordflow">if</span> (rsp_content) {
<a name="l00505"></a>00505         *rsp_content = rsp.<a class="code" href="struct__HttpResponse.html#a304c62b1c80c9858b76172e292263162">content</a>;
<a name="l00506"></a>00506         *rsp_size = rsp.<a class="code" href="struct__HttpResponse.html#a68f086a14de6180ee50bebbc66cc7d70">size</a>;
<a name="l00507"></a>00507     }
<a name="l00508"></a>00508 
<a name="l00509"></a>00509 out:
<a name="l00510"></a>00510     <span class="keywordflow">if</span> (ret &lt; 0)
<a name="l00511"></a>00511         g_free (rsp.<a class="code" href="struct__HttpResponse.html#a304c62b1c80c9858b76172e292263162">content</a>);
<a name="l00512"></a>00512     curl_slist_free_all (headers);
<a name="l00513"></a>00513     <span class="keywordflow">return</span> ret;
<a name="l00514"></a>00514 }
<a name="l00515"></a>00515 
<a name="l00516"></a>00516 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00517"></a>00517 http_post (CURL *curl, <span class="keyword">const</span> <span class="keywordtype">char</span> *url, <span class="keyword">const</span> <span class="keywordtype">char</span> *token,
<a name="l00518"></a>00518            <span class="keyword">const</span> <span class="keywordtype">char</span> *req_content, gint64 req_size,
<a name="l00519"></a>00519            <span class="keywordtype">int</span> *rsp_status, <span class="keywordtype">char</span> **rsp_content, gint64 *rsp_size)
<a name="l00520"></a>00520 {
<a name="l00521"></a>00521     <span class="keywordtype">char</span> *token_header;
<a name="l00522"></a>00522     <span class="keyword">struct </span>curl_slist *headers = NULL;
<a name="l00523"></a>00523     <span class="keywordtype">int</span> ret = 0;
<a name="l00524"></a>00524 
<a name="l00525"></a>00525     g_return_val_if_fail (req_content != NULL, -1);
<a name="l00526"></a>00526 
<a name="l00527"></a>00527     <span class="keywordflow">if</span> (token) {
<a name="l00528"></a>00528         token_header = g_strdup_printf (<span class="stringliteral">&quot;Seafile-Repo-Token: %s&quot;</span>, token);
<a name="l00529"></a>00529         headers = curl_slist_append (headers, token_header);
<a name="l00530"></a>00530         g_free (token_header);
<a name="l00531"></a>00531         curl_easy_setopt(curl, CURLOPT_HTTPHEADER, headers);
<a name="l00532"></a>00532     }
<a name="l00533"></a>00533 
<a name="l00534"></a>00534     curl_easy_setopt(curl, CURLOPT_URL, url);
<a name="l00535"></a>00535     curl_easy_setopt(curl, CURLOPT_POST, 1L);
<a name="l00536"></a>00536 
<a name="l00537"></a>00537     <span class="comment">/* Set low speed limit to 1 bytes. This effectively means no data. */</span>
<a name="l00538"></a>00538     curl_easy_setopt(curl, CURLOPT_LOW_SPEED_LIMIT, 1);
<a name="l00539"></a>00539     curl_easy_setopt(curl, CURLOPT_LOW_SPEED_TIME, <a class="code" href="http-tx-mgr_8c.html#acfc6c1ddecc516b7075c03f945c5cee9">HTTP_TIMEOUT_SEC</a>);
<a name="l00540"></a>00540 
<a name="l00541"></a>00541     <span class="keywordflow">if</span> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a9810d1dadf63c55d4a27f077683965a5">disable_verify_certificate</a>) {
<a name="l00542"></a>00542         curl_easy_setopt (curl, CURLOPT_SSL_VERIFYPEER, 0L);
<a name="l00543"></a>00543         curl_easy_setopt (curl, CURLOPT_SSL_VERIFYHOST, 0L);
<a name="l00544"></a>00544     }
<a name="l00545"></a>00545 
<a name="l00546"></a>00546     <a class="code" href="struct__HttpRequest.html">HttpRequest</a> req;
<a name="l00547"></a>00547     memset (&amp;req, 0, <span class="keyword">sizeof</span>(req));
<a name="l00548"></a>00548     req.<a class="code" href="struct__HttpRequest.html#ad418ba313e39eb93e1fbc72b9ffc9cb8">content</a> = req_content;
<a name="l00549"></a>00549     req.<a class="code" href="struct__HttpRequest.html#ab4a54ed927873962a0dabbeeea6ab80d">size</a> = req_size;
<a name="l00550"></a>00550     curl_easy_setopt(curl, CURLOPT_READFUNCTION, send_request);
<a name="l00551"></a>00551     curl_easy_setopt(curl, CURLOPT_READDATA, &amp;req);
<a name="l00552"></a>00552     curl_easy_setopt(curl, CURLOPT_POSTFIELDSIZE_LARGE, (curl_off_t)req_size);
<a name="l00553"></a>00553 
<a name="l00554"></a>00554     curl_easy_setopt(curl, CURLOPT_NOSIGNAL, 1L);
<a name="l00555"></a>00555 
<a name="l00556"></a>00556     <a class="code" href="struct__HttpResponse.html">HttpResponse</a> rsp;
<a name="l00557"></a>00557     memset (&amp;rsp, 0, <span class="keyword">sizeof</span>(rsp));
<a name="l00558"></a>00558     <span class="keywordflow">if</span> (rsp_content) {
<a name="l00559"></a>00559         curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, recv_response);
<a name="l00560"></a>00560         curl_easy_setopt(curl, CURLOPT_WRITEDATA, &amp;rsp);
<a name="l00561"></a>00561     }
<a name="l00562"></a>00562 
<a name="l00563"></a>00563     gboolean is_https = (strncasecmp(url, <span class="stringliteral">&quot;https&quot;</span>, strlen(<span class="stringliteral">&quot;https&quot;</span>)) == 0);
<a name="l00564"></a>00564     set_proxy (curl, is_https);
<a name="l00565"></a>00565 
<a name="l00566"></a>00566     curl_easy_setopt(curl, CURLOPT_FOLLOWLOCATION, 1L);
<a name="l00567"></a>00567     <span class="comment">/* All POST requests should remain POST after redirect. */</span>
<a name="l00568"></a>00568     curl_easy_setopt(curl, CURLOPT_POSTREDIR, CURL_REDIR_POST_ALL);
<a name="l00569"></a>00569 
<a name="l00570"></a>00570     <span class="keywordtype">int</span> rc = curl_easy_perform (curl);
<a name="l00571"></a>00571     <span class="keywordflow">if</span> (rc != 0) {
<a name="l00572"></a>00572         seaf_warning (<span class="stringliteral">&quot;libcurl failed to POST %s: %s.\n&quot;</span>,
<a name="l00573"></a>00573                       url, curl_easy_strerror(rc));
<a name="l00574"></a>00574         ret = -1;
<a name="l00575"></a>00575         <span class="keywordflow">goto</span> out;
<a name="l00576"></a>00576     }
<a name="l00577"></a>00577 
<a name="l00578"></a>00578     <span class="keywordtype">long</span> <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l00579"></a>00579     rc = curl_easy_getinfo (curl, CURLINFO_RESPONSE_CODE, &amp;status);
<a name="l00580"></a>00580     <span class="keywordflow">if</span> (rc != CURLE_OK) {
<a name="l00581"></a>00581         seaf_warning (<span class="stringliteral">&quot;Failed to get status code for POST %s.\n&quot;</span>, url);
<a name="l00582"></a>00582         ret = -1;
<a name="l00583"></a>00583         <span class="keywordflow">goto</span> out;
<a name="l00584"></a>00584     }
<a name="l00585"></a>00585 
<a name="l00586"></a>00586     *rsp_status = <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l00587"></a>00587 
<a name="l00588"></a>00588     <span class="keywordflow">if</span> (rsp_content) {
<a name="l00589"></a>00589         *rsp_content = rsp.<a class="code" href="struct__HttpResponse.html#a304c62b1c80c9858b76172e292263162">content</a>;
<a name="l00590"></a>00590         *rsp_size = rsp.<a class="code" href="struct__HttpResponse.html#a68f086a14de6180ee50bebbc66cc7d70">size</a>;
<a name="l00591"></a>00591     }
<a name="l00592"></a>00592 
<a name="l00593"></a>00593 out:
<a name="l00594"></a>00594     <span class="keywordflow">if</span> (ret &lt; 0)
<a name="l00595"></a>00595         g_free (rsp.<a class="code" href="struct__HttpResponse.html#a304c62b1c80c9858b76172e292263162">content</a>);
<a name="l00596"></a>00596     curl_slist_free_all (headers);
<a name="l00597"></a>00597     <span class="keywordflow">return</span> ret;
<a name="l00598"></a>00598 }
<a name="l00599"></a>00599 
<a name="l00600"></a>00600 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00601"></a>00601 handle_http_errors (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task, <span class="keywordtype">int</span> status)
<a name="l00602"></a>00602 {
<a name="l00603"></a>00603     <span class="keywordflow">if</span> (status == <a class="code" href="http-tx-mgr_8c.html#a0c1fdbbb10800664989907cbd3a5a023">HTTP_BAD_REQUEST</a>)
<a name="l00604"></a>00604         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159a6b17ca48969df67259294bd81d616502">HTTP_TASK_ERR_BAD_REQUEST</a>;
<a name="l00605"></a>00605     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="http-tx-mgr_8c.html#a92646f876056a1e5013e0050496dc04d">HTTP_FORBIDDEN</a>)
<a name="l00606"></a>00606         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159aa00ba87058de87811a512e793545688d">HTTP_TASK_ERR_FORBIDDEN</a>;
<a name="l00607"></a>00607     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status &gt;= <a class="code" href="http-tx-mgr_8c.html#a5d9777e02c26063c2985e39ef71091d2">HTTP_INTERNAL_SERVER_ERROR</a>)
<a name="l00608"></a>00608         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159aba8619a02d36bc551d2cd4bffd978a42">HTTP_TASK_ERR_SERVER</a>;
<a name="l00609"></a>00609     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="http-tx-mgr_8c.html#abd505b5244bd18ae61c581484b4bc5a0">HTTP_NOT_FOUND</a>)
<a name="l00610"></a>00610         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159aba8619a02d36bc551d2cd4bffd978a42">HTTP_TASK_ERR_SERVER</a>;
<a name="l00611"></a>00611     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="http-tx-mgr_8c.html#a71f74422b67ea7e609f97f035e8732ea">HTTP_NO_QUOTA</a>)
<a name="l00612"></a>00612         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159a2a3d2dfaad7277c09bfec6d98442c774">HTTP_TASK_ERR_NO_QUOTA</a>;
<a name="l00613"></a>00613     <span class="keywordflow">else</span>
<a name="l00614"></a>00614         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159aa1041bfc4f5093343ba20b11e10057c7">HTTP_TASK_ERR_UNKNOWN</a>;
<a name="l00615"></a>00615 }
<a name="l00616"></a>00616 
<a name="l00617"></a>00617 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00618"></a>00618 emit_transfer_done_signal (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task)
<a name="l00619"></a>00619 {
<a name="l00620"></a>00620     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ad954a300aab26e22dcd2100b2c5e248a">type</a> == <a class="code" href="http-tx-mgr_8h.html#a16af7b253440dadd46a80a4b9fddba4da429731c6953f215203cf1b17fe92ebb1">HTTP_TASK_TYPE_DOWNLOAD</a>)
<a name="l00621"></a>00621         g_signal_emit_by_name (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>, <span class="stringliteral">&quot;repo-http-fetched&quot;</span>, task);
<a name="l00622"></a>00622     <span class="keywordflow">else</span>
<a name="l00623"></a>00623         g_signal_emit_by_name (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>, <span class="stringliteral">&quot;repo-http-uploaded&quot;</span>, task);
<a name="l00624"></a>00624 }
<a name="l00625"></a>00625 
<a name="l00626"></a>00626 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00627"></a>00627 transition_state (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task, <span class="keywordtype">int</span> state, <span class="keywordtype">int</span> rt_state)
<a name="l00628"></a>00628 {
<a name="l00629"></a>00629     seaf_message (<span class="stringliteral">&quot;Transfer repo &#39;%.8s&#39;: (&#39;%s&#39;, &#39;%s&#39;) --&gt; (&#39;%s&#39;, &#39;%s&#39;)\n&quot;</span>,
<a name="l00630"></a>00630                   task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>,
<a name="l00631"></a>00631                   <a class="code" href="http-tx-mgr_8c.html#a67072054c5ac5f932ea490a3f2a87eb9">http_task_state_to_str</a>(task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a>),
<a name="l00632"></a>00632                   <a class="code" href="http-tx-mgr_8c.html#a96af3a00157e12d0ea5a88042a4f225c">http_task_rt_state_to_str</a>(task-&gt;<a class="code" href="struct__HttpTxTask.html#a42338e3407f898a2dc149f087cd0cea6">runtime_state</a>),
<a name="l00633"></a>00633                   <a class="code" href="http-tx-mgr_8c.html#a67072054c5ac5f932ea490a3f2a87eb9">http_task_state_to_str</a>(state),
<a name="l00634"></a>00634                   <a class="code" href="http-tx-mgr_8c.html#a96af3a00157e12d0ea5a88042a4f225c">http_task_rt_state_to_str</a>(rt_state));
<a name="l00635"></a>00635 
<a name="l00636"></a>00636     <span class="keywordflow">if</span> (state != task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a>)
<a name="l00637"></a>00637         task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> = state;
<a name="l00638"></a>00638     task-&gt;<a class="code" href="struct__HttpTxTask.html#a42338e3407f898a2dc149f087cd0cea6">runtime_state</a> = rt_state;
<a name="l00639"></a>00639 
<a name="l00640"></a>00640     <span class="keywordflow">if</span> (rt_state == <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617a48fa58e541bc5e2f237e8cd81b1a33b3">HTTP_TASK_RT_STATE_FINISHED</a>) {
<a name="l00641"></a>00641         <span class="comment">/* Clear download head info. */</span>
<a name="l00642"></a>00642         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ad954a300aab26e22dcd2100b2c5e248a">type</a> == <a class="code" href="http-tx-mgr_8h.html#a16af7b253440dadd46a80a4b9fddba4da429731c6953f215203cf1b17fe92ebb1">HTTP_TASK_TYPE_DOWNLOAD</a> &amp;&amp;
<a name="l00643"></a>00643             state == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5a0facf2c60cc1a598735bd4d8d488417b">HTTP_TASK_STATE_FINISHED</a>)
<a name="l00644"></a>00644             <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l00645"></a>00645                                                  task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>,
<a name="l00646"></a>00646                                                  <a class="code" href="daemon_2repo-mgr_8h.html#a1d90660156a493f14023ca76013acd64">REPO_PROP_DOWNLOAD_HEAD</a>,
<a name="l00647"></a>00647                                                  <a class="code" href="seafile-4_81_82_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>);
<a name="l00648"></a>00648 
<a name="l00649"></a>00649         emit_transfer_done_signal (task);
<a name="l00650"></a>00650     }
<a name="l00651"></a>00651 }
<a name="l00652"></a>00652 
<a name="l00653"></a><a class="code" href="structCheckProtocolData.html">00653</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00654"></a><a class="code" href="structCheckProtocolData.html#adb5bb5412e1bd26d4ac2ce541890a053">00654</a>     <span class="keywordtype">char</span> *<a class="code" href="structCheckProtocolData.html#adb5bb5412e1bd26d4ac2ce541890a053">host</a>;
<a name="l00655"></a><a class="code" href="structCheckProtocolData.html#a0e064a41b438275a9441c685377398bc">00655</a>     <a class="code" href="http-tx-mgr_8h.html#a7966f73c8d9f6feb861d8aa85adcf2bc">HttpProtocolVersionCallback</a> <a class="code" href="structCheckProtocolData.html#a0e064a41b438275a9441c685377398bc">callback</a>;
<a name="l00656"></a><a class="code" href="structCheckProtocolData.html#a748633c8bd9a0296196c5f2d31dca622">00656</a>     <span class="keywordtype">void</span> *<a class="code" href="structCheckProtocolData.html#a748633c8bd9a0296196c5f2d31dca622">user_data</a>;
<a name="l00657"></a>00657 
<a name="l00658"></a><a class="code" href="structCheckProtocolData.html#a02781822a4ab2a30eca3c7fee1ab9dd3">00658</a>     gboolean <a class="code" href="structCheckProtocolData.html#a02781822a4ab2a30eca3c7fee1ab9dd3">success</a>;
<a name="l00659"></a><a class="code" href="structCheckProtocolData.html#aabaa7bdac286887615c78069d0f54b35">00659</a>     gboolean <a class="code" href="structCheckProtocolData.html#aabaa7bdac286887615c78069d0f54b35">not_supported</a>;
<a name="l00660"></a><a class="code" href="structCheckProtocolData.html#a1cc963ee200a3ee7e31a9aeb851adf17">00660</a>     <span class="keywordtype">int</span> <a class="code" href="structCheckProtocolData.html#a1cc963ee200a3ee7e31a9aeb851adf17">version</a>;
<a name="l00661"></a>00661 } <a class="code" href="structCheckProtocolData.html">CheckProtocolData</a>;
<a name="l00662"></a>00662 
<a name="l00663"></a>00663 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00664"></a>00664 parse_protocol_version (<span class="keyword">const</span> <span class="keywordtype">char</span> *rsp_content, <span class="keywordtype">int</span> rsp_size, <a class="code" href="structCheckProtocolData.html">CheckProtocolData</a> *data)
<a name="l00665"></a>00665 {
<a name="l00666"></a>00666     json_t *<span class="keywordtype">object</span> = NULL;
<a name="l00667"></a>00667     json_error_t jerror;
<a name="l00668"></a>00668     <span class="keywordtype">int</span> <a class="code" href="block-tx-utils_8h.html#a1abe2c64ac9f8bc05bbb1719cad360f3">version</a>;
<a name="l00669"></a>00669 
<a name="l00670"></a>00670     <span class="keywordtype">object</span> = json_loadb (rsp_content, rsp_size, 0, &amp;jerror);
<a name="l00671"></a>00671     <span class="keywordflow">if</span> (!<span class="keywordtype">object</span>) {
<a name="l00672"></a>00672         seaf_warning (<span class="stringliteral">&quot;Parse response failed: %s.\n&quot;</span>, jerror.text);
<a name="l00673"></a>00673         <span class="keywordflow">return</span> -1;
<a name="l00674"></a>00674     }
<a name="l00675"></a>00675 
<a name="l00676"></a>00676     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af3fcfc36aa8248b0c8932e5c3e51f3fc">json_object_has_member</a> (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;version&quot;</span>)) {
<a name="l00677"></a>00677         version = <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a36802b9b311cdc4cd847b79c4ddd5903">json_object_get_int_member</a> (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;version&quot;</span>);
<a name="l00678"></a>00678         data-&gt;<a class="code" href="structCheckProtocolData.html#a1cc963ee200a3ee7e31a9aeb851adf17">version</a> = <a class="code" href="block-tx-utils_8h.html#a1abe2c64ac9f8bc05bbb1719cad360f3">version</a>;
<a name="l00679"></a>00679     } <span class="keywordflow">else</span> {
<a name="l00680"></a>00680         seaf_warning (<span class="stringliteral">&quot;Response doesn&#39;t contain protocol version.\n&quot;</span>);
<a name="l00681"></a>00681         json_decref (<span class="keywordtype">object</span>);
<a name="l00682"></a>00682         <span class="keywordflow">return</span> -1;
<a name="l00683"></a>00683     }
<a name="l00684"></a>00684 
<a name="l00685"></a>00685     json_decref (<span class="keywordtype">object</span>);
<a name="l00686"></a>00686     <span class="keywordflow">return</span> 0;
<a name="l00687"></a>00687 }
<a name="l00688"></a>00688 
<a name="l00689"></a>00689 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l00690"></a>00690 check_protocol_version_thread (<span class="keywordtype">void</span> *vdata)
<a name="l00691"></a>00691 {
<a name="l00692"></a>00692     <a class="code" href="structCheckProtocolData.html">CheckProtocolData</a> *data = vdata;
<a name="l00693"></a>00693     <a class="code" href="struct__HttpTxPriv.html">HttpTxPriv</a> *priv = <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>-&gt;<a class="code" href="struct__HttpTxManager.html#a3e124361f6d9812dd9e4fb15e7ea41e7">priv</a>;
<a name="l00694"></a>00694     <a class="code" href="struct__ConnectionPool.html">ConnectionPool</a> *pool;
<a name="l00695"></a>00695     <a class="code" href="struct__Connection.html">Connection</a> *conn;
<a name="l00696"></a>00696     CURL *curl;
<a name="l00697"></a>00697     <span class="keywordtype">char</span> *url;
<a name="l00698"></a>00698     <span class="keywordtype">int</span> <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l00699"></a>00699     <span class="keywordtype">char</span> *rsp_content = NULL;
<a name="l00700"></a>00700     gint64 rsp_size;
<a name="l00701"></a>00701 
<a name="l00702"></a>00702     pool = find_connection_pool (priv, data-&gt;<a class="code" href="structCheckProtocolData.html#adb5bb5412e1bd26d4ac2ce541890a053">host</a>);
<a name="l00703"></a>00703     <span class="keywordflow">if</span> (!pool) {
<a name="l00704"></a>00704         seaf_warning (<span class="stringliteral">&quot;Failed to create connection pool for host %s.\n&quot;</span>, data-&gt;<a class="code" href="structCheckProtocolData.html#adb5bb5412e1bd26d4ac2ce541890a053">host</a>);
<a name="l00705"></a>00705         <span class="keywordflow">return</span> vdata;
<a name="l00706"></a>00706     }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708     conn = connection_pool_get_connection (pool);
<a name="l00709"></a>00709     <span class="keywordflow">if</span> (!conn) {
<a name="l00710"></a>00710         seaf_warning (<span class="stringliteral">&quot;Failed to get connection to host %s.\n&quot;</span>, data-&gt;<a class="code" href="structCheckProtocolData.html#adb5bb5412e1bd26d4ac2ce541890a053">host</a>);
<a name="l00711"></a>00711         <span class="keywordflow">return</span> vdata;
<a name="l00712"></a>00712     }
<a name="l00713"></a>00713 
<a name="l00714"></a>00714     curl = conn-&gt;<a class="code" href="struct__Connection.html#af8b983fae165a24c7f9cc24e47361d57">curl</a>;
<a name="l00715"></a>00715 
<a name="l00716"></a>00716     url = g_strdup_printf (<span class="stringliteral">&quot;%s/seafhttp/protocol-version&quot;</span>, data-&gt;<a class="code" href="structCheckProtocolData.html#adb5bb5412e1bd26d4ac2ce541890a053">host</a>);
<a name="l00717"></a>00717 
<a name="l00718"></a>00718     <span class="keywordflow">if</span> (http_get (curl, url, NULL, &amp;status, &amp;rsp_content, &amp;rsp_size, NULL, NULL) &lt; 0) {
<a name="l00719"></a>00719         <span class="keywordflow">goto</span> out;
<a name="l00720"></a>00720     }
<a name="l00721"></a>00721 
<a name="l00722"></a>00722     data-&gt;<a class="code" href="structCheckProtocolData.html#a02781822a4ab2a30eca3c7fee1ab9dd3">success</a> = TRUE;
<a name="l00723"></a>00723 
<a name="l00724"></a>00724     <span class="keywordflow">if</span> (status == <a class="code" href="http-tx-mgr_8c.html#a02e6d59009dee759528ec81fc9a8eeff">HTTP_OK</a>) {
<a name="l00725"></a>00725         <span class="keywordflow">if</span> (rsp_size == 0)
<a name="l00726"></a>00726             data-&gt;<a class="code" href="structCheckProtocolData.html#aabaa7bdac286887615c78069d0f54b35">not_supported</a> = TRUE;
<a name="l00727"></a>00727         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (parse_protocol_version (rsp_content, rsp_size, data) &lt; 0)
<a name="l00728"></a>00728             data-&gt;<a class="code" href="structCheckProtocolData.html#aabaa7bdac286887615c78069d0f54b35">not_supported</a> = TRUE;
<a name="l00729"></a>00729     } <span class="keywordflow">else</span> {
<a name="l00730"></a>00730         seaf_warning (<span class="stringliteral">&quot;Bad response code for GET %s: %d.\n&quot;</span>, url, status);
<a name="l00731"></a>00731         data-&gt;<a class="code" href="structCheckProtocolData.html#aabaa7bdac286887615c78069d0f54b35">not_supported</a> = TRUE;
<a name="l00732"></a>00732     }
<a name="l00733"></a>00733 
<a name="l00734"></a>00734 out:
<a name="l00735"></a>00735     g_free (url);
<a name="l00736"></a>00736     g_free (rsp_content);
<a name="l00737"></a>00737     connection_pool_return_connection (pool, conn);
<a name="l00738"></a>00738 
<a name="l00739"></a>00739     <span class="keywordflow">return</span> vdata;
<a name="l00740"></a>00740 }
<a name="l00741"></a>00741 
<a name="l00742"></a>00742 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00743"></a>00743 check_protocol_version_done (<span class="keywordtype">void</span> *vdata)
<a name="l00744"></a>00744 {
<a name="l00745"></a>00745     <a class="code" href="structCheckProtocolData.html">CheckProtocolData</a> *data = vdata;
<a name="l00746"></a>00746     <a class="code" href="struct__HttpProtocolVersion.html">HttpProtocolVersion</a> result;
<a name="l00747"></a>00747 
<a name="l00748"></a>00748     memset (&amp;result, 0, <span class="keyword">sizeof</span>(result));
<a name="l00749"></a>00749     result.<a class="code" href="struct__HttpProtocolVersion.html#a991b27b1c98ba43a9b1ce6015621967b">check_success</a> = data-&gt;<a class="code" href="structCheckProtocolData.html#a02781822a4ab2a30eca3c7fee1ab9dd3">success</a>;
<a name="l00750"></a>00750     result.<a class="code" href="struct__HttpProtocolVersion.html#a8b83905e8e620d43f74b060a44c3a6fd">not_supported</a> = data-&gt;<a class="code" href="structCheckProtocolData.html#aabaa7bdac286887615c78069d0f54b35">not_supported</a>;
<a name="l00751"></a>00751     result.<a class="code" href="struct__HttpProtocolVersion.html#af81f9fb94ee6b008195681a8d2026591">version</a> = data-&gt;<a class="code" href="structCheckProtocolData.html#a1cc963ee200a3ee7e31a9aeb851adf17">version</a>;
<a name="l00752"></a>00752 
<a name="l00753"></a>00753     data-&gt;<a class="code" href="structCheckProtocolData.html#a0e064a41b438275a9441c685377398bc">callback</a> (&amp;result, data-&gt;<a class="code" href="structCheckProtocolData.html#a748633c8bd9a0296196c5f2d31dca622">user_data</a>);
<a name="l00754"></a>00754 
<a name="l00755"></a>00755     g_free (data-&gt;<a class="code" href="structCheckProtocolData.html#adb5bb5412e1bd26d4ac2ce541890a053">host</a>);
<a name="l00756"></a>00756     g_free (data);
<a name="l00757"></a>00757 }
<a name="l00758"></a>00758 
<a name="l00759"></a>00759 <span class="keywordtype">int</span>
<a name="l00760"></a><a class="code" href="http-tx-mgr_8h.html#a43e9d54b963e1bd9b8f43814a92563ea">00760</a> <a class="code" href="http-tx-mgr_8c.html#a43e9d54b963e1bd9b8f43814a92563ea">http_tx_manager_check_protocol_version</a> (<a class="code" href="struct__HttpTxManager.html">HttpTxManager</a> *manager,
<a name="l00761"></a>00761                                         <span class="keyword">const</span> <span class="keywordtype">char</span> *host,
<a name="l00762"></a>00762                                         <a class="code" href="http-tx-mgr_8h.html#a7966f73c8d9f6feb861d8aa85adcf2bc">HttpProtocolVersionCallback</a> callback,
<a name="l00763"></a>00763                                         <span class="keywordtype">void</span> *user_data)
<a name="l00764"></a>00764 {
<a name="l00765"></a>00765     <a class="code" href="structCheckProtocolData.html">CheckProtocolData</a> *data = g_new0 (<a class="code" href="structCheckProtocolData.html">CheckProtocolData</a>, 1);
<a name="l00766"></a>00766 
<a name="l00767"></a>00767     data-&gt;<a class="code" href="structCheckProtocolData.html#adb5bb5412e1bd26d4ac2ce541890a053">host</a> = g_strdup(host);
<a name="l00768"></a>00768     data-&gt;<a class="code" href="structCheckProtocolData.html#a0e064a41b438275a9441c685377398bc">callback</a> = callback;
<a name="l00769"></a>00769     data-&gt;<a class="code" href="structCheckProtocolData.html#a748633c8bd9a0296196c5f2d31dca622">user_data</a> = user_data;
<a name="l00770"></a>00770 
<a name="l00771"></a>00771     <a class="code" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768">ccnet_job_manager_schedule_job</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#abcbb9886e315abb16c620ce49808a0b2">job_mgr</a>,
<a name="l00772"></a>00772                                     check_protocol_version_thread,
<a name="l00773"></a>00773                                     check_protocol_version_done,
<a name="l00774"></a>00774                                     data);
<a name="l00775"></a>00775 
<a name="l00776"></a>00776     <span class="keywordflow">return</span> 0;
<a name="l00777"></a>00777 }
<a name="l00778"></a>00778 
<a name="l00779"></a>00779 <span class="comment">/* Check Head Commit. */</span>
<a name="l00780"></a>00780 
<a name="l00781"></a><a class="code" href="structCheckHeadData.html">00781</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00782"></a><a class="code" href="structCheckHeadData.html#a7cca3e9041e496e0e7ea842dc5f6a92a">00782</a>     <span class="keywordtype">char</span> repo_id[41];
<a name="l00783"></a><a class="code" href="structCheckHeadData.html#aed6948b54cd29996fcb20d0e168df45b">00783</a>     <span class="keywordtype">int</span> <a class="code" href="structCheckHeadData.html#aed6948b54cd29996fcb20d0e168df45b">repo_version</a>;
<a name="l00784"></a><a class="code" href="structCheckHeadData.html#a1c1fc026d492c1c81198cfe78b4df7d7">00784</a>     <span class="keywordtype">char</span> *<a class="code" href="structCheckHeadData.html#a1c1fc026d492c1c81198cfe78b4df7d7">host</a>;
<a name="l00785"></a><a class="code" href="structCheckHeadData.html#ad78a3cba7eec0e29aa1c2b622d2483e8">00785</a>     <span class="keywordtype">char</span> *<a class="code" href="structCheckHeadData.html#ad78a3cba7eec0e29aa1c2b622d2483e8">token</a>;
<a name="l00786"></a><a class="code" href="structCheckHeadData.html#a43b5310afa49039a08b00112712247e8">00786</a>     <a class="code" href="http-tx-mgr_8h.html#a7a1b96f515ee8993f2e9048942c917bf">HttpHeadCommitCallback</a> <a class="code" href="structCheckHeadData.html#a43b5310afa49039a08b00112712247e8">callback</a>;
<a name="l00787"></a><a class="code" href="structCheckHeadData.html#adfbb3fdc584c3771393f722f9e96d9ec">00787</a>     <span class="keywordtype">void</span> *<a class="code" href="structCheckHeadData.html#adfbb3fdc584c3771393f722f9e96d9ec">user_data</a>;
<a name="l00788"></a>00788 
<a name="l00789"></a><a class="code" href="structCheckHeadData.html#a6bea4cb89f7b9efe5ac21d678772834a">00789</a>     gboolean <a class="code" href="structCheckHeadData.html#a6bea4cb89f7b9efe5ac21d678772834a">success</a>;
<a name="l00790"></a><a class="code" href="structCheckHeadData.html#ad65a64f73ea5752689d2dd876f2a8bf2">00790</a>     gboolean <a class="code" href="structCheckHeadData.html#ad65a64f73ea5752689d2dd876f2a8bf2">is_corrupt</a>;
<a name="l00791"></a><a class="code" href="structCheckHeadData.html#a33270054cb76ac76d84591a17e100c5c">00791</a>     gboolean <a class="code" href="structCheckHeadData.html#a33270054cb76ac76d84591a17e100c5c">is_deleted</a>;
<a name="l00792"></a><a class="code" href="structCheckHeadData.html#ac719b43d4b5baae5e90ff563ec2c8532">00792</a>     <span class="keywordtype">char</span> head_commit[41];
<a name="l00793"></a>00793 } <a class="code" href="structCheckHeadData.html">CheckHeadData</a>;
<a name="l00794"></a>00794 
<a name="l00795"></a>00795 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00796"></a>00796 parse_head_commit_info (<span class="keyword">const</span> <span class="keywordtype">char</span> *rsp_content, <span class="keywordtype">int</span> rsp_size, <a class="code" href="structCheckHeadData.html">CheckHeadData</a> *data)
<a name="l00797"></a>00797 {
<a name="l00798"></a>00798     json_t *<span class="keywordtype">object</span> = NULL;
<a name="l00799"></a>00799     json_error_t jerror;
<a name="l00800"></a>00800     <span class="keyword">const</span> <span class="keywordtype">char</span> *head_commit;
<a name="l00801"></a>00801 
<a name="l00802"></a>00802     <span class="keywordtype">object</span> = json_loadb (rsp_content, rsp_size, 0, &amp;jerror);
<a name="l00803"></a>00803     <span class="keywordflow">if</span> (!<span class="keywordtype">object</span>) {
<a name="l00804"></a>00804         seaf_warning (<span class="stringliteral">&quot;Parse response failed: %s.\n&quot;</span>, jerror.text);
<a name="l00805"></a>00805         <span class="keywordflow">return</span> -1;
<a name="l00806"></a>00806     }
<a name="l00807"></a>00807 
<a name="l00808"></a>00808     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af3fcfc36aa8248b0c8932e5c3e51f3fc">json_object_has_member</a> (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;is_corrupted&quot;</span>) &amp;&amp;
<a name="l00809"></a>00809         <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a36802b9b311cdc4cd847b79c4ddd5903">json_object_get_int_member</a> (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;is_corrupted&quot;</span>))
<a name="l00810"></a>00810         data-&gt;<a class="code" href="structCheckHeadData.html#ad65a64f73ea5752689d2dd876f2a8bf2">is_corrupt</a> = TRUE;
<a name="l00811"></a>00811 
<a name="l00812"></a>00812     <span class="keywordflow">if</span> (!data-&gt;<a class="code" href="structCheckHeadData.html#ad65a64f73ea5752689d2dd876f2a8bf2">is_corrupt</a>) {
<a name="l00813"></a>00813         head_commit = <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a50be04624e628ad19aa88d9fc0fd5a28">json_object_get_string_member</a> (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;head_commit_id&quot;</span>);
<a name="l00814"></a>00814         <span class="keywordflow">if</span> (!head_commit) {
<a name="l00815"></a>00815             seaf_warning (<span class="stringliteral">&quot;Check head commit for repo %s failed. &quot;</span>
<a name="l00816"></a>00816                           <span class="stringliteral">&quot;Response doesn&#39;t contain head commit id.\n&quot;</span>,
<a name="l00817"></a>00817                           data-&gt;<a class="code" href="structCheckHeadData.html#a7cca3e9041e496e0e7ea842dc5f6a92a">repo_id</a>);
<a name="l00818"></a>00818             json_decref (<span class="keywordtype">object</span>);
<a name="l00819"></a>00819             <span class="keywordflow">return</span> -1;
<a name="l00820"></a>00820         }
<a name="l00821"></a>00821         memcpy (data-&gt;<a class="code" href="structCheckHeadData.html#ac719b43d4b5baae5e90ff563ec2c8532">head_commit</a>, head_commit, 40);
<a name="l00822"></a>00822     }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824     json_decref (<span class="keywordtype">object</span>);
<a name="l00825"></a>00825     <span class="keywordflow">return</span> 0;
<a name="l00826"></a>00826 }
<a name="l00827"></a>00827 
<a name="l00828"></a>00828 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l00829"></a>00829 check_head_commit_thread (<span class="keywordtype">void</span> *vdata)
<a name="l00830"></a>00830 {
<a name="l00831"></a>00831     <a class="code" href="structCheckHeadData.html">CheckHeadData</a> *data = vdata;
<a name="l00832"></a>00832     <a class="code" href="struct__HttpTxPriv.html">HttpTxPriv</a> *priv = <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>-&gt;<a class="code" href="struct__HttpTxManager.html#a3e124361f6d9812dd9e4fb15e7ea41e7">priv</a>;
<a name="l00833"></a>00833     <a class="code" href="struct__ConnectionPool.html">ConnectionPool</a> *pool;
<a name="l00834"></a>00834     <a class="code" href="struct__Connection.html">Connection</a> *conn;
<a name="l00835"></a>00835     CURL *curl;
<a name="l00836"></a>00836     <span class="keywordtype">char</span> *url;
<a name="l00837"></a>00837     <span class="keywordtype">int</span> <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l00838"></a>00838     <span class="keywordtype">char</span> *rsp_content = NULL;
<a name="l00839"></a>00839     gint64 rsp_size;
<a name="l00840"></a>00840 
<a name="l00841"></a>00841     pool = find_connection_pool (priv, data-&gt;<a class="code" href="structCheckHeadData.html#a1c1fc026d492c1c81198cfe78b4df7d7">host</a>);
<a name="l00842"></a>00842     <span class="keywordflow">if</span> (!pool) {
<a name="l00843"></a>00843         seaf_warning (<span class="stringliteral">&quot;Failed to create connection pool for host %s.\n&quot;</span>, data-&gt;<a class="code" href="structCheckHeadData.html#a1c1fc026d492c1c81198cfe78b4df7d7">host</a>);
<a name="l00844"></a>00844         <span class="keywordflow">return</span> vdata;
<a name="l00845"></a>00845     }
<a name="l00846"></a>00846 
<a name="l00847"></a>00847     conn = connection_pool_get_connection (pool);
<a name="l00848"></a>00848     <span class="keywordflow">if</span> (!conn) {
<a name="l00849"></a>00849         seaf_warning (<span class="stringliteral">&quot;Failed to get connection to host %s.\n&quot;</span>, data-&gt;<a class="code" href="structCheckHeadData.html#a1c1fc026d492c1c81198cfe78b4df7d7">host</a>);
<a name="l00850"></a>00850         <span class="keywordflow">return</span> vdata;
<a name="l00851"></a>00851     }
<a name="l00852"></a>00852 
<a name="l00853"></a>00853     curl = conn-&gt;<a class="code" href="struct__Connection.html#af8b983fae165a24c7f9cc24e47361d57">curl</a>;
<a name="l00854"></a>00854 
<a name="l00855"></a>00855     url = g_strdup_printf (<span class="stringliteral">&quot;%s/seafhttp/repo/%s/commit/HEAD&quot;</span>,
<a name="l00856"></a>00856                            data-&gt;<a class="code" href="structCheckHeadData.html#a1c1fc026d492c1c81198cfe78b4df7d7">host</a>, data-&gt;<a class="code" href="structCheckHeadData.html#a7cca3e9041e496e0e7ea842dc5f6a92a">repo_id</a>);
<a name="l00857"></a>00857 
<a name="l00858"></a>00858     <span class="keywordflow">if</span> (http_get (curl, url, data-&gt;<a class="code" href="structCheckHeadData.html#ad78a3cba7eec0e29aa1c2b622d2483e8">token</a>, &amp;status, &amp;rsp_content, &amp;rsp_size,
<a name="l00859"></a>00859                   NULL, NULL) &lt; 0)
<a name="l00860"></a>00860         <span class="keywordflow">goto</span> out;
<a name="l00861"></a>00861 
<a name="l00862"></a>00862     <span class="keywordflow">if</span> (status == <a class="code" href="http-tx-mgr_8c.html#a02e6d59009dee759528ec81fc9a8eeff">HTTP_OK</a>) {
<a name="l00863"></a>00863         <span class="keywordflow">if</span> (parse_head_commit_info (rsp_content, rsp_size, data) &lt; 0)
<a name="l00864"></a>00864             <span class="keywordflow">goto</span> out;
<a name="l00865"></a>00865         data-&gt;<a class="code" href="structCheckHeadData.html#a6bea4cb89f7b9efe5ac21d678772834a">success</a> = TRUE;
<a name="l00866"></a>00866     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="http-tx-mgr_8c.html#abf97213d568ebd9edd3597704d29f7f1">HTTP_REPO_DELETED</a>) {
<a name="l00867"></a>00867         data-&gt;<a class="code" href="structCheckHeadData.html#a33270054cb76ac76d84591a17e100c5c">is_deleted</a> = TRUE;
<a name="l00868"></a>00868         data-&gt;<a class="code" href="structCheckHeadData.html#a6bea4cb89f7b9efe5ac21d678772834a">success</a> = TRUE;
<a name="l00869"></a>00869     } <span class="keywordflow">else</span> {
<a name="l00870"></a>00870         seaf_warning (<span class="stringliteral">&quot;Bad response code for GET %s: %d.\n&quot;</span>, url, status);
<a name="l00871"></a>00871     }
<a name="l00872"></a>00872 
<a name="l00873"></a>00873 out:
<a name="l00874"></a>00874     g_free (url);
<a name="l00875"></a>00875     g_free (rsp_content);
<a name="l00876"></a>00876     connection_pool_return_connection (pool, conn);
<a name="l00877"></a>00877     <span class="keywordflow">return</span> vdata;
<a name="l00878"></a>00878 }
<a name="l00879"></a>00879 
<a name="l00880"></a>00880 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00881"></a>00881 check_head_commit_done (<span class="keywordtype">void</span> *vdata)
<a name="l00882"></a>00882 {
<a name="l00883"></a>00883     <a class="code" href="structCheckHeadData.html">CheckHeadData</a> *data = vdata;
<a name="l00884"></a>00884     <a class="code" href="struct__HttpHeadCommit.html">HttpHeadCommit</a> result;
<a name="l00885"></a>00885 
<a name="l00886"></a>00886     memset (&amp;result, 0, <span class="keyword">sizeof</span>(result));
<a name="l00887"></a>00887     result.<a class="code" href="struct__HttpHeadCommit.html#a42bce3980347bafa4af5d2b6ef8197a8">check_success</a> = data-&gt;<a class="code" href="structCheckHeadData.html#a6bea4cb89f7b9efe5ac21d678772834a">success</a>;
<a name="l00888"></a>00888     result.<a class="code" href="struct__HttpHeadCommit.html#ae76efcb51a295dedfbf56129af736a4b">is_corrupt</a> = data-&gt;<a class="code" href="structCheckHeadData.html#ad65a64f73ea5752689d2dd876f2a8bf2">is_corrupt</a>;
<a name="l00889"></a>00889     result.<a class="code" href="struct__HttpHeadCommit.html#ad720cf100758716906c6d73a82aad51a">is_deleted</a> = data-&gt;<a class="code" href="structCheckHeadData.html#a33270054cb76ac76d84591a17e100c5c">is_deleted</a>;
<a name="l00890"></a>00890     memcpy (result.<a class="code" href="struct__HttpHeadCommit.html#a153c7fda109c256dacfd330e5025e7e4">head_commit</a>, data-&gt;<a class="code" href="structCheckHeadData.html#ac719b43d4b5baae5e90ff563ec2c8532">head_commit</a>, 40);
<a name="l00891"></a>00891 
<a name="l00892"></a>00892     data-&gt;<a class="code" href="structCheckHeadData.html#a43b5310afa49039a08b00112712247e8">callback</a> (&amp;result, data-&gt;<a class="code" href="structCheckHeadData.html#adfbb3fdc584c3771393f722f9e96d9ec">user_data</a>);
<a name="l00893"></a>00893 
<a name="l00894"></a>00894     g_free (data-&gt;<a class="code" href="structCheckHeadData.html#a1c1fc026d492c1c81198cfe78b4df7d7">host</a>);
<a name="l00895"></a>00895     g_free (data-&gt;<a class="code" href="structCheckHeadData.html#ad78a3cba7eec0e29aa1c2b622d2483e8">token</a>);
<a name="l00896"></a>00896     g_free (data);
<a name="l00897"></a>00897 }
<a name="l00898"></a>00898 
<a name="l00899"></a>00899 <span class="keywordtype">int</span>
<a name="l00900"></a><a class="code" href="http-tx-mgr_8h.html#a4f2b3d94b4366c519af0a69ebb6edc34">00900</a> <a class="code" href="http-tx-mgr_8c.html#a4f2b3d94b4366c519af0a69ebb6edc34">http_tx_manager_check_head_commit</a> (<a class="code" href="struct__HttpTxManager.html">HttpTxManager</a> *manager,
<a name="l00901"></a>00901                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l00902"></a>00902                                    <span class="keywordtype">int</span> repo_version,
<a name="l00903"></a>00903                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *host,
<a name="l00904"></a>00904                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *token,
<a name="l00905"></a>00905                                    <a class="code" href="http-tx-mgr_8h.html#a7a1b96f515ee8993f2e9048942c917bf">HttpHeadCommitCallback</a> callback,
<a name="l00906"></a>00906                                    <span class="keywordtype">void</span> *user_data)
<a name="l00907"></a>00907 {
<a name="l00908"></a>00908     <a class="code" href="structCheckHeadData.html">CheckHeadData</a> *data = g_new0 (<a class="code" href="structCheckHeadData.html">CheckHeadData</a>, 1);
<a name="l00909"></a>00909 
<a name="l00910"></a>00910     memcpy (data-&gt;<a class="code" href="structCheckHeadData.html#a7cca3e9041e496e0e7ea842dc5f6a92a">repo_id</a>, repo_id, 36);
<a name="l00911"></a>00911     data-&gt;<a class="code" href="structCheckHeadData.html#aed6948b54cd29996fcb20d0e168df45b">repo_version</a> = repo_version;
<a name="l00912"></a>00912     data-&gt;<a class="code" href="structCheckHeadData.html#a1c1fc026d492c1c81198cfe78b4df7d7">host</a> = g_strdup(host);
<a name="l00913"></a>00913     data-&gt;<a class="code" href="structCheckHeadData.html#ad78a3cba7eec0e29aa1c2b622d2483e8">token</a> = g_strdup(token);
<a name="l00914"></a>00914     data-&gt;<a class="code" href="structCheckHeadData.html#a43b5310afa49039a08b00112712247e8">callback</a> = callback;
<a name="l00915"></a>00915     data-&gt;<a class="code" href="structCheckHeadData.html#adfbb3fdc584c3771393f722f9e96d9ec">user_data</a> = user_data;
<a name="l00916"></a>00916 
<a name="l00917"></a>00917     <a class="code" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768">ccnet_job_manager_schedule_job</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#abcbb9886e315abb16c620ce49808a0b2">job_mgr</a>,
<a name="l00918"></a>00918                                     check_head_commit_thread,
<a name="l00919"></a>00919                                     check_head_commit_done,
<a name="l00920"></a>00920                                     data);
<a name="l00921"></a>00921 
<a name="l00922"></a>00922     <span class="keywordflow">return</span> 0;
<a name="l00923"></a>00923 }
<a name="l00924"></a>00924 
<a name="l00925"></a>00925 <span class="comment">/* Get folder permissions. */</span>
<a name="l00926"></a>00926 
<a name="l00927"></a>00927 <span class="keywordtype">void</span>
<a name="l00928"></a><a class="code" href="http-tx-mgr_8h.html#a66ce748eeb3d6bdd5213772d5d5e3898">00928</a> <a class="code" href="http-tx-mgr_8c.html#a66ce748eeb3d6bdd5213772d5d5e3898">http_folder_perm_req_free</a> (<a class="code" href="struct__HttpFolderPermReq.html">HttpFolderPermReq</a> *req)
<a name="l00929"></a>00929 {
<a name="l00930"></a>00930     <span class="keywordflow">if</span> (!req)
<a name="l00931"></a>00931         <span class="keywordflow">return</span>;
<a name="l00932"></a>00932     g_free (req-&gt;<a class="code" href="struct__HttpFolderPermReq.html#aa33db724e9d1c9b0f37cbd297ed76063">token</a>);
<a name="l00933"></a>00933     g_free (req);
<a name="l00934"></a>00934 }
<a name="l00935"></a>00935 
<a name="l00936"></a>00936 <span class="keywordtype">void</span>
<a name="l00937"></a><a class="code" href="http-tx-mgr_8h.html#a24ed975a3f91c154ee960c03edeb05e1">00937</a> <a class="code" href="http-tx-mgr_8c.html#a24ed975a3f91c154ee960c03edeb05e1">http_folder_perm_res_free</a> (<a class="code" href="struct__HttpFolderPermRes.html">HttpFolderPermRes</a> *res)
<a name="l00938"></a>00938 {
<a name="l00939"></a>00939     GList *ptr;
<a name="l00940"></a>00940 
<a name="l00941"></a>00941     <span class="keywordflow">if</span> (!res)
<a name="l00942"></a>00942         <span class="keywordflow">return</span>;
<a name="l00943"></a>00943     <span class="keywordflow">for</span> (ptr = res-&gt;<a class="code" href="struct__HttpFolderPermRes.html#a02929f1af633e277256696ffc7ec3220">user_perms</a>; ptr; ptr = ptr-&gt;next)
<a name="l00944"></a>00944         <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a16e4a5db024bcc5baf2ef8a3f0623a41">folder_perm_free</a> ((<a class="code" href="struct__FolderPerm.html">FolderPerm</a> *)ptr-&gt;data);
<a name="l00945"></a>00945     <span class="keywordflow">for</span> (ptr = res-&gt;<a class="code" href="struct__HttpFolderPermRes.html#a739b8d7b0272f8a9a59bced0f202b533">group_perms</a>; ptr; ptr = ptr-&gt;next)
<a name="l00946"></a>00946         <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a16e4a5db024bcc5baf2ef8a3f0623a41">folder_perm_free</a> ((<a class="code" href="struct__FolderPerm.html">FolderPerm</a> *)ptr-&gt;data);
<a name="l00947"></a>00947     g_free (res);
<a name="l00948"></a>00948 }
<a name="l00949"></a>00949 
<a name="l00950"></a><a class="code" href="structGetFolderPermsData.html">00950</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00951"></a><a class="code" href="structGetFolderPermsData.html#a72d431889ce1b64a3c3d90d92f8ae2ff">00951</a>     <span class="keywordtype">char</span> *<a class="code" href="structGetFolderPermsData.html#a72d431889ce1b64a3c3d90d92f8ae2ff">host</a>;
<a name="l00952"></a><a class="code" href="structGetFolderPermsData.html#a2d5b8cf445f884d3da214f8382b20eae">00952</a>     GList *<a class="code" href="structGetFolderPermsData.html#a2d5b8cf445f884d3da214f8382b20eae">requests</a>;
<a name="l00953"></a><a class="code" href="structGetFolderPermsData.html#a31d36185f257a4f8acec1b29212d6f11">00953</a>     <a class="code" href="http-tx-mgr_8h.html#a286ab36a4faf202f3a3969625e77be21">HttpGetFolderPermsCallback</a> <a class="code" href="structGetFolderPermsData.html#a31d36185f257a4f8acec1b29212d6f11">callback</a>;
<a name="l00954"></a><a class="code" href="structGetFolderPermsData.html#a6686f4e3da2c44730bc7fa160efdcc40">00954</a>     <span class="keywordtype">void</span> *<a class="code" href="structGetFolderPermsData.html#a6686f4e3da2c44730bc7fa160efdcc40">user_data</a>;
<a name="l00955"></a>00955 
<a name="l00956"></a><a class="code" href="structGetFolderPermsData.html#a5a5820cfad01ddc3c60d651731ffa0b8">00956</a>     gboolean <a class="code" href="structGetFolderPermsData.html#a5a5820cfad01ddc3c60d651731ffa0b8">success</a>;
<a name="l00957"></a><a class="code" href="structGetFolderPermsData.html#a8367f60af018e6dfcb5e7c9a224a5375">00957</a>     GList *<a class="code" href="structGetFolderPermsData.html#a8367f60af018e6dfcb5e7c9a224a5375">results</a>;
<a name="l00958"></a>00958 } <a class="code" href="structGetFolderPermsData.html">GetFolderPermsData</a>;
<a name="l00959"></a>00959 
<a name="l00960"></a>00960 <span class="comment">/* Make sure the path starts with &#39;/&#39; but doesn&#39;t end with &#39;/&#39;. */</span>
<a name="l00961"></a>00961 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l00962"></a>00962 canonical_perm_path (<span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l00963"></a>00963 {
<a name="l00964"></a>00964     <span class="keywordtype">int</span> len = strlen(path);
<a name="l00965"></a>00965     <span class="keywordtype">char</span> *copy, *ret;
<a name="l00966"></a>00966 
<a name="l00967"></a>00967     <span class="keywordflow">if</span> (strcmp (path, <span class="stringliteral">&quot;/&quot;</span>) == 0)
<a name="l00968"></a>00968         <span class="keywordflow">return</span> g_strdup(path);
<a name="l00969"></a>00969 
<a name="l00970"></a>00970     <span class="keywordflow">if</span> (path[0] == <span class="charliteral">&#39;/&#39;</span> &amp;&amp; path[len-1] != <span class="charliteral">&#39;/&#39;</span>)
<a name="l00971"></a>00971         <span class="keywordflow">return</span> g_strdup(path);
<a name="l00972"></a>00972 
<a name="l00973"></a>00973     copy = g_strdup(path);
<a name="l00974"></a>00974 
<a name="l00975"></a>00975     <span class="keywordflow">if</span> (copy[len-1] == <span class="charliteral">&#39;/&#39;</span>)
<a name="l00976"></a>00976         copy[len-1] = 0;
<a name="l00977"></a>00977 
<a name="l00978"></a>00978     <span class="keywordflow">if</span> (copy[0] != <span class="charliteral">&#39;/&#39;</span>)
<a name="l00979"></a>00979         ret = g_strconcat (<span class="stringliteral">&quot;/&quot;</span>, copy, NULL);
<a name="l00980"></a>00980     <span class="keywordflow">else</span>
<a name="l00981"></a>00981         ret = copy;
<a name="l00982"></a>00982 
<a name="l00983"></a>00983     <span class="keywordflow">return</span> ret;
<a name="l00984"></a>00984 }
<a name="l00985"></a>00985 
<a name="l00986"></a>00986 <span class="keyword">static</span> GList *
<a name="l00987"></a>00987 parse_permission_list (json_t *array, gboolean *error)
<a name="l00988"></a>00988 {
<a name="l00989"></a>00989     GList *ret = NULL, *ptr;
<a name="l00990"></a>00990     json_t *object, *member;
<a name="l00991"></a>00991     <span class="keywordtype">size_t</span> n;
<a name="l00992"></a>00992     <span class="keywordtype">int</span> i;
<a name="l00993"></a>00993     <a class="code" href="struct__FolderPerm.html">FolderPerm</a> *perm;
<a name="l00994"></a>00994     <span class="keyword">const</span> <span class="keywordtype">char</span> *str;
<a name="l00995"></a>00995 
<a name="l00996"></a>00996     *error = FALSE;
<a name="l00997"></a>00997 
<a name="l00998"></a>00998     n = json_array_size (array);
<a name="l00999"></a>00999     <span class="keywordflow">for</span> (i = 0; i &lt; n; ++i) {
<a name="l01000"></a>01000         <span class="keywordtype">object</span> = json_array_get (array, i);
<a name="l01001"></a>01001 
<a name="l01002"></a>01002         perm = g_new0 (<a class="code" href="struct__FolderPerm.html">FolderPerm</a>, 1);
<a name="l01003"></a>01003 
<a name="l01004"></a>01004         member = json_object_get (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;path&quot;</span>);
<a name="l01005"></a>01005         <span class="keywordflow">if</span> (!member) {
<a name="l01006"></a>01006             seaf_warning (<span class="stringliteral">&quot;Invalid folder perm response format: no path.\n&quot;</span>);
<a name="l01007"></a>01007             *error = TRUE;
<a name="l01008"></a>01008             <span class="keywordflow">goto</span> out;
<a name="l01009"></a>01009         }
<a name="l01010"></a>01010         str = json_string_value(member);
<a name="l01011"></a>01011         <span class="keywordflow">if</span> (!str) {
<a name="l01012"></a>01012             seaf_warning (<span class="stringliteral">&quot;Invalid folder perm response format: invalid path.\n&quot;</span>);
<a name="l01013"></a>01013             *error = TRUE;
<a name="l01014"></a>01014             <span class="keywordflow">goto</span> out;
<a name="l01015"></a>01015         }
<a name="l01016"></a>01016         perm-&gt;<a class="code" href="struct__FolderPerm.html#a1d44107695fb128bdc7de3a224a69d42">path</a> = canonical_perm_path (str);
<a name="l01017"></a>01017 
<a name="l01018"></a>01018         member = json_object_get (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;permission&quot;</span>);
<a name="l01019"></a>01019         <span class="keywordflow">if</span> (!member) {
<a name="l01020"></a>01020             seaf_warning (<span class="stringliteral">&quot;Invalid folder perm response format: no permission.\n&quot;</span>);
<a name="l01021"></a>01021             *error = TRUE;
<a name="l01022"></a>01022             <span class="keywordflow">goto</span> out;
<a name="l01023"></a>01023         }
<a name="l01024"></a>01024         str = json_string_value(member);
<a name="l01025"></a>01025         <span class="keywordflow">if</span> (!str) {
<a name="l01026"></a>01026             seaf_warning (<span class="stringliteral">&quot;Invalid folder perm response format: invalid permission.\n&quot;</span>);
<a name="l01027"></a>01027             *error = TRUE;
<a name="l01028"></a>01028             <span class="keywordflow">goto</span> out;
<a name="l01029"></a>01029         }
<a name="l01030"></a>01030         perm-&gt;<a class="code" href="struct__FolderPerm.html#a5032277d09756796f0d26e373383dac6">permission</a> = g_strdup(str);
<a name="l01031"></a>01031 
<a name="l01032"></a>01032         ret = g_list_append (ret, perm);
<a name="l01033"></a>01033     }
<a name="l01034"></a>01034 
<a name="l01035"></a>01035 out:
<a name="l01036"></a>01036     <span class="keywordflow">if</span> (*error) {
<a name="l01037"></a>01037         <span class="keywordflow">for</span> (ptr = ret; ptr; ptr = ptr-&gt;next)
<a name="l01038"></a>01038             <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a16e4a5db024bcc5baf2ef8a3f0623a41">folder_perm_free</a> ((<a class="code" href="struct__FolderPerm.html">FolderPerm</a> *)ptr-&gt;data);
<a name="l01039"></a>01039         g_list_free (ret);
<a name="l01040"></a>01040         ret = NULL;
<a name="l01041"></a>01041     }
<a name="l01042"></a>01042 
<a name="l01043"></a>01043     <span class="keywordflow">return</span> ret;
<a name="l01044"></a>01044 }
<a name="l01045"></a>01045 
<a name="l01046"></a>01046 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01047"></a>01047 parse_folder_perms (<span class="keyword">const</span> <span class="keywordtype">char</span> *rsp_content, <span class="keywordtype">int</span> rsp_size, <a class="code" href="structGetFolderPermsData.html">GetFolderPermsData</a> *data)
<a name="l01048"></a>01048 {
<a name="l01049"></a>01049     json_t *array = NULL, *object, *member;
<a name="l01050"></a>01050     json_error_t jerror;
<a name="l01051"></a>01051     <span class="keywordtype">size_t</span> n;
<a name="l01052"></a>01052     <span class="keywordtype">int</span> i;
<a name="l01053"></a>01053     GList *results = NULL, *ptr;
<a name="l01054"></a>01054     <a class="code" href="struct__HttpFolderPermRes.html">HttpFolderPermRes</a> *res;
<a name="l01055"></a>01055     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id;
<a name="l01056"></a>01056     <span class="keywordtype">int</span> ret = 0;
<a name="l01057"></a>01057     gboolean error;
<a name="l01058"></a>01058 
<a name="l01059"></a>01059     array = json_loadb (rsp_content, rsp_size, 0, &amp;jerror);
<a name="l01060"></a>01060     <span class="keywordflow">if</span> (!array) {
<a name="l01061"></a>01061         seaf_warning (<span class="stringliteral">&quot;Parse response failed: %s.\n&quot;</span>, jerror.text);
<a name="l01062"></a>01062         <span class="keywordflow">return</span> -1;
<a name="l01063"></a>01063     }
<a name="l01064"></a>01064 
<a name="l01065"></a>01065     n = json_array_size (array);
<a name="l01066"></a>01066     <span class="keywordflow">for</span> (i = 0; i &lt; n; ++i) {
<a name="l01067"></a>01067         <span class="keywordtype">object</span> = json_array_get (array, i);
<a name="l01068"></a>01068 
<a name="l01069"></a>01069         res = g_new0 (<a class="code" href="struct__HttpFolderPermRes.html">HttpFolderPermRes</a>, 1);
<a name="l01070"></a>01070 
<a name="l01071"></a>01071         member = json_object_get (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;repo_id&quot;</span>);
<a name="l01072"></a>01072         <span class="keywordflow">if</span> (!member) {
<a name="l01073"></a>01073             seaf_warning (<span class="stringliteral">&quot;Invalid folder perm response format: no repo_id.\n&quot;</span>);
<a name="l01074"></a>01074             ret = -1;
<a name="l01075"></a>01075             <span class="keywordflow">goto</span> out;
<a name="l01076"></a>01076         }
<a name="l01077"></a>01077         repo_id = json_string_value(member);
<a name="l01078"></a>01078         <span class="keywordflow">if</span> (strlen(repo_id) != 36) {
<a name="l01079"></a>01079             seaf_warning (<span class="stringliteral">&quot;Invalid folder perm response format: invalid repo_id.\n&quot;</span>);
<a name="l01080"></a>01080             ret = -1;
<a name="l01081"></a>01081             <span class="keywordflow">goto</span> out;
<a name="l01082"></a>01082         }
<a name="l01083"></a>01083         memcpy (res-&gt;<a class="code" href="struct__HttpFolderPermRes.html#a5494ec0e4cf8755ccc3a7b5695622de0">repo_id</a>, repo_id, 36);
<a name="l01084"></a>01084  
<a name="l01085"></a>01085         member = json_object_get (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;ts&quot;</span>);
<a name="l01086"></a>01086         <span class="keywordflow">if</span> (!member) {
<a name="l01087"></a>01087             seaf_warning (<span class="stringliteral">&quot;Invalid folder perm response format: no timestamp.\n&quot;</span>);
<a name="l01088"></a>01088             ret = -1;
<a name="l01089"></a>01089             <span class="keywordflow">goto</span> out;
<a name="l01090"></a>01090         }
<a name="l01091"></a>01091         res-&gt;<a class="code" href="struct__HttpFolderPermRes.html#a677f775892b98905ea3cacfa9454e8a0">timestamp</a> = json_integer_value (member);
<a name="l01092"></a>01092 
<a name="l01093"></a>01093         member = json_object_get (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;user_perms&quot;</span>);
<a name="l01094"></a>01094         <span class="keywordflow">if</span> (!member) {
<a name="l01095"></a>01095             seaf_warning (<span class="stringliteral">&quot;Invalid folder perm response format: no user_perms.\n&quot;</span>);
<a name="l01096"></a>01096             ret = -1;
<a name="l01097"></a>01097             <span class="keywordflow">goto</span> out;
<a name="l01098"></a>01098         }
<a name="l01099"></a>01099         res-&gt;<a class="code" href="struct__HttpFolderPermRes.html#a02929f1af633e277256696ffc7ec3220">user_perms</a> = parse_permission_list (member, &amp;error);
<a name="l01100"></a>01100         <span class="keywordflow">if</span> (error) {
<a name="l01101"></a>01101             ret = -1;
<a name="l01102"></a>01102             <span class="keywordflow">goto</span> out;
<a name="l01103"></a>01103         }
<a name="l01104"></a>01104 
<a name="l01105"></a>01105         member = json_object_get (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;group_perms&quot;</span>);
<a name="l01106"></a>01106         <span class="keywordflow">if</span> (!member) {
<a name="l01107"></a>01107             seaf_warning (<span class="stringliteral">&quot;Invalid folder perm response format: no group_perms.\n&quot;</span>);
<a name="l01108"></a>01108             ret = -1;
<a name="l01109"></a>01109             <span class="keywordflow">goto</span> out;
<a name="l01110"></a>01110         }
<a name="l01111"></a>01111         res-&gt;<a class="code" href="struct__HttpFolderPermRes.html#a739b8d7b0272f8a9a59bced0f202b533">group_perms</a> = parse_permission_list (member, &amp;error);
<a name="l01112"></a>01112         <span class="keywordflow">if</span> (error) {
<a name="l01113"></a>01113             ret = -1;
<a name="l01114"></a>01114             <span class="keywordflow">goto</span> out;
<a name="l01115"></a>01115         }
<a name="l01116"></a>01116 
<a name="l01117"></a>01117         results = g_list_append (results, res);
<a name="l01118"></a>01118     }
<a name="l01119"></a>01119 
<a name="l01120"></a>01120 out:
<a name="l01121"></a>01121     json_decref (array);
<a name="l01122"></a>01122 
<a name="l01123"></a>01123     <span class="keywordflow">if</span> (ret &lt; 0) {
<a name="l01124"></a>01124         <span class="keywordflow">for</span> (ptr = results; ptr; ptr = ptr-&gt;next)
<a name="l01125"></a>01125             <a class="code" href="http-tx-mgr_8c.html#a24ed975a3f91c154ee960c03edeb05e1">http_folder_perm_res_free</a> ((<a class="code" href="struct__HttpFolderPermRes.html">HttpFolderPermRes</a> *)ptr-&gt;data);
<a name="l01126"></a>01126         g_list_free (results);
<a name="l01127"></a>01127     } <span class="keywordflow">else</span>
<a name="l01128"></a>01128         data-&gt;<a class="code" href="structGetFolderPermsData.html#a8367f60af018e6dfcb5e7c9a224a5375">results</a> = results;
<a name="l01129"></a>01129 
<a name="l01130"></a>01130     <span class="keywordflow">return</span> ret;
<a name="l01131"></a>01131 }
<a name="l01132"></a>01132 
<a name="l01133"></a>01133 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l01134"></a>01134 compose_get_folder_perms_request (GList *requests)
<a name="l01135"></a>01135 {
<a name="l01136"></a>01136     GList *ptr;
<a name="l01137"></a>01137     <a class="code" href="struct__HttpFolderPermReq.html">HttpFolderPermReq</a> *req;
<a name="l01138"></a>01138     json_t *object, *array;
<a name="l01139"></a>01139     <span class="keywordtype">char</span> *req_str = NULL;
<a name="l01140"></a>01140 
<a name="l01141"></a>01141     array = json_array ();
<a name="l01142"></a>01142 
<a name="l01143"></a>01143     <span class="keywordflow">for</span> (ptr = requests; ptr; ptr = ptr-&gt;next) {
<a name="l01144"></a>01144         req = ptr-&gt;data;
<a name="l01145"></a>01145 
<a name="l01146"></a>01146         <span class="keywordtype">object</span> = json_object ();
<a name="l01147"></a>01147         json_object_set_new (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;repo_id&quot;</span>, json_string(req-&gt;<a class="code" href="struct__HttpFolderPermReq.html#ac1e67df051ff5a1a9c41488633b842e1">repo_id</a>));
<a name="l01148"></a>01148         json_object_set_new (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;token&quot;</span>, json_string(req-&gt;<a class="code" href="struct__HttpFolderPermReq.html#aa33db724e9d1c9b0f37cbd297ed76063">token</a>));
<a name="l01149"></a>01149         json_object_set_new (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;ts&quot;</span>, json_integer(req-&gt;<a class="code" href="struct__HttpFolderPermReq.html#ae33fa9e631483b84321249871cff9a03">timestamp</a>));
<a name="l01150"></a>01150 
<a name="l01151"></a>01151         json_array_append_new (array, <span class="keywordtype">object</span>);
<a name="l01152"></a>01152     }
<a name="l01153"></a>01153 
<a name="l01154"></a>01154     req_str = json_dumps (array, 0);
<a name="l01155"></a>01155     <span class="keywordflow">if</span> (!req_str) {
<a name="l01156"></a>01156         seaf_warning (<span class="stringliteral">&quot;Faile to json_dumps.\n&quot;</span>);
<a name="l01157"></a>01157     }
<a name="l01158"></a>01158 
<a name="l01159"></a>01159     json_decref (array);
<a name="l01160"></a>01160     <span class="keywordflow">return</span> req_str;
<a name="l01161"></a>01161 }
<a name="l01162"></a>01162 
<a name="l01163"></a>01163 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l01164"></a>01164 get_folder_perms_thread (<span class="keywordtype">void</span> *vdata)
<a name="l01165"></a>01165 {
<a name="l01166"></a>01166     <a class="code" href="structGetFolderPermsData.html">GetFolderPermsData</a> *data = vdata;
<a name="l01167"></a>01167     <a class="code" href="struct__HttpTxPriv.html">HttpTxPriv</a> *priv = <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>-&gt;<a class="code" href="struct__HttpTxManager.html#a3e124361f6d9812dd9e4fb15e7ea41e7">priv</a>;
<a name="l01168"></a>01168     <a class="code" href="struct__ConnectionPool.html">ConnectionPool</a> *pool;
<a name="l01169"></a>01169     <a class="code" href="struct__Connection.html">Connection</a> *conn;
<a name="l01170"></a>01170     CURL *curl;
<a name="l01171"></a>01171     <span class="keywordtype">char</span> *url;
<a name="l01172"></a>01172     <span class="keywordtype">char</span> *req_content = NULL;
<a name="l01173"></a>01173     <span class="keywordtype">int</span> <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l01174"></a>01174     <span class="keywordtype">char</span> *rsp_content = NULL;
<a name="l01175"></a>01175     gint64 rsp_size;
<a name="l01176"></a>01176     GList *ptr;
<a name="l01177"></a>01177 
<a name="l01178"></a>01178     pool = find_connection_pool (priv, data-&gt;<a class="code" href="structGetFolderPermsData.html#a72d431889ce1b64a3c3d90d92f8ae2ff">host</a>);
<a name="l01179"></a>01179     <span class="keywordflow">if</span> (!pool) {
<a name="l01180"></a>01180         seaf_warning (<span class="stringliteral">&quot;Failed to create connection pool for host %s.\n&quot;</span>, data-&gt;<a class="code" href="structGetFolderPermsData.html#a72d431889ce1b64a3c3d90d92f8ae2ff">host</a>);
<a name="l01181"></a>01181         <span class="keywordflow">return</span> vdata;
<a name="l01182"></a>01182     }
<a name="l01183"></a>01183 
<a name="l01184"></a>01184     conn = connection_pool_get_connection (pool);
<a name="l01185"></a>01185     <span class="keywordflow">if</span> (!conn) {
<a name="l01186"></a>01186         seaf_warning (<span class="stringliteral">&quot;Failed to get connection to host %s.\n&quot;</span>, data-&gt;<a class="code" href="structGetFolderPermsData.html#a72d431889ce1b64a3c3d90d92f8ae2ff">host</a>);
<a name="l01187"></a>01187         <span class="keywordflow">return</span> vdata;
<a name="l01188"></a>01188     }
<a name="l01189"></a>01189 
<a name="l01190"></a>01190     curl = conn-&gt;<a class="code" href="struct__Connection.html#af8b983fae165a24c7f9cc24e47361d57">curl</a>;
<a name="l01191"></a>01191 
<a name="l01192"></a>01192     url = g_strdup_printf (<span class="stringliteral">&quot;%s/seafhttp/repo/folder-perm&quot;</span>, data-&gt;<a class="code" href="structGetFolderPermsData.html#a72d431889ce1b64a3c3d90d92f8ae2ff">host</a>);
<a name="l01193"></a>01193 
<a name="l01194"></a>01194     req_content = compose_get_folder_perms_request (data-&gt;<a class="code" href="structGetFolderPermsData.html#a2d5b8cf445f884d3da214f8382b20eae">requests</a>);
<a name="l01195"></a>01195     <span class="keywordflow">if</span> (!req_content)
<a name="l01196"></a>01196         <span class="keywordflow">goto</span> out;
<a name="l01197"></a>01197 
<a name="l01198"></a>01198     <span class="keywordflow">if</span> (http_post (curl, url, NULL, req_content, strlen(req_content),
<a name="l01199"></a>01199                    &amp;status, &amp;rsp_content, &amp;rsp_size) &lt; 0)
<a name="l01200"></a>01200         <span class="keywordflow">goto</span> out;
<a name="l01201"></a>01201 
<a name="l01202"></a>01202     <span class="keywordflow">if</span> (status == <a class="code" href="http-tx-mgr_8c.html#a02e6d59009dee759528ec81fc9a8eeff">HTTP_OK</a>) {
<a name="l01203"></a>01203         <span class="keywordflow">if</span> (parse_folder_perms (rsp_content, rsp_size, data) &lt; 0)
<a name="l01204"></a>01204             <span class="keywordflow">goto</span> out;
<a name="l01205"></a>01205         data-&gt;<a class="code" href="structGetFolderPermsData.html#a5a5820cfad01ddc3c60d651731ffa0b8">success</a> = TRUE;
<a name="l01206"></a>01206     } <span class="keywordflow">else</span> {
<a name="l01207"></a>01207         seaf_warning (<span class="stringliteral">&quot;Bad response code for GET %s: %d.\n&quot;</span>, url, status);
<a name="l01208"></a>01208     }
<a name="l01209"></a>01209 
<a name="l01210"></a>01210 out:
<a name="l01211"></a>01211     <span class="keywordflow">for</span> (ptr = data-&gt;<a class="code" href="structGetFolderPermsData.html#a2d5b8cf445f884d3da214f8382b20eae">requests</a>; ptr; ptr = ptr-&gt;next)
<a name="l01212"></a>01212         <a class="code" href="http-tx-mgr_8c.html#a66ce748eeb3d6bdd5213772d5d5e3898">http_folder_perm_req_free</a> ((<a class="code" href="struct__HttpFolderPermReq.html">HttpFolderPermReq</a> *)ptr-&gt;data);
<a name="l01213"></a>01213     g_list_free (data-&gt;<a class="code" href="structGetFolderPermsData.html#a2d5b8cf445f884d3da214f8382b20eae">requests</a>);
<a name="l01214"></a>01214 
<a name="l01215"></a>01215     g_free (url);
<a name="l01216"></a>01216     g_free (req_content);
<a name="l01217"></a>01217     g_free (rsp_content);
<a name="l01218"></a>01218     connection_pool_return_connection (pool, conn);
<a name="l01219"></a>01219     <span class="keywordflow">return</span> vdata;
<a name="l01220"></a>01220 }
<a name="l01221"></a>01221 
<a name="l01222"></a>01222 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01223"></a>01223 get_folder_perms_done (<span class="keywordtype">void</span> *vdata)
<a name="l01224"></a>01224 {
<a name="l01225"></a>01225     <a class="code" href="structGetFolderPermsData.html">GetFolderPermsData</a> *data = vdata;
<a name="l01226"></a>01226     <a class="code" href="struct__HttpFolderPerms.html">HttpFolderPerms</a> cb_data;
<a name="l01227"></a>01227 
<a name="l01228"></a>01228     memset (&amp;cb_data, 0, <span class="keyword">sizeof</span>(cb_data));
<a name="l01229"></a>01229     cb_data.<a class="code" href="struct__HttpFolderPerms.html#a9379fb92d03bba941e2769bf9b7eb7da">success</a> = data-&gt;<a class="code" href="structGetFolderPermsData.html#a5a5820cfad01ddc3c60d651731ffa0b8">success</a>;
<a name="l01230"></a>01230     cb_data.<a class="code" href="struct__HttpFolderPerms.html#ae86a1a8d2d956bf938be35e1fc4d4a9f">results</a> = data-&gt;<a class="code" href="structGetFolderPermsData.html#a8367f60af018e6dfcb5e7c9a224a5375">results</a>;
<a name="l01231"></a>01231 
<a name="l01232"></a>01232     data-&gt;<a class="code" href="structGetFolderPermsData.html#a31d36185f257a4f8acec1b29212d6f11">callback</a> (&amp;cb_data, data-&gt;<a class="code" href="structGetFolderPermsData.html#a6686f4e3da2c44730bc7fa160efdcc40">user_data</a>);
<a name="l01233"></a>01233 
<a name="l01234"></a>01234     GList *ptr;
<a name="l01235"></a>01235     <span class="keywordflow">for</span> (ptr = data-&gt;<a class="code" href="structGetFolderPermsData.html#a8367f60af018e6dfcb5e7c9a224a5375">results</a>; ptr; ptr = ptr-&gt;next)
<a name="l01236"></a>01236         <a class="code" href="http-tx-mgr_8c.html#a24ed975a3f91c154ee960c03edeb05e1">http_folder_perm_res_free</a> ((<a class="code" href="struct__HttpFolderPermRes.html">HttpFolderPermRes</a> *)ptr-&gt;data);
<a name="l01237"></a>01237     g_list_free (data-&gt;<a class="code" href="structGetFolderPermsData.html#a8367f60af018e6dfcb5e7c9a224a5375">results</a>);
<a name="l01238"></a>01238 
<a name="l01239"></a>01239     g_free (data-&gt;<a class="code" href="structGetFolderPermsData.html#a72d431889ce1b64a3c3d90d92f8ae2ff">host</a>);
<a name="l01240"></a>01240     g_free (data);
<a name="l01241"></a>01241 }
<a name="l01242"></a>01242 
<a name="l01243"></a>01243 <span class="keywordtype">int</span>
<a name="l01244"></a><a class="code" href="http-tx-mgr_8h.html#a24eb2fd0df4be5e88734649f6ff73fc3">01244</a> <a class="code" href="http-tx-mgr_8c.html#a24eb2fd0df4be5e88734649f6ff73fc3">http_tx_manager_get_folder_perms</a> (<a class="code" href="struct__HttpTxManager.html">HttpTxManager</a> *manager,
<a name="l01245"></a>01245                                   <span class="keyword">const</span> <span class="keywordtype">char</span> *host,
<a name="l01246"></a>01246                                   GList *folder_perm_requests,
<a name="l01247"></a>01247                                   <a class="code" href="http-tx-mgr_8h.html#a286ab36a4faf202f3a3969625e77be21">HttpGetFolderPermsCallback</a> callback,
<a name="l01248"></a>01248                                   <span class="keywordtype">void</span> *user_data)
<a name="l01249"></a>01249 {
<a name="l01250"></a>01250     <a class="code" href="structGetFolderPermsData.html">GetFolderPermsData</a> *data = g_new0 (<a class="code" href="structGetFolderPermsData.html">GetFolderPermsData</a>, 1);
<a name="l01251"></a>01251 
<a name="l01252"></a>01252     data-&gt;<a class="code" href="structGetFolderPermsData.html#a72d431889ce1b64a3c3d90d92f8ae2ff">host</a> = g_strdup(host);
<a name="l01253"></a>01253     data-&gt;<a class="code" href="structGetFolderPermsData.html#a2d5b8cf445f884d3da214f8382b20eae">requests</a> = folder_perm_requests;
<a name="l01254"></a>01254     data-&gt;<a class="code" href="structGetFolderPermsData.html#a31d36185f257a4f8acec1b29212d6f11">callback</a> = callback;
<a name="l01255"></a>01255     data-&gt;<a class="code" href="structGetFolderPermsData.html#a6686f4e3da2c44730bc7fa160efdcc40">user_data</a> = user_data;
<a name="l01256"></a>01256 
<a name="l01257"></a>01257     <a class="code" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768">ccnet_job_manager_schedule_job</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#abcbb9886e315abb16c620ce49808a0b2">job_mgr</a>,
<a name="l01258"></a>01258                                     get_folder_perms_thread,
<a name="l01259"></a>01259                                     get_folder_perms_done,
<a name="l01260"></a>01260                                     data);
<a name="l01261"></a>01261 
<a name="l01262"></a>01262     <span class="keywordflow">return</span> 0;
<a name="l01263"></a>01263 }
<a name="l01264"></a>01264 
<a name="l01265"></a>01265 <span class="keyword">static</span> gboolean
<a name="l01266"></a>01266 remove_task_help (gpointer key, gpointer value, gpointer user_data)
<a name="l01267"></a>01267 {
<a name="l01268"></a>01268     <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task = value;
<a name="l01269"></a>01269     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id = user_data;
<a name="l01270"></a>01270 
<a name="l01271"></a>01271     <span class="keywordflow">if</span> (strcmp(task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, repo_id) != 0)
<a name="l01272"></a>01272         <span class="keywordflow">return</span> FALSE;
<a name="l01273"></a>01273 
<a name="l01274"></a>01274     <span class="keywordflow">return</span> TRUE;
<a name="l01275"></a>01275 }
<a name="l01276"></a>01276 
<a name="l01277"></a>01277 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01278"></a>01278 clean_tasks_for_repo (<a class="code" href="struct__HttpTxManager.html">HttpTxManager</a> *manager, <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l01279"></a>01279 {
<a name="l01280"></a>01280     g_hash_table_foreach_remove (manager-&gt;<a class="code" href="struct__HttpTxManager.html#a3e124361f6d9812dd9e4fb15e7ea41e7">priv</a>-&gt;<a class="code" href="struct__HttpTxPriv.html#a054e2539c8af97620bcc0ab412398edf">download_tasks</a>,
<a name="l01281"></a>01281                                  remove_task_help, (gpointer)repo_id);
<a name="l01282"></a>01282 
<a name="l01283"></a>01283     g_hash_table_foreach_remove (manager-&gt;<a class="code" href="struct__HttpTxManager.html#a3e124361f6d9812dd9e4fb15e7ea41e7">priv</a>-&gt;<a class="code" href="struct__HttpTxPriv.html#a791e15c45420b177bfc87284015ac9db">upload_tasks</a>,
<a name="l01284"></a>01284                                  remove_task_help, (gpointer)repo_id);
<a name="l01285"></a>01285 }
<a name="l01286"></a>01286 
<a name="l01287"></a>01287 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01288"></a>01288 check_permission (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task, <a class="code" href="struct__Connection.html">Connection</a> *conn)
<a name="l01289"></a>01289 {
<a name="l01290"></a>01290     CURL *curl;
<a name="l01291"></a>01291     <span class="keywordtype">char</span> *url;
<a name="l01292"></a>01292     <span class="keywordtype">int</span> <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l01293"></a>01293     <span class="keywordtype">int</span> ret = 0;
<a name="l01294"></a>01294 
<a name="l01295"></a>01295     curl = conn-&gt;<a class="code" href="struct__Connection.html#af8b983fae165a24c7f9cc24e47361d57">curl</a>;
<a name="l01296"></a>01296 
<a name="l01297"></a>01297     <span class="keyword">const</span> <span class="keywordtype">char</span> *type = (task-&gt;<a class="code" href="struct__HttpTxTask.html#ad954a300aab26e22dcd2100b2c5e248a">type</a> == <a class="code" href="http-tx-mgr_8h.html#a16af7b253440dadd46a80a4b9fddba4da429731c6953f215203cf1b17fe92ebb1">HTTP_TASK_TYPE_DOWNLOAD</a>) ? <span class="stringliteral">&quot;download&quot;</span> : <span class="stringliteral">&quot;upload&quot;</span>;
<a name="l01298"></a>01298     <span class="keywordflow">if</span> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a7acba9a9723ea082afbcd1032be5b6de">base</a>.<a class="code" href="struct__CcnetSessionBase.html#a5cad88a662d2134e070e89d402810b8c">name</a>)
<a name="l01299"></a>01299         url = g_strdup_printf (<span class="stringliteral">&quot;%s/seafhttp/repo/%s/permission-check/?op=%s&quot;</span>
<a name="l01300"></a>01300                                <span class="stringliteral">&quot;&amp;client_id=%s&amp;client_name=%s&quot;</span>,
<a name="l01301"></a>01301                                task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, type,
<a name="l01302"></a>01302                                <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a7acba9a9723ea082afbcd1032be5b6de">base</a>.<a class="code" href="struct__CcnetSessionBase.html#a00a892cc14aa52514c079730b460852e">id</a>, <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a7acba9a9723ea082afbcd1032be5b6de">base</a>.<a class="code" href="struct__CcnetSessionBase.html#a5cad88a662d2134e070e89d402810b8c">name</a>);
<a name="l01303"></a>01303     <span class="keywordflow">else</span>
<a name="l01304"></a>01304         url = g_strdup_printf (<span class="stringliteral">&quot;%s/seafhttp/repo/%s/permission-check/?op=%s&quot;</span>,
<a name="l01305"></a>01305                                task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, type);
<a name="l01306"></a>01306 
<a name="l01307"></a>01307     <span class="keywordflow">if</span> (http_get (curl, url, task-&gt;<a class="code" href="struct__HttpTxTask.html#a7efdacb9425ad03ba280b6435b0e6ba6">token</a>, &amp;status, NULL, NULL, NULL, NULL) &lt; 0) {
<a name="l01308"></a>01308         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159acf2d300b20f69c681bb82b34900a54f6">HTTP_TASK_ERR_NET</a>;
<a name="l01309"></a>01309         ret = -1;
<a name="l01310"></a>01310         <span class="keywordflow">goto</span> out;
<a name="l01311"></a>01311     }
<a name="l01312"></a>01312 
<a name="l01313"></a>01313     <span class="keywordflow">if</span> (status != <a class="code" href="http-tx-mgr_8c.html#a02e6d59009dee759528ec81fc9a8eeff">HTTP_OK</a>) {
<a name="l01314"></a>01314         seaf_warning (<span class="stringliteral">&quot;Bad response code for GET %s: %d.\n&quot;</span>, url, status);
<a name="l01315"></a>01315         handle_http_errors (task, status);
<a name="l01316"></a>01316         ret = -1;
<a name="l01317"></a>01317     }
<a name="l01318"></a>01318 
<a name="l01319"></a>01319 out:
<a name="l01320"></a>01320     g_free (url);
<a name="l01321"></a>01321     curl_easy_reset (curl);
<a name="l01322"></a>01322 
<a name="l01323"></a>01323     <span class="keywordflow">return</span> ret;
<a name="l01324"></a>01324 }
<a name="l01325"></a>01325 
<a name="l01326"></a>01326 <span class="comment">/* Upload. */</span>
<a name="l01327"></a>01327 
<a name="l01328"></a>01328 <span class="keyword">static</span> <span class="keywordtype">void</span> *http_upload_thread (<span class="keywordtype">void</span> *vdata);
<a name="l01329"></a>01329 <span class="keyword">static</span> <span class="keywordtype">void</span> http_upload_done (<span class="keywordtype">void</span> *vdata);
<a name="l01330"></a>01330 
<a name="l01331"></a>01331 <span class="keywordtype">int</span>
<a name="l01332"></a><a class="code" href="http-tx-mgr_8h.html#a585b7bf53556be4ced268b966dd11fd2">01332</a> <a class="code" href="http-tx-mgr_8c.html#a585b7bf53556be4ced268b966dd11fd2">http_tx_manager_add_upload</a> (<a class="code" href="struct__HttpTxManager.html">HttpTxManager</a> *manager,
<a name="l01333"></a>01333                             <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l01334"></a>01334                             <span class="keywordtype">int</span> repo_version,
<a name="l01335"></a>01335                             <span class="keyword">const</span> <span class="keywordtype">char</span> *host,
<a name="l01336"></a>01336                             <span class="keyword">const</span> <span class="keywordtype">char</span> *token,
<a name="l01337"></a>01337                             <span class="keywordtype">int</span> protocol_version,
<a name="l01338"></a>01338                             GError **error)
<a name="l01339"></a>01339 {
<a name="l01340"></a>01340     <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task;
<a name="l01341"></a>01341     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l01342"></a>01342 
<a name="l01343"></a>01343     <span class="keywordflow">if</span> (!repo_id || !token || !host) {
<a name="l01344"></a>01344         g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Empty argument(s)&quot;</span>);
<a name="l01345"></a>01345         <span class="keywordflow">return</span> -1;
<a name="l01346"></a>01346     }
<a name="l01347"></a>01347 
<a name="l01348"></a>01348     repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id);
<a name="l01349"></a>01349     <span class="keywordflow">if</span> (!repo) {
<a name="l01350"></a>01350         g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Repo not found&quot;</span>);
<a name="l01351"></a>01351         <span class="keywordflow">return</span> -1;
<a name="l01352"></a>01352     }
<a name="l01353"></a>01353 
<a name="l01354"></a>01354     clean_tasks_for_repo (manager, repo_id);
<a name="l01355"></a>01355 
<a name="l01356"></a>01356     task = http_tx_task_new (manager, repo_id, repo_version,
<a name="l01357"></a>01357                              <a class="code" href="http-tx-mgr_8h.html#a16af7b253440dadd46a80a4b9fddba4da138a1036827f5836bd8e372ebe2aad95">HTTP_TASK_TYPE_UPLOAD</a>, FALSE,
<a name="l01358"></a>01358                              host, token, NULL, NULL);
<a name="l01359"></a>01359 
<a name="l01360"></a>01360     task-&gt;<a class="code" href="struct__HttpTxTask.html#a6445d889b66d46f624a8ce480792f5f0">protocol_version</a> = protocol_version;
<a name="l01361"></a>01361 
<a name="l01362"></a>01362     task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> = <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceac3efc29c1793f3f902e002589c600b33">TASK_STATE_NORMAL</a>;
<a name="l01363"></a>01363 
<a name="l01364"></a>01364     g_hash_table_insert (manager-&gt;<a class="code" href="struct__HttpTxManager.html#a3e124361f6d9812dd9e4fb15e7ea41e7">priv</a>-&gt;<a class="code" href="struct__HttpTxPriv.html#a791e15c45420b177bfc87284015ac9db">upload_tasks</a>,
<a name="l01365"></a>01365                          g_strdup(repo_id),
<a name="l01366"></a>01366                          task);
<a name="l01367"></a>01367 
<a name="l01368"></a>01368     <a class="code" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768">ccnet_job_manager_schedule_job</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#abcbb9886e315abb16c620ce49808a0b2">job_mgr</a>,
<a name="l01369"></a>01369                                     http_upload_thread,
<a name="l01370"></a>01370                                     http_upload_done,
<a name="l01371"></a>01371                                     task);
<a name="l01372"></a>01372 
<a name="l01373"></a>01373     <span class="keywordflow">return</span> 0;
<a name="l01374"></a>01374 }
<a name="l01375"></a>01375 
<a name="l01376"></a><a class="code" href="structCalcQuotaDeltaData.html">01376</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l01377"></a><a class="code" href="structCalcQuotaDeltaData.html#aa54f44d6a8ee9d0143b20329a2b37df7">01377</a>     <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *<a class="code" href="structCalcQuotaDeltaData.html#aa54f44d6a8ee9d0143b20329a2b37df7">task</a>;
<a name="l01378"></a><a class="code" href="structCalcQuotaDeltaData.html#a69af6f954176ed99ae5c331d7cf9e95b">01378</a>     gint64 <a class="code" href="structCalcQuotaDeltaData.html#a69af6f954176ed99ae5c331d7cf9e95b">delta</a>;
<a name="l01379"></a>01379 } <a class="code" href="structCalcQuotaDeltaData.html">CalcQuotaDeltaData</a>;
<a name="l01380"></a>01380 
<a name="l01381"></a>01381 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01382"></a>01382 check_quota_diff_files (<span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">char</span> *basedir, <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *files[], <span class="keywordtype">void</span> *vdata)
<a name="l01383"></a>01383 {
<a name="l01384"></a>01384     <a class="code" href="structCalcQuotaDeltaData.html">CalcQuotaDeltaData</a> *data = vdata;
<a name="l01385"></a>01385     <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *file1 = files[0];
<a name="l01386"></a>01386     <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *file2 = files[1];
<a name="l01387"></a>01387     gint64 size1, size2;
<a name="l01388"></a>01388 
<a name="l01389"></a>01389     <span class="keywordflow">if</span> (file1 &amp;&amp; file2) {
<a name="l01390"></a>01390         size1 = file1-&gt;<a class="code" href="struct__SeafDirent.html#abf0e9b6fade594b7897cb9896d370961">size</a>;
<a name="l01391"></a>01391         size2 = file2-&gt;<a class="code" href="struct__SeafDirent.html#abf0e9b6fade594b7897cb9896d370961">size</a>;
<a name="l01392"></a>01392         data-&gt;<a class="code" href="structCalcQuotaDeltaData.html#a69af6f954176ed99ae5c331d7cf9e95b">delta</a> += (size1 - size2);
<a name="l01393"></a>01393     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (file1 &amp;&amp; !file2) {
<a name="l01394"></a>01394         data-&gt;<a class="code" href="structCalcQuotaDeltaData.html#a69af6f954176ed99ae5c331d7cf9e95b">delta</a> += file1-&gt;<a class="code" href="struct__SeafDirent.html#abf0e9b6fade594b7897cb9896d370961">size</a>;
<a name="l01395"></a>01395     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!file1 &amp;&amp; file2) {
<a name="l01396"></a>01396         data-&gt;<a class="code" href="structCalcQuotaDeltaData.html#a69af6f954176ed99ae5c331d7cf9e95b">delta</a> -= file2-&gt;<a class="code" href="struct__SeafDirent.html#abf0e9b6fade594b7897cb9896d370961">size</a>;
<a name="l01397"></a>01397     }
<a name="l01398"></a>01398 
<a name="l01399"></a>01399     <span class="keywordflow">return</span> 0;
<a name="l01400"></a>01400 }
<a name="l01401"></a>01401 
<a name="l01402"></a>01402 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01403"></a>01403 check_quota_diff_dirs (<span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">char</span> *basedir, <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *dirs[], <span class="keywordtype">void</span> *data,
<a name="l01404"></a>01404                        gboolean *recurse)
<a name="l01405"></a>01405 {
<a name="l01406"></a>01406     <span class="comment">/* Do nothing */</span>
<a name="l01407"></a>01407     <span class="keywordflow">return</span> 0;
<a name="l01408"></a>01408 }
<a name="l01409"></a>01409 
<a name="l01410"></a>01410 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01411"></a>01411 calculate_upload_size_delta (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task, gint64 *delta)
<a name="l01412"></a>01412 {
<a name="l01413"></a>01413     <span class="keywordtype">int</span> ret = 0;
<a name="l01414"></a>01414     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *local = NULL, *master = NULL;
<a name="l01415"></a>01415     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *local_head = NULL, *master_head = NULL;
<a name="l01416"></a>01416 
<a name="l01417"></a>01417     local = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, <span class="stringliteral">&quot;local&quot;</span>);
<a name="l01418"></a>01418     <span class="keywordflow">if</span> (!local) {
<a name="l01419"></a>01419         seaf_warning (<span class="stringliteral">&quot;Branch local not found for repo %.8s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l01420"></a>01420         ret = -1;
<a name="l01421"></a>01421         <span class="keywordflow">goto</span> out;
<a name="l01422"></a>01422     }
<a name="l01423"></a>01423     master = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, <span class="stringliteral">&quot;master&quot;</span>);
<a name="l01424"></a>01424     <span class="keywordflow">if</span> (!master) {
<a name="l01425"></a>01425         seaf_warning (<span class="stringliteral">&quot;Branch master not found for repo %.8s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l01426"></a>01426         ret = -1;
<a name="l01427"></a>01427         <span class="keywordflow">goto</span> out;
<a name="l01428"></a>01428     }
<a name="l01429"></a>01429 
<a name="l01430"></a>01430     local_head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l01431"></a>01431                                                  task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l01432"></a>01432                                                  local-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l01433"></a>01433     <span class="keywordflow">if</span> (!local_head) {
<a name="l01434"></a>01434         seaf_warning (<span class="stringliteral">&quot;Local head commit not found for repo %.8s.\n&quot;</span>,
<a name="l01435"></a>01435                       task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l01436"></a>01436         ret = -1;
<a name="l01437"></a>01437         <span class="keywordflow">goto</span> out;
<a name="l01438"></a>01438     }
<a name="l01439"></a>01439     master_head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l01440"></a>01440                                                  task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l01441"></a>01441                                                  master-&gt;commit_id);
<a name="l01442"></a>01442     <span class="keywordflow">if</span> (!master_head) {
<a name="l01443"></a>01443         seaf_warning (<span class="stringliteral">&quot;Master head commit not found for repo %.8s.\n&quot;</span>,
<a name="l01444"></a>01444                       task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l01445"></a>01445         ret = -1;
<a name="l01446"></a>01446         <span class="keywordflow">goto</span> out;
<a name="l01447"></a>01447     }
<a name="l01448"></a>01448 
<a name="l01449"></a>01449     <a class="code" href="structCalcQuotaDeltaData.html">CalcQuotaDeltaData</a> data;
<a name="l01450"></a>01450     memset (&amp;data, 0, <span class="keyword">sizeof</span>(data));
<a name="l01451"></a>01451     data.<a class="code" href="structCalcQuotaDeltaData.html#aa54f44d6a8ee9d0143b20329a2b37df7">task</a> = task;
<a name="l01452"></a>01452 
<a name="l01453"></a>01453     <a class="code" href="structDiffOptions.html">DiffOptions</a> opts;
<a name="l01454"></a>01454     memset (&amp;opts, 0, <span class="keyword">sizeof</span>(opts));
<a name="l01455"></a>01455     memcpy (opts.<a class="code" href="structDiffOptions.html#a2f9324e06d0355964eb248315056d65c">store_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, 36);
<a name="l01456"></a>01456     opts.<a class="code" href="structDiffOptions.html#a2a919ea52308ada77775f78787df38f8">version</a> = task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>;
<a name="l01457"></a>01457     opts.<a class="code" href="structDiffOptions.html#a879b904244a3b1cf5ca46b6951d068c3">file_cb</a> = check_quota_diff_files;
<a name="l01458"></a>01458     opts.<a class="code" href="structDiffOptions.html#ac522b82b0271d69292cdaa84cb545b2b">dir_cb</a> = check_quota_diff_dirs;
<a name="l01459"></a>01459     opts.<a class="code" href="structDiffOptions.html#aa922b39e312c25c075d5ed452d400b83">data</a> = &amp;data;
<a name="l01460"></a>01460 
<a name="l01461"></a>01461     <span class="keyword">const</span> <span class="keywordtype">char</span> *trees[2];
<a name="l01462"></a>01462     trees[0] = local_head-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>;
<a name="l01463"></a>01463     trees[1] = master_head-&gt;root_id;
<a name="l01464"></a>01464     <span class="keywordflow">if</span> (<a class="code" href="diff-simple_8c.html#aad681f9b9d7dbc7586efaa4cd0b254e6">diff_trees</a> (2, trees, &amp;opts) &lt; 0) {
<a name="l01465"></a>01465         seaf_warning (<span class="stringliteral">&quot;Failed to diff local and master head for repo %.8s.\n&quot;</span>,
<a name="l01466"></a>01466                       task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l01467"></a>01467         ret = -1;
<a name="l01468"></a>01468         <span class="keywordflow">goto</span> out;
<a name="l01469"></a>01469     }
<a name="l01470"></a>01470 
<a name="l01471"></a>01471     *delta = data.<a class="code" href="structCalcQuotaDeltaData.html#a69af6f954176ed99ae5c331d7cf9e95b">delta</a>;
<a name="l01472"></a>01472 
<a name="l01473"></a>01473 out:
<a name="l01474"></a>01474     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (local);
<a name="l01475"></a>01475     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (master);
<a name="l01476"></a>01476     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (local_head);
<a name="l01477"></a>01477     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (master_head);
<a name="l01478"></a>01478 
<a name="l01479"></a>01479     <span class="keywordflow">return</span> ret;
<a name="l01480"></a>01480 }
<a name="l01481"></a>01481 
<a name="l01482"></a>01482 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01483"></a>01483 check_quota (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task, <a class="code" href="struct__Connection.html">Connection</a> *conn)
<a name="l01484"></a>01484 {
<a name="l01485"></a>01485     CURL *curl;
<a name="l01486"></a>01486     <span class="keywordtype">char</span> *url;
<a name="l01487"></a>01487     <span class="keywordtype">int</span> <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l01488"></a>01488     gint64 delta = 0;
<a name="l01489"></a>01489     <span class="keywordtype">int</span> ret = 0;
<a name="l01490"></a>01490 
<a name="l01491"></a>01491     <span class="keywordflow">if</span> (calculate_upload_size_delta (task, &amp;delta) &lt; 0) {
<a name="l01492"></a>01492         seaf_warning (<span class="stringliteral">&quot;Failed to calculate upload size delta for repo %s.\n&quot;</span>,
<a name="l01493"></a>01493                       task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l01494"></a>01494         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159ab2bac951aa574b49e1d988c044eea731">HTTP_TASK_ERR_BAD_LOCAL_DATA</a>;
<a name="l01495"></a>01495         <span class="keywordflow">return</span> -1;
<a name="l01496"></a>01496     }
<a name="l01497"></a>01497 
<a name="l01498"></a>01498     curl = conn-&gt;<a class="code" href="struct__Connection.html#af8b983fae165a24c7f9cc24e47361d57">curl</a>;
<a name="l01499"></a>01499 
<a name="l01500"></a>01500     url = g_strdup_printf (<span class="stringliteral">&quot;%s/seafhttp/repo/%s/quota-check/?delta=%&quot;</span>G_GINT64_FORMAT<span class="stringliteral">&quot;&quot;</span>,
<a name="l01501"></a>01501                            task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, delta);
<a name="l01502"></a>01502 
<a name="l01503"></a>01503     <span class="keywordflow">if</span> (http_get (curl, url, task-&gt;<a class="code" href="struct__HttpTxTask.html#a7efdacb9425ad03ba280b6435b0e6ba6">token</a>, &amp;status, NULL, NULL, NULL, NULL) &lt; 0) {
<a name="l01504"></a>01504         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159acf2d300b20f69c681bb82b34900a54f6">HTTP_TASK_ERR_NET</a>;
<a name="l01505"></a>01505         ret = -1;
<a name="l01506"></a>01506         <span class="keywordflow">goto</span> out;
<a name="l01507"></a>01507     }
<a name="l01508"></a>01508 
<a name="l01509"></a>01509     <span class="keywordflow">if</span> (status != <a class="code" href="http-tx-mgr_8c.html#a02e6d59009dee759528ec81fc9a8eeff">HTTP_OK</a>) {
<a name="l01510"></a>01510         seaf_warning (<span class="stringliteral">&quot;Bad response code for GET %s: %d.\n&quot;</span>, url, status);
<a name="l01511"></a>01511         handle_http_errors (task, status);
<a name="l01512"></a>01512         ret = -1;
<a name="l01513"></a>01513     }
<a name="l01514"></a>01514 
<a name="l01515"></a>01515 out:
<a name="l01516"></a>01516     g_free (url);
<a name="l01517"></a>01517     curl_easy_reset (curl);
<a name="l01518"></a>01518 
<a name="l01519"></a>01519     <span class="keywordflow">return</span> ret;
<a name="l01520"></a>01520 }
<a name="l01521"></a>01521 
<a name="l01522"></a>01522 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01523"></a>01523 send_commit_object (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task, <a class="code" href="struct__Connection.html">Connection</a> *conn)
<a name="l01524"></a>01524 {
<a name="l01525"></a>01525     CURL *curl;
<a name="l01526"></a>01526     <span class="keywordtype">char</span> *url;
<a name="l01527"></a>01527     <span class="keywordtype">int</span> <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l01528"></a>01528     <span class="keywordtype">char</span> *data;
<a name="l01529"></a>01529     <span class="keywordtype">int</span> len;
<a name="l01530"></a>01530     <span class="keywordtype">int</span> ret = 0;
<a name="l01531"></a>01531 
<a name="l01532"></a>01532     <span class="keywordflow">if</span> (<a class="code" href="obj-store_8c.html#a6e93a0214f9cb8a7fc837a2bc3a3c529">seaf_obj_store_read_obj</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>-&gt;<a class="code" href="struct__SeafCommitManager.html#a1b7f3176ee61112e00532b1fc4b007e8">obj_store</a>,
<a name="l01533"></a>01533                                  task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l01534"></a>01534                                  task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>, (<span class="keywordtype">void</span>**)&amp;data, &amp;len) &lt; 0) {
<a name="l01535"></a>01535         g_warning (<span class="stringliteral">&quot;Failed to read commit %s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>);
<a name="l01536"></a>01536         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159ab2bac951aa574b49e1d988c044eea731">HTTP_TASK_ERR_BAD_LOCAL_DATA</a>;
<a name="l01537"></a>01537         <span class="keywordflow">return</span> -1;
<a name="l01538"></a>01538     }
<a name="l01539"></a>01539 
<a name="l01540"></a>01540     curl = conn-&gt;<a class="code" href="struct__Connection.html#af8b983fae165a24c7f9cc24e47361d57">curl</a>;
<a name="l01541"></a>01541 
<a name="l01542"></a>01542     url = g_strdup_printf (<span class="stringliteral">&quot;%s/seafhttp/repo/%s/commit/%s&quot;</span>,
<a name="l01543"></a>01543                            task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>);
<a name="l01544"></a>01544 
<a name="l01545"></a>01545     <span class="keywordflow">if</span> (http_put (curl, url, task-&gt;<a class="code" href="struct__HttpTxTask.html#a7efdacb9425ad03ba280b6435b0e6ba6">token</a>,
<a name="l01546"></a>01546                   data, len,
<a name="l01547"></a>01547                   NULL, NULL,
<a name="l01548"></a>01548                   &amp;status, NULL, NULL) &lt; 0) {
<a name="l01549"></a>01549         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159acf2d300b20f69c681bb82b34900a54f6">HTTP_TASK_ERR_NET</a>;
<a name="l01550"></a>01550         ret = -1;
<a name="l01551"></a>01551         <span class="keywordflow">goto</span> out;
<a name="l01552"></a>01552     }
<a name="l01553"></a>01553 
<a name="l01554"></a>01554     <span class="keywordflow">if</span> (status != <a class="code" href="http-tx-mgr_8c.html#a02e6d59009dee759528ec81fc9a8eeff">HTTP_OK</a>) {
<a name="l01555"></a>01555         seaf_warning (<span class="stringliteral">&quot;Bad response code for PUT %s: %d.\n&quot;</span>, url, status);
<a name="l01556"></a>01556         handle_http_errors (task, status);
<a name="l01557"></a>01557         ret = -1;
<a name="l01558"></a>01558     }
<a name="l01559"></a>01559 
<a name="l01560"></a>01560 out:
<a name="l01561"></a>01561     g_free (url);
<a name="l01562"></a>01562     curl_easy_reset (curl);
<a name="l01563"></a>01563     g_free (data);
<a name="l01564"></a>01564 
<a name="l01565"></a>01565     <span class="keywordflow">return</span> ret;
<a name="l01566"></a>01566 }
<a name="l01567"></a>01567 
<a name="l01568"></a><a class="code" href="structCalcFsListData.html">01568</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l01569"></a><a class="code" href="structCalcFsListData.html#a8379faa839af9e140692d5c94dda115e">01569</a>     GList **<a class="code" href="structCalcFsListData.html#a8379faa839af9e140692d5c94dda115e">pret</a>;
<a name="l01570"></a><a class="code" href="structCalcFsListData.html#a9960ea20bb0fe850615477e3c2615ece">01570</a>     GHashTable *<a class="code" href="structCalcFsListData.html#a9960ea20bb0fe850615477e3c2615ece">checked_objs</a>;
<a name="l01571"></a>01571 } <a class="code" href="structCalcFsListData.html">CalcFsListData</a>;
<a name="l01572"></a>01572 
<a name="l01573"></a>01573 <span class="keyword">inline</span> <span class="keyword">static</span> gboolean
<a name="l01574"></a>01574 dirent_same (<a class="code" href="struct__SeafDirent.html">SeafDirent</a> *denta, <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *dentb)
<a name="l01575"></a>01575 {
<a name="l01576"></a>01576     <span class="keywordflow">return</span> (strcmp (dentb-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>, denta-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>) == 0 &amp;&amp; denta-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a> == dentb-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>);
<a name="l01577"></a>01577 }
<a name="l01578"></a>01578 
<a name="l01579"></a>01579 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01580"></a>01580 collect_file_ids (<span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">char</span> *basedir, <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *files[], <span class="keywordtype">void</span> *vdata)
<a name="l01581"></a>01581 {
<a name="l01582"></a>01582     <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *file1 = files[0];
<a name="l01583"></a>01583     <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *file2 = files[1];
<a name="l01584"></a>01584     <a class="code" href="structCalcFsListData.html">CalcFsListData</a> *data = vdata;
<a name="l01585"></a>01585     GList **pret = data-&gt;<a class="code" href="structCalcFsListData.html#a8379faa839af9e140692d5c94dda115e">pret</a>;
<a name="l01586"></a>01586     <span class="keywordtype">int</span> dummy;
<a name="l01587"></a>01587 
<a name="l01588"></a>01588     <span class="keywordflow">if</span> (!file1 || strcmp (file1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>) == 0)
<a name="l01589"></a>01589         <span class="keywordflow">return</span> 0;
<a name="l01590"></a>01590 
<a name="l01591"></a>01591     <span class="keywordflow">if</span> (g_hash_table_lookup (data-&gt;<a class="code" href="structCalcFsListData.html#a9960ea20bb0fe850615477e3c2615ece">checked_objs</a>, file1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>))
<a name="l01592"></a>01592         <span class="keywordflow">return</span> 0;
<a name="l01593"></a>01593 
<a name="l01594"></a>01594     <span class="keywordflow">if</span> (!file2 || !dirent_same (file1, file2)) {
<a name="l01595"></a>01595         *pret = g_list_prepend (*pret, g_strdup(file1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>));
<a name="l01596"></a>01596         g_hash_table_insert (data-&gt;<a class="code" href="structCalcFsListData.html#a9960ea20bb0fe850615477e3c2615ece">checked_objs</a>, g_strdup(file1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>), &amp;dummy);
<a name="l01597"></a>01597     }
<a name="l01598"></a>01598 
<a name="l01599"></a>01599     <span class="keywordflow">return</span> 0;
<a name="l01600"></a>01600 }
<a name="l01601"></a>01601 
<a name="l01602"></a>01602 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01603"></a>01603 collect_dir_ids (<span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">char</span> *basedir, <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *dirs[], <span class="keywordtype">void</span> *vdata,
<a name="l01604"></a>01604                  gboolean *recurse)
<a name="l01605"></a>01605 {
<a name="l01606"></a>01606     <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *dir1 = dirs[0];
<a name="l01607"></a>01607     <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *dir2 = dirs[1];
<a name="l01608"></a>01608     <a class="code" href="structCalcFsListData.html">CalcFsListData</a> *data = vdata;
<a name="l01609"></a>01609     GList **pret = data-&gt;<a class="code" href="structCalcFsListData.html#a8379faa839af9e140692d5c94dda115e">pret</a>;
<a name="l01610"></a>01610     <span class="keywordtype">int</span> dummy;
<a name="l01611"></a>01611 
<a name="l01612"></a>01612     <span class="keywordflow">if</span> (!dir1 || strcmp (dir1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>) == 0)
<a name="l01613"></a>01613         <span class="keywordflow">return</span> 0;
<a name="l01614"></a>01614 
<a name="l01615"></a>01615     <span class="keywordflow">if</span> (g_hash_table_lookup (data-&gt;<a class="code" href="structCalcFsListData.html#a9960ea20bb0fe850615477e3c2615ece">checked_objs</a>, dir1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>))
<a name="l01616"></a>01616         <span class="keywordflow">return</span> 0;
<a name="l01617"></a>01617 
<a name="l01618"></a>01618     <span class="keywordflow">if</span> (!dir2 || !dirent_same (dir1, dir2)) {
<a name="l01619"></a>01619         *pret = g_list_prepend (*pret, g_strdup(dir1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>));
<a name="l01620"></a>01620         g_hash_table_insert (data-&gt;<a class="code" href="structCalcFsListData.html#a9960ea20bb0fe850615477e3c2615ece">checked_objs</a>, g_strdup(dir1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>), &amp;dummy);
<a name="l01621"></a>01621     }
<a name="l01622"></a>01622 
<a name="l01623"></a>01623     <span class="keywordflow">return</span> 0;
<a name="l01624"></a>01624 }
<a name="l01625"></a>01625 
<a name="l01626"></a>01626 <span class="keyword">static</span> GList *
<a name="l01627"></a>01627 calculate_send_fs_object_list (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task)
<a name="l01628"></a>01628 {
<a name="l01629"></a>01629     GList *ret = NULL;
<a name="l01630"></a>01630     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *local = NULL, *master = NULL;
<a name="l01631"></a>01631     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *local_head = NULL, *master_head = NULL;
<a name="l01632"></a>01632     GList *ptr;
<a name="l01633"></a>01633 
<a name="l01634"></a>01634     local = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, <span class="stringliteral">&quot;local&quot;</span>);
<a name="l01635"></a>01635     <span class="keywordflow">if</span> (!local) {
<a name="l01636"></a>01636         seaf_warning (<span class="stringliteral">&quot;Branch local not found for repo %.8s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l01637"></a>01637         <span class="keywordflow">goto</span> out;
<a name="l01638"></a>01638     }
<a name="l01639"></a>01639     master = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, <span class="stringliteral">&quot;master&quot;</span>);
<a name="l01640"></a>01640     <span class="keywordflow">if</span> (!master) {
<a name="l01641"></a>01641         seaf_warning (<span class="stringliteral">&quot;Branch master not found for repo %.8s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l01642"></a>01642         <span class="keywordflow">goto</span> out;
<a name="l01643"></a>01643     }
<a name="l01644"></a>01644 
<a name="l01645"></a>01645     local_head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l01646"></a>01646                                                  task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l01647"></a>01647                                                  local-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l01648"></a>01648     <span class="keywordflow">if</span> (!local_head) {
<a name="l01649"></a>01649         seaf_warning (<span class="stringliteral">&quot;Local head commit not found for repo %.8s.\n&quot;</span>,
<a name="l01650"></a>01650                       task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l01651"></a>01651         <span class="keywordflow">goto</span> out;
<a name="l01652"></a>01652     }
<a name="l01653"></a>01653     master_head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l01654"></a>01654                                                   task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l01655"></a>01655                                                   master-&gt;commit_id);
<a name="l01656"></a>01656     <span class="keywordflow">if</span> (!master_head) {
<a name="l01657"></a>01657         seaf_warning (<span class="stringliteral">&quot;Master head commit not found for repo %.8s.\n&quot;</span>,
<a name="l01658"></a>01658                       task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l01659"></a>01659         <span class="keywordflow">goto</span> out;
<a name="l01660"></a>01660     }
<a name="l01661"></a>01661 
<a name="l01662"></a>01662     <span class="comment">/* Diff won&#39;t traverse the root object itself. */</span>
<a name="l01663"></a>01663     <span class="keywordflow">if</span> (strcmp (local_head-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, master_head-&gt;root_id) != 0)
<a name="l01664"></a>01664         ret = g_list_prepend (ret, g_strdup(local_head-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>));
<a name="l01665"></a>01665 
<a name="l01666"></a>01666     <a class="code" href="structCalcFsListData.html">CalcFsListData</a> *data = g_new0(<a class="code" href="structCalcFsListData.html">CalcFsListData</a>, 1);
<a name="l01667"></a>01667     data-&gt;<a class="code" href="structCalcFsListData.html#a8379faa839af9e140692d5c94dda115e">pret</a> = &amp;ret;
<a name="l01668"></a>01668     data-&gt;<a class="code" href="structCalcFsListData.html#a9960ea20bb0fe850615477e3c2615ece">checked_objs</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
<a name="l01669"></a>01669                                                 g_free, NULL);
<a name="l01670"></a>01670 
<a name="l01671"></a>01671     <a class="code" href="structDiffOptions.html">DiffOptions</a> opts;
<a name="l01672"></a>01672     memset (&amp;opts, 0, <span class="keyword">sizeof</span>(opts));
<a name="l01673"></a>01673     memcpy (opts.<a class="code" href="structDiffOptions.html#a2f9324e06d0355964eb248315056d65c">store_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, 36);
<a name="l01674"></a>01674     opts.<a class="code" href="structDiffOptions.html#a2a919ea52308ada77775f78787df38f8">version</a> = task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>;
<a name="l01675"></a>01675     opts.<a class="code" href="structDiffOptions.html#a879b904244a3b1cf5ca46b6951d068c3">file_cb</a> = collect_file_ids;
<a name="l01676"></a>01676     opts.<a class="code" href="structDiffOptions.html#ac522b82b0271d69292cdaa84cb545b2b">dir_cb</a> = collect_dir_ids;
<a name="l01677"></a>01677     opts.<a class="code" href="structDiffOptions.html#aa922b39e312c25c075d5ed452d400b83">data</a> = data;
<a name="l01678"></a>01678 
<a name="l01679"></a>01679     <span class="keyword">const</span> <span class="keywordtype">char</span> *trees[2];
<a name="l01680"></a>01680     trees[0] = local_head-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>;
<a name="l01681"></a>01681     trees[1] = master_head-&gt;root_id;
<a name="l01682"></a>01682     <span class="keywordflow">if</span> (<a class="code" href="diff-simple_8c.html#aad681f9b9d7dbc7586efaa4cd0b254e6">diff_trees</a> (2, trees, &amp;opts) &lt; 0) {
<a name="l01683"></a>01683         seaf_warning (<span class="stringliteral">&quot;Failed to diff local and master head for repo %.8s.\n&quot;</span>,
<a name="l01684"></a>01684                       task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l01685"></a>01685         <span class="keywordflow">for</span> (ptr = ret; ptr; ptr = ptr-&gt;next)
<a name="l01686"></a>01686             g_free (ptr-&gt;data);
<a name="l01687"></a>01687         ret = NULL;
<a name="l01688"></a>01688     }
<a name="l01689"></a>01689 
<a name="l01690"></a>01690     g_hash_table_destroy (data-&gt;<a class="code" href="structCalcFsListData.html#a9960ea20bb0fe850615477e3c2615ece">checked_objs</a>);
<a name="l01691"></a>01691     g_free (data);
<a name="l01692"></a>01692 
<a name="l01693"></a>01693 out:
<a name="l01694"></a>01694     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (local);
<a name="l01695"></a>01695     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (master);
<a name="l01696"></a>01696     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (local_head);
<a name="l01697"></a>01697     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (master_head);
<a name="l01698"></a>01698     <span class="keywordflow">return</span> ret;
<a name="l01699"></a>01699 }
<a name="l01700"></a>01700 
<a name="l01701"></a><a class="code" href="http-tx-mgr_8c.html#a6dbd88fd52a1f923b6c34645cce35c32">01701</a> <span class="preprocessor">#define ID_LIST_SEGMENT_N 1000</span>
<a name="l01702"></a>01702 <span class="preprocessor"></span>
<a name="l01703"></a>01703 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01704"></a>01704 upload_check_id_list_segment (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task, <a class="code" href="struct__Connection.html">Connection</a> *conn, <span class="keyword">const</span> <span class="keywordtype">char</span> *url,
<a name="l01705"></a>01705                               GList **send_id_list, GList **recv_id_list)
<a name="l01706"></a>01706 {
<a name="l01707"></a>01707     json_t *array;
<a name="l01708"></a>01708     json_error_t jerror;
<a name="l01709"></a>01709     <span class="keywordtype">char</span> *<a class="code" href="Backups_2http-server_8c.html#acdc8b2e33d61c23557d7e7563f00ef6f">obj_id</a>;
<a name="l01710"></a>01710     <span class="keywordtype">int</span> n_sent = 0;
<a name="l01711"></a>01711     <span class="keywordtype">char</span> *data = NULL;
<a name="l01712"></a>01712     <span class="keywordtype">int</span> len;
<a name="l01713"></a>01713     CURL *curl;
<a name="l01714"></a>01714     <span class="keywordtype">int</span> <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l01715"></a>01715     <span class="keywordtype">char</span> *rsp_content = NULL;
<a name="l01716"></a>01716     gint64 rsp_size;
<a name="l01717"></a>01717     <span class="keywordtype">int</span> ret = 0;
<a name="l01718"></a>01718 
<a name="l01719"></a>01719     <span class="comment">/* Convert object id list to JSON format. */</span>
<a name="l01720"></a>01720 
<a name="l01721"></a>01721     array = json_array ();
<a name="l01722"></a>01722 
<a name="l01723"></a>01723     <span class="keywordflow">while</span> (*send_id_list != NULL) {
<a name="l01724"></a>01724         obj_id = (*send_id_list)-&gt;data;
<a name="l01725"></a>01725         json_array_append_new (array, json_string(obj_id));
<a name="l01726"></a>01726 
<a name="l01727"></a>01727         *send_id_list = g_list_delete_link (*send_id_list, *send_id_list);
<a name="l01728"></a>01728         g_free (obj_id);
<a name="l01729"></a>01729 
<a name="l01730"></a>01730         <span class="keywordflow">if</span> (++n_sent &gt;= <a class="code" href="http-tx-mgr_8c.html#a6dbd88fd52a1f923b6c34645cce35c32">ID_LIST_SEGMENT_N</a>)
<a name="l01731"></a>01731             <span class="keywordflow">break</span>;
<a name="l01732"></a>01732     }
<a name="l01733"></a>01733 
<a name="l01734"></a>01734     seaf_debug (<span class="stringliteral">&quot;Check %d ids for %s:%s.\n&quot;</span>,
<a name="l01735"></a>01735                 n_sent, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l01736"></a>01736 
<a name="l01737"></a>01737     data = json_dumps (array, 0);
<a name="l01738"></a>01738     len = strlen(data);
<a name="l01739"></a>01739     json_decref (array);
<a name="l01740"></a>01740 
<a name="l01741"></a>01741     <span class="comment">/* Send fs object id list. */</span>
<a name="l01742"></a>01742 
<a name="l01743"></a>01743     curl = conn-&gt;<a class="code" href="struct__Connection.html#af8b983fae165a24c7f9cc24e47361d57">curl</a>;
<a name="l01744"></a>01744 
<a name="l01745"></a>01745     <span class="keywordflow">if</span> (http_post (curl, url, task-&gt;<a class="code" href="struct__HttpTxTask.html#a7efdacb9425ad03ba280b6435b0e6ba6">token</a>,
<a name="l01746"></a>01746                    data, len,
<a name="l01747"></a>01747                    &amp;status, &amp;rsp_content, &amp;rsp_size) &lt; 0) {
<a name="l01748"></a>01748         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159acf2d300b20f69c681bb82b34900a54f6">HTTP_TASK_ERR_NET</a>;
<a name="l01749"></a>01749         ret = -1;
<a name="l01750"></a>01750         <span class="keywordflow">goto</span> out;
<a name="l01751"></a>01751     }
<a name="l01752"></a>01752 
<a name="l01753"></a>01753     <span class="keywordflow">if</span> (status != <a class="code" href="http-tx-mgr_8c.html#a02e6d59009dee759528ec81fc9a8eeff">HTTP_OK</a>) {
<a name="l01754"></a>01754         seaf_warning (<span class="stringliteral">&quot;Bad response code for POST %s: %d.\n&quot;</span>, url, status);
<a name="l01755"></a>01755         handle_http_errors (task, status);
<a name="l01756"></a>01756         ret = -1;
<a name="l01757"></a>01757         <span class="keywordflow">goto</span> out;
<a name="l01758"></a>01758     }
<a name="l01759"></a>01759 
<a name="l01760"></a>01760     <span class="comment">/* Process needed object id list. */</span>
<a name="l01761"></a>01761 
<a name="l01762"></a>01762     array = json_loadb (rsp_content, rsp_size, 0, &amp;jerror);
<a name="l01763"></a>01763     <span class="keywordflow">if</span> (!array) {
<a name="l01764"></a>01764         seaf_warning (<span class="stringliteral">&quot;Invalid JSON response from the server: %s.\n&quot;</span>, jerror.text);
<a name="l01765"></a>01765         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159aba8619a02d36bc551d2cd4bffd978a42">HTTP_TASK_ERR_SERVER</a>;
<a name="l01766"></a>01766         ret = -1;
<a name="l01767"></a>01767         <span class="keywordflow">goto</span> out;
<a name="l01768"></a>01768     }
<a name="l01769"></a>01769 
<a name="l01770"></a>01770     <span class="keywordtype">int</span> i;
<a name="l01771"></a>01771     <span class="keywordtype">size_t</span> n = json_array_size (array);
<a name="l01772"></a>01772     json_t *str;
<a name="l01773"></a>01773 
<a name="l01774"></a>01774     seaf_debug (<span class="stringliteral">&quot;%lu objects or blocks are needed for %s:%s.\n&quot;</span>,
<a name="l01775"></a>01775                 n, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l01776"></a>01776 
<a name="l01777"></a>01777     <span class="keywordflow">for</span> (i = 0; i &lt; n; ++i) {
<a name="l01778"></a>01778         str = json_array_get (array, i);
<a name="l01779"></a>01779         <span class="keywordflow">if</span> (!str) {
<a name="l01780"></a>01780             seaf_warning (<span class="stringliteral">&quot;Invalid JSON response from the server.\n&quot;</span>);
<a name="l01781"></a>01781             json_decref (array);
<a name="l01782"></a>01782             ret = -1;
<a name="l01783"></a>01783             <span class="keywordflow">goto</span> out;
<a name="l01784"></a>01784         }
<a name="l01785"></a>01785 
<a name="l01786"></a>01786         *recv_id_list = g_list_prepend (*recv_id_list, g_strdup(json_string_value(str)));
<a name="l01787"></a>01787     }
<a name="l01788"></a>01788 
<a name="l01789"></a>01789     json_decref (array);
<a name="l01790"></a>01790 
<a name="l01791"></a>01791 out:
<a name="l01792"></a>01792     curl_easy_reset (curl);
<a name="l01793"></a>01793     g_free (data);
<a name="l01794"></a>01794     g_free (rsp_content);
<a name="l01795"></a>01795 
<a name="l01796"></a>01796     <span class="keywordflow">return</span> ret;
<a name="l01797"></a>01797 }
<a name="l01798"></a>01798 
<a name="l01799"></a><a class="code" href="http-tx-mgr_8c.html#a67b56a4c47906fef2dce1f0eb13c6895">01799</a> <span class="preprocessor">#define MAX_OBJECT_PACK_SIZE (1 &lt;&lt; 20) </span><span class="comment">/* 1MB */</span>
<a name="l01800"></a>01800 
<a name="l01801"></a>01801 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l01802"></a><a class="code" href="struct____attribute____.html#a00b7f08ee47b15aade58d5c754ed2987">01802</a>     <span class="keywordtype">char</span> <a class="code" href="Backups_2http-server_8c.html#acdc8b2e33d61c23557d7e7563f00ef6f">obj_id</a>[40];
<a name="l01803"></a><a class="code" href="struct____attribute____.html#a60b891ced833f4c3af374e16770f3395">01803</a>     guint32 <a class="code" href="struct____attribute____.html#a60b891ced833f4c3af374e16770f3395">obj_size</a>;
<a name="l01804"></a><a class="code" href="struct____attribute____.html#a6ea9b1ece6891d34121327f44b972d82">01804</a>     guint8 <span class="keywordtype">object</span>[0];
<a name="l01805"></a>01805 } <a class="code" href="fs-mgr_8h.html#ac5bca675b55e4df0a33e4e87cdbf8996">__attribute__</a>((__packed__)) ObjectHeader;
<a name="l01806"></a>01806 
<a name="l01807"></a>01807 static <span class="keywordtype">int</span>
<a name="l01808"></a>01808 send_fs_objects (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task, <a class="code" href="struct__Connection.html">Connection</a> *conn, GList **send_fs_list)
<a name="l01809"></a>01809 {
<a name="l01810"></a>01810     <span class="keyword">struct </span>evbuffer *buf;
<a name="l01811"></a>01811     ObjectHeader hdr;
<a name="l01812"></a>01812     <span class="keywordtype">char</span> *<a class="code" href="Backups_2http-server_8c.html#acdc8b2e33d61c23557d7e7563f00ef6f">obj_id</a>;
<a name="l01813"></a>01813     <span class="keywordtype">char</span> *data;
<a name="l01814"></a>01814     <span class="keywordtype">int</span> len;
<a name="l01815"></a>01815     <span class="keywordtype">int</span> total_size;
<a name="l01816"></a>01816     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *package;
<a name="l01817"></a>01817     CURL *curl;
<a name="l01818"></a>01818     <span class="keywordtype">char</span> *url;
<a name="l01819"></a>01819     <span class="keywordtype">int</span> <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l01820"></a>01820     <span class="keywordtype">int</span> ret = 0;
<a name="l01821"></a>01821     <span class="keywordtype">int</span> n_sent = 0;
<a name="l01822"></a>01822 
<a name="l01823"></a>01823     buf = evbuffer_new ();
<a name="l01824"></a>01824 
<a name="l01825"></a>01825     <span class="keywordflow">while</span> (*send_fs_list != NULL) {
<a name="l01826"></a>01826         obj_id = (*send_fs_list)-&gt;data;
<a name="l01827"></a>01827 
<a name="l01828"></a>01828         <span class="keywordflow">if</span> (<a class="code" href="obj-store_8c.html#a6e93a0214f9cb8a7fc837a2bc3a3c529">seaf_obj_store_read_obj</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>-&gt;<a class="code" href="struct__SeafFSManager.html#aff81d27b12d5aaefe129f39071d33386">obj_store</a>,
<a name="l01829"></a>01829                                      task-&gt;repo_id, task-&gt;repo_version,
<a name="l01830"></a>01830                                      obj_id, (<span class="keywordtype">void</span> **)&amp;data, &amp;len) &lt; 0) {
<a name="l01831"></a>01831             seaf_warning (<span class="stringliteral">&quot;Failed to read fs object %s in repo %s.\n&quot;</span>,
<a name="l01832"></a>01832                           obj_id, task-&gt;repo_id);
<a name="l01833"></a>01833             task-&gt;error = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159ab2bac951aa574b49e1d988c044eea731">HTTP_TASK_ERR_BAD_LOCAL_DATA</a>;
<a name="l01834"></a>01834             ret = -1;
<a name="l01835"></a>01835             <span class="keywordflow">goto</span> out;
<a name="l01836"></a>01836         }
<a name="l01837"></a>01837 
<a name="l01838"></a>01838         ++n_sent;
<a name="l01839"></a>01839 
<a name="l01840"></a>01840         memcpy (hdr.obj_id, obj_id, 40);
<a name="l01841"></a>01841         hdr.obj_size = htonl (len);
<a name="l01842"></a>01842 
<a name="l01843"></a>01843         evbuffer_add (buf, &amp;hdr, <span class="keyword">sizeof</span>(hdr));
<a name="l01844"></a>01844         evbuffer_add (buf, data, len);
<a name="l01845"></a>01845 
<a name="l01846"></a>01846         g_free (data);
<a name="l01847"></a>01847         *send_fs_list = g_list_delete_link (*send_fs_list, *send_fs_list);
<a name="l01848"></a>01848         g_free (obj_id);
<a name="l01849"></a>01849 
<a name="l01850"></a>01850         total_size = evbuffer_get_length (buf);
<a name="l01851"></a>01851         <span class="keywordflow">if</span> (total_size &gt;= <a class="code" href="http-tx-mgr_8c.html#a67b56a4c47906fef2dce1f0eb13c6895">MAX_OBJECT_PACK_SIZE</a>)
<a name="l01852"></a>01852             <span class="keywordflow">break</span>;
<a name="l01853"></a>01853     }
<a name="l01854"></a>01854 
<a name="l01855"></a>01855     seaf_debug (<span class="stringliteral">&quot;Sending %d fs objects for %s:%s.\n&quot;</span>,
<a name="l01856"></a>01856                 n_sent, task-&gt;host, task-&gt;repo_id);
<a name="l01857"></a>01857 
<a name="l01858"></a>01858     <span class="keyword">package </span>= evbuffer_pullup (buf, -1);
<a name="l01859"></a>01859 
<a name="l01860"></a>01860     curl = conn-&gt;curl;
<a name="l01861"></a>01861 
<a name="l01862"></a>01862     url = g_strdup_printf (<span class="stringliteral">&quot;%s/seafhttp/repo/%s/recv-fs/&quot;</span>,
<a name="l01863"></a>01863                            task-&gt;host, task-&gt;repo_id);
<a name="l01864"></a>01864 
<a name="l01865"></a>01865     <span class="keywordflow">if</span> (http_post (curl, url, task-&gt;token,
<a name="l01866"></a>01866                    package, evbuffer_get_length(buf),
<a name="l01867"></a>01867                    &amp;status, NULL, NULL) &lt; 0) {
<a name="l01868"></a>01868         task-&gt;error = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159acf2d300b20f69c681bb82b34900a54f6">HTTP_TASK_ERR_NET</a>;
<a name="l01869"></a>01869         ret = -1;
<a name="l01870"></a>01870         <span class="keywordflow">goto</span> out;
<a name="l01871"></a>01871     }
<a name="l01872"></a>01872 
<a name="l01873"></a>01873     <span class="keywordflow">if</span> (status != <a class="code" href="http-tx-mgr_8c.html#a02e6d59009dee759528ec81fc9a8eeff">HTTP_OK</a>) {
<a name="l01874"></a>01874         seaf_warning (<span class="stringliteral">&quot;Bad response code for POST %s: %d.\n&quot;</span>, url, status);
<a name="l01875"></a>01875         handle_http_errors (task, status);
<a name="l01876"></a>01876         ret = -1;
<a name="l01877"></a>01877     }
<a name="l01878"></a>01878 
<a name="l01879"></a>01879 out:
<a name="l01880"></a>01880     g_free (url);
<a name="l01881"></a>01881     evbuffer_free (buf);
<a name="l01882"></a>01882     curl_easy_reset (curl);
<a name="l01883"></a>01883 
<a name="l01884"></a>01884     <span class="keywordflow">return</span> ret;
<a name="l01885"></a>01885 }
<a name="l01886"></a>01886 
<a name="l01887"></a><a class="code" href="structCalcBlockListData.html">01887</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l01888"></a><a class="code" href="structCalcBlockListData.html#a13dbe7568b7e831163a392f33a45d999">01888</a>     GList *<a class="code" href="structCalcBlockListData.html#a13dbe7568b7e831163a392f33a45d999">block_list</a>;
<a name="l01889"></a><a class="code" href="structCalcBlockListData.html#a76c6d992cbcbf187075955bad7e786a6">01889</a>     GHashTable *<a class="code" href="structCalcBlockListData.html#a76c6d992cbcbf187075955bad7e786a6">added_blocks</a>;
<a name="l01890"></a><a class="code" href="structCalcBlockListData.html#a9ff6b3040656e63306c741a543511327">01890</a>     <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *<a class="code" href="structCalcBlockListData.html#a9ff6b3040656e63306c741a543511327">task</a>;
<a name="l01891"></a>01891 } <a class="code" href="structCalcBlockListData.html">CalcBlockListData</a>;
<a name="l01892"></a>01892 
<a name="l01893"></a>01893 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01894"></a>01894 add_to_block_list (GList **block_list, GHashTable *added_blocks, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="block-tx-utils_8h.html#a2d616e1f81d11995c8b388444be651ef">block_id</a>)
<a name="l01895"></a>01895 {
<a name="l01896"></a>01896     <span class="keywordtype">int</span> dummy;
<a name="l01897"></a>01897 
<a name="l01898"></a>01898     <span class="keywordflow">if</span> (g_hash_table_lookup (added_blocks, block_id))
<a name="l01899"></a>01899         <span class="keywordflow">return</span>;
<a name="l01900"></a>01900 
<a name="l01901"></a>01901     *block_list = g_list_prepend (*block_list, g_strdup(block_id));
<a name="l01902"></a>01902     g_hash_table_insert (added_blocks, g_strdup(block_id), &amp;dummy);
<a name="l01903"></a>01903 }
<a name="l01904"></a>01904 
<a name="l01905"></a>01905 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01906"></a>01906 block_list_diff_files (<span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">char</span> *basedir, <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *files[], <span class="keywordtype">void</span> *vdata)
<a name="l01907"></a>01907 {
<a name="l01908"></a>01908     <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *file1 = files[0];
<a name="l01909"></a>01909     <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *file2 = files[1];
<a name="l01910"></a>01910     <a class="code" href="structCalcBlockListData.html">CalcBlockListData</a> *data = vdata;
<a name="l01911"></a>01911     <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task = data-&gt;<a class="code" href="structCalcBlockListData.html#a9ff6b3040656e63306c741a543511327">task</a>;
<a name="l01912"></a>01912     <a class="code" href="struct__Seafile.html">Seafile</a> *f1 = NULL, *f2 = NULL;
<a name="l01913"></a>01913     <span class="keywordtype">int</span> i;
<a name="l01914"></a>01914 
<a name="l01915"></a>01915     <span class="keywordflow">if</span> (file1 &amp;&amp; strcmp (file1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>) != 0) {
<a name="l01916"></a>01916         <span class="keywordflow">if</span> (!file2) {
<a name="l01917"></a>01917             f1 = <a class="code" href="fs-mgr_8c.html#a029c16e2ecdf6eafd96edb2ee4e6beac">seaf_fs_manager_get_seafile</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
<a name="l01918"></a>01918                                               task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l01919"></a>01919                                               file1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
<a name="l01920"></a>01920             <span class="keywordflow">if</span> (!f1) {
<a name="l01921"></a>01921                 seaf_warning (<span class="stringliteral">&quot;Failed to get seafile object %s.\n&quot;</span>, file1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
<a name="l01922"></a>01922                 <span class="keywordflow">return</span> -1;
<a name="l01923"></a>01923             }
<a name="l01924"></a>01924             <span class="keywordflow">for</span> (i = 0; i &lt; f1-&gt;<a class="code" href="struct__Seafile.html#af2d5c5e5bb56d38122dead42128b9c20">n_blocks</a>; ++i)
<a name="l01925"></a>01925                 add_to_block_list (&amp;data-&gt;<a class="code" href="structCalcBlockListData.html#a13dbe7568b7e831163a392f33a45d999">block_list</a>, data-&gt;<a class="code" href="structCalcBlockListData.html#a76c6d992cbcbf187075955bad7e786a6">added_blocks</a>,
<a name="l01926"></a>01926                                    f1-&gt;<a class="code" href="struct__Seafile.html#aacaedff2674132faf3d522ba8df6e268">blk_sha1s</a>[i]);
<a name="l01927"></a>01927             <a class="code" href="fs-mgr_8c.html#a0a491c647769cf7bd09d5092ab84b85a">seafile_unref</a> (f1);
<a name="l01928"></a>01928         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp (file1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>, file2-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>) != 0) {
<a name="l01929"></a>01929             f1 = <a class="code" href="fs-mgr_8c.html#a029c16e2ecdf6eafd96edb2ee4e6beac">seaf_fs_manager_get_seafile</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
<a name="l01930"></a>01930                                               task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l01931"></a>01931                                               file1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
<a name="l01932"></a>01932             <span class="keywordflow">if</span> (!f1) {
<a name="l01933"></a>01933                 seaf_warning (<span class="stringliteral">&quot;Failed to get seafile object %s.\n&quot;</span>, file1-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
<a name="l01934"></a>01934                 <span class="keywordflow">return</span> -1;
<a name="l01935"></a>01935             }
<a name="l01936"></a>01936             f2 = <a class="code" href="fs-mgr_8c.html#a029c16e2ecdf6eafd96edb2ee4e6beac">seaf_fs_manager_get_seafile</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
<a name="l01937"></a>01937                                               task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l01938"></a>01938                                               file2-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
<a name="l01939"></a>01939             <span class="keywordflow">if</span> (!f2) {
<a name="l01940"></a>01940                 <a class="code" href="fs-mgr_8c.html#a0a491c647769cf7bd09d5092ab84b85a">seafile_unref</a> (f1);
<a name="l01941"></a>01941                 seaf_warning (<span class="stringliteral">&quot;Failed to get seafile object %s.\n&quot;</span>, file2-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
<a name="l01942"></a>01942                 <span class="keywordflow">return</span> -1;
<a name="l01943"></a>01943             }
<a name="l01944"></a>01944 
<a name="l01945"></a>01945             GHashTable *h = g_hash_table_new (g_str_hash, g_str_equal);
<a name="l01946"></a>01946             <span class="keywordtype">int</span> dummy;
<a name="l01947"></a>01947             <span class="keywordflow">for</span> (i = 0; i &lt; f2-&gt;n_blocks; ++i)
<a name="l01948"></a>01948                 g_hash_table_insert (h, f2-&gt;blk_sha1s[i], &amp;dummy);
<a name="l01949"></a>01949 
<a name="l01950"></a>01950             <span class="keywordflow">for</span> (i = 0; i &lt; f1-&gt;<a class="code" href="struct__Seafile.html#af2d5c5e5bb56d38122dead42128b9c20">n_blocks</a>; ++i)
<a name="l01951"></a>01951                 <span class="keywordflow">if</span> (!g_hash_table_lookup (h, f1-&gt;<a class="code" href="struct__Seafile.html#aacaedff2674132faf3d522ba8df6e268">blk_sha1s</a>[i]))
<a name="l01952"></a>01952                     add_to_block_list (&amp;data-&gt;<a class="code" href="structCalcBlockListData.html#a13dbe7568b7e831163a392f33a45d999">block_list</a>, data-&gt;<a class="code" href="structCalcBlockListData.html#a76c6d992cbcbf187075955bad7e786a6">added_blocks</a>,
<a name="l01953"></a>01953                                        f1-&gt;<a class="code" href="struct__Seafile.html#aacaedff2674132faf3d522ba8df6e268">blk_sha1s</a>[i]);
<a name="l01954"></a>01954 
<a name="l01955"></a>01955             <a class="code" href="fs-mgr_8c.html#a0a491c647769cf7bd09d5092ab84b85a">seafile_unref</a> (f1);
<a name="l01956"></a>01956             <a class="code" href="fs-mgr_8c.html#a0a491c647769cf7bd09d5092ab84b85a">seafile_unref</a> (f2);
<a name="l01957"></a>01957             g_hash_table_destroy (h);
<a name="l01958"></a>01958         }
<a name="l01959"></a>01959     }
<a name="l01960"></a>01960 
<a name="l01961"></a>01961     <span class="keywordflow">return</span> 0;
<a name="l01962"></a>01962 }
<a name="l01963"></a>01963 
<a name="l01964"></a>01964 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01965"></a>01965 block_list_diff_dirs (<span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">char</span> *basedir, <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *dirs[], <span class="keywordtype">void</span> *data,
<a name="l01966"></a>01966                       gboolean *recurse)
<a name="l01967"></a>01967 {
<a name="l01968"></a>01968     <span class="comment">/* Do nothing */</span>
<a name="l01969"></a>01969     <span class="keywordflow">return</span> 0;
<a name="l01970"></a>01970 }
<a name="l01971"></a>01971 
<a name="l01972"></a>01972 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01973"></a>01973 calculate_block_list (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task, GList **plist)
<a name="l01974"></a>01974 {
<a name="l01975"></a>01975     <span class="keywordtype">int</span> ret = 0;
<a name="l01976"></a>01976     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *local = NULL, *master = NULL;
<a name="l01977"></a>01977     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *local_head = NULL, *master_head = NULL;
<a name="l01978"></a>01978 
<a name="l01979"></a>01979     local = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, <span class="stringliteral">&quot;local&quot;</span>);
<a name="l01980"></a>01980     <span class="keywordflow">if</span> (!local) {
<a name="l01981"></a>01981         seaf_warning (<span class="stringliteral">&quot;Branch local not found for repo %.8s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l01982"></a>01982         ret = -1;
<a name="l01983"></a>01983         <span class="keywordflow">goto</span> out;
<a name="l01984"></a>01984     }
<a name="l01985"></a>01985     master = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, <span class="stringliteral">&quot;master&quot;</span>);
<a name="l01986"></a>01986     <span class="keywordflow">if</span> (!master) {
<a name="l01987"></a>01987         seaf_warning (<span class="stringliteral">&quot;Branch master not found for repo %.8s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l01988"></a>01988         ret = -1;
<a name="l01989"></a>01989         <span class="keywordflow">goto</span> out;
<a name="l01990"></a>01990     }
<a name="l01991"></a>01991 
<a name="l01992"></a>01992     local_head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l01993"></a>01993                                                  task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l01994"></a>01994                                                  local-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l01995"></a>01995     <span class="keywordflow">if</span> (!local_head) {
<a name="l01996"></a>01996         seaf_warning (<span class="stringliteral">&quot;Local head commit not found for repo %.8s.\n&quot;</span>,
<a name="l01997"></a>01997                       task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l01998"></a>01998         ret = -1;
<a name="l01999"></a>01999         <span class="keywordflow">goto</span> out;
<a name="l02000"></a>02000     }
<a name="l02001"></a>02001     master_head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l02002"></a>02002                                                  task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l02003"></a>02003                                                  master-&gt;commit_id);
<a name="l02004"></a>02004     <span class="keywordflow">if</span> (!master_head) {
<a name="l02005"></a>02005         seaf_warning (<span class="stringliteral">&quot;Master head commit not found for repo %.8s.\n&quot;</span>,
<a name="l02006"></a>02006                       task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02007"></a>02007         ret = -1;
<a name="l02008"></a>02008         <span class="keywordflow">goto</span> out;
<a name="l02009"></a>02009     }
<a name="l02010"></a>02010 
<a name="l02011"></a>02011     <a class="code" href="structCalcBlockListData.html">CalcBlockListData</a> data;
<a name="l02012"></a>02012     memset (&amp;data, 0, <span class="keyword">sizeof</span>(data));
<a name="l02013"></a>02013     data.<a class="code" href="structCalcBlockListData.html#a76c6d992cbcbf187075955bad7e786a6">added_blocks</a> = g_hash_table_new_full (g_str_hash, g_str_equal, g_free, NULL);
<a name="l02014"></a>02014     data.<a class="code" href="structCalcBlockListData.html#a9ff6b3040656e63306c741a543511327">task</a> = task;
<a name="l02015"></a>02015 
<a name="l02016"></a>02016     <a class="code" href="structDiffOptions.html">DiffOptions</a> opts;
<a name="l02017"></a>02017     memset (&amp;opts, 0, <span class="keyword">sizeof</span>(opts));
<a name="l02018"></a>02018     memcpy (opts.<a class="code" href="structDiffOptions.html#a2f9324e06d0355964eb248315056d65c">store_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, 36);
<a name="l02019"></a>02019     opts.<a class="code" href="structDiffOptions.html#a2a919ea52308ada77775f78787df38f8">version</a> = task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>;
<a name="l02020"></a>02020     opts.<a class="code" href="structDiffOptions.html#a879b904244a3b1cf5ca46b6951d068c3">file_cb</a> = block_list_diff_files;
<a name="l02021"></a>02021     opts.<a class="code" href="structDiffOptions.html#ac522b82b0271d69292cdaa84cb545b2b">dir_cb</a> = block_list_diff_dirs;
<a name="l02022"></a>02022     opts.<a class="code" href="structDiffOptions.html#aa922b39e312c25c075d5ed452d400b83">data</a> = &amp;data;
<a name="l02023"></a>02023 
<a name="l02024"></a>02024     <span class="keyword">const</span> <span class="keywordtype">char</span> *trees[2];
<a name="l02025"></a>02025     trees[0] = local_head-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>;
<a name="l02026"></a>02026     trees[1] = master_head-&gt;root_id;
<a name="l02027"></a>02027     <span class="keywordflow">if</span> (<a class="code" href="diff-simple_8c.html#aad681f9b9d7dbc7586efaa4cd0b254e6">diff_trees</a> (2, trees, &amp;opts) &lt; 0) {
<a name="l02028"></a>02028         seaf_warning (<span class="stringliteral">&quot;Failed to diff local and master head for repo %.8s.\n&quot;</span>,
<a name="l02029"></a>02029                       task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02030"></a>02030         g_hash_table_destroy (data.<a class="code" href="structCalcBlockListData.html#a76c6d992cbcbf187075955bad7e786a6">added_blocks</a>);
<a name="l02031"></a>02031 
<a name="l02032"></a>02032         GList *ptr;
<a name="l02033"></a>02033         <span class="keywordflow">for</span> (ptr = data.<a class="code" href="structCalcBlockListData.html#a13dbe7568b7e831163a392f33a45d999">block_list</a>; ptr; ptr = ptr-&gt;next)
<a name="l02034"></a>02034             g_free (ptr-&gt;data);
<a name="l02035"></a>02035 
<a name="l02036"></a>02036         ret = -1;
<a name="l02037"></a>02037         <span class="keywordflow">goto</span> out;
<a name="l02038"></a>02038     }
<a name="l02039"></a>02039 
<a name="l02040"></a>02040     g_hash_table_destroy (data.<a class="code" href="structCalcBlockListData.html#a76c6d992cbcbf187075955bad7e786a6">added_blocks</a>);
<a name="l02041"></a>02041     *plist = data.<a class="code" href="structCalcBlockListData.html#a13dbe7568b7e831163a392f33a45d999">block_list</a>;
<a name="l02042"></a>02042 
<a name="l02043"></a>02043 out:
<a name="l02044"></a>02044     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (local);
<a name="l02045"></a>02045     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (master);
<a name="l02046"></a>02046     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (local_head);
<a name="l02047"></a>02047     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (master_head);
<a name="l02048"></a>02048     <span class="keywordflow">return</span> ret;
<a name="l02049"></a>02049 }
<a name="l02050"></a>02050 
<a name="l02051"></a><a class="code" href="structSendBlockData.html">02051</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l02052"></a><a class="code" href="structSendBlockData.html#af1f3601d724987a19940bdcfdf6e2022">02052</a>     <span class="keywordtype">char</span> <a class="code" href="block-tx-utils_8h.html#a2d616e1f81d11995c8b388444be651ef">block_id</a>[41];
<a name="l02053"></a><a class="code" href="structSendBlockData.html#a8bbded6d0714dabb52c9c404da69c396">02053</a>     <a class="code" href="struct__BHandle.html">BlockHandle</a> *<a class="code" href="structSendBlockData.html#a8bbded6d0714dabb52c9c404da69c396">block</a>;
<a name="l02054"></a><a class="code" href="structSendBlockData.html#ad2e9472f60f27e2f17ed35d40dda2d30">02054</a>     <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *<a class="code" href="structSendBlockData.html#ad2e9472f60f27e2f17ed35d40dda2d30">task</a>;
<a name="l02055"></a>02055 } <a class="code" href="access-file_8c.html#a5f0efe134e2aac668b00eb413164decd">SendBlockData</a>;
<a name="l02056"></a>02056 
<a name="l02057"></a>02057 <span class="keyword">static</span> <span class="keywordtype">size_t</span>
<a name="l02058"></a>02058 send_block_callback (<span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> <a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a>, <span class="keywordtype">size_t</span> nmemb, <span class="keywordtype">void</span> *userp)
<a name="l02059"></a>02059 {
<a name="l02060"></a>02060     <span class="keywordtype">size_t</span> realsize = size *nmemb;
<a name="l02061"></a>02061     <a class="code" href="structSendBlockData.html">SendBlockData</a> *data = userp;
<a name="l02062"></a>02062     <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task = data-&gt;<a class="code" href="structSendBlockData.html#ad2e9472f60f27e2f17ed35d40dda2d30">task</a>;
<a name="l02063"></a>02063     <span class="keywordtype">int</span> n;
<a name="l02064"></a>02064 
<a name="l02065"></a>02065     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>)
<a name="l02066"></a>02066         <span class="keywordflow">return</span> CURL_READFUNC_ABORT;
<a name="l02067"></a>02067 
<a name="l02068"></a>02068     n = <a class="code" href="block-mgr_8c.html#a3f01e48b64b37ab59ee9875a572e945a">seaf_block_manager_read_block</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>,
<a name="l02069"></a>02069                                        data-&gt;<a class="code" href="structSendBlockData.html#a8bbded6d0714dabb52c9c404da69c396">block</a>,
<a name="l02070"></a>02070                                        ptr, realsize);
<a name="l02071"></a>02071     <span class="keywordflow">if</span> (n &lt; 0) {
<a name="l02072"></a>02072         seaf_warning (<span class="stringliteral">&quot;Failed to read block %s in repo %.8s.\n&quot;</span>,
<a name="l02073"></a>02073                       data-&gt;<a class="code" href="structSendBlockData.html#af1f3601d724987a19940bdcfdf6e2022">block_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02074"></a>02074         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159ab2bac951aa574b49e1d988c044eea731">HTTP_TASK_ERR_BAD_LOCAL_DATA</a>;
<a name="l02075"></a>02075         <span class="keywordflow">return</span> CURL_READFUNC_ABORT;
<a name="l02076"></a>02076     }
<a name="l02077"></a>02077 
<a name="l02078"></a>02078     <span class="comment">/* Update global transferred bytes. */</span>
<a name="l02079"></a>02079     g_atomic_int_add (&amp;(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a6b2a5e1e723955885f9fb27c5f064df4">sync_mgr</a>-&gt;<a class="code" href="struct__SeafSyncManager.html#aae566549651ea69a0b37db631f0b9a32">sent_bytes</a>), n);
<a name="l02080"></a>02080 
<a name="l02081"></a>02081     <span class="comment">/* If uploaded bytes exceeds the limit, wait until the counter</span>
<a name="l02082"></a>02082 <span class="comment">     * is reset. We check the counter every 100 milliseconds, so we</span>
<a name="l02083"></a>02083 <span class="comment">     * can waste up to 100 milliseconds without sending data after</span>
<a name="l02084"></a>02084 <span class="comment">     * the counter is reset.</span>
<a name="l02085"></a>02085 <span class="comment">     */</span>
<a name="l02086"></a>02086     <span class="keywordflow">while</span> (1) {
<a name="l02087"></a>02087         gint sent = g_atomic_int_get(&amp;(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a6b2a5e1e723955885f9fb27c5f064df4">sync_mgr</a>-&gt;<a class="code" href="struct__SeafSyncManager.html#aae566549651ea69a0b37db631f0b9a32">sent_bytes</a>));
<a name="l02088"></a>02088         <span class="keywordflow">if</span> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a6b2a5e1e723955885f9fb27c5f064df4">sync_mgr</a>-&gt;<a class="code" href="struct__SeafSyncManager.html#af27650b12e9237509a8b214808f18e21">upload_limit</a> &gt; 0 &amp;&amp;
<a name="l02089"></a>02089             sent &gt; <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a6b2a5e1e723955885f9fb27c5f064df4">sync_mgr</a>-&gt;<a class="code" href="struct__SeafSyncManager.html#af27650b12e9237509a8b214808f18e21">upload_limit</a>)
<a name="l02090"></a>02090             <span class="comment">/* 100 milliseconds */</span>
<a name="l02091"></a>02091             <a class="code" href="seafile-4_81_82_2common_2common_8h.html#aed82f1a99a580ff6fdf9ad1dd4f81567">G_USLEEP</a> (100000);
<a name="l02092"></a>02092         <span class="keywordflow">else</span>
<a name="l02093"></a>02093             <span class="keywordflow">break</span>;
<a name="l02094"></a>02094     }
<a name="l02095"></a>02095 
<a name="l02096"></a>02096     <span class="keywordflow">return</span> n;
<a name="l02097"></a>02097 }
<a name="l02098"></a>02098 
<a name="l02099"></a>02099 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02100"></a>02100 send_block (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task, <a class="code" href="struct__Connection.html">Connection</a> *conn, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="block-tx-utils_8h.html#a2d616e1f81d11995c8b388444be651ef">block_id</a>)
<a name="l02101"></a>02101 {
<a name="l02102"></a>02102     CURL *curl;
<a name="l02103"></a>02103     <span class="keywordtype">char</span> *url;
<a name="l02104"></a>02104     <span class="keywordtype">int</span> <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l02105"></a>02105     <a class="code" href="struct__BMetadata.html">BlockMetadata</a> *bmd;
<a name="l02106"></a>02106     <a class="code" href="struct__BHandle.html">BlockHandle</a> *block;
<a name="l02107"></a>02107     <span class="keywordtype">int</span> ret = 0;
<a name="l02108"></a>02108 
<a name="l02109"></a>02109     bmd = <a class="code" href="block-mgr_8c.html#a1a1cf6d507f6e6ce63e8f5e63fa7a837">seaf_block_manager_stat_block</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>,
<a name="l02110"></a>02110                                          task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l02111"></a>02111                                          block_id);
<a name="l02112"></a>02112     <span class="keywordflow">if</span> (!bmd) {
<a name="l02113"></a>02113         seaf_warning (<span class="stringliteral">&quot;Failed to stat block %s in repo %s.\n&quot;</span>,
<a name="l02114"></a>02114                       block_id, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02115"></a>02115         <span class="keywordflow">return</span> -1;
<a name="l02116"></a>02116     }
<a name="l02117"></a>02117 
<a name="l02118"></a>02118     block = <a class="code" href="block-mgr_8c.html#a056c34bef84deef28712969643b00dbc">seaf_block_manager_open_block</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>,
<a name="l02119"></a>02119                                            task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l02120"></a>02120                                            block_id, <a class="code" href="block_8h.html#a99fb83031ce9923c84392b4e92f956b5a70a1891853a7e204617bdcf9adcfd4a5">BLOCK_READ</a>);
<a name="l02121"></a>02121     <span class="keywordflow">if</span> (!block) {
<a name="l02122"></a>02122         seaf_warning (<span class="stringliteral">&quot;Failed to open block %s in repo %s.\n&quot;</span>,
<a name="l02123"></a>02123                       block_id, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02124"></a>02124         g_free (bmd);
<a name="l02125"></a>02125         <span class="keywordflow">return</span> -1;
<a name="l02126"></a>02126     }
<a name="l02127"></a>02127 
<a name="l02128"></a>02128     <a class="code" href="structSendBlockData.html">SendBlockData</a> data;
<a name="l02129"></a>02129     memset (&amp;data, 0, <span class="keyword">sizeof</span>(data));
<a name="l02130"></a>02130     memcpy (data.<a class="code" href="structSendBlockData.html#af1f3601d724987a19940bdcfdf6e2022">block_id</a>, block_id, 40);
<a name="l02131"></a>02131     data.<a class="code" href="structSendBlockData.html#a8bbded6d0714dabb52c9c404da69c396">block</a> = block;
<a name="l02132"></a>02132     data.<a class="code" href="structSendBlockData.html#ad2e9472f60f27e2f17ed35d40dda2d30">task</a> = task;
<a name="l02133"></a>02133 
<a name="l02134"></a>02134     curl = conn-&gt;<a class="code" href="struct__Connection.html#af8b983fae165a24c7f9cc24e47361d57">curl</a>;
<a name="l02135"></a>02135 
<a name="l02136"></a>02136     url = g_strdup_printf (<span class="stringliteral">&quot;%s/seafhttp/repo/%s/block/%s&quot;</span>,
<a name="l02137"></a>02137                            task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, block_id);
<a name="l02138"></a>02138 
<a name="l02139"></a>02139     <span class="keywordflow">if</span> (http_put (curl, url, task-&gt;<a class="code" href="struct__HttpTxTask.html#a7efdacb9425ad03ba280b6435b0e6ba6">token</a>,
<a name="l02140"></a>02140                   NULL, bmd-&gt;<a class="code" href="struct__BMetadata.html#a7802358b1840abcb33aa8b3fd8f4cf58">size</a>,
<a name="l02141"></a>02141                   send_block_callback, &amp;data,
<a name="l02142"></a>02142                   &amp;status, NULL, NULL) &lt; 0) {
<a name="l02143"></a>02143         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>)
<a name="l02144"></a>02144             <span class="keywordflow">goto</span> out;
<a name="l02145"></a>02145 
<a name="l02146"></a>02146         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> == <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7acfb83d1b15f50205274c55a792a14e1a">TASK_OK</a>)
<a name="l02147"></a>02147             task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159acf2d300b20f69c681bb82b34900a54f6">HTTP_TASK_ERR_NET</a>;
<a name="l02148"></a>02148         ret = -1;
<a name="l02149"></a>02149         <span class="keywordflow">goto</span> out;
<a name="l02150"></a>02150     }
<a name="l02151"></a>02151 
<a name="l02152"></a>02152     <span class="keywordflow">if</span> (status != <a class="code" href="http-tx-mgr_8c.html#a02e6d59009dee759528ec81fc9a8eeff">HTTP_OK</a>) {
<a name="l02153"></a>02153         seaf_warning (<span class="stringliteral">&quot;Bad response code for PUT %s: %d.\n&quot;</span>, url, status);
<a name="l02154"></a>02154         handle_http_errors (task, status);
<a name="l02155"></a>02155         ret = -1;
<a name="l02156"></a>02156     }
<a name="l02157"></a>02157 
<a name="l02158"></a>02158 out:
<a name="l02159"></a>02159     g_free (url);
<a name="l02160"></a>02160     curl_easy_reset (curl);
<a name="l02161"></a>02161     g_free (bmd);
<a name="l02162"></a>02162     <a class="code" href="block-mgr_8c.html#aa78b63ce0fb941132f6db665de4966bc">seaf_block_manager_close_block</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>, block);
<a name="l02163"></a>02163     <a class="code" href="block-mgr_8c.html#a61d32d9d0d064dea33a1e2e7008215c1">seaf_block_manager_block_handle_free</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>, block);
<a name="l02164"></a>02164 
<a name="l02165"></a>02165     <span class="keywordflow">return</span> ret;
<a name="l02166"></a>02166 }
<a name="l02167"></a>02167 
<a name="l02168"></a>02168 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02169"></a>02169 update_branch (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task, <a class="code" href="struct__Connection.html">Connection</a> *conn)
<a name="l02170"></a>02170 {
<a name="l02171"></a>02171     CURL *curl;
<a name="l02172"></a>02172     <span class="keywordtype">char</span> *url;
<a name="l02173"></a>02173     <span class="keywordtype">int</span> <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l02174"></a>02174     <span class="keywordtype">int</span> ret = 0;
<a name="l02175"></a>02175 
<a name="l02176"></a>02176     curl = conn-&gt;<a class="code" href="struct__Connection.html#af8b983fae165a24c7f9cc24e47361d57">curl</a>;
<a name="l02177"></a>02177 
<a name="l02178"></a>02178     url = g_strdup_printf (<span class="stringliteral">&quot;%s/seafhttp/repo/%s/commit/HEAD/?head=%s&quot;</span>,
<a name="l02179"></a>02179                            task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>);
<a name="l02180"></a>02180 
<a name="l02181"></a>02181     <span class="keywordflow">if</span> (http_put (curl, url, task-&gt;<a class="code" href="struct__HttpTxTask.html#a7efdacb9425ad03ba280b6435b0e6ba6">token</a>,
<a name="l02182"></a>02182                   NULL, 0,
<a name="l02183"></a>02183                   NULL, NULL,
<a name="l02184"></a>02184                   &amp;status, NULL, NULL) &lt; 0) {
<a name="l02185"></a>02185         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159acf2d300b20f69c681bb82b34900a54f6">HTTP_TASK_ERR_NET</a>;
<a name="l02186"></a>02186         ret = -1;
<a name="l02187"></a>02187         <span class="keywordflow">goto</span> out;
<a name="l02188"></a>02188     }
<a name="l02189"></a>02189 
<a name="l02190"></a>02190     <span class="keywordflow">if</span> (status != <a class="code" href="http-tx-mgr_8c.html#a02e6d59009dee759528ec81fc9a8eeff">HTTP_OK</a>) {
<a name="l02191"></a>02191         seaf_warning (<span class="stringliteral">&quot;Bad response code for PUT %s: %d.\n&quot;</span>, url, status);
<a name="l02192"></a>02192         handle_http_errors (task, status);
<a name="l02193"></a>02193         ret = -1;
<a name="l02194"></a>02194     }
<a name="l02195"></a>02195 
<a name="l02196"></a>02196 out:
<a name="l02197"></a>02197     g_free (url);
<a name="l02198"></a>02198     curl_easy_reset (curl);
<a name="l02199"></a>02199 
<a name="l02200"></a>02200     <span class="keywordflow">return</span> ret;
<a name="l02201"></a>02201 }
<a name="l02202"></a>02202 
<a name="l02203"></a>02203 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02204"></a>02204 update_master_branch (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task)
<a name="l02205"></a>02205 {
<a name="l02206"></a>02206     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch;
<a name="l02207"></a>02207     branch = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>,
<a name="l02208"></a>02208                                              task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>,
<a name="l02209"></a>02209                                              <span class="stringliteral">&quot;master&quot;</span>);
<a name="l02210"></a>02210     <span class="keywordflow">if</span> (!branch) {
<a name="l02211"></a>02211         branch = <a class="code" href="branch-mgr_8c.html#a4d213520d8a22d5191051715ccbfd1dd">seaf_branch_new</a> (<span class="stringliteral">&quot;master&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>);
<a name="l02212"></a>02212         <a class="code" href="branch-mgr_8c.html#ab67819118ec82d96e51f6c2cadd7a632">seaf_branch_manager_add_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, branch);
<a name="l02213"></a>02213         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l02214"></a>02214     } <span class="keywordflow">else</span> {
<a name="l02215"></a>02215         <a class="code" href="branch-mgr_8c.html#a7a776ebd084d2335050c68d9a2e10c18">seaf_branch_set_commit</a> (branch, task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>);
<a name="l02216"></a>02216         <a class="code" href="branch-mgr_8c.html#aab1588f5228eaf4405efb239a9ed5680">seaf_branch_manager_update_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, branch);
<a name="l02217"></a>02217         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l02218"></a>02218     }
<a name="l02219"></a>02219 }
<a name="l02220"></a>02220 
<a name="l02221"></a>02221 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l02222"></a>02222 http_upload_thread (<span class="keywordtype">void</span> *vdata)
<a name="l02223"></a>02223 {
<a name="l02224"></a>02224     <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task = vdata;
<a name="l02225"></a>02225     <a class="code" href="struct__HttpTxPriv.html">HttpTxPriv</a> *priv = <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>-&gt;<a class="code" href="struct__HttpTxManager.html#a3e124361f6d9812dd9e4fb15e7ea41e7">priv</a>;
<a name="l02226"></a>02226     <a class="code" href="struct__ConnectionPool.html">ConnectionPool</a> *pool;
<a name="l02227"></a>02227     <a class="code" href="struct__Connection.html">Connection</a> *conn = NULL;
<a name="l02228"></a>02228     <span class="keywordtype">char</span> *url = NULL;
<a name="l02229"></a>02229     GList *send_fs_list = NULL, *needed_fs_list = NULL;
<a name="l02230"></a>02230     GList *block_list = NULL, *needed_block_list = NULL;
<a name="l02231"></a>02231     GList *ptr;
<a name="l02232"></a>02232 
<a name="l02233"></a>02233     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *local = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>,
<a name="l02234"></a>02234                                                         task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, <span class="stringliteral">&quot;local&quot;</span>);
<a name="l02235"></a>02235     <span class="keywordflow">if</span> (!local) {
<a name="l02236"></a>02236         seaf_warning (<span class="stringliteral">&quot;Failed to get branch local of repo %.8s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02237"></a>02237         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159ab2bac951aa574b49e1d988c044eea731">HTTP_TASK_ERR_BAD_LOCAL_DATA</a>;
<a name="l02238"></a>02238         <span class="keywordflow">goto</span> out;
<a name="l02239"></a>02239     }
<a name="l02240"></a>02240     memcpy (task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>, local-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>, 40);
<a name="l02241"></a>02241     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (local);
<a name="l02242"></a>02242 
<a name="l02243"></a>02243     pool = find_connection_pool (priv, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>);
<a name="l02244"></a>02244     <span class="keywordflow">if</span> (!pool) {
<a name="l02245"></a>02245         seaf_warning (<span class="stringliteral">&quot;Failed to create connection pool for host %s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>);
<a name="l02246"></a>02246         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159a1b9f5fdd07452b49a753f1064b000db4">HTTP_TASK_ERR_NOT_ENOUGH_MEMORY</a>;
<a name="l02247"></a>02247         <span class="keywordflow">goto</span> out;
<a name="l02248"></a>02248     }
<a name="l02249"></a>02249 
<a name="l02250"></a>02250     conn = connection_pool_get_connection (pool);
<a name="l02251"></a>02251     <span class="keywordflow">if</span> (!conn) {
<a name="l02252"></a>02252         seaf_warning (<span class="stringliteral">&quot;Failed to get connection to host %s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>);
<a name="l02253"></a>02253         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159a1b9f5fdd07452b49a753f1064b000db4">HTTP_TASK_ERR_NOT_ENOUGH_MEMORY</a>;
<a name="l02254"></a>02254         <span class="keywordflow">goto</span> out;
<a name="l02255"></a>02255     }
<a name="l02256"></a>02256 
<a name="l02257"></a>02257     seaf_message (<span class="stringliteral">&quot;Upload with HTTP sync protocol version %d.\n&quot;</span>,
<a name="l02258"></a>02258                   task-&gt;<a class="code" href="struct__HttpTxTask.html#a6445d889b66d46f624a8ce480792f5f0">protocol_version</a>);
<a name="l02259"></a>02259 
<a name="l02260"></a>02260     transition_state (task, task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a>, <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617a51cd98784e48af2aff2e252cda6c23c1">HTTP_TASK_RT_STATE_CHECK</a>);
<a name="l02261"></a>02261 
<a name="l02262"></a>02262     <span class="keywordflow">if</span> (check_permission (task, conn) &lt; 0) {
<a name="l02263"></a>02263         seaf_warning (<span class="stringliteral">&quot;Upload permission denied for repo %.8s on server %s.\n&quot;</span>,
<a name="l02264"></a>02264                       task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>);
<a name="l02265"></a>02265         <span class="keywordflow">goto</span> out;
<a name="l02266"></a>02266     }
<a name="l02267"></a>02267 
<a name="l02268"></a>02268     <span class="keywordflow">if</span> (check_quota (task, conn) &lt; 0) {
<a name="l02269"></a>02269         seaf_warning (<span class="stringliteral">&quot;Not enough quota for repo %.8s on server %s.\n&quot;</span>,
<a name="l02270"></a>02270                       task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>);
<a name="l02271"></a>02271         <span class="keywordflow">goto</span> out;
<a name="l02272"></a>02272     }
<a name="l02273"></a>02273 
<a name="l02274"></a>02274     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>)
<a name="l02275"></a>02275         <span class="keywordflow">goto</span> out;
<a name="l02276"></a>02276 
<a name="l02277"></a>02277     transition_state (task, task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a>, <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617ad5d2aea26c1c9286119dcc352dcf681d">HTTP_TASK_RT_STATE_COMMIT</a>);
<a name="l02278"></a>02278 
<a name="l02279"></a>02279     <span class="keywordflow">if</span> (send_commit_object (task, conn) &lt; 0) {
<a name="l02280"></a>02280         seaf_warning (<span class="stringliteral">&quot;Failed to send head commit for repo %.8s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02281"></a>02281         <span class="keywordflow">goto</span> out;
<a name="l02282"></a>02282     }
<a name="l02283"></a>02283 
<a name="l02284"></a>02284     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>)
<a name="l02285"></a>02285         <span class="keywordflow">goto</span> out;
<a name="l02286"></a>02286 
<a name="l02287"></a>02287     transition_state (task, task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a>, <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617a0696dfdf8d8ac3872dcd8155a14353d3">HTTP_TASK_RT_STATE_FS</a>);
<a name="l02288"></a>02288 
<a name="l02289"></a>02289     send_fs_list = calculate_send_fs_object_list (task);
<a name="l02290"></a>02290     <span class="keywordflow">if</span> (!send_fs_list) {
<a name="l02291"></a>02291         seaf_warning (<span class="stringliteral">&quot;Failed to calculate fs object list for repo %.8s.\n&quot;</span>,
<a name="l02292"></a>02292                       task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02293"></a>02293         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159ab2bac951aa574b49e1d988c044eea731">HTTP_TASK_ERR_BAD_LOCAL_DATA</a>;
<a name="l02294"></a>02294         <span class="keywordflow">goto</span> out;
<a name="l02295"></a>02295     }
<a name="l02296"></a>02296 
<a name="l02297"></a>02297     url = g_strdup_printf (<span class="stringliteral">&quot;%s/seafhttp/repo/%s/check-fs/&quot;</span>,
<a name="l02298"></a>02298                            task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02299"></a>02299 
<a name="l02300"></a>02300     <span class="keywordflow">while</span> (send_fs_list != NULL) {
<a name="l02301"></a>02301         <span class="keywordflow">if</span> (upload_check_id_list_segment (task, conn, url,
<a name="l02302"></a>02302                                           &amp;send_fs_list, &amp;needed_fs_list) &lt; 0) {
<a name="l02303"></a>02303             seaf_warning (<span class="stringliteral">&quot;Failed to check fs list for repo %.8s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02304"></a>02304             <span class="keywordflow">goto</span> out;
<a name="l02305"></a>02305         }
<a name="l02306"></a>02306 
<a name="l02307"></a>02307         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>)
<a name="l02308"></a>02308             <span class="keywordflow">goto</span> out;
<a name="l02309"></a>02309     }
<a name="l02310"></a>02310     g_free (url);
<a name="l02311"></a>02311     url = NULL;
<a name="l02312"></a>02312 
<a name="l02313"></a>02313     <span class="keywordflow">while</span> (needed_fs_list != NULL) {
<a name="l02314"></a>02314         <span class="keywordflow">if</span> (send_fs_objects (task, conn, &amp;needed_fs_list) &lt; 0) {
<a name="l02315"></a>02315             seaf_warning (<span class="stringliteral">&quot;Failed to send fs objects for repo %.8s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02316"></a>02316             <span class="keywordflow">goto</span> out;
<a name="l02317"></a>02317         }
<a name="l02318"></a>02318 
<a name="l02319"></a>02319         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>)
<a name="l02320"></a>02320             <span class="keywordflow">goto</span> out;
<a name="l02321"></a>02321     }
<a name="l02322"></a>02322 
<a name="l02323"></a>02323     transition_state (task, task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a>, <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617a96aaa723a45db207d64fd7baf1ca23c5">HTTP_TASK_RT_STATE_BLOCK</a>);
<a name="l02324"></a>02324 
<a name="l02325"></a>02325     <span class="keywordflow">if</span> (calculate_block_list (task, &amp;block_list) &lt; 0) {
<a name="l02326"></a>02326         seaf_warning (<span class="stringliteral">&quot;Failed to calculate block list for repo %.8s.\n&quot;</span>,
<a name="l02327"></a>02327                       task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02328"></a>02328         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159ab2bac951aa574b49e1d988c044eea731">HTTP_TASK_ERR_BAD_LOCAL_DATA</a>;
<a name="l02329"></a>02329         <span class="keywordflow">goto</span> out;
<a name="l02330"></a>02330     }
<a name="l02331"></a>02331 
<a name="l02332"></a>02332     url = g_strdup_printf (<span class="stringliteral">&quot;%s/seafhttp/repo/%s/check-blocks/&quot;</span>,
<a name="l02333"></a>02333                            task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02334"></a>02334 
<a name="l02335"></a>02335     <span class="keywordflow">while</span> (block_list != NULL) {
<a name="l02336"></a>02336         <span class="keywordflow">if</span> (upload_check_id_list_segment (task, conn, url,
<a name="l02337"></a>02337                                           &amp;block_list, &amp;needed_block_list) &lt; 0) {
<a name="l02338"></a>02338             seaf_warning (<span class="stringliteral">&quot;Failed to check block list for repo %.8s.\n&quot;</span>,
<a name="l02339"></a>02339                           task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02340"></a>02340             <span class="keywordflow">goto</span> out;
<a name="l02341"></a>02341         }
<a name="l02342"></a>02342 
<a name="l02343"></a>02343         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>)
<a name="l02344"></a>02344             <span class="keywordflow">goto</span> out;
<a name="l02345"></a>02345     }
<a name="l02346"></a>02346     g_free (url);
<a name="l02347"></a>02347     url = NULL;
<a name="l02348"></a>02348 
<a name="l02349"></a>02349     task-&gt;<a class="code" href="struct__HttpTxTask.html#a613e443291cc821e0165fc4aaa239fa5">n_blocks</a> = g_list_length (needed_block_list);
<a name="l02350"></a>02350 
<a name="l02351"></a>02351     seaf_debug (<span class="stringliteral">&quot;%d blocks to send for %s:%s.\n&quot;</span>,
<a name="l02352"></a>02352                 task-&gt;<a class="code" href="struct__HttpTxTask.html#a613e443291cc821e0165fc4aaa239fa5">n_blocks</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02353"></a>02353 
<a name="l02354"></a>02354     <span class="keywordtype">char</span> *<a class="code" href="block-tx-utils_8h.html#a2d616e1f81d11995c8b388444be651ef">block_id</a>;
<a name="l02355"></a>02355     <span class="keywordflow">for</span> (ptr = needed_block_list; ptr; ptr = ptr-&gt;next) {
<a name="l02356"></a>02356         block_id = ptr-&gt;data;
<a name="l02357"></a>02357 
<a name="l02358"></a>02358         <span class="keywordflow">if</span> (send_block (task, conn, block_id) &lt; 0) {
<a name="l02359"></a>02359             seaf_warning (<span class="stringliteral">&quot;Failed to send block %s for repo %.8s.\n&quot;</span>,
<a name="l02360"></a>02360                           block_id, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02361"></a>02361             <span class="keywordflow">goto</span> out;
<a name="l02362"></a>02362         }
<a name="l02363"></a>02363 
<a name="l02364"></a>02364         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>)
<a name="l02365"></a>02365             <span class="keywordflow">goto</span> out;
<a name="l02366"></a>02366 
<a name="l02367"></a>02367         ++(task-&gt;<a class="code" href="struct__HttpTxTask.html#a127ed6f0c32983aff3ad5f8794cd48e2">done_blocks</a>);
<a name="l02368"></a>02368     }
<a name="l02369"></a>02369 
<a name="l02370"></a>02370     transition_state (task, task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a>, <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617a1c57a6fd477510e55fb9b65cb9851bd4">HTTP_TASK_RT_STATE_UPDATE_BRANCH</a>);
<a name="l02371"></a>02371 
<a name="l02372"></a>02372     <span class="keywordflow">if</span> (update_branch (task, conn) &lt; 0) {
<a name="l02373"></a>02373         seaf_warning (<span class="stringliteral">&quot;Failed to update branch of repo %.8s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02374"></a>02374         <span class="keywordflow">goto</span> out;
<a name="l02375"></a>02375     }
<a name="l02376"></a>02376 
<a name="l02377"></a>02377     <span class="comment">/* After successful upload, the cached &#39;master&#39; branch should be updated to</span>
<a name="l02378"></a>02378 <span class="comment">     * the head commit of &#39;local&#39; branch.</span>
<a name="l02379"></a>02379 <span class="comment">     */</span>
<a name="l02380"></a>02380     update_master_branch (task);
<a name="l02381"></a>02381 
<a name="l02382"></a>02382 out:
<a name="l02383"></a>02383     <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (send_fs_list);
<a name="l02384"></a>02384     <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (needed_fs_list);
<a name="l02385"></a>02385     <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (block_list);
<a name="l02386"></a>02386     <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (needed_block_list);
<a name="l02387"></a>02387 
<a name="l02388"></a>02388     g_free (url);
<a name="l02389"></a>02389 
<a name="l02390"></a>02390     connection_pool_return_connection (pool, conn);
<a name="l02391"></a>02391 
<a name="l02392"></a>02392     <span class="keywordflow">return</span> vdata;
<a name="l02393"></a>02393 }
<a name="l02394"></a>02394 
<a name="l02395"></a>02395 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02396"></a>02396 http_upload_done (<span class="keywordtype">void</span> *vdata)
<a name="l02397"></a>02397 {
<a name="l02398"></a>02398     <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task = vdata;
<a name="l02399"></a>02399 
<a name="l02400"></a>02400     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> != <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159a7d2b0dc48a6f7c202ac60e59eb473c9c">HTTP_TASK_OK</a>)
<a name="l02401"></a>02401         transition_state (task, <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5a7829485480889c6958e5ddd2996b05ff">HTTP_TASK_STATE_ERROR</a>, <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617a48fa58e541bc5e2f237e8cd81b1a33b3">HTTP_TASK_RT_STATE_FINISHED</a>);
<a name="l02402"></a>02402     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>)
<a name="l02403"></a>02403         transition_state (task, task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a>, <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617a48fa58e541bc5e2f237e8cd81b1a33b3">HTTP_TASK_RT_STATE_FINISHED</a>);
<a name="l02404"></a>02404     <span class="keywordflow">else</span>
<a name="l02405"></a>02405         transition_state (task, <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5a0facf2c60cc1a598735bd4d8d488417b">HTTP_TASK_STATE_FINISHED</a>, <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617a48fa58e541bc5e2f237e8cd81b1a33b3">HTTP_TASK_RT_STATE_FINISHED</a>);
<a name="l02406"></a>02406 }
<a name="l02407"></a>02407 
<a name="l02408"></a>02408 <span class="comment">/* Download */</span>
<a name="l02409"></a>02409 
<a name="l02410"></a>02410 <span class="keyword">static</span> <span class="keywordtype">void</span> *http_download_thread (<span class="keywordtype">void</span> *vdata);
<a name="l02411"></a>02411 <span class="keyword">static</span> <span class="keywordtype">void</span> http_download_done (<span class="keywordtype">void</span> *vdata);
<a name="l02412"></a>02412 
<a name="l02413"></a>02413 <span class="keywordtype">int</span>
<a name="l02414"></a><a class="code" href="http-tx-mgr_8h.html#a0bd2d454a6270528980a22372d300ddb">02414</a> <a class="code" href="http-tx-mgr_8c.html#a0bd2d454a6270528980a22372d300ddb">http_tx_manager_add_download</a> (<a class="code" href="struct__HttpTxManager.html">HttpTxManager</a> *manager,
<a name="l02415"></a>02415                               <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l02416"></a>02416                               <span class="keywordtype">int</span> repo_version,
<a name="l02417"></a>02417                               <span class="keyword">const</span> <span class="keywordtype">char</span> *host,
<a name="l02418"></a>02418                               <span class="keyword">const</span> <span class="keywordtype">char</span> *token,
<a name="l02419"></a>02419                               <span class="keyword">const</span> <span class="keywordtype">char</span> *server_head_id,
<a name="l02420"></a>02420                               gboolean is_clone,
<a name="l02421"></a>02421                               <span class="keyword">const</span> <span class="keywordtype">char</span> *passwd,
<a name="l02422"></a>02422                               <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree,
<a name="l02423"></a>02423                               <span class="keywordtype">int</span> protocol_version,
<a name="l02424"></a>02424                               GError **error)
<a name="l02425"></a>02425 {
<a name="l02426"></a>02426     <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task;
<a name="l02427"></a>02427     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l02428"></a>02428 
<a name="l02429"></a>02429     <span class="keywordflow">if</span> (!repo_id || !token || !host || !server_head_id) {
<a name="l02430"></a>02430         g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Empty argument(s)&quot;</span>);
<a name="l02431"></a>02431         <span class="keywordflow">return</span> -1;
<a name="l02432"></a>02432     }
<a name="l02433"></a>02433 
<a name="l02434"></a>02434     <span class="keywordflow">if</span> (!is_clone) {
<a name="l02435"></a>02435         repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id);
<a name="l02436"></a>02436         <span class="keywordflow">if</span> (!repo) {
<a name="l02437"></a>02437             g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Repo not found&quot;</span>);
<a name="l02438"></a>02438             <span class="keywordflow">return</span> -1;
<a name="l02439"></a>02439         }
<a name="l02440"></a>02440     }
<a name="l02441"></a>02441 
<a name="l02442"></a>02442     clean_tasks_for_repo (manager, repo_id);
<a name="l02443"></a>02443 
<a name="l02444"></a>02444     task = http_tx_task_new (manager, repo_id, repo_version,
<a name="l02445"></a>02445                              <a class="code" href="http-tx-mgr_8h.html#a16af7b253440dadd46a80a4b9fddba4da429731c6953f215203cf1b17fe92ebb1">HTTP_TASK_TYPE_DOWNLOAD</a>, is_clone,
<a name="l02446"></a>02446                              host, token, passwd, worktree);
<a name="l02447"></a>02447 
<a name="l02448"></a>02448     memcpy (task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>, server_head_id, 40);
<a name="l02449"></a>02449     task-&gt;<a class="code" href="struct__HttpTxTask.html#a6445d889b66d46f624a8ce480792f5f0">protocol_version</a> = protocol_version;
<a name="l02450"></a>02450 
<a name="l02451"></a>02451     task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> = <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceac3efc29c1793f3f902e002589c600b33">TASK_STATE_NORMAL</a>;
<a name="l02452"></a>02452 
<a name="l02453"></a>02453     g_hash_table_insert (manager-&gt;<a class="code" href="struct__HttpTxManager.html#a3e124361f6d9812dd9e4fb15e7ea41e7">priv</a>-&gt;<a class="code" href="struct__HttpTxPriv.html#a054e2539c8af97620bcc0ab412398edf">download_tasks</a>,
<a name="l02454"></a>02454                          g_strdup(repo_id),
<a name="l02455"></a>02455                          task);
<a name="l02456"></a>02456 
<a name="l02457"></a>02457     <a class="code" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768">ccnet_job_manager_schedule_job</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#abcbb9886e315abb16c620ce49808a0b2">job_mgr</a>,
<a name="l02458"></a>02458                                     http_download_thread,
<a name="l02459"></a>02459                                     http_download_done,
<a name="l02460"></a>02460                                     task);
<a name="l02461"></a>02461 
<a name="l02462"></a>02462     <span class="keywordflow">return</span> 0;
<a name="l02463"></a>02463 }
<a name="l02464"></a>02464 
<a name="l02465"></a>02465 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02466"></a>02466 get_commit_object (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task, <a class="code" href="struct__Connection.html">Connection</a> *conn)
<a name="l02467"></a>02467 {
<a name="l02468"></a>02468     CURL *curl;
<a name="l02469"></a>02469     <span class="keywordtype">char</span> *url;
<a name="l02470"></a>02470     <span class="keywordtype">int</span> <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l02471"></a>02471     <span class="keywordtype">char</span> *rsp_content = NULL;
<a name="l02472"></a>02472     gint64 rsp_size;
<a name="l02473"></a>02473     <span class="keywordtype">int</span> ret = 0;
<a name="l02474"></a>02474 
<a name="l02475"></a>02475     curl = conn-&gt;<a class="code" href="struct__Connection.html#af8b983fae165a24c7f9cc24e47361d57">curl</a>;
<a name="l02476"></a>02476 
<a name="l02477"></a>02477     url = g_strdup_printf (<span class="stringliteral">&quot;%s/seafhttp/repo/%s/commit/%s&quot;</span>,
<a name="l02478"></a>02478                            task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>);
<a name="l02479"></a>02479 
<a name="l02480"></a>02480     <span class="keywordflow">if</span> (http_get (curl, url, task-&gt;<a class="code" href="struct__HttpTxTask.html#a7efdacb9425ad03ba280b6435b0e6ba6">token</a>, &amp;status,
<a name="l02481"></a>02481                   &amp;rsp_content, &amp;rsp_size,
<a name="l02482"></a>02482                   NULL, NULL) &lt; 0) {
<a name="l02483"></a>02483         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159acf2d300b20f69c681bb82b34900a54f6">HTTP_TASK_ERR_NET</a>;
<a name="l02484"></a>02484         ret = -1;
<a name="l02485"></a>02485         <span class="keywordflow">goto</span> out;
<a name="l02486"></a>02486     }
<a name="l02487"></a>02487 
<a name="l02488"></a>02488     <span class="keywordflow">if</span> (status != <a class="code" href="http-tx-mgr_8c.html#a02e6d59009dee759528ec81fc9a8eeff">HTTP_OK</a>) {
<a name="l02489"></a>02489         seaf_warning (<span class="stringliteral">&quot;Bad response code for GET %s: %d.\n&quot;</span>, url, status);
<a name="l02490"></a>02490         handle_http_errors (task, status);
<a name="l02491"></a>02491         ret = -1;
<a name="l02492"></a>02492         <span class="keywordflow">goto</span> out;
<a name="l02493"></a>02493     }
<a name="l02494"></a>02494 
<a name="l02495"></a>02495     <span class="keywordtype">int</span> rc = <a class="code" href="obj-store_8c.html#a673d1262bbb4caf66816c89bde13b429">seaf_obj_store_write_obj</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>-&gt;<a class="code" href="struct__SeafCommitManager.html#a1b7f3176ee61112e00532b1fc4b007e8">obj_store</a>,
<a name="l02496"></a>02496                                        task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l02497"></a>02497                                        task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>,
<a name="l02498"></a>02498                                        rsp_content,
<a name="l02499"></a>02499                                        rsp_size,
<a name="l02500"></a>02500                                        FALSE);
<a name="l02501"></a>02501     <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l02502"></a>02502         seaf_warning (<span class="stringliteral">&quot;Failed to save commit %s in repo %.8s.\n&quot;</span>,
<a name="l02503"></a>02503                       task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02504"></a>02504         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159a3e94b4f3a5cae152befefab9cb2a2a6c">HTTP_TASK_ERR_WRITE_LOCAL_DATA</a>;
<a name="l02505"></a>02505         ret = -1;
<a name="l02506"></a>02506     }
<a name="l02507"></a>02507 
<a name="l02508"></a>02508 out:
<a name="l02509"></a>02509     g_free (url);
<a name="l02510"></a>02510     g_free (rsp_content);
<a name="l02511"></a>02511     curl_easy_reset (curl);
<a name="l02512"></a>02512 
<a name="l02513"></a>02513     <span class="keywordflow">return</span> ret;
<a name="l02514"></a>02514 }
<a name="l02515"></a>02515 
<a name="l02516"></a>02516 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02517"></a>02517 get_needed_fs_id_list (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task, <a class="code" href="struct__Connection.html">Connection</a> *conn, GList **fs_id_list)
<a name="l02518"></a>02518 {
<a name="l02519"></a>02519     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *master;
<a name="l02520"></a>02520     CURL *curl;
<a name="l02521"></a>02521     <span class="keywordtype">char</span> *url = NULL;
<a name="l02522"></a>02522     <span class="keywordtype">int</span> <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l02523"></a>02523     <span class="keywordtype">char</span> *rsp_content = NULL;
<a name="l02524"></a>02524     gint64 rsp_size;
<a name="l02525"></a>02525     <span class="keywordtype">int</span> ret = 0;
<a name="l02526"></a>02526     json_t *array;
<a name="l02527"></a>02527     json_error_t jerror;
<a name="l02528"></a>02528     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="Backups_2http-server_8c.html#acdc8b2e33d61c23557d7e7563f00ef6f">obj_id</a>;
<a name="l02529"></a>02529 
<a name="l02530"></a>02530     <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__HttpTxTask.html#a8dc7ba305c249ab73ce9424725776d41">is_clone</a>) {
<a name="l02531"></a>02531         master = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>,
<a name="l02532"></a>02532                                                  task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>,
<a name="l02533"></a>02533                                                  <span class="stringliteral">&quot;master&quot;</span>);
<a name="l02534"></a>02534         <span class="keywordflow">if</span> (!master) {
<a name="l02535"></a>02535             seaf_warning (<span class="stringliteral">&quot;Failed to get branch master for repo %.8s.\n&quot;</span>,
<a name="l02536"></a>02536                           task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02537"></a>02537             <span class="keywordflow">return</span> -1;
<a name="l02538"></a>02538         }
<a name="l02539"></a>02539 
<a name="l02540"></a>02540         url = g_strdup_printf (<span class="stringliteral">&quot;%s/seafhttp/repo/%s/fs-id-list/&quot;</span>
<a name="l02541"></a>02541                                <span class="stringliteral">&quot;?server-head=%s&amp;client-head=%s&quot;</span>,
<a name="l02542"></a>02542                                task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>,
<a name="l02543"></a>02543                                task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>, master-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l02544"></a>02544 
<a name="l02545"></a>02545         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (master);
<a name="l02546"></a>02546     } <span class="keywordflow">else</span> {
<a name="l02547"></a>02547         url = g_strdup_printf (<span class="stringliteral">&quot;%s/seafhttp/repo/%s/fs-id-list/?server-head=%s&quot;</span>,
<a name="l02548"></a>02548                                task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>);
<a name="l02549"></a>02549     }
<a name="l02550"></a>02550 
<a name="l02551"></a>02551     curl = conn-&gt;<a class="code" href="struct__Connection.html#af8b983fae165a24c7f9cc24e47361d57">curl</a>;
<a name="l02552"></a>02552 
<a name="l02553"></a>02553     <span class="keywordflow">if</span> (http_get (curl, url, task-&gt;<a class="code" href="struct__HttpTxTask.html#a7efdacb9425ad03ba280b6435b0e6ba6">token</a>, &amp;status,
<a name="l02554"></a>02554                   &amp;rsp_content, &amp;rsp_size,
<a name="l02555"></a>02555                   NULL, NULL) &lt; 0) {
<a name="l02556"></a>02556         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159acf2d300b20f69c681bb82b34900a54f6">HTTP_TASK_ERR_NET</a>;
<a name="l02557"></a>02557         ret = -1;
<a name="l02558"></a>02558         <span class="keywordflow">goto</span> out;
<a name="l02559"></a>02559     }
<a name="l02560"></a>02560 
<a name="l02561"></a>02561     <span class="keywordflow">if</span> (status != <a class="code" href="http-tx-mgr_8c.html#a02e6d59009dee759528ec81fc9a8eeff">HTTP_OK</a>) {
<a name="l02562"></a>02562         seaf_warning (<span class="stringliteral">&quot;Bad response code for GET %s: %d.\n&quot;</span>, url, status);
<a name="l02563"></a>02563         handle_http_errors (task, status);
<a name="l02564"></a>02564         ret = -1;
<a name="l02565"></a>02565         <span class="keywordflow">goto</span> out;
<a name="l02566"></a>02566     }
<a name="l02567"></a>02567 
<a name="l02568"></a>02568     array = json_loadb (rsp_content, rsp_size, 0, &amp;jerror);
<a name="l02569"></a>02569     <span class="keywordflow">if</span> (!array) {
<a name="l02570"></a>02570         seaf_warning (<span class="stringliteral">&quot;Invalid JSON response from the server: %s.\n&quot;</span>, jerror.text);
<a name="l02571"></a>02571         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159aba8619a02d36bc551d2cd4bffd978a42">HTTP_TASK_ERR_SERVER</a>;
<a name="l02572"></a>02572         ret = -1;
<a name="l02573"></a>02573         <span class="keywordflow">goto</span> out;
<a name="l02574"></a>02574     }
<a name="l02575"></a>02575 
<a name="l02576"></a>02576     <span class="keywordtype">int</span> i;
<a name="l02577"></a>02577     <span class="keywordtype">size_t</span> n = json_array_size (array);
<a name="l02578"></a>02578     json_t *str;
<a name="l02579"></a>02579 
<a name="l02580"></a>02580     seaf_debug (<span class="stringliteral">&quot;Received fs object list size %lu from %s:%s.\n&quot;</span>,
<a name="l02581"></a>02581                 n, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02582"></a>02582 
<a name="l02583"></a>02583     GHashTable *checked_objs = g_hash_table_new_full (g_str_hash, g_str_equal,
<a name="l02584"></a>02584                                                       g_free, NULL);
<a name="l02585"></a>02585 
<a name="l02586"></a>02586     <span class="keywordflow">for</span> (i = 0; i &lt; n; ++i) {
<a name="l02587"></a>02587         str = json_array_get (array, i);
<a name="l02588"></a>02588         <span class="keywordflow">if</span> (!str) {
<a name="l02589"></a>02589             seaf_warning (<span class="stringliteral">&quot;Invalid JSON response from the server.\n&quot;</span>);
<a name="l02590"></a>02590             json_decref (array);
<a name="l02591"></a>02591             <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (*fs_id_list);
<a name="l02592"></a>02592             ret = -1;
<a name="l02593"></a>02593             <span class="keywordflow">goto</span> out;
<a name="l02594"></a>02594         }
<a name="l02595"></a>02595 
<a name="l02596"></a>02596         obj_id = json_string_value(str);
<a name="l02597"></a>02597 
<a name="l02598"></a>02598         <span class="keywordflow">if</span> (g_hash_table_lookup (checked_objs, obj_id))
<a name="l02599"></a>02599             <span class="keywordflow">continue</span>;
<a name="l02600"></a>02600         <span class="keywordtype">char</span> *key = g_strdup(obj_id);
<a name="l02601"></a>02601         g_hash_table_replace (checked_objs, key, key);
<a name="l02602"></a>02602 
<a name="l02603"></a>02603         <span class="keywordflow">if</span> (!<a class="code" href="obj-store_8c.html#abebb46e47ff4c76a309686613bd17ec1">seaf_obj_store_obj_exists</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>-&gt;<a class="code" href="struct__SeafFSManager.html#aff81d27b12d5aaefe129f39071d33386">obj_store</a>,
<a name="l02604"></a>02604                                         task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l02605"></a>02605                                         obj_id)) {
<a name="l02606"></a>02606             *fs_id_list = g_list_prepend (*fs_id_list, g_strdup(obj_id));
<a name="l02607"></a>02607         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#a8dc7ba305c249ab73ce9424725776d41">is_clone</a>) {
<a name="l02608"></a>02608             gboolean io_error = FALSE;
<a name="l02609"></a>02609             gboolean sound;
<a name="l02610"></a>02610             sound = <a class="code" href="fs-mgr_8c.html#a70406a91027ed3add3d9026d8dad8a0c">seaf_fs_manager_verify_object</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
<a name="l02611"></a>02611                                                    task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l02612"></a>02612                                                    obj_id, FALSE, &amp;io_error);
<a name="l02613"></a>02613             <span class="keywordflow">if</span> (!sound &amp;&amp; !io_error)
<a name="l02614"></a>02614                 *fs_id_list = g_list_prepend (*fs_id_list, g_strdup(obj_id));
<a name="l02615"></a>02615         }
<a name="l02616"></a>02616     }
<a name="l02617"></a>02617 
<a name="l02618"></a>02618     json_decref (array);
<a name="l02619"></a>02619     g_hash_table_destroy (checked_objs);
<a name="l02620"></a>02620 
<a name="l02621"></a>02621 out:
<a name="l02622"></a>02622     g_free (url);
<a name="l02623"></a>02623     g_free (rsp_content);
<a name="l02624"></a>02624     curl_easy_reset (curl);
<a name="l02625"></a>02625 
<a name="l02626"></a>02626     <span class="keywordflow">return</span> ret;
<a name="l02627"></a>02627 }
<a name="l02628"></a>02628 
<a name="l02629"></a><a class="code" href="http-tx-mgr_8c.html#a7f001889686003b4656202668fe24f75">02629</a> <span class="preprocessor">#define GET_FS_OBJECT_N 100</span>
<a name="l02630"></a>02630 <span class="preprocessor"></span>
<a name="l02631"></a>02631 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02632"></a>02632 get_fs_objects (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task, <a class="code" href="struct__Connection.html">Connection</a> *conn, GList **fs_list)
<a name="l02633"></a>02633 {
<a name="l02634"></a>02634     json_t *array;
<a name="l02635"></a>02635     json_error_t jerror;
<a name="l02636"></a>02636     <span class="keywordtype">char</span> *<a class="code" href="Backups_2http-server_8c.html#acdc8b2e33d61c23557d7e7563f00ef6f">obj_id</a>;
<a name="l02637"></a>02637     <span class="keywordtype">int</span> n_sent = 0;
<a name="l02638"></a>02638     <span class="keywordtype">char</span> *data = NULL;
<a name="l02639"></a>02639     <span class="keywordtype">int</span> len;
<a name="l02640"></a>02640     CURL *curl;
<a name="l02641"></a>02641     <span class="keywordtype">char</span> *url = NULL;
<a name="l02642"></a>02642     <span class="keywordtype">int</span> <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l02643"></a>02643     <span class="keywordtype">char</span> *rsp_content = NULL;
<a name="l02644"></a>02644     gint64 rsp_size;
<a name="l02645"></a>02645     <span class="keywordtype">int</span> ret = 0;
<a name="l02646"></a>02646     GHashTable *requested;
<a name="l02647"></a>02647 
<a name="l02648"></a>02648     <span class="comment">/* Convert object id list to JSON format. */</span>
<a name="l02649"></a>02649 
<a name="l02650"></a>02650     requested = g_hash_table_new_full (g_str_hash, g_str_equal, g_free, NULL);
<a name="l02651"></a>02651 
<a name="l02652"></a>02652     array = json_array ();
<a name="l02653"></a>02653 
<a name="l02654"></a>02654     <span class="keywordflow">while</span> (*fs_list != NULL) {
<a name="l02655"></a>02655         obj_id = (*fs_list)-&gt;data;
<a name="l02656"></a>02656         json_array_append_new (array, json_string(obj_id));
<a name="l02657"></a>02657 
<a name="l02658"></a>02658         *fs_list = g_list_delete_link (*fs_list, *fs_list);
<a name="l02659"></a>02659 
<a name="l02660"></a>02660         g_hash_table_replace (requested, obj_id, obj_id);
<a name="l02661"></a>02661 
<a name="l02662"></a>02662         <span class="keywordflow">if</span> (++n_sent &gt;= <a class="code" href="http-tx-mgr_8c.html#a7f001889686003b4656202668fe24f75">GET_FS_OBJECT_N</a>)
<a name="l02663"></a>02663             <span class="keywordflow">break</span>;
<a name="l02664"></a>02664     }
<a name="l02665"></a>02665 
<a name="l02666"></a>02666     seaf_debug (<span class="stringliteral">&quot;Requesting %d fs objects from %s:%s.\n&quot;</span>,
<a name="l02667"></a>02667                 n_sent, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02668"></a>02668 
<a name="l02669"></a>02669     data = json_dumps (array, 0);
<a name="l02670"></a>02670     len = strlen(data);
<a name="l02671"></a>02671     json_decref (array);
<a name="l02672"></a>02672 
<a name="l02673"></a>02673     <span class="comment">/* Send fs object id list. */</span>
<a name="l02674"></a>02674 
<a name="l02675"></a>02675     curl = conn-&gt;<a class="code" href="struct__Connection.html#af8b983fae165a24c7f9cc24e47361d57">curl</a>;
<a name="l02676"></a>02676 
<a name="l02677"></a>02677     url = g_strdup_printf (<span class="stringliteral">&quot;%s/seafhttp/repo/%s/pack-fs/&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02678"></a>02678 
<a name="l02679"></a>02679     <span class="keywordflow">if</span> (http_post (curl, url, task-&gt;<a class="code" href="struct__HttpTxTask.html#a7efdacb9425ad03ba280b6435b0e6ba6">token</a>,
<a name="l02680"></a>02680                    data, len,
<a name="l02681"></a>02681                    &amp;status, &amp;rsp_content, &amp;rsp_size) &lt; 0) {
<a name="l02682"></a>02682         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159acf2d300b20f69c681bb82b34900a54f6">HTTP_TASK_ERR_NET</a>;
<a name="l02683"></a>02683         ret = -1;
<a name="l02684"></a>02684         <span class="keywordflow">goto</span> out;
<a name="l02685"></a>02685     }
<a name="l02686"></a>02686 
<a name="l02687"></a>02687     <span class="keywordflow">if</span> (status != <a class="code" href="http-tx-mgr_8c.html#a02e6d59009dee759528ec81fc9a8eeff">HTTP_OK</a>) {
<a name="l02688"></a>02688         seaf_warning (<span class="stringliteral">&quot;Bad response code for POST %s: %d.\n&quot;</span>, url, status);
<a name="l02689"></a>02689         handle_http_errors (task, status);
<a name="l02690"></a>02690         ret = -1;
<a name="l02691"></a>02691         <span class="keywordflow">goto</span> out;
<a name="l02692"></a>02692     }
<a name="l02693"></a>02693 
<a name="l02694"></a>02694     <span class="comment">/* Save received fs objects. */</span>
<a name="l02695"></a>02695 
<a name="l02696"></a>02696     <span class="keywordtype">int</span> n_recv = 0;
<a name="l02697"></a>02697     <span class="keywordtype">char</span> *p = rsp_content;
<a name="l02698"></a>02698     ObjectHeader *hdr = (ObjectHeader *)p;
<a name="l02699"></a>02699     <span class="keywordtype">char</span> recv_obj_id[41];
<a name="l02700"></a>02700     <span class="keywordtype">int</span> n = 0;
<a name="l02701"></a>02701     <span class="keywordtype">int</span> <a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a>;
<a name="l02702"></a>02702     <span class="keywordtype">int</span> rc;
<a name="l02703"></a>02703     <span class="keywordflow">while</span> (n &lt; rsp_size) {
<a name="l02704"></a>02704         memcpy (recv_obj_id, hdr-&gt;obj_id, 40);
<a name="l02705"></a>02705         recv_obj_id[40] = 0;
<a name="l02706"></a>02706         size = ntohl (hdr-&gt;obj_size);
<a name="l02707"></a>02707         <span class="keywordflow">if</span> (n + <span class="keyword">sizeof</span>(ObjectHeader) + size &gt; rsp_size) {
<a name="l02708"></a>02708             seaf_warning (<span class="stringliteral">&quot;Incomplete object package received for repo %.8s.\n&quot;</span>,
<a name="l02709"></a>02709                           task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02710"></a>02710             task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159aba8619a02d36bc551d2cd4bffd978a42">HTTP_TASK_ERR_SERVER</a>;
<a name="l02711"></a>02711             ret = -1;
<a name="l02712"></a>02712             <span class="keywordflow">goto</span> out;
<a name="l02713"></a>02713         }
<a name="l02714"></a>02714 
<a name="l02715"></a>02715         ++n_recv;
<a name="l02716"></a>02716 
<a name="l02717"></a>02717         rc = <a class="code" href="obj-store_8c.html#a673d1262bbb4caf66816c89bde13b429">seaf_obj_store_write_obj</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>-&gt;<a class="code" href="struct__SeafFSManager.html#aff81d27b12d5aaefe129f39071d33386">obj_store</a>,
<a name="l02718"></a>02718                                        task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l02719"></a>02719                                        recv_obj_id,
<a name="l02720"></a>02720                                        hdr-&gt;object,
<a name="l02721"></a>02721                                        size, FALSE);
<a name="l02722"></a>02722         <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l02723"></a>02723             seaf_warning (<span class="stringliteral">&quot;Failed to write fs object %s in repo %.8s.\n&quot;</span>,
<a name="l02724"></a>02724                           recv_obj_id, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02725"></a>02725             task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159a3e94b4f3a5cae152befefab9cb2a2a6c">HTTP_TASK_ERR_WRITE_LOCAL_DATA</a>;
<a name="l02726"></a>02726             ret = -1;
<a name="l02727"></a>02727             <span class="keywordflow">goto</span> out;
<a name="l02728"></a>02728         }
<a name="l02729"></a>02729 
<a name="l02730"></a>02730         g_hash_table_remove (requested, recv_obj_id);
<a name="l02731"></a>02731 
<a name="l02732"></a>02732         p += (<span class="keyword">sizeof</span>(ObjectHeader) + size);
<a name="l02733"></a>02733         n += (<span class="keyword">sizeof</span>(ObjectHeader) + size);
<a name="l02734"></a>02734         hdr = (ObjectHeader *)p;
<a name="l02735"></a>02735     }
<a name="l02736"></a>02736 
<a name="l02737"></a>02737     seaf_debug (<span class="stringliteral">&quot;Received %d fs objects from %s:%s.\n&quot;</span>,
<a name="l02738"></a>02738                 n_recv, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02739"></a>02739 
<a name="l02740"></a>02740     <span class="comment">/* The server may not return all the objects we requested.</span>
<a name="l02741"></a>02741 <span class="comment">     * So we need to add back the remaining object ids into fs_list.</span>
<a name="l02742"></a>02742 <span class="comment">     */</span>
<a name="l02743"></a>02743     GHashTableIter iter;
<a name="l02744"></a>02744     gpointer key, value;
<a name="l02745"></a>02745     g_hash_table_iter_init (&amp;iter, requested);
<a name="l02746"></a>02746     <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
<a name="l02747"></a>02747         obj_id = key;
<a name="l02748"></a>02748         *fs_list = g_list_prepend (*fs_list, g_strdup(obj_id));
<a name="l02749"></a>02749     }
<a name="l02750"></a>02750     g_hash_table_destroy (requested);
<a name="l02751"></a>02751 
<a name="l02752"></a>02752 out:
<a name="l02753"></a>02753     g_free (url);
<a name="l02754"></a>02754     g_free (data);
<a name="l02755"></a>02755     g_free (rsp_content);
<a name="l02756"></a>02756     curl_easy_reset (curl);
<a name="l02757"></a>02757 
<a name="l02758"></a>02758     <span class="keywordflow">return</span> ret;
<a name="l02759"></a>02759 }
<a name="l02760"></a>02760 
<a name="l02761"></a><a class="code" href="structGetBlockData.html">02761</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l02762"></a><a class="code" href="structGetBlockData.html#a1515b2bb9dd04955f67560b1519dd61c">02762</a>     <span class="keywordtype">char</span> block_id[41];
<a name="l02763"></a><a class="code" href="structGetBlockData.html#a9314fa19bd161bbf4ebf6e9a0e8b6e3f">02763</a>     <a class="code" href="struct__BHandle.html">BlockHandle</a> *<a class="code" href="structGetBlockData.html#a9314fa19bd161bbf4ebf6e9a0e8b6e3f">block</a>;
<a name="l02764"></a><a class="code" href="structGetBlockData.html#acfae751c364f0708483f762bd6fb54c0">02764</a>     <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *<a class="code" href="structGetBlockData.html#acfae751c364f0708483f762bd6fb54c0">task</a>;
<a name="l02765"></a>02765 } <a class="code" href="structGetBlockData.html">GetBlockData</a>;
<a name="l02766"></a>02766 
<a name="l02767"></a>02767 <span class="keyword">static</span> <span class="keywordtype">size_t</span>
<a name="l02768"></a>02768 get_block_callback (<span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> size, <span class="keywordtype">size_t</span> nmemb, <span class="keywordtype">void</span> *userp)
<a name="l02769"></a>02769 {
<a name="l02770"></a>02770     <span class="keywordtype">size_t</span> realsize = size *nmemb;
<a name="l02771"></a>02771     <a class="code" href="structSendBlockData.html">SendBlockData</a> *data = userp;
<a name="l02772"></a>02772     <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task = data-&gt;<a class="code" href="structSendBlockData.html#ad2e9472f60f27e2f17ed35d40dda2d30">task</a>;
<a name="l02773"></a>02773     <span class="keywordtype">size_t</span> n;
<a name="l02774"></a>02774 
<a name="l02775"></a>02775     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>)
<a name="l02776"></a>02776         <span class="keywordflow">return</span> 0;
<a name="l02777"></a>02777 
<a name="l02778"></a>02778     n = <a class="code" href="block-mgr_8c.html#a3a19508559060678dcdf1b2426b8ed99">seaf_block_manager_write_block</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>,
<a name="l02779"></a>02779                                         data-&gt;<a class="code" href="structSendBlockData.html#a8bbded6d0714dabb52c9c404da69c396">block</a>,
<a name="l02780"></a>02780                                         ptr, realsize);
<a name="l02781"></a>02781     <span class="keywordflow">if</span> (n &lt; realsize) {
<a name="l02782"></a>02782         seaf_warning (<span class="stringliteral">&quot;Failed to write block %s in repo %.8s.\n&quot;</span>,
<a name="l02783"></a>02783                       data-&gt;<a class="code" href="structSendBlockData.html#af1f3601d724987a19940bdcfdf6e2022">block_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02784"></a>02784         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159ab2bac951aa574b49e1d988c044eea731">HTTP_TASK_ERR_BAD_LOCAL_DATA</a>;
<a name="l02785"></a>02785         <span class="keywordflow">return</span> n;
<a name="l02786"></a>02786     }
<a name="l02787"></a>02787 
<a name="l02788"></a>02788     <span class="comment">/* Update global transferred bytes. */</span>
<a name="l02789"></a>02789     g_atomic_int_add (&amp;(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a6b2a5e1e723955885f9fb27c5f064df4">sync_mgr</a>-&gt;<a class="code" href="struct__SeafSyncManager.html#a0c2c72b3bff4c8c3d5b29717c06f9195">recv_bytes</a>), n);
<a name="l02790"></a>02790 
<a name="l02791"></a>02791     <span class="comment">/* If uploaded bytes exceeds the limit, wait until the counter</span>
<a name="l02792"></a>02792 <span class="comment">     * is reset. We check the counter every 100 milliseconds, so we</span>
<a name="l02793"></a>02793 <span class="comment">     * can waste up to 100 milliseconds without sending data after</span>
<a name="l02794"></a>02794 <span class="comment">     * the counter is reset.</span>
<a name="l02795"></a>02795 <span class="comment">     */</span>
<a name="l02796"></a>02796     <span class="keywordflow">while</span> (1) {
<a name="l02797"></a>02797         gint sent = g_atomic_int_get(&amp;(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a6b2a5e1e723955885f9fb27c5f064df4">sync_mgr</a>-&gt;<a class="code" href="struct__SeafSyncManager.html#a0c2c72b3bff4c8c3d5b29717c06f9195">recv_bytes</a>));
<a name="l02798"></a>02798         <span class="keywordflow">if</span> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a6b2a5e1e723955885f9fb27c5f064df4">sync_mgr</a>-&gt;<a class="code" href="struct__SeafSyncManager.html#a8ca07c4d618fb2c931b0fbc616a24a47">download_limit</a> &gt; 0 &amp;&amp;
<a name="l02799"></a>02799             sent &gt; <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a6b2a5e1e723955885f9fb27c5f064df4">sync_mgr</a>-&gt;<a class="code" href="struct__SeafSyncManager.html#a8ca07c4d618fb2c931b0fbc616a24a47">download_limit</a>)
<a name="l02800"></a>02800             <span class="comment">/* 100 milliseconds */</span>
<a name="l02801"></a>02801             <a class="code" href="seafile-4_81_82_2common_2common_8h.html#aed82f1a99a580ff6fdf9ad1dd4f81567">G_USLEEP</a> (100000);
<a name="l02802"></a>02802         <span class="keywordflow">else</span>
<a name="l02803"></a>02803             <span class="keywordflow">break</span>;
<a name="l02804"></a>02804     }
<a name="l02805"></a>02805 
<a name="l02806"></a>02806     <span class="keywordflow">return</span> n;
<a name="l02807"></a>02807 }
<a name="l02808"></a>02808 
<a name="l02809"></a>02809 <span class="keywordtype">int</span>
<a name="l02810"></a><a class="code" href="http-tx-mgr_8c.html#a9405628380ded681f1831e92755869e3">02810</a> <a class="code" href="http-tx-mgr_8c.html#a9405628380ded681f1831e92755869e3">get_block</a> (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task, <a class="code" href="struct__Connection.html">Connection</a> *conn, <span class="keyword">const</span> <span class="keywordtype">char</span> *block_id)
<a name="l02811"></a>02811 {
<a name="l02812"></a>02812     CURL *curl;
<a name="l02813"></a>02813     <span class="keywordtype">char</span> *url;
<a name="l02814"></a>02814     <span class="keywordtype">int</span> <a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l02815"></a>02815     <a class="code" href="struct__BHandle.html">BlockHandle</a> *block;
<a name="l02816"></a>02816     <span class="keywordtype">int</span> ret = 0;
<a name="l02817"></a>02817 
<a name="l02818"></a>02818     block = <a class="code" href="block-mgr_8c.html#a056c34bef84deef28712969643b00dbc">seaf_block_manager_open_block</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>,
<a name="l02819"></a>02819                                            task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l02820"></a>02820                                            block_id, <a class="code" href="block_8h.html#a99fb83031ce9923c84392b4e92f956b5a0a33c2a4005cb32ae50b7f3688cfbc76">BLOCK_WRITE</a>);
<a name="l02821"></a>02821     <span class="keywordflow">if</span> (!block) {
<a name="l02822"></a>02822         seaf_warning (<span class="stringliteral">&quot;Failed to open block %s in repo %.8s.\n&quot;</span>,
<a name="l02823"></a>02823                       block_id, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02824"></a>02824         <span class="keywordflow">return</span> -1;
<a name="l02825"></a>02825     }
<a name="l02826"></a>02826 
<a name="l02827"></a>02827     <a class="code" href="structGetBlockData.html">GetBlockData</a> data;
<a name="l02828"></a>02828     memcpy (data.<a class="code" href="structGetBlockData.html#a1515b2bb9dd04955f67560b1519dd61c">block_id</a>, block_id, 40);
<a name="l02829"></a>02829     data.<a class="code" href="structGetBlockData.html#a9314fa19bd161bbf4ebf6e9a0e8b6e3f">block</a> = block;
<a name="l02830"></a>02830     data.<a class="code" href="structGetBlockData.html#acfae751c364f0708483f762bd6fb54c0">task</a> = task;
<a name="l02831"></a>02831 
<a name="l02832"></a>02832     curl = conn-&gt;<a class="code" href="struct__Connection.html#af8b983fae165a24c7f9cc24e47361d57">curl</a>;
<a name="l02833"></a>02833 
<a name="l02834"></a>02834     url = g_strdup_printf (<span class="stringliteral">&quot;%s/seafhttp/repo/%s/block/%s&quot;</span>,
<a name="l02835"></a>02835                            task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, block_id);
<a name="l02836"></a>02836 
<a name="l02837"></a>02837     <span class="keywordflow">if</span> (http_get (curl, url, task-&gt;<a class="code" href="struct__HttpTxTask.html#a7efdacb9425ad03ba280b6435b0e6ba6">token</a>, &amp;status, NULL, NULL,
<a name="l02838"></a>02838                   get_block_callback, &amp;data) &lt; 0) {
<a name="l02839"></a>02839         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>)
<a name="l02840"></a>02840             <span class="keywordflow">goto</span> error;
<a name="l02841"></a>02841 
<a name="l02842"></a>02842         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> == <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159a7d2b0dc48a6f7c202ac60e59eb473c9c">HTTP_TASK_OK</a>)
<a name="l02843"></a>02843             task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159acf2d300b20f69c681bb82b34900a54f6">HTTP_TASK_ERR_NET</a>;
<a name="l02844"></a>02844         ret = -1;
<a name="l02845"></a>02845         <span class="keywordflow">goto</span> error;
<a name="l02846"></a>02846     }
<a name="l02847"></a>02847 
<a name="l02848"></a>02848     <span class="keywordflow">if</span> (status != <a class="code" href="http-tx-mgr_8c.html#a02e6d59009dee759528ec81fc9a8eeff">HTTP_OK</a>) {
<a name="l02849"></a>02849         seaf_warning (<span class="stringliteral">&quot;Bad response code for GET %s: %d.\n&quot;</span>, url, status);
<a name="l02850"></a>02850         handle_http_errors (task, status);
<a name="l02851"></a>02851         ret = -1;
<a name="l02852"></a>02852         <span class="keywordflow">goto</span> error;
<a name="l02853"></a>02853     }
<a name="l02854"></a>02854 
<a name="l02855"></a>02855     <a class="code" href="block-mgr_8c.html#aa78b63ce0fb941132f6db665de4966bc">seaf_block_manager_close_block</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>, block);
<a name="l02856"></a>02856 
<a name="l02857"></a>02857     <span class="keywordflow">if</span> (<a class="code" href="block-mgr_8c.html#a30d3350f36f7448fcf414ccc2cd59824">seaf_block_manager_commit_block</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>, block) &lt; 0) {
<a name="l02858"></a>02858         seaf_warning (<span class="stringliteral">&quot;Failed to commit block %s in repo %.8s.\n&quot;</span>,
<a name="l02859"></a>02859                       block_id, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02860"></a>02860         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159a3e94b4f3a5cae152befefab9cb2a2a6c">HTTP_TASK_ERR_WRITE_LOCAL_DATA</a>;
<a name="l02861"></a>02861         ret = -1;
<a name="l02862"></a>02862     }
<a name="l02863"></a>02863 
<a name="l02864"></a>02864     <a class="code" href="block-mgr_8c.html#a61d32d9d0d064dea33a1e2e7008215c1">seaf_block_manager_block_handle_free</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>, block);
<a name="l02865"></a>02865 
<a name="l02866"></a>02866     g_free (url);
<a name="l02867"></a>02867 
<a name="l02868"></a>02868     <span class="keywordflow">return</span> ret;
<a name="l02869"></a>02869 
<a name="l02870"></a>02870 error:
<a name="l02871"></a>02871     g_free (url);
<a name="l02872"></a>02872 
<a name="l02873"></a>02873     <a class="code" href="block-mgr_8c.html#aa78b63ce0fb941132f6db665de4966bc">seaf_block_manager_close_block</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>, block);
<a name="l02874"></a>02874     <a class="code" href="block-mgr_8c.html#a61d32d9d0d064dea33a1e2e7008215c1">seaf_block_manager_block_handle_free</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>, block);
<a name="l02875"></a>02875 
<a name="l02876"></a>02876     <span class="keywordflow">return</span> ret;
<a name="l02877"></a>02877 }
<a name="l02878"></a>02878 
<a name="l02879"></a>02879 <span class="keywordtype">int</span>
<a name="l02880"></a><a class="code" href="http-tx-mgr_8h.html#a3cdcb1e4f4996dabc1adb7ae742ddfb4">02880</a> <a class="code" href="http-tx-mgr_8c.html#a3cdcb1e4f4996dabc1adb7ae742ddfb4">http_tx_task_download_file_blocks</a> (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task, <span class="keyword">const</span> <span class="keywordtype">char</span> *file_id)
<a name="l02881"></a>02881 {
<a name="l02882"></a>02882     <a class="code" href="struct__Seafile.html">Seafile</a> *file;
<a name="l02883"></a>02883     <a class="code" href="struct__HttpTxPriv.html">HttpTxPriv</a> *priv = <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>-&gt;<a class="code" href="struct__HttpTxManager.html#a3e124361f6d9812dd9e4fb15e7ea41e7">priv</a>;
<a name="l02884"></a>02884     <a class="code" href="struct__ConnectionPool.html">ConnectionPool</a> *pool;
<a name="l02885"></a>02885     <a class="code" href="struct__Connection.html">Connection</a> *conn;
<a name="l02886"></a>02886     <span class="keywordtype">int</span> ret = 0;
<a name="l02887"></a>02887 
<a name="l02888"></a>02888     file = <a class="code" href="fs-mgr_8c.html#a029c16e2ecdf6eafd96edb2ee4e6beac">seaf_fs_manager_get_seafile</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
<a name="l02889"></a>02889                                         task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>,
<a name="l02890"></a>02890                                         task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l02891"></a>02891                                         file_id);
<a name="l02892"></a>02892     <span class="keywordflow">if</span> (!file) {
<a name="l02893"></a>02893         seaf_warning (<span class="stringliteral">&quot;Failed to find seafile object %s in repo %.8s.\n&quot;</span>,
<a name="l02894"></a>02894                       file_id, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02895"></a>02895         <span class="keywordflow">return</span> -1;
<a name="l02896"></a>02896     }
<a name="l02897"></a>02897 
<a name="l02898"></a>02898     pool = find_connection_pool (priv, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>);
<a name="l02899"></a>02899     <span class="keywordflow">if</span> (!pool) {
<a name="l02900"></a>02900         seaf_warning (<span class="stringliteral">&quot;Failed to create connection pool for host %s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>);
<a name="l02901"></a>02901         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159a1b9f5fdd07452b49a753f1064b000db4">HTTP_TASK_ERR_NOT_ENOUGH_MEMORY</a>;
<a name="l02902"></a>02902         <a class="code" href="fs-mgr_8c.html#a0a491c647769cf7bd09d5092ab84b85a">seafile_unref</a> (file);
<a name="l02903"></a>02903         <span class="keywordflow">return</span> -1;
<a name="l02904"></a>02904     }
<a name="l02905"></a>02905 
<a name="l02906"></a>02906     conn = connection_pool_get_connection (pool);
<a name="l02907"></a>02907     <span class="keywordflow">if</span> (!conn) {
<a name="l02908"></a>02908         seaf_warning (<span class="stringliteral">&quot;Failed to get connection to host %s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>);
<a name="l02909"></a>02909         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159a1b9f5fdd07452b49a753f1064b000db4">HTTP_TASK_ERR_NOT_ENOUGH_MEMORY</a>;
<a name="l02910"></a>02910         <a class="code" href="fs-mgr_8c.html#a0a491c647769cf7bd09d5092ab84b85a">seafile_unref</a> (file);
<a name="l02911"></a>02911         <span class="keywordflow">return</span> -1;
<a name="l02912"></a>02912     }
<a name="l02913"></a>02913 
<a name="l02914"></a>02914     <span class="keywordtype">int</span> i;
<a name="l02915"></a>02915     <span class="keywordtype">char</span> *<a class="code" href="block-tx-utils_8h.html#a2d616e1f81d11995c8b388444be651ef">block_id</a>;
<a name="l02916"></a>02916     <span class="keywordflow">for</span> (i = 0; i &lt; file-&gt;<a class="code" href="struct__Seafile.html#af2d5c5e5bb56d38122dead42128b9c20">n_blocks</a>; ++i) {
<a name="l02917"></a>02917         block_id = file-&gt;<a class="code" href="struct__Seafile.html#aacaedff2674132faf3d522ba8df6e268">blk_sha1s</a>[i];
<a name="l02918"></a>02918         <span class="keywordflow">if</span> (!<a class="code" href="block-mgr_8c.html#acc8d899bbbf17d0db6d07c9eda67fd0c">seaf_block_manager_block_exists</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>,
<a name="l02919"></a>02919                                               task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>,
<a name="l02920"></a>02920                                               task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l02921"></a>02921                                               block_id)) {
<a name="l02922"></a>02922             ret = <a class="code" href="http-tx-mgr_8c.html#a9405628380ded681f1831e92755869e3">get_block</a> (task, conn, block_id);
<a name="l02923"></a>02923             <span class="keywordflow">if</span> (ret &lt; 0 || task-&gt;state == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>)
<a name="l02924"></a>02924                 <span class="keywordflow">break</span>;
<a name="l02925"></a>02925         }
<a name="l02926"></a>02926     }
<a name="l02927"></a>02927 
<a name="l02928"></a>02928     connection_pool_return_connection (pool, conn);
<a name="l02929"></a>02929 
<a name="l02930"></a>02930     <a class="code" href="fs-mgr_8c.html#a0a491c647769cf7bd09d5092ab84b85a">seafile_unref</a> (file);
<a name="l02931"></a>02931 
<a name="l02932"></a>02932     <span class="keywordflow">return</span> ret;
<a name="l02933"></a>02933 }
<a name="l02934"></a>02934 
<a name="l02935"></a>02935 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02936"></a>02936 update_local_repo (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task)
<a name="l02937"></a>02937 {
<a name="l02938"></a>02938     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l02939"></a>02939     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *new_head;
<a name="l02940"></a>02940     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch;
<a name="l02941"></a>02941     <span class="keywordtype">int</span> ret = 0;
<a name="l02942"></a>02942 
<a name="l02943"></a>02943     new_head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l02944"></a>02944                                                task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>,
<a name="l02945"></a>02945                                                task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>,
<a name="l02946"></a>02946                                                task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>);
<a name="l02947"></a>02947     <span class="keywordflow">if</span> (!new_head) {
<a name="l02948"></a>02948         seaf_warning (<span class="stringliteral">&quot;Failed to get commit %s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>);
<a name="l02949"></a>02949         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159ab2bac951aa574b49e1d988c044eea731">HTTP_TASK_ERR_BAD_LOCAL_DATA</a>;
<a name="l02950"></a>02950         <span class="keywordflow">return</span> -1;
<a name="l02951"></a>02951     }
<a name="l02952"></a>02952 
<a name="l02953"></a>02953     <span class="comment">/* If repo doesn&#39;t exist, create it.</span>
<a name="l02954"></a>02954 <span class="comment">     * Note that branch doesn&#39;t exist either in this case.</span>
<a name="l02955"></a>02955 <span class="comment">     */</span>
<a name="l02956"></a>02956     repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, new_head-&gt;<a class="code" href="struct__SeafCommit.html#af9c51057516029191941d47985df7f5f">repo_id</a>);
<a name="l02957"></a>02957     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#a8dc7ba305c249ab73ce9424725776d41">is_clone</a>) {
<a name="l02958"></a>02958         <span class="keywordflow">if</span> (repo != NULL)
<a name="l02959"></a>02959             <span class="keywordflow">goto</span> out;
<a name="l02960"></a>02960 
<a name="l02961"></a>02961         repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a63ab9fe4694e3d967376c911cbe2c655">seaf_repo_new</a> (new_head-&gt;<a class="code" href="struct__SeafCommit.html#af9c51057516029191941d47985df7f5f">repo_id</a>, NULL, NULL);
<a name="l02962"></a>02962         <span class="keywordflow">if</span> (repo == NULL) {
<a name="l02963"></a>02963             <span class="comment">/* create repo failed */</span>
<a name="l02964"></a>02964             task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159a1b9f5fdd07452b49a753f1064b000db4">HTTP_TASK_ERR_NOT_ENOUGH_MEMORY</a>;
<a name="l02965"></a>02965             ret = -1;
<a name="l02966"></a>02966             <span class="keywordflow">goto</span> out;
<a name="l02967"></a>02967         }
<a name="l02968"></a>02968 
<a name="l02969"></a>02969         <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a9c8ead9892374c87ece888d76e810197">seaf_repo_from_commit</a> (repo, new_head);
<a name="l02970"></a>02970 
<a name="l02971"></a>02971         <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a140616a89d5a02935665f86cf3bb744c">seaf_repo_manager_add_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo);
<a name="l02972"></a>02972 
<a name="l02973"></a>02973         <span class="comment">/* If it&#39;s a new repo, create &#39;local&#39; and &#39;master&#39; branch */</span>
<a name="l02974"></a>02974         branch = <a class="code" href="branch-mgr_8c.html#a4d213520d8a22d5191051715ccbfd1dd">seaf_branch_new</a> (<span class="stringliteral">&quot;local&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>);
<a name="l02975"></a>02975         <a class="code" href="branch-mgr_8c.html#ab67819118ec82d96e51f6c2cadd7a632">seaf_branch_manager_add_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, branch);
<a name="l02976"></a>02976         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l02977"></a>02977 
<a name="l02978"></a>02978         branch = <a class="code" href="branch-mgr_8c.html#a4d213520d8a22d5191051715ccbfd1dd">seaf_branch_new</a> (<span class="stringliteral">&quot;master&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>);
<a name="l02979"></a>02979         <a class="code" href="branch-mgr_8c.html#ab67819118ec82d96e51f6c2cadd7a632">seaf_branch_manager_add_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, branch);
<a name="l02980"></a>02980         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l02981"></a>02981     } <span class="keywordflow">else</span> {
<a name="l02982"></a>02982         <span class="keywordflow">if</span> (!repo) {
<a name="l02983"></a>02983             task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159ab2bac951aa574b49e1d988c044eea731">HTTP_TASK_ERR_BAD_LOCAL_DATA</a>;
<a name="l02984"></a>02984             ret = -1;
<a name="l02985"></a>02985             <span class="keywordflow">goto</span> out;
<a name="l02986"></a>02986         }
<a name="l02987"></a>02987 
<a name="l02988"></a>02988         branch = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, 
<a name="l02989"></a>02989                                                  task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>,
<a name="l02990"></a>02990                                                  <span class="stringliteral">&quot;master&quot;</span>);
<a name="l02991"></a>02991         <span class="keywordflow">if</span> (!branch) {
<a name="l02992"></a>02992             seaf_warning (<span class="stringliteral">&quot;Branch master not found for repo %.8s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02993"></a>02993             task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159ab2bac951aa574b49e1d988c044eea731">HTTP_TASK_ERR_BAD_LOCAL_DATA</a>;
<a name="l02994"></a>02994             ret = -1;
<a name="l02995"></a>02995             <span class="keywordflow">goto</span> out;
<a name="l02996"></a>02996         }
<a name="l02997"></a>02997         <a class="code" href="branch-mgr_8c.html#a7a776ebd084d2335050c68d9a2e10c18">seaf_branch_set_commit</a> (branch, new_head-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>);
<a name="l02998"></a>02998         <a class="code" href="branch-mgr_8c.html#aab1588f5228eaf4405efb239a9ed5680">seaf_branch_manager_update_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, branch);
<a name="l02999"></a>02999         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l03000"></a>03000 
<a name="l03001"></a>03001         <span class="comment">/* Update repo head branch. */</span>
<a name="l03002"></a>03002         <a class="code" href="branch-mgr_8c.html#a7a776ebd084d2335050c68d9a2e10c18">seaf_branch_set_commit</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>, new_head-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>);
<a name="l03003"></a>03003         <a class="code" href="branch-mgr_8c.html#aab1588f5228eaf4405efb239a9ed5680">seaf_branch_manager_update_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>);
<a name="l03004"></a>03004     }
<a name="l03005"></a>03005 
<a name="l03006"></a>03006 out:
<a name="l03007"></a>03007     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (new_head);
<a name="l03008"></a>03008     <span class="keywordflow">return</span> ret;
<a name="l03009"></a>03009 }
<a name="l03010"></a>03010 
<a name="l03011"></a>03011 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l03012"></a>03012 http_download_thread (<span class="keywordtype">void</span> *vdata)
<a name="l03013"></a>03013 {
<a name="l03014"></a>03014     <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task = vdata;
<a name="l03015"></a>03015     <a class="code" href="struct__HttpTxPriv.html">HttpTxPriv</a> *priv = <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>-&gt;<a class="code" href="struct__HttpTxManager.html#a3e124361f6d9812dd9e4fb15e7ea41e7">priv</a>;
<a name="l03016"></a>03016     <a class="code" href="struct__ConnectionPool.html">ConnectionPool</a> *pool;
<a name="l03017"></a>03017     <a class="code" href="struct__Connection.html">Connection</a> *conn = NULL;
<a name="l03018"></a>03018     GList *fs_id_list = NULL;
<a name="l03019"></a>03019 
<a name="l03020"></a>03020     pool = find_connection_pool (priv, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>);
<a name="l03021"></a>03021     <span class="keywordflow">if</span> (!pool) {
<a name="l03022"></a>03022         seaf_warning (<span class="stringliteral">&quot;Failed to create connection pool for host %s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>);
<a name="l03023"></a>03023         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159a1b9f5fdd07452b49a753f1064b000db4">HTTP_TASK_ERR_NOT_ENOUGH_MEMORY</a>;
<a name="l03024"></a>03024         <span class="keywordflow">goto</span> out;
<a name="l03025"></a>03025     }
<a name="l03026"></a>03026 
<a name="l03027"></a>03027     conn = connection_pool_get_connection (pool);
<a name="l03028"></a>03028     <span class="keywordflow">if</span> (!conn) {
<a name="l03029"></a>03029         seaf_warning (<span class="stringliteral">&quot;Failed to get connection to host %s.\n&quot;</span>, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>);
<a name="l03030"></a>03030         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159a1b9f5fdd07452b49a753f1064b000db4">HTTP_TASK_ERR_NOT_ENOUGH_MEMORY</a>;
<a name="l03031"></a>03031         <span class="keywordflow">goto</span> out;
<a name="l03032"></a>03032     }
<a name="l03033"></a>03033 
<a name="l03034"></a>03034     seaf_message (<span class="stringliteral">&quot;Download with HTTP sync protocol version %d.\n&quot;</span>,
<a name="l03035"></a>03035                   task-&gt;<a class="code" href="struct__HttpTxTask.html#a6445d889b66d46f624a8ce480792f5f0">protocol_version</a>);
<a name="l03036"></a>03036 
<a name="l03037"></a>03037     transition_state (task, task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a>, <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617a51cd98784e48af2aff2e252cda6c23c1">HTTP_TASK_RT_STATE_CHECK</a>);
<a name="l03038"></a>03038 
<a name="l03039"></a>03039     <span class="keywordflow">if</span> (check_permission (task, conn) &lt; 0) {
<a name="l03040"></a>03040         seaf_warning (<span class="stringliteral">&quot;Download permission denied for repo %.8s on server %s.\n&quot;</span>,
<a name="l03041"></a>03041                       task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>);
<a name="l03042"></a>03042         <span class="keywordflow">goto</span> out;
<a name="l03043"></a>03043     }
<a name="l03044"></a>03044 
<a name="l03045"></a>03045     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>)
<a name="l03046"></a>03046         <span class="keywordflow">goto</span> out;
<a name="l03047"></a>03047 
<a name="l03048"></a>03048     transition_state (task, task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a>, <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617ad5d2aea26c1c9286119dcc352dcf681d">HTTP_TASK_RT_STATE_COMMIT</a>);
<a name="l03049"></a>03049 
<a name="l03050"></a>03050     <span class="keywordflow">if</span> (get_commit_object (task, conn) &lt; 0) {
<a name="l03051"></a>03051         seaf_warning (<span class="stringliteral">&quot;Failed to get server head commit for repo %.8s on server %s.\n&quot;</span>,
<a name="l03052"></a>03052                       task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>);
<a name="l03053"></a>03053         <span class="keywordflow">goto</span> out;
<a name="l03054"></a>03054     }
<a name="l03055"></a>03055 
<a name="l03056"></a>03056     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>)
<a name="l03057"></a>03057         <span class="keywordflow">goto</span> out;
<a name="l03058"></a>03058 
<a name="l03059"></a>03059     transition_state (task, task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a>, <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617a0696dfdf8d8ac3872dcd8155a14353d3">HTTP_TASK_RT_STATE_FS</a>);
<a name="l03060"></a>03060 
<a name="l03061"></a>03061     <span class="keywordflow">if</span> (get_needed_fs_id_list (task, conn, &amp;fs_id_list) &lt; 0) {
<a name="l03062"></a>03062         seaf_warning (<span class="stringliteral">&quot;Failed to get fs id list for repo %.8s on server %s.\n&quot;</span>,
<a name="l03063"></a>03063                       task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>);
<a name="l03064"></a>03064         <span class="keywordflow">goto</span> out;
<a name="l03065"></a>03065     }
<a name="l03066"></a>03066 
<a name="l03067"></a>03067     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>)
<a name="l03068"></a>03068         <span class="keywordflow">goto</span> out;
<a name="l03069"></a>03069 
<a name="l03070"></a>03070     <span class="keywordflow">while</span> (fs_id_list != NULL) {
<a name="l03071"></a>03071         <span class="keywordflow">if</span> (get_fs_objects (task, conn, &amp;fs_id_list) &lt; 0) {
<a name="l03072"></a>03072             seaf_warning (<span class="stringliteral">&quot;Failed to get fs objects for repo %.8s on server %s.\n&quot;</span>,
<a name="l03073"></a>03073                           task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#a846b22f672c2c90c4319732bbf3fc5a4">host</a>);
<a name="l03074"></a>03074             <span class="keywordflow">goto</span> out;
<a name="l03075"></a>03075         }
<a name="l03076"></a>03076 
<a name="l03077"></a>03077         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>)
<a name="l03078"></a>03078             <span class="keywordflow">goto</span> out;
<a name="l03079"></a>03079     }
<a name="l03080"></a>03080 
<a name="l03081"></a>03081     transition_state (task, task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a>, <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617a96aaa723a45db207d64fd7baf1ca23c5">HTTP_TASK_RT_STATE_BLOCK</a>);
<a name="l03082"></a>03082 
<a name="l03083"></a>03083     <span class="comment">/* Record download head commit id, so that we can resume download</span>
<a name="l03084"></a>03084 <span class="comment">     * if this download is interrupted.</span>
<a name="l03085"></a>03085 <span class="comment">     */</span>
<a name="l03086"></a>03086     <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l03087"></a>03087                                          task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>,
<a name="l03088"></a>03088                                          <a class="code" href="daemon_2repo-mgr_8h.html#a1d90660156a493f14023ca76013acd64">REPO_PROP_DOWNLOAD_HEAD</a>,
<a name="l03089"></a>03089                                          task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>);
<a name="l03090"></a>03090 
<a name="l03091"></a>03091     <span class="keywordtype">int</span> rc = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a3ae125d7fd328d8d141dc38710ffd24e">seaf_repo_fetch_and_checkout</a> (NULL, task, TRUE, task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>);
<a name="l03092"></a>03092     <span class="keywordflow">switch</span> (rc) {
<a name="l03093"></a>03093     <span class="keywordflow">case</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>:
<a name="l03094"></a>03094         <span class="keywordflow">break</span>;
<a name="l03095"></a>03095     <span class="keywordflow">case</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ae2a1e8d995b67343e5162cdb29513380">FETCH_CHECKOUT_CANCELED</a>:
<a name="l03096"></a>03096         <span class="keywordflow">goto</span> out;
<a name="l03097"></a>03097     <span class="keywordflow">case</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>:
<a name="l03098"></a>03098         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159a3e94b4f3a5cae152befefab9cb2a2a6c">HTTP_TASK_ERR_WRITE_LOCAL_DATA</a>;
<a name="l03099"></a>03099         <span class="keywordflow">goto</span> out;
<a name="l03100"></a>03100     <span class="keywordflow">case</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a4a1718c70eba70651160111e48589161">FETCH_CHECKOUT_TRANSFER_ERROR</a>:
<a name="l03101"></a>03101         <span class="keywordflow">goto</span> out;
<a name="l03102"></a>03102     <span class="keywordflow">case</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a662e1ae03ecdd8c6d02c7195e332d3ce">FETCH_CHECKOUT_LOCKED</a>:
<a name="l03103"></a>03103         task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> = <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159aae23d23cfaef7dcaed67aae072df1f74">HTTP_TASK_ERR_FILES_LOCKED</a>;
<a name="l03104"></a>03104         <span class="keywordflow">goto</span> out;
<a name="l03105"></a>03105     }
<a name="l03106"></a>03106 
<a name="l03107"></a>03107     update_local_repo (task);
<a name="l03108"></a>03108 
<a name="l03109"></a>03109 out:
<a name="l03110"></a>03110     connection_pool_return_connection (pool, conn);
<a name="l03111"></a>03111     <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (fs_id_list);
<a name="l03112"></a>03112     <span class="keywordflow">return</span> vdata;
<a name="l03113"></a>03113 }
<a name="l03114"></a>03114 
<a name="l03115"></a>03115 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l03116"></a>03116 http_download_done (<span class="keywordtype">void</span> *vdata)
<a name="l03117"></a>03117 {
<a name="l03118"></a>03118     <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task = vdata;
<a name="l03119"></a>03119 
<a name="l03120"></a>03120     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> != <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159a7d2b0dc48a6f7c202ac60e59eb473c9c">HTTP_TASK_OK</a>)
<a name="l03121"></a>03121         transition_state (task, <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5a7829485480889c6958e5ddd2996b05ff">HTTP_TASK_STATE_ERROR</a>, <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617a48fa58e541bc5e2f237e8cd81b1a33b3">HTTP_TASK_RT_STATE_FINISHED</a>);
<a name="l03122"></a>03122     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>)
<a name="l03123"></a>03123         transition_state (task, task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a>, <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617a48fa58e541bc5e2f237e8cd81b1a33b3">HTTP_TASK_RT_STATE_FINISHED</a>);
<a name="l03124"></a>03124     <span class="keywordflow">else</span>
<a name="l03125"></a>03125         transition_state (task, <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5a0facf2c60cc1a598735bd4d8d488417b">HTTP_TASK_STATE_FINISHED</a>, <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617a48fa58e541bc5e2f237e8cd81b1a33b3">HTTP_TASK_RT_STATE_FINISHED</a>);
<a name="l03126"></a>03126 }
<a name="l03127"></a>03127 
<a name="l03128"></a>03128 GList*
<a name="l03129"></a><a class="code" href="http-tx-mgr_8h.html#a3cf653baf4245f9f361a2be605464035">03129</a> <a class="code" href="http-tx-mgr_8c.html#a3cf653baf4245f9f361a2be605464035">http_tx_manager_get_upload_tasks</a> (<a class="code" href="struct__HttpTxManager.html">HttpTxManager</a> *manager)
<a name="l03130"></a>03130 {
<a name="l03131"></a>03131     <span class="keywordflow">return</span> g_hash_table_get_values (manager-&gt;<a class="code" href="struct__HttpTxManager.html#a3e124361f6d9812dd9e4fb15e7ea41e7">priv</a>-&gt;<a class="code" href="struct__HttpTxPriv.html#a791e15c45420b177bfc87284015ac9db">upload_tasks</a>);
<a name="l03132"></a>03132 }
<a name="l03133"></a>03133 
<a name="l03134"></a>03134 GList*
<a name="l03135"></a><a class="code" href="http-tx-mgr_8h.html#a4b8e6e4dd009a90d6fd8a42b6683995c">03135</a> <a class="code" href="http-tx-mgr_8c.html#a4b8e6e4dd009a90d6fd8a42b6683995c">http_tx_manager_get_download_tasks</a> (<a class="code" href="struct__HttpTxManager.html">HttpTxManager</a> *manager)
<a name="l03136"></a>03136 {
<a name="l03137"></a>03137     <span class="keywordflow">return</span> g_hash_table_get_values (manager-&gt;<a class="code" href="struct__HttpTxManager.html#a3e124361f6d9812dd9e4fb15e7ea41e7">priv</a>-&gt;<a class="code" href="struct__HttpTxPriv.html#a054e2539c8af97620bcc0ab412398edf">download_tasks</a>);
<a name="l03138"></a>03138 }
<a name="l03139"></a>03139 
<a name="l03140"></a>03140 <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *
<a name="l03141"></a><a class="code" href="http-tx-mgr_8h.html#a7ff95e76d064c44f4d9e3bdbf0b6b0b6">03141</a> <a class="code" href="http-tx-mgr_8c.html#a7ff95e76d064c44f4d9e3bdbf0b6b0b6">http_tx_manager_find_task</a> (<a class="code" href="struct__HttpTxManager.html">HttpTxManager</a> *manager, <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l03142"></a>03142 {
<a name="l03143"></a>03143     <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task = NULL;
<a name="l03144"></a>03144 
<a name="l03145"></a>03145     task = g_hash_table_lookup (manager-&gt;<a class="code" href="struct__HttpTxManager.html#a3e124361f6d9812dd9e4fb15e7ea41e7">priv</a>-&gt;<a class="code" href="struct__HttpTxPriv.html#a791e15c45420b177bfc87284015ac9db">upload_tasks</a>, repo_id);
<a name="l03146"></a>03146     <span class="keywordflow">if</span> (task)
<a name="l03147"></a>03147         <span class="keywordflow">return</span> task;
<a name="l03148"></a>03148 
<a name="l03149"></a>03149     task = g_hash_table_lookup (manager-&gt;<a class="code" href="struct__HttpTxManager.html#a3e124361f6d9812dd9e4fb15e7ea41e7">priv</a>-&gt;<a class="code" href="struct__HttpTxPriv.html#a054e2539c8af97620bcc0ab412398edf">download_tasks</a>, repo_id);
<a name="l03150"></a>03150     <span class="keywordflow">return</span> task;
<a name="l03151"></a>03151 }
<a name="l03152"></a>03152 
<a name="l03153"></a>03153 <span class="keywordtype">void</span>
<a name="l03154"></a><a class="code" href="http-tx-mgr_8h.html#a1333f1b023ba910df52c75f6ec51c41d">03154</a> <a class="code" href="http-tx-mgr_8c.html#a1333f1b023ba910df52c75f6ec51c41d">http_tx_manager_cancel_task</a> (<a class="code" href="struct__HttpTxManager.html">HttpTxManager</a> *manager,
<a name="l03155"></a>03155                              <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l03156"></a>03156                              <span class="keywordtype">int</span> task_type)
<a name="l03157"></a>03157 {
<a name="l03158"></a>03158     <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task = NULL;
<a name="l03159"></a>03159 
<a name="l03160"></a>03160     <span class="keywordflow">if</span> (task_type == <a class="code" href="http-tx-mgr_8h.html#a16af7b253440dadd46a80a4b9fddba4da429731c6953f215203cf1b17fe92ebb1">HTTP_TASK_TYPE_DOWNLOAD</a>)
<a name="l03161"></a>03161         task = g_hash_table_lookup (manager-&gt;<a class="code" href="struct__HttpTxManager.html#a3e124361f6d9812dd9e4fb15e7ea41e7">priv</a>-&gt;<a class="code" href="struct__HttpTxPriv.html#a054e2539c8af97620bcc0ab412398edf">download_tasks</a>, repo_id);
<a name="l03162"></a>03162     <span class="keywordflow">else</span>
<a name="l03163"></a>03163         task = g_hash_table_lookup (manager-&gt;<a class="code" href="struct__HttpTxManager.html#a3e124361f6d9812dd9e4fb15e7ea41e7">priv</a>-&gt;<a class="code" href="struct__HttpTxPriv.html#a791e15c45420b177bfc87284015ac9db">upload_tasks</a>, repo_id);
<a name="l03164"></a>03164 
<a name="l03165"></a>03165     <span class="keywordflow">if</span> (!task)
<a name="l03166"></a>03166         <span class="keywordflow">return</span>;
<a name="l03167"></a>03167 
<a name="l03168"></a>03168     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> != <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ad33e055301cbadbb9544f199ee76c00e">HTTP_TASK_STATE_NORMAL</a>) {
<a name="l03169"></a>03169         seaf_warning (<span class="stringliteral">&quot;Cannot cancel task not in NORMAL state.\n&quot;</span>);
<a name="l03170"></a>03170         <span class="keywordflow">return</span>;
<a name="l03171"></a>03171     }
<a name="l03172"></a>03172 
<a name="l03173"></a>03173     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#a42338e3407f898a2dc149f087cd0cea6">runtime_state</a> == <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617a529f48738b7509bb452c8f25915938cf">HTTP_TASK_RT_STATE_INIT</a>) {
<a name="l03174"></a>03174         transition_state (task, <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaae36dd6c8f3e2e25e7946660ec15cf7d">TASK_STATE_CANCELED</a>, <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a>);
<a name="l03175"></a>03175         <span class="keywordflow">return</span>;
<a name="l03176"></a>03176     }
<a name="l03177"></a>03177 
<a name="l03178"></a>03178     <span class="comment">/* Only change state. runtime_state will be changed in worker thread. */</span>
<a name="l03179"></a>03179     transition_state (task, <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaae36dd6c8f3e2e25e7946660ec15cf7d">TASK_STATE_CANCELED</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#a42338e3407f898a2dc149f087cd0cea6">runtime_state</a>);
<a name="l03180"></a>03180 }
<a name="l03181"></a>03181 
<a name="l03182"></a>03182 <span class="keywordtype">int</span>
<a name="l03183"></a><a class="code" href="http-tx-mgr_8h.html#ae22399dc7fe166fe634ba3738b657036">03183</a> <a class="code" href="http-tx-mgr_8c.html#ae22399dc7fe166fe634ba3738b657036">http_tx_task_get_rate</a> (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task)
<a name="l03184"></a>03184 {
<a name="l03185"></a>03185     <span class="keywordflow">return</span> task-&gt;<a class="code" href="struct__HttpTxTask.html#a651e7b5f81850c38468bbb102a18d878">last_tx_bytes</a>;
<a name="l03186"></a>03186 }
<a name="l03187"></a>03187 
<a name="l03188"></a>03188 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l03189"></a><a class="code" href="http-tx-mgr_8h.html#a67072054c5ac5f932ea490a3f2a87eb9">03189</a> <a class="code" href="http-tx-mgr_8c.html#a67072054c5ac5f932ea490a3f2a87eb9">http_task_state_to_str</a> (<span class="keywordtype">int</span> state)
<a name="l03190"></a>03190 {
<a name="l03191"></a>03191     <span class="keywordflow">if</span> (state &lt; 0 || state &gt;= <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ad8ba7b8530e5648c1220f8d2fe9c1ea9">N_HTTP_TASK_STATE</a>)
<a name="l03192"></a>03192         <span class="keywordflow">return</span> <span class="stringliteral">&quot;unknown&quot;</span>;
<a name="l03193"></a>03193 
<a name="l03194"></a>03194     <span class="keywordflow">return</span> http_task_state_str[state];
<a name="l03195"></a>03195 }
<a name="l03196"></a>03196 
<a name="l03197"></a>03197 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l03198"></a><a class="code" href="http-tx-mgr_8h.html#a96af3a00157e12d0ea5a88042a4f225c">03198</a> <a class="code" href="http-tx-mgr_8c.html#a96af3a00157e12d0ea5a88042a4f225c">http_task_rt_state_to_str</a> (<span class="keywordtype">int</span> rt_state)
<a name="l03199"></a>03199 {
<a name="l03200"></a>03200     <span class="keywordflow">if</span> (rt_state &lt; 0 || rt_state &gt;= <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617ae67f1dd2b61ce65971a1b3280d7977b5">N_HTTP_TASK_RT_STATE</a>)
<a name="l03201"></a>03201         <span class="keywordflow">return</span> <span class="stringliteral">&quot;unknown&quot;</span>;
<a name="l03202"></a>03202 
<a name="l03203"></a>03203     <span class="keywordflow">return</span> http_task_rt_state_str[rt_state];
<a name="l03204"></a>03204 }
<a name="l03205"></a>03205 
<a name="l03206"></a>03206 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l03207"></a><a class="code" href="http-tx-mgr_8h.html#a3b6822841a7614f31c8ef70ffa61d278">03207</a> <a class="code" href="http-tx-mgr_8c.html#a3b6822841a7614f31c8ef70ffa61d278">http_task_error_str</a> (<span class="keywordtype">int</span> task_errno)
<a name="l03208"></a>03208 {
<a name="l03209"></a>03209     <span class="keywordflow">if</span> (task_errno &lt; 0 || task_errno &gt;= <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159ad0fa9a44f6573e27948b91ef500a5c1b">N_HTTP_TASK_ERROR</a>)
<a name="l03210"></a>03210         <span class="keywordflow">return</span> <span class="stringliteral">&quot;unknown error&quot;</span>;
<a name="l03211"></a>03211 
<a name="l03212"></a>03212     <span class="keywordflow">return</span> http_task_error_strs[task_errno];
<a name="l03213"></a>03213 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Wed Aug 19 2015 03:59:41 for My Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
