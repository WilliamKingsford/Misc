<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>My Project: seafile-4.1.2/daemon/repo-mgr.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">My Project
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">seafile-4.1.2/daemon/repo-mgr.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="daemon_2repo-mgr_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="preprocessor">#include &quot;common.h&quot;</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;glib/gstdio.h&gt;</span>
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="preprocessor">#ifdef WIN32</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor">#include &lt;windows.h&gt;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#endif</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;<a class="code" href="ccnet_8h.html">ccnet.h</a>&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &quot;utils.h&quot;</span>
<a name="l00012"></a><a class="code" href="daemon_2repo-mgr_8c.html#a05d1af42442c934b555896d3fe55c79e">00012</a> <span class="preprocessor">#define DEBUG_FLAG SEAFILE_DEBUG_SYNC</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor">#include &quot;log.h&quot;</span>
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;<a class="code" href="status_8h.html">status.h</a>&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;<a class="code" href="vc-utils_8h.html">vc-utils.h</a>&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="merge_8h.html">merge.h</a>&quot;</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="daemon_2seafile-session_8h.html">seafile-session.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="seafile-config_8h.html">seafile-config.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="commit-mgr_8h.html">commit-mgr.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="branch-mgr_8h.html">branch-mgr.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="daemon_2repo-mgr_8h.html">repo-mgr.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="fs-mgr_8h.html">fs-mgr.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="seafile-error_8h.html">seafile-error.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="seafile-crypt_8h.html">seafile-crypt.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="index_8h.html">index/index.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="cache-tree_8h.html">index/cache-tree.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="unpack-trees_8h.html">unpack-trees.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="diff-simple_8h.html">diff-simple.h</a>&quot;</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;db.h&quot;</span>
<a name="l00033"></a>00033 
<a name="l00034"></a><a class="code" href="daemon_2repo-mgr_8c.html#a823aa5bebe4b4b836619cae12751b8a5">00034</a> <span class="preprocessor">#define INDEX_DIR &quot;index&quot;</span>
<a name="l00035"></a><a class="code" href="daemon_2repo-mgr_8c.html#a237e501289ed87ac7fb2bb3859e81cb0">00035</a> <span class="preprocessor"></span><span class="preprocessor">#define IGNORE_FILE &quot;seafile-ignore.txt&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span>
<a name="l00037"></a>00037 <span class="preprocessor">#ifdef HAVE_KEYSTORAGE_GK</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="seafile-gnome-keyring_8h.html">repokey/seafile-gnome-keyring.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#endif // HAVE_KEYSTORAGE_GK</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span>
<a name="l00041"></a>00041 <span class="keyword">struct </span><a class="code" href="struct__SeafRepoManagerPriv.html">_SeafRepoManagerPriv</a> {
<a name="l00042"></a>00042     GHashTable *<a class="code" href="struct__SeafRepoManagerPriv.html#a46e78181430977b311346c02e5738286">repo_hash</a>;
<a name="l00043"></a>00043     sqlite3    *<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>;
<a name="l00044"></a>00044     pthread_mutex_t <a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>;
<a name="l00045"></a>00045     GHashTable *<a class="code" href="struct__SeafRepoManagerPriv.html#a7fde21f0d7bba66fac76f4783377f20c">checkout_tasks_hash</a>;
<a name="l00046"></a>00046     pthread_rwlock_t <a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>;
<a name="l00047"></a>00047 };
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *ignore_table[] = {
<a name="l00050"></a>00050     <span class="comment">/* tmp files under Linux */</span>
<a name="l00051"></a>00051     <span class="stringliteral">&quot;*~&quot;</span>,
<a name="l00052"></a>00052     <span class="comment">/* Emacs tmp files */</span>
<a name="l00053"></a>00053     <span class="stringliteral">&quot;#*#&quot;</span>,
<a name="l00054"></a>00054     <span class="comment">/* windows image cache */</span>
<a name="l00055"></a>00055     <span class="stringliteral">&quot;Thumbs.db&quot;</span>,
<a name="l00056"></a>00056     <span class="comment">/* For Mac */</span>
<a name="l00057"></a>00057     <span class="stringliteral">&quot;.DS_Store&quot;</span>,
<a name="l00058"></a>00058     NULL,
<a name="l00059"></a>00059 };
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="keyword">static</span> GPatternSpec** ignore_patterns;
<a name="l00062"></a>00062 <span class="keyword">static</span> GPatternSpec* office_temp_ignore_patterns[4];
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="keyword">static</span> <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *
<a name="l00066"></a>00066 load_repo (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id);
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="keyword">static</span> <span class="keywordtype">void</span> load_repos (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <span class="keyword">const</span> <span class="keywordtype">char</span> *seaf_dir);
<a name="l00069"></a>00069 <span class="keyword">static</span> <span class="keywordtype">void</span> seaf_repo_manager_del_repo_property (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l00070"></a>00070                                                  <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id);
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 <span class="keyword">static</span> <span class="keywordtype">int</span> save_branch_repo_map (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch);
<a name="l00073"></a>00073 <span class="keyword">static</span> <span class="keywordtype">void</span> save_repo_property (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l00074"></a>00074                                 <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l00075"></a>00075                                 <span class="keyword">const</span> <span class="keywordtype">char</span> *key, <span class="keyword">const</span> <span class="keywordtype">char</span> *value);
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00078"></a>00078 locked_file_free (<a class="code" href="struct__LockedFile.html">LockedFile</a> *file)
<a name="l00079"></a>00079 {
<a name="l00080"></a>00080     <span class="keywordflow">if</span> (!file)
<a name="l00081"></a>00081         <span class="keywordflow">return</span>;
<a name="l00082"></a>00082     g_free (file-&gt;<a class="code" href="struct__LockedFile.html#abdcab3c93928ff7a61146d497d5e4ec7">operation</a>);
<a name="l00083"></a>00083     g_free (file);
<a name="l00084"></a>00084 }
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 <span class="keyword">static</span> gboolean
<a name="l00087"></a>00087 load_locked_file (sqlite3_stmt *stmt, <span class="keywordtype">void</span> *data)
<a name="l00088"></a>00088 {
<a name="l00089"></a>00089     GHashTable *ret = data;
<a name="l00090"></a>00090     <a class="code" href="struct__LockedFile.html">LockedFile</a> *file;
<a name="l00091"></a>00091     <span class="keyword">const</span> <span class="keywordtype">char</span> *path, *operation, *file_id;
<a name="l00092"></a>00092     gint64 old_mtime;
<a name="l00093"></a>00093 
<a name="l00094"></a>00094     path = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)sqlite3_column_text (stmt, 0);
<a name="l00095"></a>00095     operation = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)sqlite3_column_text (stmt, 1);
<a name="l00096"></a>00096     old_mtime = sqlite3_column_int64 (stmt, 2);
<a name="l00097"></a>00097     file_id = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)sqlite3_column_text (stmt, 3);
<a name="l00098"></a>00098 
<a name="l00099"></a>00099     file = g_new0 (<a class="code" href="struct__LockedFile.html">LockedFile</a>, 1);
<a name="l00100"></a>00100     file-&gt;<a class="code" href="struct__LockedFile.html#abdcab3c93928ff7a61146d497d5e4ec7">operation</a> = g_strdup(operation);
<a name="l00101"></a>00101     file-&gt;<a class="code" href="struct__LockedFile.html#a1e6ec2e3b09c05236c6898df5dc77475">old_mtime</a> = old_mtime;
<a name="l00102"></a>00102     <span class="keywordflow">if</span> (file_id)
<a name="l00103"></a>00103         memcpy (file-&gt;<a class="code" href="struct__LockedFile.html#aebea73a3294e0a1493195022ffce6f23">file_id</a>, file_id, 40);
<a name="l00104"></a>00104 
<a name="l00105"></a>00105     g_hash_table_insert (ret, g_strdup(path), file);
<a name="l00106"></a>00106 
<a name="l00107"></a>00107     <span class="keywordflow">return</span> TRUE;
<a name="l00108"></a>00108 }
<a name="l00109"></a>00109 
<a name="l00110"></a>00110 <a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *
<a name="l00111"></a><a class="code" href="daemon_2repo-mgr_8c.html#a06294e91365be10d46a356d427f62e07">00111</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a06294e91365be10d46a356d427f62e07">seaf_repo_manager_get_locked_file_set</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr, <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l00112"></a>00112 {
<a name="l00113"></a>00113     GHashTable *locked_files = g_hash_table_new_full (g_str_hash, g_str_equal,
<a name="l00114"></a>00114                                                       g_free,
<a name="l00115"></a>00115                                                       (GDestroyNotify)locked_file_free);
<a name="l00116"></a>00116     <span class="keywordtype">char</span> sql[256];
<a name="l00117"></a>00117 
<a name="l00118"></a>00118     sqlite3_snprintf (<span class="keyword">sizeof</span>(sql), sql,
<a name="l00119"></a>00119                       <span class="stringliteral">&quot;SELECT path, operation, old_mtime, file_id FROM LockedFiles &quot;</span>
<a name="l00120"></a>00120                       <span class="stringliteral">&quot;WHERE repo_id = &#39;%q&#39;&quot;</span>,
<a name="l00121"></a>00121                       repo_id);
<a name="l00122"></a>00122 
<a name="l00123"></a>00123     pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00124"></a>00124 
<a name="l00125"></a>00125     <span class="comment">/* Ingore database error. We return an empty set on error. */</span>
<a name="l00126"></a>00126     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql,
<a name="l00127"></a>00127                                  load_locked_file, locked_files);
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00130"></a>00130 
<a name="l00131"></a>00131     <a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *ret = g_new0 (<a class="code" href="struct__LockedFileSet.html">LockedFileSet</a>, 1);
<a name="l00132"></a>00132     ret-&gt;<a class="code" href="struct__LockedFileSet.html#ae599e7470165a7f4eaaaefad7bb85c5f">mgr</a> = mgr;
<a name="l00133"></a>00133     memcpy (ret-&gt;<a class="code" href="struct__LockedFileSet.html#ae51031b45e0a18e92898ce33bef301fe">repo_id</a>, repo_id, 36);
<a name="l00134"></a>00134     ret-&gt;<a class="code" href="struct__LockedFileSet.html#a228bfd2b438cfa59fcf2dbd596ce335a">locked_files</a> = locked_files;
<a name="l00135"></a>00135 
<a name="l00136"></a>00136     <span class="keywordflow">return</span> ret;
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 <span class="keywordtype">void</span>
<a name="l00140"></a><a class="code" href="daemon_2repo-mgr_8c.html#ab44c57f5e23996e5eb807f7c84f443f5">00140</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ab44c57f5e23996e5eb807f7c84f443f5">locked_file_set_free</a> (<a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset)
<a name="l00141"></a>00141 {
<a name="l00142"></a>00142     <span class="keywordflow">if</span> (!fset)
<a name="l00143"></a>00143         <span class="keywordflow">return</span>;
<a name="l00144"></a>00144     g_hash_table_destroy (fset-&gt;<a class="code" href="struct__LockedFileSet.html#a228bfd2b438cfa59fcf2dbd596ce335a">locked_files</a>);
<a name="l00145"></a>00145     g_free (fset);
<a name="l00146"></a>00146 }
<a name="l00147"></a>00147 
<a name="l00148"></a>00148 <span class="keywordtype">int</span>
<a name="l00149"></a><a class="code" href="daemon_2repo-mgr_8c.html#a8782ae78d069d4073a35d981b04a2a88">00149</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a8782ae78d069d4073a35d981b04a2a88">locked_file_set_add_update</a> (<a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset,
<a name="l00150"></a>00150                             <span class="keyword">const</span> <span class="keywordtype">char</span> *path,
<a name="l00151"></a>00151                             <span class="keyword">const</span> <span class="keywordtype">char</span> *operation,
<a name="l00152"></a>00152                             gint64 old_mtime,
<a name="l00153"></a>00153                             <span class="keyword">const</span> <span class="keywordtype">char</span> *file_id)
<a name="l00154"></a>00154 {
<a name="l00155"></a>00155     <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = fset-&gt;<a class="code" href="struct__LockedFileSet.html#ae599e7470165a7f4eaaaefad7bb85c5f">mgr</a>;
<a name="l00156"></a>00156     <span class="keywordtype">char</span> *sql;
<a name="l00157"></a>00157     sqlite3_stmt *stmt;
<a name="l00158"></a>00158     <a class="code" href="struct__LockedFile.html">LockedFile</a> *file;
<a name="l00159"></a>00159     gboolean exists;
<a name="l00160"></a>00160 
<a name="l00161"></a>00161     exists = (g_hash_table_lookup (fset-&gt;<a class="code" href="struct__LockedFileSet.html#a228bfd2b438cfa59fcf2dbd596ce335a">locked_files</a>, path) != NULL);
<a name="l00162"></a>00162 
<a name="l00163"></a>00163     pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00164"></a>00164 
<a name="l00165"></a>00165     <span class="keywordflow">if</span> (!exists) {
<a name="l00166"></a>00166         seaf_debug (<span class="stringliteral">&quot;New locked file record %.8s, %s, %s, %&quot;</span>
<a name="l00167"></a>00167                     G_GINT64_FORMAT<span class="stringliteral">&quot;.\n&quot;</span>,
<a name="l00168"></a>00168                     fset-&gt;<a class="code" href="struct__LockedFileSet.html#ae51031b45e0a18e92898ce33bef301fe">repo_id</a>, path, operation, old_mtime);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170         sql = <span class="stringliteral">&quot;INSERT INTO LockedFiles VALUES (?, ?, ?, ?, ?, NULL)&quot;</span>;
<a name="l00171"></a>00171         stmt = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a4d1d0eb407f8f5dd522c3875beb7b9c8">sqlite_query_prepare</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l00172"></a>00172         sqlite3_bind_text (stmt, 1, fset-&gt;<a class="code" href="struct__LockedFileSet.html#ae51031b45e0a18e92898ce33bef301fe">repo_id</a>, -1, SQLITE_TRANSIENT);
<a name="l00173"></a>00173         sqlite3_bind_text (stmt, 2, path, -1, SQLITE_TRANSIENT);
<a name="l00174"></a>00174         sqlite3_bind_text (stmt, 3, operation, -1, SQLITE_TRANSIENT);
<a name="l00175"></a>00175         sqlite3_bind_int64 (stmt, 4, old_mtime);
<a name="l00176"></a>00176         sqlite3_bind_text (stmt, 5, file_id, -1, SQLITE_TRANSIENT);
<a name="l00177"></a>00177         <span class="keywordflow">if</span> (sqlite3_step (stmt) != SQLITE_DONE) {
<a name="l00178"></a>00178             seaf_warning (<span class="stringliteral">&quot;Failed to insert locked file %s to db: %s.\n&quot;</span>,
<a name="l00179"></a>00179                           path, sqlite3_errmsg (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>));
<a name="l00180"></a>00180             sqlite3_finalize (stmt);
<a name="l00181"></a>00181             pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00182"></a>00182             <span class="keywordflow">return</span> -1;
<a name="l00183"></a>00183         }
<a name="l00184"></a>00184         sqlite3_finalize (stmt);
<a name="l00185"></a>00185 
<a name="l00186"></a>00186         file = g_new0 (<a class="code" href="struct__LockedFile.html">LockedFile</a>, 1);
<a name="l00187"></a>00187         file-&gt;<a class="code" href="struct__LockedFile.html#abdcab3c93928ff7a61146d497d5e4ec7">operation</a> = g_strdup(operation);
<a name="l00188"></a>00188         file-&gt;<a class="code" href="struct__LockedFile.html#a1e6ec2e3b09c05236c6898df5dc77475">old_mtime</a> = old_mtime;
<a name="l00189"></a>00189         <span class="keywordflow">if</span> (file_id)
<a name="l00190"></a>00190             memcpy (file-&gt;<a class="code" href="struct__LockedFile.html#aebea73a3294e0a1493195022ffce6f23">file_id</a>, file_id, 40);
<a name="l00191"></a>00191 
<a name="l00192"></a>00192         g_hash_table_insert (fset-&gt;<a class="code" href="struct__LockedFileSet.html#a228bfd2b438cfa59fcf2dbd596ce335a">locked_files</a>, g_strdup(path), file);
<a name="l00193"></a>00193     } <span class="keywordflow">else</span> {
<a name="l00194"></a>00194         seaf_debug (<span class="stringliteral">&quot;Update locked file record %.8s, %s, %s.\n&quot;</span>,
<a name="l00195"></a>00195                     fset-&gt;<a class="code" href="struct__LockedFileSet.html#ae51031b45e0a18e92898ce33bef301fe">repo_id</a>, path, operation);
<a name="l00196"></a>00196 
<a name="l00197"></a>00197         <span class="comment">/* If a UPDATE record exists, don&#39;t update the old_mtime.</span>
<a name="l00198"></a>00198 <span class="comment">         * We need to keep the old mtime when the locked file was first detected.</span>
<a name="l00199"></a>00199 <span class="comment">         */</span>
<a name="l00200"></a>00200 
<a name="l00201"></a>00201         sql = <span class="stringliteral">&quot;UPDATE LockedFiles SET operation = ?, file_id = ? &quot;</span>
<a name="l00202"></a>00202             <span class="stringliteral">&quot;WHERE repo_id = ? AND path = ?&quot;</span>;
<a name="l00203"></a>00203         stmt = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a4d1d0eb407f8f5dd522c3875beb7b9c8">sqlite_query_prepare</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l00204"></a>00204         sqlite3_bind_text (stmt, 1, operation, -1, SQLITE_TRANSIENT);
<a name="l00205"></a>00205         sqlite3_bind_text (stmt, 2, file_id, -1, SQLITE_TRANSIENT);
<a name="l00206"></a>00206         sqlite3_bind_text (stmt, 3, fset-&gt;<a class="code" href="struct__LockedFileSet.html#ae51031b45e0a18e92898ce33bef301fe">repo_id</a>, -1, SQLITE_TRANSIENT);
<a name="l00207"></a>00207         sqlite3_bind_text (stmt, 4, path, -1, SQLITE_TRANSIENT);
<a name="l00208"></a>00208         <span class="keywordflow">if</span> (sqlite3_step (stmt) != SQLITE_DONE) {
<a name="l00209"></a>00209             seaf_warning (<span class="stringliteral">&quot;Failed to update locked file %s to db: %s.\n&quot;</span>,
<a name="l00210"></a>00210                           path, sqlite3_errmsg (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>));
<a name="l00211"></a>00211             sqlite3_finalize (stmt);
<a name="l00212"></a>00212             pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00213"></a>00213             <span class="keywordflow">return</span> -1;
<a name="l00214"></a>00214         }
<a name="l00215"></a>00215         sqlite3_finalize (stmt);
<a name="l00216"></a>00216 
<a name="l00217"></a>00217         file = g_hash_table_lookup (fset-&gt;<a class="code" href="struct__LockedFileSet.html#a228bfd2b438cfa59fcf2dbd596ce335a">locked_files</a>, path);
<a name="l00218"></a>00218         g_free (file-&gt;<a class="code" href="struct__LockedFile.html#abdcab3c93928ff7a61146d497d5e4ec7">operation</a>);
<a name="l00219"></a>00219         file-&gt;<a class="code" href="struct__LockedFile.html#abdcab3c93928ff7a61146d497d5e4ec7">operation</a> = g_strdup(operation);
<a name="l00220"></a>00220         <span class="keywordflow">if</span> (file_id)
<a name="l00221"></a>00221             memcpy (file-&gt;<a class="code" href="struct__LockedFile.html#aebea73a3294e0a1493195022ffce6f23">file_id</a>, file_id, 40);
<a name="l00222"></a>00222     }
<a name="l00223"></a>00223 
<a name="l00224"></a>00224     pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     <span class="keywordflow">return</span> 0;
<a name="l00227"></a>00227 }
<a name="l00228"></a>00228 
<a name="l00229"></a>00229 <span class="keywordtype">int</span>
<a name="l00230"></a><a class="code" href="daemon_2repo-mgr_8c.html#a4d1dacc802b818970800154a9bc6e3db">00230</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a4d1dacc802b818970800154a9bc6e3db">locked_file_set_remove</a> (<a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset, <span class="keyword">const</span> <span class="keywordtype">char</span> *path, gboolean db_only)
<a name="l00231"></a>00231 {
<a name="l00232"></a>00232     <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = fset-&gt;<a class="code" href="struct__LockedFileSet.html#ae599e7470165a7f4eaaaefad7bb85c5f">mgr</a>;
<a name="l00233"></a>00233     <span class="keywordtype">char</span> *sql;
<a name="l00234"></a>00234     sqlite3_stmt *stmt;
<a name="l00235"></a>00235 
<a name="l00236"></a>00236     <span class="keywordflow">if</span> (g_hash_table_lookup (fset-&gt;<a class="code" href="struct__LockedFileSet.html#a228bfd2b438cfa59fcf2dbd596ce335a">locked_files</a>, path) == NULL)
<a name="l00237"></a>00237         <span class="keywordflow">return</span> 0;
<a name="l00238"></a>00238 
<a name="l00239"></a>00239     seaf_debug (<span class="stringliteral">&quot;Remove locked file record %.8s, %s.\n&quot;</span>,
<a name="l00240"></a>00240                 fset-&gt;<a class="code" href="struct__LockedFileSet.html#ae51031b45e0a18e92898ce33bef301fe">repo_id</a>, path);
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00243"></a>00243 
<a name="l00244"></a>00244     sql = <span class="stringliteral">&quot;DELETE FROM LockedFiles WHERE repo_id = ? AND path = ?&quot;</span>;
<a name="l00245"></a>00245     stmt = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a4d1d0eb407f8f5dd522c3875beb7b9c8">sqlite_query_prepare</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l00246"></a>00246     sqlite3_bind_text (stmt, 1, fset-&gt;<a class="code" href="struct__LockedFileSet.html#ae51031b45e0a18e92898ce33bef301fe">repo_id</a>, -1, SQLITE_TRANSIENT);
<a name="l00247"></a>00247     sqlite3_bind_text (stmt, 2, path, -1, SQLITE_TRANSIENT);
<a name="l00248"></a>00248     <span class="keywordflow">if</span> (sqlite3_step (stmt) != SQLITE_DONE) {
<a name="l00249"></a>00249         seaf_warning (<span class="stringliteral">&quot;Failed to remove locked file %s from db: %s.\n&quot;</span>,
<a name="l00250"></a>00250                       path, sqlite3_errmsg (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>));
<a name="l00251"></a>00251         sqlite3_finalize (stmt);
<a name="l00252"></a>00252         pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00253"></a>00253         <span class="keywordflow">return</span> -1;
<a name="l00254"></a>00254     }
<a name="l00255"></a>00255     sqlite3_finalize (stmt);
<a name="l00256"></a>00256     pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00257"></a>00257 
<a name="l00258"></a>00258     g_hash_table_remove (fset-&gt;<a class="code" href="struct__LockedFileSet.html#a228bfd2b438cfa59fcf2dbd596ce335a">locked_files</a>, path);
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     <span class="keywordflow">return</span> 0;
<a name="l00261"></a>00261 }
<a name="l00262"></a>00262 
<a name="l00263"></a>00263 <a class="code" href="struct__LockedFile.html">LockedFile</a> *
<a name="l00264"></a><a class="code" href="daemon_2repo-mgr_8c.html#a818fec9b8684b386170e39cfe5feff55">00264</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a818fec9b8684b386170e39cfe5feff55">locked_file_set_lookup</a> (<a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset, <span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l00265"></a>00265 {
<a name="l00266"></a>00266     <span class="keywordflow">return</span> (<a class="code" href="struct__LockedFile.html">LockedFile</a> *) g_hash_table_lookup (fset-&gt;<a class="code" href="struct__LockedFileSet.html#a228bfd2b438cfa59fcf2dbd596ce335a">locked_files</a>, path);
<a name="l00267"></a>00267 }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269 <span class="comment">/* Folder permissions. */</span>
<a name="l00270"></a>00270 
<a name="l00271"></a>00271 <a class="code" href="struct__FolderPerm.html">FolderPerm</a> *
<a name="l00272"></a><a class="code" href="daemon_2repo-mgr_8c.html#af73ee61bbe7c459c590af5aa523bfec4">00272</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af73ee61bbe7c459c590af5aa523bfec4">folder_perm_new</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keyword">const</span> <span class="keywordtype">char</span> *permission)
<a name="l00273"></a>00273 {
<a name="l00274"></a>00274     <a class="code" href="struct__FolderPerm.html">FolderPerm</a> *perm = g_new0 (<a class="code" href="struct__FolderPerm.html">FolderPerm</a>, 1);
<a name="l00275"></a>00275 
<a name="l00276"></a>00276     perm-&gt;<a class="code" href="struct__FolderPerm.html#a1d44107695fb128bdc7de3a224a69d42">path</a> = g_strdup(path);
<a name="l00277"></a>00277     perm-&gt;<a class="code" href="struct__FolderPerm.html#a5032277d09756796f0d26e373383dac6">permission</a> = g_strdup(permission);
<a name="l00278"></a>00278 
<a name="l00279"></a>00279     <span class="keywordflow">return</span> perm;
<a name="l00280"></a>00280 }
<a name="l00281"></a>00281 
<a name="l00282"></a>00282 <span class="keywordtype">void</span>
<a name="l00283"></a><a class="code" href="daemon_2repo-mgr_8c.html#a16e4a5db024bcc5baf2ef8a3f0623a41">00283</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a16e4a5db024bcc5baf2ef8a3f0623a41">folder_perm_free</a> (<a class="code" href="struct__FolderPerm.html">FolderPerm</a> *perm)
<a name="l00284"></a>00284 {
<a name="l00285"></a>00285     <span class="keywordflow">if</span> (!perm)
<a name="l00286"></a>00286         <span class="keywordflow">return</span>;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288     g_free (perm-&gt;<a class="code" href="struct__FolderPerm.html#a1d44107695fb128bdc7de3a224a69d42">path</a>);
<a name="l00289"></a>00289     g_free (perm-&gt;<a class="code" href="struct__FolderPerm.html#a5032277d09756796f0d26e373383dac6">permission</a>);
<a name="l00290"></a>00290     g_free (perm);
<a name="l00291"></a>00291 }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293 <span class="keywordtype">int</span>
<a name="l00294"></a><a class="code" href="daemon_2repo-mgr_8c.html#a446e8f23cdec415146a604f1b954c1a3">00294</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a446e8f23cdec415146a604f1b954c1a3">seaf_repo_manager_update_folder_perms</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l00295"></a>00295                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l00296"></a>00296                                        <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1a">FolderPermType</a> <a class="code" href="fs-mgr_8c.html#a65cfc9e13d3352fd9099a0408cba715c">type</a>,
<a name="l00297"></a>00297                                        GList *folder_perms)
<a name="l00298"></a>00298 {
<a name="l00299"></a>00299     <span class="keywordtype">char</span> *sql;
<a name="l00300"></a>00300     sqlite3_stmt *stmt;
<a name="l00301"></a>00301     GList *ptr;
<a name="l00302"></a>00302     <a class="code" href="struct__FolderPerm.html">FolderPerm</a> *perm;
<a name="l00303"></a>00303 
<a name="l00304"></a>00304     g_return_val_if_fail ((type == <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa664ef9343772c1e5e20606d23a2f696a">FOLDER_PERM_TYPE_USER</a> ||
<a name="l00305"></a>00305                            type == <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa55b4f2e55f412aa138091a6f350d16de">FOLDER_PERM_TYPE_GROUP</a>),
<a name="l00306"></a>00306                           -1);
<a name="l00307"></a>00307 
<a name="l00308"></a>00308     pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00309"></a>00309 
<a name="l00310"></a>00310     <span class="keywordflow">if</span> (type == <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa664ef9343772c1e5e20606d23a2f696a">FOLDER_PERM_TYPE_USER</a>)
<a name="l00311"></a>00311         sql = <span class="stringliteral">&quot;DELETE FROM FolderUserPerms WHERE repo_id = ?&quot;</span>;
<a name="l00312"></a>00312     <span class="keywordflow">else</span>
<a name="l00313"></a>00313         sql = <span class="stringliteral">&quot;DELETE FROM FolderGroupPerms WHERE repo_id = ?&quot;</span>;
<a name="l00314"></a>00314     stmt = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a4d1d0eb407f8f5dd522c3875beb7b9c8">sqlite_query_prepare</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l00315"></a>00315     sqlite3_bind_text (stmt, 1, repo_id, -1, SQLITE_TRANSIENT);
<a name="l00316"></a>00316     <span class="keywordflow">if</span> (sqlite3_step (stmt) != SQLITE_DONE) {
<a name="l00317"></a>00317         seaf_warning (<span class="stringliteral">&quot;Failed to remove folder perms for %.8s: %s.\n&quot;</span>,
<a name="l00318"></a>00318                       repo_id, sqlite3_errmsg (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>));
<a name="l00319"></a>00319         sqlite3_finalize (stmt);
<a name="l00320"></a>00320         pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00321"></a>00321         <span class="keywordflow">return</span> -1;
<a name="l00322"></a>00322     }
<a name="l00323"></a>00323     sqlite3_finalize (stmt);
<a name="l00324"></a>00324 
<a name="l00325"></a>00325     <span class="keywordflow">if</span> (!folder_perms) {
<a name="l00326"></a>00326         pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00327"></a>00327         <span class="keywordflow">return</span> 0;
<a name="l00328"></a>00328     }
<a name="l00329"></a>00329 
<a name="l00330"></a>00330     <span class="keywordflow">if</span> (type == <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa664ef9343772c1e5e20606d23a2f696a">FOLDER_PERM_TYPE_USER</a>)
<a name="l00331"></a>00331         sql = <span class="stringliteral">&quot;INSERT INTO FolderUserPerms VALUES (?, ?, ?)&quot;</span>;
<a name="l00332"></a>00332     <span class="keywordflow">else</span>
<a name="l00333"></a>00333         sql = <span class="stringliteral">&quot;INSERT INTO FolderGroupPerms VALUES (?, ?, ?)&quot;</span>;
<a name="l00334"></a>00334     stmt = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a4d1d0eb407f8f5dd522c3875beb7b9c8">sqlite_query_prepare</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l00335"></a>00335 
<a name="l00336"></a>00336     <span class="keywordflow">for</span> (ptr = folder_perms; ptr; ptr = ptr-&gt;next) {
<a name="l00337"></a>00337         perm = ptr-&gt;data;
<a name="l00338"></a>00338 
<a name="l00339"></a>00339         sqlite3_bind_text (stmt, 1, repo_id, -1, SQLITE_TRANSIENT);
<a name="l00340"></a>00340         sqlite3_bind_text (stmt, 2, perm-&gt;<a class="code" href="struct__FolderPerm.html#a1d44107695fb128bdc7de3a224a69d42">path</a>, -1, SQLITE_TRANSIENT);
<a name="l00341"></a>00341         sqlite3_bind_text (stmt, 3, perm-&gt;<a class="code" href="struct__FolderPerm.html#a5032277d09756796f0d26e373383dac6">permission</a>, -1, SQLITE_TRANSIENT);
<a name="l00342"></a>00342 
<a name="l00343"></a>00343         <span class="keywordflow">if</span> (sqlite3_step (stmt) != SQLITE_DONE) {
<a name="l00344"></a>00344             seaf_warning (<span class="stringliteral">&quot;Failed to insert folder perms for %.8s: %s.\n&quot;</span>,
<a name="l00345"></a>00345                           repo_id, sqlite3_errmsg (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>));
<a name="l00346"></a>00346             sqlite3_finalize (stmt);
<a name="l00347"></a>00347             pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00348"></a>00348             <span class="keywordflow">return</span> -1;
<a name="l00349"></a>00349         }
<a name="l00350"></a>00350 
<a name="l00351"></a>00351         sqlite3_reset (stmt);
<a name="l00352"></a>00352         sqlite3_clear_bindings (stmt);
<a name="l00353"></a>00353     }
<a name="l00354"></a>00354 
<a name="l00355"></a>00355     sqlite3_finalize (stmt);
<a name="l00356"></a>00356 
<a name="l00357"></a>00357     pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00358"></a>00358 
<a name="l00359"></a>00359     <span class="keywordflow">return</span> 0;
<a name="l00360"></a>00360 }
<a name="l00361"></a>00361 
<a name="l00362"></a>00362 <span class="keyword">static</span> gboolean
<a name="l00363"></a>00363 load_folder_perm (sqlite3_stmt *stmt, <span class="keywordtype">void</span> *data)
<a name="l00364"></a>00364 {
<a name="l00365"></a>00365     GList **p_perms = data;
<a name="l00366"></a>00366     <span class="keyword">const</span> <span class="keywordtype">char</span> *path, *permission;
<a name="l00367"></a>00367 
<a name="l00368"></a>00368     path = sqlite3_column_text (stmt, 0);
<a name="l00369"></a>00369     permission = sqlite3_column_text (stmt, 1);
<a name="l00370"></a>00370 
<a name="l00371"></a>00371     <a class="code" href="struct__FolderPerm.html">FolderPerm</a> *perm = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af73ee61bbe7c459c590af5aa523bfec4">folder_perm_new</a> (path, permission);
<a name="l00372"></a>00372     *p_perms = g_list_prepend (*p_perms, perm);
<a name="l00373"></a>00373 
<a name="l00374"></a>00374     <span class="keywordflow">return</span> TRUE;
<a name="l00375"></a>00375 }
<a name="l00376"></a>00376 
<a name="l00377"></a>00377 <span class="keyword">static</span> gint
<a name="l00378"></a>00378 comp_folder_perms (gconstpointer a, gconstpointer b)
<a name="l00379"></a>00379 {
<a name="l00380"></a>00380     <span class="keyword">const</span> <a class="code" href="struct__FolderPerm.html">FolderPerm</a> *perm_a = a, *perm_b = b;
<a name="l00381"></a>00381 
<a name="l00382"></a>00382     <span class="keywordflow">return</span> (strcmp (perm_b-&gt;path, perm_a-&gt;<a class="code" href="struct__FolderPerm.html#a1d44107695fb128bdc7de3a224a69d42">path</a>));
<a name="l00383"></a>00383 }
<a name="l00384"></a>00384 
<a name="l00385"></a>00385 GList *
<a name="l00386"></a><a class="code" href="daemon_2repo-mgr_8c.html#ad00e4e927e8099054e29e532cae9c5e4">00386</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ad00e4e927e8099054e29e532cae9c5e4">seaf_repo_manager_load_folder_perms</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l00387"></a>00387                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l00388"></a>00388                                      <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1a">FolderPermType</a> <a class="code" href="fs-mgr_8c.html#a65cfc9e13d3352fd9099a0408cba715c">type</a>)
<a name="l00389"></a>00389 {
<a name="l00390"></a>00390     GList *perms = NULL;
<a name="l00391"></a>00391     <span class="keywordtype">char</span> sql[256];
<a name="l00392"></a>00392 
<a name="l00393"></a>00393     g_return_val_if_fail ((type == <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa664ef9343772c1e5e20606d23a2f696a">FOLDER_PERM_TYPE_USER</a> ||
<a name="l00394"></a>00394                            type == <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa55b4f2e55f412aa138091a6f350d16de">FOLDER_PERM_TYPE_GROUP</a>),
<a name="l00395"></a>00395                           NULL);
<a name="l00396"></a>00396 
<a name="l00397"></a>00397     <span class="keywordflow">if</span> (type == <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa664ef9343772c1e5e20606d23a2f696a">FOLDER_PERM_TYPE_USER</a>)
<a name="l00398"></a>00398         sqlite3_snprintf (<span class="keyword">sizeof</span>(sql), sql,
<a name="l00399"></a>00399                           <span class="stringliteral">&quot;SELECT path, permission FROM FolderUserPerms &quot;</span>
<a name="l00400"></a>00400                           <span class="stringliteral">&quot;WHERE repo_id = &#39;%q&#39;&quot;</span>,
<a name="l00401"></a>00401                           repo_id);
<a name="l00402"></a>00402     <span class="keywordflow">else</span>
<a name="l00403"></a>00403         sqlite3_snprintf (<span class="keyword">sizeof</span>(sql), sql,
<a name="l00404"></a>00404                           <span class="stringliteral">&quot;SELECT path, permission FROM FolderGroupPerms &quot;</span>
<a name="l00405"></a>00405                           <span class="stringliteral">&quot;WHERE repo_id = &#39;%q&#39;&quot;</span>,
<a name="l00406"></a>00406                           repo_id);
<a name="l00407"></a>00407 
<a name="l00408"></a>00408     pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00409"></a>00409 
<a name="l00410"></a>00410     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql,
<a name="l00411"></a>00411                                      load_folder_perm, &amp;perms) &lt; 0) {
<a name="l00412"></a>00412         pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00413"></a>00413         GList *ptr;
<a name="l00414"></a>00414         <span class="keywordflow">for</span> (ptr = perms; ptr; ptr = ptr-&gt;next)
<a name="l00415"></a>00415             <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a16e4a5db024bcc5baf2ef8a3f0623a41">folder_perm_free</a> ((<a class="code" href="struct__FolderPerm.html">FolderPerm</a> *)ptr-&gt;data);
<a name="l00416"></a>00416         g_list_free (perms);
<a name="l00417"></a>00417         <span class="keywordflow">return</span> NULL;
<a name="l00418"></a>00418     }
<a name="l00419"></a>00419 
<a name="l00420"></a>00420     pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00421"></a>00421 
<a name="l00422"></a>00422     <span class="comment">/* Sort list in descending order by perm-&gt;path (longer path first). */</span>
<a name="l00423"></a>00423     perms = g_list_sort (perms, comp_folder_perms);
<a name="l00424"></a>00424 
<a name="l00425"></a>00425     <span class="keywordflow">return</span> perms;
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 <span class="keywordtype">int</span>
<a name="l00429"></a><a class="code" href="daemon_2repo-mgr_8c.html#af7adb54d2ed6bcfd5b722428bfcfb6d6">00429</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af7adb54d2ed6bcfd5b722428bfcfb6d6">seaf_repo_manager_update_folder_perm_timestamp</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l00430"></a>00430                                                 <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l00431"></a>00431                                                 gint64 timestamp)
<a name="l00432"></a>00432 {
<a name="l00433"></a>00433     <span class="keywordtype">char</span> sql[256];
<a name="l00434"></a>00434     <span class="keywordtype">int</span> ret;
<a name="l00435"></a>00435 
<a name="l00436"></a>00436     snprintf (sql, <span class="keyword">sizeof</span>(sql),
<a name="l00437"></a>00437               <span class="stringliteral">&quot;REPLACE INTO FolderPermTimestamp VALUES (&#39;%s&#39;, %&quot;</span>G_GINT64_FORMAT<span class="stringliteral">&quot;)&quot;</span>,
<a name="l00438"></a>00438               repo_id, timestamp);
<a name="l00439"></a>00439 
<a name="l00440"></a>00440     pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00441"></a>00441 
<a name="l00442"></a>00442     ret = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00445"></a>00445 
<a name="l00446"></a>00446     <span class="keywordflow">return</span> ret;
<a name="l00447"></a>00447 }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449 gint64
<a name="l00450"></a><a class="code" href="daemon_2repo-mgr_8c.html#a7320afc04f67e0cb3dcc20389479c234">00450</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a7320afc04f67e0cb3dcc20389479c234">seaf_repo_manager_get_folder_perm_timestamp</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l00451"></a>00451                                              <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l00452"></a>00452 {
<a name="l00453"></a>00453     <span class="keywordtype">char</span> sql[256];
<a name="l00454"></a>00454     gint64 ret;
<a name="l00455"></a>00455 
<a name="l00456"></a>00456     sqlite3_snprintf (<span class="keyword">sizeof</span>(sql), sql,
<a name="l00457"></a>00457                       <span class="stringliteral">&quot;SELECT timestamp FROM FolderPermTimestamp WHERE repo_id = &#39;%q&#39;&quot;</span>,
<a name="l00458"></a>00458                       repo_id);
<a name="l00459"></a>00459 
<a name="l00460"></a>00460     pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00461"></a>00461 
<a name="l00462"></a>00462     ret = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a8e8a339b39f493438e6a2c06dcdc06da">sqlite_get_int64</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l00463"></a>00463 
<a name="l00464"></a>00464     pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l00465"></a>00465 
<a name="l00466"></a>00466     <span class="keywordflow">return</span> ret;
<a name="l00467"></a>00467 }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l00470"></a>00470 lookup_folder_perm (GList *perms, <span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l00471"></a>00471 {
<a name="l00472"></a>00472     GList *ptr;
<a name="l00473"></a>00473     <a class="code" href="struct__FolderPerm.html">FolderPerm</a> *perm;
<a name="l00474"></a>00474     <span class="keywordtype">char</span> *folder;
<a name="l00475"></a>00475     <span class="keywordtype">int</span> len;
<a name="l00476"></a>00476     <span class="keywordtype">char</span> *permission = NULL;
<a name="l00477"></a>00477 
<a name="l00478"></a>00478     <span class="keywordflow">for</span> (ptr = perms; ptr; ptr = ptr-&gt;next) {
<a name="l00479"></a>00479         perm = ptr-&gt;data;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481         <span class="keywordflow">if</span> (strcmp (perm-&gt;<a class="code" href="struct__FolderPerm.html#a1d44107695fb128bdc7de3a224a69d42">path</a>, <span class="stringliteral">&quot;/&quot;</span>) != 0)
<a name="l00482"></a>00482             folder = g_strconcat (perm-&gt;<a class="code" href="struct__FolderPerm.html#a1d44107695fb128bdc7de3a224a69d42">path</a>, <span class="stringliteral">&quot;/&quot;</span>, NULL);
<a name="l00483"></a>00483         <span class="keywordflow">else</span>
<a name="l00484"></a>00484             folder = g_strdup(perm-&gt;<a class="code" href="struct__FolderPerm.html#a1d44107695fb128bdc7de3a224a69d42">path</a>);
<a name="l00485"></a>00485 
<a name="l00486"></a>00486         len = strlen(folder);
<a name="l00487"></a>00487         <span class="keywordflow">if</span> (strcmp (perm-&gt;<a class="code" href="struct__FolderPerm.html#a1d44107695fb128bdc7de3a224a69d42">path</a>, path) == 0 || strncmp(folder, path, len) == 0) {
<a name="l00488"></a>00488             permission = perm-&gt;<a class="code" href="struct__FolderPerm.html#a5032277d09756796f0d26e373383dac6">permission</a>;
<a name="l00489"></a>00489             g_free (folder);
<a name="l00490"></a>00490             <span class="keywordflow">break</span>;
<a name="l00491"></a>00491         }
<a name="l00492"></a>00492         g_free (folder);
<a name="l00493"></a>00493     }
<a name="l00494"></a>00494 
<a name="l00495"></a>00495     <span class="keywordflow">return</span> permission;
<a name="l00496"></a>00496 }
<a name="l00497"></a>00497 
<a name="l00498"></a>00498 <span class="keyword">static</span> gboolean
<a name="l00499"></a>00499 is_path_writable (GList *user_perms,
<a name="l00500"></a>00500                   GList *group_perms,
<a name="l00501"></a>00501                   gboolean is_repo_readonly,
<a name="l00502"></a>00502                   <span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l00503"></a>00503 {
<a name="l00504"></a>00504     <span class="keywordtype">char</span> *permission = NULL;
<a name="l00505"></a>00505     <span class="keywordtype">char</span> *abs_path = NULL;
<a name="l00506"></a>00506 
<a name="l00507"></a>00507     <span class="keywordflow">if</span> (user_perms || group_perms)
<a name="l00508"></a>00508         abs_path = g_strconcat (<span class="stringliteral">&quot;/&quot;</span>, path, NULL);
<a name="l00509"></a>00509 
<a name="l00510"></a>00510     <span class="keywordflow">if</span> (user_perms)
<a name="l00511"></a>00511         permission = lookup_folder_perm (user_perms, abs_path);
<a name="l00512"></a>00512     <span class="keywordflow">if</span> (!permission &amp;&amp; group_perms)
<a name="l00513"></a>00513         permission = lookup_folder_perm (group_perms, abs_path);
<a name="l00514"></a>00514 
<a name="l00515"></a>00515     g_free (abs_path);
<a name="l00516"></a>00516 
<a name="l00517"></a>00517     <span class="keywordflow">if</span> (!permission)
<a name="l00518"></a>00518         <span class="keywordflow">return</span> !is_repo_readonly;
<a name="l00519"></a>00519 
<a name="l00520"></a>00520     <span class="keywordflow">if</span> (strcmp (permission, <span class="stringliteral">&quot;rw&quot;</span>) == 0)
<a name="l00521"></a>00521         <span class="keywordflow">return</span> TRUE;
<a name="l00522"></a>00522     <span class="keywordflow">else</span>
<a name="l00523"></a>00523         <span class="keywordflow">return</span> FALSE;
<a name="l00524"></a>00524 }
<a name="l00525"></a>00525 
<a name="l00526"></a>00526 gboolean
<a name="l00527"></a><a class="code" href="daemon_2repo-mgr_8c.html#a35ce9f51287bbd5f961c261516c1c5f0">00527</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a35ce9f51287bbd5f961c261516c1c5f0">is_repo_id_valid</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>)
<a name="l00528"></a>00528 {
<a name="l00529"></a>00529     <span class="keywordflow">if</span> (!<span class="keywordtype">id</span>)
<a name="l00530"></a>00530         <span class="keywordflow">return</span> FALSE;
<a name="l00531"></a>00531 
<a name="l00532"></a>00532     <span class="keywordflow">return</span> <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a48ecdc72b727191abafbbf2ec1f70ace">is_uuid_valid</a> (<span class="keywordtype">id</span>);
<a name="l00533"></a>00533 }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535 <a class="code" href="struct__SeafRepo.html">SeafRepo</a>*
<a name="l00536"></a><a class="code" href="daemon_2repo-mgr_8c.html#a63ab9fe4694e3d967376c911cbe2c655">00536</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a63ab9fe4694e3d967376c911cbe2c655">seaf_repo_new</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *desc)
<a name="l00537"></a>00537 {
<a name="l00538"></a>00538     <a class="code" href="struct__SeafRepo.html">SeafRepo</a>* repo;
<a name="l00539"></a>00539 
<a name="l00540"></a>00540     <span class="comment">/* valid check */</span>
<a name="l00541"></a>00541   
<a name="l00542"></a>00542     
<a name="l00543"></a>00543     repo = g_new0 (<a class="code" href="struct__SeafRepo.html">SeafRepo</a>, 1);
<a name="l00544"></a>00544     memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="keywordtype">id</span>, 36);
<a name="l00545"></a>00545     repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>[36] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00546"></a>00546 
<a name="l00547"></a>00547     repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a> = g_strdup(name);
<a name="l00548"></a>00548     repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a> = g_strdup(desc);
<a name="l00549"></a>00549 
<a name="l00550"></a>00550     repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a> = TRUE;
<a name="l00551"></a>00551     repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a> = 1;
<a name="l00552"></a>00552     repo-&gt;<a class="code" href="struct__SeafRepo.html#a575e562d38b7fc0adc79a6b24ea00ac1">net_browsable</a> = 0;
<a name="l00553"></a>00553     pthread_mutex_init (&amp;repo-&gt;<a class="code" href="struct__SeafRepo.html#aaa93119bb8b7b6038e9feb3c3a78b0ab">lock</a>, NULL);
<a name="l00554"></a>00554 
<a name="l00555"></a>00555     <span class="keywordflow">return</span> repo;
<a name="l00556"></a>00556 }
<a name="l00557"></a>00557 
<a name="l00558"></a>00558 <span class="keywordtype">int</span>
<a name="l00559"></a><a class="code" href="daemon_2repo-mgr_8c.html#ad1200d69d8e6219885da4e85af15dca2">00559</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ad1200d69d8e6219885da4e85af15dca2">seaf_repo_check_worktree</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l00560"></a>00560 {
<a name="l00561"></a>00561     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l00562"></a>00562 
<a name="l00563"></a>00563     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a> == NULL) {
<a name="l00564"></a>00564         seaf_warning (<span class="stringliteral">&quot;Worktree for repo &#39;%s&#39;(%.8s) is not set.\n&quot;</span>,
<a name="l00565"></a>00565                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00566"></a>00566         <span class="keywordflow">return</span> -1;
<a name="l00567"></a>00567     }
<a name="l00568"></a>00568 
<a name="l00569"></a>00569     <span class="comment">/* check repo worktree */</span>
<a name="l00570"></a>00570     <span class="keywordflow">if</span> (g_access(repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, F_OK) &lt; 0) {
<a name="l00571"></a>00571         seaf_warning (<span class="stringliteral">&quot;Failed to access worktree %s for repo &#39;%s&#39;(%.8s)\n&quot;</span>,
<a name="l00572"></a>00572                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00573"></a>00573         <span class="keywordflow">return</span> -1;
<a name="l00574"></a>00574     }
<a name="l00575"></a>00575     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, &amp;st) &lt; 0) {
<a name="l00576"></a>00576         seaf_warning (<span class="stringliteral">&quot;Failed to stat worktree %s for repo &#39;%s&#39;(%.8s)\n&quot;</span>,
<a name="l00577"></a>00577                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00578"></a>00578         <span class="keywordflow">return</span> -1;
<a name="l00579"></a>00579     }
<a name="l00580"></a>00580     <span class="keywordflow">if</span> (!S_ISDIR(st.st_mode)) {
<a name="l00581"></a>00581         seaf_warning (<span class="stringliteral">&quot;Worktree %s for repo &#39;%s&#39;(%.8s) is not a directory.\n&quot;</span>,
<a name="l00582"></a>00582                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00583"></a>00583         <span class="keywordflow">return</span> -1;
<a name="l00584"></a>00584     }
<a name="l00585"></a>00585 
<a name="l00586"></a>00586     <span class="keywordflow">return</span> 0;
<a name="l00587"></a>00587 }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589 
<a name="l00590"></a>00590 <span class="keyword">static</span> gboolean
<a name="l00591"></a>00591 check_worktree_common (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l00592"></a>00592 {
<a name="l00593"></a>00593     <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>) {
<a name="l00594"></a>00594         seaf_warning (<span class="stringliteral">&quot;Head for repo &#39;%s&#39;(%.8s) is not set.\n&quot;</span>,
<a name="l00595"></a>00595                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00596"></a>00596         <span class="keywordflow">return</span> FALSE;
<a name="l00597"></a>00597     }
<a name="l00598"></a>00598 
<a name="l00599"></a>00599     <span class="keywordflow">if</span> (<a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ad1200d69d8e6219885da4e85af15dca2">seaf_repo_check_worktree</a> (repo) &lt; 0) {
<a name="l00600"></a>00600         <span class="keywordflow">return</span> FALSE;
<a name="l00601"></a>00601     }
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     <span class="keywordflow">return</span> TRUE;
<a name="l00604"></a>00604 }
<a name="l00605"></a>00605 
<a name="l00606"></a>00606 <span class="keywordtype">void</span>
<a name="l00607"></a><a class="code" href="daemon_2repo-mgr_8c.html#ad0a65514ad80789ff244b20c66460b96">00607</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ad0a65514ad80789ff244b20c66460b96">seaf_repo_free</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l00608"></a>00608 {
<a name="l00609"></a>00609     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>) <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>);
<a name="l00610"></a>00610 
<a name="l00611"></a>00611     g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>);
<a name="l00612"></a>00612     g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a>);
<a name="l00613"></a>00613     g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4d7c42c5644eb9dbfd24bf43adb9316c">category</a>);
<a name="l00614"></a>00614     g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>);
<a name="l00615"></a>00615     g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>);
<a name="l00616"></a>00616     g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a>);
<a name="l00617"></a>00617     g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a0ce3b61cb31e78ffea429615379b3eb4">token</a>);
<a name="l00618"></a>00618     g_free (repo);
<a name="l00619"></a>00619 }
<a name="l00620"></a>00620 
<a name="l00621"></a>00621 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00622"></a>00622 set_head_common (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch)
<a name="l00623"></a>00623 {
<a name="l00624"></a>00624     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>)
<a name="l00625"></a>00625         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>);
<a name="l00626"></a>00626     repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a> = branch;
<a name="l00627"></a>00627     <a class="code" href="branch-mgr_8c.html#a25fb6e7971efc301cfed3ef286f29746">seaf_branch_ref</a>(branch);
<a name="l00628"></a>00628 }
<a name="l00629"></a>00629 
<a name="l00630"></a>00630 <span class="keywordtype">int</span>
<a name="l00631"></a><a class="code" href="daemon_2repo-mgr_8c.html#a6c47d6277897f6afbe866f2755f9762d">00631</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a6c47d6277897f6afbe866f2755f9762d">seaf_repo_set_head</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch)
<a name="l00632"></a>00632 {
<a name="l00633"></a>00633     <span class="keywordflow">if</span> (save_branch_repo_map (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>, branch) &lt; 0)
<a name="l00634"></a>00634         <span class="keywordflow">return</span> -1;
<a name="l00635"></a>00635     set_head_common (repo, branch);
<a name="l00636"></a>00636     <span class="keywordflow">return</span> 0;
<a name="l00637"></a>00637 }
<a name="l00638"></a>00638 
<a name="l00639"></a>00639 <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *
<a name="l00640"></a><a class="code" href="daemon_2repo-mgr_8c.html#a7fdd2ba98b2cab98aaced0e49a1685a9">00640</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a7fdd2ba98b2cab98aaced0e49a1685a9">seaf_repo_get_head_commit</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l00641"></a>00641 {
<a name="l00642"></a>00642     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l00643"></a>00643     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head;
<a name="l00644"></a>00644 
<a name="l00645"></a>00645     repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id);
<a name="l00646"></a>00646     <span class="keywordflow">if</span> (!repo) {
<a name="l00647"></a>00647         seaf_warning (<span class="stringliteral">&quot;Failed to get repo %s.\n&quot;</span>, repo_id);
<a name="l00648"></a>00648         <span class="keywordflow">return</span> NULL;
<a name="l00649"></a>00649     }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651     head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l00652"></a>00652                                            repo_id, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
<a name="l00653"></a>00653                                            repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l00654"></a>00654     <span class="keywordflow">if</span> (!head) {
<a name="l00655"></a>00655         seaf_warning (<span class="stringliteral">&quot;Failed to get head for repo %s.\n&quot;</span>, repo_id);
<a name="l00656"></a>00656         <span class="keywordflow">return</span> NULL;
<a name="l00657"></a>00657     }
<a name="l00658"></a>00658 
<a name="l00659"></a>00659     <span class="keywordflow">return</span> head;
<a name="l00660"></a>00660 }
<a name="l00661"></a>00661 
<a name="l00662"></a>00662 <span class="keywordtype">void</span>
<a name="l00663"></a><a class="code" href="daemon_2repo-mgr_8c.html#a9c8ead9892374c87ece888d76e810197">00663</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a9c8ead9892374c87ece888d76e810197">seaf_repo_from_commit</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit)
<a name="l00664"></a>00664 {
<a name="l00665"></a>00665     repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a> = g_strdup (commit-&gt;<a class="code" href="struct__SeafCommit.html#aacd7b88f8a3e72446cd7352396eaa09e">repo_name</a>);
<a name="l00666"></a>00666     repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a> = g_strdup (commit-&gt;<a class="code" href="struct__SeafCommit.html#aa3d8e868c630cfbecbcb9158c4bbe2e4">repo_desc</a>);
<a name="l00667"></a>00667     repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#a906e77d2a658f4337437ff8694a4bfc0">encrypted</a>;
<a name="l00668"></a>00668     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
<a name="l00669"></a>00669         repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a>;
<a name="l00670"></a>00670         <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> == 1)
<a name="l00671"></a>00671             memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a>, 32);
<a name="l00672"></a>00672         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> == 2) {
<a name="l00673"></a>00673             memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a>, 64);
<a name="l00674"></a>00674             memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#a83e0a2366ba320396f2deb6faa167b84">random_key</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#ab1d44814bc44472105aef8761656e3d7">random_key</a>, 96);
<a name="l00675"></a>00675         }
<a name="l00676"></a>00676     }
<a name="l00677"></a>00677     repo-&gt;<a class="code" href="struct__SeafRepo.html#a4710aaee11c7887df402fffa7ca6c54f">no_local_history</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#a383ea4a4b94417c7d9e9827d60420d64">no_local_history</a>;
<a name="l00678"></a>00678     repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#abc83f168ce2b43fa864522bf0ea26d6d">version</a>;
<a name="l00679"></a>00679 }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681 <span class="keywordtype">void</span>
<a name="l00682"></a><a class="code" href="daemon_2repo-mgr_8c.html#a39a9a41ffdfc324f3c935251d9e14d51">00682</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a39a9a41ffdfc324f3c935251d9e14d51">seaf_repo_to_commit</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit)
<a name="l00683"></a>00683 {
<a name="l00684"></a>00684     commit-&gt;<a class="code" href="struct__SeafCommit.html#aacd7b88f8a3e72446cd7352396eaa09e">repo_name</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>);
<a name="l00685"></a>00685     commit-&gt;<a class="code" href="struct__SeafCommit.html#aa3d8e868c630cfbecbcb9158c4bbe2e4">repo_desc</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a>);
<a name="l00686"></a>00686     commit-&gt;<a class="code" href="struct__SeafCommit.html#a906e77d2a658f4337437ff8694a4bfc0">encrypted</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>;
<a name="l00687"></a>00687     <span class="keywordflow">if</span> (commit-&gt;<a class="code" href="struct__SeafCommit.html#a906e77d2a658f4337437ff8694a4bfc0">encrypted</a>) {
<a name="l00688"></a>00688         commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>;
<a name="l00689"></a>00689         <span class="keywordflow">if</span> (commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a> == 1)
<a name="l00690"></a>00690             commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>);
<a name="l00691"></a>00691         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a> == 2) {
<a name="l00692"></a>00692             commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>);
<a name="l00693"></a>00693             commit-&gt;<a class="code" href="struct__SeafCommit.html#ab1d44814bc44472105aef8761656e3d7">random_key</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a83e0a2366ba320396f2deb6faa167b84">random_key</a>);
<a name="l00694"></a>00694         }
<a name="l00695"></a>00695     }
<a name="l00696"></a>00696     commit-&gt;<a class="code" href="struct__SeafCommit.html#a383ea4a4b94417c7d9e9827d60420d64">no_local_history</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#a4710aaee11c7887df402fffa7ca6c54f">no_local_history</a>;
<a name="l00697"></a>00697     commit-&gt;<a class="code" href="struct__SeafCommit.html#abc83f168ce2b43fa864522bf0ea26d6d">version</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>;
<a name="l00698"></a>00698 }
<a name="l00699"></a>00699 
<a name="l00700"></a>00700 <span class="keyword">static</span> gboolean
<a name="l00701"></a>00701 collect_commit (<a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit, <span class="keywordtype">void</span> *vlist, gboolean *stop)
<a name="l00702"></a>00702 {
<a name="l00703"></a>00703     GList **commits = vlist;
<a name="l00704"></a>00704 
<a name="l00705"></a>00705     <span class="comment">/* The traverse function will unref the commit, so we need to ref it.</span>
<a name="l00706"></a>00706 <span class="comment">     */</span>
<a name="l00707"></a>00707     <a class="code" href="commit-mgr_8c.html#a2b1cc305cf40cb64c341a0e64d0fe921">seaf_commit_ref</a> (commit);
<a name="l00708"></a>00708     *commits = g_list_prepend (*commits, commit);
<a name="l00709"></a>00709     <span class="keywordflow">return</span> TRUE;
<a name="l00710"></a>00710 }
<a name="l00711"></a>00711 
<a name="l00712"></a>00712 GList *
<a name="l00713"></a><a class="code" href="daemon_2repo-mgr_8c.html#adc55911231fbdbb9d54f39d7f0e60dca">00713</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#adc55911231fbdbb9d54f39d7f0e60dca">seaf_repo_get_commits</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l00714"></a>00714 {
<a name="l00715"></a>00715     GList *branches;
<a name="l00716"></a>00716     GList *ptr;
<a name="l00717"></a>00717     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch;
<a name="l00718"></a>00718     GList *commits = NULL;
<a name="l00719"></a>00719 
<a name="l00720"></a>00720     branches = <a class="code" href="branch-mgr_8c.html#ad5bd62cbe17cb8fe91bcd993956a1fbf">seaf_branch_manager_get_branch_list</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00721"></a>00721     <span class="keywordflow">if</span> (branches == NULL) {
<a name="l00722"></a>00722         g_warning (<span class="stringliteral">&quot;Failed to get branch list of repo %s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00723"></a>00723         <span class="keywordflow">return</span> NULL;
<a name="l00724"></a>00724     }
<a name="l00725"></a>00725 
<a name="l00726"></a>00726     <span class="keywordflow">for</span> (ptr = branches; ptr != NULL; ptr = ptr-&gt;next) {
<a name="l00727"></a>00727         branch = ptr-&gt;data;
<a name="l00728"></a>00728         gboolean res = <a class="code" href="commit-mgr_8c.html#ac6547d5546781608b39446d9a2077fed">seaf_commit_manager_traverse_commit_tree</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l00729"></a>00729                                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l00730"></a>00730                                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
<a name="l00731"></a>00731                                                                  branch-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>,
<a name="l00732"></a>00732                                                                  collect_commit,
<a name="l00733"></a>00733                                                                  &amp;commits, FALSE);
<a name="l00734"></a>00734         <span class="keywordflow">if</span> (!res) {
<a name="l00735"></a>00735             <span class="keywordflow">for</span> (ptr = commits; ptr != NULL; ptr = ptr-&gt;next)
<a name="l00736"></a>00736                 <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> ((<a class="code" href="struct__SeafCommit.html">SeafCommit</a> *)(ptr-&gt;data));
<a name="l00737"></a>00737             g_list_free (commits);
<a name="l00738"></a>00738             <span class="keywordflow">goto</span> out;
<a name="l00739"></a>00739         }
<a name="l00740"></a>00740     }
<a name="l00741"></a>00741 
<a name="l00742"></a>00742     commits = g_list_reverse (commits);
<a name="l00743"></a>00743 
<a name="l00744"></a>00744 out:
<a name="l00745"></a>00745     <span class="keywordflow">for</span> (ptr = branches; ptr != NULL; ptr = ptr-&gt;next) {
<a name="l00746"></a>00746         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> ((<a class="code" href="struct__SeafBranch.html">SeafBranch</a> *)ptr-&gt;data);
<a name="l00747"></a>00747     }
<a name="l00748"></a>00748     <span class="keywordflow">return</span> commits;
<a name="l00749"></a>00749 }
<a name="l00750"></a>00750 
<a name="l00751"></a>00751 <span class="keywordtype">void</span>
<a name="l00752"></a><a class="code" href="daemon_2repo-mgr_8c.html#a01b64563a9ab1351f8a9626c86ff8d6a">00752</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a01b64563a9ab1351f8a9626c86ff8d6a">seaf_repo_set_readonly</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l00753"></a>00753 {
<a name="l00754"></a>00754     repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a> = TRUE;
<a name="l00755"></a>00755     save_repo_property (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a152076b2a531e04976bdc390e8d43b92">REPO_PROP_IS_READONLY</a>, <span class="stringliteral">&quot;true&quot;</span>);
<a name="l00756"></a>00756 }
<a name="l00757"></a>00757 
<a name="l00758"></a>00758 <span class="keywordtype">void</span>
<a name="l00759"></a><a class="code" href="daemon_2repo-mgr_8c.html#af712f7a4551fbc0dfa780f3aada0a029">00759</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af712f7a4551fbc0dfa780f3aada0a029">seaf_repo_unset_readonly</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l00760"></a>00760 {
<a name="l00761"></a>00761     repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a> = FALSE;
<a name="l00762"></a>00762     save_repo_property (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a152076b2a531e04976bdc390e8d43b92">REPO_PROP_IS_READONLY</a>, <span class="stringliteral">&quot;false&quot;</span>);
<a name="l00763"></a>00763 }
<a name="l00764"></a>00764 
<a name="l00765"></a>00765 gboolean
<a name="l00766"></a><a class="code" href="daemon_2repo-mgr_8c.html#a1705de1c533ed3783c9e7ad4b34f4b96">00766</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a1705de1c533ed3783c9e7ad4b34f4b96">seaf_repo_manager_is_ignored_hidden_file</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *filename)
<a name="l00767"></a>00767 {
<a name="l00768"></a>00768     GPatternSpec **spec = ignore_patterns;
<a name="l00769"></a>00769 
<a name="l00770"></a>00770     <span class="keywordflow">while</span> (*spec) {
<a name="l00771"></a>00771         <span class="keywordflow">if</span> (g_pattern_match_string(*spec, filename))
<a name="l00772"></a>00772             <span class="keywordflow">return</span> TRUE;
<a name="l00773"></a>00773         spec++;
<a name="l00774"></a>00774     }
<a name="l00775"></a>00775 
<a name="l00776"></a>00776     <span class="keywordflow">return</span> FALSE;
<a name="l00777"></a>00777 }
<a name="l00778"></a>00778 
<a name="l00779"></a>00779 <span class="keyword">static</span> <span class="keyword">inline</span> gboolean
<a name="l00780"></a>00780 has_trailing_space_or_period (<span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l00781"></a>00781 {
<a name="l00782"></a>00782     <span class="keywordtype">int</span> len = strlen(path);
<a name="l00783"></a>00783     <span class="keywordflow">if</span> (path[len - 1] == <span class="charliteral">&#39; &#39;</span> || path[len - 1] == <span class="charliteral">&#39;.&#39;</span>) {
<a name="l00784"></a>00784         <span class="keywordflow">return</span> TRUE;
<a name="l00785"></a>00785     }
<a name="l00786"></a>00786 
<a name="l00787"></a>00787     <span class="keywordflow">return</span> FALSE;
<a name="l00788"></a>00788 }
<a name="l00789"></a>00789 
<a name="l00790"></a>00790 <span class="keyword">static</span> gboolean
<a name="l00791"></a>00791 should_ignore_on_checkout (<span class="keyword">const</span> <span class="keywordtype">char</span> *file_path)
<a name="l00792"></a>00792 {
<a name="l00793"></a>00793     gboolean ret = FALSE;
<a name="l00794"></a>00794 
<a name="l00795"></a>00795 <span class="preprocessor">#ifdef WIN32</span>
<a name="l00796"></a>00796 <span class="preprocessor"></span>    <span class="keyword">static</span> <span class="keywordtype">char</span> illegals[] = {<span class="charliteral">&#39;\\&#39;</span>, <span class="charliteral">&#39;:&#39;</span>, <span class="charliteral">&#39;*&#39;</span>, <span class="charliteral">&#39;?&#39;</span>, <span class="charliteral">&#39;&quot;&#39;</span>, <span class="charliteral">&#39;&lt;&#39;</span>, <span class="charliteral">&#39;&gt;&#39;</span>, <span class="charliteral">&#39;|&#39;</span>, <span class="charliteral">&#39;\b&#39;</span>, <span class="charliteral">&#39;\t&#39;</span>};
<a name="l00797"></a>00797     <span class="keywordtype">char</span> **components = g_strsplit (file_path, <span class="stringliteral">&quot;/&quot;</span>, -1);
<a name="l00798"></a>00798     <span class="keywordtype">int</span> n_comps = g_strv_length (components);
<a name="l00799"></a>00799     <span class="keywordtype">int</span> j = 0;
<a name="l00800"></a>00800     <span class="keywordtype">char</span> *file_name;
<a name="l00801"></a>00801     <span class="keywordtype">int</span> i;
<a name="l00802"></a>00802     <span class="keywordtype">char</span> c;
<a name="l00803"></a>00803 
<a name="l00804"></a>00804     <span class="keywordflow">for</span> (; j &lt; n_comps; ++j) {
<a name="l00805"></a>00805         file_name = components[j];
<a name="l00806"></a>00806 
<a name="l00807"></a>00807         <span class="keywordflow">if</span> (has_trailing_space_or_period (file_name)) {
<a name="l00808"></a>00808             <span class="comment">/* Ignore files/dir whose path has trailing spaces. It would cause</span>
<a name="l00809"></a>00809 <span class="comment">             * problem on windows. */</span>
<a name="l00810"></a>00810             <span class="comment">/* g_debug (&quot;ignore &#39;%s&#39; which contains trailing space in path\n&quot;, path); */</span>
<a name="l00811"></a>00811             ret = TRUE;
<a name="l00812"></a>00812             <span class="keywordflow">goto</span> out;
<a name="l00813"></a>00813         }
<a name="l00814"></a>00814 
<a name="l00815"></a>00815         <span class="keywordflow">for</span> (i = 0; i &lt; G_N_ELEMENTS(illegals); i++) {
<a name="l00816"></a>00816             <span class="keywordflow">if</span> (strchr (file_name, illegals[i])) {
<a name="l00817"></a>00817                 ret = TRUE;
<a name="l00818"></a>00818                 <span class="keywordflow">goto</span> out;
<a name="l00819"></a>00819             }
<a name="l00820"></a>00820         }
<a name="l00821"></a>00821 
<a name="l00822"></a>00822         <span class="keywordflow">for</span> (c = 1; c &lt;= 31; c++) {
<a name="l00823"></a>00823             <span class="keywordflow">if</span> (strchr (file_name, c)) {
<a name="l00824"></a>00824                 ret = TRUE;
<a name="l00825"></a>00825                 <span class="keywordflow">goto</span> out;
<a name="l00826"></a>00826             }
<a name="l00827"></a>00827         }
<a name="l00828"></a>00828     }
<a name="l00829"></a>00829 
<a name="l00830"></a>00830 out:
<a name="l00831"></a>00831     g_strfreev (components);
<a name="l00832"></a>00832 <span class="preprocessor">#endif</span>
<a name="l00833"></a>00833 <span class="preprocessor"></span>
<a name="l00834"></a>00834     <span class="keywordflow">return</span> ret;
<a name="l00835"></a>00835 }
<a name="l00836"></a>00836 
<a name="l00837"></a>00837 <span class="keyword">static</span> gboolean
<a name="l00838"></a>00838 should_ignore(<span class="keyword">const</span> <span class="keywordtype">char</span> *basepath, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keywordtype">void</span> *data)
<a name="l00839"></a>00839 {
<a name="l00840"></a>00840     GPatternSpec **spec = ignore_patterns;
<a name="l00841"></a>00841     GList *ignore_list = (GList *)data;
<a name="l00842"></a>00842 
<a name="l00843"></a>00843     <span class="keywordflow">if</span> (!g_utf8_validate (filename, -1, NULL)) {
<a name="l00844"></a>00844         seaf_warning (<span class="stringliteral">&quot;File name %s contains non-UTF8 characters, skip.\n&quot;</span>, filename);
<a name="l00845"></a>00845         <span class="keywordflow">return</span> TRUE;
<a name="l00846"></a>00846     }
<a name="l00847"></a>00847 
<a name="l00848"></a>00848     <span class="comment">/* Ignore file/dir if its name is too long. */</span>
<a name="l00849"></a>00849     <span class="keywordflow">if</span> (strlen(filename) &gt;= <a class="code" href="fs-mgr_8h.html#ae95c413b4d740d94ac0cc8becc46e61e">SEAF_DIR_NAME_LEN</a>)
<a name="l00850"></a>00850         <span class="keywordflow">return</span> TRUE;
<a name="l00851"></a>00851 
<a name="l00852"></a>00852     <span class="keywordflow">if</span> (strchr (filename, <span class="charliteral">&#39;/&#39;</span>))
<a name="l00853"></a>00853         <span class="keywordflow">return</span> TRUE;
<a name="l00854"></a>00854 
<a name="l00855"></a>00855     <span class="keywordflow">while</span> (*spec) {
<a name="l00856"></a>00856         <span class="keywordflow">if</span> (g_pattern_match_string(*spec, filename))
<a name="l00857"></a>00857             <span class="keywordflow">return</span> TRUE;
<a name="l00858"></a>00858         spec++;
<a name="l00859"></a>00859     }
<a name="l00860"></a>00860 
<a name="l00861"></a>00861     <span class="keywordflow">if</span> (!<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acf8951763f56c5d40051318ff12af60f">sync_extra_temp_file</a>) {
<a name="l00862"></a>00862         spec = office_temp_ignore_patterns;
<a name="l00863"></a>00863         <span class="keywordflow">while</span> (*spec) {
<a name="l00864"></a>00864             <span class="keywordflow">if</span> (g_pattern_match_string(*spec, filename))
<a name="l00865"></a>00865                 <span class="keywordflow">return</span> TRUE;
<a name="l00866"></a>00866             spec++;
<a name="l00867"></a>00867         }
<a name="l00868"></a>00868     }
<a name="l00869"></a>00869 
<a name="l00870"></a>00870     <span class="keywordflow">if</span> (basepath) {
<a name="l00871"></a>00871         <span class="keywordtype">char</span> *fullpath = g_build_path (<span class="stringliteral">&quot;/&quot;</span>, basepath, filename, NULL);
<a name="l00872"></a>00872         <span class="keywordflow">if</span> (<a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a32907bbaf9e2790699ddb7aaa97a3052">seaf_repo_check_ignore_file</a> (ignore_list, fullpath)) {
<a name="l00873"></a>00873             g_free (fullpath);
<a name="l00874"></a>00874             <span class="keywordflow">return</span> TRUE;
<a name="l00875"></a>00875         }
<a name="l00876"></a>00876         g_free (fullpath);
<a name="l00877"></a>00877     }
<a name="l00878"></a>00878 
<a name="l00879"></a>00879     <span class="keywordflow">return</span> FALSE;
<a name="l00880"></a>00880 }
<a name="l00881"></a>00881 
<a name="l00882"></a>00882 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00883"></a>00883 index_cb (<span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l00884"></a>00884           <span class="keywordtype">int</span> <a class="code" href="block-tx-utils_8h.html#a1abe2c64ac9f8bc05bbb1719cad360f3">version</a>,
<a name="l00885"></a>00885           <span class="keyword">const</span> <span class="keywordtype">char</span> *path,
<a name="l00886"></a>00886           <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="index_8h.html#a96e76167c968d38441e90ee0488ee4aa">sha1</a>[],
<a name="l00887"></a>00887           <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt,
<a name="l00888"></a>00888           gboolean write_data)
<a name="l00889"></a>00889 {
<a name="l00890"></a>00890     gint64 <a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a>;
<a name="l00891"></a>00891 
<a name="l00892"></a>00892     <span class="comment">/* Check in blocks and get object ID. */</span>
<a name="l00893"></a>00893     <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#af41e85bce809b9f05ed5b20ac5eeb745">seaf_fs_manager_index_blocks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>, repo_id, version,
<a name="l00894"></a>00894                                       path, sha1, &amp;size, crypt, write_data) &lt; 0) {
<a name="l00895"></a>00895         g_warning (<span class="stringliteral">&quot;Failed to index file %s.\n&quot;</span>, path);
<a name="l00896"></a>00896         <span class="keywordflow">return</span> -1;
<a name="l00897"></a>00897     }
<a name="l00898"></a>00898     <span class="keywordflow">return</span> 0;
<a name="l00899"></a>00899 }
<a name="l00900"></a>00900 
<a name="l00901"></a><a class="code" href="daemon_2repo-mgr_8c.html#a67a7df7fa60be3209b087d86faaab360">00901</a> <span class="preprocessor">#define MAX_COMMIT_SIZE 100 * (1 &lt;&lt; 20) </span><span class="comment">/* 100MB */</span>
<a name="l00902"></a>00902 
<a name="l00903"></a>00903 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__AddOptions.html">_AddOptions</a> {
<a name="l00904"></a>00904     <a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *<a class="code" href="struct__AddOptions.html#a97b5b11d9f2d4b00559bb1eec13ae35a">fset</a>;
<a name="l00905"></a>00905     GList *<a class="code" href="struct__AddOptions.html#ab09791ac93d1644f25367cf06d814981">user_perms</a>;
<a name="l00906"></a>00906     GList *<a class="code" href="struct__AddOptions.html#a195f8021f03f1db3606c02f6cf55311f">group_perms</a>;
<a name="l00907"></a>00907     gboolean <a class="code" href="struct__AddOptions.html#a5dbb2227dac4de70d96c8ee8727acf16">is_repo_ro</a>;
<a name="l00908"></a>00908 } <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a484d651f14e66ed05ff54bab5793a695">AddOptions</a>;
<a name="l00909"></a>00909 
<a name="l00910"></a>00910 <span class="preprocessor">#ifndef WIN32</span>
<a name="l00911"></a>00911 <span class="preprocessor"></span>
<a name="l00912"></a>00912 <span class="comment">/*</span>
<a name="l00913"></a>00913 <span class="comment"> * @remain_files: returns the files haven&#39;t been added under this path.</span>
<a name="l00914"></a>00914 <span class="comment"> *                If it&#39;s set to NULL, no partial commit will be created.</span>
<a name="l00915"></a>00915 <span class="comment"> */</span>
<a name="l00916"></a>00916 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00917"></a>00917 add_recursive (<span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l00918"></a>00918                <span class="keywordtype">int</span> version,
<a name="l00919"></a>00919                <span class="keyword">const</span> <span class="keywordtype">char</span> *modifier,
<a name="l00920"></a>00920                <span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate, 
<a name="l00921"></a>00921                <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree,
<a name="l00922"></a>00922                <span class="keyword">const</span> <span class="keywordtype">char</span> *path,
<a name="l00923"></a>00923                <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt,
<a name="l00924"></a>00924                gboolean ignore_empty_dir,
<a name="l00925"></a>00925                GList *ignore_list,
<a name="l00926"></a>00926                gint64 *total_size,
<a name="l00927"></a>00927                GQueue **remain_files,
<a name="l00928"></a>00928                <a class="code" href="struct__AddOptions.html">AddOptions</a> *<a class="code" href="structoptions.html">options</a>)
<a name="l00929"></a>00929 {
<a name="l00930"></a>00930     <span class="keywordtype">char</span> *full_path;
<a name="l00931"></a>00931     GDir *dir;
<a name="l00932"></a>00932     <span class="keyword">const</span> <span class="keywordtype">char</span> *dname;
<a name="l00933"></a>00933     <span class="keywordtype">char</span> *subpath;
<a name="l00934"></a>00934     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l00935"></a>00935     <span class="keywordtype">int</span> n;
<a name="l00936"></a>00936     <span class="keywordtype">int</span> ret = 0;
<a name="l00937"></a>00937 
<a name="l00938"></a>00938     full_path = g_build_path (<a class="code" href="vc-utils_8h.html#aa7da4cdc6796b13fca1a4b263488dfdd">PATH_SEPERATOR</a>, worktree, path, NULL);
<a name="l00939"></a>00939     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (full_path, &amp;st) &lt; 0) {
<a name="l00940"></a>00940         <span class="comment">/* Ignore broken symlinks on Linux and Mac OS X */</span>
<a name="l00941"></a>00941         <span class="keywordflow">if</span> (lstat (full_path, &amp;st) == 0 &amp;&amp; S_ISLNK(st.st_mode)) {
<a name="l00942"></a>00942             g_free (full_path);
<a name="l00943"></a>00943             <span class="keywordflow">return</span> 0;
<a name="l00944"></a>00944         }
<a name="l00945"></a>00945         g_warning (<span class="stringliteral">&quot;Failed to stat %s.\n&quot;</span>, full_path);
<a name="l00946"></a>00946         g_free (full_path);
<a name="l00947"></a>00947         <span class="keywordflow">return</span> -1;
<a name="l00948"></a>00948     }
<a name="l00949"></a>00949 
<a name="l00950"></a>00950     <span class="keywordflow">if</span> (S_ISREG(st.st_mode)) {
<a name="l00951"></a>00951         gboolean added = FALSE;
<a name="l00952"></a>00952 
<a name="l00953"></a>00953         <span class="keywordflow">if</span> (options &amp;&amp;
<a name="l00954"></a>00954             !is_path_writable (options-&gt;<a class="code" href="struct__AddOptions.html#ab09791ac93d1644f25367cf06d814981">user_perms</a>, options-&gt;<a class="code" href="struct__AddOptions.html#a195f8021f03f1db3606c02f6cf55311f">group_perms</a>,
<a name="l00955"></a>00955                                options-&gt;<a class="code" href="struct__AddOptions.html#a5dbb2227dac4de70d96c8ee8727acf16">is_repo_ro</a>, path)) {
<a name="l00956"></a>00956             g_free (full_path);
<a name="l00957"></a>00957             <span class="keywordflow">return</span> ret;
<a name="l00958"></a>00958         }
<a name="l00959"></a>00959 
<a name="l00960"></a>00960         <span class="keywordflow">if</span> (!remain_files) {
<a name="l00961"></a>00961             ret = <a class="code" href="index_8c.html#ac412654516da827612dd5db31703b32c">add_to_index</a> (repo_id, version, istate, path, full_path,
<a name="l00962"></a>00962                                 &amp;st, 0, crypt, index_cb, modifier, &amp;added);
<a name="l00963"></a>00963         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*remain_files == NULL) {
<a name="l00964"></a>00964             ret = <a class="code" href="index_8c.html#ac412654516da827612dd5db31703b32c">add_to_index</a> (repo_id, version, istate, path, full_path,
<a name="l00965"></a>00965                                 &amp;st, 0, crypt, index_cb, modifier, &amp;added);
<a name="l00966"></a>00966             <span class="keywordflow">if</span> (added) {
<a name="l00967"></a>00967                 *total_size += (gint64)(st.st_size);
<a name="l00968"></a>00968                 <span class="keywordflow">if</span> (*total_size &gt;= <a class="code" href="daemon_2repo-mgr_8c.html#a67a7df7fa60be3209b087d86faaab360">MAX_COMMIT_SIZE</a>)
<a name="l00969"></a>00969                     *remain_files = g_queue_new ();
<a name="l00970"></a>00970             }
<a name="l00971"></a>00971         } <span class="keywordflow">else</span>
<a name="l00972"></a>00972             g_queue_push_tail (*remain_files, g_strdup(path));
<a name="l00973"></a>00973 
<a name="l00974"></a>00974         g_free (full_path);
<a name="l00975"></a>00975         <span class="keywordflow">return</span> ret;
<a name="l00976"></a>00976     }
<a name="l00977"></a>00977 
<a name="l00978"></a>00978     <span class="keywordflow">if</span> (S_ISDIR(st.st_mode)) {
<a name="l00979"></a>00979         dir = g_dir_open (full_path, 0, NULL);
<a name="l00980"></a>00980         <span class="keywordflow">if</span> (!dir) {
<a name="l00981"></a>00981             g_warning (<span class="stringliteral">&quot;Failed to open dir %s: %s.\n&quot;</span>, full_path, strerror(errno));
<a name="l00982"></a>00982             <span class="keywordflow">goto</span> bad;
<a name="l00983"></a>00983         }
<a name="l00984"></a>00984 
<a name="l00985"></a>00985         n = 0;
<a name="l00986"></a>00986         <span class="keywordflow">while</span> ((dname = g_dir_read_name(dir)) != NULL) {
<a name="l00987"></a>00987             <span class="keywordflow">if</span> (should_ignore(full_path, dname, ignore_list))
<a name="l00988"></a>00988                 <span class="keywordflow">continue</span>;
<a name="l00989"></a>00989 
<a name="l00990"></a>00990             ++n;
<a name="l00991"></a>00991 
<a name="l00992"></a>00992 <span class="preprocessor">#ifdef __APPLE__</span>
<a name="l00993"></a>00993 <span class="preprocessor"></span>            <span class="keywordtype">char</span> *norm_dname = g_utf8_normalize (dname, -1, G_NORMALIZE_NFC);
<a name="l00994"></a>00994             subpath = g_build_path (<a class="code" href="vc-utils_8h.html#aa7da4cdc6796b13fca1a4b263488dfdd">PATH_SEPERATOR</a>, path, norm_dname, NULL);
<a name="l00995"></a>00995             g_free (norm_dname);
<a name="l00996"></a>00996 <span class="preprocessor">#else</span>
<a name="l00997"></a>00997 <span class="preprocessor"></span>            subpath = g_build_path (<a class="code" href="vc-utils_8h.html#aa7da4cdc6796b13fca1a4b263488dfdd">PATH_SEPERATOR</a>, path, dname, NULL);
<a name="l00998"></a>00998 <span class="preprocessor">#endif</span>
<a name="l00999"></a>00999 <span class="preprocessor"></span>
<a name="l01000"></a>01000             ret = add_recursive (repo_id, version, modifier,
<a name="l01001"></a>01001                                  istate, worktree, subpath,
<a name="l01002"></a>01002                                  crypt, ignore_empty_dir, ignore_list,
<a name="l01003"></a>01003                                  total_size, remain_files, options);
<a name="l01004"></a>01004             g_free (subpath);
<a name="l01005"></a>01005             <span class="keywordflow">if</span> (ret &lt; 0)
<a name="l01006"></a>01006                 <span class="keywordflow">break</span>;
<a name="l01007"></a>01007         }
<a name="l01008"></a>01008         g_dir_close (dir);
<a name="l01009"></a>01009         <span class="keywordflow">if</span> (ret &lt; 0)
<a name="l01010"></a>01010             <span class="keywordflow">goto</span> bad;
<a name="l01011"></a>01011 
<a name="l01012"></a>01012         <span class="keywordflow">if</span> (n == 0 &amp;&amp; path[0] != 0 &amp;&amp; !ignore_empty_dir &amp;&amp;
<a name="l01013"></a>01013             (!options ||
<a name="l01014"></a>01014              is_path_writable(options-&gt;<a class="code" href="struct__AddOptions.html#ab09791ac93d1644f25367cf06d814981">user_perms</a>, options-&gt;<a class="code" href="struct__AddOptions.html#a195f8021f03f1db3606c02f6cf55311f">group_perms</a>,
<a name="l01015"></a>01015                               options-&gt;<a class="code" href="struct__AddOptions.html#a5dbb2227dac4de70d96c8ee8727acf16">is_repo_ro</a>, path)))
<a name="l01016"></a>01016         {
<a name="l01017"></a>01017             <span class="keywordflow">if</span> (!remain_files || *remain_files == NULL)
<a name="l01018"></a>01018                 <a class="code" href="index_8c.html#a0a287241a624545389a63a0b22a98513">add_empty_dir_to_index</a> (istate, path, &amp;st);
<a name="l01019"></a>01019             <span class="keywordflow">else</span>
<a name="l01020"></a>01020                 g_queue_push_tail (*remain_files, g_strdup(path));
<a name="l01021"></a>01021         }
<a name="l01022"></a>01022     }
<a name="l01023"></a>01023 
<a name="l01024"></a>01024     g_free (full_path);
<a name="l01025"></a>01025     <span class="keywordflow">return</span> 0;
<a name="l01026"></a>01026 
<a name="l01027"></a>01027 bad:
<a name="l01028"></a>01028     g_free (full_path);
<a name="l01029"></a>01029     <span class="keywordflow">return</span> -1;
<a name="l01030"></a>01030 }
<a name="l01031"></a>01031 
<a name="l01032"></a>01032 <span class="keyword">static</span> gboolean
<a name="l01033"></a>01033 is_empty_dir (<span class="keyword">const</span> <span class="keywordtype">char</span> *path, GList *ignore_list)
<a name="l01034"></a>01034 {
<a name="l01035"></a>01035     GDir *dir;
<a name="l01036"></a>01036     <span class="keyword">const</span> <span class="keywordtype">char</span> *dname;
<a name="l01037"></a>01037     gboolean ret = TRUE;
<a name="l01038"></a>01038 
<a name="l01039"></a>01039     dir = g_dir_open (path, 0, NULL);
<a name="l01040"></a>01040     <span class="keywordflow">if</span> (!dir) {
<a name="l01041"></a>01041         <span class="keywordflow">return</span> FALSE;
<a name="l01042"></a>01042     }
<a name="l01043"></a>01043 
<a name="l01044"></a>01044     <span class="keywordflow">while</span> ((dname = g_dir_read_name(dir)) != NULL) {
<a name="l01045"></a>01045         <span class="keywordflow">if</span> (!should_ignore(path, dname, ignore_list)) {
<a name="l01046"></a>01046             ret = FALSE;
<a name="l01047"></a>01047             <span class="keywordflow">break</span>;
<a name="l01048"></a>01048         }
<a name="l01049"></a>01049     }
<a name="l01050"></a>01050     g_dir_close (dir);
<a name="l01051"></a>01051 
<a name="l01052"></a>01052     <span class="keywordflow">return</span> ret;
<a name="l01053"></a>01053 }
<a name="l01054"></a>01054 
<a name="l01055"></a>01055 <span class="preprocessor">#else</span>
<a name="l01056"></a>01056 <span class="preprocessor"></span>
<a name="l01057"></a>01057 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01058"></a>01058 add_file (<span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l01059"></a>01059           <span class="keywordtype">int</span> version,
<a name="l01060"></a>01060           <span class="keyword">const</span> <span class="keywordtype">char</span> *modifier,
<a name="l01061"></a>01061           <span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate, 
<a name="l01062"></a>01062           <span class="keyword">const</span> <span class="keywordtype">char</span> *path,
<a name="l01063"></a>01063           <span class="keyword">const</span> <span class="keywordtype">char</span> *full_path,
<a name="l01064"></a>01064           <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> *st,
<a name="l01065"></a>01065           <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt,
<a name="l01066"></a>01066           gint64 *total_size,
<a name="l01067"></a>01067           GQueue **remain_files,
<a name="l01068"></a>01068           <a class="code" href="struct__AddOptions.html">AddOptions</a> *options)
<a name="l01069"></a>01069 {
<a name="l01070"></a>01070     gboolean added = FALSE;
<a name="l01071"></a>01071     <span class="keywordtype">int</span> ret = 0;
<a name="l01072"></a>01072 
<a name="l01073"></a>01073     <span class="keywordflow">if</span> (options &amp;&amp;
<a name="l01074"></a>01074         !is_path_writable (options-&gt;<a class="code" href="struct__AddOptions.html#ab09791ac93d1644f25367cf06d814981">user_perms</a>, options-&gt;<a class="code" href="struct__AddOptions.html#a195f8021f03f1db3606c02f6cf55311f">group_perms</a>,
<a name="l01075"></a>01075                            options-&gt;<a class="code" href="struct__AddOptions.html#a5dbb2227dac4de70d96c8ee8727acf16">is_repo_ro</a>, path)) {
<a name="l01076"></a>01076         <span class="keywordflow">return</span> ret;
<a name="l01077"></a>01077     }
<a name="l01078"></a>01078 
<a name="l01079"></a>01079     <span class="keywordflow">if</span> (options &amp;&amp; options-&gt;<a class="code" href="struct__AddOptions.html#a97b5b11d9f2d4b00559bb1eec13ae35a">fset</a>) {
<a name="l01080"></a>01080         <a class="code" href="struct__LockedFile.html">LockedFile</a> *file = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a818fec9b8684b386170e39cfe5feff55">locked_file_set_lookup</a> (options-&gt;<a class="code" href="struct__AddOptions.html#a97b5b11d9f2d4b00559bb1eec13ae35a">fset</a>, path);
<a name="l01081"></a>01081         <span class="keywordflow">if</span> (file) {
<a name="l01082"></a>01082             <span class="keywordflow">if</span> (strcmp (file-&gt;<a class="code" href="struct__LockedFile.html#abdcab3c93928ff7a61146d497d5e4ec7">operation</a>, <a class="code" href="daemon_2repo-mgr_8h.html#ae9d9b81961c1ed4497f7f808c6be96ed">LOCKED_OP_DELETE</a>) == 0) {
<a name="l01083"></a>01083                 <span class="comment">/* Only remove the lock record if the file is changed. */</span>
<a name="l01084"></a>01084                 <span class="keywordflow">if</span> (st-&gt;st_mtime == file-&gt;<a class="code" href="struct__LockedFile.html#a1e6ec2e3b09c05236c6898df5dc77475">old_mtime</a>) {
<a name="l01085"></a>01085                     <span class="keywordflow">return</span> ret;
<a name="l01086"></a>01086                 }
<a name="l01087"></a>01087                 <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a4d1dacc802b818970800154a9bc6e3db">locked_file_set_remove</a> (options-&gt;<a class="code" href="struct__AddOptions.html#a97b5b11d9f2d4b00559bb1eec13ae35a">fset</a>, path, FALSE);
<a name="l01088"></a>01088             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp (file-&gt;<a class="code" href="struct__LockedFile.html#abdcab3c93928ff7a61146d497d5e4ec7">operation</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a73695736a3b6d6bc38b8a7e439dba0b4">LOCKED_OP_UPDATE</a>) == 0) {
<a name="l01089"></a>01089                 <span class="keywordflow">return</span> ret;
<a name="l01090"></a>01090             }
<a name="l01091"></a>01091         }
<a name="l01092"></a>01092     }
<a name="l01093"></a>01093 
<a name="l01094"></a>01094     <span class="keywordflow">if</span> (!remain_files) {
<a name="l01095"></a>01095         ret = <a class="code" href="index_8c.html#ac412654516da827612dd5db31703b32c">add_to_index</a> (repo_id, version, istate, path, full_path,
<a name="l01096"></a>01096                             st, 0, crypt, index_cb, modifier, &amp;added);
<a name="l01097"></a>01097     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*remain_files == NULL) {
<a name="l01098"></a>01098         ret = <a class="code" href="index_8c.html#ac412654516da827612dd5db31703b32c">add_to_index</a> (repo_id, version, istate, path, full_path,
<a name="l01099"></a>01099                             st, 0, crypt, index_cb, modifier, &amp;added);
<a name="l01100"></a>01100         <span class="keywordflow">if</span> (added) {
<a name="l01101"></a>01101             *total_size += (gint64)(st-&gt;st_size);
<a name="l01102"></a>01102             <span class="keywordflow">if</span> (*total_size &gt;= <a class="code" href="daemon_2repo-mgr_8c.html#a67a7df7fa60be3209b087d86faaab360">MAX_COMMIT_SIZE</a>)
<a name="l01103"></a>01103                 *remain_files = g_queue_new ();
<a name="l01104"></a>01104         }
<a name="l01105"></a>01105     } <span class="keywordflow">else</span>
<a name="l01106"></a>01106         g_queue_push_tail (*remain_files, g_strdup(path));
<a name="l01107"></a>01107 
<a name="l01108"></a>01108     <span class="keywordflow">return</span> ret;
<a name="l01109"></a>01109 }
<a name="l01110"></a>01110 
<a name="l01111"></a>01111 <span class="keyword">typedef</span> <span class="keyword">struct </span>AddParams {
<a name="l01112"></a>01112     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id;
<a name="l01113"></a>01113     <span class="keywordtype">int</span> <a class="code" href="block-tx-utils_8h.html#a1abe2c64ac9f8bc05bbb1719cad360f3">version</a>;
<a name="l01114"></a>01114     <span class="keyword">const</span> <span class="keywordtype">char</span> *modifier;
<a name="l01115"></a>01115     <span class="keyword">struct </span><a class="code" href="structindex__state.html">index_state</a> *istate;
<a name="l01116"></a>01116     <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree;
<a name="l01117"></a>01117     <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt;
<a name="l01118"></a>01118     gboolean ignore_empty_dir;
<a name="l01119"></a>01119     GList *ignore_list;
<a name="l01120"></a>01120     gint64 *total_size;
<a name="l01121"></a>01121     GQueue **remain_files;
<a name="l01122"></a>01122     <a class="code" href="struct__AddOptions.html">AddOptions</a> *<a class="code" href="seaf-fuse_8c.html#a75a4394524b5a85ecc4c8998e0ef680f">options</a>;
<a name="l01123"></a>01123 } AddParams;
<a name="l01124"></a>01124 
<a name="l01125"></a>01125 <span class="keyword">typedef</span> <span class="keyword">struct </span>IterCBData {
<a name="l01126"></a>01126     AddParams *add_params;
<a name="l01127"></a>01127     <span class="keyword">const</span> <span class="keywordtype">char</span> *parent;
<a name="l01128"></a>01128     <span class="keyword">const</span> <span class="keywordtype">char</span> *full_parent;
<a name="l01129"></a>01129     <span class="keywordtype">int</span> n;
<a name="l01130"></a>01130 } IterCBData;
<a name="l01131"></a>01131 
<a name="l01132"></a>01132 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01133"></a>01133 add_dir_recursive (<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keyword">const</span> <span class="keywordtype">char</span> *full_path, <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> *st,
<a name="l01134"></a>01134                    AddParams *params);
<a name="l01135"></a>01135 
<a name="l01136"></a>01136 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01137"></a>01137 iter_dir_cb (<span class="keywordtype">wchar_t</span> *full_parent_w,
<a name="l01138"></a>01138              WIN32_FIND_DATAW *fdata,
<a name="l01139"></a>01139              <span class="keywordtype">void</span> *user_data,
<a name="l01140"></a>01140              gboolean *stop)
<a name="l01141"></a>01141 {
<a name="l01142"></a>01142     IterCBData *data = user_data;
<a name="l01143"></a>01143     AddParams *params = data-&gt;add_params;
<a name="l01144"></a>01144     <span class="keywordtype">char</span> *dname = NULL, *path = NULL, *full_path = NULL;
<a name="l01145"></a>01145     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l01146"></a>01146     <span class="keywordtype">int</span> ret = 0;
<a name="l01147"></a>01147 
<a name="l01148"></a>01148     dname = g_utf16_to_utf8 (fdata-&gt;cFileName, -1, NULL, NULL, NULL);
<a name="l01149"></a>01149 
<a name="l01150"></a>01150     <span class="keywordflow">if</span> (should_ignore(data-&gt;full_parent, dname, params-&gt;ignore_list))
<a name="l01151"></a>01151         <span class="keywordflow">goto</span> out;
<a name="l01152"></a>01152 
<a name="l01153"></a>01153     path = g_build_path (<span class="stringliteral">&quot;/&quot;</span>, data-&gt;parent, dname, NULL);
<a name="l01154"></a>01154     full_path = g_build_path (<span class="stringliteral">&quot;/&quot;</span>, params-&gt;worktree, path, NULL);
<a name="l01155"></a>01155 
<a name="l01156"></a>01156     seaf_stat_from_find_data (fdata, &amp;st);
<a name="l01157"></a>01157 
<a name="l01158"></a>01158     <span class="keywordflow">if</span> (fdata-&gt;dwFileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY)
<a name="l01159"></a>01159         ret = add_dir_recursive (path, full_path, &amp;st, params);
<a name="l01160"></a>01160     <span class="keywordflow">else</span>
<a name="l01161"></a>01161         ret = add_file (params-&gt;repo_id,
<a name="l01162"></a>01162                         params-&gt;version,
<a name="l01163"></a>01163                         params-&gt;modifier,
<a name="l01164"></a>01164                         params-&gt;istate,
<a name="l01165"></a>01165                         path,
<a name="l01166"></a>01166                         full_path,
<a name="l01167"></a>01167                         &amp;st,
<a name="l01168"></a>01168                         params-&gt;crypt,
<a name="l01169"></a>01169                         params-&gt;total_size,
<a name="l01170"></a>01170                         params-&gt;remain_files,
<a name="l01171"></a>01171                         params-&gt;options);
<a name="l01172"></a>01172 
<a name="l01173"></a>01173     ++(data-&gt;n);
<a name="l01174"></a>01174 
<a name="l01175"></a>01175 out:
<a name="l01176"></a>01176     g_free (dname);
<a name="l01177"></a>01177     g_free (path);
<a name="l01178"></a>01178     g_free (full_path);
<a name="l01179"></a>01179 
<a name="l01180"></a>01180     <span class="keywordflow">return</span> ret;
<a name="l01181"></a>01181 }
<a name="l01182"></a>01182 
<a name="l01183"></a>01183 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01184"></a>01184 add_dir_recursive (<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keyword">const</span> <span class="keywordtype">char</span> *full_path, <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> *st,
<a name="l01185"></a>01185                    AddParams *params)
<a name="l01186"></a>01186 {
<a name="l01187"></a>01187     <a class="code" href="struct__AddOptions.html">AddOptions</a> *options = params-&gt;options;
<a name="l01188"></a>01188     IterCBData data;
<a name="l01189"></a>01189     <span class="keywordtype">wchar_t</span> *full_path_w;
<a name="l01190"></a>01190     <span class="keywordtype">int</span> ret = 0;
<a name="l01191"></a>01191 
<a name="l01192"></a>01192     memset (&amp;data, 0, <span class="keyword">sizeof</span>(data));
<a name="l01193"></a>01193     data.add_params = params;
<a name="l01194"></a>01194     data.parent = path;
<a name="l01195"></a>01195     data.full_parent = full_path;
<a name="l01196"></a>01196 
<a name="l01197"></a>01197     full_path_w = win32_long_path (full_path);
<a name="l01198"></a>01198     ret = traverse_directory_win32 (full_path_w, iter_dir_cb, &amp;data);
<a name="l01199"></a>01199     g_free (full_path_w);
<a name="l01200"></a>01200 
<a name="l01201"></a>01201     <span class="keywordflow">if</span> (ret &lt; 0)
<a name="l01202"></a>01202         <span class="keywordflow">return</span> ret;
<a name="l01203"></a>01203 
<a name="l01204"></a>01204     <span class="keywordflow">if</span> (data.n == 0 &amp;&amp; path[0] != 0 &amp;&amp; !params-&gt;ignore_empty_dir &amp;&amp;
<a name="l01205"></a>01205         (!options ||
<a name="l01206"></a>01206          is_path_writable(options-&gt;<a class="code" href="struct__AddOptions.html#ab09791ac93d1644f25367cf06d814981">user_perms</a>, options-&gt;<a class="code" href="struct__AddOptions.html#a195f8021f03f1db3606c02f6cf55311f">group_perms</a>,
<a name="l01207"></a>01207                           options-&gt;<a class="code" href="struct__AddOptions.html#a5dbb2227dac4de70d96c8ee8727acf16">is_repo_ro</a>, path))) {
<a name="l01208"></a>01208         <span class="keywordflow">if</span> (!params-&gt;remain_files || *(params-&gt;remain_files) == NULL)
<a name="l01209"></a>01209             <a class="code" href="index_8c.html#a0a287241a624545389a63a0b22a98513">add_empty_dir_to_index</a> (params-&gt;istate, path, st);
<a name="l01210"></a>01210         <span class="keywordflow">else</span>
<a name="l01211"></a>01211             g_queue_push_tail (*(params-&gt;remain_files), g_strdup(path));
<a name="l01212"></a>01212     }
<a name="l01213"></a>01213 
<a name="l01214"></a>01214     <span class="keywordflow">return</span> ret;
<a name="l01215"></a>01215 }
<a name="l01216"></a>01216 
<a name="l01217"></a>01217 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01218"></a>01218 add_recursive (<span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l01219"></a>01219                <span class="keywordtype">int</span> version,
<a name="l01220"></a>01220                <span class="keyword">const</span> <span class="keywordtype">char</span> *modifier,
<a name="l01221"></a>01221                <span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate, 
<a name="l01222"></a>01222                <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree,
<a name="l01223"></a>01223                <span class="keyword">const</span> <span class="keywordtype">char</span> *path,
<a name="l01224"></a>01224                <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt,
<a name="l01225"></a>01225                gboolean ignore_empty_dir,
<a name="l01226"></a>01226                GList *ignore_list,
<a name="l01227"></a>01227                gint64 *total_size,
<a name="l01228"></a>01228                GQueue **remain_files,
<a name="l01229"></a>01229                <a class="code" href="struct__AddOptions.html">AddOptions</a> *options)
<a name="l01230"></a>01230 {
<a name="l01231"></a>01231     <span class="keywordtype">char</span> *full_path;
<a name="l01232"></a>01232     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l01233"></a>01233     <span class="keywordtype">int</span> ret = 0;
<a name="l01234"></a>01234 
<a name="l01235"></a>01235     full_path = g_build_path (<a class="code" href="vc-utils_8h.html#aa7da4cdc6796b13fca1a4b263488dfdd">PATH_SEPERATOR</a>, worktree, path, NULL);
<a name="l01236"></a>01236     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (full_path, &amp;st) &lt; 0) {
<a name="l01237"></a>01237         g_warning (<span class="stringliteral">&quot;Failed to stat %s.\n&quot;</span>, full_path);
<a name="l01238"></a>01238         g_free (full_path);
<a name="l01239"></a>01239         <span class="keywordflow">return</span> -1;
<a name="l01240"></a>01240     }
<a name="l01241"></a>01241 
<a name="l01242"></a>01242     <span class="keywordflow">if</span> (S_ISREG(st.st_mode)) {
<a name="l01243"></a>01243         ret = add_file (repo_id,
<a name="l01244"></a>01244                         version,
<a name="l01245"></a>01245                         modifier,
<a name="l01246"></a>01246                         istate, 
<a name="l01247"></a>01247                         path,
<a name="l01248"></a>01248                         full_path,
<a name="l01249"></a>01249                         &amp;st,
<a name="l01250"></a>01250                         crypt,
<a name="l01251"></a>01251                         total_size,
<a name="l01252"></a>01252                         remain_files,
<a name="l01253"></a>01253                         options);
<a name="l01254"></a>01254     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S_ISDIR(st.st_mode)) {
<a name="l01255"></a>01255         AddParams params = {
<a name="l01256"></a>01256             .repo_id = repo_id,
<a name="l01257"></a>01257             .version = <a class="code" href="block-tx-utils_8h.html#a1abe2c64ac9f8bc05bbb1719cad360f3">version</a>,
<a name="l01258"></a>01258             .modifier = modifier,
<a name="l01259"></a>01259             .istate = istate,
<a name="l01260"></a>01260             .worktree = worktree,
<a name="l01261"></a>01261             .crypt = crypt,
<a name="l01262"></a>01262             .ignore_empty_dir = ignore_empty_dir,
<a name="l01263"></a>01263             .ignore_list = ignore_list,
<a name="l01264"></a>01264             .total_size = total_size,
<a name="l01265"></a>01265             .remain_files = remain_files,
<a name="l01266"></a>01266             .options = <a class="code" href="seaf-fuse_8c.html#a75a4394524b5a85ecc4c8998e0ef680f">options</a>,
<a name="l01267"></a>01267         };
<a name="l01268"></a>01268 
<a name="l01269"></a>01269         ret = add_dir_recursive (path, full_path, &amp;st, &amp;params);
<a name="l01270"></a>01270     }
<a name="l01271"></a>01271 
<a name="l01272"></a>01272     g_free (full_path);
<a name="l01273"></a>01273     <span class="keywordflow">return</span> ret;
<a name="l01274"></a>01274 }
<a name="l01275"></a>01275 
<a name="l01276"></a>01276 <span class="keyword">static</span> gboolean
<a name="l01277"></a>01277 is_empty_dir (<span class="keyword">const</span> <span class="keywordtype">char</span> *path, GList *ignore_list)
<a name="l01278"></a>01278 {
<a name="l01279"></a>01279     WIN32_FIND_DATAW fdata;
<a name="l01280"></a>01280     HANDLE handle;
<a name="l01281"></a>01281     <span class="keywordtype">wchar_t</span> *pattern;
<a name="l01282"></a>01282     <span class="keywordtype">wchar_t</span> *path_w;
<a name="l01283"></a>01283     <span class="keywordtype">char</span> *dname;
<a name="l01284"></a>01284     <span class="keywordtype">int</span> path_len_w;
<a name="l01285"></a>01285     DWORD error;
<a name="l01286"></a>01286     gboolean ret = TRUE;
<a name="l01287"></a>01287 
<a name="l01288"></a>01288     path_w = win32_long_path (path);
<a name="l01289"></a>01289 
<a name="l01290"></a>01290     path_len_w = wcslen(path_w);
<a name="l01291"></a>01291 
<a name="l01292"></a>01292     pattern = g_new0 (<span class="keywordtype">wchar_t</span>, (path_len_w + 3));
<a name="l01293"></a>01293     wcscpy (pattern, path_w);
<a name="l01294"></a>01294     wcscat (pattern, L<span class="stringliteral">&quot;\\*&quot;</span>);
<a name="l01295"></a>01295 
<a name="l01296"></a>01296     handle = FindFirstFileW (pattern, &amp;fdata);
<a name="l01297"></a>01297     <span class="keywordflow">if</span> (handle == INVALID_HANDLE_VALUE) {
<a name="l01298"></a>01298         seaf_warning (<span class="stringliteral">&quot;FindFirstFile failed %s: %lu.\n&quot;</span>,
<a name="l01299"></a>01299                       path, GetLastError());
<a name="l01300"></a>01300         ret = FALSE;
<a name="l01301"></a>01301         <span class="keywordflow">goto</span> out;
<a name="l01302"></a>01302     }
<a name="l01303"></a>01303 
<a name="l01304"></a>01304     <span class="keywordflow">do</span> {
<a name="l01305"></a>01305         <span class="keywordflow">if</span> (wcscmp (fdata.cFileName, L<span class="stringliteral">&quot;.&quot;</span>) == 0 ||
<a name="l01306"></a>01306             wcscmp (fdata.cFileName, L<span class="stringliteral">&quot;..&quot;</span>) == 0)
<a name="l01307"></a>01307             <span class="keywordflow">continue</span>;
<a name="l01308"></a>01308 
<a name="l01309"></a>01309         dname = g_utf16_to_utf8 (fdata.cFileName, -1, NULL, NULL, NULL);
<a name="l01310"></a>01310         <span class="keywordflow">if</span> (!should_ignore (path, dname, ignore_list)) {
<a name="l01311"></a>01311             ret = FALSE;
<a name="l01312"></a>01312             g_free (dname);
<a name="l01313"></a>01313             FindClose (handle);
<a name="l01314"></a>01314             <span class="keywordflow">goto</span> out;
<a name="l01315"></a>01315         }
<a name="l01316"></a>01316         g_free (dname);
<a name="l01317"></a>01317     } <span class="keywordflow">while</span> (FindNextFileW (handle, &amp;fdata) != 0);
<a name="l01318"></a>01318 
<a name="l01319"></a>01319     error = GetLastError();
<a name="l01320"></a>01320     <span class="keywordflow">if</span> (error != ERROR_NO_MORE_FILES) {
<a name="l01321"></a>01321         seaf_warning (<span class="stringliteral">&quot;FindNextFile failed %s: %lu.\n&quot;</span>,
<a name="l01322"></a>01322                       path, error);
<a name="l01323"></a>01323     }
<a name="l01324"></a>01324 
<a name="l01325"></a>01325     FindClose (handle);
<a name="l01326"></a>01326 
<a name="l01327"></a>01327 out:
<a name="l01328"></a>01328     g_free (path_w);
<a name="l01329"></a>01329     g_free (pattern);
<a name="l01330"></a>01330     <span class="keywordflow">return</span> ret;
<a name="l01331"></a>01331 }
<a name="l01332"></a>01332 
<a name="l01333"></a>01333 <span class="preprocessor">#endif  </span><span class="comment">/* WIN32 */</span>
<a name="l01334"></a>01334 
<a name="l01335"></a>01335 <span class="comment">/* Returns whether the file should be removed from index. */</span>
<a name="l01336"></a>01336 <span class="keyword">static</span> gboolean
<a name="l01337"></a>01337 check_locked_file_before_remove (<a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset, <span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l01338"></a>01338 {
<a name="l01339"></a>01339 <span class="preprocessor">#ifdef WIN32</span>
<a name="l01340"></a>01340 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!fset)
<a name="l01341"></a>01341         <span class="keywordflow">return</span> TRUE;
<a name="l01342"></a>01342 
<a name="l01343"></a>01343     <a class="code" href="struct__LockedFile.html">LockedFile</a> *file = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a818fec9b8684b386170e39cfe5feff55">locked_file_set_lookup</a> (fset, path);
<a name="l01344"></a>01344     gboolean ret = TRUE;
<a name="l01345"></a>01345 
<a name="l01346"></a>01346     <span class="keywordflow">if</span> (file)
<a name="l01347"></a>01347         ret = FALSE;
<a name="l01348"></a>01348 
<a name="l01349"></a>01349     <span class="keywordflow">return</span> ret;
<a name="l01350"></a>01350 <span class="preprocessor">#else</span>
<a name="l01351"></a>01351 <span class="preprocessor"></span>    <span class="keywordflow">return</span> TRUE;
<a name="l01352"></a>01352 <span class="preprocessor">#endif</span>
<a name="l01353"></a>01353 <span class="preprocessor"></span>}
<a name="l01354"></a>01354 
<a name="l01355"></a>01355 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01356"></a>01356 remove_deleted (<span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate, <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree, <span class="keyword">const</span> <span class="keywordtype">char</span> *prefix,
<a name="l01357"></a>01357                 GList *ignore_list, <a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset,
<a name="l01358"></a>01358                 GList *user_perms, GList *group_perms, gboolean is_repo_ro)
<a name="l01359"></a>01359 {
<a name="l01360"></a>01360     <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> **ce_array = istate-&gt;<a class="code" href="structindex__state.html#a8aa7a8aa984ec5a39ff2eee96412db07">cache</a>;
<a name="l01361"></a>01361     <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *ce;
<a name="l01362"></a>01362     <span class="keywordtype">char</span> path[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
<a name="l01363"></a>01363     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
<a name="l01364"></a>01364     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l01365"></a>01365     <span class="keywordtype">int</span> ret;
<a name="l01366"></a>01366 
<a name="l01367"></a>01367     <span class="keywordtype">char</span> *full_prefix = g_strconcat (prefix, <span class="stringliteral">&quot;/&quot;</span>, NULL);
<a name="l01368"></a>01368     <span class="keywordtype">int</span> len = strlen(full_prefix);
<a name="l01369"></a>01369 
<a name="l01370"></a>01370     <span class="keywordflow">for</span> (i = 0; i &lt; istate-&gt;<a class="code" href="structindex__state.html#a15b38cdd30ad2374bc12da429f39312f">cache_nr</a>; ++i) {
<a name="l01371"></a>01371         ce = ce_array[i];
<a name="l01372"></a>01372 
<a name="l01373"></a>01373         <span class="keywordflow">if</span> (!is_path_writable (user_perms, group_perms, is_repo_ro, ce-&gt;<a class="code" href="structcache__entry.html#a792e4ea24cb16c76abe3229651e414a0">name</a>))
<a name="l01374"></a>01374             <span class="keywordflow">continue</span>;
<a name="l01375"></a>01375 
<a name="l01376"></a>01376         <span class="keywordflow">if</span> (prefix[0] != 0 &amp;&amp; strcmp (ce-&gt;<a class="code" href="structcache__entry.html#a792e4ea24cb16c76abe3229651e414a0">name</a>, prefix) != 0 &amp;&amp;
<a name="l01377"></a>01377             strncmp (ce-&gt;<a class="code" href="structcache__entry.html#a792e4ea24cb16c76abe3229651e414a0">name</a>, full_prefix, len) != 0)
<a name="l01378"></a>01378             <span class="keywordflow">continue</span>;
<a name="l01379"></a>01379 
<a name="l01380"></a>01380         snprintf (path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, worktree, ce-&gt;<a class="code" href="structcache__entry.html#a792e4ea24cb16c76abe3229651e414a0">name</a>);
<a name="l01381"></a>01381         ret = <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (path, &amp;st);
<a name="l01382"></a>01382 
<a name="l01383"></a>01383         <span class="keywordflow">if</span> (S_ISDIR (ce-&gt;<a class="code" href="structcache__entry.html#a5fcbcc4e7265ae8150f136380ed92c05">ce_mode</a>)) {
<a name="l01384"></a>01384             <span class="keywordflow">if</span> ((ret &lt; 0 || !S_ISDIR (st.st_mode)
<a name="l01385"></a>01385                  || !is_empty_dir (path, ignore_list)) &amp;&amp;
<a name="l01386"></a>01386                 (ce-&gt;<a class="code" href="structcache__entry.html#a5258a9a9e2fc3bfcd4859049912b65e8">ce_ctime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a> != 0 || <a class="code" href="index_8h.html#a0379c411a3dc56c2d5ac0b1fcce22ead">ce_stage</a>(ce) != 0))
<a name="l01387"></a>01387                 ce-&gt;<a class="code" href="structcache__entry.html#a4dab14fd813a1bb6b67352674ff4afb2">ce_flags</a> |= <a class="code" href="index_8h.html#aa5ee599d9d7af67f19dba204ce9030c0">CE_REMOVE</a>;
<a name="l01388"></a>01388         } <span class="keywordflow">else</span> {
<a name="l01389"></a>01389             <span class="comment">/* If ce-&gt;ctime is 0 and stage is 0, it was not successfully checked out.</span>
<a name="l01390"></a>01390 <span class="comment">             * In this case we don&#39;t want to mistakenly remove the file</span>
<a name="l01391"></a>01391 <span class="comment">             * from the repo.</span>
<a name="l01392"></a>01392 <span class="comment">             */</span>
<a name="l01393"></a>01393             <span class="keywordflow">if</span> ((ret &lt; 0 || !S_ISREG (st.st_mode)) &amp;&amp;
<a name="l01394"></a>01394                 (ce-&gt;<a class="code" href="structcache__entry.html#a5258a9a9e2fc3bfcd4859049912b65e8">ce_ctime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a> != 0 || <a class="code" href="index_8h.html#a0379c411a3dc56c2d5ac0b1fcce22ead">ce_stage</a>(ce) != 0) &amp;&amp;
<a name="l01395"></a>01395                 check_locked_file_before_remove (fset, ce-&gt;<a class="code" href="structcache__entry.html#a792e4ea24cb16c76abe3229651e414a0">name</a>))
<a name="l01396"></a>01396                 ce_array[i]-&gt;<a class="code" href="structcache__entry.html#a4dab14fd813a1bb6b67352674ff4afb2">ce_flags</a> |= <a class="code" href="index_8h.html#aa5ee599d9d7af67f19dba204ce9030c0">CE_REMOVE</a>;
<a name="l01397"></a>01397         }
<a name="l01398"></a>01398     }
<a name="l01399"></a>01399 
<a name="l01400"></a>01400     <a class="code" href="index_8c.html#a12825d79310dd67cd238e49161be5bfd">remove_marked_cache_entries</a> (istate);
<a name="l01401"></a>01401 
<a name="l01402"></a>01402     g_free (full_prefix);
<a name="l01403"></a>01403 }
<a name="l01404"></a>01404 
<a name="l01405"></a>01405 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01406"></a>01406 scan_worktree_for_changes (<span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate, <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo,
<a name="l01407"></a>01407                            <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt, GList *ignore_list,
<a name="l01408"></a>01408                            <a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset,
<a name="l01409"></a>01409                            GList *user_perms, GList *group_perms)
<a name="l01410"></a>01410 {
<a name="l01411"></a>01411     remove_deleted (istate, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, <span class="stringliteral">&quot;&quot;</span>, ignore_list, fset,
<a name="l01412"></a>01412                     user_perms, group_perms, repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>);
<a name="l01413"></a>01413 
<a name="l01414"></a>01414     <a class="code" href="struct__AddOptions.html">AddOptions</a> <a class="code" href="seaf-fuse_8c.html#a75a4394524b5a85ecc4c8998e0ef680f">options</a>;
<a name="l01415"></a>01415     memset (&amp;options, 0, <span class="keyword">sizeof</span>(options));
<a name="l01416"></a>01416     options.<a class="code" href="struct__AddOptions.html#a97b5b11d9f2d4b00559bb1eec13ae35a">fset</a> = fset;
<a name="l01417"></a>01417     options.<a class="code" href="struct__AddOptions.html#ab09791ac93d1644f25367cf06d814981">user_perms</a> = user_perms;
<a name="l01418"></a>01418     options.<a class="code" href="struct__AddOptions.html#a195f8021f03f1db3606c02f6cf55311f">group_perms</a> = group_perms;
<a name="l01419"></a>01419     options.<a class="code" href="struct__AddOptions.html#a5dbb2227dac4de70d96c8ee8727acf16">is_repo_ro</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>;
<a name="l01420"></a>01420 
<a name="l01421"></a>01421     <span class="keywordflow">if</span> (add_recursive (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a>,
<a name="l01422"></a>01422                        istate, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, <span class="stringliteral">&quot;&quot;</span>, crypt, FALSE, ignore_list,
<a name="l01423"></a>01423                        NULL, NULL, &amp;options) &lt; 0)
<a name="l01424"></a>01424         <span class="keywordflow">return</span> -1;
<a name="l01425"></a>01425 
<a name="l01426"></a>01426     <span class="keywordflow">return</span> 0;
<a name="l01427"></a>01427 }
<a name="l01428"></a>01428 
<a name="l01429"></a>01429 <span class="keyword">static</span> gboolean
<a name="l01430"></a>01430 check_full_path_ignore (<span class="keyword">const</span> <span class="keywordtype">char</span> *worktree, <span class="keyword">const</span> <span class="keywordtype">char</span> *path, GList *ignore_list)
<a name="l01431"></a>01431 {
<a name="l01432"></a>01432     <span class="keywordtype">char</span> **tokens;
<a name="l01433"></a>01433     guint i;
<a name="l01434"></a>01434     guint n;
<a name="l01435"></a>01435     gboolean ret = FALSE;
<a name="l01436"></a>01436 
<a name="l01437"></a>01437     tokens = g_strsplit (path, <span class="stringliteral">&quot;/&quot;</span>, 0);
<a name="l01438"></a>01438     n = g_strv_length (tokens);
<a name="l01439"></a>01439     <span class="keywordflow">for</span> (i = 0; i &lt; n; ++i) {
<a name="l01440"></a>01440         <span class="comment">/* don&#39;t check ignore_list */</span>
<a name="l01441"></a>01441         <span class="keywordflow">if</span> (should_ignore (NULL, tokens[i], ignore_list)) {
<a name="l01442"></a>01442             ret = TRUE;
<a name="l01443"></a>01443             <span class="keywordflow">goto</span> out;
<a name="l01444"></a>01444         }
<a name="l01445"></a>01445     }
<a name="l01446"></a>01446 
<a name="l01447"></a>01447     <span class="keywordtype">char</span> *full_path = g_build_path (<span class="stringliteral">&quot;/&quot;</span>, worktree, path, NULL);
<a name="l01448"></a>01448     <span class="keywordflow">if</span> (<a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a32907bbaf9e2790699ddb7aaa97a3052">seaf_repo_check_ignore_file</a> (ignore_list, full_path))
<a name="l01449"></a>01449         ret = TRUE;
<a name="l01450"></a>01450     g_free (full_path);
<a name="l01451"></a>01451 
<a name="l01452"></a>01452 out:
<a name="l01453"></a>01453     g_strfreev (tokens);
<a name="l01454"></a>01454     <span class="keywordflow">return</span> ret;
<a name="l01455"></a>01455 }
<a name="l01456"></a>01456 
<a name="l01457"></a>01457 <span class="preprocessor">#ifndef __APPLE__</span>
<a name="l01458"></a>01458 <span class="preprocessor"></span>
<a name="l01459"></a>01459 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01460"></a>01460 add_path_to_index (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate,
<a name="l01461"></a>01461                    <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt, <span class="keyword">const</span> <span class="keywordtype">char</span> *path, GList *ignore_list,
<a name="l01462"></a>01462                    GList **scanned_dirs, gint64 *total_size, GQueue **remain_files,
<a name="l01463"></a>01463                    <a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset, GList *user_perms, GList *group_perms)
<a name="l01464"></a>01464 {
<a name="l01465"></a>01465     <span class="keywordtype">char</span> *full_path;
<a name="l01466"></a>01466     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l01467"></a>01467     <a class="code" href="struct__AddOptions.html">AddOptions</a> <a class="code" href="seaf-fuse_8c.html#a75a4394524b5a85ecc4c8998e0ef680f">options</a>;
<a name="l01468"></a>01468 
<a name="l01469"></a>01469     <span class="comment">/* When a repo is initially added, a SCAN_DIR event will be created</span>
<a name="l01470"></a>01470 <span class="comment">     * for the worktree root &quot;&quot;.</span>
<a name="l01471"></a>01471 <span class="comment">     */</span>
<a name="l01472"></a>01472     <span class="keywordflow">if</span> (path[0] == 0) {
<a name="l01473"></a>01473         remove_deleted (istate, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, <span class="stringliteral">&quot;&quot;</span>, ignore_list, fset,
<a name="l01474"></a>01474                         user_perms, group_perms, repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>);
<a name="l01475"></a>01475 
<a name="l01476"></a>01476         memset (&amp;options, 0, <span class="keyword">sizeof</span>(options));
<a name="l01477"></a>01477         options.<a class="code" href="struct__AddOptions.html#a97b5b11d9f2d4b00559bb1eec13ae35a">fset</a> = fset;
<a name="l01478"></a>01478         options.<a class="code" href="struct__AddOptions.html#ab09791ac93d1644f25367cf06d814981">user_perms</a> = user_perms;
<a name="l01479"></a>01479         options.<a class="code" href="struct__AddOptions.html#a195f8021f03f1db3606c02f6cf55311f">group_perms</a> = group_perms;
<a name="l01480"></a>01480         options.<a class="code" href="struct__AddOptions.html#a5dbb2227dac4de70d96c8ee8727acf16">is_repo_ro</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>;
<a name="l01481"></a>01481 
<a name="l01482"></a>01482         add_recursive (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a>, istate,
<a name="l01483"></a>01483                        repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, path,
<a name="l01484"></a>01484                        crypt, FALSE, ignore_list,
<a name="l01485"></a>01485                        total_size, remain_files, &amp;options);
<a name="l01486"></a>01486         <span class="keywordflow">return</span> 0;
<a name="l01487"></a>01487     }
<a name="l01488"></a>01488 
<a name="l01489"></a>01489     <span class="comment">/* If we&#39;ve recursively scanned the parent directory, don&#39;t need to scan</span>
<a name="l01490"></a>01490 <span class="comment">     * any files under it any more.</span>
<a name="l01491"></a>01491 <span class="comment">     */</span>
<a name="l01492"></a>01492     GList *ptr;
<a name="l01493"></a>01493     <span class="keywordtype">char</span> *dir, *full_dir;
<a name="l01494"></a>01494     <span class="keywordflow">for</span> (ptr = *scanned_dirs; ptr; ptr = ptr-&gt;next) {
<a name="l01495"></a>01495         dir = ptr-&gt;data;
<a name="l01496"></a>01496         <span class="comment">/* exact match */</span>
<a name="l01497"></a>01497         <span class="keywordflow">if</span> (strcmp (dir, path) == 0) {
<a name="l01498"></a>01498             seaf_debug (<span class="stringliteral">&quot;%s has been scanned before, skip adding.\n&quot;</span>, path);
<a name="l01499"></a>01499             <span class="keywordflow">return</span> 0;
<a name="l01500"></a>01500         }
<a name="l01501"></a>01501 
<a name="l01502"></a>01502         <span class="comment">/* prefix match. */</span>
<a name="l01503"></a>01503         full_dir = g_strconcat (dir, <span class="stringliteral">&quot;/&quot;</span>, NULL);
<a name="l01504"></a>01504         <span class="keywordflow">if</span> (strncmp (full_dir, path, strlen(full_dir)) == 0) {
<a name="l01505"></a>01505             g_free (full_dir);
<a name="l01506"></a>01506             seaf_debug (<span class="stringliteral">&quot;%s has been scanned before, skip adding.\n&quot;</span>, path);
<a name="l01507"></a>01507             <span class="keywordflow">return</span> 0;
<a name="l01508"></a>01508         }
<a name="l01509"></a>01509         g_free (full_dir);
<a name="l01510"></a>01510     }
<a name="l01511"></a>01511 
<a name="l01512"></a>01512     <span class="keywordflow">if</span> (check_full_path_ignore (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, path, ignore_list))
<a name="l01513"></a>01513         <span class="keywordflow">return</span> 0;
<a name="l01514"></a>01514 
<a name="l01515"></a>01515     full_path = g_build_filename (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, path, NULL);
<a name="l01516"></a>01516 
<a name="l01517"></a>01517     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (full_path, &amp;st) &lt; 0) {
<a name="l01518"></a>01518         seaf_warning (<span class="stringliteral">&quot;Failed to stat %s: %s.\n&quot;</span>, path, strerror(errno));
<a name="l01519"></a>01519         g_free (full_path);
<a name="l01520"></a>01520         <span class="keywordflow">return</span> -1;
<a name="l01521"></a>01521     }
<a name="l01522"></a>01522 
<a name="l01523"></a>01523     <span class="keywordflow">if</span> (S_ISDIR(st.st_mode))
<a name="l01524"></a>01524         *scanned_dirs = g_list_prepend (*scanned_dirs, g_strdup(path));
<a name="l01525"></a>01525 
<a name="l01526"></a>01526     memset (&amp;options, 0, <span class="keyword">sizeof</span>(options));
<a name="l01527"></a>01527     options.<a class="code" href="struct__AddOptions.html#a97b5b11d9f2d4b00559bb1eec13ae35a">fset</a> = fset;
<a name="l01528"></a>01528     options.<a class="code" href="struct__AddOptions.html#ab09791ac93d1644f25367cf06d814981">user_perms</a> = user_perms;
<a name="l01529"></a>01529     options.<a class="code" href="struct__AddOptions.html#a195f8021f03f1db3606c02f6cf55311f">group_perms</a> = group_perms;
<a name="l01530"></a>01530     options.<a class="code" href="struct__AddOptions.html#a5dbb2227dac4de70d96c8ee8727acf16">is_repo_ro</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>;
<a name="l01531"></a>01531 
<a name="l01532"></a>01532     <span class="comment">/* Add is always recursive */</span>
<a name="l01533"></a>01533     add_recursive (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a>, istate, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, path,
<a name="l01534"></a>01534                    crypt, FALSE, ignore_list, total_size, remain_files, &amp;options);
<a name="l01535"></a>01535 
<a name="l01536"></a>01536     g_free (full_path);
<a name="l01537"></a>01537     <span class="keywordflow">return</span> 0;
<a name="l01538"></a>01538 }
<a name="l01539"></a>01539 
<a name="l01540"></a>01540 <span class="preprocessor">#else</span>
<a name="l01541"></a>01541 <span class="preprocessor"></span>
<a name="l01542"></a>01542 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01543"></a>01543 add_path_to_index (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate,
<a name="l01544"></a>01544                    <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt, <span class="keyword">const</span> <span class="keywordtype">char</span> *path, GList *ignore_list,
<a name="l01545"></a>01545                    GList **scanned_dirs, gint64 *total_size, GQueue **remain_files,
<a name="l01546"></a>01546                    <a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset, GList *user_perms, GList *group_perms)
<a name="l01547"></a>01547 {
<a name="l01548"></a>01548     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l01549"></a>01549 
<a name="l01550"></a>01550     <span class="comment">/* If we&#39;ve recursively scanned the parent directory, don&#39;t need to scan</span>
<a name="l01551"></a>01551 <span class="comment">     * any files under it any more.</span>
<a name="l01552"></a>01552 <span class="comment">     */</span>
<a name="l01553"></a>01553     GList *ptr;
<a name="l01554"></a>01554     <span class="keywordtype">char</span> *dir, *full_dir;
<a name="l01555"></a>01555     <span class="keywordflow">for</span> (ptr = *scanned_dirs; ptr; ptr = ptr-&gt;next) {
<a name="l01556"></a>01556         dir = ptr-&gt;data;
<a name="l01557"></a>01557 
<a name="l01558"></a>01558         <span class="comment">/* Have scanned from root directory. */</span>
<a name="l01559"></a>01559         <span class="keywordflow">if</span> (dir[0] == 0) {
<a name="l01560"></a>01560             seaf_debug (<span class="stringliteral">&quot;%s has been scanned before, skip adding.\n&quot;</span>, path);
<a name="l01561"></a>01561             <span class="keywordflow">return</span> 0;
<a name="l01562"></a>01562         }
<a name="l01563"></a>01563 
<a name="l01564"></a>01564         <span class="comment">/* exact match */</span>
<a name="l01565"></a>01565         <span class="keywordflow">if</span> (strcmp (dir, path) == 0) {
<a name="l01566"></a>01566             seaf_debug (<span class="stringliteral">&quot;%s has been scanned before, skip adding.\n&quot;</span>, path);
<a name="l01567"></a>01567             <span class="keywordflow">return</span> 0;
<a name="l01568"></a>01568         }
<a name="l01569"></a>01569 
<a name="l01570"></a>01570         <span class="comment">/* prefix match. */</span>
<a name="l01571"></a>01571         full_dir = g_strconcat (dir, <span class="stringliteral">&quot;/&quot;</span>, NULL);
<a name="l01572"></a>01572         <span class="keywordflow">if</span> (strncmp (full_dir, path, strlen(full_dir)) == 0) {
<a name="l01573"></a>01573             g_free (full_dir);
<a name="l01574"></a>01574             seaf_debug (<span class="stringliteral">&quot;%s has been scanned before, skip adding.\n&quot;</span>, path);
<a name="l01575"></a>01575             <span class="keywordflow">return</span> 0;
<a name="l01576"></a>01576         }
<a name="l01577"></a>01577         g_free (full_dir);
<a name="l01578"></a>01578     }
<a name="l01579"></a>01579 
<a name="l01580"></a>01580     <span class="keywordflow">if</span> (path[0] != 0 &amp;&amp; check_full_path_ignore (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, path, ignore_list))
<a name="l01581"></a>01581         <span class="keywordflow">return</span> 0;
<a name="l01582"></a>01582 
<a name="l01583"></a>01583     remove_deleted (istate, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, path, ignore_list, NULL,
<a name="l01584"></a>01584                     user_perms, group_perms, repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>);
<a name="l01585"></a>01585 
<a name="l01586"></a>01586     *scanned_dirs = g_list_prepend (*scanned_dirs, g_strdup(path));
<a name="l01587"></a>01587 
<a name="l01588"></a>01588     <a class="code" href="struct__AddOptions.html">AddOptions</a> <a class="code" href="seaf-fuse_8c.html#a75a4394524b5a85ecc4c8998e0ef680f">options</a>;
<a name="l01589"></a>01589     memset (&amp;options, 0, <span class="keyword">sizeof</span>(options));
<a name="l01590"></a>01590     options.<a class="code" href="struct__AddOptions.html#a97b5b11d9f2d4b00559bb1eec13ae35a">fset</a> = fset;
<a name="l01591"></a>01591     options.<a class="code" href="struct__AddOptions.html#ab09791ac93d1644f25367cf06d814981">user_perms</a> = user_perms;
<a name="l01592"></a>01592     options.<a class="code" href="struct__AddOptions.html#a195f8021f03f1db3606c02f6cf55311f">group_perms</a> = group_perms;
<a name="l01593"></a>01593     options.<a class="code" href="struct__AddOptions.html#a5dbb2227dac4de70d96c8ee8727acf16">is_repo_ro</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>;
<a name="l01594"></a>01594 
<a name="l01595"></a>01595     <span class="comment">/* Add is always recursive */</span>
<a name="l01596"></a>01596     add_recursive (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a>, istate, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, path,
<a name="l01597"></a>01597                    crypt, FALSE, ignore_list, total_size, remain_files, &amp;options);
<a name="l01598"></a>01598 
<a name="l01599"></a>01599     <span class="keywordflow">return</span> 0;
<a name="l01600"></a>01600 }
<a name="l01601"></a>01601 
<a name="l01602"></a>01602 <span class="preprocessor">#endif  </span><span class="comment">/* __APPLE__ */</span>
<a name="l01603"></a>01603 
<a name="l01604"></a>01604 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01605"></a>01605 add_remain_files (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate,
<a name="l01606"></a>01606                   <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt, GQueue *remain_files,
<a name="l01607"></a>01607                   GList *ignore_list, gint64 *total_size)
<a name="l01608"></a>01608 {
<a name="l01609"></a>01609     <span class="keywordtype">char</span> *path;
<a name="l01610"></a>01610     <span class="keywordtype">char</span> *full_path;
<a name="l01611"></a>01611     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l01612"></a>01612 
<a name="l01613"></a>01613     <span class="keywordflow">while</span> ((path = g_queue_pop_head (remain_files)) != NULL) {
<a name="l01614"></a>01614         full_path = g_build_filename (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, path, NULL);
<a name="l01615"></a>01615         <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (full_path, &amp;st) &lt; 0) {
<a name="l01616"></a>01616             seaf_warning (<span class="stringliteral">&quot;Failed to stat %s: %s.\n&quot;</span>, full_path, strerror(errno));
<a name="l01617"></a>01617             g_free (path);
<a name="l01618"></a>01618             g_free (full_path);
<a name="l01619"></a>01619             <span class="keywordflow">continue</span>;
<a name="l01620"></a>01620         }
<a name="l01621"></a>01621 
<a name="l01622"></a>01622         <span class="keywordflow">if</span> (S_ISREG(st.st_mode)) {
<a name="l01623"></a>01623             gboolean added = FALSE;
<a name="l01624"></a>01624             <a class="code" href="index_8c.html#ac412654516da827612dd5db31703b32c">add_to_index</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, istate, path, full_path,
<a name="l01625"></a>01625                           &amp;st, 0, crypt, index_cb, repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a>, &amp;added);
<a name="l01626"></a>01626             <span class="keywordflow">if</span> (added) {
<a name="l01627"></a>01627                 *total_size += (gint64)(st.st_size);
<a name="l01628"></a>01628                 <span class="keywordflow">if</span> (*total_size &gt;= <a class="code" href="daemon_2repo-mgr_8c.html#a67a7df7fa60be3209b087d86faaab360">MAX_COMMIT_SIZE</a>) {
<a name="l01629"></a>01629                     g_free (path);
<a name="l01630"></a>01630                     g_free (full_path);
<a name="l01631"></a>01631                     <span class="keywordflow">break</span>;
<a name="l01632"></a>01632                 }
<a name="l01633"></a>01633             }
<a name="l01634"></a>01634         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S_ISDIR(st.st_mode)) {
<a name="l01635"></a>01635             <span class="keywordflow">if</span> (is_empty_dir (full_path, ignore_list))
<a name="l01636"></a>01636                 <a class="code" href="index_8c.html#a0a287241a624545389a63a0b22a98513">add_empty_dir_to_index</a> (istate, path, &amp;st);
<a name="l01637"></a>01637         }
<a name="l01638"></a>01638         g_free (path);
<a name="l01639"></a>01639         g_free (full_path);
<a name="l01640"></a>01640     }
<a name="l01641"></a>01641 
<a name="l01642"></a>01642     <span class="keywordflow">return</span> 0;
<a name="l01643"></a>01643 }
<a name="l01644"></a>01644 
<a name="l01645"></a>01645 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01646"></a>01646 try_add_empty_parent_dir_entry (<span class="keyword">const</span> <span class="keywordtype">char</span> *worktree,
<a name="l01647"></a>01647                                 <span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate,
<a name="l01648"></a>01648                                 <span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l01649"></a>01649 {
<a name="l01650"></a>01650     <span class="keywordflow">if</span> (<a class="code" href="index_8c.html#a3931a94c55aad8bf8267f179ae846711">index_name_exists</a> (istate, path, strlen(path), 0) != NULL)
<a name="l01651"></a>01651         <span class="keywordflow">return</span>;
<a name="l01652"></a>01652 
<a name="l01653"></a>01653     <span class="keywordtype">char</span> *parent_dir = g_path_get_dirname (path);
<a name="l01654"></a>01654 
<a name="l01655"></a>01655     <span class="comment">/* Parent dir is the worktree dir. */</span>
<a name="l01656"></a>01656     <span class="keywordflow">if</span> (strcmp (parent_dir, <span class="stringliteral">&quot;.&quot;</span>) == 0) {
<a name="l01657"></a>01657         g_free (parent_dir);
<a name="l01658"></a>01658         <span class="keywordflow">return</span>;
<a name="l01659"></a>01659     }
<a name="l01660"></a>01660 
<a name="l01661"></a>01661     <span class="keywordtype">char</span> *full_dir = g_build_filename (worktree, parent_dir, NULL);
<a name="l01662"></a>01662     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l01663"></a>01663     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (full_dir, &amp;st) &lt; 0) {
<a name="l01664"></a>01664         <span class="keywordflow">goto</span> out;
<a name="l01665"></a>01665     }
<a name="l01666"></a>01666 
<a name="l01667"></a>01667     <a class="code" href="index_8c.html#ac3edae475009ceeec48b372556153c70">add_empty_dir_to_index_with_check</a> (istate, parent_dir, &amp;st);
<a name="l01668"></a>01668 
<a name="l01669"></a>01669 out:
<a name="l01670"></a>01670     g_free (parent_dir);
<a name="l01671"></a>01671     g_free (full_dir);
<a name="l01672"></a>01672 }
<a name="l01673"></a>01673 
<a name="l01674"></a>01674 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01675"></a>01675 try_add_empty_parent_dir_entry_from_wt (<span class="keyword">const</span> <span class="keywordtype">char</span> *worktree,
<a name="l01676"></a>01676                                         <span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate,
<a name="l01677"></a>01677                                         GList *ignore_list,
<a name="l01678"></a>01678                                         <span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l01679"></a>01679 {
<a name="l01680"></a>01680     <span class="keywordflow">if</span> (<a class="code" href="index_8c.html#a3931a94c55aad8bf8267f179ae846711">index_name_exists</a> (istate, path, strlen(path), 0) != NULL)
<a name="l01681"></a>01681         <span class="keywordflow">return</span>;
<a name="l01682"></a>01682 
<a name="l01683"></a>01683     <span class="keywordtype">char</span> *parent_dir = g_path_get_dirname (path);
<a name="l01684"></a>01684 
<a name="l01685"></a>01685     <span class="comment">/* Parent dir is the worktree dir. */</span>
<a name="l01686"></a>01686     <span class="keywordflow">if</span> (strcmp (parent_dir, <span class="stringliteral">&quot;.&quot;</span>) == 0) {
<a name="l01687"></a>01687         g_free (parent_dir);
<a name="l01688"></a>01688         <span class="keywordflow">return</span>;
<a name="l01689"></a>01689     }
<a name="l01690"></a>01690 
<a name="l01691"></a>01691     <span class="keywordtype">char</span> *full_dir = g_build_filename (worktree, parent_dir, NULL);
<a name="l01692"></a>01692     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l01693"></a>01693     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (full_dir, &amp;st) &lt; 0) {
<a name="l01694"></a>01694         <span class="keywordflow">goto</span> out;
<a name="l01695"></a>01695     }
<a name="l01696"></a>01696 
<a name="l01697"></a>01697     <span class="keywordflow">if</span> (is_empty_dir (full_dir, ignore_list)) {
<a name="l01698"></a>01698 <span class="preprocessor">#ifdef WIN32</span>
<a name="l01699"></a>01699 <span class="preprocessor"></span>        <span class="keywordtype">wchar_t</span> *parent_dir_w = g_utf8_to_utf16 (parent_dir, -1, NULL, NULL, NULL);
<a name="l01700"></a>01700         <span class="keywordtype">wchar_t</span> *pw;
<a name="l01701"></a>01701         <span class="keywordflow">for</span> (pw = parent_dir_w; *pw != L<span class="charliteral">&#39;\0&#39;</span>; ++pw)
<a name="l01702"></a>01702             <span class="keywordflow">if</span> (*pw == L<span class="charliteral">&#39;/&#39;</span>)
<a name="l01703"></a>01703                 *pw = L<span class="charliteral">&#39;\\&#39;</span>;
<a name="l01704"></a>01704 
<a name="l01705"></a>01705         <span class="keywordtype">wchar_t</span> *long_path = win32_83_path_to_long_path (worktree,
<a name="l01706"></a>01706                                                          parent_dir_w,
<a name="l01707"></a>01707                                                          wcslen(parent_dir_w));
<a name="l01708"></a>01708         g_free (parent_dir_w);
<a name="l01709"></a>01709         <span class="keywordflow">if</span> (!long_path) {
<a name="l01710"></a>01710             seaf_warning (<span class="stringliteral">&quot;Convert %s to long path failed.\n&quot;</span>, parent_dir);
<a name="l01711"></a>01711             <span class="keywordflow">goto</span> out;
<a name="l01712"></a>01712         }
<a name="l01713"></a>01713 
<a name="l01714"></a>01714         <span class="keywordtype">char</span> *utf8_path = g_utf16_to_utf8 (long_path, -1, NULL, NULL, NULL);
<a name="l01715"></a>01715         <span class="keywordtype">char</span> *p;
<a name="l01716"></a>01716         <span class="keywordflow">for</span> (p = utf8_path; *p != 0; ++p)
<a name="l01717"></a>01717             <span class="keywordflow">if</span> (*p == <span class="charliteral">&#39;\\&#39;</span>)
<a name="l01718"></a>01718                 *p = <span class="charliteral">&#39;/&#39;</span>;
<a name="l01719"></a>01719         g_free (long_path);
<a name="l01720"></a>01720 
<a name="l01721"></a>01721         <a class="code" href="index_8c.html#a0a287241a624545389a63a0b22a98513">add_empty_dir_to_index</a> (istate, utf8_path, &amp;st);
<a name="l01722"></a>01722 <span class="preprocessor">#else</span>
<a name="l01723"></a>01723 <span class="preprocessor"></span>        <a class="code" href="index_8c.html#a0a287241a624545389a63a0b22a98513">add_empty_dir_to_index</a> (istate, parent_dir, &amp;st);
<a name="l01724"></a>01724 <span class="preprocessor">#endif</span>
<a name="l01725"></a>01725 <span class="preprocessor"></span>    }
<a name="l01726"></a>01726 
<a name="l01727"></a>01727 out:
<a name="l01728"></a>01728     g_free (parent_dir);
<a name="l01729"></a>01729     g_free (full_dir);
<a name="l01730"></a>01730 }
<a name="l01731"></a>01731 
<a name="l01732"></a>01732 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01733"></a>01733 update_ce_mode (<span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate, <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree, <span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l01734"></a>01734 {
<a name="l01735"></a>01735     <span class="keywordtype">char</span> *full_path;
<a name="l01736"></a>01736     <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *ce;
<a name="l01737"></a>01737     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l01738"></a>01738 
<a name="l01739"></a>01739     ce = <a class="code" href="index_8c.html#a3931a94c55aad8bf8267f179ae846711">index_name_exists</a> (istate, path, strlen(path), 0);
<a name="l01740"></a>01740     <span class="keywordflow">if</span> (!ce)
<a name="l01741"></a>01741         <span class="keywordflow">return</span>;
<a name="l01742"></a>01742 
<a name="l01743"></a>01743     full_path = g_build_filename (worktree, path, NULL);
<a name="l01744"></a>01744     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (full_path, &amp;st) &lt; 0) {
<a name="l01745"></a>01745         seaf_warning (<span class="stringliteral">&quot;Failed to stat %s: %s.\n&quot;</span>, full_path, strerror(errno));
<a name="l01746"></a>01746         g_free (full_path);
<a name="l01747"></a>01747         <span class="keywordflow">return</span>;
<a name="l01748"></a>01748     }
<a name="l01749"></a>01749 
<a name="l01750"></a>01750     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> new_mode = create_ce_mode (st.st_mode);
<a name="l01751"></a>01751     <span class="keywordflow">if</span> (new_mode != ce-&gt;<a class="code" href="structcache__entry.html#a5fcbcc4e7265ae8150f136380ed92c05">ce_mode</a>)
<a name="l01752"></a>01752         ce-&gt;<a class="code" href="structcache__entry.html#a5fcbcc4e7265ae8150f136380ed92c05">ce_mode</a> = new_mode;
<a name="l01753"></a>01753     istate-&gt;<a class="code" href="structindex__state.html#a8e22a9fe2486576488e72fe97801ebe5">cache_changed</a> = 1;
<a name="l01754"></a>01754 }
<a name="l01755"></a>01755 
<a name="l01756"></a>01756 <span class="preprocessor">#ifdef WIN32</span>
<a name="l01757"></a>01757 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01758"></a>01758 scan_subtree_for_deletion (<span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate,
<a name="l01759"></a>01759                            <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree,
<a name="l01760"></a>01760                            <span class="keyword">const</span> <span class="keywordtype">char</span> *path,
<a name="l01761"></a>01761                            GList *ignore_list,
<a name="l01762"></a>01762                            <a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset,
<a name="l01763"></a>01763                            GList *user_perms,
<a name="l01764"></a>01764                            GList *group_perms,
<a name="l01765"></a>01765                            gboolean is_readonly,
<a name="l01766"></a>01766                            GList **scanned_dirs)
<a name="l01767"></a>01767 {
<a name="l01768"></a>01768     <span class="keywordtype">wchar_t</span> *path_w;
<a name="l01769"></a>01769     <span class="keywordtype">wchar_t</span> *dir_w = NULL;
<a name="l01770"></a>01770     <span class="keywordtype">wchar_t</span> *p;
<a name="l01771"></a>01771     <span class="keywordtype">char</span> *dir = NULL;
<a name="l01772"></a>01772     <span class="keywordtype">char</span> *p2;
<a name="l01773"></a>01773 
<a name="l01774"></a>01774     <span class="comment">/* In most file systems, like NTFS, 8.3 format path should contain ~.</span>
<a name="l01775"></a>01775 <span class="comment">     * Also note that *~ files are ignored.</span>
<a name="l01776"></a>01776 <span class="comment">     */</span>
<a name="l01777"></a>01777     <span class="keywordflow">if</span> (!strchr (path, <span class="charliteral">&#39;~&#39;</span>) || path[strlen(path)-1] == <span class="charliteral">&#39;~&#39;</span>)
<a name="l01778"></a>01778         <span class="keywordflow">return</span>;
<a name="l01779"></a>01779 
<a name="l01780"></a>01780     path_w = g_utf8_to_utf16 (path, -1, NULL, NULL, NULL);
<a name="l01781"></a>01781 
<a name="l01782"></a>01782     <span class="keywordflow">for</span> (p = path_w; *p != L<span class="charliteral">&#39;\0&#39;</span>; ++p)
<a name="l01783"></a>01783         <span class="keywordflow">if</span> (*p == L<span class="charliteral">&#39;/&#39;</span>)
<a name="l01784"></a>01784             *p = L<span class="charliteral">&#39;\\&#39;</span>;
<a name="l01785"></a>01785 
<a name="l01786"></a>01786     <span class="keywordflow">while</span> (1) {
<a name="l01787"></a>01787         p = wcsrchr (path_w, L<span class="charliteral">&#39;\\&#39;</span>);
<a name="l01788"></a>01788         <span class="keywordflow">if</span> (p)
<a name="l01789"></a>01789             *p = L<span class="charliteral">&#39;\0&#39;</span>;
<a name="l01790"></a>01790         dir_w = win32_83_path_to_long_path (worktree, path_w, wcslen(path_w));
<a name="l01791"></a>01791         <span class="keywordflow">if</span> (dir_w)
<a name="l01792"></a>01792             <span class="keywordflow">break</span>;
<a name="l01793"></a>01793         <span class="keywordflow">if</span> (!p)
<a name="l01794"></a>01794             <span class="keywordflow">break</span>;
<a name="l01795"></a>01795     }
<a name="l01796"></a>01796 
<a name="l01797"></a>01797     <span class="keywordflow">if</span> (!dir_w)
<a name="l01798"></a>01798         dir_w = wcsdup(L<span class="stringliteral">&quot;&quot;</span>);
<a name="l01799"></a>01799 
<a name="l01800"></a>01800     dir = g_utf16_to_utf8 (dir_w, -1, NULL, NULL, NULL);
<a name="l01801"></a>01801     <span class="keywordflow">for</span> (p2 = dir; *p2 != 0; ++p2)
<a name="l01802"></a>01802         <span class="keywordflow">if</span> (*p2 == <span class="charliteral">&#39;\\&#39;</span>)
<a name="l01803"></a>01803             *p2 = <span class="charliteral">&#39;/&#39;</span>;
<a name="l01804"></a>01804 
<a name="l01805"></a>01805     <span class="comment">/* If we&#39;ve recursively scanned the parent directory, don&#39;t need to scan</span>
<a name="l01806"></a>01806 <span class="comment">     * any files under it any more.</span>
<a name="l01807"></a>01807 <span class="comment">     */</span>
<a name="l01808"></a>01808     GList *ptr;
<a name="l01809"></a>01809     <span class="keywordtype">char</span> *s, *full_s;
<a name="l01810"></a>01810     <span class="keywordflow">for</span> (ptr = *scanned_dirs; ptr; ptr = ptr-&gt;next) {
<a name="l01811"></a>01811         s = ptr-&gt;data;
<a name="l01812"></a>01812 
<a name="l01813"></a>01813         <span class="comment">/* Have scanned from root directory. */</span>
<a name="l01814"></a>01814         <span class="keywordflow">if</span> (s[0] == 0) {
<a name="l01815"></a>01815             <span class="keywordflow">goto</span> out;
<a name="l01816"></a>01816         }
<a name="l01817"></a>01817 
<a name="l01818"></a>01818         <span class="comment">/* exact match */</span>
<a name="l01819"></a>01819         <span class="keywordflow">if</span> (strcmp (s, path) == 0) {
<a name="l01820"></a>01820             <span class="keywordflow">goto</span> out;
<a name="l01821"></a>01821         }
<a name="l01822"></a>01822 
<a name="l01823"></a>01823         <span class="comment">/* prefix match. */</span>
<a name="l01824"></a>01824         full_s = g_strconcat (s, <span class="stringliteral">&quot;/&quot;</span>, NULL);
<a name="l01825"></a>01825         <span class="keywordflow">if</span> (strncmp (full_s, dir, strlen(full_s)) == 0) {
<a name="l01826"></a>01826             g_free (full_s);
<a name="l01827"></a>01827             <span class="keywordflow">goto</span> out;
<a name="l01828"></a>01828         }
<a name="l01829"></a>01829         g_free (full_s);
<a name="l01830"></a>01830     }
<a name="l01831"></a>01831 
<a name="l01832"></a>01832     *scanned_dirs = g_list_prepend (*scanned_dirs, g_strdup(dir));
<a name="l01833"></a>01833 
<a name="l01834"></a>01834     remove_deleted (istate, worktree, dir, ignore_list, fset,
<a name="l01835"></a>01835                     user_perms, group_perms, is_readonly);
<a name="l01836"></a>01836 
<a name="l01837"></a>01837 out:
<a name="l01838"></a>01838     g_free (path_w);
<a name="l01839"></a>01839     g_free (dir_w);
<a name="l01840"></a>01840     g_free (dir);
<a name="l01841"></a>01841 }
<a name="l01842"></a>01842 <span class="preprocessor">#else</span>
<a name="l01843"></a>01843 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01844"></a>01844 scan_subtree_for_deletion (<span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate,
<a name="l01845"></a>01845                            <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree,
<a name="l01846"></a>01846                            <span class="keyword">const</span> <span class="keywordtype">char</span> *path,
<a name="l01847"></a>01847                            GList *ignore_list,
<a name="l01848"></a>01848                            <a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset,
<a name="l01849"></a>01849                            GList *user_perms,
<a name="l01850"></a>01850                            GList *group_perms,
<a name="l01851"></a>01851                            gboolean is_readonly,
<a name="l01852"></a>01852                            GList **scanned_dirs)
<a name="l01853"></a>01853 {
<a name="l01854"></a>01854 }
<a name="l01855"></a>01855 <span class="preprocessor">#endif</span>
<a name="l01856"></a>01856 <span class="preprocessor"></span>
<a name="l01857"></a>01857 <span class="comment">/* Return TRUE if the caller should stop processing next event. */</span>
<a name="l01858"></a>01858 <span class="keyword">static</span> gboolean
<a name="l01859"></a>01859 handle_add_files (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate,
<a name="l01860"></a>01860                   <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt, GList *ignore_list,
<a name="l01861"></a>01861                   <a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset,
<a name="l01862"></a>01862                   GList *user_perms, GList *group_perms,
<a name="l01863"></a>01863                   <a class="code" href="structWTStatus.html">WTStatus</a> *<a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>, <a class="code" href="structWTEvent.html">WTEvent</a> *event,
<a name="l01864"></a>01864                   GList **scanned_dirs, gint64 *total_size)
<a name="l01865"></a>01865 {
<a name="l01866"></a>01866     <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#ae55dc691d150f9eef30f3f942d8dacca">create_partial_commit</a>) {
<a name="l01867"></a>01867         <span class="comment">/* XXX: We now use remain_files = NULL to signify not creating</span>
<a name="l01868"></a>01868 <span class="comment">         * partial commits. It&#39;s better to use total_size = NULL for</span>
<a name="l01869"></a>01869 <span class="comment">         * that purpose.</span>
<a name="l01870"></a>01870 <span class="comment">         */</span>
<a name="l01871"></a>01871         add_path_to_index (repo, istate, crypt, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>,
<a name="l01872"></a>01872                            ignore_list, scanned_dirs,
<a name="l01873"></a>01873                            total_size, NULL, NULL,
<a name="l01874"></a>01874                            user_perms, group_perms);
<a name="l01875"></a>01875     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!event-&gt;<a class="code" href="structWTEvent.html#a4f9b1829a6c0a8cdac986ace9ea0116f">remain_files</a>) {
<a name="l01876"></a>01876         GQueue *remain_files = NULL;
<a name="l01877"></a>01877         add_path_to_index (repo, istate, crypt, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>,
<a name="l01878"></a>01878                            ignore_list, scanned_dirs,
<a name="l01879"></a>01879                            total_size, &amp;remain_files, fset,
<a name="l01880"></a>01880                            user_perms, group_perms);
<a name="l01881"></a>01881         <span class="keywordflow">if</span> (*total_size &gt;= <a class="code" href="daemon_2repo-mgr_8c.html#a67a7df7fa60be3209b087d86faaab360">MAX_COMMIT_SIZE</a>) {
<a name="l01882"></a>01882             seaf_message (<span class="stringliteral">&quot;Creating partial commit after adding %s.\n&quot;</span>,
<a name="l01883"></a>01883                           event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>);
<a name="l01884"></a>01884 
<a name="l01885"></a>01885             status-&gt;<a class="code" href="structWTStatus.html#a80a104859f6aa1d369f07efaf3c6bcfc">partial_commit</a> = TRUE;
<a name="l01886"></a>01886 
<a name="l01887"></a>01887             <span class="comment">/* An event for a new folder may contain many files.</span>
<a name="l01888"></a>01888 <span class="comment">             * If the total_size become larger than 100MB after adding</span>
<a name="l01889"></a>01889 <span class="comment">             * some of these files, the remaining file paths will be</span>
<a name="l01890"></a>01890 <span class="comment">             * cached in remain files. This way we don&#39;t need to scan</span>
<a name="l01891"></a>01891 <span class="comment">             * the folder again next time.</span>
<a name="l01892"></a>01892 <span class="comment">             */</span>
<a name="l01893"></a>01893             <span class="keywordflow">if</span> (remain_files) {
<a name="l01894"></a>01894                 <span class="keywordflow">if</span> (g_queue_get_length (remain_files) == 0) {
<a name="l01895"></a>01895                     g_queue_free (remain_files);
<a name="l01896"></a>01896                     <span class="keywordflow">return</span> TRUE;
<a name="l01897"></a>01897                 }
<a name="l01898"></a>01898 
<a name="l01899"></a>01899                 seaf_message (<span class="stringliteral">&quot;Remain files for %s.\n&quot;</span>, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>);
<a name="l01900"></a>01900 
<a name="l01901"></a>01901                 <span class="comment">/* Cache remaining files in the event structure. */</span>
<a name="l01902"></a>01902                 <span class="keyword">event</span>-&gt;remain_files = remain_files;
<a name="l01903"></a>01903 
<a name="l01904"></a>01904                 pthread_mutex_lock (&amp;status-&gt;<a class="code" href="structWTStatus.html#a4f6f1851f6c1b6f83af1c9bfbdf099af">q_lock</a>);
<a name="l01905"></a>01905                 g_queue_push_head (status-&gt;<a class="code" href="structWTStatus.html#ad480fdc9a98872fb02bc14c0a122ed64">event_q</a>, event);
<a name="l01906"></a>01906                 pthread_mutex_unlock (&amp;status-&gt;<a class="code" href="structWTStatus.html#a4f6f1851f6c1b6f83af1c9bfbdf099af">q_lock</a>);
<a name="l01907"></a>01907             }
<a name="l01908"></a>01908 
<a name="l01909"></a>01909             <span class="keywordflow">return</span> TRUE;
<a name="l01910"></a>01910         }
<a name="l01911"></a>01911     } <span class="keywordflow">else</span> {
<a name="l01912"></a>01912         seaf_message (<span class="stringliteral">&quot;Adding remaining files for %s.\n&quot;</span>, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>);
<a name="l01913"></a>01913 
<a name="l01914"></a>01914         add_remain_files (repo, istate, crypt, event-&gt;<a class="code" href="structWTEvent.html#a4f9b1829a6c0a8cdac986ace9ea0116f">remain_files</a>,
<a name="l01915"></a>01915                           ignore_list, total_size);
<a name="l01916"></a>01916         <span class="keywordflow">if</span> (g_queue_get_length (event-&gt;<a class="code" href="structWTEvent.html#a4f9b1829a6c0a8cdac986ace9ea0116f">remain_files</a>) != 0) {
<a name="l01917"></a>01917             pthread_mutex_lock (&amp;status-&gt;<a class="code" href="structWTStatus.html#a4f6f1851f6c1b6f83af1c9bfbdf099af">q_lock</a>);
<a name="l01918"></a>01918             g_queue_push_head (status-&gt;<a class="code" href="structWTStatus.html#ad480fdc9a98872fb02bc14c0a122ed64">event_q</a>, event);
<a name="l01919"></a>01919             pthread_mutex_unlock (&amp;status-&gt;<a class="code" href="structWTStatus.html#a4f6f1851f6c1b6f83af1c9bfbdf099af">q_lock</a>);
<a name="l01920"></a>01920             <span class="keywordflow">return</span> TRUE;
<a name="l01921"></a>01921         }
<a name="l01922"></a>01922         <span class="keywordflow">if</span> (*total_size &gt;= <a class="code" href="daemon_2repo-mgr_8c.html#a67a7df7fa60be3209b087d86faaab360">MAX_COMMIT_SIZE</a>)
<a name="l01923"></a>01923             <span class="keywordflow">return</span> TRUE;
<a name="l01924"></a>01924     }
<a name="l01925"></a>01925 
<a name="l01926"></a>01926     <span class="keywordflow">return</span> FALSE;
<a name="l01927"></a>01927 }
<a name="l01928"></a>01928 
<a name="l01929"></a>01929 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01930"></a>01930 apply_worktree_changes_to_index (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate,
<a name="l01931"></a>01931                                  <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt, GList *ignore_list,
<a name="l01932"></a>01932                                  <a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset,
<a name="l01933"></a>01933                                  GList *user_perms, GList *group_perms)
<a name="l01934"></a>01934 {
<a name="l01935"></a>01935     <a class="code" href="structWTStatus.html">WTStatus</a> *<a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l01936"></a>01936     <a class="code" href="structWTEvent.html">WTEvent</a> *event, *next_event;
<a name="l01937"></a>01937     gboolean not_found;
<a name="l01938"></a>01938 
<a name="l01939"></a>01939     status = <a class="code" href="wt-monitor-linux_8c.html#ac6fd1291570eac2124938f17d4223651">seaf_wt_monitor_get_worktree_status</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a64fc6ad3e80ab34bd2d5ac10dfc1aa66">wt_monitor</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01940"></a>01940     <span class="keywordflow">if</span> (!status) {
<a name="l01941"></a>01941         seaf_warning (<span class="stringliteral">&quot;Can&#39;t find worktree status for repo %s(%.8s).\n&quot;</span>,
<a name="l01942"></a>01942                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01943"></a>01943         <span class="keywordflow">return</span> -1;
<a name="l01944"></a>01944     }
<a name="l01945"></a>01945 
<a name="l01946"></a>01946     GList *scanned_dirs = NULL, *scanned_del_dirs = NULL;
<a name="l01947"></a>01947 
<a name="l01948"></a>01948     <a class="code" href="structWTEvent.html">WTEvent</a> *last_event;
<a name="l01949"></a>01949 
<a name="l01950"></a>01950     pthread_mutex_lock (&amp;status-&gt;<a class="code" href="structWTStatus.html#a4f6f1851f6c1b6f83af1c9bfbdf099af">q_lock</a>);
<a name="l01951"></a>01951     last_event = g_queue_peek_tail (status-&gt;<a class="code" href="structWTStatus.html#ad480fdc9a98872fb02bc14c0a122ed64">event_q</a>);
<a name="l01952"></a>01952     pthread_mutex_unlock (&amp;status-&gt;<a class="code" href="structWTStatus.html#a4f6f1851f6c1b6f83af1c9bfbdf099af">q_lock</a>);
<a name="l01953"></a>01953 
<a name="l01954"></a>01954     <span class="keywordflow">if</span> (!last_event) {
<a name="l01955"></a>01955         seaf_message (<span class="stringliteral">&quot;All events are processed for repo %s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01956"></a>01956         status-&gt;<a class="code" href="structWTStatus.html#a80a104859f6aa1d369f07efaf3c6bcfc">partial_commit</a> = FALSE;
<a name="l01957"></a>01957         <span class="keywordflow">goto</span> out;
<a name="l01958"></a>01958     }
<a name="l01959"></a>01959 
<a name="l01960"></a>01960     gint64 total_size = 0;
<a name="l01961"></a>01961 
<a name="l01962"></a>01962     <span class="keywordflow">while</span> (1) {
<a name="l01963"></a>01963         pthread_mutex_lock (&amp;status-&gt;<a class="code" href="structWTStatus.html#a4f6f1851f6c1b6f83af1c9bfbdf099af">q_lock</a>);
<a name="l01964"></a>01964         <span class="keyword">event</span> = g_queue_pop_head (status-&gt;<a class="code" href="structWTStatus.html#ad480fdc9a98872fb02bc14c0a122ed64">event_q</a>);
<a name="l01965"></a>01965         next_event = g_queue_peek_head (status-&gt;<a class="code" href="structWTStatus.html#ad480fdc9a98872fb02bc14c0a122ed64">event_q</a>);
<a name="l01966"></a>01966         pthread_mutex_unlock (&amp;status-&gt;<a class="code" href="structWTStatus.html#a4f6f1851f6c1b6f83af1c9bfbdf099af">q_lock</a>);
<a name="l01967"></a>01967         <span class="keywordflow">if</span> (!event)
<a name="l01968"></a>01968             <span class="keywordflow">break</span>;
<a name="l01969"></a>01969 
<a name="l01970"></a>01970         <span class="keywordflow">switch</span> (event-&gt;<a class="code" href="structWTEvent.html#a4c4bc6419bd54a04e1cb140e35a40df0">ev_type</a>) {
<a name="l01971"></a>01971         <span class="keywordflow">case</span> <a class="code" href="wt-monitor-structs_8h.html#a157d5577a5b2f5986037d0d09c7dc77da105d31e8ef66447f9b1dc0d7f38540b2">WT_EVENT_CREATE_OR_UPDATE</a>:
<a name="l01972"></a>01972             <span class="comment">/* If consecutive CREATE_OR_UPDATE events present</span>
<a name="l01973"></a>01973 <span class="comment">               in the event queue, only process the last one.</span>
<a name="l01974"></a>01974 <span class="comment">            */</span>
<a name="l01975"></a>01975             <span class="keywordflow">if</span> (next_event &amp;&amp;
<a name="l01976"></a>01976                 next_event-&gt;<a class="code" href="structWTEvent.html#a4c4bc6419bd54a04e1cb140e35a40df0">ev_type</a> == event-&gt;<a class="code" href="structWTEvent.html#a4c4bc6419bd54a04e1cb140e35a40df0">ev_type</a> &amp;&amp;
<a name="l01977"></a>01977                 strcmp (next_event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>) == 0)
<a name="l01978"></a>01978                 <span class="keywordflow">break</span>;
<a name="l01979"></a>01979 
<a name="l01980"></a>01980             <span class="comment">/* CREATE_OR_UPDATE event tells us the exact path of changed file/dir.</span>
<a name="l01981"></a>01981 <span class="comment">             * If the event path is not writable, we don&#39;t need to check the paths</span>
<a name="l01982"></a>01982 <span class="comment">             * under the event path.</span>
<a name="l01983"></a>01983 <span class="comment">             */</span>
<a name="l01984"></a>01984             <span class="keywordflow">if</span> (!is_path_writable(user_perms, group_perms,
<a name="l01985"></a>01985                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>)) {
<a name="l01986"></a>01986                 seaf_debug (<span class="stringliteral">&quot;%s is not writable, ignore.\n&quot;</span>, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>);
<a name="l01987"></a>01987                 <span class="keywordflow">break</span>;
<a name="l01988"></a>01988             }
<a name="l01989"></a>01989 
<a name="l01990"></a>01990             <span class="keywordflow">if</span> (handle_add_files (repo, istate, crypt, ignore_list,
<a name="l01991"></a>01991                                   fset, user_perms, group_perms,
<a name="l01992"></a>01992                                   status, event,
<a name="l01993"></a>01993                                   &amp;scanned_dirs, &amp;total_size))
<a name="l01994"></a>01994                 <span class="keywordflow">goto</span> out;
<a name="l01995"></a>01995 
<a name="l01996"></a>01996             <span class="keywordflow">break</span>;
<a name="l01997"></a>01997         <span class="keywordflow">case</span> <a class="code" href="wt-monitor-structs_8h.html#a157d5577a5b2f5986037d0d09c7dc77da8b132903bb7378264cf3473025db5528">WT_EVENT_SCAN_DIR</a>:
<a name="l01998"></a>01998             <span class="keywordflow">if</span> (handle_add_files (repo, istate, crypt, ignore_list,
<a name="l01999"></a>01999                                   fset, user_perms, group_perms,
<a name="l02000"></a>02000                                   status, event,
<a name="l02001"></a>02001                                   &amp;scanned_dirs, &amp;total_size))
<a name="l02002"></a>02002                 <span class="keywordflow">goto</span> out;
<a name="l02003"></a>02003 
<a name="l02004"></a>02004             <span class="keywordflow">break</span>;
<a name="l02005"></a>02005         <span class="keywordflow">case</span> <a class="code" href="wt-monitor-structs_8h.html#a157d5577a5b2f5986037d0d09c7dc77da256004e731640556897a39e2a38617b1">WT_EVENT_DELETE</a>:
<a name="l02006"></a>02006             <span class="keywordflow">if</span> (!is_path_writable(user_perms, group_perms,
<a name="l02007"></a>02007                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>)) {
<a name="l02008"></a>02008                 seaf_debug (<span class="stringliteral">&quot;%s is not writable, ignore.\n&quot;</span>, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>);
<a name="l02009"></a>02009                 <span class="keywordflow">break</span>;
<a name="l02010"></a>02010             }
<a name="l02011"></a>02011 
<a name="l02012"></a>02012             <span class="keywordflow">if</span> (check_locked_file_before_remove (fset, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>)) {
<a name="l02013"></a>02013                 not_found = FALSE;
<a name="l02014"></a>02014                 <a class="code" href="index_8c.html#a86bf1084dfc4e0057a52b4da1922de9b">remove_from_index_with_prefix</a> (istate, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>, &amp;not_found);
<a name="l02015"></a>02015                 <span class="keywordflow">if</span> (not_found)
<a name="l02016"></a>02016                     scan_subtree_for_deletion (istate,
<a name="l02017"></a>02017                                                repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>,
<a name="l02018"></a>02018                                                ignore_list, fset,
<a name="l02019"></a>02019                                                user_perms, group_perms,
<a name="l02020"></a>02020                                                repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>,
<a name="l02021"></a>02021                                                &amp;scanned_del_dirs);
<a name="l02022"></a>02022 
<a name="l02023"></a>02023                 try_add_empty_parent_dir_entry_from_wt (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>,
<a name="l02024"></a>02024                                                         istate,
<a name="l02025"></a>02025                                                         ignore_list,
<a name="l02026"></a>02026                                                         event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>);
<a name="l02027"></a>02027             }
<a name="l02028"></a>02028             <span class="keywordflow">break</span>;
<a name="l02029"></a>02029         <span class="keywordflow">case</span> <a class="code" href="wt-monitor-structs_8h.html#a157d5577a5b2f5986037d0d09c7dc77da140f77fddf110c85cdd1b9423a9065fe">WT_EVENT_RENAME</a>:
<a name="l02030"></a>02030             <span class="keywordflow">if</span> (!is_path_writable(user_perms, group_perms,
<a name="l02031"></a>02031                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>) ||
<a name="l02032"></a>02032                 !is_path_writable(user_perms, group_perms,
<a name="l02033"></a>02033                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>, event-&gt;<a class="code" href="structWTEvent.html#a7d1cd3fd19bad012b8e0117b910efc23">new_path</a>)) {
<a name="l02034"></a>02034                 seaf_debug (<span class="stringliteral">&quot;Rename: %s or %s is not writable, ignore.\n&quot;</span>,
<a name="l02035"></a>02035                             event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>, event-&gt;<a class="code" href="structWTEvent.html#a7d1cd3fd19bad012b8e0117b910efc23">new_path</a>);
<a name="l02036"></a>02036                 <span class="keywordflow">break</span>;
<a name="l02037"></a>02037             }
<a name="l02038"></a>02038 
<a name="l02039"></a>02039             <span class="comment">/* If the destination path is ignored, just remove the source path. */</span>
<a name="l02040"></a>02040             <span class="keywordflow">if</span> (check_full_path_ignore (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, event-&gt;<a class="code" href="structWTEvent.html#a7d1cd3fd19bad012b8e0117b910efc23">new_path</a>,
<a name="l02041"></a>02041                                         ignore_list)) {
<a name="l02042"></a>02042                 <span class="keywordflow">if</span> (check_locked_file_before_remove (fset, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>)) {
<a name="l02043"></a>02043                     not_found = FALSE;
<a name="l02044"></a>02044                     <a class="code" href="index_8c.html#a86bf1084dfc4e0057a52b4da1922de9b">remove_from_index_with_prefix</a> (istate, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>, &amp;not_found);
<a name="l02045"></a>02045                     <span class="keywordflow">if</span> (not_found)
<a name="l02046"></a>02046                         scan_subtree_for_deletion (istate,
<a name="l02047"></a>02047                                                    repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>,
<a name="l02048"></a>02048                                                    ignore_list, fset,
<a name="l02049"></a>02049                                                    user_perms, group_perms,
<a name="l02050"></a>02050                                                    repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>,
<a name="l02051"></a>02051                                                    &amp;scanned_del_dirs);
<a name="l02052"></a>02052                 }
<a name="l02053"></a>02053                 <span class="keywordflow">break</span>;
<a name="l02054"></a>02054             }
<a name="l02055"></a>02055 
<a name="l02056"></a>02056             <span class="keywordflow">if</span> (check_locked_file_before_remove (fset, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>)) {
<a name="l02057"></a>02057                 not_found = FALSE;
<a name="l02058"></a>02058                 <a class="code" href="index_8c.html#a56d1945a0677d925b25c610d613aeefc">rename_index_entries</a> (istate, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>, event-&gt;<a class="code" href="structWTEvent.html#a7d1cd3fd19bad012b8e0117b910efc23">new_path</a>, &amp;not_found);
<a name="l02059"></a>02059                 <span class="keywordflow">if</span> (not_found)
<a name="l02060"></a>02060                     scan_subtree_for_deletion (istate,
<a name="l02061"></a>02061                                                repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>,
<a name="l02062"></a>02062                                                ignore_list, fset,
<a name="l02063"></a>02063                                                user_perms, group_perms,
<a name="l02064"></a>02064                                                repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>,
<a name="l02065"></a>02065                                                &amp;scanned_del_dirs);
<a name="l02066"></a>02066 
<a name="l02067"></a>02067                 <span class="comment">/* Moving files out of a dir may make it empty. */</span>
<a name="l02068"></a>02068                 try_add_empty_parent_dir_entry_from_wt (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>,
<a name="l02069"></a>02069                                                         istate,
<a name="l02070"></a>02070                                                         ignore_list,
<a name="l02071"></a>02071                                                         event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>);
<a name="l02072"></a>02072             }
<a name="l02073"></a>02073 
<a name="l02074"></a>02074             <a class="code" href="struct__AddOptions.html">AddOptions</a> <a class="code" href="seaf-fuse_8c.html#a75a4394524b5a85ecc4c8998e0ef680f">options</a>;
<a name="l02075"></a>02075             memset (&amp;options, 0, <span class="keyword">sizeof</span>(options));
<a name="l02076"></a>02076             options.<a class="code" href="struct__AddOptions.html#a97b5b11d9f2d4b00559bb1eec13ae35a">fset</a> = fset;
<a name="l02077"></a>02077             options.<a class="code" href="struct__AddOptions.html#a5dbb2227dac4de70d96c8ee8727acf16">is_repo_ro</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>;
<a name="l02078"></a>02078 
<a name="l02079"></a>02079             <span class="comment">/* We should always scan the destination to compare with the renamed</span>
<a name="l02080"></a>02080 <span class="comment">             * index entries. For example, in the following case:</span>
<a name="l02081"></a>02081 <span class="comment">             * 1. file a.txt is updated;</span>
<a name="l02082"></a>02082 <span class="comment">             * 2. a.txt is moved to test/a.txt;</span>
<a name="l02083"></a>02083 <span class="comment">             * If the two operations are executed in a batch, the updated content</span>
<a name="l02084"></a>02084 <span class="comment">             * of a.txt won&#39;t be committed if we don&#39;t scan the destination, because</span>
<a name="l02085"></a>02085 <span class="comment">             * when we process the update event, a.txt is already not in its original</span>
<a name="l02086"></a>02086 <span class="comment">             * place.</span>
<a name="l02087"></a>02087 <span class="comment">             */</span>
<a name="l02088"></a>02088             add_recursive (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a>,
<a name="l02089"></a>02089                            istate, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, event-&gt;<a class="code" href="structWTEvent.html#a7d1cd3fd19bad012b8e0117b910efc23">new_path</a>,
<a name="l02090"></a>02090                            crypt, FALSE, ignore_list,
<a name="l02091"></a>02091                            NULL, NULL, &amp;options);
<a name="l02092"></a>02092             <span class="keywordflow">break</span>;
<a name="l02093"></a>02093         <span class="keywordflow">case</span> <a class="code" href="wt-monitor-structs_8h.html#a157d5577a5b2f5986037d0d09c7dc77daae8b08725cbb4052898d7fc8b5a1baaf">WT_EVENT_ATTRIB</a>:
<a name="l02094"></a>02094             <span class="keywordflow">if</span> (!is_path_writable(user_perms, group_perms,
<a name="l02095"></a>02095                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>)) {
<a name="l02096"></a>02096                 seaf_debug (<span class="stringliteral">&quot;%s is not writable, ignore.\n&quot;</span>, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>);
<a name="l02097"></a>02097                 <span class="keywordflow">break</span>;
<a name="l02098"></a>02098             }
<a name="l02099"></a>02099             update_ce_mode (istate, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, event-&gt;<a class="code" href="structWTEvent.html#ab76241d50ea50552beb651c5970a5336">path</a>);
<a name="l02100"></a>02100             <span class="keywordflow">break</span>;
<a name="l02101"></a>02101         <span class="keywordflow">case</span> <a class="code" href="wt-monitor-structs_8h.html#a157d5577a5b2f5986037d0d09c7dc77dae6e953fead9819ab676a5a592a0aa015">WT_EVENT_OVERFLOW</a>:
<a name="l02102"></a>02102             seaf_warning (<span class="stringliteral">&quot;Kernel event queue overflowed, fall back to scan.\n&quot;</span>);
<a name="l02103"></a>02103             scan_worktree_for_changes (istate, repo, crypt, ignore_list, fset,
<a name="l02104"></a>02104                                        user_perms, group_perms);
<a name="l02105"></a>02105             <span class="keywordflow">break</span>;
<a name="l02106"></a>02106         }
<a name="l02107"></a>02107 
<a name="l02108"></a>02108         <span class="keywordflow">if</span> (event == last_event) {
<a name="l02109"></a>02109             <a class="code" href="wt-monitor-structs_8c.html#a76c039c5a442f1c80b9570b950cc82c8">wt_event_free</a> (event);
<a name="l02110"></a>02110             seaf_message (<span class="stringliteral">&quot;All events are processed for repo %s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02111"></a>02111             status-&gt;<a class="code" href="structWTStatus.html#a80a104859f6aa1d369f07efaf3c6bcfc">partial_commit</a> = FALSE;
<a name="l02112"></a>02112             <span class="keywordflow">break</span>;
<a name="l02113"></a>02113         } <span class="keywordflow">else</span>
<a name="l02114"></a>02114             <a class="code" href="wt-monitor-structs_8c.html#a76c039c5a442f1c80b9570b950cc82c8">wt_event_free</a> (event);
<a name="l02115"></a>02115     }
<a name="l02116"></a>02116 
<a name="l02117"></a>02117 out:
<a name="l02118"></a>02118     <a class="code" href="wt-monitor-structs_8c.html#a53f5564385cb3d86fff013bf7ee17e86">wt_status_unref</a> (status);
<a name="l02119"></a>02119     <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (scanned_dirs);
<a name="l02120"></a>02120     <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (scanned_del_dirs);
<a name="l02121"></a>02121 
<a name="l02122"></a>02122     <span class="keywordflow">return</span> 0;
<a name="l02123"></a>02123 }
<a name="l02124"></a>02124 
<a name="l02125"></a>02125 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02126"></a>02126 handle_unmerged_index_entries (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate,
<a name="l02127"></a>02127                                <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt, GList *ignore_list)
<a name="l02128"></a>02128 {
<a name="l02129"></a>02129     <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> **ce_array = istate-&gt;<a class="code" href="structindex__state.html#a8aa7a8aa984ec5a39ff2eee96412db07">cache</a>;
<a name="l02130"></a>02130     <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *ce;
<a name="l02131"></a>02131     <span class="keywordtype">char</span> path[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
<a name="l02132"></a>02132     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
<a name="l02133"></a>02133     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l02134"></a>02134     <span class="keywordtype">int</span> ret;
<a name="l02135"></a>02135     GList *unmerged_paths = NULL;
<a name="l02136"></a>02136     <span class="keywordtype">char</span> *last_name = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02137"></a>02137 
<a name="l02138"></a>02138 retry:
<a name="l02139"></a>02139     <span class="keywordflow">for</span> (i = 0; i &lt; istate-&gt;<a class="code" href="structindex__state.html#a15b38cdd30ad2374bc12da429f39312f">cache_nr</a>; ++i) {
<a name="l02140"></a>02140         ce = ce_array[i];
<a name="l02141"></a>02141 
<a name="l02142"></a>02142         <span class="keywordflow">if</span> (<a class="code" href="index_8h.html#a0379c411a3dc56c2d5ac0b1fcce22ead">ce_stage</a>(ce) == 0)
<a name="l02143"></a>02143             <span class="keywordflow">continue</span>;
<a name="l02144"></a>02144 
<a name="l02145"></a>02145         snprintf (path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, ce-&gt;<a class="code" href="structcache__entry.html#a792e4ea24cb16c76abe3229651e414a0">name</a>);
<a name="l02146"></a>02146         ret = <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (path, &amp;st);
<a name="l02147"></a>02147 
<a name="l02148"></a>02148         <span class="keywordflow">if</span> (S_ISDIR (ce-&gt;<a class="code" href="structcache__entry.html#a5fcbcc4e7265ae8150f136380ed92c05">ce_mode</a>)) {
<a name="l02149"></a>02149             <span class="keywordflow">if</span> (ret &lt; 0 || !S_ISDIR (st.st_mode)
<a name="l02150"></a>02150                 || !is_empty_dir (path, ignore_list))
<a name="l02151"></a>02151                 ce-&gt;<a class="code" href="structcache__entry.html#a4dab14fd813a1bb6b67352674ff4afb2">ce_flags</a> |= <a class="code" href="index_8h.html#aa5ee599d9d7af67f19dba204ce9030c0">CE_REMOVE</a>;
<a name="l02152"></a>02152             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp (ce-&gt;<a class="code" href="structcache__entry.html#a792e4ea24cb16c76abe3229651e414a0">name</a>, last_name) != 0) {
<a name="l02153"></a>02153                 unmerged_paths = g_list_append (unmerged_paths, g_strdup(ce-&gt;<a class="code" href="structcache__entry.html#a792e4ea24cb16c76abe3229651e414a0">name</a>));
<a name="l02154"></a>02154                 last_name = ce-&gt;<a class="code" href="structcache__entry.html#a792e4ea24cb16c76abe3229651e414a0">name</a>;
<a name="l02155"></a>02155             }
<a name="l02156"></a>02156         } <span class="keywordflow">else</span> {
<a name="l02157"></a>02157             <span class="keywordflow">if</span> (ret &lt; 0 || !S_ISREG (st.st_mode))
<a name="l02158"></a>02158                 ce-&gt;<a class="code" href="structcache__entry.html#a4dab14fd813a1bb6b67352674ff4afb2">ce_flags</a> |= <a class="code" href="index_8h.html#aa5ee599d9d7af67f19dba204ce9030c0">CE_REMOVE</a>;
<a name="l02159"></a>02159             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp (ce-&gt;<a class="code" href="structcache__entry.html#a792e4ea24cb16c76abe3229651e414a0">name</a>, last_name) != 0) {
<a name="l02160"></a>02160                 unmerged_paths = g_list_append (unmerged_paths, g_strdup(ce-&gt;<a class="code" href="structcache__entry.html#a792e4ea24cb16c76abe3229651e414a0">name</a>));
<a name="l02161"></a>02161                 last_name = ce-&gt;<a class="code" href="structcache__entry.html#a792e4ea24cb16c76abe3229651e414a0">name</a>;
<a name="l02162"></a>02162             }
<a name="l02163"></a>02163         }
<a name="l02164"></a>02164     }
<a name="l02165"></a>02165 
<a name="l02166"></a>02166     <a class="code" href="index_8c.html#a12825d79310dd67cd238e49161be5bfd">remove_marked_cache_entries</a> (istate);
<a name="l02167"></a>02167 
<a name="l02168"></a>02168     GList *ptr;
<a name="l02169"></a>02169     <span class="keywordtype">char</span> *ce_name;
<a name="l02170"></a>02170     <span class="keywordflow">for</span> (ptr = unmerged_paths; ptr; ptr = ptr-&gt;next) {
<a name="l02171"></a>02171         ce_name = ptr-&gt;data;
<a name="l02172"></a>02172         snprintf (path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, ce_name);
<a name="l02173"></a>02173         ret = <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (path, &amp;st);
<a name="l02174"></a>02174         <span class="keywordflow">if</span> (ret &lt; 0) {
<a name="l02175"></a>02175             seaf_warning (<span class="stringliteral">&quot;Failed to stat %s: %s.\n&quot;</span>, path, strerror(errno));
<a name="l02176"></a>02176             <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (unmerged_paths);
<a name="l02177"></a>02177             unmerged_paths = NULL;
<a name="l02178"></a>02178             <span class="keywordflow">goto</span> retry;
<a name="l02179"></a>02179         }
<a name="l02180"></a>02180 
<a name="l02181"></a>02181         <span class="keywordflow">if</span> (S_ISDIR (st.st_mode)) {
<a name="l02182"></a>02182             <span class="keywordflow">if</span> (is_empty_dir (path, ignore_list))
<a name="l02183"></a>02183                 <a class="code" href="index_8c.html#a0a287241a624545389a63a0b22a98513">add_empty_dir_to_index</a> (istate, ce_name, &amp;st);
<a name="l02184"></a>02184         } <span class="keywordflow">else</span> {
<a name="l02185"></a>02185             gboolean added;
<a name="l02186"></a>02186             <a class="code" href="index_8c.html#ac412654516da827612dd5db31703b32c">add_to_index</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, istate, ce_name, path,
<a name="l02187"></a>02187                           &amp;st, 0, crypt, index_cb, repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a>, &amp;added);
<a name="l02188"></a>02188         }
<a name="l02189"></a>02189     }
<a name="l02190"></a>02190 
<a name="l02191"></a>02191     <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (unmerged_paths);
<a name="l02192"></a>02192 }
<a name="l02193"></a>02193 
<a name="l02194"></a>02194 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02195"></a>02195 index_add (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate,
<a name="l02196"></a>02196            gboolean is_force_commit, gboolean handle_unmerged)
<a name="l02197"></a>02197 {
<a name="l02198"></a>02198     <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt = NULL;
<a name="l02199"></a>02199     <a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset = NULL;
<a name="l02200"></a>02200     GList *ignore_list = NULL;
<a name="l02201"></a>02201     GList *user_perms = NULL, *group_perms = NULL;
<a name="l02202"></a>02202     GList *ptr;
<a name="l02203"></a>02203     <span class="keywordtype">int</span> ret = 0;
<a name="l02204"></a>02204 
<a name="l02205"></a>02205     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
<a name="l02206"></a>02206         crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ad951f63e287f0ea14c863937afea6779">enc_key</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a7ad105e1fab206035f1c585c25e0dc94">enc_iv</a>);
<a name="l02207"></a>02207     }
<a name="l02208"></a>02208 
<a name="l02209"></a>02209 <span class="preprocessor">#ifdef WIN32</span>
<a name="l02210"></a>02210 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a> &gt; 0)
<a name="l02211"></a>02211         fset = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a06294e91365be10d46a356d427f62e07">seaf_repo_manager_get_locked_file_set</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02212"></a>02212 <span class="preprocessor">#endif</span>
<a name="l02213"></a>02213 <span class="preprocessor"></span>
<a name="l02214"></a>02214     ignore_list = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#abdf6d76830c08b16b49d76e2f34037a5">seaf_repo_load_ignore_files</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>);
<a name="l02215"></a>02215 
<a name="l02216"></a>02216     user_perms = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ad00e4e927e8099054e29e532cae9c5e4">seaf_repo_manager_load_folder_perms</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l02217"></a>02217                                                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l02218"></a>02218                                                       <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa664ef9343772c1e5e20606d23a2f696a">FOLDER_PERM_TYPE_USER</a>);
<a name="l02219"></a>02219     group_perms = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ad00e4e927e8099054e29e532cae9c5e4">seaf_repo_manager_load_folder_perms</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l02220"></a>02220                                                        repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l02221"></a>02221                                                        <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa55b4f2e55f412aa138091a6f350d16de">FOLDER_PERM_TYPE_GROUP</a>);
<a name="l02222"></a>02222 
<a name="l02223"></a>02223     <span class="keywordflow">if</span> (!is_force_commit) {
<a name="l02224"></a>02224         <span class="keywordflow">if</span> (apply_worktree_changes_to_index (repo, istate, crypt, ignore_list, fset,
<a name="l02225"></a>02225                                              user_perms, group_perms) &lt; 0) {
<a name="l02226"></a>02226             seaf_warning (<span class="stringliteral">&quot;Failed to apply worktree changes to index.\n&quot;</span>);
<a name="l02227"></a>02227             ret = -1;
<a name="l02228"></a>02228         }
<a name="l02229"></a>02229     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (scan_worktree_for_changes (istate, repo, crypt, ignore_list, fset,
<a name="l02230"></a>02230                                           user_perms, group_perms) &lt; 0) {
<a name="l02231"></a>02231         seaf_warning (<span class="stringliteral">&quot;Failed to scan worktree for changes.\n&quot;</span>);
<a name="l02232"></a>02232         ret = -1;
<a name="l02233"></a>02233     }
<a name="l02234"></a>02234 
<a name="l02235"></a>02235     <span class="comment">/* If the index contains unmerged entries, check and remove those entries</span>
<a name="l02236"></a>02236 <span class="comment">     * in the end, in cases where they were not completely handled in</span>
<a name="l02237"></a>02237 <span class="comment">     * apply_worktree_changes_to_index().</span>
<a name="l02238"></a>02238 <span class="comment">     */</span>
<a name="l02239"></a>02239     <span class="keywordflow">if</span> (handle_unmerged)
<a name="l02240"></a>02240         handle_unmerged_index_entries (repo, istate, crypt, ignore_list);
<a name="l02241"></a>02241 
<a name="l02242"></a>02242     <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ae640da4e7db6b316cd0e3c1ba463f9bd">seaf_repo_free_ignore_files</a> (ignore_list);
<a name="l02243"></a>02243 
<a name="l02244"></a>02244 <span class="preprocessor">#ifdef WIN32</span>
<a name="l02245"></a>02245 <span class="preprocessor"></span>    <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ab44c57f5e23996e5eb807f7c84f443f5">locked_file_set_free</a> (fset);
<a name="l02246"></a>02246 <span class="preprocessor">#endif</span>
<a name="l02247"></a>02247 <span class="preprocessor"></span>
<a name="l02248"></a>02248     <span class="keywordflow">for</span> (ptr = user_perms; ptr; ptr = ptr-&gt;next)
<a name="l02249"></a>02249         <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a16e4a5db024bcc5baf2ef8a3f0623a41">folder_perm_free</a> ((<a class="code" href="struct__FolderPerm.html">FolderPerm</a> *)ptr-&gt;data);
<a name="l02250"></a>02250     g_list_free (user_perms);
<a name="l02251"></a>02251     <span class="keywordflow">for</span> (ptr = group_perms; ptr; ptr = ptr-&gt;next)
<a name="l02252"></a>02252         <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a16e4a5db024bcc5baf2ef8a3f0623a41">folder_perm_free</a> ((<a class="code" href="struct__FolderPerm.html">FolderPerm</a> *)ptr-&gt;data);
<a name="l02253"></a>02253     g_list_free (group_perms);
<a name="l02254"></a>02254 
<a name="l02255"></a>02255     g_free (crypt);
<a name="l02256"></a>02256 
<a name="l02257"></a>02257     <span class="keywordflow">return</span> ret;
<a name="l02258"></a>02258 }
<a name="l02259"></a>02259 
<a name="l02260"></a>02260 <span class="comment">/*</span>
<a name="l02261"></a>02261 <span class="comment"> * Add the files in @worktree to index and return the corresponding</span>
<a name="l02262"></a>02262 <span class="comment"> * @root_id. The repo doesn&#39;t have to exist.</span>
<a name="l02263"></a>02263 <span class="comment"> */</span>
<a name="l02264"></a>02264 <span class="keywordtype">int</span>
<a name="l02265"></a><a class="code" href="daemon_2repo-mgr_8c.html#aadbf4eb74b53f6423e7eabf716f5f4fb">02265</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#aadbf4eb74b53f6423e7eabf716f5f4fb">seaf_repo_index_worktree_files</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l02266"></a>02266                                 <span class="keywordtype">int</span> repo_version,
<a name="l02267"></a>02267                                 <span class="keyword">const</span> <span class="keywordtype">char</span> *modifier,
<a name="l02268"></a>02268                                 <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree,
<a name="l02269"></a>02269                                 <span class="keyword">const</span> <span class="keywordtype">char</span> *passwd,
<a name="l02270"></a>02270                                 <span class="keywordtype">int</span> enc_version,
<a name="l02271"></a>02271                                 <span class="keyword">const</span> <span class="keywordtype">char</span> *random_key,
<a name="l02272"></a>02272                                 <span class="keywordtype">char</span> *root_id)
<a name="l02273"></a>02273 {
<a name="l02274"></a>02274     <span class="keywordtype">char</span> <a class="code" href="index_8c.html#a35caece3e3575d32521f820a8f0a24a7">index_path</a>[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
<a name="l02275"></a>02275     <span class="keyword">struct </span><a class="code" href="structindex__state.html">index_state</a> istate;
<a name="l02276"></a>02276     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> key[32], iv[16];
<a name="l02277"></a>02277     <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt = NULL;
<a name="l02278"></a>02278     <span class="keyword">struct </span><a class="code" href="structcache__tree.html">cache_tree</a> *it = NULL;
<a name="l02279"></a>02279     GList *ignore_list = NULL;
<a name="l02280"></a>02280 
<a name="l02281"></a>02281     memset (&amp;istate, 0, <span class="keyword">sizeof</span>(istate));
<a name="l02282"></a>02282     snprintf (index_path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>, repo_id);
<a name="l02283"></a>02283 
<a name="l02284"></a>02284     <span class="comment">/* Remove existing index. An existing index signifies an interrupted</span>
<a name="l02285"></a>02285 <span class="comment">     * clone-merge. Removing it assures that new blocks from the worktree</span>
<a name="l02286"></a>02286 <span class="comment">     * get added into the repo again (they&#39;re deleted by GC).</span>
<a name="l02287"></a>02287 <span class="comment">     */</span>
<a name="l02288"></a>02288     <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a26f091009701c5a9d1886b9d6ceb9c8e">seaf_util_unlink</a> (index_path);
<a name="l02289"></a>02289 
<a name="l02290"></a>02290     <span class="keywordflow">if</span> (<a class="code" href="index_8c.html#a0f9de2761514c9136fb4b9c5541ef6f8">read_index_from</a> (&amp;istate, index_path, repo_version) &lt; 0) {
<a name="l02291"></a>02291         g_warning (<span class="stringliteral">&quot;Failed to load index.\n&quot;</span>);
<a name="l02292"></a>02292         <span class="keywordflow">return</span> -1;
<a name="l02293"></a>02293     }
<a name="l02294"></a>02294 
<a name="l02295"></a>02295     <span class="keywordflow">if</span> (passwd != NULL) {
<a name="l02296"></a>02296         <span class="keywordflow">if</span> (<a class="code" href="seafile-crypt_8c.html#af0dc7b06b352baa5469b21beec40f73a">seafile_decrypt_repo_enc_key</a> (enc_version, passwd,
<a name="l02297"></a>02297                                           random_key, key, iv) &lt; 0) {
<a name="l02298"></a>02298             seaf_warning (<span class="stringliteral">&quot;Failed to generate enc key for repo %s.\n&quot;</span>, repo_id);
<a name="l02299"></a>02299             <span class="keywordflow">goto</span> error;
<a name="l02300"></a>02300         }
<a name="l02301"></a>02301         crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (enc_version, key, iv);
<a name="l02302"></a>02302     }
<a name="l02303"></a>02303 
<a name="l02304"></a>02304     ignore_list = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#abdf6d76830c08b16b49d76e2f34037a5">seaf_repo_load_ignore_files</a>(worktree);
<a name="l02305"></a>02305 
<a name="l02306"></a>02306     <span class="comment">/* Add empty dir to index. Otherwise if the repo on relay contains an empty</span>
<a name="l02307"></a>02307 <span class="comment">     * dir, we&#39;ll fail to detect fast-forward relationship later.</span>
<a name="l02308"></a>02308 <span class="comment">     */</span>
<a name="l02309"></a>02309     <span class="keywordflow">if</span> (add_recursive (repo_id, repo_version, modifier,
<a name="l02310"></a>02310                        &amp;istate, worktree, <span class="stringliteral">&quot;&quot;</span>, crypt, FALSE, ignore_list,
<a name="l02311"></a>02311                        NULL, NULL, NULL) &lt; 0)
<a name="l02312"></a>02312         <span class="keywordflow">goto</span> error;
<a name="l02313"></a>02313 
<a name="l02314"></a>02314     remove_deleted (&amp;istate, worktree, <span class="stringliteral">&quot;&quot;</span>, ignore_list, NULL, NULL, NULL, FALSE);
<a name="l02315"></a>02315 
<a name="l02316"></a>02316     it = <a class="code" href="cache-tree_8c.html#a120475d6b5efa481c3acb318724e308d">cache_tree</a> ();
<a name="l02317"></a>02317     <span class="keywordflow">if</span> (<a class="code" href="cache-tree_8c.html#abc55c58b49566383d534a4ab37d0b255">cache_tree_update</a> (repo_id, repo_version, worktree,
<a name="l02318"></a>02318                            it, istate.<a class="code" href="structindex__state.html#a8aa7a8aa984ec5a39ff2eee96412db07">cache</a>, istate.<a class="code" href="structindex__state.html#a15b38cdd30ad2374bc12da429f39312f">cache_nr</a>,
<a name="l02319"></a>02319                            0, 0, <a class="code" href="vc-utils_8c.html#a4b086cedacd72882aa71266710f3d869">commit_trees_cb</a>) &lt; 0) {
<a name="l02320"></a>02320         g_warning (<span class="stringliteral">&quot;Failed to build cache tree&quot;</span>);
<a name="l02321"></a>02321         <span class="keywordflow">goto</span> error;
<a name="l02322"></a>02322     }
<a name="l02323"></a>02323 
<a name="l02324"></a>02324     <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a> (it-&gt;<a class="code" href="structcache__tree.html#a662341619d00b9fd6cbd25ea74cc22dd">sha1</a>, root_id, 20);
<a name="l02325"></a>02325 
<a name="l02326"></a>02326     <span class="keywordflow">if</span> (<a class="code" href="vc-utils_8c.html#ab93fff6b962d6fd7482c95d17c8bf6eb">update_index</a> (&amp;istate, index_path) &lt; 0)
<a name="l02327"></a>02327         <span class="keywordflow">goto</span> error;
<a name="l02328"></a>02328 
<a name="l02329"></a>02329     <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
<a name="l02330"></a>02330     g_free (crypt);
<a name="l02331"></a>02331     <span class="keywordflow">if</span> (it)
<a name="l02332"></a>02332         <a class="code" href="cache-tree_8c.html#a4d76480b03fedc601676872518b3bc71">cache_tree_free</a> (&amp;it);
<a name="l02333"></a>02333     <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ae640da4e7db6b316cd0e3c1ba463f9bd">seaf_repo_free_ignore_files</a>(ignore_list);
<a name="l02334"></a>02334     <span class="keywordflow">return</span> 0;
<a name="l02335"></a>02335 
<a name="l02336"></a>02336 error:
<a name="l02337"></a>02337     <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
<a name="l02338"></a>02338     g_free (crypt);
<a name="l02339"></a>02339     <span class="keywordflow">if</span> (it)
<a name="l02340"></a>02340         <a class="code" href="cache-tree_8c.html#a4d76480b03fedc601676872518b3bc71">cache_tree_free</a> (&amp;it);
<a name="l02341"></a>02341     <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ae640da4e7db6b316cd0e3c1ba463f9bd">seaf_repo_free_ignore_files</a>(ignore_list);
<a name="l02342"></a>02342     <span class="keywordflow">return</span> -1;
<a name="l02343"></a>02343 }
<a name="l02344"></a>02344 
<a name="l02345"></a>02345 gboolean
<a name="l02346"></a><a class="code" href="daemon_2repo-mgr_8c.html#a461e72948bba5928329e269ad395e293">02346</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a461e72948bba5928329e269ad395e293">seaf_repo_is_worktree_changed</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l02347"></a>02347 {
<a name="l02348"></a>02348     <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>;
<a name="l02349"></a>02349     GList *res = NULL, *p;
<a name="l02350"></a>02350     <span class="keyword">struct </span><a class="code" href="structindex__state.html">index_state</a> istate;
<a name="l02351"></a>02351     <span class="keywordtype">char</span> <a class="code" href="index_8c.html#a35caece3e3575d32521f820a8f0a24a7">index_path</a>[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
<a name="l02352"></a>02352 
<a name="l02353"></a>02353     <a class="code" href="structDiffEntry.html">DiffEntry</a> *de;
<a name="l02354"></a>02354     <span class="keywordtype">int</span> pos;
<a name="l02355"></a>02355     <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *ce;
<a name="l02356"></a>02356     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> sb;
<a name="l02357"></a>02357     <span class="keywordtype">char</span> *full_path;
<a name="l02358"></a>02358 
<a name="l02359"></a>02359     <span class="keywordflow">if</span> (!check_worktree_common (repo))
<a name="l02360"></a>02360         <span class="keywordflow">return</span> FALSE;
<a name="l02361"></a>02361 
<a name="l02362"></a>02362     memset (&amp;istate, 0, <span class="keyword">sizeof</span>(istate));
<a name="l02363"></a>02363     snprintf (index_path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02364"></a>02364     <span class="keywordflow">if</span> (<a class="code" href="index_8c.html#a0f9de2761514c9136fb4b9c5541ef6f8">read_index_from</a> (&amp;istate, index_path, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>) &lt; 0) {
<a name="l02365"></a>02365         repo-&gt;<a class="code" href="struct__SeafRepo.html#a5377f474b9e1cc96a69ab26d5da8e244">index_corrupted</a> = TRUE;
<a name="l02366"></a>02366         g_warning (<span class="stringliteral">&quot;Failed to load index.\n&quot;</span>);
<a name="l02367"></a>02367         <span class="keywordflow">goto</span> error;
<a name="l02368"></a>02368     }
<a name="l02369"></a>02369     repo-&gt;<a class="code" href="struct__SeafRepo.html#a5377f474b9e1cc96a69ab26d5da8e244">index_corrupted</a> = FALSE;
<a name="l02370"></a>02370 
<a name="l02371"></a>02371     <a class="code" href="status_8c.html#aedde1fa2f15b7c6a05b14c2dcc04f6be">wt_status_collect_changes_worktree</a> (&amp;istate, &amp;res, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>);
<a name="l02372"></a>02372     <span class="keywordflow">if</span> (res != NULL)
<a name="l02373"></a>02373         <span class="keywordflow">goto</span> changed;
<a name="l02374"></a>02374 
<a name="l02375"></a>02375     <a class="code" href="status_8c.html#ae9ecb4f4ad21d7ff69f36e16cc6996de">wt_status_collect_untracked</a> (&amp;istate, &amp;res, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, should_ignore);
<a name="l02376"></a>02376     <span class="keywordflow">if</span> (res != NULL)
<a name="l02377"></a>02377         <span class="keywordflow">goto</span> changed;
<a name="l02378"></a>02378 
<a name="l02379"></a>02379     <a class="code" href="status_8c.html#a5aaef0b3a73d20b9f422c9d39f0a2325">wt_status_collect_changes_index</a> (&amp;istate, &amp;res, repo);
<a name="l02380"></a>02380     <span class="keywordflow">if</span> (res != NULL)
<a name="l02381"></a>02381         <span class="keywordflow">goto</span> changed;
<a name="l02382"></a>02382 
<a name="l02383"></a>02383     <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
<a name="l02384"></a>02384 
<a name="l02385"></a>02385     repo-&gt;<a class="code" href="struct__SeafRepo.html#a0c328bbabc240a013e03b822a5304933">wt_changed</a> = FALSE;
<a name="l02386"></a>02386 
<a name="l02387"></a>02387     <span class="comment">/* g_debug (&quot;%s worktree is changed\n&quot;, repo-&gt;id); */</span>
<a name="l02388"></a>02388     <span class="keywordflow">return</span> FALSE;
<a name="l02389"></a>02389 
<a name="l02390"></a>02390 changed:
<a name="l02391"></a>02391 
<a name="l02392"></a>02392     g_message (<span class="stringliteral">&quot;Worktree changes (at most 5 files are shown):\n&quot;</span>);
<a name="l02393"></a>02393     <span class="keywordtype">int</span> i = 0;
<a name="l02394"></a>02394     <span class="keywordflow">for</span> (p = res; p != NULL &amp;&amp; i &lt; 5; p = p-&gt;next, ++i) {
<a name="l02395"></a>02395         de = p-&gt;data;
<a name="l02396"></a>02396 
<a name="l02397"></a>02397         full_path = g_build_path (<span class="stringliteral">&quot;/&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, NULL);
<a name="l02398"></a>02398         <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (full_path, &amp;sb) &lt; 0) {
<a name="l02399"></a>02399             g_warning (<span class="stringliteral">&quot;Failed to stat %s: %s.\n&quot;</span>, full_path, strerror(errno));
<a name="l02400"></a>02400             g_free (full_path);
<a name="l02401"></a>02401             <span class="keywordflow">continue</span>;
<a name="l02402"></a>02402         }
<a name="l02403"></a>02403         g_free (full_path);
<a name="l02404"></a>02404 
<a name="l02405"></a>02405         pos = <a class="code" href="index_8c.html#a1f5ad45bcfb5a2dcc3fae542fa293d4a">index_name_pos</a> (&amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, strlen(de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>));
<a name="l02406"></a>02406         <span class="keywordflow">if</span> (pos &lt; 0) {
<a name="l02407"></a>02407             g_warning (<span class="stringliteral">&quot;Cannot find diff entry %s in index.\n&quot;</span>, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);
<a name="l02408"></a>02408             <span class="keywordflow">continue</span>;
<a name="l02409"></a>02409         }
<a name="l02410"></a>02410         ce = istate.<a class="code" href="structindex__state.html#a8aa7a8aa984ec5a39ff2eee96412db07">cache</a>[pos];
<a name="l02411"></a>02411 
<a name="l02412"></a>02412         g_message (<span class="stringliteral">&quot;type: %c, status: %c, name: %s, &quot;</span>
<a name="l02413"></a>02413                    <span class="stringliteral">&quot;ce mtime: %&quot;</span>G_GINT64_FORMAT<span class="stringliteral">&quot;, ce size: %&quot;</span> G_GUINT64_FORMAT <span class="stringliteral">&quot;, &quot;</span>
<a name="l02414"></a>02414                    <span class="stringliteral">&quot;file mtime: %d, file size: %&quot;</span> G_GUINT64_FORMAT <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l02415"></a>02415                    de-&gt;<a class="code" href="structDiffEntry.html#a07ebfe57746e5fc5017603545ab04b47">type</a>, de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a>, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>,
<a name="l02416"></a>02416                    ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a>, ce-&gt;<a class="code" href="structcache__entry.html#a869a62534c704e5d24ee26cf2f7b86b7">ce_size</a>, (<span class="keywordtype">int</span>)sb.st_mtime, sb.st_size);
<a name="l02417"></a>02417     }
<a name="l02418"></a>02418 
<a name="l02419"></a>02419     <span class="keywordflow">for</span> (p = res; p; p = p-&gt;next) {
<a name="l02420"></a>02420         de = p-&gt;data;
<a name="l02421"></a>02421         <a class="code" href="diff-simple_8c.html#abb759117ec4b4aca623768424487f5da">diff_entry_free</a> (de);
<a name="l02422"></a>02422     }
<a name="l02423"></a>02423     g_list_free (res);
<a name="l02424"></a>02424 
<a name="l02425"></a>02425     <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
<a name="l02426"></a>02426 
<a name="l02427"></a>02427     repo-&gt;<a class="code" href="struct__SeafRepo.html#a0c328bbabc240a013e03b822a5304933">wt_changed</a> = TRUE;
<a name="l02428"></a>02428 
<a name="l02429"></a>02429     <span class="comment">/* g_debug (&quot;%s worktree is changed\n&quot;, repo-&gt;id); */</span>
<a name="l02430"></a>02430     <span class="keywordflow">return</span> TRUE;
<a name="l02431"></a>02431 
<a name="l02432"></a>02432 error:
<a name="l02433"></a>02433     <span class="keywordflow">return</span> FALSE;
<a name="l02434"></a>02434 }
<a name="l02435"></a>02435 
<a name="l02436"></a>02436 <span class="comment">/*</span>
<a name="l02437"></a>02437 <span class="comment"> * Generate commit description based on files to be commited.</span>
<a name="l02438"></a>02438 <span class="comment"> * It only checks index status, not worktree status.</span>
<a name="l02439"></a>02439 <span class="comment"> * So it should be called after &quot;add&quot; completes.</span>
<a name="l02440"></a>02440 <span class="comment"> * This way we can always get the correct list of files to be</span>
<a name="l02441"></a>02441 <span class="comment"> * commited, even we were interrupted in the last add-commit</span>
<a name="l02442"></a>02442 <span class="comment"> * sequence.</span>
<a name="l02443"></a>02443 <span class="comment"> */</span>
<a name="l02444"></a>02444 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l02445"></a>02445 gen_commit_description (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate)
<a name="l02446"></a>02446 {
<a name="l02447"></a>02447     GList *p;
<a name="l02448"></a>02448     GList *results = NULL;
<a name="l02449"></a>02449     <span class="keywordtype">char</span> *desc;
<a name="l02450"></a>02450     
<a name="l02451"></a>02451     <a class="code" href="status_8c.html#a5aaef0b3a73d20b9f422c9d39f0a2325">wt_status_collect_changes_index</a> (istate, &amp;results, repo);
<a name="l02452"></a>02452     <a class="code" href="diff-simple_8c.html#a8007e76befdeace050ccd548d21657f6">diff_resolve_empty_dirs</a> (&amp;results);
<a name="l02453"></a>02453     <a class="code" href="diff-simple_8c.html#a3d936e2ea0a740cbdc9bbab7113b3742">diff_resolve_renames</a> (&amp;results);
<a name="l02454"></a>02454 
<a name="l02455"></a>02455     desc = <a class="code" href="diff-simple_8c.html#a661dddff1df554c9c4da96ee30e44c8d">diff_results_to_description</a> (results);
<a name="l02456"></a>02456     <span class="keywordflow">if</span> (!desc)
<a name="l02457"></a>02457         <span class="keywordflow">return</span> NULL;
<a name="l02458"></a>02458 
<a name="l02459"></a>02459     <span class="keywordflow">for</span> (p = results; p; p = p-&gt;next) {
<a name="l02460"></a>02460         <a class="code" href="structDiffEntry.html">DiffEntry</a> *de = p-&gt;data;
<a name="l02461"></a>02461         <a class="code" href="diff-simple_8c.html#abb759117ec4b4aca623768424487f5da">diff_entry_free</a> (de);
<a name="l02462"></a>02462     }
<a name="l02463"></a>02463     g_list_free (results);
<a name="l02464"></a>02464 
<a name="l02465"></a>02465     <span class="keywordflow">return</span> desc;
<a name="l02466"></a>02466 }
<a name="l02467"></a>02467 
<a name="l02468"></a>02468 gboolean
<a name="l02469"></a><a class="code" href="daemon_2repo-mgr_8c.html#a79db93d798035e3e07f48c2ad32d87f1">02469</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a79db93d798035e3e07f48c2ad32d87f1">seaf_repo_is_index_unmerged</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l02470"></a>02470 {
<a name="l02471"></a>02471     <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>;
<a name="l02472"></a>02472     <span class="keyword">struct </span><a class="code" href="structindex__state.html">index_state</a> istate;
<a name="l02473"></a>02473     <span class="keywordtype">char</span> <a class="code" href="index_8c.html#a35caece3e3575d32521f820a8f0a24a7">index_path</a>[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
<a name="l02474"></a>02474     gboolean ret = FALSE;
<a name="l02475"></a>02475 
<a name="l02476"></a>02476     <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>)
<a name="l02477"></a>02477         <span class="keywordflow">return</span> FALSE;
<a name="l02478"></a>02478 
<a name="l02479"></a>02479     memset (&amp;istate, 0, <span class="keyword">sizeof</span>(istate));
<a name="l02480"></a>02480     snprintf (index_path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02481"></a>02481     <span class="keywordflow">if</span> (<a class="code" href="index_8c.html#a0f9de2761514c9136fb4b9c5541ef6f8">read_index_from</a> (&amp;istate, index_path, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>) &lt; 0) {
<a name="l02482"></a>02482         g_warning (<span class="stringliteral">&quot;Failed to load index.\n&quot;</span>);
<a name="l02483"></a>02483         <span class="keywordflow">return</span> FALSE;
<a name="l02484"></a>02484     }
<a name="l02485"></a>02485 
<a name="l02486"></a>02486     <span class="keywordflow">if</span> (<a class="code" href="index_8c.html#a177df5d9afa8392326c1a1cef68f08c0">unmerged_index</a> (&amp;istate))
<a name="l02487"></a>02487         ret = TRUE;
<a name="l02488"></a>02488 
<a name="l02489"></a>02489     <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
<a name="l02490"></a>02490     <span class="keywordflow">return</span> ret;
<a name="l02491"></a>02491 }
<a name="l02492"></a>02492 
<a name="l02493"></a>02493 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02494"></a>02494 commit_tree (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <span class="keyword">struct</span> <a class="code" href="structcache__tree.html">cache_tree</a> *it,
<a name="l02495"></a>02495              <span class="keyword">const</span> <span class="keywordtype">char</span> *desc, <span class="keywordtype">char</span> commit_id[],
<a name="l02496"></a>02496              gboolean unmerged)
<a name="l02497"></a>02497 {
<a name="l02498"></a>02498     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit;
<a name="l02499"></a>02499     <span class="keywordtype">char</span> root_id[41];
<a name="l02500"></a>02500 
<a name="l02501"></a>02501     <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a> (it-&gt;<a class="code" href="structcache__tree.html#a662341619d00b9fd6cbd25ea74cc22dd">sha1</a>, root_id, 20);
<a name="l02502"></a>02502 
<a name="l02503"></a>02503     commit = <a class="code" href="commit-mgr_8c.html#afe68dfa15b1bbd8557b044b1b1b58dc2">seaf_commit_new</a> (NULL, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, root_id,
<a name="l02504"></a>02504                               repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a> ? repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a>
<a name="l02505"></a>02505                               : <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a7acba9a9723ea082afbcd1032be5b6de">base</a>.<a class="code" href="struct__CcnetSessionBase.html#acb921a00a3498928d68d4a5b42c1ece4">user_name</a>,
<a name="l02506"></a>02506                               <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a7acba9a9723ea082afbcd1032be5b6de">base</a>.<a class="code" href="struct__CcnetSessionBase.html#a00a892cc14aa52514c079730b460852e">id</a>,
<a name="l02507"></a>02507                               desc, 0);
<a name="l02508"></a>02508 
<a name="l02509"></a>02509     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>)
<a name="l02510"></a>02510         commit-&gt;<a class="code" href="struct__SeafCommit.html#a24518f58c804153742e9976049da8512">parent_id</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l02511"></a>02511 
<a name="l02512"></a>02512     <span class="keywordflow">if</span> (unmerged) {
<a name="l02513"></a>02513         <a class="code" href="structSeafRepoMergeInfo.html">SeafRepoMergeInfo</a> minfo;
<a name="l02514"></a>02514 
<a name="l02515"></a>02515         <span class="comment">/* Don&#39;t use head commit of master branch since that branch may have</span>
<a name="l02516"></a>02516 <span class="comment">         * been updated after the last merge.</span>
<a name="l02517"></a>02517 <span class="comment">         */</span>
<a name="l02518"></a>02518         memset (&amp;minfo, 0, <span class="keyword">sizeof</span>(minfo));
<a name="l02519"></a>02519         <span class="keywordflow">if</span> (<a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ac0e4e52af419d42f34ce53d368777070">seaf_repo_manager_get_merge_info</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, &amp;minfo) &lt; 0) {
<a name="l02520"></a>02520             seaf_warning (<span class="stringliteral">&quot;Failed to get merge info of repo %.10s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02521"></a>02521             <span class="keywordflow">return</span> -1;
<a name="l02522"></a>02522         }
<a name="l02523"></a>02523 
<a name="l02524"></a>02524         commit-&gt;<a class="code" href="struct__SeafCommit.html#aad2ebe1498cc25f837554456cbcd31f5">second_parent_id</a> = g_strdup (minfo.<a class="code" href="structSeafRepoMergeInfo.html#a1f6af16dd70282a1c33333a4b6520219">remote_head</a>);
<a name="l02525"></a>02525         commit-&gt;<a class="code" href="struct__SeafCommit.html#a78d20b7c73d8d7645fc5d6410cb1a4be">new_merge</a> = TRUE;
<a name="l02526"></a>02526         commit-&gt;<a class="code" href="struct__SeafCommit.html#a5e522b729c973107a36257cc1d60badb">conflict</a> = TRUE;
<a name="l02527"></a>02527     }
<a name="l02528"></a>02528 
<a name="l02529"></a>02529     <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a39a9a41ffdfc324f3c935251d9e14d51">seaf_repo_to_commit</a> (repo, commit);
<a name="l02530"></a>02530 
<a name="l02531"></a>02531     <span class="keywordflow">if</span> (<a class="code" href="commit-mgr_8c.html#a7c138604e615440b65741b77e71248c6">seaf_commit_manager_add_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>, commit) &lt; 0)
<a name="l02532"></a>02532         <span class="keywordflow">return</span> -1;
<a name="l02533"></a>02533 
<a name="l02534"></a>02534     <a class="code" href="branch-mgr_8c.html#a7a776ebd084d2335050c68d9a2e10c18">seaf_branch_set_commit</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>);
<a name="l02535"></a>02535     <a class="code" href="branch-mgr_8c.html#aab1588f5228eaf4405efb239a9ed5680">seaf_branch_manager_update_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>);
<a name="l02536"></a>02536 
<a name="l02537"></a>02537     strcpy (commit_id, commit-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>);
<a name="l02538"></a>02538     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
<a name="l02539"></a>02539 
<a name="l02540"></a>02540     <span class="keywordflow">return</span> 0;
<a name="l02541"></a>02541 }
<a name="l02542"></a>02542 
<a name="l02543"></a>02543 <span class="keyword">static</span> gboolean
<a name="l02544"></a>02544 need_handle_unmerged_index (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate)
<a name="l02545"></a>02545 {
<a name="l02546"></a>02546     <span class="keywordflow">if</span> (!<a class="code" href="index_8c.html#a177df5d9afa8392326c1a1cef68f08c0">unmerged_index</a> (istate))
<a name="l02547"></a>02547         <span class="keywordflow">return</span> FALSE;
<a name="l02548"></a>02548 
<a name="l02549"></a>02549     <span class="comment">/* Syncing with an existing directory may require a real merge.</span>
<a name="l02550"></a>02550 <span class="comment">     * If the merge produced conflicts, the index will be unmerged.</span>
<a name="l02551"></a>02551 <span class="comment">     * But we don&#39;t want to generate a merge commit in this case.</span>
<a name="l02552"></a>02552 <span class="comment">     * An &quot;index&quot; branch should exist in this case.</span>
<a name="l02553"></a>02553 <span class="comment">     */</span>
<a name="l02554"></a>02554     <span class="keywordflow">if</span> (<a class="code" href="branch-mgr_8c.html#a228e7abb258c810aa8b8e02b9c368e10">seaf_branch_manager_branch_exists</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="stringliteral">&quot;index&quot;</span>))
<a name="l02555"></a>02555         <span class="keywordflow">return</span> FALSE;
<a name="l02556"></a>02556 
<a name="l02557"></a>02557     <span class="keywordflow">return</span> TRUE;
<a name="l02558"></a>02558 }
<a name="l02559"></a>02559 
<a name="l02560"></a>02560 <span class="keyword">static</span> <span class="keywordtype">int</span> 
<a name="l02561"></a>02561 print_index (<span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate)
<a name="l02562"></a>02562 {
<a name="l02563"></a>02563     <span class="keywordtype">int</span> i;
<a name="l02564"></a>02564     <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *ce;
<a name="l02565"></a>02565     <span class="keywordtype">char</span> <span class="keywordtype">id</span>[41];
<a name="l02566"></a>02566     seaf_message (<span class="stringliteral">&quot;Totally %u entries in index, version %u.\n&quot;</span>,
<a name="l02567"></a>02567                   istate-&gt;<a class="code" href="structindex__state.html#a15b38cdd30ad2374bc12da429f39312f">cache_nr</a>, istate-&gt;<a class="code" href="structindex__state.html#a0fb0d6a2dabae448b68f04e75ffc1612">version</a>);
<a name="l02568"></a>02568     <span class="keywordflow">for</span> (i = 0; i &lt; istate-&gt;<a class="code" href="structindex__state.html#a15b38cdd30ad2374bc12da429f39312f">cache_nr</a>; ++i) {
<a name="l02569"></a>02569         ce = istate-&gt;<a class="code" href="structindex__state.html#a8aa7a8aa984ec5a39ff2eee96412db07">cache</a>[i];
<a name="l02570"></a>02570         <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a> (ce-&gt;<a class="code" href="structcache__entry.html#a119ab5c5e9db495e6e5f8d301f01421c">sha1</a>, <span class="keywordtype">id</span>, 20);
<a name="l02571"></a>02571         seaf_message (<span class="stringliteral">&quot;%s, %s, %o, %&quot;</span>G_GINT64_FORMAT<span class="stringliteral">&quot;, %s, %&quot;</span>G_GINT64_FORMAT<span class="stringliteral">&quot;, %d\n&quot;</span>,
<a name="l02572"></a>02572                       ce-&gt;<a class="code" href="structcache__entry.html#a792e4ea24cb16c76abe3229651e414a0">name</a>, <span class="keywordtype">id</span>, ce-&gt;<a class="code" href="structcache__entry.html#a5fcbcc4e7265ae8150f136380ed92c05">ce_mode</a>, 
<a name="l02573"></a>02573                       ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a>, ce-&gt;<a class="code" href="structcache__entry.html#a786aa5bc6234542fe202023bcf721afd">modifier</a>, ce-&gt;<a class="code" href="structcache__entry.html#a869a62534c704e5d24ee26cf2f7b86b7">ce_size</a>, <a class="code" href="index_8h.html#a0379c411a3dc56c2d5ac0b1fcce22ead">ce_stage</a>(ce));
<a name="l02574"></a>02574     }
<a name="l02575"></a>02575 
<a name="l02576"></a>02576     <span class="keywordflow">return</span> 0;
<a name="l02577"></a>02577 }
<a name="l02578"></a>02578 
<a name="l02579"></a>02579 <span class="keywordtype">char</span> *
<a name="l02580"></a><a class="code" href="daemon_2repo-mgr_8c.html#af591ba84286a82123c728debd33ff300">02580</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af591ba84286a82123c728debd33ff300">seaf_repo_index_commit</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <span class="keyword">const</span> <span class="keywordtype">char</span> *desc, gboolean is_force_commit,
<a name="l02581"></a>02581                         GError **error)
<a name="l02582"></a>02582 {
<a name="l02583"></a>02583     <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>;
<a name="l02584"></a>02584     <span class="keyword">struct </span><a class="code" href="structindex__state.html">index_state</a> istate;
<a name="l02585"></a>02585     <span class="keyword">struct </span><a class="code" href="structcache__tree.html">cache_tree</a> *it;
<a name="l02586"></a>02586     <span class="keywordtype">char</span> <a class="code" href="index_8c.html#a35caece3e3575d32521f820a8f0a24a7">index_path</a>[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
<a name="l02587"></a>02587     <span class="keywordtype">char</span> commit_id[41];
<a name="l02588"></a>02588     gboolean unmerged = FALSE;
<a name="l02589"></a>02589 
<a name="l02590"></a>02590     <span class="keywordflow">if</span> (!check_worktree_common (repo))
<a name="l02591"></a>02591         <span class="keywordflow">return</span> NULL;
<a name="l02592"></a>02592 
<a name="l02593"></a>02593     memset (&amp;istate, 0, <span class="keyword">sizeof</span>(istate));
<a name="l02594"></a>02594     snprintf (index_path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02595"></a>02595     <span class="keywordflow">if</span> (<a class="code" href="index_8c.html#a0f9de2761514c9136fb4b9c5541ef6f8">read_index_from</a> (&amp;istate, index_path, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>) &lt; 0) {
<a name="l02596"></a>02596         g_warning (<span class="stringliteral">&quot;Failed to load index.\n&quot;</span>);
<a name="l02597"></a>02597         g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;Internal data structure error&quot;</span>);
<a name="l02598"></a>02598         <span class="keywordflow">return</span> NULL;
<a name="l02599"></a>02599     }
<a name="l02600"></a>02600 
<a name="l02601"></a>02601     <span class="keywordflow">if</span> (need_handle_unmerged_index (repo, &amp;istate))
<a name="l02602"></a>02602         unmerged = TRUE;
<a name="l02603"></a>02603 
<a name="l02604"></a>02604     <span class="keywordflow">if</span> (index_add (repo, &amp;istate, is_force_commit, unmerged) &lt; 0) {
<a name="l02605"></a>02605         g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;Failed to add&quot;</span>);
<a name="l02606"></a>02606         <span class="keywordflow">goto</span> error;
<a name="l02607"></a>02607     }
<a name="l02608"></a>02608 
<a name="l02609"></a>02609     <span class="comment">/* Commit before updating the index, so that new blocks won&#39;t be GC&#39;ed. */</span>
<a name="l02610"></a>02610 
<a name="l02611"></a>02611     <span class="keywordtype">char</span> *my_desc = g_strdup(desc);
<a name="l02612"></a>02612     <span class="keywordflow">if</span> (my_desc[0] == <span class="charliteral">&#39;\0&#39;</span>) {
<a name="l02613"></a>02613         <span class="keywordtype">char</span> *gen_desc = gen_commit_description (repo, &amp;istate);
<a name="l02614"></a>02614         <span class="keywordflow">if</span> (!gen_desc) {
<a name="l02615"></a>02615             <span class="comment">/* error not set. */</span>
<a name="l02616"></a>02616             g_free (my_desc);
<a name="l02617"></a>02617 
<a name="l02618"></a>02618             <span class="comment">/* Still need to update index even nothing to commit. */</span>
<a name="l02619"></a>02619             <a class="code" href="vc-utils_8c.html#ab93fff6b962d6fd7482c95d17c8bf6eb">update_index</a> (&amp;istate, index_path);
<a name="l02620"></a>02620             <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
<a name="l02621"></a>02621 
<a name="l02622"></a>02622             <span class="keywordflow">return</span> NULL;
<a name="l02623"></a>02623         }
<a name="l02624"></a>02624         g_free (my_desc);
<a name="l02625"></a>02625         my_desc = gen_desc;
<a name="l02626"></a>02626     }
<a name="l02627"></a>02627 
<a name="l02628"></a>02628     it = <a class="code" href="cache-tree_8c.html#a120475d6b5efa481c3acb318724e308d">cache_tree</a> ();
<a name="l02629"></a>02629     <span class="keywordflow">if</span> (<a class="code" href="cache-tree_8c.html#abc55c58b49566383d534a4ab37d0b255">cache_tree_update</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
<a name="l02630"></a>02630                            repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>,
<a name="l02631"></a>02631                            it, istate.<a class="code" href="structindex__state.html#a8aa7a8aa984ec5a39ff2eee96412db07">cache</a>,
<a name="l02632"></a>02632                            istate.<a class="code" href="structindex__state.html#a15b38cdd30ad2374bc12da429f39312f">cache_nr</a>, 0, 0, <a class="code" href="vc-utils_8c.html#a4b086cedacd72882aa71266710f3d869">commit_trees_cb</a>) &lt; 0) {
<a name="l02633"></a>02633         g_warning (<span class="stringliteral">&quot;Failed to build cache tree&quot;</span>);
<a name="l02634"></a>02634         g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;Internal data structure error&quot;</span>);
<a name="l02635"></a>02635         <a class="code" href="cache-tree_8c.html#a4d76480b03fedc601676872518b3bc71">cache_tree_free</a> (&amp;it);
<a name="l02636"></a>02636         <span class="keywordflow">goto</span> error;
<a name="l02637"></a>02637     }
<a name="l02638"></a>02638 
<a name="l02639"></a>02639     <span class="keywordflow">if</span> (commit_tree (repo, it, my_desc, commit_id, unmerged) &lt; 0) {
<a name="l02640"></a>02640         g_warning (<span class="stringliteral">&quot;Failed to save commit file&quot;</span>);
<a name="l02641"></a>02641         g_set_error (error, <a class="code" href="seafile-4_81_82_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;Internal error&quot;</span>);
<a name="l02642"></a>02642         <a class="code" href="cache-tree_8c.html#a4d76480b03fedc601676872518b3bc71">cache_tree_free</a> (&amp;it);
<a name="l02643"></a>02643         <span class="keywordflow">goto</span> error;
<a name="l02644"></a>02644     }
<a name="l02645"></a>02645     g_free (my_desc);
<a name="l02646"></a>02646     <a class="code" href="cache-tree_8c.html#a4d76480b03fedc601676872518b3bc71">cache_tree_free</a> (&amp;it);
<a name="l02647"></a>02647 
<a name="l02648"></a>02648     <span class="keywordflow">if</span> (<a class="code" href="vc-utils_8c.html#ab93fff6b962d6fd7482c95d17c8bf6eb">update_index</a> (&amp;istate, index_path) &lt; 0)
<a name="l02649"></a>02649         <span class="keywordflow">goto</span> error;
<a name="l02650"></a>02650 
<a name="l02651"></a>02651     <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
<a name="l02652"></a>02652 
<a name="l02653"></a>02653     g_signal_emit_by_name (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>, <span class="stringliteral">&quot;repo-committed&quot;</span>, repo);
<a name="l02654"></a>02654 
<a name="l02655"></a>02655     <span class="keywordflow">return</span> g_strdup(commit_id);
<a name="l02656"></a>02656 
<a name="l02657"></a>02657 error:
<a name="l02658"></a>02658     <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
<a name="l02659"></a>02659     <span class="keywordflow">return</span> NULL;
<a name="l02660"></a>02660 }
<a name="l02661"></a>02661 
<a name="l02662"></a>02662 <span class="preprocessor">#ifdef DEBUG_UNPACK_TREES</span>
<a name="l02663"></a>02663 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02664"></a>02664 print_unpack_result (<span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *result)
<a name="l02665"></a>02665 {
<a name="l02666"></a>02666         <span class="keywordtype">int</span> i;
<a name="l02667"></a>02667         <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *ce;
<a name="l02668"></a>02668 
<a name="l02669"></a>02669         <span class="keywordflow">for</span> (i = 0; i &lt; result-&gt;<a class="code" href="structindex__state.html#a15b38cdd30ad2374bc12da429f39312f">cache_nr</a>; ++i) {
<a name="l02670"></a>02670                 ce = result-&gt;<a class="code" href="structindex__state.html#a8aa7a8aa984ec5a39ff2eee96412db07">cache</a>[i];
<a name="l02671"></a>02671                 printf (<span class="stringliteral">&quot;%s\t&quot;</span>, ce-&gt;<a class="code" href="structcache__entry.html#a792e4ea24cb16c76abe3229651e414a0">name</a>);
<a name="l02672"></a>02672                 <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="structcache__entry.html#a4dab14fd813a1bb6b67352674ff4afb2">ce_flags</a> &amp; <a class="code" href="index_8h.html#a1d46becf22e28d6f8bffa8ee949acb45">CE_UPDATE</a>)
<a name="l02673"></a>02673                         printf (<span class="stringliteral">&quot;update/add\n&quot;</span>);
<a name="l02674"></a>02674                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="structcache__entry.html#a4dab14fd813a1bb6b67352674ff4afb2">ce_flags</a> &amp; <a class="code" href="index_8h.html#ab8db831d893aba29775bf7251661296b">CE_WT_REMOVE</a>)
<a name="l02675"></a>02675                         printf (<span class="stringliteral">&quot;remove\n&quot;</span>);
<a name="l02676"></a>02676                 <span class="keywordflow">else</span>
<a name="l02677"></a>02677                         printf (<span class="stringliteral">&quot;unchange\n&quot;</span>);
<a name="l02678"></a>02678         }
<a name="l02679"></a>02679 }
<a name="l02680"></a>02680 
<a name="l02681"></a>02681 <span class="keyword">static</span> <span class="keywordtype">int</span> 
<a name="l02682"></a>02682 print_index (<span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate)
<a name="l02683"></a>02683 {
<a name="l02684"></a>02684     printf (<span class="stringliteral">&quot;Index timestamp: %d\n&quot;</span>, istate-&gt;<a class="code" href="structindex__state.html#aba21746d004309949f3af631aced813a">timestamp</a>.<a class="code" href="structcache__time.html#ad79ea7590f31a5cc560ab4809d31562d">sec</a>);
<a name="l02685"></a>02685 
<a name="l02686"></a>02686     <span class="keywordtype">int</span> i;
<a name="l02687"></a>02687     <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *ce;
<a name="l02688"></a>02688     <span class="keywordtype">char</span> <span class="keywordtype">id</span>[41];
<a name="l02689"></a>02689     printf (<span class="stringliteral">&quot;Totally %u entries in index.\n&quot;</span>, istate-&gt;<a class="code" href="structindex__state.html#a15b38cdd30ad2374bc12da429f39312f">cache_nr</a>);
<a name="l02690"></a>02690     <span class="keywordflow">for</span> (i = 0; i &lt; istate-&gt;<a class="code" href="structindex__state.html#a15b38cdd30ad2374bc12da429f39312f">cache_nr</a>; ++i) {
<a name="l02691"></a>02691         ce = istate-&gt;<a class="code" href="structindex__state.html#a8aa7a8aa984ec5a39ff2eee96412db07">cache</a>[i];
<a name="l02692"></a>02692         <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a> (ce-&gt;<a class="code" href="structcache__entry.html#a119ab5c5e9db495e6e5f8d301f01421c">sha1</a>, <span class="keywordtype">id</span>, 20);
<a name="l02693"></a>02693         printf (<span class="stringliteral">&quot;%s\t%s\t%o\t%d\t%d\n&quot;</span>, ce-&gt;<a class="code" href="structcache__entry.html#a792e4ea24cb16c76abe3229651e414a0">name</a>, <span class="keywordtype">id</span>, ce-&gt;<a class="code" href="structcache__entry.html#a5fcbcc4e7265ae8150f136380ed92c05">ce_mode</a>, 
<a name="l02694"></a>02694                 ce-&gt;<a class="code" href="structcache__entry.html#a5258a9a9e2fc3bfcd4859049912b65e8">ce_ctime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a>, ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a>);
<a name="l02695"></a>02695     }
<a name="l02696"></a>02696 
<a name="l02697"></a>02697     <span class="keywordflow">return</span> 0;
<a name="l02698"></a>02698 }
<a name="l02699"></a>02699 <span class="preprocessor">#endif  </span><span class="comment">/* DEBUG_UNPACK_TREES */</span>
<a name="l02700"></a>02700 
<a name="l02701"></a>02701 <span class="keywordtype">int</span>
<a name="l02702"></a><a class="code" href="daemon_2repo-mgr_8c.html#a7923c5fb7b957a121f1b2616a8d66745">02702</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a7923c5fb7b957a121f1b2616a8d66745">seaf_repo_checkout_commit</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit, gboolean recover_merge,
<a name="l02703"></a>02703                            <span class="keywordtype">char</span> **error)
<a name="l02704"></a>02704 {
<a name="l02705"></a>02705     <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>;
<a name="l02706"></a>02706     <span class="keywordtype">char</span> <a class="code" href="index_8c.html#a35caece3e3575d32521f820a8f0a24a7">index_path</a>[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
<a name="l02707"></a>02707     <span class="keyword">struct </span><a class="code" href="structtree__desc.html">tree_desc</a> trees[2];
<a name="l02708"></a>02708     <span class="keyword">struct </span><a class="code" href="structunpack__trees__options.html">unpack_trees_options</a> topts;
<a name="l02709"></a>02709     <span class="keyword">struct </span><a class="code" href="structindex__state.html">index_state</a> istate;
<a name="l02710"></a>02710     gboolean initial_checkout;
<a name="l02711"></a>02711     GString *err_msgs;
<a name="l02712"></a>02712     <span class="keywordtype">int</span> ret = 0;
<a name="l02713"></a>02713 
<a name="l02714"></a>02714     memset (&amp;istate, 0, <span class="keyword">sizeof</span>(istate));
<a name="l02715"></a>02715     snprintf (index_path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02716"></a>02716     <span class="keywordflow">if</span> (<a class="code" href="index_8c.html#a0f9de2761514c9136fb4b9c5541ef6f8">read_index_from</a> (&amp;istate, index_path, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>) &lt; 0) {
<a name="l02717"></a>02717         g_warning (<span class="stringliteral">&quot;Failed to load index.\n&quot;</span>);
<a name="l02718"></a>02718         <span class="keywordflow">return</span> -1;
<a name="l02719"></a>02719     }
<a name="l02720"></a>02720     repo-&gt;<a class="code" href="struct__SeafRepo.html#a5377f474b9e1cc96a69ab26d5da8e244">index_corrupted</a> = FALSE;
<a name="l02721"></a>02721     initial_checkout = <a class="code" href="index_8c.html#a9527d61c2cbd37e4f1691dfc0f543a5d">is_index_unborn</a>(&amp;istate);
<a name="l02722"></a>02722 
<a name="l02723"></a>02723     <span class="keywordflow">if</span> (!initial_checkout) {
<a name="l02724"></a>02724         <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>) {
<a name="l02725"></a>02725             <span class="comment">/* TODO: Set error string*/</span>
<a name="l02726"></a>02726             g_warning (<span class="stringliteral">&quot;Repo corrupt: Index exists but head branch is not set\n&quot;</span>);
<a name="l02727"></a>02727             <span class="keywordflow">return</span> -1;
<a name="l02728"></a>02728         }
<a name="l02729"></a>02729         <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head =
<a name="l02730"></a>02730             <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l02731"></a>02731                                             repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
<a name="l02732"></a>02732                                             repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l02733"></a>02733         <span class="keywordflow">if</span> (!head) {
<a name="l02734"></a>02734             seaf_warning (<span class="stringliteral">&quot;Failed to get commit %s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l02735"></a>02735             <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
<a name="l02736"></a>02736             <span class="keywordflow">return</span> -1;
<a name="l02737"></a>02737         }
<a name="l02738"></a>02738         <a class="code" href="seaf-tree-walk_8c.html#a7b310abaeb185b8918eb2a9fc843e097">fill_tree_descriptor</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, &amp;trees[0], head-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>);
<a name="l02739"></a>02739         <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (head);
<a name="l02740"></a>02740     } <span class="keywordflow">else</span> {
<a name="l02741"></a>02741         <a class="code" href="seaf-tree-walk_8c.html#a7b310abaeb185b8918eb2a9fc843e097">fill_tree_descriptor</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, &amp;trees[0], NULL);
<a name="l02742"></a>02742     }
<a name="l02743"></a>02743     <a class="code" href="seaf-tree-walk_8c.html#a7b310abaeb185b8918eb2a9fc843e097">fill_tree_descriptor</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, &amp;trees[1], commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>);
<a name="l02744"></a>02744 
<a name="l02745"></a>02745     <span class="comment">/* 2-way merge to the new branch */</span>
<a name="l02746"></a>02746     memset(&amp;topts, 0, <span class="keyword">sizeof</span>(topts));
<a name="l02747"></a>02747     memcpy (topts.<a class="code" href="structunpack__trees__options.html#a7270e145ba04fb2e7ba054a3af66d98c">repo_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, 36);
<a name="l02748"></a>02748     topts.<a class="code" href="structunpack__trees__options.html#a62f5e734252135d55f83a54015e1a4c6">version</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>;
<a name="l02749"></a>02749     topts.<a class="code" href="structunpack__trees__options.html#a4a9bd1ef1d5e87af93c7ddce399e6b5f">base</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>;
<a name="l02750"></a>02750     topts.<a class="code" href="structunpack__trees__options.html#ac3c76fcf0737031ee5783304d59c4865">head_idx</a> = -1;
<a name="l02751"></a>02751     topts.<a class="code" href="structunpack__trees__options.html#a5781bfdf9479b84caf218a475e48476c">src_index</a> = &amp;istate;
<a name="l02752"></a>02752     <span class="comment">/* topts.dst_index = &amp;istate; */</span>
<a name="l02753"></a>02753     topts.<a class="code" href="structunpack__trees__options.html#ab6aee2819c20555d29c0e7f18b4a3df3">initial_checkout</a> = initial_checkout;
<a name="l02754"></a>02754     topts.<a class="code" href="structunpack__trees__options.html#a41b55dd4c6ef32c4938cc1b53936aacf">update</a> = 1;
<a name="l02755"></a>02755     topts.<a class="code" href="structunpack__trees__options.html#a3173b72b67869712cae670d071a73d44">merge</a> = 1;
<a name="l02756"></a>02756     topts.<a class="code" href="structunpack__trees__options.html#a41e304e12d552f063099ac1fb1e9a7f3">gently</a> = 0;
<a name="l02757"></a>02757     topts.<a class="code" href="structunpack__trees__options.html#a90508a87b1070ef3a68d410c50982aac">verbose_update</a> = 0;
<a name="l02758"></a>02758     <span class="comment">/* topts.debug_unpack = 1; */</span>
<a name="l02759"></a>02759     topts.<a class="code" href="structunpack__trees__options.html#adb26db5d8b826c55137939df5122c859">fn</a> = <a class="code" href="unpack-trees_8c.html#a37f4950a59ff1ce85ed1bf91eeea7054">twoway_merge</a>;
<a name="l02760"></a>02760     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
<a name="l02761"></a>02761         topts.<a class="code" href="structunpack__trees__options.html#a6d3d0c296c9b75e94ad49befce418bda">crypt</a> = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>, 
<a name="l02762"></a>02762                                          repo-&gt;<a class="code" href="struct__SeafRepo.html#ad951f63e287f0ea14c863937afea6779">enc_key</a>, 
<a name="l02763"></a>02763                                          repo-&gt;<a class="code" href="struct__SeafRepo.html#a7ad105e1fab206035f1c585c25e0dc94">enc_iv</a>);
<a name="l02764"></a>02764     }
<a name="l02765"></a>02765 
<a name="l02766"></a>02766     <span class="keywordflow">if</span> (<a class="code" href="unpack-trees_8c.html#a5bfe365644fb33537027e988fb891e08">unpack_trees</a> (2, trees, &amp;topts) &lt; 0) {
<a name="l02767"></a>02767         g_warning (<span class="stringliteral">&quot;Failed to merge commit %s with work tree.\n&quot;</span>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>);
<a name="l02768"></a>02768         ret = -1;
<a name="l02769"></a>02769         <span class="keywordflow">goto</span> out;
<a name="l02770"></a>02770     }
<a name="l02771"></a>02771 
<a name="l02772"></a>02772 <span class="preprocessor">#ifdef WIN32</span>
<a name="l02773"></a>02773 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!initial_checkout &amp;&amp; !recover_merge &amp;&amp;
<a name="l02774"></a>02774         <a class="code" href="vc-utils_8h.html#a60f3e68c113c902bbc43e308317a259e">files_locked_on_windows</a>(&amp;topts.<a class="code" href="structunpack__trees__options.html#a091d6e59892b9009809e45dfb38c24da">result</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>)) {
<a name="l02775"></a>02775         <a class="code" href="seafile-4_81_82_2lib_2include_8h.html#ae5a5c3cadbc1f6e2363d25fc0fb46084">g_debug</a> (<span class="stringliteral">&quot;[checkout] files are locked, quit checkout now.\n&quot;</span>);
<a name="l02776"></a>02776         ret = -1;
<a name="l02777"></a>02777         <span class="keywordflow">goto</span> out;
<a name="l02778"></a>02778     }
<a name="l02779"></a>02779 <span class="preprocessor">#endif</span>
<a name="l02780"></a>02780 <span class="preprocessor"></span>
<a name="l02781"></a>02781     <span class="keywordtype">int</span> *finished_entries = NULL;
<a name="l02782"></a>02782     <a class="code" href="structCheckoutTask.html">CheckoutTask</a> *c_task = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#abe8b32b343e5e7d2d06018e398011151">seaf_repo_manager_get_checkout_task</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02783"></a>02783     <span class="keywordflow">if</span> (c_task) {
<a name="l02784"></a>02784         finished_entries = &amp;c_task-&gt;<a class="code" href="structCheckoutTask.html#a870604697553d88bc67e5a3b4ef0549b">finished_files</a>;
<a name="l02785"></a>02785     }
<a name="l02786"></a>02786     <span class="keywordflow">if</span> (<a class="code" href="vc-utils_8c.html#a4b8dc271b94740a5cb1e32827ee88d29">update_worktree</a> (&amp;topts, recover_merge,
<a name="l02787"></a>02787                          initial_checkout ? NULL : commit-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>,
<a name="l02788"></a>02788                          commit-&gt;<a class="code" href="struct__SeafCommit.html#ab19d020b7c936d11821fe0b836aa548e">creator_name</a>,
<a name="l02789"></a>02789                          finished_entries) &lt; 0) {
<a name="l02790"></a>02790         g_warning (<span class="stringliteral">&quot;Failed to update worktree.\n&quot;</span>);
<a name="l02791"></a>02791         <span class="comment">/* Still finish checkout even have I/O errors. */</span>
<a name="l02792"></a>02792     }
<a name="l02793"></a>02793 
<a name="l02794"></a>02794     <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
<a name="l02795"></a>02795     istate = topts.<a class="code" href="structunpack__trees__options.html#a091d6e59892b9009809e45dfb38c24da">result</a>;
<a name="l02796"></a>02796     <span class="keywordflow">if</span> (<a class="code" href="vc-utils_8c.html#ab93fff6b962d6fd7482c95d17c8bf6eb">update_index</a> (&amp;istate, index_path) &lt; 0) {
<a name="l02797"></a>02797         g_warning (<span class="stringliteral">&quot;Failed to update index.\n&quot;</span>);
<a name="l02798"></a>02798         ret = -1;
<a name="l02799"></a>02799         <span class="keywordflow">goto</span> out;
<a name="l02800"></a>02800     }
<a name="l02801"></a>02801 
<a name="l02802"></a>02802 out:
<a name="l02803"></a>02803     err_msgs = g_string_new (<span class="stringliteral">&quot;&quot;</span>);
<a name="l02804"></a>02804     <a class="code" href="unpack-trees_8c.html#a795a271a95b2bc0ef892ee87f48a0c62">get_unpack_trees_error_msgs</a> (&amp;topts, err_msgs, <a class="code" href="unpack-trees_8h.html#abed82baf7f470b522273a3e37c24c600af3d4fc3232b5bb0490577270e80493c6">OPR_CHECKOUT</a>);
<a name="l02805"></a>02805     *error = g_string_free (err_msgs, FALSE);
<a name="l02806"></a>02806 
<a name="l02807"></a>02807     tree_desc_free (&amp;trees[0]);
<a name="l02808"></a>02808     tree_desc_free (&amp;trees[1]);
<a name="l02809"></a>02809 
<a name="l02810"></a>02810     g_free (topts.<a class="code" href="structunpack__trees__options.html#a6d3d0c296c9b75e94ad49befce418bda">crypt</a>);
<a name="l02811"></a>02811 
<a name="l02812"></a>02812     <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
<a name="l02813"></a>02813 
<a name="l02814"></a>02814     <span class="keywordflow">return</span> ret;
<a name="l02815"></a>02815 }
<a name="l02816"></a>02816 
<a name="l02817"></a>02817 
<a name="l02822"></a>02822 <span class="keywordtype">int</span>
<a name="l02823"></a><a class="code" href="daemon_2repo-mgr_8c.html#a888b4c185cc198eaf4eb7d4d3b8e9054">02823</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a888b4c185cc198eaf4eb7d4d3b8e9054">seaf_repo_checkout</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree, <span class="keywordtype">char</span> **error)
<a name="l02824"></a>02824 {
<a name="l02825"></a>02825     <span class="keyword">const</span> <span class="keywordtype">char</span> *commit_id;
<a name="l02826"></a>02826     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch;
<a name="l02827"></a>02827     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit;
<a name="l02828"></a>02828     GString *err_msgs;
<a name="l02829"></a>02829 
<a name="l02830"></a>02830     <span class="comment">/* remove original index */</span>
<a name="l02831"></a>02831     <span class="keywordtype">char</span> <a class="code" href="index_8c.html#a35caece3e3575d32521f820a8f0a24a7">index_path</a>[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
<a name="l02832"></a>02832     snprintf (index_path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02833"></a>02833     <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a26f091009701c5a9d1886b9d6ceb9c8e">seaf_util_unlink</a> (index_path);
<a name="l02834"></a>02834 
<a name="l02835"></a>02835     branch = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>,
<a name="l02836"></a>02836                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="stringliteral">&quot;local&quot;</span>);
<a name="l02837"></a>02837     <span class="keywordflow">if</span> (!branch) {
<a name="l02838"></a>02838         g_warning (<span class="stringliteral">&quot;[repo-mgr] Checkout repo failed: local branch does not exists\n&quot;</span>);
<a name="l02839"></a>02839         *error = g_strdup (<span class="stringliteral">&quot;Repo&#39;s local branch does not exists.&quot;</span>);
<a name="l02840"></a>02840         <span class="keywordflow">goto</span> error;
<a name="l02841"></a>02841     }
<a name="l02842"></a>02842     commit_id = branch-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>;
<a name="l02843"></a>02843         
<a name="l02844"></a>02844     commit = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l02845"></a>02845                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l02846"></a>02846                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
<a name="l02847"></a>02847                                              commit_id);
<a name="l02848"></a>02848     <span class="keywordflow">if</span> (!commit) {
<a name="l02849"></a>02849         err_msgs = g_string_new (<span class="stringliteral">&quot;&quot;</span>);
<a name="l02850"></a>02850         g_string_append_printf (err_msgs, <span class="stringliteral">&quot;Commit %s does not exist.\n&quot;</span>,
<a name="l02851"></a>02851                                 commit_id);
<a name="l02852"></a>02852         g_warning (<span class="stringliteral">&quot;%s&quot;</span>, err_msgs-&gt;str);
<a name="l02853"></a>02853         *error = g_string_free (err_msgs, FALSE);
<a name="l02854"></a>02854         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l02855"></a>02855         <span class="keywordflow">goto</span> error;
<a name="l02856"></a>02856     }
<a name="l02857"></a>02857 
<a name="l02858"></a>02858     <span class="keywordflow">if</span> (strcmp(repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#af9c51057516029191941d47985df7f5f">repo_id</a>) != 0) {
<a name="l02859"></a>02859         err_msgs = g_string_new (<span class="stringliteral">&quot;&quot;</span>);
<a name="l02860"></a>02860         g_string_append_printf (err_msgs, <span class="stringliteral">&quot;Commit %s is not in Repo %s.\n&quot;</span>, 
<a name="l02861"></a>02861                                 commit_id, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02862"></a>02862         g_warning (<span class="stringliteral">&quot;%s&quot;</span>, err_msgs-&gt;str);
<a name="l02863"></a>02863         *error = g_string_free (err_msgs, FALSE);
<a name="l02864"></a>02864         <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
<a name="l02865"></a>02865         <span class="keywordflow">if</span> (branch)
<a name="l02866"></a>02866             <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l02867"></a>02867         <span class="keywordflow">goto</span> error;
<a name="l02868"></a>02868     }
<a name="l02869"></a>02869 
<a name="l02870"></a>02870     <a class="code" href="structCheckoutTask.html">CheckoutTask</a> *task = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#abe8b32b343e5e7d2d06018e398011151">seaf_repo_manager_get_checkout_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l02871"></a>02871                                                               repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02872"></a>02872     <span class="keywordflow">if</span> (!task) {
<a name="l02873"></a>02873         seaf_warning (<span class="stringliteral">&quot;No checkout task found for repo %.10s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02874"></a>02874         <span class="keywordflow">goto</span> error;
<a name="l02875"></a>02875     }
<a name="l02876"></a>02876     task-&gt;<a class="code" href="structCheckoutTask.html#a91c93d2e31b4ce625dcfd7e98a0b1c4f">total_files</a> = <a class="code" href="fs-mgr_8c.html#afa141245d62ac11820ad120fef68d01e">seaf_fs_manager_count_fs_files</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
<a name="l02877"></a>02877                                                         repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
<a name="l02878"></a>02878                                                         commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>);
<a name="l02879"></a>02879 
<a name="l02880"></a>02880     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="structCheckoutTask.html#a91c93d2e31b4ce625dcfd7e98a0b1c4f">total_files</a> &lt; 0) {
<a name="l02881"></a>02881         seaf_warning (<span class="stringliteral">&quot;Failed to count files for repo %.10s .\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02882"></a>02882         <span class="keywordflow">goto</span> error;
<a name="l02883"></a>02883     }
<a name="l02884"></a>02884 
<a name="l02885"></a>02885     <span class="keywordflow">if</span> (<a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a7923c5fb7b957a121f1b2616a8d66745">seaf_repo_checkout_commit</a> (repo, commit, FALSE, error) &lt; 0) {
<a name="l02886"></a>02886         <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
<a name="l02887"></a>02887         <span class="keywordflow">if</span> (branch)
<a name="l02888"></a>02888             <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l02889"></a>02889         <span class="keywordflow">goto</span> error;
<a name="l02890"></a>02890     }
<a name="l02891"></a>02891 
<a name="l02892"></a>02892     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l02893"></a>02893     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
<a name="l02894"></a>02894 
<a name="l02895"></a>02895     <span class="keywordflow">return</span> 0;
<a name="l02896"></a>02896 
<a name="l02897"></a>02897 error:
<a name="l02898"></a>02898     <span class="keywordflow">return</span> -1;
<a name="l02899"></a>02899 }
<a name="l02900"></a>02900 
<a name="l02901"></a>02901 <span class="keywordtype">int</span>
<a name="l02902"></a><a class="code" href="daemon_2repo-mgr_8c.html#a25b9a6f8f5199db34dcb95789a80eba4">02902</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a25b9a6f8f5199db34dcb95789a80eba4">seaf_repo_merge</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <span class="keyword">const</span> <span class="keywordtype">char</span> *branch, <span class="keywordtype">char</span> **error,
<a name="l02903"></a>02903                  <span class="keywordtype">int</span> *merge_status)
<a name="l02904"></a>02904 {
<a name="l02905"></a>02905     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *remote_branch;
<a name="l02906"></a>02906     <span class="keywordtype">int</span> ret = 0;
<a name="l02907"></a>02907 
<a name="l02908"></a>02908     <span class="keywordflow">if</span> (!check_worktree_common (repo))
<a name="l02909"></a>02909         <span class="keywordflow">return</span> -1;
<a name="l02910"></a>02910 
<a name="l02911"></a>02911     remote_branch = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>,
<a name="l02912"></a>02912                                                     repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l02913"></a>02913                                                     branch);
<a name="l02914"></a>02914     <span class="keywordflow">if</span> (!remote_branch) {
<a name="l02915"></a>02915         *error = g_strdup(<span class="stringliteral">&quot;Invalid remote branch.\n&quot;</span>);
<a name="l02916"></a>02916         <span class="keywordflow">goto</span> error;
<a name="l02917"></a>02917     }
<a name="l02918"></a>02918 
<a name="l02919"></a>02919     <span class="keywordflow">if</span> (g_strcmp0 (remote_branch-&gt;<a class="code" href="struct__SeafBranch.html#a88717f46308eb12629b99f9ff91740c2">repo_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>) != 0) {
<a name="l02920"></a>02920         *error = g_strdup (<span class="stringliteral">&quot;Remote branch is not in this repository.\n&quot;</span>);
<a name="l02921"></a>02921         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (remote_branch);
<a name="l02922"></a>02922         <span class="keywordflow">goto</span> error;
<a name="l02923"></a>02923     }
<a name="l02924"></a>02924 
<a name="l02925"></a>02925     ret = <a class="code" href="merge_8c.html#a65b859e991bbf3718673fa75b0251c85">merge_branches</a> (repo, remote_branch, error, merge_status);
<a name="l02926"></a>02926     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (remote_branch);
<a name="l02927"></a>02927 
<a name="l02928"></a>02928     <span class="keywordflow">return</span> ret;
<a name="l02929"></a>02929 
<a name="l02930"></a>02930 error:
<a name="l02931"></a>02931     <span class="keywordflow">return</span> -1;
<a name="l02932"></a>02932 }
<a name="l02933"></a>02933 
<a name="l02934"></a>02934 <span class="keywordtype">int</span>
<a name="l02935"></a><a class="code" href="daemon_2repo-mgr_8c.html#a450e5bcc50da4c40b7ba2bde33a22a84">02935</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a450e5bcc50da4c40b7ba2bde33a22a84">checkout_file</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l02936"></a>02936                <span class="keywordtype">int</span> repo_version,
<a name="l02937"></a>02937                <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree,
<a name="l02938"></a>02938                <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>,
<a name="l02939"></a>02939                <span class="keyword">const</span> <span class="keywordtype">char</span> *file_id,
<a name="l02940"></a>02940                gint64 <a class="code" href="index_8h.html#adb9fb1ca66f1a67516c2ee1492e6ab2b">mtime</a>,
<a name="l02941"></a>02941                <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="index_8h.html#ac1b4d694fc07a39e06900e82872aac7f">mode</a>,
<a name="l02942"></a>02942                <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt,
<a name="l02943"></a>02943                <span class="keyword">struct</span> <a class="code" href="structcache__entry.html">cache_entry</a> *ce,
<a name="l02944"></a>02944                <a class="code" href="struct__TransferTask.html">TransferTask</a> *task,
<a name="l02945"></a>02945                <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *http_task,
<a name="l02946"></a>02946                gboolean is_http,
<a name="l02947"></a>02947                <span class="keyword">const</span> <span class="keywordtype">char</span> *conflict_head_id,
<a name="l02948"></a>02948                GHashTable *conflict_hash,
<a name="l02949"></a>02949                GHashTable *no_conflict_hash,
<a name="l02950"></a>02950                gboolean download_only)
<a name="l02951"></a>02951 {
<a name="l02952"></a>02952     <span class="keywordtype">char</span> *path;
<a name="l02953"></a>02953     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st, st2;
<a name="l02954"></a>02954     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> sha1[20];
<a name="l02955"></a>02955     gboolean path_exists = FALSE;
<a name="l02956"></a>02956     gboolean case_conflict = FALSE;
<a name="l02957"></a>02957     gboolean force_conflict = FALSE;
<a name="l02958"></a>02958     gboolean update_mode_only = FALSE;
<a name="l02959"></a>02959 
<a name="l02960"></a>02960 <span class="preprocessor">#ifndef __linux__</span>
<a name="l02961"></a>02961 <span class="preprocessor"></span>    path = <a class="code" href="vc-utils_8h.html#a055d7e42fb7353b50b3a0a075e830fea">build_case_conflict_free_path</a> (worktree, name,
<a name="l02962"></a>02962                                           conflict_hash, no_conflict_hash,
<a name="l02963"></a>02963                                           &amp;case_conflict,
<a name="l02964"></a>02964                                           FALSE);
<a name="l02965"></a>02965 <span class="preprocessor">#else</span>
<a name="l02966"></a>02966 <span class="preprocessor"></span>    path = <a class="code" href="vc-utils_8h.html#a02eca597ddebd74fe744c41265969b02">build_checkout_path</a> (worktree, name, strlen(name));
<a name="l02967"></a>02967 <span class="preprocessor">#endif</span>
<a name="l02968"></a>02968 <span class="preprocessor"></span>
<a name="l02969"></a>02969     <span class="keywordflow">if</span> (!path)
<a name="l02970"></a>02970         <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;
<a name="l02971"></a>02971 
<a name="l02972"></a>02972     <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a130e83c1ad29d78ef1a5b6baef1754d5">hex_to_rawdata</a> (file_id, sha1, 20);
<a name="l02973"></a>02973 
<a name="l02974"></a>02974     path_exists = (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (path, &amp;st) == 0);
<a name="l02975"></a>02975 
<a name="l02976"></a>02976     <span class="keywordflow">if</span> (path_exists &amp;&amp; S_ISREG(st.st_mode)) {
<a name="l02977"></a>02977         <span class="keywordflow">if</span> (st.st_mtime == ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a>) {
<a name="l02978"></a>02978             <span class="comment">/* Worktree and index are consistent. */</span>
<a name="l02979"></a>02979             <span class="keywordflow">if</span> (memcmp (sha1, ce-&gt;<a class="code" href="structcache__entry.html#a119ab5c5e9db495e6e5f8d301f01421c">sha1</a>, 20) == 0) {
<a name="l02980"></a>02980                 <span class="keywordflow">if</span> (mode == ce-&gt;<a class="code" href="structcache__entry.html#a5fcbcc4e7265ae8150f136380ed92c05">ce_mode</a>) {
<a name="l02981"></a>02981                     <span class="comment">/* Worktree and index are all uptodate, no need to checkout.</span>
<a name="l02982"></a>02982 <span class="comment">                     * This may happen after an interrupted checkout.</span>
<a name="l02983"></a>02983 <span class="comment">                     */</span>
<a name="l02984"></a>02984                     seaf_debug (<span class="stringliteral">&quot;wt and index are consistent. no need to checkout.\n&quot;</span>);
<a name="l02985"></a>02985                     <span class="keywordflow">goto</span> update_cache;
<a name="l02986"></a>02986                 } <span class="keywordflow">else</span>
<a name="l02987"></a>02987                     update_mode_only = TRUE;
<a name="l02988"></a>02988             }
<a name="l02989"></a>02989             <span class="comment">/* otherwise we have to checkout the file. */</span>
<a name="l02990"></a>02990         } <span class="keywordflow">else</span> {
<a name="l02991"></a>02991             <span class="keywordflow">if</span> (<a class="code" href="vc-utils_8c.html#afa0ef6de91f37ec2adcfbfa16a70e0d0">compare_file_content</a> (path, &amp;st, sha1, crypt, repo_version) == 0) {
<a name="l02992"></a>02992                 <span class="comment">/* This happens after the worktree file was updated,</span>
<a name="l02993"></a>02993 <span class="comment">                 * but the index was not. Just need to update the index.</span>
<a name="l02994"></a>02994 <span class="comment">                 */</span>
<a name="l02995"></a>02995                 seaf_debug (<span class="stringliteral">&quot;update index only.\n&quot;</span>);
<a name="l02996"></a>02996                 <span class="keywordflow">goto</span> update_cache;
<a name="l02997"></a>02997             } <span class="keywordflow">else</span> {
<a name="l02998"></a>02998                 <span class="comment">/* Conflict. The worktree file was updated by the user. */</span>
<a name="l02999"></a>02999                 seaf_message (<span class="stringliteral">&quot;File %s is updated by user. &quot;</span>
<a name="l03000"></a>03000                               <span class="stringliteral">&quot;Will checkout to conflict file later.\n&quot;</span>, path);
<a name="l03001"></a>03001                 force_conflict = TRUE;
<a name="l03002"></a>03002             }
<a name="l03003"></a>03003         }
<a name="l03004"></a>03004     }
<a name="l03005"></a>03005 
<a name="l03006"></a>03006     <span class="keywordflow">if</span> (update_mode_only) {
<a name="l03007"></a>03007 <span class="preprocessor">#ifdef WIN32</span>
<a name="l03008"></a>03008 <span class="preprocessor"></span>        g_free (path);
<a name="l03009"></a>03009         <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>;
<a name="l03010"></a>03010 <span class="preprocessor">#else</span>
<a name="l03011"></a>03011 <span class="preprocessor"></span>        chmod (path, mode &amp; ~S_IFMT);
<a name="l03012"></a>03012         ce-&gt;<a class="code" href="structcache__entry.html#a5fcbcc4e7265ae8150f136380ed92c05">ce_mode</a> = <a class="code" href="index_8h.html#ac1b4d694fc07a39e06900e82872aac7f">mode</a>;
<a name="l03013"></a>03013         g_free (path);
<a name="l03014"></a>03014         <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>;
<a name="l03015"></a>03015 <span class="preprocessor">#endif</span>
<a name="l03016"></a>03016 <span class="preprocessor"></span>    }
<a name="l03017"></a>03017 
<a name="l03018"></a>03018     <span class="comment">/* Download the blocks of this file. */</span>
<a name="l03019"></a>03019     <span class="keywordtype">int</span> rc;
<a name="l03020"></a>03020     <span class="keywordflow">if</span> (!is_http) {
<a name="l03021"></a>03021         rc = <a class="code" href="transfer-mgr_8c.html#a760b69b5aa68dcb74c3020f091d1fc6c">seaf_transfer_manager_download_file_blocks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa04a8214ef989d1e5d68799dc19cbf22">transfer_mgr</a>,
<a name="l03022"></a>03022                                                          task, file_id);
<a name="l03023"></a>03023         <span class="keywordflow">switch</span> (rc) {
<a name="l03024"></a>03024         <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87edda66f4cf8f7807f8038262d56bc42c61df">BLOCK_CLIENT_SUCCESS</a>:
<a name="l03025"></a>03025             <span class="keywordflow">break</span>;
<a name="l03026"></a>03026         <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87edda961f855d617f8d1c95ffbe88a1729b23">BLOCK_CLIENT_UNKNOWN</a>:
<a name="l03027"></a>03027         <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87eddab6ee07e1f93fd060c972725c7a5642a0">BLOCK_CLIENT_FAILED</a>:
<a name="l03028"></a>03028         <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87edda77daa389ab8b27e7dfb05e61b181c643">BLOCK_CLIENT_NET_ERROR</a>:
<a name="l03029"></a>03029         <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87edda879e124929511a9dbbcbba1efb527900">BLOCK_CLIENT_SERVER_ERROR</a>:
<a name="l03030"></a>03030             g_free (path);
<a name="l03031"></a>03031             <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a4a1718c70eba70651160111e48589161">FETCH_CHECKOUT_TRANSFER_ERROR</a>;
<a name="l03032"></a>03032         <span class="keywordflow">case</span> <a class="code" href="transfer-mgr_8h.html#ac205be2172292384dd687b5471a87edda5176a3efc074d82147f6ad9aee27702b">BLOCK_CLIENT_CANCELED</a>:
<a name="l03033"></a>03033             g_free (path);
<a name="l03034"></a>03034             <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ae2a1e8d995b67343e5162cdb29513380">FETCH_CHECKOUT_CANCELED</a>;
<a name="l03035"></a>03035         }
<a name="l03036"></a>03036     } <span class="keywordflow">else</span> {
<a name="l03037"></a>03037         rc = <a class="code" href="http-tx-mgr_8c.html#a3cdcb1e4f4996dabc1adb7ae742ddfb4">http_tx_task_download_file_blocks</a> (http_task, file_id);
<a name="l03038"></a>03038         <span class="keywordflow">if</span> (http_task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>) {
<a name="l03039"></a>03039             g_free (path);
<a name="l03040"></a>03040             <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ae2a1e8d995b67343e5162cdb29513380">FETCH_CHECKOUT_CANCELED</a>;
<a name="l03041"></a>03041         }
<a name="l03042"></a>03042         <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l03043"></a>03043             g_free (path);
<a name="l03044"></a>03044             <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a4a1718c70eba70651160111e48589161">FETCH_CHECKOUT_TRANSFER_ERROR</a>;
<a name="l03045"></a>03045         }
<a name="l03046"></a>03046     }
<a name="l03047"></a>03047 
<a name="l03048"></a>03048     <span class="keywordflow">if</span> (download_only) {
<a name="l03049"></a>03049         g_free (path);
<a name="l03050"></a>03050         <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>;
<a name="l03051"></a>03051     }
<a name="l03052"></a>03052 
<a name="l03053"></a>03053     <span class="comment">/* The worktree file may have been changed when we&#39;re downloading the blocks. */</span>
<a name="l03054"></a>03054     <span class="keywordflow">if</span> (path_exists &amp;&amp; S_ISREG(st.st_mode) &amp;&amp; !force_conflict) {
<a name="l03055"></a>03055         <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (path, &amp;st2);
<a name="l03056"></a>03056         <span class="keywordflow">if</span> (st.st_mtime != st2.st_mtime) {
<a name="l03057"></a>03057             seaf_message (<span class="stringliteral">&quot;File %s is updated by user. &quot;</span>
<a name="l03058"></a>03058                           <span class="stringliteral">&quot;Will checkout to conflict file later.\n&quot;</span>, path);
<a name="l03059"></a>03059             force_conflict = TRUE;
<a name="l03060"></a>03060         }
<a name="l03061"></a>03061     }
<a name="l03062"></a>03062 
<a name="l03063"></a>03063     <span class="comment">/* then checkout the file. */</span>
<a name="l03064"></a>03064     gboolean conflicted = FALSE;
<a name="l03065"></a>03065     <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#aa1e02fce35b0a00a0a65c37299865628">seaf_fs_manager_checkout_file</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
<a name="l03066"></a>03066                                        repo_id,
<a name="l03067"></a>03067                                        repo_version,
<a name="l03068"></a>03068                                        file_id,
<a name="l03069"></a>03069                                        path,
<a name="l03070"></a>03070                                        mode,
<a name="l03071"></a>03071                                        mtime,
<a name="l03072"></a>03072                                        crypt,
<a name="l03073"></a>03073                                        name,
<a name="l03074"></a>03074                                        conflict_head_id,
<a name="l03075"></a>03075                                        force_conflict,
<a name="l03076"></a>03076                                        &amp;conflicted) &lt; 0) {
<a name="l03077"></a>03077         seaf_warning (<span class="stringliteral">&quot;Failed to checkout file %s.\n&quot;</span>, path);
<a name="l03078"></a>03078         g_free (path);
<a name="l03079"></a>03079         <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;
<a name="l03080"></a>03080     }
<a name="l03081"></a>03081 
<a name="l03082"></a>03082     <span class="comment">/* If case conflict, this file has been checked out to another path.</span>
<a name="l03083"></a>03083 <span class="comment">     * Remove the current entry, otherwise it won&#39;t be removed later</span>
<a name="l03084"></a>03084 <span class="comment">     * since it&#39;s timestamp is 0.</span>
<a name="l03085"></a>03085 <span class="comment">     */</span>
<a name="l03086"></a>03086     <span class="keywordflow">if</span> (case_conflict) {
<a name="l03087"></a>03087         ce-&gt;<a class="code" href="structcache__entry.html#a4dab14fd813a1bb6b67352674ff4afb2">ce_flags</a> |= <a class="code" href="index_8h.html#aa5ee599d9d7af67f19dba204ce9030c0">CE_REMOVE</a>;
<a name="l03088"></a>03088         g_free (path);
<a name="l03089"></a>03089         <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>;
<a name="l03090"></a>03090     }
<a name="l03091"></a>03091 
<a name="l03092"></a>03092     <span class="keywordflow">if</span> (conflicted) {
<a name="l03093"></a>03093         g_free (path);
<a name="l03094"></a>03094         <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>;
<a name="l03095"></a>03095     }
<a name="l03096"></a>03096 
<a name="l03097"></a>03097 update_cache:
<a name="l03098"></a>03098     <span class="comment">/* finally fill cache_entry info */</span>
<a name="l03099"></a>03099     <span class="comment">/* Only update index if we checked out the file without any error</span>
<a name="l03100"></a>03100 <span class="comment">     * or conflicts. The timestamp of the entry will remain 0 if error</span>
<a name="l03101"></a>03101 <span class="comment">     * or conflicted.</span>
<a name="l03102"></a>03102 <span class="comment">     */</span>
<a name="l03103"></a>03103     <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (path, &amp;st);
<a name="l03104"></a>03104     <a class="code" href="index_8c.html#a8225ef1fb93e6538cc4c632928516314">fill_stat_cache_info</a> (ce, &amp;st);
<a name="l03105"></a>03105 
<a name="l03106"></a>03106     g_free (path);
<a name="l03107"></a>03107     <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>;
<a name="l03108"></a>03108 }
<a name="l03109"></a>03109 
<a name="l03110"></a>03110 <span class="keywordtype">int</span>
<a name="l03111"></a><a class="code" href="daemon_2repo-mgr_8c.html#a181f66e1d3900771c37883e97fea7fba">03111</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a181f66e1d3900771c37883e97fea7fba">checkout_empty_dir</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *worktree,
<a name="l03112"></a>03112                     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>,
<a name="l03113"></a>03113                     gint64 <a class="code" href="index_8h.html#adb9fb1ca66f1a67516c2ee1492e6ab2b">mtime</a>,
<a name="l03114"></a>03114                     <span class="keyword">struct</span> <a class="code" href="structcache__entry.html">cache_entry</a> *ce,
<a name="l03115"></a>03115                     GHashTable *conflict_hash,
<a name="l03116"></a>03116                     GHashTable *no_conflict_hash)
<a name="l03117"></a>03117 {
<a name="l03118"></a>03118     <span class="keywordtype">char</span> *path;
<a name="l03119"></a>03119     gboolean case_conflict = FALSE;
<a name="l03120"></a>03120 
<a name="l03121"></a>03121 <span class="preprocessor">#ifndef __linux__</span>
<a name="l03122"></a>03122 <span class="preprocessor"></span>    path = <a class="code" href="vc-utils_8h.html#a055d7e42fb7353b50b3a0a075e830fea">build_case_conflict_free_path</a> (worktree, name,
<a name="l03123"></a>03123                                           conflict_hash, no_conflict_hash,
<a name="l03124"></a>03124                                           &amp;case_conflict,
<a name="l03125"></a>03125                                           FALSE);
<a name="l03126"></a>03126 <span class="preprocessor">#else</span>
<a name="l03127"></a>03127 <span class="preprocessor"></span>    path = <a class="code" href="vc-utils_8h.html#a02eca597ddebd74fe744c41265969b02">build_checkout_path</a> (worktree, name, strlen(name));
<a name="l03128"></a>03128 <span class="preprocessor">#endif</span>
<a name="l03129"></a>03129 <span class="preprocessor"></span>
<a name="l03130"></a>03130     <span class="keywordflow">if</span> (!path)
<a name="l03131"></a>03131         <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;
<a name="l03132"></a>03132 
<a name="l03133"></a>03133     <span class="keywordflow">if</span> (!<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a1c2448a989efb1ce953a90f3db3c8042">seaf_util_exists</a> (path) &amp;&amp; <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a51aa6c51cc437a2766ca666660289bce">seaf_util_mkdir</a> (path, 0777) &lt; 0) {
<a name="l03134"></a>03134         g_warning (<span class="stringliteral">&quot;Failed to create empty dir %s in checkout.\n&quot;</span>, path);
<a name="l03135"></a>03135         g_free (path);
<a name="l03136"></a>03136         <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;
<a name="l03137"></a>03137     }
<a name="l03138"></a>03138 
<a name="l03139"></a>03139     <span class="keywordflow">if</span> (mtime != 0 &amp;&amp; <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#abc8dd3d83f54a07998aea73c4071d818">seaf_set_file_time</a> (path, mtime) &lt; 0) {
<a name="l03140"></a>03140         g_warning (<span class="stringliteral">&quot;Failed to set mtime for %s.\n&quot;</span>, path);
<a name="l03141"></a>03141     }
<a name="l03142"></a>03142 
<a name="l03143"></a>03143     <span class="keywordflow">if</span> (case_conflict) {
<a name="l03144"></a>03144         ce-&gt;<a class="code" href="structcache__entry.html#a4dab14fd813a1bb6b67352674ff4afb2">ce_flags</a> |= <a class="code" href="index_8h.html#aa5ee599d9d7af67f19dba204ce9030c0">CE_REMOVE</a>;
<a name="l03145"></a>03145         g_free (path);
<a name="l03146"></a>03146         <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>;
<a name="l03147"></a>03147     }
<a name="l03148"></a>03148 
<a name="l03149"></a>03149     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l03150"></a>03150     <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (path, &amp;st);
<a name="l03151"></a>03151     <a class="code" href="index_8c.html#a8225ef1fb93e6538cc4c632928516314">fill_stat_cache_info</a> (ce, &amp;st);
<a name="l03152"></a>03152 
<a name="l03153"></a>03153     g_free (path);
<a name="l03154"></a>03154     <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>;
<a name="l03155"></a>03155 }
<a name="l03156"></a>03156 
<a name="l03157"></a>03157 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *
<a name="l03158"></a>03158 cache_entry_from_diff_entry (<a class="code" href="structDiffEntry.html">DiffEntry</a> *de)
<a name="l03159"></a>03159 {
<a name="l03160"></a>03160     <span class="keywordtype">int</span> <a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a>, namelen;
<a name="l03161"></a>03161     <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *ce;
<a name="l03162"></a>03162 
<a name="l03163"></a>03163     namelen = strlen(de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);
<a name="l03164"></a>03164     size = <a class="code" href="index_8h.html#a07a18158c879287d1606ceec992ba702">cache_entry_size</a>(namelen);
<a name="l03165"></a>03165     ce = calloc(1, size);
<a name="l03166"></a>03166     memcpy(ce-&gt;<a class="code" href="structcache__entry.html#a792e4ea24cb16c76abe3229651e414a0">name</a>, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, namelen);
<a name="l03167"></a>03167     ce-&gt;<a class="code" href="structcache__entry.html#a4dab14fd813a1bb6b67352674ff4afb2">ce_flags</a> = namelen;
<a name="l03168"></a>03168 
<a name="l03169"></a>03169     memcpy (ce-&gt;<a class="code" href="structcache__entry.html#a119ab5c5e9db495e6e5f8d301f01421c">sha1</a>, de-&gt;<a class="code" href="structDiffEntry.html#a3329ba035605e868d00fb3b773ae021d">sha1</a>, 20);
<a name="l03170"></a>03170     ce-&gt;<a class="code" href="structcache__entry.html#a786aa5bc6234542fe202023bcf721afd">modifier</a> = g_strdup(de-&gt;modifier);
<a name="l03171"></a>03171     ce-&gt;<a class="code" href="structcache__entry.html#a869a62534c704e5d24ee26cf2f7b86b7">ce_size</a> = de-&gt;size;
<a name="l03172"></a>03172     ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a> = de-&gt;mtime;
<a name="l03173"></a>03173 
<a name="l03174"></a>03174     <span class="keywordflow">if</span> (S_ISREG(de-&gt;mode))
<a name="l03175"></a>03175         ce-&gt;<a class="code" href="structcache__entry.html#a5fcbcc4e7265ae8150f136380ed92c05">ce_mode</a> = create_ce_mode (de-&gt;mode);
<a name="l03176"></a>03176     <span class="keywordflow">else</span>
<a name="l03177"></a>03177         ce-&gt;<a class="code" href="structcache__entry.html#a5fcbcc4e7265ae8150f136380ed92c05">ce_mode</a> = S_IFDIR;
<a name="l03178"></a>03178 
<a name="l03179"></a>03179     <span class="keywordflow">return</span> ce;
<a name="l03180"></a>03180 }
<a name="l03181"></a>03181 
<a name="l03182"></a>03182 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l03183"></a>03183 cleanup_file_blocks (<span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id, <span class="keywordtype">int</span> version, <span class="keyword">const</span> <span class="keywordtype">char</span> *file_id)
<a name="l03184"></a>03184 {
<a name="l03185"></a>03185     <a class="code" href="struct__Seafile.html">Seafile</a> *file;
<a name="l03186"></a>03186     <span class="keywordtype">int</span> i;
<a name="l03187"></a>03187 
<a name="l03188"></a>03188     file = <a class="code" href="fs-mgr_8c.html#a029c16e2ecdf6eafd96edb2ee4e6beac">seaf_fs_manager_get_seafile</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
<a name="l03189"></a>03189                                         repo_id, version,
<a name="l03190"></a>03190                                         file_id);
<a name="l03191"></a>03191     <span class="keywordflow">for</span> (i = 0; i &lt; file-&gt;<a class="code" href="struct__Seafile.html#af2d5c5e5bb56d38122dead42128b9c20">n_blocks</a>; ++i)
<a name="l03192"></a>03192         <a class="code" href="block-mgr_8c.html#a4b9324cd1b942eb1378bc9ea7f5eaccf">seaf_block_manager_remove_block</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>,
<a name="l03193"></a>03193                                          repo_id, version,
<a name="l03194"></a>03194                                          file-&gt;<a class="code" href="struct__Seafile.html#aacaedff2674132faf3d522ba8df6e268">blk_sha1s</a>[i]);
<a name="l03195"></a>03195 
<a name="l03196"></a>03196     <a class="code" href="fs-mgr_8c.html#a0a491c647769cf7bd09d5092ab84b85a">seafile_unref</a> (file);
<a name="l03197"></a>03197 }
<a name="l03198"></a>03198 
<a name="l03199"></a>03199 <span class="keyword">static</span> gboolean
<a name="l03200"></a>03200 expand_dir_added_cb (<a class="code" href="struct__SeafFSManager.html">SeafFSManager</a> *mgr,
<a name="l03201"></a>03201                      <span class="keyword">const</span> <span class="keywordtype">char</span> *path,
<a name="l03202"></a>03202                      <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *dent,
<a name="l03203"></a>03203                      <span class="keywordtype">void</span> *user_data,
<a name="l03204"></a>03204                      gboolean *stop)
<a name="l03205"></a>03205 {
<a name="l03206"></a>03206     GList **expanded = user_data;
<a name="l03207"></a>03207     <a class="code" href="structDiffEntry.html">DiffEntry</a> *de = NULL;
<a name="l03208"></a>03208     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> sha1[20];
<a name="l03209"></a>03209 
<a name="l03210"></a>03210     <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a130e83c1ad29d78ef1a5b6baef1754d5">hex_to_rawdata</a> (dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>, sha1, 20);
<a name="l03211"></a>03211 
<a name="l03212"></a>03212     <span class="keywordflow">if</span> (S_ISDIR(dent-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>) &amp;&amp; strcmp(dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>) == 0)
<a name="l03213"></a>03213         de = <a class="code" href="diff-simple_8c.html#a5a9e3f70659801a181ca4ff6004bf021">diff_entry_new</a> (<a class="code" href="diff-simple_8h.html#abd106f800596da115b74dd40a7f9e46f">DIFF_TYPE_COMMITS</a>, <a class="code" href="diff-simple_8h.html#a36e1b9c5a30fee84055977065fd0265d">DIFF_STATUS_DIR_ADDED</a>, sha1, path);
<a name="l03214"></a>03214     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S_ISREG(dent-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>))
<a name="l03215"></a>03215         de = <a class="code" href="diff-simple_8c.html#a5a9e3f70659801a181ca4ff6004bf021">diff_entry_new</a> (<a class="code" href="diff-simple_8h.html#abd106f800596da115b74dd40a7f9e46f">DIFF_TYPE_COMMITS</a>, <a class="code" href="diff-simple_8h.html#a8a5184ba68f5168383e7a1017e89e290">DIFF_STATUS_ADDED</a>, sha1, path);
<a name="l03216"></a>03216 
<a name="l03217"></a>03217     <span class="keywordflow">if</span> (de) {
<a name="l03218"></a>03218         de-&gt;mtime = dent-&gt;<a class="code" href="struct__SeafDirent.html#a42acf83af54b1c20696b5f288bbdd681">mtime</a>;
<a name="l03219"></a>03219         de-&gt;mode = dent-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>;
<a name="l03220"></a>03220         de-&gt;modifier = g_strdup(dent-&gt;<a class="code" href="struct__SeafDirent.html#a3c4c6d87516341646347c48ef21cd5eb">modifier</a>);
<a name="l03221"></a>03221         de-&gt;size = dent-&gt;<a class="code" href="struct__SeafDirent.html#abf0e9b6fade594b7897cb9896d370961">size</a>;
<a name="l03222"></a>03222         *expanded = g_list_prepend (*expanded, de);
<a name="l03223"></a>03223     }
<a name="l03224"></a>03224 
<a name="l03225"></a>03225     <span class="keywordflow">return</span> TRUE;
<a name="l03226"></a>03226 }
<a name="l03227"></a>03227 
<a name="l03228"></a>03228 <span class="comment">/*</span>
<a name="l03229"></a>03229 <span class="comment"> * Expand DIR_ADDED results into multiple ADDED results.</span>
<a name="l03230"></a>03230 <span class="comment"> */</span>
<a name="l03231"></a>03231 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l03232"></a>03232 expand_diff_results (<span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id, <span class="keywordtype">int</span> version,
<a name="l03233"></a>03233                      <span class="keyword">const</span> <span class="keywordtype">char</span> *remote_root, <span class="keyword">const</span> <span class="keywordtype">char</span> *local_root,
<a name="l03234"></a>03234                      GList **results)
<a name="l03235"></a>03235 {
<a name="l03236"></a>03236     GList *ptr, *<a class="code" href="structcache__entry.html#afd4bec9067a7e0c76158d32a9d287684">next</a>;
<a name="l03237"></a>03237     <a class="code" href="structDiffEntry.html">DiffEntry</a> *de;
<a name="l03238"></a>03238     <span class="keywordtype">char</span> <a class="code" href="Backups_2http-server_8c.html#acdc8b2e33d61c23557d7e7563f00ef6f">obj_id</a>[41];
<a name="l03239"></a>03239     GList *expanded = NULL;
<a name="l03240"></a>03240 
<a name="l03241"></a>03241     ptr = *results;
<a name="l03242"></a>03242     <span class="keywordflow">while</span> (ptr) {
<a name="l03243"></a>03243         de = ptr-&gt;data;
<a name="l03244"></a>03244 
<a name="l03245"></a>03245         next = ptr-&gt;next;
<a name="l03246"></a>03246 
<a name="l03247"></a>03247         <span class="keywordflow">if</span> (de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a36e1b9c5a30fee84055977065fd0265d">DIFF_STATUS_DIR_ADDED</a>) {
<a name="l03248"></a>03248             *results = g_list_delete_link (*results, ptr);
<a name="l03249"></a>03249 
<a name="l03250"></a>03250             <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a> (de-&gt;<a class="code" href="structDiffEntry.html#a3329ba035605e868d00fb3b773ae021d">sha1</a>, obj_id, 20);
<a name="l03251"></a>03251             <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#a4fd132514ca9fb157d1b16a8e21bf749">seaf_fs_manager_traverse_path</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
<a name="l03252"></a>03252                                                repo_id, version,
<a name="l03253"></a>03253                                                remote_root,
<a name="l03254"></a>03254                                                de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>,
<a name="l03255"></a>03255                                                expand_dir_added_cb,
<a name="l03256"></a>03256                                                &amp;expanded) &lt; 0)
<a name="l03257"></a>03257                 <span class="keywordflow">goto</span> error;
<a name="l03258"></a>03258         }
<a name="l03259"></a>03259 
<a name="l03260"></a>03260         ptr = <a class="code" href="structcache__entry.html#afd4bec9067a7e0c76158d32a9d287684">next</a>;
<a name="l03261"></a>03261     }
<a name="l03262"></a>03262 
<a name="l03263"></a>03263     expanded = g_list_reverse (expanded);
<a name="l03264"></a>03264     *results = g_list_concat (*results, expanded);
<a name="l03265"></a>03265 
<a name="l03266"></a>03266     <span class="keywordflow">return</span> 0;
<a name="l03267"></a>03267 
<a name="l03268"></a>03268 error:
<a name="l03269"></a>03269     <span class="keywordflow">for</span> (ptr = expanded; ptr; ptr = ptr-&gt;next)
<a name="l03270"></a>03270         <a class="code" href="diff-simple_8c.html#abb759117ec4b4aca623768424487f5da">diff_entry_free</a> ((<a class="code" href="structDiffEntry.html">DiffEntry</a> *)(ptr-&gt;data));
<a name="l03271"></a>03271     <span class="keywordflow">return</span> -1;
<a name="l03272"></a>03272 }
<a name="l03273"></a>03273 
<a name="l03274"></a>03274 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l03275"></a>03275 do_rename_in_worktree (<a class="code" href="structDiffEntry.html">DiffEntry</a> *de, <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree,
<a name="l03276"></a>03276                        GHashTable *conflict_hash, GHashTable *no_conflict_hash)
<a name="l03277"></a>03277 {
<a name="l03278"></a>03278     <span class="keywordtype">char</span> *old_path, *new_path;
<a name="l03279"></a>03279     gboolean case_conflict;
<a name="l03280"></a>03280     <span class="keywordtype">int</span> ret = 0;
<a name="l03281"></a>03281 
<a name="l03282"></a>03282     old_path = g_build_filename (worktree, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, NULL);
<a name="l03283"></a>03283 
<a name="l03284"></a>03284     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a1c2448a989efb1ce953a90f3db3c8042">seaf_util_exists</a> (old_path)) {
<a name="l03285"></a>03285 <span class="preprocessor">#ifndef __linux__</span>
<a name="l03286"></a>03286 <span class="preprocessor"></span>        new_path = <a class="code" href="vc-utils_8h.html#a055d7e42fb7353b50b3a0a075e830fea">build_case_conflict_free_path</a> (worktree, de-&gt;<a class="code" href="structDiffEntry.html#acfe7cac599e8737146318883029c26e9">new_name</a>,
<a name="l03287"></a>03287                                                   conflict_hash, no_conflict_hash,
<a name="l03288"></a>03288                                                   &amp;case_conflict,
<a name="l03289"></a>03289                                                   TRUE);
<a name="l03290"></a>03290 <span class="preprocessor">#else</span>
<a name="l03291"></a>03291 <span class="preprocessor"></span>        new_path = <a class="code" href="vc-utils_8h.html#a02eca597ddebd74fe744c41265969b02">build_checkout_path</a> (worktree, de-&gt;<a class="code" href="structDiffEntry.html#acfe7cac599e8737146318883029c26e9">new_name</a>, strlen(de-&gt;<a class="code" href="structDiffEntry.html#acfe7cac599e8737146318883029c26e9">new_name</a>));
<a name="l03292"></a>03292 <span class="preprocessor">#endif</span>
<a name="l03293"></a>03293 <span class="preprocessor"></span>
<a name="l03294"></a>03294         <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a46307856992913eeb741c8203cfc93c2">seaf_util_rename</a> (old_path, new_path) &lt; 0) {
<a name="l03295"></a>03295             seaf_warning (<span class="stringliteral">&quot;Failed to rename %s to %s: %s.\n&quot;</span>,
<a name="l03296"></a>03296                           old_path, new_path, strerror(errno));
<a name="l03297"></a>03297             ret = -1;
<a name="l03298"></a>03298         }
<a name="l03299"></a>03299 
<a name="l03300"></a>03300         g_free (new_path);
<a name="l03301"></a>03301     }
<a name="l03302"></a>03302 
<a name="l03303"></a>03303     g_free (old_path);
<a name="l03304"></a>03304     <span class="keywordflow">return</span> ret;
<a name="l03305"></a>03305 }
<a name="l03306"></a>03306 
<a name="l03307"></a>03307 <span class="preprocessor">#ifdef WIN32</span>
<a name="l03308"></a>03308 <span class="preprocessor"></span>
<a name="l03309"></a>03309 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l03310"></a>03310 delete_worktree_dir_recursive_win32 (<span class="keyword">const</span> <span class="keywordtype">char</span> *worktree,
<a name="l03311"></a>03311                                      <span class="keyword">const</span> <span class="keywordtype">wchar_t</span> *path_w)
<a name="l03312"></a>03312 {
<a name="l03313"></a>03313     WIN32_FIND_DATAW fdata;
<a name="l03314"></a>03314     HANDLE handle;
<a name="l03315"></a>03315     <span class="keywordtype">wchar_t</span> *pattern;
<a name="l03316"></a>03316     <span class="keywordtype">wchar_t</span> *sub_path_w;
<a name="l03317"></a>03317     <span class="keywordtype">char</span> *path, *sub_path;
<a name="l03318"></a>03318     <span class="keywordtype">int</span> path_len_w;
<a name="l03319"></a>03319     DWORD error;
<a name="l03320"></a>03320 
<a name="l03321"></a>03321     path = g_utf16_to_utf8 (path_w, -1, NULL, NULL, NULL);
<a name="l03322"></a>03322 
<a name="l03323"></a>03323     path_len_w = wcslen(path_w);
<a name="l03324"></a>03324 
<a name="l03325"></a>03325     pattern = g_new0 (<span class="keywordtype">wchar_t</span>, (path_len_w + 3));
<a name="l03326"></a>03326     wcscpy (pattern, path_w);
<a name="l03327"></a>03327     wcscat (pattern, L<span class="stringliteral">&quot;\\*&quot;</span>);
<a name="l03328"></a>03328 
<a name="l03329"></a>03329     handle = FindFirstFileW (pattern, &amp;fdata);
<a name="l03330"></a>03330     <span class="keywordflow">if</span> (handle == INVALID_HANDLE_VALUE) {
<a name="l03331"></a>03331         seaf_warning (<span class="stringliteral">&quot;FindFirstFile failed %s: %lu.\n&quot;</span>,
<a name="l03332"></a>03332                       path, GetLastError());
<a name="l03333"></a>03333         g_free (path);
<a name="l03334"></a>03334         g_free (pattern);
<a name="l03335"></a>03335         <span class="keywordflow">return</span>;
<a name="l03336"></a>03336     }
<a name="l03337"></a>03337 
<a name="l03338"></a>03338     <span class="keywordflow">do</span> {
<a name="l03339"></a>03339         <span class="keywordflow">if</span> (wcscmp (fdata.cFileName, L<span class="stringliteral">&quot;.&quot;</span>) == 0 ||
<a name="l03340"></a>03340             wcscmp (fdata.cFileName, L<span class="stringliteral">&quot;..&quot;</span>) == 0)
<a name="l03341"></a>03341             <span class="keywordflow">continue</span>;
<a name="l03342"></a>03342 
<a name="l03343"></a>03343         sub_path_w = g_new0 (<span class="keywordtype">wchar_t</span>, path_len_w + wcslen(fdata.cFileName) + 2);
<a name="l03344"></a>03344         wcscpy (sub_path_w, path_w);
<a name="l03345"></a>03345         wcscat (sub_path_w, L<span class="stringliteral">&quot;\\&quot;</span>);
<a name="l03346"></a>03346         wcscat (sub_path_w, fdata.cFileName);
<a name="l03347"></a>03347 
<a name="l03348"></a>03348         <span class="keywordflow">if</span> (fdata.dwFileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY) {
<a name="l03349"></a>03349             delete_worktree_dir_recursive_win32 (worktree, sub_path_w);
<a name="l03350"></a>03350         } <span class="keywordflow">else</span> {
<a name="l03351"></a>03351             <span class="keywordflow">if</span> (!DeleteFileW (sub_path_w)) {
<a name="l03352"></a>03352                 error = GetLastError();
<a name="l03353"></a>03353 
<a name="l03354"></a>03354                 sub_path = g_utf16_to_utf8 (sub_path_w, -1,
<a name="l03355"></a>03355                                             NULL, NULL, NULL);
<a name="l03356"></a>03356                 seaf_warning (<span class="stringliteral">&quot;Failed to delete file %s: %lu.\n&quot;</span>,
<a name="l03357"></a>03357                               sub_path, error);
<a name="l03358"></a>03358 
<a name="l03359"></a>03359                 g_free (sub_path);
<a name="l03360"></a>03360             }
<a name="l03361"></a>03361         }
<a name="l03362"></a>03362 
<a name="l03363"></a>03363         g_free (sub_path_w);
<a name="l03364"></a>03364     } <span class="keywordflow">while</span> (FindNextFileW (handle, &amp;fdata) != 0);
<a name="l03365"></a>03365 
<a name="l03366"></a>03366     error = GetLastError();
<a name="l03367"></a>03367     <span class="keywordflow">if</span> (error != ERROR_NO_MORE_FILES) {
<a name="l03368"></a>03368         seaf_warning (<span class="stringliteral">&quot;FindNextFile failed %s: %lu.\n&quot;</span>,
<a name="l03369"></a>03369                       path, error);
<a name="l03370"></a>03370     }
<a name="l03371"></a>03371 
<a name="l03372"></a>03372     FindClose (handle);
<a name="l03373"></a>03373 
<a name="l03374"></a>03374     <span class="keywordtype">int</span> n = 0;
<a name="l03375"></a>03375     <span class="keywordflow">while</span> (!RemoveDirectoryW (path_w)) {
<a name="l03376"></a>03376         error = GetLastError();
<a name="l03377"></a>03377         seaf_warning (<span class="stringliteral">&quot;Failed to remove dir %s: %lu.\n&quot;</span>,
<a name="l03378"></a>03378                       path, error);
<a name="l03379"></a>03379         <span class="keywordflow">if</span> (error != ERROR_DIR_NOT_EMPTY)
<a name="l03380"></a>03380             <span class="keywordflow">break</span>;
<a name="l03381"></a>03381         <span class="keywordflow">if</span> (++n &gt;= 3)
<a name="l03382"></a>03382             <span class="keywordflow">break</span>;
<a name="l03383"></a>03383         <span class="comment">/* Sleep 100ms and retry. */</span>
<a name="l03384"></a>03384         <a class="code" href="seafile-4_81_82_2common_2common_8h.html#aed82f1a99a580ff6fdf9ad1dd4f81567">G_USLEEP</a> (100000);
<a name="l03385"></a>03385         seaf_warning (<span class="stringliteral">&quot;Retry remove dir %s.\n&quot;</span>, path);
<a name="l03386"></a>03386     }
<a name="l03387"></a>03387     g_free (path);
<a name="l03388"></a>03388     g_free (pattern);
<a name="l03389"></a>03389 }
<a name="l03390"></a>03390 
<a name="l03391"></a>03391 <span class="preprocessor">#else</span>
<a name="l03392"></a>03392 <span class="preprocessor"></span>
<a name="l03393"></a>03393 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l03394"></a>03394 delete_worktree_dir_recursive (<span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l03395"></a>03395 {
<a name="l03396"></a>03396     GDir *dir;
<a name="l03397"></a>03397     <span class="keyword">const</span> <span class="keywordtype">char</span> *dname;
<a name="l03398"></a>03398     GError *error = NULL;
<a name="l03399"></a>03399     <span class="keywordtype">char</span> *sub_path;
<a name="l03400"></a>03400     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l03401"></a>03401 
<a name="l03402"></a>03402     dir = g_dir_open (path, 0, &amp;error);
<a name="l03403"></a>03403     <span class="keywordflow">if</span> (!dir) {
<a name="l03404"></a>03404         seaf_warning (<span class="stringliteral">&quot;Failed to open dir %s: %s.\n&quot;</span>, path, error-&gt;message);
<a name="l03405"></a>03405         <span class="keywordflow">return</span>;
<a name="l03406"></a>03406     }
<a name="l03407"></a>03407 
<a name="l03408"></a>03408     <span class="keywordflow">while</span> ((dname = g_dir_read_name (dir)) != NULL) {
<a name="l03409"></a>03409         sub_path = g_build_filename (path, dname, NULL);
<a name="l03410"></a>03410 
<a name="l03411"></a>03411         <span class="keywordflow">if</span> (lstat (sub_path, &amp;st) &lt; 0) {
<a name="l03412"></a>03412             seaf_warning (<span class="stringliteral">&quot;Failed to stat %s.\n&quot;</span>, sub_path);
<a name="l03413"></a>03413             <span class="keywordflow">continue</span>;
<a name="l03414"></a>03414         }
<a name="l03415"></a>03415 
<a name="l03416"></a>03416         <span class="keywordflow">if</span> (S_ISDIR(st.st_mode)) {
<a name="l03417"></a>03417             delete_worktree_dir_recursive (sub_path);
<a name="l03418"></a>03418         } <span class="keywordflow">else</span> {
<a name="l03419"></a>03419             <span class="comment">/* Delete all other file types. */</span>
<a name="l03420"></a>03420             <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a26f091009701c5a9d1886b9d6ceb9c8e">seaf_util_unlink</a> (sub_path) &lt; 0) {
<a name="l03421"></a>03421                 seaf_warning (<span class="stringliteral">&quot;Failed to delete file %s: %s.\n&quot;</span>,
<a name="l03422"></a>03422                               sub_path, strerror(errno));
<a name="l03423"></a>03423             }
<a name="l03424"></a>03424         }
<a name="l03425"></a>03425 
<a name="l03426"></a>03426         g_free (sub_path);
<a name="l03427"></a>03427     }
<a name="l03428"></a>03428 
<a name="l03429"></a>03429     g_dir_close (dir);
<a name="l03430"></a>03430 
<a name="l03431"></a>03431     <span class="keywordflow">if</span> (g_rmdir (path) &lt; 0) {
<a name="l03432"></a>03432         seaf_warning (<span class="stringliteral">&quot;Failed to delete dir %s: %s.\n&quot;</span>, path, strerror(errno));
<a name="l03433"></a>03433     }
<a name="l03434"></a>03434 }
<a name="l03435"></a>03435 
<a name="l03436"></a>03436 <span class="preprocessor">#endif  </span><span class="comment">/* WIN32 */</span>
<a name="l03437"></a>03437 
<a name="l03438"></a>03438 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l03439"></a>03439 delete_worktree_dir (<span class="keyword">const</span> <span class="keywordtype">char</span> *worktree, <span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l03440"></a>03440 {
<a name="l03441"></a>03441     <span class="keywordtype">char</span> *full_path = g_build_path (<span class="stringliteral">&quot;/&quot;</span>, worktree, path, NULL);
<a name="l03442"></a>03442 
<a name="l03443"></a>03443 <span class="preprocessor">#ifdef WIN32</span>
<a name="l03444"></a>03444 <span class="preprocessor"></span>    <span class="keywordtype">wchar_t</span> *full_path_w = win32_long_path (full_path);
<a name="l03445"></a>03445     delete_worktree_dir_recursive_win32 (worktree, full_path_w);
<a name="l03446"></a>03446     g_free (full_path_w);
<a name="l03447"></a>03447 <span class="preprocessor">#else</span>
<a name="l03448"></a>03448 <span class="preprocessor"></span>    delete_worktree_dir_recursive(full_path);
<a name="l03449"></a>03449 <span class="preprocessor">#endif</span>
<a name="l03450"></a>03450 <span class="preprocessor"></span>
<a name="l03451"></a>03451     g_free (full_path);
<a name="l03452"></a>03452 }
<a name="l03453"></a>03453 
<a name="l03454"></a><a class="code" href="daemon_2repo-mgr_8c.html#a4ee85b8b11bc0c69227a8c331a8d9d30">03454</a> <span class="preprocessor">#define UPDATE_CACHE_SIZE_LIMIT 100 * (1 &lt;&lt; 20) </span><span class="comment">/* 100MB */</span>
<a name="l03455"></a>03455 
<a name="l03456"></a>03456 <span class="keywordtype">int</span>
<a name="l03457"></a><a class="code" href="daemon_2repo-mgr_8c.html#a3ae125d7fd328d8d141dc38710ffd24e">03457</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a3ae125d7fd328d8d141dc38710ffd24e">seaf_repo_fetch_and_checkout</a> (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task,
<a name="l03458"></a>03458                               <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *http_task,
<a name="l03459"></a>03459                               gboolean is_http,
<a name="l03460"></a>03460                               <span class="keyword">const</span> <span class="keywordtype">char</span> *remote_head_id)
<a name="l03461"></a>03461 {
<a name="l03462"></a>03462     <span class="keywordtype">char</span> *repo_id;
<a name="l03463"></a>03463     <span class="keywordtype">int</span> repo_version;
<a name="l03464"></a>03464     gboolean is_clone;
<a name="l03465"></a>03465     <span class="keywordtype">char</span> *worktree;
<a name="l03466"></a>03466     <span class="keywordtype">char</span> *passwd;
<a name="l03467"></a>03467 
<a name="l03468"></a>03468     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
<a name="l03469"></a>03469     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *master = NULL;
<a name="l03470"></a>03470     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *remote_head = NULL, *master_head = NULL;
<a name="l03471"></a>03471     <span class="keywordtype">char</span> <a class="code" href="index_8c.html#a35caece3e3575d32521f820a8f0a24a7">index_path</a>[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
<a name="l03472"></a>03472     <span class="keyword">struct </span><a class="code" href="structindex__state.html">index_state</a> istate;
<a name="l03473"></a>03473     <span class="keywordtype">int</span> ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a3bd7bd125dc75983ea384746da28fbbb">FETCH_CHECKOUT_SUCCESS</a>;
<a name="l03474"></a>03474     GList *results = NULL;
<a name="l03475"></a>03475     <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt = NULL;
<a name="l03476"></a>03476     GHashTable *conflict_hash = NULL, *no_conflict_hash = NULL;
<a name="l03477"></a>03477     GList *ignore_list = NULL;
<a name="l03478"></a>03478     <a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset = NULL;
<a name="l03479"></a>03479 
<a name="l03480"></a>03480     <span class="keywordflow">if</span> (is_http) {
<a name="l03481"></a>03481         repo_id = http_task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>;
<a name="l03482"></a>03482         repo_version = http_task-&gt;<a class="code" href="struct__HttpTxTask.html#af0d9bc0f4289e7b270fd7398d2bf3b6d">repo_version</a>;
<a name="l03483"></a>03483         is_clone = http_task-&gt;<a class="code" href="struct__HttpTxTask.html#a8dc7ba305c249ab73ce9424725776d41">is_clone</a>;
<a name="l03484"></a>03484         worktree = http_task-&gt;<a class="code" href="struct__HttpTxTask.html#aa3f98febcc990a1b3ac304baa0f7d800">worktree</a>;
<a name="l03485"></a>03485         passwd = http_task-&gt;<a class="code" href="struct__HttpTxTask.html#a1a4bf0844a0d15f8128fbaa521e649f1">passwd</a>;
<a name="l03486"></a>03486     } <span class="keywordflow">else</span> {
<a name="l03487"></a>03487         repo_id = task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>;
<a name="l03488"></a>03488         repo_version = task-&gt;<a class="code" href="struct__TransferTask.html#a0e5952dd77a930029e2c12b808ad5fe4">repo_version</a>;
<a name="l03489"></a>03489         is_clone = task-&gt;<a class="code" href="struct__TransferTask.html#a4462883da6780feae2b41060e5b48456">is_clone</a>;
<a name="l03490"></a>03490         worktree = task-&gt;<a class="code" href="struct__TransferTask.html#a0a8e92f99b30194a9e2315f3b70b5c13">worktree</a>;
<a name="l03491"></a>03491         passwd = task-&gt;<a class="code" href="struct__TransferTask.html#a5d04ab09b9dd283c65cb78d1918164b2">passwd</a>;
<a name="l03492"></a>03492     }
<a name="l03493"></a>03493 
<a name="l03494"></a>03494     memset (&amp;istate, 0, <span class="keyword">sizeof</span>(istate));
<a name="l03495"></a>03495     snprintf (index_path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>,
<a name="l03496"></a>03496               <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>, repo_id);
<a name="l03497"></a>03497     <span class="keywordflow">if</span> (<a class="code" href="index_8c.html#a0f9de2761514c9136fb4b9c5541ef6f8">read_index_from</a> (&amp;istate, index_path, repo_version) &lt; 0) {
<a name="l03498"></a>03498         g_warning (<span class="stringliteral">&quot;Failed to load index.\n&quot;</span>);
<a name="l03499"></a>03499         <span class="keywordflow">return</span> <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;
<a name="l03500"></a>03500     }
<a name="l03501"></a>03501 
<a name="l03502"></a>03502     <span class="keywordflow">if</span> (!is_clone) {
<a name="l03503"></a>03503         repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id);
<a name="l03504"></a>03504         <span class="keywordflow">if</span> (!repo) {
<a name="l03505"></a>03505             seaf_warning (<span class="stringliteral">&quot;Failed to get repo %.8s.\n&quot;</span>, repo_id);
<a name="l03506"></a>03506             <span class="keywordflow">goto</span> out;
<a name="l03507"></a>03507         }
<a name="l03508"></a>03508 
<a name="l03509"></a>03509         master = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>,
<a name="l03510"></a>03510                                                  repo_id, <span class="stringliteral">&quot;master&quot;</span>);
<a name="l03511"></a>03511         <span class="keywordflow">if</span> (!master) {
<a name="l03512"></a>03512             seaf_warning (<span class="stringliteral">&quot;Failed to get master branch for repo %.8s.\n&quot;</span>,
<a name="l03513"></a>03513                           repo_id);
<a name="l03514"></a>03514             ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;
<a name="l03515"></a>03515             <span class="keywordflow">goto</span> out;
<a name="l03516"></a>03516         }
<a name="l03517"></a>03517 
<a name="l03518"></a>03518         master_head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l03519"></a>03519                                                       repo_id,
<a name="l03520"></a>03520                                                       repo_version,
<a name="l03521"></a>03521                                                       master-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l03522"></a>03522         <span class="keywordflow">if</span> (!master_head) {
<a name="l03523"></a>03523             seaf_warning (<span class="stringliteral">&quot;Failed to get master head %s of repo %.8s.\n&quot;</span>,
<a name="l03524"></a>03524                           repo_id, master-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l03525"></a>03525             ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;
<a name="l03526"></a>03526             <span class="keywordflow">goto</span> out;
<a name="l03527"></a>03527         }
<a name="l03528"></a>03528     }
<a name="l03529"></a>03529 
<a name="l03530"></a>03530     <span class="keywordflow">if</span> (!is_clone)
<a name="l03531"></a>03531         worktree = repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>;
<a name="l03532"></a>03532 
<a name="l03533"></a>03533     remote_head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l03534"></a>03534                                                   repo_id,
<a name="l03535"></a>03535                                                   repo_version,
<a name="l03536"></a>03536                                                   remote_head_id);
<a name="l03537"></a>03537     <span class="keywordflow">if</span> (!remote_head) {
<a name="l03538"></a>03538         seaf_warning (<span class="stringliteral">&quot;Failed to get remote head %s of repo %.8s.\n&quot;</span>,
<a name="l03539"></a>03539                       repo_id, remote_head_id);
<a name="l03540"></a>03540         ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;
<a name="l03541"></a>03541         <span class="keywordflow">goto</span> out;
<a name="l03542"></a>03542     }
<a name="l03543"></a>03543 
<a name="l03544"></a>03544     <span class="keywordflow">if</span> (<a class="code" href="diff-simple_8c.html#a76134c9482b81d9ff5455eac2765a656">diff_commit_roots</a> (repo_id, repo_version,
<a name="l03545"></a>03545                            master_head ? master_head-&gt;root_id : <a class="code" href="seafile-4_81_82_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>,
<a name="l03546"></a>03546                            remote_head-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
<a name="l03547"></a>03547                            &amp;results, TRUE) &lt; 0) {
<a name="l03548"></a>03548         seaf_warning (<span class="stringliteral">&quot;Failed to diff for repo %.8s.\n&quot;</span>, repo_id);
<a name="l03549"></a>03549         ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;
<a name="l03550"></a>03550         <span class="keywordflow">goto</span> out;
<a name="l03551"></a>03551     }
<a name="l03552"></a>03552 
<a name="l03553"></a>03553     GList *ptr;
<a name="l03554"></a>03554     <a class="code" href="structDiffEntry.html">DiffEntry</a> *de;
<a name="l03555"></a>03555 
<a name="l03556"></a>03556     <span class="comment">/* Expand DIR_ADDED diff entries. */</span>
<a name="l03557"></a>03557     <span class="keywordflow">if</span> (expand_diff_results (repo_id, repo_version,
<a name="l03558"></a>03558                              remote_head-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
<a name="l03559"></a>03559                              master_head ? master_head-&gt;root_id : EMPTY_SHA1,
<a name="l03560"></a>03560                              &amp;results) &lt; 0) {
<a name="l03561"></a>03561         ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ac2960941ae6f238c4fbaf2473ce569b7">FETCH_CHECKOUT_FAILED</a>;
<a name="l03562"></a>03562         <span class="keywordflow">goto</span> out;
<a name="l03563"></a>03563     }
<a name="l03564"></a>03564 
<a name="l03565"></a>03565 <span class="preprocessor">#ifdef WIN32</span>
<a name="l03566"></a>03566 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (ptr = results; ptr; ptr = ptr-&gt;next) {
<a name="l03567"></a>03567         de = ptr-&gt;data;
<a name="l03568"></a>03568         <span class="keywordflow">if</span> (de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a7ebaae7e72a366dbc3aba360e5e9957c">DIFF_STATUS_DIR_RENAMED</a> ||
<a name="l03569"></a>03569             de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a820629607c6c8a44530724c2c9bc4974">DIFF_STATUS_DIR_DELETED</a>) {
<a name="l03570"></a>03570             <span class="keywordflow">if</span> (<a class="code" href="vc-utils_8h.html#a88a07e43e3943080e6105849af3658eb">do_check_dir_locked</a> (de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, worktree)) {
<a name="l03571"></a>03571                 seaf_message (<span class="stringliteral">&quot;File(s) in dir %s are locked by other program, &quot;</span>
<a name="l03572"></a>03572                               <span class="stringliteral">&quot;skip rename/delete.\n&quot;</span>, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);
<a name="l03573"></a>03573                 ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a662e1ae03ecdd8c6d02c7195e332d3ce">FETCH_CHECKOUT_LOCKED</a>;
<a name="l03574"></a>03574                 <span class="keywordflow">goto</span> out;
<a name="l03575"></a>03575             }
<a name="l03576"></a>03576         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#abcf4512ebeae34bfed839057e70a72c2">DIFF_STATUS_RENAMED</a>) {
<a name="l03577"></a>03577             <span class="keywordflow">if</span> (<a class="code" href="vc-utils_8h.html#ade755cc297b064bd93b1527533979454">do_check_file_locked</a> (de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, worktree)) {
<a name="l03578"></a>03578                 seaf_message (<span class="stringliteral">&quot;File %s is locked by other program, skip rename.\n&quot;</span>,
<a name="l03579"></a>03579                               de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);
<a name="l03580"></a>03580                 ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a662e1ae03ecdd8c6d02c7195e332d3ce">FETCH_CHECKOUT_LOCKED</a>;
<a name="l03581"></a>03581                 <span class="keywordflow">goto</span> out;
<a name="l03582"></a>03582             }
<a name="l03583"></a>03583         }
<a name="l03584"></a>03584     }
<a name="l03585"></a>03585 <span class="preprocessor">#endif</span>
<a name="l03586"></a>03586 <span class="preprocessor"></span>
<a name="l03587"></a>03587     <span class="keywordflow">if</span> (remote_head-&gt;<a class="code" href="struct__SeafCommit.html#a906e77d2a658f4337437ff8694a4bfc0">encrypted</a>) {
<a name="l03588"></a>03588         <span class="keywordflow">if</span> (!is_clone) {
<a name="l03589"></a>03589             crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>,
<a name="l03590"></a>03590                                        repo-&gt;<a class="code" href="struct__SeafRepo.html#ad951f63e287f0ea14c863937afea6779">enc_key</a>,
<a name="l03591"></a>03591                                        repo-&gt;<a class="code" href="struct__SeafRepo.html#a7ad105e1fab206035f1c585c25e0dc94">enc_iv</a>);
<a name="l03592"></a>03592         } <span class="keywordflow">else</span> {
<a name="l03593"></a>03593             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> enc_key[32], enc_iv[16];
<a name="l03594"></a>03594             <a class="code" href="seafile-crypt_8c.html#af0dc7b06b352baa5469b21beec40f73a">seafile_decrypt_repo_enc_key</a> (remote_head-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a>,
<a name="l03595"></a>03595                                           passwd,
<a name="l03596"></a>03596                                           remote_head-&gt;<a class="code" href="struct__SeafCommit.html#ab1d44814bc44472105aef8761656e3d7">random_key</a>,
<a name="l03597"></a>03597                                           enc_key, enc_iv);
<a name="l03598"></a>03598             crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (remote_head-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a>,
<a name="l03599"></a>03599                                        enc_key, enc_iv);
<a name="l03600"></a>03600         }
<a name="l03601"></a>03601     }
<a name="l03602"></a>03602 
<a name="l03603"></a>03603     conflict_hash = g_hash_table_new_full (g_str_hash, g_str_equal,
<a name="l03604"></a>03604                                            g_free, g_free);
<a name="l03605"></a>03605     no_conflict_hash = g_hash_table_new_full (g_str_hash, g_str_equal,
<a name="l03606"></a>03606                                               g_free, NULL);
<a name="l03607"></a>03607 
<a name="l03608"></a>03608     ignore_list = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#abdf6d76830c08b16b49d76e2f34037a5">seaf_repo_load_ignore_files</a> (worktree);
<a name="l03609"></a>03609 
<a name="l03610"></a>03610     <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *ce;
<a name="l03611"></a>03611 
<a name="l03612"></a>03612     <span class="keywordflow">for</span> (ptr = results; ptr; ptr = ptr-&gt;next) {
<a name="l03613"></a>03613         de = ptr-&gt;data;
<a name="l03614"></a>03614         <span class="keywordflow">if</span> (de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a8a5184ba68f5168383e7a1017e89e290">DIFF_STATUS_ADDED</a> || de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a94791401bdf8fe513b0a744823436190">DIFF_STATUS_MODIFIED</a>) {
<a name="l03615"></a>03615             <span class="keywordflow">if</span> (!is_http)
<a name="l03616"></a>03616                 ++(task-&gt;<a class="code" href="struct__TransferTask.html#a3271f44397eb71c95a51afa70b8743d3">n_to_download</a>);
<a name="l03617"></a>03617             <span class="keywordflow">else</span>
<a name="l03618"></a>03618                 ++(http_task-&gt;<a class="code" href="struct__HttpTxTask.html#a89a08e86e788096b51d35c7d6244f115">n_files</a>);
<a name="l03619"></a>03619         }
<a name="l03620"></a>03620     }
<a name="l03621"></a>03621 
<a name="l03622"></a>03622 <span class="preprocessor">#ifdef WIN32</span>
<a name="l03623"></a>03623 <span class="preprocessor"></span>    fset = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a06294e91365be10d46a356d427f62e07">seaf_repo_manager_get_locked_file_set</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id);
<a name="l03624"></a>03624 <span class="preprocessor">#endif</span>
<a name="l03625"></a>03625 <span class="preprocessor"></span>
<a name="l03626"></a>03626     <span class="keywordflow">for</span> (ptr = results; ptr; ptr = ptr-&gt;next) {
<a name="l03627"></a>03627         de = ptr-&gt;data;
<a name="l03628"></a>03628         <span class="keywordflow">if</span> (de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a33f1598ea0372aa7bd1dcf4b36bad9e8">DIFF_STATUS_DELETED</a>) {
<a name="l03629"></a>03629             seaf_debug (<span class="stringliteral">&quot;Delete file %s.\n&quot;</span>, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);
<a name="l03630"></a>03630 
<a name="l03631"></a>03631             ce = <a class="code" href="index_8c.html#a3931a94c55aad8bf8267f179ae846711">index_name_exists</a> (&amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, strlen(de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>), 0);
<a name="l03632"></a>03632             <span class="keywordflow">if</span> (!ce)
<a name="l03633"></a>03633                 <span class="keywordflow">continue</span>;
<a name="l03634"></a>03634 
<a name="l03635"></a>03635 <span class="preprocessor">#ifdef WIN32</span>
<a name="l03636"></a>03636 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!<a class="code" href="vc-utils_8h.html#ade755cc297b064bd93b1527533979454">do_check_file_locked</a> (de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, worktree)) {
<a name="l03637"></a>03637                 <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a4d1dacc802b818970800154a9bc6e3db">locked_file_set_remove</a> (fset, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, FALSE);
<a name="l03638"></a>03638                 <a class="code" href="vc-utils_8c.html#afe4721091f815b2382d2cc8b30e97cf0">delete_path</a> (worktree, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, de-&gt;mode, ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a>);
<a name="l03639"></a>03639             } <span class="keywordflow">else</span> {
<a name="l03640"></a>03640                 <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a8782ae78d069d4073a35d981b04a2a88">locked_file_set_add_update</a> (fset, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, <a class="code" href="daemon_2repo-mgr_8h.html#ae9d9b81961c1ed4497f7f808c6be96ed">LOCKED_OP_DELETE</a>,
<a name="l03641"></a>03641                                             ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a>, NULL);
<a name="l03642"></a>03642             }
<a name="l03643"></a>03643 <span class="preprocessor">#else</span>
<a name="l03644"></a>03644 <span class="preprocessor"></span>            <a class="code" href="vc-utils_8c.html#afe4721091f815b2382d2cc8b30e97cf0">delete_path</a> (worktree, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, de-&gt;mode, ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a>);
<a name="l03645"></a>03645 <span class="preprocessor">#endif</span>
<a name="l03646"></a>03646 <span class="preprocessor"></span>
<a name="l03647"></a>03647             <a class="code" href="index_8c.html#a86bf1084dfc4e0057a52b4da1922de9b">remove_from_index_with_prefix</a> (&amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, NULL);
<a name="l03648"></a>03648             try_add_empty_parent_dir_entry (worktree, &amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);
<a name="l03649"></a>03649         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a820629607c6c8a44530724c2c9bc4974">DIFF_STATUS_DIR_DELETED</a>) {
<a name="l03650"></a>03650             seaf_debug (<span class="stringliteral">&quot;Delete dir %s.\n&quot;</span>, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);
<a name="l03651"></a>03651 
<a name="l03652"></a>03652             <span class="comment">/* Nothing to delete. */</span>
<a name="l03653"></a>03653             <span class="keywordflow">if</span> (!master_head || strcmp(master_head-&gt;root_id, EMPTY_SHA1) == 0)
<a name="l03654"></a>03654                 <span class="keywordflow">continue</span>;
<a name="l03655"></a>03655 
<a name="l03656"></a>03656             delete_worktree_dir (worktree, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);
<a name="l03657"></a>03657 
<a name="l03658"></a>03658             <span class="comment">/* Remove all index entries under this directory */</span>
<a name="l03659"></a>03659             <a class="code" href="index_8c.html#a86bf1084dfc4e0057a52b4da1922de9b">remove_from_index_with_prefix</a> (&amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, NULL);
<a name="l03660"></a>03660 
<a name="l03661"></a>03661             try_add_empty_parent_dir_entry (worktree, &amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);
<a name="l03662"></a>03662         }
<a name="l03663"></a>03663     }
<a name="l03664"></a>03664 
<a name="l03665"></a>03665     <span class="keywordflow">for</span> (ptr = results; ptr; ptr = ptr-&gt;next) {
<a name="l03666"></a>03666         de = ptr-&gt;data;
<a name="l03667"></a>03667         <span class="keywordflow">if</span> (de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#abcf4512ebeae34bfed839057e70a72c2">DIFF_STATUS_RENAMED</a> ||
<a name="l03668"></a>03668             de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a7ebaae7e72a366dbc3aba360e5e9957c">DIFF_STATUS_DIR_RENAMED</a>) {
<a name="l03669"></a>03669             seaf_debug (<span class="stringliteral">&quot;Rename %s to %s.\n&quot;</span>, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, de-&gt;<a class="code" href="structDiffEntry.html#acfe7cac599e8737146318883029c26e9">new_name</a>);
<a name="l03670"></a>03670 
<a name="l03671"></a>03671             do_rename_in_worktree (de, worktree, conflict_hash, no_conflict_hash);
<a name="l03672"></a>03672 
<a name="l03673"></a>03673             <a class="code" href="index_8c.html#a56d1945a0677d925b25c610d613aeefc">rename_index_entries</a> (&amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, de-&gt;<a class="code" href="structDiffEntry.html#acfe7cac599e8737146318883029c26e9">new_name</a>, NULL);
<a name="l03674"></a>03674 
<a name="l03675"></a>03675             <span class="comment">/* Moving files out of a dir may make it empty. */</span>
<a name="l03676"></a>03676             try_add_empty_parent_dir_entry (worktree, &amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);
<a name="l03677"></a>03677         }
<a name="l03678"></a>03678     }
<a name="l03679"></a>03679 
<a name="l03680"></a>03680     <span class="keywordflow">if</span> (istate.<a class="code" href="structindex__state.html#a8e22a9fe2486576488e72fe97801ebe5">cache_changed</a>)
<a name="l03681"></a>03681         <a class="code" href="vc-utils_8c.html#ab93fff6b962d6fd7482c95d17c8bf6eb">update_index</a> (&amp;istate, index_path);
<a name="l03682"></a>03682 
<a name="l03683"></a>03683     gint64 checkout_size = 0;
<a name="l03684"></a>03684     <span class="keywordtype">int</span> rc;
<a name="l03685"></a>03685     <span class="keywordflow">for</span> (ptr = results; ptr; ptr = ptr-&gt;next) {
<a name="l03686"></a>03686         de = ptr-&gt;data;
<a name="l03687"></a>03687 
<a name="l03688"></a>03688         <span class="keywordflow">if</span> (de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a8a5184ba68f5168383e7a1017e89e290">DIFF_STATUS_ADDED</a> ||
<a name="l03689"></a>03689             de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a94791401bdf8fe513b0a744823436190">DIFF_STATUS_MODIFIED</a>) {
<a name="l03690"></a>03690             seaf_debug (<span class="stringliteral">&quot;Checkout file %s.\n&quot;</span>, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);
<a name="l03691"></a>03691 
<a name="l03692"></a>03692             gboolean add_ce = FALSE;
<a name="l03693"></a>03693             gboolean is_locked = FALSE;
<a name="l03694"></a>03694             <span class="keywordtype">char</span> file_id[41];
<a name="l03695"></a>03695 
<a name="l03696"></a>03696             <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a> (de-&gt;<a class="code" href="structDiffEntry.html#a3329ba035605e868d00fb3b773ae021d">sha1</a>, file_id, 20);
<a name="l03697"></a>03697 
<a name="l03698"></a>03698             ce = <a class="code" href="index_8c.html#a3931a94c55aad8bf8267f179ae846711">index_name_exists</a> (&amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, strlen(de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>), 0);
<a name="l03699"></a>03699             <span class="keywordflow">if</span> (!ce) {
<a name="l03700"></a>03700                 ce = cache_entry_from_diff_entry (de);
<a name="l03701"></a>03701                 add_ce = TRUE;
<a name="l03702"></a>03702             }
<a name="l03703"></a>03703 
<a name="l03704"></a>03704             <span class="keywordflow">if</span> (!should_ignore_on_checkout (de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>)) {
<a name="l03705"></a>03705 <span class="preprocessor">#ifdef WIN32</span>
<a name="l03706"></a>03706 <span class="preprocessor"></span>                is_locked = <a class="code" href="vc-utils_8h.html#ade755cc297b064bd93b1527533979454">do_check_file_locked</a> (de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, worktree);
<a name="l03707"></a>03707 <span class="preprocessor">#endif</span>
<a name="l03708"></a>03708 <span class="preprocessor"></span>
<a name="l03709"></a>03709                 rc = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a450e5bcc50da4c40b7ba2bde33a22a84">checkout_file</a> (repo_id,
<a name="l03710"></a>03710                                     repo_version,
<a name="l03711"></a>03711                                     worktree,
<a name="l03712"></a>03712                                     de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>,
<a name="l03713"></a>03713                                     file_id,
<a name="l03714"></a>03714                                     de-&gt;mtime,
<a name="l03715"></a>03715                                     de-&gt;mode,
<a name="l03716"></a>03716                                     crypt,
<a name="l03717"></a>03717                                     ce,
<a name="l03718"></a>03718                                     task,
<a name="l03719"></a>03719                                     http_task,
<a name="l03720"></a>03720                                     is_http,
<a name="l03721"></a>03721                                     remote_head_id,
<a name="l03722"></a>03722                                     conflict_hash,
<a name="l03723"></a>03723                                     no_conflict_hash,
<a name="l03724"></a>03724                                     is_locked);
<a name="l03725"></a>03725 
<a name="l03726"></a>03726                 <span class="comment">/* Even if the file failed to check out, still need to update index.</span>
<a name="l03727"></a>03727 <span class="comment">                 * But we have to stop after transfer errors.</span>
<a name="l03728"></a>03728 <span class="comment">                 */</span>
<a name="l03729"></a>03729                 <span class="keywordflow">if</span> (rc == <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ae2a1e8d995b67343e5162cdb29513380">FETCH_CHECKOUT_CANCELED</a>) {
<a name="l03730"></a>03730                     seaf_debug (<span class="stringliteral">&quot;Transfer canceled.\n&quot;</span>);
<a name="l03731"></a>03731                     ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609ae2a1e8d995b67343e5162cdb29513380">FETCH_CHECKOUT_CANCELED</a>;
<a name="l03732"></a>03732                     <span class="keywordflow">if</span> (add_ce)
<a name="l03733"></a>03733                         <a class="code" href="index_8c.html#a156a4ea461fcf14e0b73755b02e7e7d1">cache_entry_free</a> (ce);
<a name="l03734"></a>03734                     <span class="keywordflow">goto</span> out;
<a name="l03735"></a>03735                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a4a1718c70eba70651160111e48589161">FETCH_CHECKOUT_TRANSFER_ERROR</a>) {
<a name="l03736"></a>03736                     seaf_warning (<span class="stringliteral">&quot;Transfer failed.\n&quot;</span>);
<a name="l03737"></a>03737                     ret = <a class="code" href="daemon_2repo-mgr_8h.html#a458e651af6690959efa2afb96be7d609a4a1718c70eba70651160111e48589161">FETCH_CHECKOUT_TRANSFER_ERROR</a>;
<a name="l03738"></a>03738                     <span class="keywordflow">if</span> (add_ce)
<a name="l03739"></a>03739                         <a class="code" href="index_8c.html#a156a4ea461fcf14e0b73755b02e7e7d1">cache_entry_free</a> (ce);
<a name="l03740"></a>03740                     <span class="keywordflow">goto</span> out;
<a name="l03741"></a>03741                 }
<a name="l03742"></a>03742 
<a name="l03743"></a>03743                 <span class="keywordflow">if</span> (!is_locked) {
<a name="l03744"></a>03744                     cleanup_file_blocks (repo_id, repo_version, file_id);
<a name="l03745"></a>03745                 } <span class="keywordflow">else</span> {
<a name="l03746"></a>03746 <span class="preprocessor">#ifdef WIN32</span>
<a name="l03747"></a>03747 <span class="preprocessor"></span>                    <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a8782ae78d069d4073a35d981b04a2a88">locked_file_set_add_update</a> (fset, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a73695736a3b6d6bc38b8a7e439dba0b4">LOCKED_OP_UPDATE</a>,
<a name="l03748"></a>03748                                                 ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a>, file_id);
<a name="l03749"></a>03749 <span class="preprocessor">#endif</span>
<a name="l03750"></a>03750 <span class="preprocessor"></span>                }
<a name="l03751"></a>03751             }
<a name="l03752"></a>03752 
<a name="l03753"></a>03753             <span class="keywordflow">if</span> (!is_http)
<a name="l03754"></a>03754                 ++(task-&gt;<a class="code" href="struct__TransferTask.html#a70063517880957e979f6f222bec67220">n_downloaded</a>);
<a name="l03755"></a>03755             <span class="keywordflow">else</span>
<a name="l03756"></a>03756                 ++(http_task-&gt;<a class="code" href="struct__HttpTxTask.html#a60379872ec333476dfd2b86f9fb0864d">done_files</a>);
<a name="l03757"></a>03757 
<a name="l03758"></a>03758             <span class="keywordflow">if</span> (add_ce) {
<a name="l03759"></a>03759                 <span class="keywordflow">if</span> (!(ce-&gt;<a class="code" href="structcache__entry.html#a4dab14fd813a1bb6b67352674ff4afb2">ce_flags</a> &amp; <a class="code" href="index_8h.html#aa5ee599d9d7af67f19dba204ce9030c0">CE_REMOVE</a>)) {
<a name="l03760"></a>03760                     <a class="code" href="index_8c.html#afafdfbe15ca205599303d6e2230886c0">add_index_entry</a> (&amp;istate, ce,
<a name="l03761"></a>03761                                      (<a class="code" href="index_8h.html#a4e7659151088d67c163cc90e6f12c39c">ADD_CACHE_OK_TO_ADD</a>|<a class="code" href="index_8h.html#a6b5725eef5481c5f354df57bd32a4d87">ADD_CACHE_OK_TO_REPLACE</a>));
<a name="l03762"></a>03762                 }
<a name="l03763"></a>03763             } <span class="keywordflow">else</span> {
<a name="l03764"></a>03764                 ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a> = de-&gt;mtime;
<a name="l03765"></a>03765                 ce-&gt;<a class="code" href="structcache__entry.html#a869a62534c704e5d24ee26cf2f7b86b7">ce_size</a> = de-&gt;size;
<a name="l03766"></a>03766                 memcpy (ce-&gt;<a class="code" href="structcache__entry.html#a119ab5c5e9db495e6e5f8d301f01421c">sha1</a>, de-&gt;<a class="code" href="structDiffEntry.html#a3329ba035605e868d00fb3b773ae021d">sha1</a>, 20);
<a name="l03767"></a>03767                 <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="structcache__entry.html#a786aa5bc6234542fe202023bcf721afd">modifier</a>) g_free (ce-&gt;<a class="code" href="structcache__entry.html#a786aa5bc6234542fe202023bcf721afd">modifier</a>);
<a name="l03768"></a>03768                 ce-&gt;<a class="code" href="structcache__entry.html#a786aa5bc6234542fe202023bcf721afd">modifier</a> = g_strdup(de-&gt;modifier);
<a name="l03769"></a>03769                 ce-&gt;<a class="code" href="structcache__entry.html#a5fcbcc4e7265ae8150f136380ed92c05">ce_mode</a> = create_ce_mode (de-&gt;mode);
<a name="l03770"></a>03770             }
<a name="l03771"></a>03771 
<a name="l03772"></a>03772             <span class="comment">/* Save index file to disk after checking out some size of files.</span>
<a name="l03773"></a>03773 <span class="comment">             * This way we don&#39;t need to re-compare too many files if this</span>
<a name="l03774"></a>03774 <span class="comment">             * checkout is interrupted.</span>
<a name="l03775"></a>03775 <span class="comment">             */</span>
<a name="l03776"></a>03776             checkout_size += ce-&gt;<a class="code" href="structcache__entry.html#a869a62534c704e5d24ee26cf2f7b86b7">ce_size</a>;
<a name="l03777"></a>03777             <span class="keywordflow">if</span> (checkout_size &gt;= <a class="code" href="daemon_2repo-mgr_8c.html#a4ee85b8b11bc0c69227a8c331a8d9d30">UPDATE_CACHE_SIZE_LIMIT</a>) {
<a name="l03778"></a>03778                 seaf_debug (<span class="stringliteral">&quot;Save index file.\n&quot;</span>);
<a name="l03779"></a>03779                 <a class="code" href="vc-utils_8c.html#ab93fff6b962d6fd7482c95d17c8bf6eb">update_index</a> (&amp;istate, index_path);
<a name="l03780"></a>03780                 checkout_size = 0;
<a name="l03781"></a>03781             }
<a name="l03782"></a>03782         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (de-&gt;<a class="code" href="structDiffEntry.html#a93a8fc375b3837c75c9b79157ab98d0a">status</a> == <a class="code" href="diff-simple_8h.html#a36e1b9c5a30fee84055977065fd0265d">DIFF_STATUS_DIR_ADDED</a>) {
<a name="l03783"></a>03783             seaf_debug (<span class="stringliteral">&quot;Checkout empty dir %s.\n&quot;</span>, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>);
<a name="l03784"></a>03784 
<a name="l03785"></a>03785             gboolean add_ce = FALSE;
<a name="l03786"></a>03786 
<a name="l03787"></a>03787             ce = <a class="code" href="index_8c.html#a3931a94c55aad8bf8267f179ae846711">index_name_exists</a> (&amp;istate, de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>, strlen(de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>), 0);
<a name="l03788"></a>03788             <span class="keywordflow">if</span> (!ce) {
<a name="l03789"></a>03789                 ce = cache_entry_from_diff_entry (de);
<a name="l03790"></a>03790                 add_ce = TRUE;
<a name="l03791"></a>03791             }
<a name="l03792"></a>03792 
<a name="l03793"></a>03793             <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a181f66e1d3900771c37883e97fea7fba">checkout_empty_dir</a> (worktree,
<a name="l03794"></a>03794                                 de-&gt;<a class="code" href="structDiffEntry.html#a13d88a564e6d598e93f64f211a9c160c">name</a>,
<a name="l03795"></a>03795                                 de-&gt;mtime,
<a name="l03796"></a>03796                                 ce,
<a name="l03797"></a>03797                                 conflict_hash,
<a name="l03798"></a>03798                                 no_conflict_hash);
<a name="l03799"></a>03799 
<a name="l03800"></a>03800             <span class="keywordflow">if</span> (add_ce) {
<a name="l03801"></a>03801                 <span class="keywordflow">if</span> (!(ce-&gt;<a class="code" href="structcache__entry.html#a4dab14fd813a1bb6b67352674ff4afb2">ce_flags</a> &amp; <a class="code" href="index_8h.html#aa5ee599d9d7af67f19dba204ce9030c0">CE_REMOVE</a>)) {
<a name="l03802"></a>03802                     <a class="code" href="index_8c.html#afafdfbe15ca205599303d6e2230886c0">add_index_entry</a> (&amp;istate, ce,
<a name="l03803"></a>03803                                      (<a class="code" href="index_8h.html#a4e7659151088d67c163cc90e6f12c39c">ADD_CACHE_OK_TO_ADD</a>|<a class="code" href="index_8h.html#a6b5725eef5481c5f354df57bd32a4d87">ADD_CACHE_OK_TO_REPLACE</a>));
<a name="l03804"></a>03804                 }
<a name="l03805"></a>03805             } <span class="keywordflow">else</span>
<a name="l03806"></a>03806                 ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a> = de-&gt;mtime;
<a name="l03807"></a>03807         }
<a name="l03808"></a>03808     }
<a name="l03809"></a>03809 
<a name="l03810"></a>03810     <a class="code" href="vc-utils_8c.html#ab93fff6b962d6fd7482c95d17c8bf6eb">update_index</a> (&amp;istate, index_path);
<a name="l03811"></a>03811 
<a name="l03812"></a>03812 out:
<a name="l03813"></a>03813     <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
<a name="l03814"></a>03814 
<a name="l03815"></a>03815     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (master);
<a name="l03816"></a>03816     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (master_head);
<a name="l03817"></a>03817     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (remote_head);
<a name="l03818"></a>03818 
<a name="l03819"></a>03819     <span class="keywordflow">for</span> (ptr = results; ptr; ptr = ptr-&gt;next)
<a name="l03820"></a>03820         <a class="code" href="diff-simple_8c.html#abb759117ec4b4aca623768424487f5da">diff_entry_free</a> ((<a class="code" href="structDiffEntry.html">DiffEntry</a> *)ptr-&gt;data);
<a name="l03821"></a>03821 
<a name="l03822"></a>03822     g_free (crypt);
<a name="l03823"></a>03823     <span class="keywordflow">if</span> (conflict_hash)
<a name="l03824"></a>03824         g_hash_table_destroy (conflict_hash);
<a name="l03825"></a>03825     <span class="keywordflow">if</span> (no_conflict_hash)
<a name="l03826"></a>03826         g_hash_table_destroy (no_conflict_hash);
<a name="l03827"></a>03827 
<a name="l03828"></a>03828     <span class="keywordflow">if</span> (ignore_list)
<a name="l03829"></a>03829         <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ae640da4e7db6b316cd0e3c1ba463f9bd">seaf_repo_free_ignore_files</a> (ignore_list);
<a name="l03830"></a>03830 
<a name="l03831"></a>03831 <span class="preprocessor">#ifdef WIN32</span>
<a name="l03832"></a>03832 <span class="preprocessor"></span>    <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ab44c57f5e23996e5eb807f7c84f443f5">locked_file_set_free</a> (fset);
<a name="l03833"></a>03833 <span class="preprocessor">#endif</span>
<a name="l03834"></a>03834 <span class="preprocessor"></span>
<a name="l03835"></a>03835     <span class="keywordflow">return</span> ret;
<a name="l03836"></a>03836 }
<a name="l03837"></a>03837 
<a name="l03838"></a>03838 <span class="keywordtype">int</span>
<a name="l03839"></a><a class="code" href="daemon_2repo-mgr_8c.html#a6ed05df6501a326fc58a0fefb91aef3d">03839</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a6ed05df6501a326fc58a0fefb91aef3d">seaf_repo_manager_set_repo_worktree</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l03840"></a>03840                                      <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo,
<a name="l03841"></a>03841                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree)
<a name="l03842"></a>03842 {
<a name="l03843"></a>03843     <span class="keywordflow">if</span> (g_access(worktree, F_OK) != 0)
<a name="l03844"></a>03844         <span class="keywordflow">return</span> -1;
<a name="l03845"></a>03845 
<a name="l03846"></a>03846     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>)
<a name="l03847"></a>03847         g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>);
<a name="l03848"></a>03848     repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a> = g_strdup(worktree);
<a name="l03849"></a>03849 
<a name="l03850"></a>03850     <span class="keywordflow">if</span> (<a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (mgr, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l03851"></a>03851                                              <span class="stringliteral">&quot;worktree&quot;</span>,
<a name="l03852"></a>03852                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>) &lt; 0)
<a name="l03853"></a>03853         <span class="keywordflow">return</span> -1;
<a name="l03854"></a>03854 
<a name="l03855"></a>03855     repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a> = FALSE;
<a name="l03856"></a>03856 
<a name="l03857"></a>03857     <span class="keywordflow">return</span> 0;
<a name="l03858"></a>03858 }
<a name="l03859"></a>03859 
<a name="l03860"></a>03860 <span class="keywordtype">void</span>
<a name="l03861"></a><a class="code" href="daemon_2repo-mgr_8c.html#a4002175d5613c80a6dd82b95bc1fae24">03861</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a4002175d5613c80a6dd82b95bc1fae24">seaf_repo_manager_invalidate_repo_worktree</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l03862"></a>03862                                             <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l03863"></a>03863 {
<a name="l03864"></a>03864     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a>)
<a name="l03865"></a>03865         <span class="keywordflow">return</span>;
<a name="l03866"></a>03866 
<a name="l03867"></a>03867     repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a> = TRUE;
<a name="l03868"></a>03868 
<a name="l03869"></a>03869     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a>) {
<a name="l03870"></a>03870         <span class="keywordflow">if</span> (<a class="code" href="wt-monitor_8c.html#af6eb142936b07efb92d6b4e6ef650f64">seaf_wt_monitor_unwatch_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a64fc6ad3e80ab34bd2d5ac10dfc1aa66">wt_monitor</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>) &lt; 0) {
<a name="l03871"></a>03871             g_warning (<span class="stringliteral">&quot;failed to unwatch repo %s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l03872"></a>03872         }
<a name="l03873"></a>03873     }
<a name="l03874"></a>03874 }
<a name="l03875"></a>03875 
<a name="l03876"></a>03876 <span class="keywordtype">void</span>
<a name="l03877"></a><a class="code" href="daemon_2repo-mgr_8c.html#a8299b47936df15cd58ba2ae41e344450">03877</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a8299b47936df15cd58ba2ae41e344450">seaf_repo_manager_validate_repo_worktree</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l03878"></a>03878                                           <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l03879"></a>03879 {
<a name="l03880"></a>03880     <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a>)
<a name="l03881"></a>03881         <span class="keywordflow">return</span>;
<a name="l03882"></a>03882 
<a name="l03883"></a>03883     repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a> = FALSE;
<a name="l03884"></a>03884 
<a name="l03885"></a>03885     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a>) {
<a name="l03886"></a>03886         <span class="keywordflow">if</span> (<a class="code" href="wt-monitor_8c.html#aa6375a36881f0c171399a5116e64f061">seaf_wt_monitor_watch_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a64fc6ad3e80ab34bd2d5ac10dfc1aa66">wt_monitor</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>) &lt; 0) {
<a name="l03887"></a>03887             g_warning (<span class="stringliteral">&quot;failed to watch repo %s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l03888"></a>03888         }
<a name="l03889"></a>03889     }
<a name="l03890"></a>03890 }
<a name="l03891"></a>03891 
<a name="l03892"></a>03892 <span class="keyword">static</span> <span class="keywordtype">int</span> 
<a name="l03893"></a>03893 compare_repo (<span class="keyword">const</span> <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *srepo, <span class="keyword">const</span> <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *trepo)
<a name="l03894"></a>03894 {
<a name="l03895"></a>03895     <span class="keywordflow">return</span> g_strcmp0 (srepo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, trepo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l03896"></a>03896 }
<a name="l03897"></a>03897 
<a name="l03898"></a>03898 <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a>*
<a name="l03899"></a><a class="code" href="daemon_2repo-mgr_8c.html#a8f91693d20dfa77546527064cb1097e3">03899</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a8f91693d20dfa77546527064cb1097e3">seaf_repo_manager_new</a> (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>)
<a name="l03900"></a>03900 {
<a name="l03901"></a>03901     <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = g_new0 (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a>, 1);
<a name="l03902"></a>03902 
<a name="l03903"></a>03903     mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a> = g_new0 (<a class="code" href="struct__SeafRepoManagerPriv.html">SeafRepoManagerPriv</a>, 1);
<a name="l03904"></a>03904     mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a> = <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>;
<a name="l03905"></a>03905     mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a> = g_build_path (<a class="code" href="vc-utils_8h.html#aa7da4cdc6796b13fca1a4b263488dfdd">PATH_SEPERATOR</a>, seaf-&gt;<a class="code" href="struct__SeafileSession.html#ae4df188e5674e3e4b405f14d0ee1bf9f">seaf_dir</a>, <a class="code" href="daemon_2repo-mgr_8c.html#a823aa5bebe4b4b836619cae12751b8a5">INDEX_DIR</a>, NULL);
<a name="l03906"></a>03906 
<a name="l03907"></a>03907     pthread_mutex_init (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>, NULL);
<a name="l03908"></a>03908 
<a name="l03909"></a>03909     mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a7fde21f0d7bba66fac76f4783377f20c">checkout_tasks_hash</a> = g_hash_table_new_full
<a name="l03910"></a>03910         (g_str_hash, g_str_equal, g_free, g_free);
<a name="l03911"></a>03911 
<a name="l03912"></a>03912     ignore_patterns = g_new0 (GPatternSpec*, G_N_ELEMENTS(ignore_table));
<a name="l03913"></a>03913     <span class="keywordtype">int</span> i;
<a name="l03914"></a>03914     <span class="keywordflow">for</span> (i = 0; ignore_table[i] != NULL; i++) {
<a name="l03915"></a>03915         ignore_patterns[i] = g_pattern_spec_new (ignore_table[i]);
<a name="l03916"></a>03916     }
<a name="l03917"></a>03917 
<a name="l03918"></a>03918     office_temp_ignore_patterns[0] = g_pattern_spec_new(<span class="stringliteral">&quot;~$*&quot;</span>);
<a name="l03919"></a>03919     <span class="comment">/* for files like ~WRL0001.tmp */</span>
<a name="l03920"></a>03920     office_temp_ignore_patterns[1] = g_pattern_spec_new(<span class="stringliteral">&quot;~*.tmp&quot;</span>);
<a name="l03921"></a>03921     office_temp_ignore_patterns[2] = g_pattern_spec_new(<span class="stringliteral">&quot;.~lock*#&quot;</span>);
<a name="l03922"></a>03922     office_temp_ignore_patterns[3] = NULL;
<a name="l03923"></a>03923 
<a name="l03924"></a>03924     mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a46e78181430977b311346c02e5738286">repo_hash</a> = g_hash_table_new_full (g_str_hash, g_str_equal, g_free, NULL);
<a name="l03925"></a>03925 
<a name="l03926"></a>03926     pthread_rwlock_init (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>, NULL);
<a name="l03927"></a>03927 
<a name="l03928"></a>03928     <span class="keywordflow">return</span> mgr;
<a name="l03929"></a>03929 }
<a name="l03930"></a>03930 
<a name="l03931"></a>03931 <span class="keywordtype">int</span>
<a name="l03932"></a><a class="code" href="daemon_2repo-mgr_8c.html#a8dab773e289d1148e7afec7c8614278a">03932</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a8dab773e289d1148e7afec7c8614278a">seaf_repo_manager_init</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr)
<a name="l03933"></a>03933 {
<a name="l03934"></a>03934     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ace0bdb78b60b2d088517a3e03a448e8b">checkdir_with_mkdir</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>) &lt; 0) {
<a name="l03935"></a>03935         g_warning (<span class="stringliteral">&quot;Index dir %s does not exist and is unable to create\n&quot;</span>,
<a name="l03936"></a>03936                    mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>);
<a name="l03937"></a>03937         <span class="keywordflow">return</span> -1;
<a name="l03938"></a>03938     }
<a name="l03939"></a>03939 
<a name="l03940"></a>03940     <span class="comment">/* Load all the repos into memory on the client side. */</span>
<a name="l03941"></a>03941     load_repos (mgr, mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ae4df188e5674e3e4b405f14d0ee1bf9f">seaf_dir</a>);
<a name="l03942"></a>03942 
<a name="l03943"></a>03943     <span class="keywordflow">return</span> 0;
<a name="l03944"></a>03944 }
<a name="l03945"></a>03945 
<a name="l03946"></a>03946 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l03947"></a>03947 watch_repos (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr)
<a name="l03948"></a>03948 {
<a name="l03949"></a>03949     GHashTableIter iter;
<a name="l03950"></a>03950     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l03951"></a>03951     gpointer key, value;
<a name="l03952"></a>03952 
<a name="l03953"></a>03953     g_hash_table_iter_init (&amp;iter, mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a46e78181430977b311346c02e5738286">repo_hash</a>);
<a name="l03954"></a>03954     <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
<a name="l03955"></a>03955         repo = value;
<a name="l03956"></a>03956         <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a> &amp;&amp; !repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a>) {
<a name="l03957"></a>03957             <span class="keywordflow">if</span> (<a class="code" href="wt-monitor_8c.html#aa6375a36881f0c171399a5116e64f061">seaf_wt_monitor_watch_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a64fc6ad3e80ab34bd2d5ac10dfc1aa66">wt_monitor</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>) &lt; 0) {
<a name="l03958"></a>03958                 g_warning (<span class="stringliteral">&quot;failed to watch repo %s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l03959"></a>03959                 <span class="comment">/* If we fail to add watch at the beginning, sync manager</span>
<a name="l03960"></a>03960 <span class="comment">                 * will periodically check repo status and retry.</span>
<a name="l03961"></a>03961 <span class="comment">                 */</span>
<a name="l03962"></a>03962             }
<a name="l03963"></a>03963         }
<a name="l03964"></a>03964     }
<a name="l03965"></a>03965 }
<a name="l03966"></a>03966 
<a name="l03967"></a>03967 <span class="keywordtype">int</span>
<a name="l03968"></a><a class="code" href="daemon_2repo-mgr_8c.html#a2e049cfa3d0546aaf51e7f6792e1467d">03968</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a2e049cfa3d0546aaf51e7f6792e1467d">seaf_repo_manager_start</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr)
<a name="l03969"></a>03969 {
<a name="l03970"></a>03970     watch_repos (mgr);
<a name="l03971"></a>03971 
<a name="l03972"></a>03972     <span class="keywordflow">return</span> 0;
<a name="l03973"></a>03973 }
<a name="l03974"></a>03974 
<a name="l03975"></a>03975 <a class="code" href="struct__SeafRepo.html">SeafRepo</a>*
<a name="l03976"></a><a class="code" href="daemon_2repo-mgr_8c.html#ab599ba29e40bdb918ac78060d1165c2d">03976</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ab599ba29e40bdb918ac78060d1165c2d">seaf_repo_manager_create_new_repo</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l03977"></a>03977                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>,
<a name="l03978"></a>03978                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *desc)
<a name="l03979"></a>03979 {
<a name="l03980"></a>03980     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l03981"></a>03981     <span class="keywordtype">char</span> *repo_id;
<a name="l03982"></a>03982     
<a name="l03983"></a>03983     repo_id = <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af64020f0be33abde6a2a076ff9808809">gen_uuid</a> ();
<a name="l03984"></a>03984     repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a63ab9fe4694e3d967376c911cbe2c655">seaf_repo_new</a> (repo_id, name, desc);
<a name="l03985"></a>03985     <span class="keywordflow">if</span> (!repo) {
<a name="l03986"></a>03986         g_free (repo_id);
<a name="l03987"></a>03987         <span class="keywordflow">return</span> NULL;
<a name="l03988"></a>03988     }
<a name="l03989"></a>03989     g_free (repo_id);
<a name="l03990"></a>03990 
<a name="l03991"></a>03991     <span class="comment">/* we directly create dir because it shouldn&#39;t exist */</span>
<a name="l03992"></a>03992     <span class="comment">/* if (seaf_repo_mkdir (repo, base) &lt; 0) { */</span>
<a name="l03993"></a>03993     <span class="comment">/*     seaf_repo_free (repo); */</span>
<a name="l03994"></a>03994     <span class="comment">/*     goto out; */</span>
<a name="l03995"></a>03995     <span class="comment">/* } */</span>
<a name="l03996"></a>03996 
<a name="l03997"></a>03997     <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a140616a89d5a02935665f86cf3bb744c">seaf_repo_manager_add_repo</a> (mgr, repo);
<a name="l03998"></a>03998     <span class="keywordflow">return</span> repo;
<a name="l03999"></a>03999 }
<a name="l04000"></a>04000 
<a name="l04001"></a>04001 <span class="keywordtype">int</span>
<a name="l04002"></a><a class="code" href="daemon_2repo-mgr_8c.html#a140616a89d5a02935665f86cf3bb744c">04002</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a140616a89d5a02935665f86cf3bb744c">seaf_repo_manager_add_repo</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l04003"></a>04003                             <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l04004"></a>04004 {
<a name="l04005"></a>04005     <span class="keywordtype">char</span> sql[256];
<a name="l04006"></a>04006     sqlite3 *db = manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>;
<a name="l04007"></a>04007 
<a name="l04008"></a>04008     pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04009"></a>04009 
<a name="l04010"></a>04010     snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;REPLACE INTO Repo VALUES (&#39;%s&#39;);&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l04011"></a>04011     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04012"></a>04012 
<a name="l04013"></a>04013     pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04014"></a>04014 
<a name="l04015"></a>04015     <span class="comment">/* There may be a &quot;deletion record&quot; for this repo when it was deleted</span>
<a name="l04016"></a>04016 <span class="comment">     * last time.</span>
<a name="l04017"></a>04017 <span class="comment">     */</span>
<a name="l04018"></a>04018     <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a7d2cf85f06fa2e7d459730f7494c1a65">seaf_repo_manager_remove_garbage_repo</a> (manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l04019"></a>04019 
<a name="l04020"></a>04020     repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a> = manager;
<a name="l04021"></a>04021 
<a name="l04022"></a>04022     <span class="keywordflow">if</span> (pthread_rwlock_wrlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>) &lt; 0) {
<a name="l04023"></a>04023         g_warning (<span class="stringliteral">&quot;[repo mgr] failed to lock repo cache.\n&quot;</span>);
<a name="l04024"></a>04024         <span class="keywordflow">return</span> -1;
<a name="l04025"></a>04025     }
<a name="l04026"></a>04026 
<a name="l04027"></a>04027     g_hash_table_insert (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a46e78181430977b311346c02e5738286">repo_hash</a>, g_strdup(repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>), repo);
<a name="l04028"></a>04028 
<a name="l04029"></a>04029     pthread_rwlock_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);
<a name="l04030"></a>04030 
<a name="l04031"></a>04031     <span class="keywordflow">return</span> 0;
<a name="l04032"></a>04032 }
<a name="l04033"></a>04033 
<a name="l04034"></a>04034 <span class="keywordtype">int</span>
<a name="l04035"></a><a class="code" href="daemon_2repo-mgr_8c.html#ad41b6fcdbf4fdfa7d70daf98af124460">04035</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ad41b6fcdbf4fdfa7d70daf98af124460">seaf_repo_manager_mark_repo_deleted</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr, <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l04036"></a>04036 {
<a name="l04037"></a>04037     <span class="keywordtype">char</span> sql[256];
<a name="l04038"></a>04038 
<a name="l04039"></a>04039     pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04040"></a>04040 
<a name="l04041"></a>04041     snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;INSERT INTO DeletedRepo VALUES (&#39;%s&#39;)&quot;</span>,
<a name="l04042"></a>04042               repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l04043"></a>04043     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql) &lt; 0) {
<a name="l04044"></a>04044         pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04045"></a>04045         <span class="keywordflow">return</span> -1;
<a name="l04046"></a>04046     }
<a name="l04047"></a>04047 
<a name="l04048"></a>04048     pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04049"></a>04049 
<a name="l04050"></a>04050     repo-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a> = TRUE;
<a name="l04051"></a>04051 
<a name="l04052"></a>04052     <span class="keywordflow">return</span> 0;
<a name="l04053"></a>04053 }
<a name="l04054"></a>04054 
<a name="l04055"></a>04055 <span class="keyword">static</span> gboolean
<a name="l04056"></a>04056 get_garbage_repo_id (sqlite3_stmt *stmt, <span class="keywordtype">void</span> *vid_list)
<a name="l04057"></a>04057 {
<a name="l04058"></a>04058     GList **ret = vid_list;
<a name="l04059"></a>04059     <span class="keywordtype">char</span> *repo_id;
<a name="l04060"></a>04060 
<a name="l04061"></a>04061     repo_id = g_strdup((<span class="keyword">const</span> <span class="keywordtype">char</span> *)sqlite3_column_text (stmt, 0));
<a name="l04062"></a>04062     *ret = g_list_prepend (*ret, repo_id);
<a name="l04063"></a>04063 
<a name="l04064"></a>04064     <span class="keywordflow">return</span> TRUE;
<a name="l04065"></a>04065 }
<a name="l04066"></a>04066 
<a name="l04067"></a>04067 GList *
<a name="l04068"></a><a class="code" href="daemon_2repo-mgr_8c.html#ae45351706ea0868c8e6c9bad500e1785">04068</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ae45351706ea0868c8e6c9bad500e1785">seaf_repo_manager_list_garbage_repos</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr)
<a name="l04069"></a>04069 {
<a name="l04070"></a>04070     GList *repo_ids = NULL;
<a name="l04071"></a>04071 
<a name="l04072"></a>04072     pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04073"></a>04073 
<a name="l04074"></a>04074     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>,
<a name="l04075"></a>04075                                  <span class="stringliteral">&quot;SELECT repo_id FROM GarbageRepos&quot;</span>,
<a name="l04076"></a>04076                                  get_garbage_repo_id, &amp;repo_ids);
<a name="l04077"></a>04077     pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04078"></a>04078 
<a name="l04079"></a>04079     <span class="keywordflow">return</span> repo_ids;
<a name="l04080"></a>04080 }
<a name="l04081"></a>04081 
<a name="l04082"></a>04082 <span class="keywordtype">void</span>
<a name="l04083"></a><a class="code" href="daemon_2repo-mgr_8c.html#a7d2cf85f06fa2e7d459730f7494c1a65">04083</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a7d2cf85f06fa2e7d459730f7494c1a65">seaf_repo_manager_remove_garbage_repo</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr, <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l04084"></a>04084 {
<a name="l04085"></a>04085     <span class="keywordtype">char</span> sql[256];
<a name="l04086"></a>04086 
<a name="l04087"></a>04087     pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04088"></a>04088 
<a name="l04089"></a>04089     snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM GarbageRepos WHERE repo_id=&#39;%s&#39;&quot;</span>,
<a name="l04090"></a>04090               repo_id);
<a name="l04091"></a>04091     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l04092"></a>04092 
<a name="l04093"></a>04093     pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04094"></a>04094 }
<a name="l04095"></a>04095 
<a name="l04096"></a>04096 <span class="keywordtype">void</span>
<a name="l04097"></a><a class="code" href="daemon_2repo-mgr_8c.html#a008f145440cf3620f7883d1fe109f69c">04097</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a008f145440cf3620f7883d1fe109f69c">seaf_repo_manager_remove_repo_ondisk</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l04098"></a>04098                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l04099"></a>04099                                       gboolean add_deleted_record)
<a name="l04100"></a>04100 {
<a name="l04101"></a>04101     <span class="keywordtype">char</span> sql[256];
<a name="l04102"></a>04102 
<a name="l04103"></a>04103     <span class="comment">/* We don&#39;t need to care about I/O errors here, since we can</span>
<a name="l04104"></a>04104 <span class="comment">     * GC any unreferenced repo data later.</span>
<a name="l04105"></a>04105 <span class="comment">     */</span>
<a name="l04106"></a>04106 
<a name="l04107"></a>04107     <span class="keywordflow">if</span> (add_deleted_record) {
<a name="l04108"></a>04108         snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;REPLACE INTO GarbageRepos VALUES (&#39;%s&#39;)&quot;</span>,
<a name="l04109"></a>04109                   repo_id);
<a name="l04110"></a>04110         <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql) &lt; 0)
<a name="l04111"></a>04111             <span class="keywordflow">goto</span> out;
<a name="l04112"></a>04112     }
<a name="l04113"></a>04113 
<a name="l04114"></a>04114     <span class="comment">/* Once the item in Repo table is deleted, the repo is gone.</span>
<a name="l04115"></a>04115 <span class="comment">     * This is the &quot;commit point&quot;.</span>
<a name="l04116"></a>04116 <span class="comment">     */</span>
<a name="l04117"></a>04117     pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04118"></a>04118 
<a name="l04119"></a>04119     snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM Repo WHERE repo_id = &#39;%s&#39;&quot;</span>, repo_id);
<a name="l04120"></a>04120     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql) &lt; 0)
<a name="l04121"></a>04121         <span class="keywordflow">goto</span> out;
<a name="l04122"></a>04122 
<a name="l04123"></a>04123     snprintf (sql, <span class="keyword">sizeof</span>(sql), 
<a name="l04124"></a>04124               <span class="stringliteral">&quot;DELETE FROM DeletedRepo WHERE repo_id = &#39;%s&#39;&quot;</span>, repo_id);
<a name="l04125"></a>04125     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l04126"></a>04126 
<a name="l04127"></a>04127     pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04128"></a>04128 
<a name="l04129"></a>04129     <span class="comment">/* remove index */</span>
<a name="l04130"></a>04130     <span class="keywordtype">char</span> path[<a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
<a name="l04131"></a>04131     snprintf (path, <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>, repo_id);
<a name="l04132"></a>04132     <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a26f091009701c5a9d1886b9d6ceb9c8e">seaf_util_unlink</a> (path);
<a name="l04133"></a>04133 
<a name="l04134"></a>04134     <span class="comment">/* remove branch */</span>
<a name="l04135"></a>04135     GList *p;
<a name="l04136"></a>04136     GList *branch_list = 
<a name="l04137"></a>04137         <a class="code" href="branch-mgr_8c.html#ad5bd62cbe17cb8fe91bcd993956a1fbf">seaf_branch_manager_get_branch_list</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo_id);
<a name="l04138"></a>04138     <span class="keywordflow">for</span> (p = branch_list; p; p = p-&gt;next) {
<a name="l04139"></a>04139         <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *b = (<a class="code" href="struct__SeafBranch.html">SeafBranch</a> *)p-&gt;data;
<a name="l04140"></a>04140         <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ae586fb5fbd61d6b44be3e47e7b6c86da">seaf_repo_manager_branch_repo_unmap</a> (mgr, b);
<a name="l04141"></a>04141         <a class="code" href="branch-mgr_8c.html#a16b2df7708f3a4c4b96e9135ec7e1a3d">seaf_branch_manager_del_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo_id, b-&gt;<a class="code" href="struct__SeafBranch.html#ae6af0006b9b80ded4f0525a3be06ccda">name</a>);
<a name="l04142"></a>04142     }
<a name="l04143"></a>04143     <a class="code" href="branch-mgr_8c.html#ac6476414064e0ff0c429629aaab0bfc9">seaf_branch_list_free</a> (branch_list);
<a name="l04144"></a>04144 
<a name="l04145"></a>04145     <span class="comment">/* delete repo property firstly */</span>
<a name="l04146"></a>04146     seaf_repo_manager_del_repo_property (mgr, repo_id);
<a name="l04147"></a>04147 
<a name="l04148"></a>04148     pthread_mutex_lock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04149"></a>04149 
<a name="l04150"></a>04150     snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM RepoPasswd WHERE repo_id = &#39;%s&#39;&quot;</span>, 
<a name="l04151"></a>04151               repo_id);
<a name="l04152"></a>04152     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l04153"></a>04153     snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM RepoKeys WHERE repo_id = &#39;%s&#39;&quot;</span>, 
<a name="l04154"></a>04154               repo_id);
<a name="l04155"></a>04155     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l04156"></a>04156 
<a name="l04157"></a>04157     snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM MergeInfo WHERE repo_id = &#39;%s&#39;&quot;</span>, 
<a name="l04158"></a>04158               repo_id);
<a name="l04159"></a>04159     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l04160"></a>04160 
<a name="l04161"></a>04161 <span class="preprocessor">#ifdef WIN32</span>
<a name="l04162"></a>04162 <span class="preprocessor"></span>    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM LockedFiles WHERE repo_id = &#39;%s&#39;&quot;</span>,
<a name="l04163"></a>04163               repo_id);
<a name="l04164"></a>04164     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l04165"></a>04165 <span class="preprocessor">#endif</span>
<a name="l04166"></a>04166 <span class="preprocessor"></span>
<a name="l04167"></a>04167     snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM FolderUserPerms WHERE repo_id = &#39;%s&#39;&quot;</span>, 
<a name="l04168"></a>04168               repo_id);
<a name="l04169"></a>04169     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l04170"></a>04170 
<a name="l04171"></a>04171     snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM FolderGroupPerms WHERE repo_id = &#39;%s&#39;&quot;</span>, 
<a name="l04172"></a>04172               repo_id);
<a name="l04173"></a>04173     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l04174"></a>04174 
<a name="l04175"></a>04175     snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM FolderPermTimestamp WHERE repo_id = &#39;%s&#39;&quot;</span>, 
<a name="l04176"></a>04176               repo_id);
<a name="l04177"></a>04177     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l04178"></a>04178 
<a name="l04179"></a>04179 out:
<a name="l04180"></a>04180     pthread_mutex_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04181"></a>04181 }
<a name="l04182"></a>04182 
<a name="l04183"></a>04183 <span class="keywordtype">int</span>
<a name="l04184"></a><a class="code" href="daemon_2repo-mgr_8c.html#afdce2de6ee36dcf6b6264ac35fb17f7a">04184</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#afdce2de6ee36dcf6b6264ac35fb17f7a">seaf_repo_manager_del_repo</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l04185"></a>04185                             <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l04186"></a>04186 {
<a name="l04187"></a>04187     <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a008f145440cf3620f7883d1fe109f69c">seaf_repo_manager_remove_repo_ondisk</a> (mgr, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l04188"></a>04188                                           (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a> &gt; 0) ? TRUE : FALSE);
<a name="l04189"></a>04189 
<a name="l04190"></a>04190     <span class="keywordflow">if</span> (pthread_rwlock_wrlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>) &lt; 0) {
<a name="l04191"></a>04191         g_warning (<span class="stringliteral">&quot;[repo mgr] failed to lock repo cache.\n&quot;</span>);
<a name="l04192"></a>04192         <span class="keywordflow">return</span> -1;
<a name="l04193"></a>04193     }
<a name="l04194"></a>04194 
<a name="l04195"></a>04195     g_hash_table_remove (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a46e78181430977b311346c02e5738286">repo_hash</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l04196"></a>04196 
<a name="l04197"></a>04197     pthread_rwlock_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);
<a name="l04198"></a>04198 
<a name="l04199"></a>04199     <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ad0a65514ad80789ff244b20c66460b96">seaf_repo_free</a> (repo);
<a name="l04200"></a>04200 
<a name="l04201"></a>04201     <span class="keywordflow">return</span> 0;
<a name="l04202"></a>04202 }
<a name="l04203"></a>04203 
<a name="l04204"></a>04204 <span class="comment">/*</span>
<a name="l04205"></a>04205 <span class="comment">  Return the internal Repo in hashtable. The caller should not free the returned Repo.</span>
<a name="l04206"></a>04206 <span class="comment"> */</span>
<a name="l04207"></a>04207 <a class="code" href="struct__SeafRepo.html">SeafRepo</a>*
<a name="l04208"></a><a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">04208</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <span class="keyword">const</span> gchar *<span class="keywordtype">id</span>)
<a name="l04209"></a>04209 {
<a name="l04210"></a>04210     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *res;
<a name="l04211"></a>04211 
<a name="l04212"></a>04212     <span class="keywordflow">if</span> (pthread_rwlock_rdlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>) &lt; 0) {
<a name="l04213"></a>04213         g_warning (<span class="stringliteral">&quot;[repo mgr] failed to lock repo cache.\n&quot;</span>);
<a name="l04214"></a>04214         <span class="keywordflow">return</span> NULL;
<a name="l04215"></a>04215     }
<a name="l04216"></a>04216 
<a name="l04217"></a>04217     res = g_hash_table_lookup (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a46e78181430977b311346c02e5738286">repo_hash</a>, <span class="keywordtype">id</span>);
<a name="l04218"></a>04218 
<a name="l04219"></a>04219     pthread_rwlock_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);
<a name="l04220"></a>04220 
<a name="l04221"></a>04221     <span class="keywordflow">if</span> (res &amp;&amp; !res-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>)
<a name="l04222"></a>04222         <span class="keywordflow">return</span> res;
<a name="l04223"></a>04223 
<a name="l04224"></a>04224     <span class="keywordflow">return</span> NULL;
<a name="l04225"></a>04225 }
<a name="l04226"></a>04226 
<a name="l04227"></a>04227 gboolean
<a name="l04228"></a><a class="code" href="daemon_2repo-mgr_8c.html#a4b2497e6cdde50c4ce3cb642370e06eb">04228</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a4b2497e6cdde50c4ce3cb642370e06eb">seaf_repo_manager_repo_exists</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <span class="keyword">const</span> gchar *<span class="keywordtype">id</span>)
<a name="l04229"></a>04229 {
<a name="l04230"></a>04230     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *res;
<a name="l04231"></a>04231 
<a name="l04232"></a>04232     <span class="keywordflow">if</span> (pthread_rwlock_rdlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>) &lt; 0) {
<a name="l04233"></a>04233         g_warning (<span class="stringliteral">&quot;[repo mgr] failed to lock repo cache.\n&quot;</span>);
<a name="l04234"></a>04234         <span class="keywordflow">return</span> FALSE;
<a name="l04235"></a>04235     }
<a name="l04236"></a>04236 
<a name="l04237"></a>04237     res = g_hash_table_lookup (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a46e78181430977b311346c02e5738286">repo_hash</a>, <span class="keywordtype">id</span>);
<a name="l04238"></a>04238 
<a name="l04239"></a>04239     pthread_rwlock_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);
<a name="l04240"></a>04240 
<a name="l04241"></a>04241     <span class="keywordflow">if</span> (res &amp;&amp; !res-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>)
<a name="l04242"></a>04242         <span class="keywordflow">return</span> TRUE;
<a name="l04243"></a>04243     
<a name="l04244"></a>04244     <span class="keywordflow">return</span> FALSE;
<a name="l04245"></a>04245 }
<a name="l04246"></a>04246 
<a name="l04247"></a>04247 <span class="keyword">static</span> gboolean
<a name="l04248"></a>04248 get_token (sqlite3_stmt *stmt, <span class="keywordtype">void</span> *data)
<a name="l04249"></a>04249 {
<a name="l04250"></a>04250     <span class="keywordtype">char</span> **token = data;
<a name="l04251"></a>04251 
<a name="l04252"></a>04252     *token = g_strdup((<span class="keywordtype">char</span> *)sqlite3_column_text (stmt, 0));
<a name="l04253"></a>04253     <span class="comment">/* There should be only one result. */</span>
<a name="l04254"></a>04254     <span class="keywordflow">return</span> FALSE;
<a name="l04255"></a>04255 }
<a name="l04256"></a>04256 
<a name="l04257"></a>04257 <span class="keywordtype">char</span> *
<a name="l04258"></a><a class="code" href="daemon_2repo-mgr_8c.html#a45b0ed6bbbdfac4fd104962800f426c3">04258</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a45b0ed6bbbdfac4fd104962800f426c3">seaf_repo_manager_get_repo_lantoken</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l04259"></a>04259                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l04260"></a>04260 {
<a name="l04261"></a>04261     <span class="keywordtype">char</span> sql[256];
<a name="l04262"></a>04262     <span class="keywordtype">char</span> *ret = NULL;
<a name="l04263"></a>04263 
<a name="l04264"></a>04264     pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04265"></a>04265 
<a name="l04266"></a>04266     snprintf (sql, <span class="keyword">sizeof</span>(sql),
<a name="l04267"></a>04267               <span class="stringliteral">&quot;SELECT token FROM RepoLanToken WHERE repo_id=&#39;%s&#39;&quot;</span>,
<a name="l04268"></a>04268               repo_id);
<a name="l04269"></a>04269     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql,
<a name="l04270"></a>04270                                      get_token, &amp;ret) &lt; 0) {
<a name="l04271"></a>04271         g_warning (<span class="stringliteral">&quot;DB error when get token for repo %s.\n&quot;</span>, repo_id);
<a name="l04272"></a>04272         pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04273"></a>04273         <span class="keywordflow">return</span> NULL;
<a name="l04274"></a>04274     }
<a name="l04275"></a>04275 
<a name="l04276"></a>04276     pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04277"></a>04277 
<a name="l04278"></a>04278     <span class="keywordflow">return</span> ret;
<a name="l04279"></a>04279 }
<a name="l04280"></a>04280 
<a name="l04281"></a>04281 <span class="keywordtype">int</span>
<a name="l04282"></a><a class="code" href="daemon_2repo-mgr_8c.html#a93b2f3d8f0964708f8fb0450fded2a42">04282</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a93b2f3d8f0964708f8fb0450fded2a42">seaf_repo_manager_set_repo_lantoken</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l04283"></a>04283                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l04284"></a>04284                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *token)
<a name="l04285"></a>04285 {
<a name="l04286"></a>04286     <span class="keywordtype">char</span> sql[256];
<a name="l04287"></a>04287     sqlite3 *db = manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>;
<a name="l04288"></a>04288 
<a name="l04289"></a>04289     pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04290"></a>04290 
<a name="l04291"></a>04291     snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;REPLACE INTO RepoLanToken VALUES (&#39;%s&#39;, &#39;%s&#39;);&quot;</span>,
<a name="l04292"></a>04292               repo_id, token);
<a name="l04293"></a>04293     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql) &lt; 0) {
<a name="l04294"></a>04294         pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04295"></a>04295         <span class="keywordflow">return</span> -1;
<a name="l04296"></a>04296     }
<a name="l04297"></a>04297 
<a name="l04298"></a>04298     pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04299"></a>04299 
<a name="l04300"></a>04300     <span class="keywordflow">return</span> 0;
<a name="l04301"></a>04301 }
<a name="l04302"></a>04302 
<a name="l04303"></a>04303 <span class="keywordtype">int</span>
<a name="l04304"></a><a class="code" href="daemon_2repo-mgr_8c.html#a297f8a46a2390465725298d9a08c1145">04304</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a297f8a46a2390465725298d9a08c1145">seaf_repo_manager_verify_repo_lantoken</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l04305"></a>04305                                         <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l04306"></a>04306                                         <span class="keyword">const</span> <span class="keywordtype">char</span> *token)
<a name="l04307"></a>04307 {
<a name="l04308"></a>04308     <span class="keywordtype">int</span> ret = 0;
<a name="l04309"></a>04309     <span class="keywordflow">if</span> (!token)
<a name="l04310"></a>04310         <span class="keywordflow">return</span> 0;
<a name="l04311"></a>04311 
<a name="l04312"></a>04312     <span class="keywordtype">char</span> *my_token = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a45b0ed6bbbdfac4fd104962800f426c3">seaf_repo_manager_get_repo_lantoken</a> (manager, repo_id);
<a name="l04313"></a>04313 
<a name="l04314"></a>04314     <span class="keywordflow">if</span> (!my_token) {
<a name="l04315"></a>04315         <span class="keywordflow">if</span> (memcmp (<a class="code" href="daemon_2repo-mgr_8h.html#afa2f07ad83586c04020cc7fa2760ff1a">DEFAULT_REPO_TOKEN</a>, token, strlen(token)) == 0)
<a name="l04316"></a>04316             ret = 1;
<a name="l04317"></a>04317     } <span class="keywordflow">else</span> {
<a name="l04318"></a>04318         <span class="keywordflow">if</span> (memcmp (my_token, token, strlen(token)) == 0)
<a name="l04319"></a>04319             ret = 1;
<a name="l04320"></a>04320         g_free (my_token);
<a name="l04321"></a>04321     }
<a name="l04322"></a>04322 
<a name="l04323"></a>04323     <span class="keywordflow">return</span> ret;
<a name="l04324"></a>04324 }
<a name="l04325"></a>04325 
<a name="l04326"></a>04326 <span class="keywordtype">char</span> *
<a name="l04327"></a><a class="code" href="daemon_2repo-mgr_8c.html#afebb8831a3f9be12c5612c5707118d3b">04327</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#afebb8831a3f9be12c5612c5707118d3b">seaf_repo_manager_generate_tmp_token</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l04328"></a>04328                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l04329"></a>04329                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id)
<a name="l04330"></a>04330 {
<a name="l04331"></a>04331     <span class="keywordtype">char</span> sql[256];
<a name="l04332"></a>04332     sqlite3 *db = manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>;
<a name="l04333"></a>04333 
<a name="l04334"></a>04334     <span class="keywordtype">int</span> now = time(NULL);
<a name="l04335"></a>04335     <span class="keywordtype">char</span> *token = <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#af64020f0be33abde6a2a076ff9808809">gen_uuid</a>();
<a name="l04336"></a>04336     pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04337"></a>04337 
<a name="l04338"></a>04338     snprintf (sql, <span class="keyword">sizeof</span>(sql),
<a name="l04339"></a>04339               <span class="stringliteral">&quot;REPLACE INTO RepoTmpToken VALUES (&#39;%s&#39;, &#39;%s&#39;, &#39;%s&#39;, %d);&quot;</span>,
<a name="l04340"></a>04340               repo_id, peer_id, token, now);
<a name="l04341"></a>04341     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql) &lt; 0) {
<a name="l04342"></a>04342         pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04343"></a>04343         g_free (token);
<a name="l04344"></a>04344         <span class="keywordflow">return</span> NULL;
<a name="l04345"></a>04345     }
<a name="l04346"></a>04346 
<a name="l04347"></a>04347     pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04348"></a>04348     <span class="keywordflow">return</span> token;
<a name="l04349"></a>04349 }
<a name="l04350"></a>04350 
<a name="l04351"></a>04351 <span class="keywordtype">int</span>
<a name="l04352"></a><a class="code" href="daemon_2repo-mgr_8c.html#ae27495cf631eca68cf5e94048b7e66f2">04352</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ae27495cf631eca68cf5e94048b7e66f2">seaf_repo_manager_verify_tmp_token</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l04353"></a>04353                                     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l04354"></a>04354                                     <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id,
<a name="l04355"></a>04355                                     <span class="keyword">const</span> <span class="keywordtype">char</span> *token)
<a name="l04356"></a>04356 {
<a name="l04357"></a>04357     <span class="keywordtype">int</span> ret;
<a name="l04358"></a>04358     <span class="keywordtype">char</span> sql[512];
<a name="l04359"></a>04359     <span class="keywordflow">if</span> (!repo_id || !peer_id || !token)
<a name="l04360"></a>04360         <span class="keywordflow">return</span> 0;
<a name="l04361"></a>04361 
<a name="l04362"></a>04362     pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04363"></a>04363     snprintf (sql, 512, <span class="stringliteral">&quot;SELECT timestamp FROM RepoTmpToken &quot;</span>
<a name="l04364"></a>04364               <span class="stringliteral">&quot;WHERE repo_id=&#39;%s&#39; AND peer_id=&#39;%s&#39; AND token=&#39;%s&#39;&quot;</span>,
<a name="l04365"></a>04365               repo_id, peer_id, token);
<a name="l04366"></a>04366     ret = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#aceca02fb8bd317ba59939bae695d1a48">sqlite_check_for_existence</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l04367"></a>04367     <span class="keywordflow">if</span> (ret) {
<a name="l04368"></a>04368         snprintf (sql, 512, <span class="stringliteral">&quot;DELETE FROM RepoTmpToken WHERE &quot;</span>
<a name="l04369"></a>04369                   <span class="stringliteral">&quot;repo_id=&#39;%s&#39; AND peer_id=&#39;%s&#39;&quot;</span>,
<a name="l04370"></a>04370                   repo_id, peer_id);
<a name="l04371"></a>04371         <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l04372"></a>04372     }
<a name="l04373"></a>04373     pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04374"></a>04374 
<a name="l04375"></a>04375     <span class="keywordflow">return</span> ret;
<a name="l04376"></a>04376 }
<a name="l04377"></a>04377 
<a name="l04378"></a>04378 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l04379"></a>04379 save_branch_repo_map (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch)
<a name="l04380"></a>04380 {
<a name="l04381"></a>04381     <span class="keywordtype">char</span> *sql;
<a name="l04382"></a>04382     sqlite3 *db = manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>;
<a name="l04383"></a>04383 
<a name="l04384"></a>04384     pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04385"></a>04385 
<a name="l04386"></a>04386     sql = sqlite3_mprintf (<span class="stringliteral">&quot;REPLACE INTO RepoBranch VALUES (%Q, %Q)&quot;</span>,
<a name="l04387"></a>04387                            branch-&gt;<a class="code" href="struct__SeafBranch.html#a88717f46308eb12629b99f9ff91740c2">repo_id</a>, branch-&gt;<a class="code" href="struct__SeafBranch.html#ae6af0006b9b80ded4f0525a3be06ccda">name</a>);
<a name="l04388"></a>04388     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04389"></a>04389     sqlite3_free (sql);
<a name="l04390"></a>04390 
<a name="l04391"></a>04391     pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04392"></a>04392 
<a name="l04393"></a>04393     <span class="keywordflow">return</span> 0;
<a name="l04394"></a>04394 }
<a name="l04395"></a>04395 
<a name="l04396"></a>04396 <span class="keywordtype">int</span>
<a name="l04397"></a><a class="code" href="daemon_2repo-mgr_8c.html#ae586fb5fbd61d6b44be3e47e7b6c86da">04397</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ae586fb5fbd61d6b44be3e47e7b6c86da">seaf_repo_manager_branch_repo_unmap</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch)
<a name="l04398"></a>04398 {
<a name="l04399"></a>04399     <span class="keywordtype">char</span> *sql;
<a name="l04400"></a>04400     sqlite3 *db = manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>;
<a name="l04401"></a>04401 
<a name="l04402"></a>04402     pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04403"></a>04403 
<a name="l04404"></a>04404     sql = sqlite3_mprintf (<span class="stringliteral">&quot;DELETE FROM RepoBranch WHERE branch_name = %Q&quot;</span>
<a name="l04405"></a>04405                            <span class="stringliteral">&quot; AND repo_id = %Q&quot;</span>,
<a name="l04406"></a>04406                            branch-&gt;<a class="code" href="struct__SeafBranch.html#ae6af0006b9b80ded4f0525a3be06ccda">name</a>, branch-&gt;<a class="code" href="struct__SeafBranch.html#a88717f46308eb12629b99f9ff91740c2">repo_id</a>);
<a name="l04407"></a>04407     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql) &lt; 0) {
<a name="l04408"></a>04408         g_warning (<span class="stringliteral">&quot;Unmap branch repo failed\n&quot;</span>);
<a name="l04409"></a>04409         pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04410"></a>04410         sqlite3_free (sql);
<a name="l04411"></a>04411         <span class="keywordflow">return</span> -1;
<a name="l04412"></a>04412     }
<a name="l04413"></a>04413 
<a name="l04414"></a>04414     sqlite3_free (sql);
<a name="l04415"></a>04415     pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04416"></a>04416 
<a name="l04417"></a>04417     <span class="keywordflow">return</span> 0;
<a name="l04418"></a>04418 }
<a name="l04419"></a>04419 
<a name="l04420"></a>04420 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l04421"></a>04421 load_repo_commit (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l04422"></a>04422                   <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo,
<a name="l04423"></a>04423                   <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch)
<a name="l04424"></a>04424 {
<a name="l04425"></a>04425     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit;
<a name="l04426"></a>04426 
<a name="l04427"></a>04427     commit = <a class="code" href="commit-mgr_8c.html#af797c5d03d9c32cd3a4c5ebcf376a855">seaf_commit_manager_get_commit_compatible</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l04428"></a>04428                                                         repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l04429"></a>04429                                                         branch-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l04430"></a>04430     <span class="keywordflow">if</span> (!commit) {
<a name="l04431"></a>04431         g_warning (<span class="stringliteral">&quot;Commit %s is missing\n&quot;</span>, branch-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l04432"></a>04432         repo-&gt;<a class="code" href="struct__SeafRepo.html#a30acbbe15ec4e36a8b3bb31581c333e5">is_corrupted</a> = TRUE;
<a name="l04433"></a>04433         <span class="keywordflow">return</span>;
<a name="l04434"></a>04434     }
<a name="l04435"></a>04435 
<a name="l04436"></a>04436     set_head_common (repo, branch);
<a name="l04437"></a>04437     <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a9c8ead9892374c87ece888d76e810197">seaf_repo_from_commit</a> (repo, commit);
<a name="l04438"></a>04438 
<a name="l04439"></a>04439     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
<a name="l04440"></a>04440 }
<a name="l04441"></a>04441 
<a name="l04442"></a>04442 <span class="keyword">static</span> gboolean
<a name="l04443"></a>04443 load_keys_cb (sqlite3_stmt *stmt, <span class="keywordtype">void</span> *vrepo)
<a name="l04444"></a>04444 {
<a name="l04445"></a>04445     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = vrepo;
<a name="l04446"></a>04446     <span class="keyword">const</span> <span class="keywordtype">char</span> *key, *iv;
<a name="l04447"></a>04447 
<a name="l04448"></a>04448     key = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)sqlite3_column_text(stmt, 0);
<a name="l04449"></a>04449     iv = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)sqlite3_column_text(stmt, 1);
<a name="l04450"></a>04450 
<a name="l04451"></a>04451     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> == 1) {
<a name="l04452"></a>04452         <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a130e83c1ad29d78ef1a5b6baef1754d5">hex_to_rawdata</a> (key, repo-&gt;<a class="code" href="struct__SeafRepo.html#ad951f63e287f0ea14c863937afea6779">enc_key</a>, 16);
<a name="l04453"></a>04453         <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a130e83c1ad29d78ef1a5b6baef1754d5">hex_to_rawdata</a> (iv, repo-&gt;<a class="code" href="struct__SeafRepo.html#a7ad105e1fab206035f1c585c25e0dc94">enc_iv</a>, 16);
<a name="l04454"></a>04454     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> == 2) {
<a name="l04455"></a>04455         <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a130e83c1ad29d78ef1a5b6baef1754d5">hex_to_rawdata</a> (key, repo-&gt;<a class="code" href="struct__SeafRepo.html#ad951f63e287f0ea14c863937afea6779">enc_key</a>, 32);
<a name="l04456"></a>04456         <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a130e83c1ad29d78ef1a5b6baef1754d5">hex_to_rawdata</a> (iv, repo-&gt;<a class="code" href="struct__SeafRepo.html#a7ad105e1fab206035f1c585c25e0dc94">enc_iv</a>, 16);
<a name="l04457"></a>04457     }
<a name="l04458"></a>04458 
<a name="l04459"></a>04459     <span class="keywordflow">return</span> FALSE;
<a name="l04460"></a>04460 }
<a name="l04461"></a>04461 
<a name="l04462"></a>04462 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l04463"></a>04463 load_repo_passwd (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l04464"></a>04464 {
<a name="l04465"></a>04465     sqlite3 *db = manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>;
<a name="l04466"></a>04466     <span class="keywordtype">char</span> sql[256];
<a name="l04467"></a>04467     <span class="keywordtype">int</span> n;
<a name="l04468"></a>04468 
<a name="l04469"></a>04469     pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04470"></a>04470 
<a name="l04471"></a>04471     snprintf (sql, <span class="keyword">sizeof</span>(sql), 
<a name="l04472"></a>04472               <span class="stringliteral">&quot;SELECT key, iv FROM RepoKeys WHERE repo_id=&#39;%s&#39;&quot;</span>,
<a name="l04473"></a>04473               repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l04474"></a>04474     n = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (db, sql, load_keys_cb, repo);
<a name="l04475"></a>04475     <span class="keywordflow">if</span> (n &lt; 0)
<a name="l04476"></a>04476         <span class="keywordflow">return</span> -1;
<a name="l04477"></a>04477 
<a name="l04478"></a>04478     pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04479"></a>04479 
<a name="l04480"></a>04480     <span class="keywordflow">return</span> 0;
<a name="l04481"></a>04481     
<a name="l04482"></a>04482 }
<a name="l04483"></a>04483 
<a name="l04484"></a>04484 <span class="keyword">static</span> gboolean
<a name="l04485"></a>04485 load_property_cb (sqlite3_stmt *stmt, <span class="keywordtype">void</span> *pvalue)
<a name="l04486"></a>04486 {
<a name="l04487"></a>04487     <span class="keywordtype">char</span> **value = pvalue;
<a name="l04488"></a>04488 
<a name="l04489"></a>04489     <span class="keywordtype">char</span> *v = (<span class="keywordtype">char</span> *) sqlite3_column_text (stmt, 0);
<a name="l04490"></a>04490     *value = g_strdup (v);
<a name="l04491"></a>04491 
<a name="l04492"></a>04492     <span class="comment">/* Only one result. */</span>
<a name="l04493"></a>04493     <span class="keywordflow">return</span> FALSE;
<a name="l04494"></a>04494 }
<a name="l04495"></a>04495 
<a name="l04496"></a>04496 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l04497"></a>04497 load_repo_property (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l04498"></a>04498                     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l04499"></a>04499                     <span class="keyword">const</span> <span class="keywordtype">char</span> *key)
<a name="l04500"></a>04500 {
<a name="l04501"></a>04501     sqlite3 *db = manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>;
<a name="l04502"></a>04502     <span class="keywordtype">char</span> sql[256];
<a name="l04503"></a>04503     <span class="keywordtype">char</span> *value = NULL;
<a name="l04504"></a>04504 
<a name="l04505"></a>04505     pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04506"></a>04506 
<a name="l04507"></a>04507     snprintf(sql, 256, <span class="stringliteral">&quot;SELECT value FROM RepoProperty WHERE &quot;</span>
<a name="l04508"></a>04508              <span class="stringliteral">&quot;repo_id=&#39;%s&#39; and key=&#39;%s&#39;&quot;</span>, repo_id, key);
<a name="l04509"></a>04509     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (db, sql, load_property_cb, &amp;value) &lt; 0) {
<a name="l04510"></a>04510         g_warning (<span class="stringliteral">&quot;Error read property %s for repo %s.\n&quot;</span>, key, repo_id);
<a name="l04511"></a>04511         pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04512"></a>04512         <span class="keywordflow">return</span> NULL;
<a name="l04513"></a>04513     }
<a name="l04514"></a>04514 
<a name="l04515"></a>04515     pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04516"></a>04516 
<a name="l04517"></a>04517     <span class="keywordflow">return</span> value;
<a name="l04518"></a>04518 }
<a name="l04519"></a>04519 
<a name="l04520"></a>04520 <span class="keyword">static</span> gboolean
<a name="l04521"></a>04521 load_branch_cb (sqlite3_stmt *stmt, <span class="keywordtype">void</span> *vrepo)
<a name="l04522"></a>04522 {
<a name="l04523"></a>04523     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = vrepo;
<a name="l04524"></a>04524     <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager = repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>;
<a name="l04525"></a>04525 
<a name="l04526"></a>04526     <span class="keywordtype">char</span> *branch_name = (<span class="keywordtype">char</span> *) sqlite3_column_text (stmt, 0);
<a name="l04527"></a>04527     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch =
<a name="l04528"></a>04528         <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>,
<a name="l04529"></a>04529                                         repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, branch_name);
<a name="l04530"></a>04530     <span class="keywordflow">if</span> (branch == NULL) {
<a name="l04531"></a>04531         g_warning (<span class="stringliteral">&quot;Broken branch name for repo %s\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>); 
<a name="l04532"></a>04532         repo-&gt;<a class="code" href="struct__SeafRepo.html#a30acbbe15ec4e36a8b3bb31581c333e5">is_corrupted</a> = TRUE;
<a name="l04533"></a>04533         <span class="keywordflow">return</span> FALSE;
<a name="l04534"></a>04534     }
<a name="l04535"></a>04535     load_repo_commit (manager, repo, branch);
<a name="l04536"></a>04536     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l04537"></a>04537 
<a name="l04538"></a>04538     <span class="comment">/* Only one result. */</span>
<a name="l04539"></a>04539     <span class="keywordflow">return</span> FALSE;
<a name="l04540"></a>04540 }
<a name="l04541"></a>04541 
<a name="l04542"></a>04542 <span class="keyword">static</span> <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *
<a name="l04543"></a>04543 load_repo (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l04544"></a>04544 {
<a name="l04545"></a>04545     <span class="keywordtype">char</span> sql[256];
<a name="l04546"></a>04546 
<a name="l04547"></a>04547     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a63ab9fe4694e3d967376c911cbe2c655">seaf_repo_new</a>(repo_id, NULL, NULL);
<a name="l04548"></a>04548     <span class="keywordflow">if</span> (!repo) {
<a name="l04549"></a>04549         g_warning (<span class="stringliteral">&quot;[repo mgr] failed to alloc repo.\n&quot;</span>);
<a name="l04550"></a>04550         <span class="keywordflow">return</span> NULL;
<a name="l04551"></a>04551     }
<a name="l04552"></a>04552 
<a name="l04553"></a>04553     repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a> = manager;
<a name="l04554"></a>04554 
<a name="l04555"></a>04555     snprintf(sql, 256, <span class="stringliteral">&quot;SELECT branch_name FROM RepoBranch WHERE repo_id=&#39;%s&#39;&quot;</span>,
<a name="l04556"></a>04556              repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l04557"></a>04557     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql, 
<a name="l04558"></a>04558                                      load_branch_cb, repo) &lt; 0) {
<a name="l04559"></a>04559         g_warning (<span class="stringliteral">&quot;Error read branch for repo %s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l04560"></a>04560         <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ad0a65514ad80789ff244b20c66460b96">seaf_repo_free</a> (repo);
<a name="l04561"></a>04561         <span class="keywordflow">return</span> NULL;
<a name="l04562"></a>04562     }
<a name="l04563"></a>04563 
<a name="l04564"></a>04564     <span class="comment">/* If repo head is set but failed to load branch or commit. */</span>
<a name="l04565"></a>04565     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a30acbbe15ec4e36a8b3bb31581c333e5">is_corrupted</a>) {
<a name="l04566"></a>04566         <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ad0a65514ad80789ff244b20c66460b96">seaf_repo_free</a> (repo);
<a name="l04567"></a>04567         <span class="comment">/* remove_repo_ondisk (manager, repo_id); */</span>
<a name="l04568"></a>04568         <span class="keywordflow">return</span> NULL;
<a name="l04569"></a>04569     }
<a name="l04570"></a>04570 
<a name="l04571"></a>04571     <span class="comment">/* Repo head may be not set if it&#39;s just cloned but not checked out yet. */</span>
<a name="l04572"></a>04572     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a> == NULL) {
<a name="l04573"></a>04573         <span class="comment">/* the repo do not have a head branch, try to load &#39;master&#39; branch */</span>
<a name="l04574"></a>04574         <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch =
<a name="l04575"></a>04575             <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>,
<a name="l04576"></a>04576                                             repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="stringliteral">&quot;master&quot;</span>);
<a name="l04577"></a>04577         <span class="keywordflow">if</span> (branch != NULL) {
<a name="l04578"></a>04578              <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit;
<a name="l04579"></a>04579 
<a name="l04580"></a>04580              commit =
<a name="l04581"></a>04581                  <a class="code" href="commit-mgr_8c.html#af797c5d03d9c32cd3a4c5ebcf376a855">seaf_commit_manager_get_commit_compatible</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l04582"></a>04582                                                             repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l04583"></a>04583                                                             branch-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l04584"></a>04584              <span class="keywordflow">if</span> (commit) {
<a name="l04585"></a>04585                  <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a9c8ead9892374c87ece888d76e810197">seaf_repo_from_commit</a> (repo, commit);
<a name="l04586"></a>04586                  <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
<a name="l04587"></a>04587              } <span class="keywordflow">else</span> {
<a name="l04588"></a>04588                  g_warning (<span class="stringliteral">&quot;[repo-mgr] Can not find commit %s\n&quot;</span>,
<a name="l04589"></a>04589                             branch-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l04590"></a>04590                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a30acbbe15ec4e36a8b3bb31581c333e5">is_corrupted</a> = TRUE;
<a name="l04591"></a>04591              }
<a name="l04592"></a>04592 
<a name="l04593"></a>04593              <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l04594"></a>04594         } <span class="keywordflow">else</span> {
<a name="l04595"></a>04595             g_warning (<span class="stringliteral">&quot;[repo-mgr] Failed to get branch master&quot;</span>);
<a name="l04596"></a>04596             repo-&gt;<a class="code" href="struct__SeafRepo.html#a30acbbe15ec4e36a8b3bb31581c333e5">is_corrupted</a> = TRUE;
<a name="l04597"></a>04597         }
<a name="l04598"></a>04598     }
<a name="l04599"></a>04599 
<a name="l04600"></a>04600     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a30acbbe15ec4e36a8b3bb31581c333e5">is_corrupted</a>) {
<a name="l04601"></a>04601         <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ad0a65514ad80789ff244b20c66460b96">seaf_repo_free</a> (repo);
<a name="l04602"></a>04602         <span class="comment">/* remove_repo_ondisk (manager, repo_id); */</span>
<a name="l04603"></a>04603         <span class="keywordflow">return</span> NULL;
<a name="l04604"></a>04604     }
<a name="l04605"></a>04605 
<a name="l04606"></a>04606     load_repo_passwd (manager, repo);
<a name="l04607"></a>04607 
<a name="l04608"></a>04608     <span class="keywordtype">char</span> *value;
<a name="l04609"></a>04609 
<a name="l04610"></a>04610     value = load_repo_property (manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a2d6340e4ada61e93d58c0411fa6fcfe5">REPO_AUTO_SYNC</a>);
<a name="l04611"></a>04611     <span class="keywordflow">if</span> (g_strcmp0(value, <span class="stringliteral">&quot;false&quot;</span>) == 0) {
<a name="l04612"></a>04612         repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a> = 0;
<a name="l04613"></a>04613     }
<a name="l04614"></a>04614     g_free (value);
<a name="l04615"></a>04615 
<a name="l04616"></a>04616     repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a> = load_repo_property (manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="stringliteral">&quot;worktree&quot;</span>);
<a name="l04617"></a>04617     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>)
<a name="l04618"></a>04618         repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a> = FALSE;
<a name="l04619"></a>04619 
<a name="l04620"></a>04620     repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a> = load_repo_property (manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a88e179c17ec642b434e82bb40403a6ba">REPO_RELAY_ID</a>);
<a name="l04621"></a>04621     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a> &amp;&amp; strlen(repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>) != 40) {
<a name="l04622"></a>04622         g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>);
<a name="l04623"></a>04623         repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a> = NULL;
<a name="l04624"></a>04624     }
<a name="l04625"></a>04625 
<a name="l04626"></a>04626     value = load_repo_property (manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a4dc57106ac24f4cf008c10b85ae1e384">REPO_NET_BROWSABLE</a>);
<a name="l04627"></a>04627     <span class="keywordflow">if</span> (g_strcmp0(value, <span class="stringliteral">&quot;true&quot;</span>) == 0) {
<a name="l04628"></a>04628         repo-&gt;<a class="code" href="struct__SeafRepo.html#a575e562d38b7fc0adc79a6b24ea00ac1">net_browsable</a> = 1;
<a name="l04629"></a>04629     }
<a name="l04630"></a>04630     g_free (value);
<a name="l04631"></a>04631 
<a name="l04632"></a>04632     repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a> = load_repo_property (manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a710e166548b51934b6a3d916eb86442e">REPO_PROP_EMAIL</a>);
<a name="l04633"></a>04633     repo-&gt;<a class="code" href="struct__SeafRepo.html#a0ce3b61cb31e78ffea429615379b3eb4">token</a> = load_repo_property (manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a1d2a9886ff3a1d69407ba0b287cbeac4">REPO_PROP_TOKEN</a>);
<a name="l04634"></a>04634 
<a name="l04635"></a>04635     <span class="comment">/* May be NULL if this property is not set in db. */</span>
<a name="l04636"></a>04636     repo-&gt;<a class="code" href="struct__SeafRepo.html#a1a7beee19acb913be2c23ac0e71ea733">server_url</a> = load_repo_property (manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a55797c21d6209596736b5a81a8411ff9">REPO_PROP_SERVER_URL</a>);
<a name="l04637"></a>04637 
<a name="l04638"></a>04638     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a> != NULL &amp;&amp; <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ad1200d69d8e6219885da4e85af15dca2">seaf_repo_check_worktree</a> (repo) &lt; 0) {
<a name="l04639"></a>04639         <span class="keywordflow">if</span> (<a class="code" href="seafile-config_8c.html#adfb95469d4c47a60ad25400c3e2a9f96">seafile_session_config_get_allow_invalid_worktree</a>(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>)) {
<a name="l04640"></a>04640             seaf_warning (<span class="stringliteral">&quot;Worktree for repo \&quot;%s\&quot; is invalid, but still keep it.\n&quot;</span>,
<a name="l04641"></a>04641                           repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>);
<a name="l04642"></a>04642             repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a> = TRUE;
<a name="l04643"></a>04643         } <span class="keywordflow">else</span> {
<a name="l04644"></a>04644             seaf_message (<span class="stringliteral">&quot;Worktree for repo \&quot;%s\&quot; is invalid, delete it.\n&quot;</span>,
<a name="l04645"></a>04645                           repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>);
<a name="l04646"></a>04646             <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#afdce2de6ee36dcf6b6264ac35fb17f7a">seaf_repo_manager_del_repo</a> (manager, repo);
<a name="l04647"></a>04647             <span class="keywordflow">return</span> NULL;
<a name="l04648"></a>04648         }
<a name="l04649"></a>04649     }
<a name="l04650"></a>04650 
<a name="l04651"></a>04651     <span class="comment">/* load readonly property */</span>
<a name="l04652"></a>04652     value = load_repo_property (manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a152076b2a531e04976bdc390e8d43b92">REPO_PROP_IS_READONLY</a>);
<a name="l04653"></a>04653     <span class="keywordflow">if</span> (g_strcmp0(value, <span class="stringliteral">&quot;true&quot;</span>) == 0)
<a name="l04654"></a>04654         repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a> = TRUE;
<a name="l04655"></a>04655     <span class="keywordflow">else</span>
<a name="l04656"></a>04656         repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a> = FALSE;
<a name="l04657"></a>04657 
<a name="l04658"></a>04658     g_hash_table_insert (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a46e78181430977b311346c02e5738286">repo_hash</a>, g_strdup(repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>), repo);
<a name="l04659"></a>04659 
<a name="l04660"></a>04660     <span class="keywordflow">return</span> repo;
<a name="l04661"></a>04661 }
<a name="l04662"></a>04662 
<a name="l04663"></a>04663 <span class="keyword">static</span> sqlite3*
<a name="l04664"></a>04664 open_db (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <span class="keyword">const</span> <span class="keywordtype">char</span> *seaf_dir)
<a name="l04665"></a>04665 {
<a name="l04666"></a>04666     sqlite3 *db;
<a name="l04667"></a>04667     <span class="keywordtype">char</span> *db_path;
<a name="l04668"></a>04668 
<a name="l04669"></a>04669     db_path = g_build_filename (seaf_dir, <span class="stringliteral">&quot;repo.db&quot;</span>, NULL);
<a name="l04670"></a>04670     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#af6e9a0e79db923d4a7df37bc5588400a">sqlite_open_db</a> (db_path, &amp;db) &lt; 0)
<a name="l04671"></a>04671         <span class="keywordflow">return</span> NULL;
<a name="l04672"></a>04672     g_free (db_path);
<a name="l04673"></a>04673     manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a> = db;
<a name="l04674"></a>04674 
<a name="l04675"></a>04675     <span class="keywordtype">char</span> *sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS Repo (repo_id TEXT PRIMARY KEY);&quot;</span>;
<a name="l04676"></a>04676     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04677"></a>04677 
<a name="l04678"></a>04678     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS DeletedRepo (repo_id TEXT PRIMARY KEY);&quot;</span>;
<a name="l04679"></a>04679     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04680"></a>04680 
<a name="l04681"></a>04681     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoBranch (&quot;</span>
<a name="l04682"></a>04682         <span class="stringliteral">&quot;repo_id TEXT PRIMARY KEY, branch_name TEXT);&quot;</span>;
<a name="l04683"></a>04683     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04684"></a>04684 
<a name="l04685"></a>04685     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoLanToken (&quot;</span>
<a name="l04686"></a>04686         <span class="stringliteral">&quot;repo_id TEXT PRIMARY KEY, token TEXT);&quot;</span>;
<a name="l04687"></a>04687     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04688"></a>04688 
<a name="l04689"></a>04689     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoTmpToken (&quot;</span>
<a name="l04690"></a>04690         <span class="stringliteral">&quot;repo_id TEXT, peer_id TEXT, token TEXT, timestamp INTEGER, &quot;</span>
<a name="l04691"></a>04691         <span class="stringliteral">&quot;PRIMARY KEY (repo_id, peer_id));&quot;</span>;
<a name="l04692"></a>04692     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04693"></a>04693 
<a name="l04694"></a>04694     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoPasswd &quot;</span>
<a name="l04695"></a>04695         <span class="stringliteral">&quot;(repo_id TEXT PRIMARY KEY, passwd TEXT NOT NULL);&quot;</span>;
<a name="l04696"></a>04696     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04697"></a>04697 
<a name="l04698"></a>04698     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoKeys &quot;</span>
<a name="l04699"></a>04699         <span class="stringliteral">&quot;(repo_id TEXT PRIMARY KEY, key TEXT NOT NULL, iv TEXT NOT NULL);&quot;</span>;
<a name="l04700"></a>04700     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04701"></a>04701     
<a name="l04702"></a>04702     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoProperty (&quot;</span>
<a name="l04703"></a>04703         <span class="stringliteral">&quot;repo_id TEXT, key TEXT, value TEXT);&quot;</span>;
<a name="l04704"></a>04704     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04705"></a>04705 
<a name="l04706"></a>04706     sql = <span class="stringliteral">&quot;CREATE INDEX IF NOT EXISTS RepoIndex ON RepoProperty (repo_id);&quot;</span>;
<a name="l04707"></a>04707     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04708"></a>04708 
<a name="l04709"></a>04709     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS MergeInfo (&quot;</span>
<a name="l04710"></a>04710         <span class="stringliteral">&quot;repo_id TEXT PRIMARY KEY, in_merge INTEGER, branch TEXT);&quot;</span>;
<a name="l04711"></a>04711     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04712"></a>04712 
<a name="l04713"></a>04713     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS CommonAncestor (&quot;</span>
<a name="l04714"></a>04714         <span class="stringliteral">&quot;repo_id TEXT PRIMARY KEY, ca_id TEXT, head_id TEXT);&quot;</span>;
<a name="l04715"></a>04715     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04716"></a>04716 
<a name="l04717"></a>04717     <span class="comment">/* Version 1 repos will be added to this table after deletion.</span>
<a name="l04718"></a>04718 <span class="comment">     * GC will scan this table and remove the objects and blocks for the repos.</span>
<a name="l04719"></a>04719 <span class="comment">     */</span>
<a name="l04720"></a>04720     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS GarbageRepos (repo_id TEXT PRIMARY KEY);&quot;</span>;
<a name="l04721"></a>04721     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04722"></a>04722 
<a name="l04723"></a>04723 <span class="preprocessor">#ifdef WIN32</span>
<a name="l04724"></a>04724 <span class="preprocessor"></span>    sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS LockedFiles (repo_id TEXT, path TEXT, &quot;</span>
<a name="l04725"></a>04725         <span class="stringliteral">&quot;operation TEXT, old_mtime INTEGER, file_id TEXT, new_path TEXT, &quot;</span>
<a name="l04726"></a>04726         <span class="stringliteral">&quot;PRIMARY KEY (repo_id, path));&quot;</span>;
<a name="l04727"></a>04727     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04728"></a>04728 <span class="preprocessor">#endif</span>
<a name="l04729"></a>04729 <span class="preprocessor"></span>
<a name="l04730"></a>04730     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS FolderUserPerms (&quot;</span>
<a name="l04731"></a>04731         <span class="stringliteral">&quot;repo_id TEXT, path TEXT, permission TEXT);&quot;</span>;
<a name="l04732"></a>04732     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04733"></a>04733 
<a name="l04734"></a>04734     sql = <span class="stringliteral">&quot;CREATE INDEX IF NOT EXISTS folder_user_perms_repo_id_idx &quot;</span>
<a name="l04735"></a>04735         <span class="stringliteral">&quot;ON FolderUserPerms (repo_id);&quot;</span>;
<a name="l04736"></a>04736     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04737"></a>04737 
<a name="l04738"></a>04738     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS FolderGroupPerms (&quot;</span>
<a name="l04739"></a>04739         <span class="stringliteral">&quot;repo_id TEXT, path TEXT, permission TEXT);&quot;</span>;
<a name="l04740"></a>04740     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04741"></a>04741 
<a name="l04742"></a>04742     sql = <span class="stringliteral">&quot;CREATE INDEX IF NOT EXISTS folder_group_perms_repo_id_idx &quot;</span>
<a name="l04743"></a>04743         <span class="stringliteral">&quot;ON FolderGroupPerms (repo_id);&quot;</span>;
<a name="l04744"></a>04744     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04745"></a>04745 
<a name="l04746"></a>04746     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS FolderPermTimestamp (&quot;</span>
<a name="l04747"></a>04747         <span class="stringliteral">&quot;repo_id TEXT, timestamp INTEGER, PRIMARY KEY (repo_id));&quot;</span>;
<a name="l04748"></a>04748     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04749"></a>04749 
<a name="l04750"></a>04750     <span class="keywordflow">return</span> db;
<a name="l04751"></a>04751 }
<a name="l04752"></a>04752 
<a name="l04753"></a>04753 <span class="keyword">static</span> gboolean
<a name="l04754"></a>04754 load_repo_cb (sqlite3_stmt *stmt, <span class="keywordtype">void</span> *vmanager)
<a name="l04755"></a>04755 {
<a name="l04756"></a>04756     <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager = vmanager;
<a name="l04757"></a>04757     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id;
<a name="l04758"></a>04758 
<a name="l04759"></a>04759     repo_id = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) sqlite3_column_text (stmt, 0);
<a name="l04760"></a>04760 
<a name="l04761"></a>04761     load_repo (manager, repo_id);
<a name="l04762"></a>04762 
<a name="l04763"></a>04763     <span class="keywordflow">return</span> TRUE;
<a name="l04764"></a>04764 }
<a name="l04765"></a>04765 
<a name="l04766"></a>04766 <span class="keyword">static</span> gboolean
<a name="l04767"></a>04767 remove_deleted_repo (sqlite3_stmt *stmt, <span class="keywordtype">void</span> *vmanager)
<a name="l04768"></a>04768 {
<a name="l04769"></a>04769     <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager = vmanager;
<a name="l04770"></a>04770     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id;
<a name="l04771"></a>04771 
<a name="l04772"></a>04772     repo_id = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) sqlite3_column_text (stmt, 0);
<a name="l04773"></a>04773 
<a name="l04774"></a>04774     <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a008f145440cf3620f7883d1fe109f69c">seaf_repo_manager_remove_repo_ondisk</a> (manager, repo_id, TRUE);
<a name="l04775"></a>04775 
<a name="l04776"></a>04776     <span class="keywordflow">return</span> TRUE;
<a name="l04777"></a>04777 }
<a name="l04778"></a>04778 
<a name="l04779"></a>04779 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l04780"></a>04780 load_repos (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <span class="keyword">const</span> <span class="keywordtype">char</span> *seaf_dir)
<a name="l04781"></a>04781 {
<a name="l04782"></a>04782     sqlite3 *db = open_db(manager, seaf_dir);
<a name="l04783"></a>04783     <span class="keywordflow">if</span> (!db) <span class="keywordflow">return</span>;
<a name="l04784"></a>04784 
<a name="l04785"></a>04785     <span class="keywordtype">char</span> *sql;
<a name="l04786"></a>04786 
<a name="l04787"></a>04787     sql = <span class="stringliteral">&quot;SELECT repo_id FROM DeletedRepo&quot;</span>;
<a name="l04788"></a>04788     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (db, sql, remove_deleted_repo, manager) &lt; 0) {
<a name="l04789"></a>04789         g_warning (<span class="stringliteral">&quot;Error removing deleted repos.\n&quot;</span>);
<a name="l04790"></a>04790         <span class="keywordflow">return</span>;
<a name="l04791"></a>04791     }
<a name="l04792"></a>04792 
<a name="l04793"></a>04793     sql = <span class="stringliteral">&quot;SELECT repo_id FROM Repo;&quot;</span>;
<a name="l04794"></a>04794     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (db, sql, load_repo_cb, manager) &lt; 0) {
<a name="l04795"></a>04795         g_warning (<span class="stringliteral">&quot;Error read repo db.\n&quot;</span>);
<a name="l04796"></a>04796         <span class="keywordflow">return</span>;
<a name="l04797"></a>04797     }
<a name="l04798"></a>04798 }
<a name="l04799"></a>04799 
<a name="l04800"></a>04800 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l04801"></a>04801 save_repo_property (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l04802"></a>04802                     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l04803"></a>04803                     <span class="keyword">const</span> <span class="keywordtype">char</span> *key, <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
<a name="l04804"></a>04804 {
<a name="l04805"></a>04805     <span class="keywordtype">char</span> *sql;
<a name="l04806"></a>04806     sqlite3 *db = manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>;
<a name="l04807"></a>04807 
<a name="l04808"></a>04808     pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04809"></a>04809 
<a name="l04810"></a>04810     sql = sqlite3_mprintf (<span class="stringliteral">&quot;SELECT repo_id FROM RepoProperty WHERE repo_id=%Q AND key=%Q&quot;</span>,
<a name="l04811"></a>04811                            repo_id, key);
<a name="l04812"></a>04812     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#aceca02fb8bd317ba59939bae695d1a48">sqlite_check_for_existence</a>(db, sql)) {
<a name="l04813"></a>04813         sqlite3_free (sql);
<a name="l04814"></a>04814         sql = sqlite3_mprintf (<span class="stringliteral">&quot;UPDATE RepoProperty SET value=%Q&quot;</span>
<a name="l04815"></a>04815                                <span class="stringliteral">&quot;WHERE repo_id=%Q and key=%Q&quot;</span>,
<a name="l04816"></a>04816                                value, repo_id, key);
<a name="l04817"></a>04817         <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04818"></a>04818         sqlite3_free (sql);
<a name="l04819"></a>04819     } <span class="keywordflow">else</span> {
<a name="l04820"></a>04820         sqlite3_free (sql);
<a name="l04821"></a>04821         sql = sqlite3_mprintf (<span class="stringliteral">&quot;INSERT INTO RepoProperty VALUES (%Q, %Q, %Q)&quot;</span>,
<a name="l04822"></a>04822                                repo_id, key, value);
<a name="l04823"></a>04823         <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04824"></a>04824         sqlite3_free (sql);
<a name="l04825"></a>04825     }
<a name="l04826"></a>04826 
<a name="l04827"></a>04827     pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04828"></a>04828 }
<a name="l04829"></a>04829 
<a name="l04830"></a>04830 <span class="keyword">inline</span> <span class="keyword">static</span> gboolean is_peer_relay (<span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id)
<a name="l04831"></a>04831 {
<a name="l04832"></a>04832     <a class="code" href="struct__CcnetPeer.html">CcnetPeer</a> *peer = <a class="code" href="ccnet_8h.html#a136915227534e9204ffca3d7dc4d331e">ccnet_get_peer</a>(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#add541d96cca483ad72ff56ad061d1d32">ccnetrpc_client</a>, peer_id);
<a name="l04833"></a>04833 
<a name="l04834"></a>04834     <span class="keywordflow">if</span> (!peer)
<a name="l04835"></a>04835         <span class="keywordflow">return</span> FALSE;
<a name="l04836"></a>04836 
<a name="l04837"></a>04837     gboolean is_relay = <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#a38f449c218477960cf9dc2136453db10">string_list_is_exists</a>(peer-&gt;<a class="code" href="struct__CcnetPeer.html#ada3797a08ba0f1cc321661a288f2c8df">role_list</a>, <span class="stringliteral">&quot;MyRelay&quot;</span>);
<a name="l04838"></a>04838     g_object_unref (peer);
<a name="l04839"></a>04839     <span class="keywordflow">return</span> is_relay;
<a name="l04840"></a>04840 }
<a name="l04841"></a>04841 
<a name="l04842"></a>04842 <span class="keywordtype">int</span>
<a name="l04843"></a><a class="code" href="daemon_2repo-mgr_8c.html#ad2263393047e4ea1f5226842b11e7b05">04843</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ad2263393047e4ea1f5226842b11e7b05">seaf_repo_manager_set_repo_relay_id</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l04844"></a>04844                                      <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo,
<a name="l04845"></a>04845                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *relay_id)
<a name="l04846"></a>04846 {
<a name="l04847"></a>04847     <span class="keywordflow">if</span> (relay_id &amp;&amp; strlen(relay_id) != 40)
<a name="l04848"></a>04848         <span class="keywordflow">return</span> -1;
<a name="l04849"></a>04849 
<a name="l04850"></a>04850     save_repo_property (mgr, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a88e179c17ec642b434e82bb40403a6ba">REPO_RELAY_ID</a>, relay_id);
<a name="l04851"></a>04851 
<a name="l04852"></a>04852     g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>);
<a name="l04853"></a>04853 
<a name="l04854"></a>04854     <span class="keywordflow">if</span> (relay_id)
<a name="l04855"></a>04855         repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a> = g_strdup (relay_id);
<a name="l04856"></a>04856     <span class="keywordflow">else</span>
<a name="l04857"></a>04857         repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a> = NULL;        
<a name="l04858"></a>04858     <span class="keywordflow">return</span> 0;
<a name="l04859"></a>04859 }
<a name="l04860"></a>04860 
<a name="l04861"></a>04861 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l04862"></a>04862 canonical_server_url (<span class="keyword">const</span> <span class="keywordtype">char</span> *url_in)
<a name="l04863"></a>04863 {
<a name="l04864"></a>04864     <span class="keywordtype">char</span> *url = g_strdup(url_in);
<a name="l04865"></a>04865     <span class="keywordtype">int</span> len = strlen(url);
<a name="l04866"></a>04866 
<a name="l04867"></a>04867     <span class="keywordflow">if</span> (url[len - 1] == <span class="charliteral">&#39;/&#39;</span>)
<a name="l04868"></a>04868         url[len - 1] = 0;
<a name="l04869"></a>04869 
<a name="l04870"></a>04870     <span class="keywordflow">return</span> url;
<a name="l04871"></a>04871 }
<a name="l04872"></a>04872 
<a name="l04873"></a>04873 <span class="keywordtype">int</span>
<a name="l04874"></a><a class="code" href="daemon_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">04874</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, 
<a name="l04875"></a>04875                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l04876"></a>04876                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *key,
<a name="l04877"></a>04877                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
<a name="l04878"></a>04878 {
<a name="l04879"></a>04879     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l04880"></a>04880 
<a name="l04881"></a>04881     repo = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (manager, repo_id);
<a name="l04882"></a>04882     <span class="keywordflow">if</span> (!repo)
<a name="l04883"></a>04883         <span class="keywordflow">return</span> -1;
<a name="l04884"></a>04884 
<a name="l04885"></a>04885     <span class="keywordflow">if</span> (strcmp(key, <a class="code" href="daemon_2repo-mgr_8h.html#a2d6340e4ada61e93d58c0411fa6fcfe5">REPO_AUTO_SYNC</a>) == 0) {
<a name="l04886"></a>04886         <span class="keywordflow">if</span> (!<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a5432788378b921624977855244c63a85">started</a>) {
<a name="l04887"></a>04887             seaf_message (<span class="stringliteral">&quot;System not started, skip setting auto sync value.\n&quot;</span>);
<a name="l04888"></a>04888             <span class="keywordflow">return</span> 0;
<a name="l04889"></a>04889         }
<a name="l04890"></a>04890 
<a name="l04891"></a>04891         <span class="keywordflow">if</span> (g_strcmp0(value, <span class="stringliteral">&quot;true&quot;</span>) == 0) {
<a name="l04892"></a>04892             repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a> = 1;
<a name="l04893"></a>04893             <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>)
<a name="l04894"></a>04894                 <a class="code" href="wt-monitor_8c.html#aa6375a36881f0c171399a5116e64f061">seaf_wt_monitor_watch_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a64fc6ad3e80ab34bd2d5ac10dfc1aa66">wt_monitor</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l04895"></a>04895                                             repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>);
<a name="l04896"></a>04896             repo-&gt;<a class="code" href="struct__SeafRepo.html#aea8a8f2c57241ca9b47ae1e7026b4ea5">last_sync_time</a> = 0;
<a name="l04897"></a>04897         } <span class="keywordflow">else</span> {
<a name="l04898"></a>04898             repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a> = 0;
<a name="l04899"></a>04899             <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#acde5aeaa410508f873ecaecd9da4c681">is_readonly</a>)
<a name="l04900"></a>04900                 <a class="code" href="wt-monitor_8c.html#af6eb142936b07efb92d6b4e6ef650f64">seaf_wt_monitor_unwatch_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a64fc6ad3e80ab34bd2d5ac10dfc1aa66">wt_monitor</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l04901"></a>04901             <span class="comment">/* Cancel current sync task if any. */</span>
<a name="l04902"></a>04902             <a class="code" href="sync-mgr_8c.html#a0b90f2ae7c7e7a85ae97b7ade254572a">seaf_sync_manager_cancel_sync_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a6b2a5e1e723955885f9fb27c5f064df4">sync_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l04903"></a>04903         }
<a name="l04904"></a>04904     }
<a name="l04905"></a>04905     <span class="keywordflow">if</span> (strcmp(key, <a class="code" href="daemon_2repo-mgr_8h.html#a4dc57106ac24f4cf008c10b85ae1e384">REPO_NET_BROWSABLE</a>) == 0) {
<a name="l04906"></a>04906         <span class="keywordflow">if</span> (g_strcmp0(value, <span class="stringliteral">&quot;true&quot;</span>) == 0)
<a name="l04907"></a>04907             repo-&gt;<a class="code" href="struct__SeafRepo.html#a575e562d38b7fc0adc79a6b24ea00ac1">net_browsable</a> = 1;
<a name="l04908"></a>04908         <span class="keywordflow">else</span>
<a name="l04909"></a>04909             repo-&gt;<a class="code" href="struct__SeafRepo.html#a575e562d38b7fc0adc79a6b24ea00ac1">net_browsable</a> = 0;
<a name="l04910"></a>04910     }
<a name="l04911"></a>04911 
<a name="l04912"></a>04912     <span class="keywordflow">if</span> (strcmp(key, <a class="code" href="daemon_2repo-mgr_8h.html#a88e179c17ec642b434e82bb40403a6ba">REPO_RELAY_ID</a>) == 0)
<a name="l04913"></a>04913         <span class="keywordflow">return</span> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ad2263393047e4ea1f5226842b11e7b05">seaf_repo_manager_set_repo_relay_id</a> (manager, repo, value);
<a name="l04914"></a>04914 
<a name="l04915"></a>04915     <span class="keywordflow">if</span> (strcmp (key, <a class="code" href="daemon_2repo-mgr_8h.html#a55797c21d6209596736b5a81a8411ff9">REPO_PROP_SERVER_URL</a>) == 0) {
<a name="l04916"></a>04916         <span class="keywordtype">char</span> *url = canonical_server_url (value);
<a name="l04917"></a>04917         repo-&gt;<a class="code" href="struct__SeafRepo.html#a1a7beee19acb913be2c23ac0e71ea733">server_url</a> = url;
<a name="l04918"></a>04918         save_repo_property (manager, repo_id, key, url);
<a name="l04919"></a>04919         <span class="keywordflow">return</span> 0;
<a name="l04920"></a>04920     }
<a name="l04921"></a>04921 
<a name="l04922"></a>04922     save_repo_property (manager, repo_id, key, value);
<a name="l04923"></a>04923     <span class="keywordflow">return</span> 0;
<a name="l04924"></a>04924 }
<a name="l04925"></a>04925 
<a name="l04926"></a>04926 <span class="keywordtype">char</span> *
<a name="l04927"></a><a class="code" href="daemon_2repo-mgr_8c.html#a71edf5bba9589fa8793d7b0312cb9553">04927</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a71edf5bba9589fa8793d7b0312cb9553">seaf_repo_manager_get_repo_property</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, 
<a name="l04928"></a>04928                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l04929"></a>04929                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *key)
<a name="l04930"></a>04930 {
<a name="l04931"></a>04931     <span class="keywordflow">return</span> load_repo_property (manager, repo_id, key);
<a name="l04932"></a>04932 }
<a name="l04933"></a>04933 
<a name="l04934"></a>04934 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l04935"></a>04935 seaf_repo_manager_del_repo_property (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, 
<a name="l04936"></a>04936                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l04937"></a>04937 {
<a name="l04938"></a>04938     <span class="keywordtype">char</span> *sql;
<a name="l04939"></a>04939     sqlite3 *db = manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>;
<a name="l04940"></a>04940 
<a name="l04941"></a>04941     pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04942"></a>04942 
<a name="l04943"></a>04943     sql = sqlite3_mprintf (<span class="stringliteral">&quot;DELETE FROM RepoProperty WHERE repo_id = %Q&quot;</span>, repo_id);
<a name="l04944"></a>04944     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04945"></a>04945     sqlite3_free (sql);
<a name="l04946"></a>04946 
<a name="l04947"></a>04947     pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04948"></a>04948 }
<a name="l04949"></a>04949 
<a name="l04950"></a>04950 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l04951"></a>04951 seaf_repo_manager_del_repo_property_by_key (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l04952"></a>04952                                             <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l04953"></a>04953                                             <span class="keyword">const</span> <span class="keywordtype">char</span> *key)
<a name="l04954"></a>04954 {
<a name="l04955"></a>04955     <span class="keywordtype">char</span> *sql;
<a name="l04956"></a>04956     sqlite3 *db = manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>;
<a name="l04957"></a>04957 
<a name="l04958"></a>04958     pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04959"></a>04959 
<a name="l04960"></a>04960     sql = sqlite3_mprintf (<span class="stringliteral">&quot;DELETE FROM RepoProperty &quot;</span>
<a name="l04961"></a>04961                            <span class="stringliteral">&quot;WHERE repo_id = %Q &quot;</span>
<a name="l04962"></a>04962                            <span class="stringliteral">&quot;  AND key = %Q&quot;</span>, repo_id, key);
<a name="l04963"></a>04963     <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);
<a name="l04964"></a>04964     sqlite3_free (sql);
<a name="l04965"></a>04965 
<a name="l04966"></a>04966     pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l04967"></a>04967 }
<a name="l04968"></a>04968 
<a name="l04969"></a>04969 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l04970"></a>04970 save_repo_enc_info (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l04971"></a>04971                     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l04972"></a>04972 {
<a name="l04973"></a>04973     sqlite3 *db = manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>;
<a name="l04974"></a>04974     <span class="keywordtype">char</span> sql[512];
<a name="l04975"></a>04975     <span class="keywordtype">char</span> key[65], iv[33];
<a name="l04976"></a>04976 
<a name="l04977"></a>04977     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> == 1) {
<a name="l04978"></a>04978         <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ad951f63e287f0ea14c863937afea6779">enc_key</a>, key, 16);
<a name="l04979"></a>04979         <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a7ad105e1fab206035f1c585c25e0dc94">enc_iv</a>, iv, 16);
<a name="l04980"></a>04980     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> == 2) {
<a name="l04981"></a>04981         <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ad951f63e287f0ea14c863937afea6779">enc_key</a>, key, 32);
<a name="l04982"></a>04982         <a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a7ad105e1fab206035f1c585c25e0dc94">enc_iv</a>, iv, 16);
<a name="l04983"></a>04983     }
<a name="l04984"></a>04984 
<a name="l04985"></a>04985     snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;REPLACE INTO RepoKeys VALUES (&#39;%s&#39;, &#39;%s&#39;, &#39;%s&#39;)&quot;</span>,
<a name="l04986"></a>04986               repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, key, iv);
<a name="l04987"></a>04987     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql) &lt; 0)
<a name="l04988"></a>04988         <span class="keywordflow">return</span> -1;
<a name="l04989"></a>04989 
<a name="l04990"></a>04990     <span class="keywordflow">return</span> 0;
<a name="l04991"></a>04991 }
<a name="l04992"></a>04992 
<a name="l04993"></a>04993 <span class="keywordtype">int</span> 
<a name="l04994"></a><a class="code" href="daemon_2repo-mgr_8c.html#a683d25df06076d282da2f7ae01e05a49">04994</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a683d25df06076d282da2f7ae01e05a49">seaf_repo_manager_set_repo_passwd</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l04995"></a>04995                                    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo,
<a name="l04996"></a>04996                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *passwd)
<a name="l04997"></a>04997 {
<a name="l04998"></a>04998     <span class="keywordtype">int</span> ret;
<a name="l04999"></a>04999 
<a name="l05000"></a>05000     <span class="keywordflow">if</span> (<a class="code" href="seafile-crypt_8c.html#af0dc7b06b352baa5469b21beec40f73a">seafile_decrypt_repo_enc_key</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>, passwd, repo-&gt;<a class="code" href="struct__SeafRepo.html#a83e0a2366ba320396f2deb6faa167b84">random_key</a>,
<a name="l05001"></a>05001                                       repo-&gt;<a class="code" href="struct__SeafRepo.html#ad951f63e287f0ea14c863937afea6779">enc_key</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a7ad105e1fab206035f1c585c25e0dc94">enc_iv</a>) &lt; 0)
<a name="l05002"></a>05002         <span class="keywordflow">return</span> -1;
<a name="l05003"></a>05003 
<a name="l05004"></a>05004     pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l05005"></a>05005 
<a name="l05006"></a>05006     ret = save_repo_enc_info (manager, repo);
<a name="l05007"></a>05007 
<a name="l05008"></a>05008     pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l05009"></a>05009 
<a name="l05010"></a>05010     <span class="keywordflow">return</span> ret;
<a name="l05011"></a>05011 }
<a name="l05012"></a>05012 
<a name="l05013"></a>05013 <span class="keywordtype">int</span>
<a name="l05014"></a><a class="code" href="daemon_2repo-mgr_8c.html#a2e382a4324579845c975befc11cccda2">05014</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a2e382a4324579845c975befc11cccda2">seaf_repo_manager_set_merge</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l05015"></a>05015                              <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l05016"></a>05016                              <span class="keyword">const</span> <span class="keywordtype">char</span> *remote_head)
<a name="l05017"></a>05017 {
<a name="l05018"></a>05018     <span class="keywordtype">char</span> sql[256];
<a name="l05019"></a>05019 
<a name="l05020"></a>05020     pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l05021"></a>05021 
<a name="l05022"></a>05022     snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;REPLACE INTO MergeInfo VALUES (&#39;%s&#39;, 1, &#39;%s&#39;);&quot;</span>,
<a name="l05023"></a>05023               repo_id, remote_head);
<a name="l05024"></a>05024     <span class="keywordtype">int</span> ret = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l05025"></a>05025 
<a name="l05026"></a>05026     pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l05027"></a>05027     <span class="keywordflow">return</span> ret;
<a name="l05028"></a>05028 }
<a name="l05029"></a>05029 
<a name="l05030"></a>05030 <span class="keywordtype">int</span>
<a name="l05031"></a><a class="code" href="daemon_2repo-mgr_8c.html#a04253ac87d4466bd4e2abd1e312a1663">05031</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a04253ac87d4466bd4e2abd1e312a1663">seaf_repo_manager_clear_merge</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l05032"></a>05032                                <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l05033"></a>05033 {
<a name="l05034"></a>05034     <span class="keywordtype">char</span> sql[256];
<a name="l05035"></a>05035 
<a name="l05036"></a>05036     pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l05037"></a>05037 
<a name="l05038"></a>05038     snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;UPDATE MergeInfo SET in_merge=0 WHERE repo_id=&#39;%s&#39;;&quot;</span>,
<a name="l05039"></a>05039               repo_id);
<a name="l05040"></a>05040     <span class="keywordtype">int</span> ret = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l05041"></a>05041 
<a name="l05042"></a>05042     pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l05043"></a>05043     <span class="keywordflow">return</span> ret;
<a name="l05044"></a>05044 }
<a name="l05045"></a>05045 
<a name="l05046"></a>05046 <span class="keyword">static</span> gboolean
<a name="l05047"></a>05047 get_merge_info (sqlite3_stmt *stmt, <span class="keywordtype">void</span> *vinfo)
<a name="l05048"></a>05048 {
<a name="l05049"></a>05049     <a class="code" href="structSeafRepoMergeInfo.html">SeafRepoMergeInfo</a> *info = vinfo;
<a name="l05050"></a>05050     <span class="keywordtype">int</span> in_merge;
<a name="l05051"></a>05051 
<a name="l05052"></a>05052     in_merge = sqlite3_column_int (stmt, 1);
<a name="l05053"></a>05053     <span class="keywordflow">if</span> (in_merge == 0)
<a name="l05054"></a>05054         info-&gt;<a class="code" href="structSeafRepoMergeInfo.html#a511f64caf502d7e67b2ce2d838c5fa51">in_merge</a> = FALSE;
<a name="l05055"></a>05055     <span class="keywordflow">else</span>
<a name="l05056"></a>05056         info-&gt;<a class="code" href="structSeafRepoMergeInfo.html#a511f64caf502d7e67b2ce2d838c5fa51">in_merge</a> = TRUE;
<a name="l05057"></a>05057 
<a name="l05058"></a>05058     <span class="comment">/* </span>
<a name="l05059"></a>05059 <span class="comment">     * Note that compatibility, we store remote_head in the &quot;branch&quot; column.</span>
<a name="l05060"></a>05060 <span class="comment">     */</span>
<a name="l05061"></a>05061     <span class="keyword">const</span> <span class="keywordtype">char</span> *remote_head = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) sqlite3_column_text (stmt, 2);
<a name="l05062"></a>05062     memcpy (info-&gt;<a class="code" href="structSeafRepoMergeInfo.html#a1f6af16dd70282a1c33333a4b6520219">remote_head</a>, remote_head, 40);
<a name="l05063"></a>05063 
<a name="l05064"></a>05064     <span class="keywordflow">return</span> FALSE;
<a name="l05065"></a>05065 }
<a name="l05066"></a>05066 
<a name="l05067"></a>05067 <span class="keywordtype">int</span>
<a name="l05068"></a><a class="code" href="daemon_2repo-mgr_8c.html#ac0e4e52af419d42f34ce53d368777070">05068</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ac0e4e52af419d42f34ce53d368777070">seaf_repo_manager_get_merge_info</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l05069"></a>05069                                   <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l05070"></a>05070                                   <a class="code" href="structSeafRepoMergeInfo.html">SeafRepoMergeInfo</a> *info)
<a name="l05071"></a>05071 {
<a name="l05072"></a>05072     <span class="keywordtype">char</span> sql[256];
<a name="l05073"></a>05073 
<a name="l05074"></a>05074     <span class="comment">/* Default not in_merge, if no row is found in db. */</span>
<a name="l05075"></a>05075     info-&gt;<a class="code" href="structSeafRepoMergeInfo.html#a511f64caf502d7e67b2ce2d838c5fa51">in_merge</a> = FALSE;
<a name="l05076"></a>05076 
<a name="l05077"></a>05077     pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l05078"></a>05078 
<a name="l05079"></a>05079     snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT * FROM MergeInfo WHERE repo_id=&#39;%s&#39;;&quot;</span>,
<a name="l05080"></a>05080               repo_id);
<a name="l05081"></a>05081     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql,
<a name="l05082"></a>05082                                      get_merge_info, info) &lt; 0) {
<a name="l05083"></a>05083         pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l05084"></a>05084         <span class="keywordflow">return</span> -1;
<a name="l05085"></a>05085     }
<a name="l05086"></a>05086 
<a name="l05087"></a>05087     pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l05088"></a>05088 
<a name="l05089"></a>05089     <span class="keywordflow">return</span> 0;
<a name="l05090"></a>05090 }
<a name="l05091"></a>05091 
<a name="l05092"></a>05092 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l05093"></a>05093     <span class="keywordtype">char</span> common_ancestor[41];
<a name="l05094"></a>05094     <span class="keywordtype">char</span> head_id[41];
<a name="l05095"></a>05095 } <a class="code" href="structCAInfo.html">CAInfo</a>;
<a name="l05096"></a>05096 
<a name="l05097"></a>05097 <span class="keyword">static</span> gboolean
<a name="l05098"></a>05098 get_common_ancestor (sqlite3_stmt *stmt, <span class="keywordtype">void</span> *vinfo)
<a name="l05099"></a>05099 {
<a name="l05100"></a>05100     <a class="code" href="structCAInfo.html">CAInfo</a> *info = vinfo;
<a name="l05101"></a>05101 
<a name="l05102"></a>05102     <span class="keyword">const</span> <span class="keywordtype">char</span> *ancestor = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) sqlite3_column_text (stmt, 0);
<a name="l05103"></a>05103     <span class="keyword">const</span> <span class="keywordtype">char</span> *head_id = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) sqlite3_column_text (stmt, 1);
<a name="l05104"></a>05104 
<a name="l05105"></a>05105     memcpy (info-&gt;<a class="code" href="structCAInfo.html#a7cc5cc6b5c24fb17f1ae6fccd0b4886b">common_ancestor</a>, ancestor, 40);
<a name="l05106"></a>05106     memcpy (info-&gt;<a class="code" href="structCAInfo.html#a042601365b02d2737bc2466821337b3e">head_id</a>, head_id, 40);
<a name="l05107"></a>05107 
<a name="l05108"></a>05108     <span class="keywordflow">return</span> FALSE;
<a name="l05109"></a>05109 }
<a name="l05110"></a>05110 
<a name="l05111"></a>05111 <span class="keywordtype">int</span>
<a name="l05112"></a><a class="code" href="daemon_2repo-mgr_8c.html#a3d8affa43a26075cdd6821e330f68748">05112</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a3d8affa43a26075cdd6821e330f68748">seaf_repo_manager_get_common_ancestor</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l05113"></a>05113                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l05114"></a>05114                                        <span class="keywordtype">char</span> *common_ancestor,
<a name="l05115"></a>05115                                        <span class="keywordtype">char</span> *head_id)
<a name="l05116"></a>05116 {
<a name="l05117"></a>05117     <span class="keywordtype">char</span> sql[256];
<a name="l05118"></a>05118     <a class="code" href="structCAInfo.html">CAInfo</a> info;
<a name="l05119"></a>05119 
<a name="l05120"></a>05120     memset (&amp;info, 0, <span class="keyword">sizeof</span>(info));
<a name="l05121"></a>05121 
<a name="l05122"></a>05122     pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l05123"></a>05123 
<a name="l05124"></a>05124     snprintf (sql, <span class="keyword">sizeof</span>(sql),
<a name="l05125"></a>05125               <span class="stringliteral">&quot;SELECT ca_id, head_id FROM CommonAncestor WHERE repo_id=&#39;%s&#39;;&quot;</span>,
<a name="l05126"></a>05126               repo_id);
<a name="l05127"></a>05127     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql,
<a name="l05128"></a>05128                                      get_common_ancestor, &amp;info) &lt; 0) {
<a name="l05129"></a>05129         pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l05130"></a>05130         <span class="keywordflow">return</span> -1;
<a name="l05131"></a>05131     }
<a name="l05132"></a>05132 
<a name="l05133"></a>05133     pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l05134"></a>05134 
<a name="l05135"></a>05135     memcpy (common_ancestor, info.<a class="code" href="structCAInfo.html#a7cc5cc6b5c24fb17f1ae6fccd0b4886b">common_ancestor</a>, 41);
<a name="l05136"></a>05136     memcpy (head_id, info.<a class="code" href="structCAInfo.html#a042601365b02d2737bc2466821337b3e">head_id</a>, 41);
<a name="l05137"></a>05137 
<a name="l05138"></a>05138     <span class="keywordflow">return</span> 0;
<a name="l05139"></a>05139 }
<a name="l05140"></a>05140 
<a name="l05141"></a>05141 <span class="keywordtype">int</span>
<a name="l05142"></a><a class="code" href="daemon_2repo-mgr_8c.html#af2f71495e665325efae99d4beb03deb5">05142</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#af2f71495e665325efae99d4beb03deb5">seaf_repo_manager_set_common_ancestor</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l05143"></a>05143                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l05144"></a>05144                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *common_ancestor,
<a name="l05145"></a>05145                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *head_id)
<a name="l05146"></a>05146 {
<a name="l05147"></a>05147     <span class="keywordtype">char</span> sql[256];
<a name="l05148"></a>05148 
<a name="l05149"></a>05149     pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l05150"></a>05150 
<a name="l05151"></a>05151     snprintf (sql, <span class="keyword">sizeof</span>(sql),
<a name="l05152"></a>05152               <span class="stringliteral">&quot;REPLACE INTO CommonAncestor VALUES (&#39;%s&#39;, &#39;%s&#39;, &#39;%s&#39;);&quot;</span>,
<a name="l05153"></a>05153               repo_id, common_ancestor, head_id);
<a name="l05154"></a>05154     <span class="keywordtype">int</span> ret = <a class="code" href="seafile-4_81_82_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a73d385bd72143e5f1e8fb7c2db240347">db</a>, sql);
<a name="l05155"></a>05155 
<a name="l05156"></a>05156     pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
<a name="l05157"></a>05157     <span class="keywordflow">return</span> ret;
<a name="l05158"></a>05158 }
<a name="l05159"></a>05159 
<a name="l05160"></a>05160 GList*
<a name="l05161"></a><a class="code" href="daemon_2repo-mgr_8c.html#a5fe41fb7382995f3f335e408ba4ddb30">05161</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a5fe41fb7382995f3f335e408ba4ddb30">seaf_repo_manager_get_repo_list</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <span class="keywordtype">int</span> start, <span class="keywordtype">int</span> limit)
<a name="l05162"></a>05162 {
<a name="l05163"></a>05163     GList *repo_list = NULL;
<a name="l05164"></a>05164     GHashTableIter iter;
<a name="l05165"></a>05165     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l05166"></a>05166     gpointer key, value;
<a name="l05167"></a>05167 
<a name="l05168"></a>05168     <span class="keywordflow">if</span> (pthread_rwlock_rdlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>) &lt; 0) {
<a name="l05169"></a>05169         g_warning (<span class="stringliteral">&quot;[repo mgr] failed to lock repo cache.\n&quot;</span>);
<a name="l05170"></a>05170         <span class="keywordflow">return</span> NULL;
<a name="l05171"></a>05171     }
<a name="l05172"></a>05172     g_hash_table_iter_init (&amp;iter, manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a46e78181430977b311346c02e5738286">repo_hash</a>);
<a name="l05173"></a>05173 
<a name="l05174"></a>05174     <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
<a name="l05175"></a>05175         repo = value;
<a name="l05176"></a>05176         <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>)
<a name="l05177"></a>05177             repo_list = g_list_prepend (repo_list, repo);
<a name="l05178"></a>05178     }
<a name="l05179"></a>05179 
<a name="l05180"></a>05180     pthread_rwlock_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);
<a name="l05181"></a>05181 
<a name="l05182"></a>05182     <span class="keywordflow">return</span> repo_list;
<a name="l05183"></a>05183 }
<a name="l05184"></a>05184 
<a name="l05185"></a>05185 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l05186"></a>05186     <a class="code" href="struct__SeafRepo.html">SeafRepo</a>                *repo;
<a name="l05187"></a>05187     <a class="code" href="structCheckoutTask.html">CheckoutTask</a>            *task;
<a name="l05188"></a>05188     <a class="code" href="daemon_2repo-mgr_8h.html#a699bd5e643ce774eaebfc58876713669">CheckoutDoneCallback</a>     done_cb;
<a name="l05189"></a>05189     <span class="keywordtype">void</span>                    *cb_data;
<a name="l05190"></a>05190 } <a class="code" href="structCheckoutData.html">CheckoutData</a>;
<a name="l05191"></a>05191 
<a name="l05192"></a>05192 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l05193"></a>05193 checkout_job_done (<span class="keywordtype">void</span> *vresult)
<a name="l05194"></a>05194 {
<a name="l05195"></a>05195     <span class="keywordflow">if</span> (!vresult)
<a name="l05196"></a>05196         <span class="keywordflow">return</span>;
<a name="l05197"></a>05197     <a class="code" href="structCheckoutData.html">CheckoutData</a> *cdata = vresult;
<a name="l05198"></a>05198     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = cdata-&gt;<a class="code" href="structCheckoutData.html#a03c40d0bdf3f7188b8d5a65d1c91311b">repo</a>;
<a name="l05199"></a>05199     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *local = NULL;
<a name="l05200"></a>05200 
<a name="l05201"></a>05201     <span class="keywordflow">if</span> (!cdata-&gt;<a class="code" href="structCheckoutData.html#af0930d83e4f52dde3b3dc1042505d30a">task</a>-&gt;<a class="code" href="structCheckoutTask.html#a1a6e214f7718e025a661ded5f5b9214d">success</a>)
<a name="l05202"></a>05202         <span class="keywordflow">goto</span> out;
<a name="l05203"></a>05203 
<a name="l05204"></a>05204     <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a6ed05df6501a326fc58a0fefb91aef3d">seaf_repo_manager_set_repo_worktree</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>,
<a name="l05205"></a>05205                                          repo,
<a name="l05206"></a>05206                                          cdata-&gt;<a class="code" href="structCheckoutData.html#af0930d83e4f52dde3b3dc1042505d30a">task</a>-&gt;<a class="code" href="structCheckoutTask.html#a26041098da1295d02fe5c82b35deb75d">worktree</a>);
<a name="l05207"></a>05207 
<a name="l05208"></a>05208     local = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="stringliteral">&quot;local&quot;</span>);
<a name="l05209"></a>05209     <span class="keywordflow">if</span> (!local) {
<a name="l05210"></a>05210         seaf_warning (<span class="stringliteral">&quot;Cannot get branch local for repo %s(%.10s).\n&quot;</span>,
<a name="l05211"></a>05211                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l05212"></a>05212         <span class="keywordflow">return</span>;
<a name="l05213"></a>05213     }
<a name="l05214"></a>05214     <span class="comment">/* Set repo head to mark checkout done. */</span>
<a name="l05215"></a>05215     <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a6c47d6277897f6afbe866f2755f9762d">seaf_repo_set_head</a> (repo, local);
<a name="l05216"></a>05216     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (local);
<a name="l05217"></a>05217 
<a name="l05218"></a>05218     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a>) {
<a name="l05219"></a>05219         <span class="keywordflow">if</span> (<a class="code" href="wt-monitor_8c.html#aa6375a36881f0c171399a5116e64f061">seaf_wt_monitor_watch_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a64fc6ad3e80ab34bd2d5ac10dfc1aa66">wt_monitor</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>) &lt; 0) {
<a name="l05220"></a>05220             seaf_warning (<span class="stringliteral">&quot;failed to watch repo %s(%.10s).\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l05221"></a>05221             <span class="keywordflow">return</span>;
<a name="l05222"></a>05222         }
<a name="l05223"></a>05223     }
<a name="l05224"></a>05224 
<a name="l05225"></a>05225 out:
<a name="l05226"></a>05226     <span class="keywordflow">if</span> (cdata-&gt;<a class="code" href="structCheckoutData.html#a110a3d2da03b5eedf63ee17e64aa28f0">done_cb</a>)
<a name="l05227"></a>05227         cdata-&gt;<a class="code" href="structCheckoutData.html#a110a3d2da03b5eedf63ee17e64aa28f0">done_cb</a> (cdata-&gt;<a class="code" href="structCheckoutData.html#af0930d83e4f52dde3b3dc1042505d30a">task</a>, cdata-&gt;<a class="code" href="structCheckoutData.html#a03c40d0bdf3f7188b8d5a65d1c91311b">repo</a>, cdata-&gt;<a class="code" href="structCheckoutData.html#a509cbdb4a742d8fe7995c99b8633c499">cb_data</a>);
<a name="l05228"></a>05228 
<a name="l05229"></a>05229     <span class="comment">/* g_hash_table_remove (mgr-&gt;priv-&gt;checkout_tasks_hash, cdata-&gt;repo-&gt;id); */</span>
<a name="l05230"></a>05230 }
<a name="l05231"></a>05231 
<a name="l05232"></a>05232 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l05233"></a>05233 checkout_repo_job (<span class="keywordtype">void</span> *data)
<a name="l05234"></a>05234 {
<a name="l05235"></a>05235     <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>;
<a name="l05236"></a>05236     <a class="code" href="structCheckoutData.html">CheckoutData</a> *cdata = data;
<a name="l05237"></a>05237     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = cdata-&gt;<a class="code" href="structCheckoutData.html#a03c40d0bdf3f7188b8d5a65d1c91311b">repo</a>;
<a name="l05238"></a>05238     <a class="code" href="structCheckoutTask.html">CheckoutTask</a> *task;
<a name="l05239"></a>05239 
<a name="l05240"></a>05240     task = g_hash_table_lookup (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a7fde21f0d7bba66fac76f4783377f20c">checkout_tasks_hash</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l05241"></a>05241     <span class="keywordflow">if</span> (!task) {
<a name="l05242"></a>05242         seaf_warning (<span class="stringliteral">&quot;Failed to find checkout task for repo %.10s\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l05243"></a>05243         <span class="keywordflow">return</span> NULL;
<a name="l05244"></a>05244     }
<a name="l05245"></a>05245 
<a name="l05246"></a>05246     repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a> = g_strdup (task-&gt;<a class="code" href="structCheckoutTask.html#a26041098da1295d02fe5c82b35deb75d">worktree</a>);
<a name="l05247"></a>05247 
<a name="l05248"></a>05248     <span class="keywordtype">char</span> *error_msg = NULL;
<a name="l05249"></a>05249     <span class="keywordflow">if</span> (<a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a888b4c185cc198eaf4eb7d4d3b8e9054">seaf_repo_checkout</a> (repo, task-&gt;<a class="code" href="structCheckoutTask.html#a26041098da1295d02fe5c82b35deb75d">worktree</a>, &amp;error_msg) &lt; 0) {
<a name="l05250"></a>05250         seaf_warning (<span class="stringliteral">&quot;Failed to checkout repo %.10s to %s : %s\n&quot;</span>,
<a name="l05251"></a>05251                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, task-&gt;<a class="code" href="structCheckoutTask.html#a26041098da1295d02fe5c82b35deb75d">worktree</a>, error_msg);
<a name="l05252"></a>05252         g_free (error_msg);
<a name="l05253"></a>05253         task-&gt;<a class="code" href="structCheckoutTask.html#a1a6e214f7718e025a661ded5f5b9214d">success</a> = FALSE;
<a name="l05254"></a>05254         <span class="keywordflow">goto</span> ret;
<a name="l05255"></a>05255     }
<a name="l05256"></a>05256     task-&gt;<a class="code" href="structCheckoutTask.html#a1a6e214f7718e025a661ded5f5b9214d">success</a> = TRUE;
<a name="l05257"></a>05257 
<a name="l05258"></a>05258 ret:
<a name="l05259"></a>05259     <span class="keywordflow">return</span> data;
<a name="l05260"></a>05260 }
<a name="l05261"></a>05261 
<a name="l05262"></a>05262 <span class="keywordtype">int</span>
<a name="l05263"></a><a class="code" href="daemon_2repo-mgr_8c.html#ae2b1438737e8d1bebeb1e674013b02b5">05263</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ae2b1438737e8d1bebeb1e674013b02b5">seaf_repo_manager_add_checkout_task</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l05264"></a>05264                                      <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo,
<a name="l05265"></a>05265                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree,
<a name="l05266"></a>05266                                      <a class="code" href="daemon_2repo-mgr_8h.html#a699bd5e643ce774eaebfc58876713669">CheckoutDoneCallback</a> done_cb,
<a name="l05267"></a>05267                                      <span class="keywordtype">void</span> *cb_data)
<a name="l05268"></a>05268 {
<a name="l05269"></a>05269     <span class="keywordflow">if</span> (!repo || !worktree) {
<a name="l05270"></a>05270         seaf_warning (<span class="stringliteral">&quot;Invaid args\n&quot;</span>);
<a name="l05271"></a>05271         <span class="keywordflow">return</span> -1;
<a name="l05272"></a>05272     }
<a name="l05273"></a>05273 
<a name="l05274"></a>05274     <a class="code" href="structCheckoutTask.html">CheckoutTask</a> *task = g_new0 (<a class="code" href="structCheckoutTask.html">CheckoutTask</a>, 1);
<a name="l05275"></a>05275     memcpy (task-&gt;<a class="code" href="structCheckoutTask.html#a84eafe72ec4243ad00e41f6fd8a9050b">repo_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, 41);
<a name="l05276"></a>05276     g_return_val_if_fail (strlen(worktree) &lt; <a class="code" href="seafile-4_81_82_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, -1);
<a name="l05277"></a>05277     strcpy (task-&gt;<a class="code" href="structCheckoutTask.html#a26041098da1295d02fe5c82b35deb75d">worktree</a>, worktree);
<a name="l05278"></a>05278 
<a name="l05279"></a>05279     g_hash_table_insert (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a7fde21f0d7bba66fac76f4783377f20c">checkout_tasks_hash</a>,
<a name="l05280"></a>05280                          g_strdup(repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>), task);
<a name="l05281"></a>05281 
<a name="l05282"></a>05282     <a class="code" href="structCheckoutData.html">CheckoutData</a> *cdata = g_new0 (<a class="code" href="structCheckoutData.html">CheckoutData</a>, 1);
<a name="l05283"></a>05283     cdata-&gt;<a class="code" href="structCheckoutData.html#a03c40d0bdf3f7188b8d5a65d1c91311b">repo</a> = repo;
<a name="l05284"></a>05284     cdata-&gt;<a class="code" href="structCheckoutData.html#af0930d83e4f52dde3b3dc1042505d30a">task</a> = task;
<a name="l05285"></a>05285     cdata-&gt;<a class="code" href="structCheckoutData.html#a110a3d2da03b5eedf63ee17e64aa28f0">done_cb</a> = done_cb;
<a name="l05286"></a>05286     cdata-&gt;<a class="code" href="structCheckoutData.html#a509cbdb4a742d8fe7995c99b8633c499">cb_data</a> = cb_data;
<a name="l05287"></a>05287     <a class="code" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768">ccnet_job_manager_schedule_job</a>(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#abcbb9886e315abb16c620ce49808a0b2">job_mgr</a>,
<a name="l05288"></a>05288                                    (<a class="code" href="job-mgr_8h.html#a6afa5278e04afad06a1953d430c877b8">JobThreadFunc</a>)checkout_repo_job,
<a name="l05289"></a>05289                                    (<a class="code" href="job-mgr_8h.html#a837a757135a35cf40cefa26e8909b402">JobDoneCallback</a>)checkout_job_done,
<a name="l05290"></a>05290                                    cdata);
<a name="l05291"></a>05291     <span class="keywordflow">return</span> 0;
<a name="l05292"></a>05292 }
<a name="l05293"></a>05293 
<a name="l05294"></a>05294 <a class="code" href="structCheckoutTask.html">CheckoutTask</a> *
<a name="l05295"></a><a class="code" href="daemon_2repo-mgr_8c.html#abe8b32b343e5e7d2d06018e398011151">05295</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#abe8b32b343e5e7d2d06018e398011151">seaf_repo_manager_get_checkout_task</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l05296"></a>05296                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l05297"></a>05297 {
<a name="l05298"></a>05298     <span class="keywordflow">if</span> (!repo_id || strlen(repo_id) != 36) {
<a name="l05299"></a>05299         seaf_warning (<span class="stringliteral">&quot;Invalid args\n&quot;</span>);
<a name="l05300"></a>05300         <span class="keywordflow">return</span> NULL;
<a name="l05301"></a>05301     }
<a name="l05302"></a>05302 
<a name="l05303"></a>05303     <span class="keywordflow">return</span> g_hash_table_lookup(mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a7fde21f0d7bba66fac76f4783377f20c">checkout_tasks_hash</a>, repo_id);
<a name="l05304"></a>05304 }
<a name="l05305"></a>05305 
<a name="l05306"></a>05306 <span class="keywordtype">int</span>
<a name="l05307"></a><a class="code" href="daemon_2repo-mgr_8c.html#a4f525e2d8e12d4d8afab74b4291c24d3">05307</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a4f525e2d8e12d4d8afab74b4291c24d3">seaf_repo_manager_set_repo_email</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l05308"></a>05308                                   <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo,
<a name="l05309"></a>05309                                   <span class="keyword">const</span> <span class="keywordtype">char</span> *email)
<a name="l05310"></a>05310 {
<a name="l05311"></a>05311     g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a>);
<a name="l05312"></a>05312     repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a> = g_strdup(email);
<a name="l05313"></a>05313 
<a name="l05314"></a>05314     save_repo_property (mgr, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a710e166548b51934b6a3d916eb86442e">REPO_PROP_EMAIL</a>, email);
<a name="l05315"></a>05315     <span class="keywordflow">return</span> 0;
<a name="l05316"></a>05316 }
<a name="l05317"></a>05317 
<a name="l05318"></a>05318 <span class="keywordtype">int</span>
<a name="l05319"></a><a class="code" href="daemon_2repo-mgr_8c.html#a4fdafbeb326de99eec7160b72bcc3dd4">05319</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a4fdafbeb326de99eec7160b72bcc3dd4">seaf_repo_manager_set_repo_token</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, 
<a name="l05320"></a>05320                                   <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo,
<a name="l05321"></a>05321                                   <span class="keyword">const</span> <span class="keywordtype">char</span> *token)
<a name="l05322"></a>05322 {
<a name="l05323"></a>05323     g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a0ce3b61cb31e78ffea429615379b3eb4">token</a>);
<a name="l05324"></a>05324     repo-&gt;<a class="code" href="struct__SeafRepo.html#a0ce3b61cb31e78ffea429615379b3eb4">token</a> = g_strdup(token);
<a name="l05325"></a>05325 
<a name="l05326"></a>05326     save_repo_property (manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a1d2a9886ff3a1d69407ba0b287cbeac4">REPO_PROP_TOKEN</a>, token);
<a name="l05327"></a>05327     <span class="keywordflow">return</span> 0;
<a name="l05328"></a>05328 }
<a name="l05329"></a>05329 
<a name="l05330"></a>05330 
<a name="l05331"></a>05331 <span class="keywordtype">int</span>
<a name="l05332"></a><a class="code" href="daemon_2repo-mgr_8c.html#abbca41e16d1632518aedb8cbe31199b5">05332</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#abbca41e16d1632518aedb8cbe31199b5">seaf_repo_manager_remove_repo_token</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l05333"></a>05333                                      <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l05334"></a>05334 {
<a name="l05335"></a>05335     g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a0ce3b61cb31e78ffea429615379b3eb4">token</a>);
<a name="l05336"></a>05336     repo-&gt;<a class="code" href="struct__SeafRepo.html#a0ce3b61cb31e78ffea429615379b3eb4">token</a> = NULL;
<a name="l05337"></a>05337     seaf_repo_manager_del_repo_property_by_key(manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a1d2a9886ff3a1d69407ba0b287cbeac4">REPO_PROP_TOKEN</a>);
<a name="l05338"></a>05338     <span class="keywordflow">return</span> 0;
<a name="l05339"></a>05339 }
<a name="l05340"></a>05340 
<a name="l05341"></a>05341 <span class="keywordtype">int</span>
<a name="l05342"></a><a class="code" href="daemon_2repo-mgr_8c.html#a8539157b5ddbb1e183886ac3f03b0f0d">05342</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a8539157b5ddbb1e183886ac3f03b0f0d">seaf_repo_manager_set_repo_relay_info</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l05343"></a>05343                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l05344"></a>05344                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *relay_addr,
<a name="l05345"></a>05345                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *relay_port)
<a name="l05346"></a>05346 {
<a name="l05347"></a>05347     save_repo_property (mgr, repo_id, <a class="code" href="daemon_2repo-mgr_8h.html#aed012d90d39cca6687bcc13ab66cb796">REPO_PROP_RELAY_ADDR</a>, relay_addr);
<a name="l05348"></a>05348     save_repo_property (mgr, repo_id, <a class="code" href="daemon_2repo-mgr_8h.html#a566c5e4d2fcf5f9de3a8e996430a22f4">REPO_PROP_RELAY_PORT</a>, relay_port);
<a name="l05349"></a>05349     <span class="keywordflow">return</span> 0;
<a name="l05350"></a>05350 }
<a name="l05351"></a>05351 
<a name="l05352"></a>05352 <span class="keywordtype">void</span>
<a name="l05353"></a><a class="code" href="daemon_2repo-mgr_8c.html#a018177d17e765b6b8519f6537650e1cc">05353</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a018177d17e765b6b8519f6537650e1cc">seaf_repo_manager_get_repo_relay_info</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l05354"></a>05354                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l05355"></a>05355                                        <span class="keywordtype">char</span> **relay_addr,
<a name="l05356"></a>05356                                        <span class="keywordtype">char</span> **relay_port)
<a name="l05357"></a>05357 {
<a name="l05358"></a>05358     <span class="keywordtype">char</span> *addr, *port;
<a name="l05359"></a>05359 
<a name="l05360"></a>05360     addr = load_repo_property (mgr, repo_id, <a class="code" href="daemon_2repo-mgr_8h.html#aed012d90d39cca6687bcc13ab66cb796">REPO_PROP_RELAY_ADDR</a>);
<a name="l05361"></a>05361     port = load_repo_property (mgr, repo_id, <a class="code" href="daemon_2repo-mgr_8h.html#a566c5e4d2fcf5f9de3a8e996430a22f4">REPO_PROP_RELAY_PORT</a>);
<a name="l05362"></a>05362 
<a name="l05363"></a>05363     <span class="keywordflow">if</span> (relay_addr &amp;&amp; addr)
<a name="l05364"></a>05364         *relay_addr = addr;
<a name="l05365"></a>05365     <span class="keywordflow">if</span> (relay_port &amp;&amp; port)
<a name="l05366"></a>05366         *relay_port = port;
<a name="l05367"></a>05367 }
<a name="l05368"></a>05368 
<a name="l05369"></a>05369 <span class="keywordtype">int</span>
<a name="l05370"></a><a class="code" href="daemon_2repo-mgr_8c.html#aaca4b8f68d91db58fc8e1484d9695ce6">05370</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#aaca4b8f68d91db58fc8e1484d9695ce6">seaf_repo_manager_update_repo_relay_info</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l05371"></a>05371                                           <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo,
<a name="l05372"></a>05372                                           <span class="keyword">const</span> <span class="keywordtype">char</span> *new_addr,
<a name="l05373"></a>05373                                           <span class="keyword">const</span> <span class="keywordtype">char</span> *new_port)
<a name="l05374"></a>05374 {
<a name="l05375"></a>05375     GList *ptr, *repos = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a5fe41fb7382995f3f335e408ba4ddb30">seaf_repo_manager_get_repo_list</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, 0, -1);
<a name="l05376"></a>05376     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *r;
<a name="l05377"></a>05377     <span class="keywordflow">for</span> (ptr = repos; ptr; ptr = ptr-&gt;next) {
<a name="l05378"></a>05378         r = ptr-&gt;data;
<a name="l05379"></a>05379         <span class="keywordflow">if</span> (g_strcmp0(r-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>) != 0)
<a name="l05380"></a>05380             <span class="keywordflow">continue</span>;
<a name="l05381"></a>05381 
<a name="l05382"></a>05382         <span class="keywordtype">char</span> *relay_addr = NULL;
<a name="l05383"></a>05383         <span class="keywordtype">char</span> *relay_port = NULL;
<a name="l05384"></a>05384         <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a018177d17e765b6b8519f6537650e1cc">seaf_repo_manager_get_repo_relay_info</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, r-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l05385"></a>05385                                                &amp;relay_addr, &amp;relay_port);
<a name="l05386"></a>05386         <span class="keywordflow">if</span> (g_strcmp0(relay_addr, new_addr) != 0 ||
<a name="l05387"></a>05387             g_strcmp0(relay_port, new_port) != 0) {
<a name="l05388"></a>05388             <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a8539157b5ddbb1e183886ac3f03b0f0d">seaf_repo_manager_set_repo_relay_info</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, r-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l05389"></a>05389                                                    new_addr, new_port);
<a name="l05390"></a>05390         }
<a name="l05391"></a>05391 
<a name="l05392"></a>05392         g_free (relay_addr);
<a name="l05393"></a>05393         g_free (relay_port);
<a name="l05394"></a>05394     }
<a name="l05395"></a>05395 
<a name="l05396"></a>05396     g_list_free (repos);
<a name="l05397"></a>05397 
<a name="l05398"></a>05398     <span class="keywordflow">return</span> 0;
<a name="l05399"></a>05399 }
<a name="l05400"></a>05400 
<a name="l05401"></a>05401 <span class="keywordtype">int</span>
<a name="l05402"></a><a class="code" href="daemon_2repo-mgr_8c.html#ae3753999b4845dfe68bd6f098313280c">05402</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ae3753999b4845dfe68bd6f098313280c">seaf_repo_manager_update_repos_server_host</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l05403"></a>05403                                             <span class="keyword">const</span> <span class="keywordtype">char</span> *old_host,
<a name="l05404"></a>05404                                             <span class="keyword">const</span> <span class="keywordtype">char</span> *new_host,
<a name="l05405"></a>05405                                             <span class="keyword">const</span> <span class="keywordtype">char</span> *new_server_url)
<a name="l05406"></a>05406 {
<a name="l05407"></a>05407     GList *ptr, *repos = <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a5fe41fb7382995f3f335e408ba4ddb30">seaf_repo_manager_get_repo_list</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, 0, -1);
<a name="l05408"></a>05408     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *r;
<a name="l05409"></a>05409     <span class="keywordflow">for</span> (ptr = repos; ptr; ptr = ptr-&gt;next) {
<a name="l05410"></a>05410         r = ptr-&gt;data;
<a name="l05411"></a>05411                 
<a name="l05412"></a>05412         <span class="keywordtype">char</span> *relay_addr = NULL;
<a name="l05413"></a>05413         <span class="keywordtype">char</span> *relay_port = NULL;
<a name="l05414"></a>05414         <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a018177d17e765b6b8519f6537650e1cc">seaf_repo_manager_get_repo_relay_info</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, r-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, 
<a name="l05415"></a>05415                                                &amp;relay_addr, &amp;relay_port);
<a name="l05416"></a>05416         <span class="keywordflow">if</span> (g_strcmp0(relay_addr, old_host) == 0) {
<a name="l05417"></a>05417             <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a8539157b5ddbb1e183886ac3f03b0f0d">seaf_repo_manager_set_repo_relay_info</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, r-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l05418"></a>05418                                                    new_host, relay_port);
<a name="l05419"></a>05419             <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (
<a name="l05420"></a>05420                 <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, r-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a55797c21d6209596736b5a81a8411ff9">REPO_PROP_SERVER_URL</a>, new_server_url);
<a name="l05421"></a>05421         }
<a name="l05422"></a>05422 
<a name="l05423"></a>05423         g_free (relay_addr);
<a name="l05424"></a>05424         g_free (relay_port);
<a name="l05425"></a>05425     }
<a name="l05426"></a>05426 
<a name="l05427"></a>05427     g_list_free (repos);
<a name="l05428"></a>05428 
<a name="l05429"></a>05429     <span class="keywordflow">return</span> 0;
<a name="l05430"></a>05430 }
<a name="l05431"></a>05431 
<a name="l05432"></a>05432 <span class="comment">/*</span>
<a name="l05433"></a>05433 <span class="comment"> * Read ignored files from ignore.txt</span>
<a name="l05434"></a>05434 <span class="comment"> */</span>
<a name="l05435"></a><a class="code" href="daemon_2repo-mgr_8c.html#abdf6d76830c08b16b49d76e2f34037a5">05435</a> GList *<a class="code" href="daemon_2Backups_2repo-mgr_8c.html#abdf6d76830c08b16b49d76e2f34037a5">seaf_repo_load_ignore_files</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *worktree)
<a name="l05436"></a>05436 {
<a name="l05437"></a>05437     GList *list = NULL;
<a name="l05438"></a>05438     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l05439"></a>05439     FILE *fp;
<a name="l05440"></a>05440     <span class="keywordtype">char</span> *full_path, *pattern;
<a name="l05441"></a>05441     <span class="keywordtype">char</span> path[PATH_MAX];
<a name="l05442"></a>05442 
<a name="l05443"></a>05443     full_path = g_build_path (<a class="code" href="vc-utils_8h.html#aa7da4cdc6796b13fca1a4b263488dfdd">PATH_SEPERATOR</a>, worktree,
<a name="l05444"></a>05444                               <a class="code" href="daemon_2repo-mgr_8c.html#a237e501289ed87ac7fb2bb3859e81cb0">IGNORE_FILE</a>, NULL);
<a name="l05445"></a>05445     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (full_path, &amp;st) &lt; 0)
<a name="l05446"></a>05446         <span class="keywordflow">goto</span> error;
<a name="l05447"></a>05447     <span class="keywordflow">if</span> (!S_ISREG(st.st_mode))
<a name="l05448"></a>05448         <span class="keywordflow">goto</span> error;
<a name="l05449"></a>05449     fp = g_fopen(full_path, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l05450"></a>05450     <span class="keywordflow">if</span> (fp == NULL)
<a name="l05451"></a>05451         <span class="keywordflow">goto</span> error;
<a name="l05452"></a>05452 
<a name="l05453"></a>05453     <span class="keywordflow">while</span> (fgets(path, PATH_MAX, fp) != NULL) {
<a name="l05454"></a>05454         <span class="comment">/* remove leading and trailing whitespace, including \n \r. */</span>
<a name="l05455"></a>05455         g_strstrip (path);
<a name="l05456"></a>05456 
<a name="l05457"></a>05457         <span class="comment">/* ignore comment and blank line */</span>
<a name="l05458"></a>05458         <span class="keywordflow">if</span> (path[0] == <span class="charliteral">&#39;#&#39;</span> || path[0] == <span class="charliteral">&#39;\0&#39;</span>)
<a name="l05459"></a>05459             <span class="keywordflow">continue</span>;
<a name="l05460"></a>05460 
<a name="l05461"></a>05461         <span class="comment">/* Change &#39;foo/&#39; to &#39;foo/ *&#39;. */</span>
<a name="l05462"></a>05462         <span class="keywordflow">if</span> (path[strlen(path)-1] == <span class="charliteral">&#39;/&#39;</span>)
<a name="l05463"></a>05463             pattern = g_strdup_printf(<span class="stringliteral">&quot;%s/%s*&quot;</span>, worktree, path);
<a name="l05464"></a>05464         <span class="keywordflow">else</span>
<a name="l05465"></a>05465             pattern = g_strdup_printf(<span class="stringliteral">&quot;%s/%s&quot;</span>, worktree, path);
<a name="l05466"></a>05466 
<a name="l05467"></a>05467         list = g_list_prepend(list, pattern);
<a name="l05468"></a>05468     }
<a name="l05469"></a>05469 
<a name="l05470"></a>05470     fclose(fp);
<a name="l05471"></a>05471     g_free (full_path);
<a name="l05472"></a>05472     <span class="keywordflow">return</span> list;
<a name="l05473"></a>05473 
<a name="l05474"></a>05474 error:
<a name="l05475"></a>05475     g_free (full_path);
<a name="l05476"></a>05476     <span class="keywordflow">return</span> NULL;
<a name="l05477"></a>05477 }
<a name="l05478"></a>05478 
<a name="l05479"></a>05479 gboolean
<a name="l05480"></a><a class="code" href="daemon_2repo-mgr_8c.html#a32907bbaf9e2790699ddb7aaa97a3052">05480</a> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#a32907bbaf9e2790699ddb7aaa97a3052">seaf_repo_check_ignore_file</a> (GList *ignore_list, <span class="keyword">const</span> <span class="keywordtype">char</span> *fullpath)
<a name="l05481"></a>05481 {
<a name="l05482"></a>05482     <span class="keywordtype">char</span> *str;
<a name="l05483"></a>05483     <a class="code" href="seafile-4_81_82_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l05484"></a>05484     GPatternSpec *ignore_spec;
<a name="l05485"></a>05485     GList *p;
<a name="l05486"></a>05486 
<a name="l05487"></a>05487     str = g_strdup(fullpath);
<a name="l05488"></a>05488 
<a name="l05489"></a>05489     <span class="comment">/* first check the path is a reg file or a dir */</span>
<a name="l05490"></a>05490     <span class="keywordflow">if</span> (<a class="code" href="seafile-4_81_82_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a>(str, &amp;st) &lt; 0) {
<a name="l05491"></a>05491         g_free(str);
<a name="l05492"></a>05492         <span class="keywordflow">return</span> FALSE;
<a name="l05493"></a>05493     }
<a name="l05494"></a>05494     <span class="keywordflow">if</span> (S_ISDIR(st.st_mode)) {
<a name="l05495"></a>05495         g_free(str);
<a name="l05496"></a>05496         str = g_strconcat (fullpath, <span class="stringliteral">&quot;/&quot;</span>, NULL);
<a name="l05497"></a>05497     }
<a name="l05498"></a>05498 
<a name="l05499"></a>05499     <span class="keywordflow">for</span> (p = ignore_list; p != NULL; p = p-&gt;next) {
<a name="l05500"></a>05500         <span class="keywordtype">char</span> *pattern = (<span class="keywordtype">char</span> *)p-&gt;data;
<a name="l05501"></a>05501 
<a name="l05502"></a>05502         ignore_spec = g_pattern_spec_new(pattern);
<a name="l05503"></a>05503         <span class="keywordflow">if</span> (g_pattern_match_string(ignore_spec, str)) {
<a name="l05504"></a>05504             g_free (str);
<a name="l05505"></a>05505             g_pattern_spec_free(ignore_spec);
<a name="l05506"></a>05506             <span class="keywordflow">return</span> TRUE;
<a name="l05507"></a>05507         }
<a name="l05508"></a>05508         g_pattern_spec_free(ignore_spec);
<a name="l05509"></a>05509     }
<a name="l05510"></a>05510 
<a name="l05511"></a>05511     g_free (str);
<a name="l05512"></a>05512     <span class="keywordflow">return</span> FALSE;
<a name="l05513"></a>05513 }
<a name="l05514"></a>05514 
<a name="l05515"></a>05515 <span class="comment">/*</span>
<a name="l05516"></a>05516 <span class="comment"> * Free ignored file list</span>
<a name="l05517"></a>05517 <span class="comment"> */</span>
<a name="l05518"></a><a class="code" href="daemon_2repo-mgr_8c.html#ae640da4e7db6b316cd0e3c1ba463f9bd">05518</a> <span class="keywordtype">void</span> <a class="code" href="daemon_2Backups_2repo-mgr_8c.html#ae640da4e7db6b316cd0e3c1ba463f9bd">seaf_repo_free_ignore_files</a> (GList *ignore_list)
<a name="l05519"></a>05519 {
<a name="l05520"></a>05520     GList *p;
<a name="l05521"></a>05521 
<a name="l05522"></a>05522     <span class="keywordflow">if</span> (ignore_list == NULL)
<a name="l05523"></a>05523         <span class="keywordflow">return</span>;
<a name="l05524"></a>05524 
<a name="l05525"></a>05525     <span class="keywordflow">for</span> (p = ignore_list; p != NULL; p = p-&gt;next)
<a name="l05526"></a>05526         free(p-&gt;data);
<a name="l05527"></a>05527 
<a name="l05528"></a>05528     g_list_free (ignore_list);
<a name="l05529"></a>05529 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Wed Aug 19 2015 03:59:41 for My Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
