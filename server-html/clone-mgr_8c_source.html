<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>My Project: seafile/daemon/clone-mgr.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">My Project
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">seafile/daemon/clone-mgr.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="clone-mgr_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="preprocessor">#include &quot;common.h&quot;</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;<a class="code" href="ccnet_8h.html">ccnet.h</a>&gt;</span>
<a name="l00006"></a>00006 
<a name="l00007"></a><a class="code" href="clone-mgr_8c.html#a05d1af42442c934b555896d3fe55c79e">00007</a> <span class="preprocessor">#define DEBUG_FLAG SEAFILE_DEBUG_SYNC</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor">#include &quot;log.h&quot;</span>
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 <span class="preprocessor">#include &quot;<a class="code" href="seafile-error_8h.html">seafile-error.h</a>&quot;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &quot;<a class="code" href="daemon_2seafile-session_8h.html">seafile-session.h</a>&quot;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="index_8h.html">index/index.h</a>&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="merge-recursive_8h.html">merge-recursive.h</a>&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="unpack-trees_8h.html">unpack-trees.h</a>&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;<a class="code" href="vc-utils_8h.html">vc-utils.h</a>&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;utils.h&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="seafile-config_8h.html">seafile-config.h</a>&quot;</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;processors/checkff-proc.h&quot;</span>
<a name="l00020"></a>00020 
<a name="l00021"></a><a class="code" href="clone-mgr_8c.html#a35f4ad46c9e15dc72ccb38574e0c62c6">00021</a> <span class="preprocessor">#define CLONE_DB &quot;clone.db&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span>
<a name="l00023"></a><a class="code" href="clone-mgr_8c.html#a50841e5a1d701383bf3b5c0302545d9b">00023</a> <span class="preprocessor">#define CHECK_CONNECT_INTERVAL 5 </span><span class="comment">/* 5s */</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00026"></a>00026 on_repo_fetched (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>,
<a name="l00027"></a>00027                  <a class="code" href="struct__TransferTask.html">TransferTask</a> *tx_task,
<a name="l00028"></a>00028                  <a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr);
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00031"></a>00031 on_repo_http_fetched (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>,
<a name="l00032"></a>00032                       <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *tx_task,
<a name="l00033"></a>00033                       <a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr);
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00036"></a>00036 on_checkout_done (<a class="code" href="structCheckoutTask.html">CheckoutTask</a> *task, <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <span class="keywordtype">void</span> *data);
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00039"></a>00039 start_index_or_transfer (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr, <a class="code" href="struct__CloneTask.html">CloneTask</a> *task, GError **error);
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00042"></a>00042 start_connect_task_relay (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task, GError **error);
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00045"></a>00045 start_checkout (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <a class="code" href="struct__CloneTask.html">CloneTask</a> *task);
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00048"></a>00048 transition_state (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task, <span class="keywordtype">int</span> new_state);
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00051"></a>00051 transition_to_error (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task, <span class="keywordtype">int</span> error);
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00054"></a>00054 add_transfer_task (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task, GError **error);
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *state_str[] = {
<a name="l00057"></a>00057     <span class="stringliteral">&quot;init&quot;</span>,
<a name="l00058"></a>00058     <span class="stringliteral">&quot;connect&quot;</span>,
<a name="l00059"></a>00059     <span class="stringliteral">&quot;connect&quot;</span>,
<a name="l00060"></a>00060     <span class="stringliteral">&quot;connect&quot;</span>,                  <span class="comment">/* Use &quot;connect&quot; for CHECK_PROTOCOL */</span>
<a name="l00061"></a>00061     <span class="stringliteral">&quot;index&quot;</span>,
<a name="l00062"></a>00062     <span class="stringliteral">&quot;fetch&quot;</span>,
<a name="l00063"></a>00063     <span class="stringliteral">&quot;checkout&quot;</span>,
<a name="l00064"></a>00064     <span class="stringliteral">&quot;merge&quot;</span>,
<a name="l00065"></a>00065     <span class="stringliteral">&quot;done&quot;</span>,
<a name="l00066"></a>00066     <span class="stringliteral">&quot;error&quot;</span>,
<a name="l00067"></a>00067     <span class="stringliteral">&quot;canceling&quot;</span>,
<a name="l00068"></a>00068     <span class="stringliteral">&quot;canceled&quot;</span>,
<a name="l00069"></a>00069 };
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *error_str[] = {
<a name="l00072"></a>00072     <span class="stringliteral">&quot;ok&quot;</span>,
<a name="l00073"></a>00073     <span class="stringliteral">&quot;connect&quot;</span>,
<a name="l00074"></a>00074     <span class="stringliteral">&quot;index&quot;</span>,
<a name="l00075"></a>00075     <span class="stringliteral">&quot;fetch&quot;</span>,
<a name="l00076"></a>00076     <span class="stringliteral">&quot;password&quot;</span>,
<a name="l00077"></a>00077     <span class="stringliteral">&quot;checkout&quot;</span>,
<a name="l00078"></a>00078     <span class="stringliteral">&quot;merge&quot;</span>,
<a name="l00079"></a>00079     <span class="stringliteral">&quot;internal&quot;</span>,
<a name="l00080"></a>00080 };
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00083"></a>00083 start_clone (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task)
<a name="l00084"></a>00084 {
<a name="l00085"></a>00085     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>);
<a name="l00086"></a>00086     <span class="keywordflow">if</span> (!repo)
<a name="l00087"></a>00087         start_index_or_transfer (task-&gt;<a class="code" href="struct__CloneTask.html#a3028c18408cdca62d9f0cc68d03bd121">manager</a>, task, NULL);
<a name="l00088"></a>00088     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a> == NULL)
<a name="l00089"></a>00089         start_checkout (repo, task);
<a name="l00090"></a>00090 }
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00093"></a>00093 mark_clone_done_v2 (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <a class="code" href="struct__CloneTask.html">CloneTask</a> *task)
<a name="l00094"></a>00094 {
<a name="l00095"></a>00095     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *local = NULL;
<a name="l00096"></a>00096 
<a name="l00097"></a>00097     <a class="code" href="daemon_2repo-mgr_8c.html#a6ed05df6501a326fc58a0fefb91aef3d">seaf_repo_manager_set_repo_worktree</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>,
<a name="l00098"></a>00098                                          repo,
<a name="l00099"></a>00099                                          task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>);
<a name="l00100"></a>00100 
<a name="l00101"></a>00101     local = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="stringliteral">&quot;local&quot;</span>);
<a name="l00102"></a>00102     <span class="keywordflow">if</span> (!local) {
<a name="l00103"></a>00103         seaf_warning (<span class="stringliteral">&quot;Cannot get branch local for repo %s(%.10s).\n&quot;</span>,
<a name="l00104"></a>00104                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00105"></a>00105         transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9eacb3d74adef1000d6f681754a40837713">CLONE_ERROR_INTERNAL</a>);
<a name="l00106"></a>00106         <span class="keywordflow">return</span>;
<a name="l00107"></a>00107     }
<a name="l00108"></a>00108     <span class="comment">/* Set repo head to mark checkout done. */</span>
<a name="l00109"></a>00109     <a class="code" href="daemon_2repo-mgr_8c.html#a6c47d6277897f6afbe866f2755f9762d">seaf_repo_set_head</a> (repo, local);
<a name="l00110"></a>00110     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (local);
<a name="l00111"></a>00111 
<a name="l00112"></a>00112     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
<a name="l00113"></a>00113         <span class="keywordflow">if</span> (<a class="code" href="daemon_2repo-mgr_8c.html#a683d25df06076d282da2f7ae01e05a49">seaf_repo_manager_set_repo_passwd</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l00114"></a>00114                                                repo,
<a name="l00115"></a>00115                                                task-&gt;<a class="code" href="struct__CloneTask.html#a474148b59212fcf1716cc6b975593264">passwd</a>) &lt; 0) {
<a name="l00116"></a>00116             seaf_warning (<span class="stringliteral">&quot;[Clone mgr] failed to set passwd for %s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00117"></a>00117             transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9eacb3d74adef1000d6f681754a40837713">CLONE_ERROR_INTERNAL</a>);
<a name="l00118"></a>00118             <span class="keywordflow">return</span>;
<a name="l00119"></a>00119         }
<a name="l00120"></a>00120     }
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#af9ee5390751896c41183f53735bb05bc">is_readonly</a>) {
<a name="l00123"></a>00123         <a class="code" href="daemon_2repo-mgr_8c.html#a01b64563a9ab1351f8a9626c86ff8d6a">seaf_repo_set_readonly</a> (repo);
<a name="l00124"></a>00124     }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a>)
<a name="l00127"></a>00127         repo-&gt;<a class="code" href="struct__SeafRepo.html#a1a7beee19acb913be2c23ac0e71ea733">server_url</a> = g_strdup(task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a>);
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a>) {
<a name="l00130"></a>00130         <span class="keywordflow">if</span> (<a class="code" href="wt-monitor_8c.html#aa6375a36881f0c171399a5116e64f061">seaf_wt_monitor_watch_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a64fc6ad3e80ab34bd2d5ac10dfc1aa66">wt_monitor</a>,
<a name="l00131"></a>00131                                         repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>) &lt; 0) {
<a name="l00132"></a>00132             seaf_warning (<span class="stringliteral">&quot;failed to watch repo %s(%.10s).\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00133"></a>00133             transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9eacb3d74adef1000d6f681754a40837713">CLONE_ERROR_INTERNAL</a>);
<a name="l00134"></a>00134             <span class="keywordflow">return</span>;
<a name="l00135"></a>00135         }
<a name="l00136"></a>00136     }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138     <span class="comment">/* For compatibility, still set these two properties.</span>
<a name="l00139"></a>00139 <span class="comment">     * So that if we downgrade to an old version, the syncing can still work.</span>
<a name="l00140"></a>00140 <span class="comment">     */</span>
<a name="l00141"></a>00141     <a class="code" href="daemon_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l00142"></a>00142                                          repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l00143"></a>00143                                          <a class="code" href="daemon_2repo-mgr_8h.html#af63040384723b88eb87e261c8ebb298b">REPO_REMOTE_HEAD</a>,
<a name="l00144"></a>00144                                          repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l00145"></a>00145     <a class="code" href="daemon_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l00146"></a>00146                                          repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l00147"></a>00147                                          <a class="code" href="daemon_2repo-mgr_8h.html#ab09a088f0dfff9872d5dfb605ed1cade">REPO_LOCAL_HEAD</a>,
<a name="l00148"></a>00148                                          repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8af1c3a28143f803ec77f12421a745c80e">CLONE_STATE_DONE</a>);
<a name="l00151"></a>00151 }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00154"></a>00154 start_clone_v2 (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task)
<a name="l00155"></a>00155 {
<a name="l00156"></a>00156     GError *error = NULL;
<a name="l00157"></a>00157 
<a name="l00158"></a>00158     <span class="keywordflow">if</span> (g_access (task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>, F_OK) != 0 &amp;&amp;
<a name="l00159"></a>00159         g_mkdir_with_parents (task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>, 0777) &lt; 0) {
<a name="l00160"></a>00160         seaf_warning (<span class="stringliteral">&quot;[clone mgr] Failed to create worktree %s.\n&quot;</span>,
<a name="l00161"></a>00161                       task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>);
<a name="l00162"></a>00162         transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea970814942feca38b0d4dbced3393be65">CLONE_ERROR_FETCH</a>);
<a name="l00163"></a>00163         <span class="keywordflow">return</span>;
<a name="l00164"></a>00164     }
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>);
<a name="l00167"></a>00167     <span class="keywordflow">if</span> (repo != NULL) {
<a name="l00168"></a>00168         <a class="code" href="daemon_2repo-mgr_8c.html#a4fdafbeb326de99eec7160b72bcc3dd4">seaf_repo_manager_set_repo_token</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo, task-&gt;<a class="code" href="struct__CloneTask.html#a8e19296e76e4b3dec6b4dfcf4fab5342">token</a>);
<a name="l00169"></a>00169         <a class="code" href="daemon_2repo-mgr_8c.html#a4f525e2d8e12d4d8afab74b4291c24d3">seaf_repo_manager_set_repo_email</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo, task-&gt;<a class="code" href="struct__CloneTask.html#a4b875dabcf508a393d9bf8696c204dae">email</a>);
<a name="l00170"></a>00170         <a class="code" href="daemon_2repo-mgr_8c.html#a8539157b5ddbb1e183886ac3f03b0f0d">seaf_repo_manager_set_repo_relay_info</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l00171"></a>00171                                                task-&gt;<a class="code" href="struct__CloneTask.html#a42281f48e42f5e3766d31dfdca199bb1">peer_addr</a>, task-&gt;<a class="code" href="struct__CloneTask.html#af6e520f57dd7b32106a88ebd42f3d5b1">peer_port</a>);
<a name="l00172"></a>00172         <a class="code" href="daemon_2repo-mgr_8c.html#ad2263393047e4ea1f5226842b11e7b05">seaf_repo_manager_set_repo_relay_id</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo, task-&gt;<a class="code" href="struct__CloneTask.html#a96fa052d9fc866a313ecad95b93a4197">peer_id</a>);
<a name="l00173"></a>00173         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a>) {
<a name="l00174"></a>00174             <a class="code" href="daemon_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l00175"></a>00175                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l00176"></a>00176                                                  <a class="code" href="daemon_2repo-mgr_8h.html#a55797c21d6209596736b5a81a8411ff9">REPO_PROP_SERVER_URL</a>,
<a name="l00177"></a>00177                                                  task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a>);
<a name="l00178"></a>00178         }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180         mark_clone_done_v2 (repo, task);
<a name="l00181"></a>00181         <span class="keywordflow">return</span>;
<a name="l00182"></a>00182     }
<a name="l00183"></a>00183 
<a name="l00184"></a>00184     <span class="keywordflow">if</span> (add_transfer_task (task, &amp;error) == 0)
<a name="l00185"></a>00185         transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8ae67f39ebed40e85b2d90de1f3119edca">CLONE_STATE_FETCH</a>);
<a name="l00186"></a>00186     <span class="keywordflow">else</span>
<a name="l00187"></a>00187         transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea970814942feca38b0d4dbced3393be65">CLONE_ERROR_FETCH</a>);
<a name="l00188"></a>00188 }
<a name="l00189"></a>00189 
<a name="l00190"></a>00190 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00191"></a>00191 check_protocol_done_cb (<a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor, gboolean success, <span class="keywordtype">void</span> *data)
<a name="l00192"></a>00192 {
<a name="l00193"></a>00193     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task = data;
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     <span class="keywordflow">if</span> (success)
<a name="l00196"></a>00196         task-&gt;<a class="code" href="struct__CloneTask.html#a3ed371dcb52612faf91b1ff4501a8f66">server_side_merge</a> = TRUE;
<a name="l00197"></a>00197     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (processor-&gt;<a class="code" href="struct__CcnetProcessor.html#a044d12f3870190314e8fe43d636fd823">failure</a> == <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260a32e3732cd459464942237b9963e3cfa7">PROC_NO_SERVICE</a>)
<a name="l00198"></a>00198         <span class="comment">/* Talking to an old server. */</span>
<a name="l00199"></a>00199         task-&gt;<a class="code" href="struct__CloneTask.html#a3ed371dcb52612faf91b1ff4501a8f66">server_side_merge</a> = FALSE;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#a3ed371dcb52612faf91b1ff4501a8f66">server_side_merge</a>)
<a name="l00202"></a>00202         start_clone_v2 (task);
<a name="l00203"></a>00203     <span class="keywordflow">else</span>
<a name="l00204"></a>00204         start_clone (task);
<a name="l00205"></a>00205 }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00208"></a>00208 start_check_protocol_proc (<span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id, <a class="code" href="struct__CloneTask.html">CloneTask</a> *task)
<a name="l00209"></a>00209 {
<a name="l00210"></a>00210     <a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor;
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#af967b4a19b18b8dca0ad7c471ba98581">repo_version</a> == 0) {
<a name="l00213"></a>00213         task-&gt;<a class="code" href="struct__CloneTask.html#a3ed371dcb52612faf91b1ff4501a8f66">server_side_merge</a> = FALSE;
<a name="l00214"></a>00214         start_clone (task);
<a name="l00215"></a>00215         <span class="keywordflow">return</span> 0;
<a name="l00216"></a>00216     }
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     processor = <a class="code" href="include_2ccnet_2proc-factory_8h.html#a4e77de8f2768695e93845129041759c7">ccnet_proc_factory_create_remote_master_processor</a> (
<a name="l00219"></a>00219         <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>, <span class="stringliteral">&quot;seafile-check-protocol&quot;</span>, peer_id);
<a name="l00220"></a>00220     <span class="keywordflow">if</span> (!processor) {
<a name="l00221"></a>00221         seaf_warning (<span class="stringliteral">&quot;failed to create seafile-check-protocol proc.\n&quot;</span>);
<a name="l00222"></a>00222         <span class="keywordflow">return</span> -1;
<a name="l00223"></a>00223     }
<a name="l00224"></a>00224 
<a name="l00225"></a>00225     <span class="keywordflow">if</span> (<a class="code" href="include_2ccnet_2processor_8h.html#ae2bb4b51c8e7dd43366b777ca9b00cf6">ccnet_processor_startl</a> (processor, NULL) &lt; 0) {
<a name="l00226"></a>00226         seaf_warning (<span class="stringliteral">&quot;failed to start seafile-check-protocol proc.\n&quot;</span>);
<a name="l00227"></a>00227         <span class="keywordflow">return</span> -1;
<a name="l00228"></a>00228     }
<a name="l00229"></a>00229 
<a name="l00230"></a>00230     g_signal_connect (processor, <span class="stringliteral">&quot;done&quot;</span>, (GCallback)check_protocol_done_cb, task);
<a name="l00231"></a>00231 
<a name="l00232"></a>00232     transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a92bbc8ffd9c4edd7093b89cf92fa73c3">CLONE_STATE_CHECK_PROTOCOL</a>);
<a name="l00233"></a>00233 
<a name="l00234"></a>00234     <span class="keywordflow">return</span> 0;
<a name="l00235"></a>00235 }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00238"></a>00238 start_connect_task_relay (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task, GError **error)
<a name="l00239"></a>00239 {
<a name="l00240"></a>00240     <a class="code" href="struct__CcnetPeer.html">CcnetPeer</a> *peer = <a class="code" href="ccnet_8h.html#a136915227534e9204ffca3d7dc4d331e">ccnet_get_peer</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#add541d96cca483ad72ff56ad061d1d32">ccnetrpc_client</a>, task-&gt;<a class="code" href="struct__CloneTask.html#a96fa052d9fc866a313ecad95b93a4197">peer_id</a>);
<a name="l00241"></a>00241     <span class="keywordflow">if</span> (!peer) {
<a name="l00242"></a>00242         <span class="comment">/* clone from a new relay */</span>
<a name="l00243"></a>00243         GString *buf = NULL; 
<a name="l00244"></a>00244         seaf_message (<span class="stringliteral">&quot;add relay before clone, %s:%s\n&quot;</span>,
<a name="l00245"></a>00245                       task-&gt;<a class="code" href="struct__CloneTask.html#a42281f48e42f5e3766d31dfdca199bb1">peer_addr</a>, task-&gt;<a class="code" href="struct__CloneTask.html#af6e520f57dd7b32106a88ebd42f3d5b1">peer_port</a>);
<a name="l00246"></a>00246         buf = g_string_new(NULL);
<a name="l00247"></a>00247         g_string_append_printf (buf, <span class="stringliteral">&quot;add-relay --id %s --addr %s:%s&quot;</span>,
<a name="l00248"></a>00248                                 task-&gt;<a class="code" href="struct__CloneTask.html#a96fa052d9fc866a313ecad95b93a4197">peer_id</a>, task-&gt;<a class="code" href="struct__CloneTask.html#a42281f48e42f5e3766d31dfdca199bb1">peer_addr</a>, task-&gt;<a class="code" href="struct__CloneTask.html#af6e520f57dd7b32106a88ebd42f3d5b1">peer_port</a>);
<a name="l00249"></a>00249         <a class="code" href="ccnet_8h.html#a7e0e66a5bbdd84284c8a524f467c1d6f">ccnet_send_command</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>, buf-&gt;str, NULL, NULL);
<a name="l00250"></a>00250         transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8afd7df49789f27957a882d91822b78eff">CLONE_STATE_CONNECT</a>);
<a name="l00251"></a>00251         g_string_free (buf, TRUE);
<a name="l00252"></a>00252     } <span class="keywordflow">else</span> {
<a name="l00253"></a>00253         <span class="comment">/* The peer is added to ccnet already and will be connected,</span>
<a name="l00254"></a>00254 <span class="comment">         * only need to transition the state</span>
<a name="l00255"></a>00255 <span class="comment">         */</span>
<a name="l00256"></a>00256         transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8afd7df49789f27957a882d91822b78eff">CLONE_STATE_CONNECT</a>);
<a name="l00257"></a>00257     }
<a name="l00258"></a>00258 
<a name="l00259"></a>00259     <span class="keywordflow">if</span> (peer)
<a name="l00260"></a>00260         g_object_unref (peer);
<a name="l00261"></a>00261 }
<a name="l00262"></a>00262 
<a name="l00263"></a>00263 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00264"></a>00264 connect_non_http_server (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task)
<a name="l00265"></a>00265 {
<a name="l00266"></a>00266     <span class="keywordflow">if</span> (!<a class="code" href="ccnet_8h.html#aaf2e8f3b63d6ad9fb1012b23d4e242b0">ccnet_peer_is_ready</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#add541d96cca483ad72ff56ad061d1d32">ccnetrpc_client</a>, task-&gt;<a class="code" href="struct__CloneTask.html#a96fa052d9fc866a313ecad95b93a4197">peer_id</a>))
<a name="l00267"></a>00267         start_connect_task_relay (task, NULL);
<a name="l00268"></a>00268     <span class="keywordflow">else</span>
<a name="l00269"></a>00269         start_check_protocol_proc (task-&gt;<a class="code" href="struct__CloneTask.html#a96fa052d9fc866a313ecad95b93a4197">peer_id</a>, task);
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00273"></a>00273 check_head_commit_done (<a class="code" href="struct__HttpHeadCommit.html">HttpHeadCommit</a> *result, <span class="keywordtype">void</span> *user_data)
<a name="l00274"></a>00274 {
<a name="l00275"></a>00275     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task = user_data;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277     <span class="keywordflow">if</span> (result-&gt;<a class="code" href="struct__HttpHeadCommit.html#a42bce3980347bafa4af5d2b6ef8197a8">check_success</a> &amp;&amp; !result-&gt;<a class="code" href="struct__HttpHeadCommit.html#ae76efcb51a295dedfbf56129af736a4b">is_corrupt</a> &amp;&amp; !result-&gt;<a class="code" href="struct__HttpHeadCommit.html#ad720cf100758716906c6d73a82aad51a">is_deleted</a>) {
<a name="l00278"></a>00278         memcpy (task-&gt;<a class="code" href="struct__CloneTask.html#acbccf574778b2c3241d627352a657eda">server_head_id</a>, result-&gt;<a class="code" href="struct__HttpHeadCommit.html#a153c7fda109c256dacfd330e5025e7e4">head_commit</a>, 40);
<a name="l00279"></a>00279         start_clone_v2 (task);
<a name="l00280"></a>00280     } <span class="keywordflow">else</span> {
<a name="l00281"></a>00281         task-&gt;<a class="code" href="struct__CloneTask.html#ae9ed3b204a7c4364ef44b16a7056ccd1">http_sync</a> = FALSE;
<a name="l00282"></a>00282         connect_non_http_server (task);
<a name="l00283"></a>00283     }
<a name="l00284"></a>00284 }
<a name="l00285"></a>00285 
<a name="l00286"></a>00286 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00287"></a>00287 http_check_head_commit (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task)
<a name="l00288"></a>00288 {
<a name="l00289"></a>00289     <a class="code" href="http-tx-mgr_8c.html#a4f2b3d94b4366c519af0a69ebb6edc34">http_tx_manager_check_head_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>,
<a name="l00290"></a>00290                                        task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>,
<a name="l00291"></a>00291                                        task-&gt;<a class="code" href="struct__CloneTask.html#af967b4a19b18b8dca0ad7c471ba98581">repo_version</a>,
<a name="l00292"></a>00292                                        task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a>,
<a name="l00293"></a>00293                                        task-&gt;<a class="code" href="struct__CloneTask.html#a8e19296e76e4b3dec6b4dfcf4fab5342">token</a>,
<a name="l00294"></a>00294                                        check_head_commit_done,
<a name="l00295"></a>00295                                        task);
<a name="l00296"></a>00296 }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00299"></a>00299 check_http_protocol_done (<a class="code" href="struct__HttpProtocolVersion.html">HttpProtocolVersion</a> *result, <span class="keywordtype">void</span> *user_data)
<a name="l00300"></a>00300 {
<a name="l00301"></a>00301     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task = user_data;
<a name="l00302"></a>00302 
<a name="l00303"></a>00303     <span class="keywordflow">if</span> (result-&gt;<a class="code" href="struct__HttpProtocolVersion.html#a991b27b1c98ba43a9b1ce6015621967b">check_success</a> &amp;&amp; !result-&gt;<a class="code" href="struct__HttpProtocolVersion.html#a8b83905e8e620d43f74b060a44c3a6fd">not_supported</a>) {
<a name="l00304"></a>00304         task-&gt;<a class="code" href="struct__CloneTask.html#a287b2603a5596a4f3a5cf94fb8c745e8">http_protocol_version</a> = result-&gt;<a class="code" href="struct__HttpProtocolVersion.html#af81f9fb94ee6b008195681a8d2026591">version</a>;
<a name="l00305"></a>00305         task-&gt;<a class="code" href="struct__CloneTask.html#ae9ed3b204a7c4364ef44b16a7056ccd1">http_sync</a> = TRUE;
<a name="l00306"></a>00306         http_check_head_commit (task);
<a name="l00307"></a>00307     } <span class="keywordflow">else</span>
<a name="l00308"></a>00308         connect_non_http_server (task);
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00312"></a>00312 check_http_protocol (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task)
<a name="l00313"></a>00313 {
<a name="l00314"></a>00314     <a class="code" href="http-tx-mgr_8c.html#a43e9d54b963e1bd9b8f43814a92563ea">http_tx_manager_check_protocol_version</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>,
<a name="l00315"></a>00315                                             task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a>,
<a name="l00316"></a>00316                                             check_http_protocol_done,
<a name="l00317"></a>00317                                             task);
<a name="l00318"></a>00318     transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a327bd2bf73c5ed1911de1f9e75e1c510">CLONE_STATE_CHECK_HTTP</a>);
<a name="l00319"></a>00319 }
<a name="l00320"></a>00320 
<a name="l00321"></a>00321 <span class="keyword">static</span> <a class="code" href="struct__CloneTask.html">CloneTask</a> *
<a name="l00322"></a>00322 clone_task_new (<span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l00323"></a>00323                 <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id,
<a name="l00324"></a>00324                 <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_name,
<a name="l00325"></a>00325                 <span class="keyword">const</span> <span class="keywordtype">char</span> *token,
<a name="l00326"></a>00326                 <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree,
<a name="l00327"></a>00327                 <span class="keyword">const</span> <span class="keywordtype">char</span> *passwd,
<a name="l00328"></a>00328                 <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_addr,
<a name="l00329"></a>00329                 <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_port,
<a name="l00330"></a>00330                 <span class="keyword">const</span> <span class="keywordtype">char</span> *email)
<a name="l00331"></a>00331 {
<a name="l00332"></a>00332     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task = g_new0 (<a class="code" href="struct__CloneTask.html">CloneTask</a>, 1);
<a name="l00333"></a>00333 
<a name="l00334"></a>00334     memcpy (task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>, repo_id, 37);
<a name="l00335"></a>00335     memcpy (task-&gt;<a class="code" href="struct__CloneTask.html#a96fa052d9fc866a313ecad95b93a4197">peer_id</a>, peer_id, 41);
<a name="l00336"></a>00336     task-&gt;<a class="code" href="struct__CloneTask.html#a8e19296e76e4b3dec6b4dfcf4fab5342">token</a> = g_strdup (token);
<a name="l00337"></a>00337     task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a> = g_strdup(worktree);
<a name="l00338"></a>00338     task-&gt;<a class="code" href="struct__CloneTask.html#a42281f48e42f5e3766d31dfdca199bb1">peer_addr</a> = g_strdup(peer_addr);
<a name="l00339"></a>00339     task-&gt;<a class="code" href="struct__CloneTask.html#af6e520f57dd7b32106a88ebd42f3d5b1">peer_port</a> = g_strdup(peer_port);
<a name="l00340"></a>00340     task-&gt;<a class="code" href="struct__CloneTask.html#a4b875dabcf508a393d9bf8696c204dae">email</a> = g_strdup(email);
<a name="l00341"></a>00341     <span class="keywordflow">if</span> (repo_name)
<a name="l00342"></a>00342         task-&gt;<a class="code" href="struct__CloneTask.html#af4f2887a7ddd497587e0bfbe0d51018f">repo_name</a> = g_strdup(repo_name);
<a name="l00343"></a>00343     <span class="keywordflow">if</span> (passwd)
<a name="l00344"></a>00344         task-&gt;<a class="code" href="struct__CloneTask.html#a474148b59212fcf1716cc6b975593264">passwd</a> = g_strdup (passwd);
<a name="l00345"></a>00345 
<a name="l00346"></a>00346     <span class="keywordflow">return</span> task;
<a name="l00347"></a>00347 }
<a name="l00348"></a>00348 
<a name="l00349"></a>00349 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00350"></a>00350 clone_task_free (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task)
<a name="l00351"></a>00351 {
<a name="l00352"></a>00352     g_free (task-&gt;<a class="code" href="struct__CloneTask.html#a6ffe70c7ca5bbb71b617eecb53c0244f">tx_id</a>);
<a name="l00353"></a>00353     g_free (task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>);
<a name="l00354"></a>00354     g_free (task-&gt;<a class="code" href="struct__CloneTask.html#a474148b59212fcf1716cc6b975593264">passwd</a>);
<a name="l00355"></a>00355     g_free (task-&gt;<a class="code" href="struct__CloneTask.html#a8e19296e76e4b3dec6b4dfcf4fab5342">token</a>);
<a name="l00356"></a>00356     g_free (task-&gt;<a class="code" href="struct__CloneTask.html#af4f2887a7ddd497587e0bfbe0d51018f">repo_name</a>);
<a name="l00357"></a>00357     g_free (task-&gt;<a class="code" href="struct__CloneTask.html#a42281f48e42f5e3766d31dfdca199bb1">peer_addr</a>);
<a name="l00358"></a>00358     g_free (task-&gt;<a class="code" href="struct__CloneTask.html#af6e520f57dd7b32106a88ebd42f3d5b1">peer_port</a>);
<a name="l00359"></a>00359     g_free (task-&gt;<a class="code" href="struct__CloneTask.html#a4b875dabcf508a393d9bf8696c204dae">email</a>);
<a name="l00360"></a>00360     g_free (task-&gt;<a class="code" href="struct__CloneTask.html#aa75c409cf11d38d6d6753a53a416a94d">random_key</a>);
<a name="l00361"></a>00361     g_free (task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a>);
<a name="l00362"></a>00362 
<a name="l00363"></a>00363     g_free (task);
<a name="l00364"></a>00364 }
<a name="l00365"></a>00365 
<a name="l00366"></a>00366 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00367"></a><a class="code" href="clone-mgr_8h.html#a371fa00197a050e76f04061d410b0097">00367</a> <a class="code" href="clone-mgr_8c.html#a371fa00197a050e76f04061d410b0097">clone_task_state_to_str</a> (<span class="keywordtype">int</span> state)
<a name="l00368"></a>00368 {
<a name="l00369"></a>00369     <span class="keywordflow">if</span> (state &lt; 0 || state &gt;= <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8acca394d0558d1cd602cc71c51d572725">N_CLONE_STATES</a>)
<a name="l00370"></a>00370         <span class="keywordflow">return</span> NULL;
<a name="l00371"></a>00371     <span class="keywordflow">return</span> state_str[state];
<a name="l00372"></a>00372 }
<a name="l00373"></a>00373 
<a name="l00374"></a>00374 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00375"></a><a class="code" href="clone-mgr_8h.html#ad97feb27f9f5e662efea51d3297b1376">00375</a> <a class="code" href="clone-mgr_8c.html#ad97feb27f9f5e662efea51d3297b1376">clone_task_error_to_str</a> (<span class="keywordtype">int</span> error)
<a name="l00376"></a>00376 {
<a name="l00377"></a>00377     <span class="keywordflow">if</span> (error &lt; 0 || error &gt;= <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea5cc2e23ea05f81fca6b7aea2ccb6f780">N_CLONE_ERRORS</a>)
<a name="l00378"></a>00378         <span class="keywordflow">return</span> NULL;
<a name="l00379"></a>00379     <span class="keywordflow">return</span> error_str[error];
<a name="l00380"></a>00380 }
<a name="l00381"></a>00381 
<a name="l00382"></a>00382 <a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *
<a name="l00383"></a><a class="code" href="clone-mgr_8h.html#ae861dc0d625b2072ab3a0641a2aa6797">00383</a> <a class="code" href="clone-mgr_8c.html#af28bac46c2f7acc1fc6eef867db947e9">seaf_clone_manager_new</a> (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *<a class="code" href="cluster-mgr_8c.html#af241ba8540cd17c31a02b56c2aaa126c">session</a>)
<a name="l00384"></a>00384 {
<a name="l00385"></a>00385     <a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr = g_new0 (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a>, 1);
<a name="l00386"></a>00386 
<a name="l00387"></a>00387     <span class="keywordtype">char</span> *db_path = g_build_path (<span class="stringliteral">&quot;/&quot;</span>, session-&gt;<a class="code" href="struct__SeafileSession.html#ae4df188e5674e3e4b405f14d0ee1bf9f">seaf_dir</a>, <a class="code" href="clone-mgr_8c.html#a35f4ad46c9e15dc72ccb38574e0c62c6">CLONE_DB</a>, NULL);
<a name="l00388"></a>00388     <span class="keywordflow">if</span> (<a class="code" href="seafile_2lib_2db_8c.html#af6e9a0e79db923d4a7df37bc5588400a">sqlite_open_db</a> (db_path, &amp;mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#a58b6344d07f7bbaa4fbd81b570cfbe65">db</a>) &lt; 0) {
<a name="l00389"></a>00389         g_critical (<span class="stringliteral">&quot;[Clone mgr] Failed to open db\n&quot;</span>);
<a name="l00390"></a>00390         g_free (db_path);
<a name="l00391"></a>00391         g_free (mgr);
<a name="l00392"></a>00392         <span class="keywordflow">return</span> NULL;
<a name="l00393"></a>00393     }
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#a3ffe52698a800372c82b6d19215d5b82">seaf</a> = <a class="code" href="cluster-mgr_8c.html#af241ba8540cd17c31a02b56c2aaa126c">session</a>;
<a name="l00396"></a>00396     mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#ac27110eab926004781f02c7b5e4d0370">tasks</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
<a name="l00397"></a>00397                                         g_free, (GDestroyNotify)clone_task_free);
<a name="l00398"></a>00398     <span class="keywordflow">return</span> mgr;
<a name="l00399"></a>00399 }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401 <span class="keyword">static</span> gboolean
<a name="l00402"></a>00402 load_enc_info_cb (sqlite3_stmt *stmt, <span class="keywordtype">void</span> *data)
<a name="l00403"></a>00403 {
<a name="l00404"></a>00404     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task = data;
<a name="l00405"></a>00405     <span class="keywordtype">int</span> enc_version;
<a name="l00406"></a>00406     <span class="keyword">const</span> <span class="keywordtype">char</span> *random_key;
<a name="l00407"></a>00407 
<a name="l00408"></a>00408     enc_version = sqlite3_column_int (stmt, 0);
<a name="l00409"></a>00409     random_key = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)sqlite3_column_text (stmt, 1);
<a name="l00410"></a>00410 
<a name="l00411"></a>00411     task-&gt;<a class="code" href="struct__CloneTask.html#aeac6a9af6d9734c17efa7027e4661d55">enc_version</a> = enc_version;
<a name="l00412"></a>00412     task-&gt;<a class="code" href="struct__CloneTask.html#aa75c409cf11d38d6d6753a53a416a94d">random_key</a> = g_strdup (random_key);
<a name="l00413"></a>00413 
<a name="l00414"></a>00414     <span class="keywordflow">return</span> FALSE;
<a name="l00415"></a>00415 }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00418"></a>00418 load_clone_enc_info (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task)
<a name="l00419"></a>00419 {
<a name="l00420"></a>00420     <span class="keywordtype">char</span> sql[256];
<a name="l00421"></a>00421 
<a name="l00422"></a>00422     snprintf (sql, <span class="keyword">sizeof</span>(sql),
<a name="l00423"></a>00423               <span class="stringliteral">&quot;SELECT enc_version, random_key FROM CloneEncInfo WHERE repo_id=&#39;%s&#39;&quot;</span>,
<a name="l00424"></a>00424               task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>);
<a name="l00425"></a>00425 
<a name="l00426"></a>00426     <span class="keywordflow">if</span> (<a class="code" href="seafile_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (task-&gt;<a class="code" href="struct__CloneTask.html#a3028c18408cdca62d9f0cc68d03bd121">manager</a>-&gt;<a class="code" href="struct__SeafCloneManager.html#a58b6344d07f7bbaa4fbd81b570cfbe65">db</a>, sql,
<a name="l00427"></a>00427                                      load_enc_info_cb, task) &lt; 0)
<a name="l00428"></a>00428         <span class="keywordflow">return</span> -1;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430     <span class="keywordflow">return</span> 0;
<a name="l00431"></a>00431 }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433 <span class="keyword">static</span> gboolean
<a name="l00434"></a>00434 load_version_info_cb (sqlite3_stmt *stmt, <span class="keywordtype">void</span> *data)
<a name="l00435"></a>00435 {
<a name="l00436"></a>00436     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task = data;
<a name="l00437"></a>00437     <span class="keywordtype">int</span> repo_version;
<a name="l00438"></a>00438 
<a name="l00439"></a>00439     repo_version = sqlite3_column_int (stmt, 0);
<a name="l00440"></a>00440 
<a name="l00441"></a>00441     task-&gt;<a class="code" href="struct__CloneTask.html#af967b4a19b18b8dca0ad7c471ba98581">repo_version</a> = repo_version;
<a name="l00442"></a>00442 
<a name="l00443"></a>00443     <span class="keywordflow">return</span> FALSE;
<a name="l00444"></a>00444 }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00447"></a>00447 load_clone_repo_version_info (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task)
<a name="l00448"></a>00448 {
<a name="l00449"></a>00449     <span class="keywordtype">char</span> sql[256];
<a name="l00450"></a>00450 
<a name="l00451"></a>00451     snprintf (sql, <span class="keyword">sizeof</span>(sql),
<a name="l00452"></a>00452               <span class="stringliteral">&quot;SELECT repo_version FROM CloneVersionInfo WHERE repo_id=&#39;%s&#39;&quot;</span>,
<a name="l00453"></a>00453               task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>);
<a name="l00454"></a>00454 
<a name="l00455"></a>00455     <a class="code" href="seafile_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (task-&gt;<a class="code" href="struct__CloneTask.html#a3028c18408cdca62d9f0cc68d03bd121">manager</a>-&gt;<a class="code" href="struct__SeafCloneManager.html#a58b6344d07f7bbaa4fbd81b570cfbe65">db</a>, sql,
<a name="l00456"></a>00456                                  load_version_info_cb, task);
<a name="l00457"></a>00457 }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459 <span class="keyword">static</span> gboolean
<a name="l00460"></a>00460 load_more_info_cb (sqlite3_stmt *stmt, <span class="keywordtype">void</span> *data)
<a name="l00461"></a>00461 {
<a name="l00462"></a>00462     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task = data;
<a name="l00463"></a>00463     json_error_t jerror;
<a name="l00464"></a>00464     json_t *<span class="keywordtype">object</span> = NULL;
<a name="l00465"></a>00465     <span class="keyword">const</span> <span class="keywordtype">char</span> *more_info;
<a name="l00466"></a>00466 
<a name="l00467"></a>00467     more_info = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)sqlite3_column_text (stmt, 0);
<a name="l00468"></a>00468     <span class="keywordtype">object</span> = json_loads (more_info, 0, &amp;jerror);
<a name="l00469"></a>00469     <span class="keywordflow">if</span> (!<span class="keywordtype">object</span>) {
<a name="l00470"></a>00470         <span class="keywordflow">if</span> (jerror.text)
<a name="l00471"></a>00471             seaf_warning (<span class="stringliteral">&quot;Failed to load more sync info from json: %s.\n&quot;</span>, jerror.text);
<a name="l00472"></a>00472         <span class="keywordflow">else</span>
<a name="l00473"></a>00473             seaf_warning (<span class="stringliteral">&quot;Failed to load more sync info from json.\n&quot;</span>);
<a name="l00474"></a>00474 
<a name="l00475"></a>00475         <span class="keywordflow">return</span> FALSE;
<a name="l00476"></a>00476     }
<a name="l00477"></a>00477         
<a name="l00478"></a>00478     json_t *integer = json_object_get (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;is_readonly&quot;</span>);
<a name="l00479"></a>00479     task-&gt;<a class="code" href="struct__CloneTask.html#af9ee5390751896c41183f53735bb05bc">is_readonly</a> = json_integer_value (integer);
<a name="l00480"></a>00480     json_t *<span class="keywordtype">string</span> = json_object_get (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;server_url&quot;</span>);
<a name="l00481"></a>00481     <span class="keywordflow">if</span> (<span class="keywordtype">string</span>)
<a name="l00482"></a>00482         task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a> = g_strdup (json_string_value (<span class="keywordtype">string</span>));
<a name="l00483"></a>00483     json_decref (<span class="keywordtype">object</span>);
<a name="l00484"></a>00484 
<a name="l00485"></a>00485     <span class="keywordflow">return</span> FALSE;
<a name="l00486"></a>00486 }
<a name="l00487"></a>00487 
<a name="l00488"></a>00488 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00489"></a>00489 load_clone_more_info (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task)
<a name="l00490"></a>00490 {
<a name="l00491"></a>00491     <span class="keywordtype">char</span> sql[256];
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     snprintf (sql, <span class="keyword">sizeof</span>(sql),
<a name="l00494"></a>00494               <span class="stringliteral">&quot;SELECT more_info FROM CloneTasksMoreInfo WHERE repo_id=&#39;%s&#39;&quot;</span>,
<a name="l00495"></a>00495               task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>);
<a name="l00496"></a>00496 
<a name="l00497"></a>00497     <a class="code" href="seafile_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (task-&gt;<a class="code" href="struct__CloneTask.html#a3028c18408cdca62d9f0cc68d03bd121">manager</a>-&gt;<a class="code" href="struct__SeafCloneManager.html#a58b6344d07f7bbaa4fbd81b570cfbe65">db</a>, sql,
<a name="l00498"></a>00498                                  load_more_info_cb, task);
<a name="l00499"></a>00499 }
<a name="l00500"></a>00500 
<a name="l00501"></a>00501 <span class="keyword">static</span> gboolean
<a name="l00502"></a>00502 restart_task (sqlite3_stmt *stmt, <span class="keywordtype">void</span> *data)
<a name="l00503"></a>00503 {
<a name="l00504"></a>00504     <a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr = data;
<a name="l00505"></a>00505     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id, *repo_name, *token, *peer_id, *worktree, *passwd;
<a name="l00506"></a>00506     <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_addr, *peer_port, *email;
<a name="l00507"></a>00507     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task;
<a name="l00508"></a>00508     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l00509"></a>00509 
<a name="l00510"></a>00510     repo_id = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)sqlite3_column_text (stmt, 0);
<a name="l00511"></a>00511     repo_name = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)sqlite3_column_text (stmt, 1);
<a name="l00512"></a>00512     token = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)sqlite3_column_text (stmt, 2);
<a name="l00513"></a>00513     peer_id = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)sqlite3_column_text (stmt, 3);
<a name="l00514"></a>00514     worktree = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)sqlite3_column_text (stmt, 4);
<a name="l00515"></a>00515     passwd = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)sqlite3_column_text (stmt, 5);
<a name="l00516"></a>00516     peer_addr = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)sqlite3_column_text (stmt, 6);
<a name="l00517"></a>00517     peer_port = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)sqlite3_column_text (stmt, 7);
<a name="l00518"></a>00518     email = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)sqlite3_column_text (stmt, 8);
<a name="l00519"></a>00519 
<a name="l00520"></a>00520     task = clone_task_new (repo_id, peer_id, repo_name, 
<a name="l00521"></a>00521                            token, worktree, passwd,
<a name="l00522"></a>00522                            peer_addr, peer_port, email);
<a name="l00523"></a>00523     task-&gt;<a class="code" href="struct__CloneTask.html#a3028c18408cdca62d9f0cc68d03bd121">manager</a> = mgr;
<a name="l00524"></a>00524     <span class="comment">/* Default to 1. */</span>
<a name="l00525"></a>00525     task-&gt;<a class="code" href="struct__CloneTask.html#aeac6a9af6d9734c17efa7027e4661d55">enc_version</a> = 1;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527     <span class="keywordflow">if</span> (passwd &amp;&amp; load_clone_enc_info (task) &lt; 0) {
<a name="l00528"></a>00528         clone_task_free (task);
<a name="l00529"></a>00529         <span class="keywordflow">return</span> TRUE;
<a name="l00530"></a>00530     }
<a name="l00531"></a>00531 
<a name="l00532"></a>00532     task-&gt;<a class="code" href="struct__CloneTask.html#af967b4a19b18b8dca0ad7c471ba98581">repo_version</a> = 0;
<a name="l00533"></a>00533     load_clone_repo_version_info (task);
<a name="l00534"></a>00534 
<a name="l00535"></a>00535     load_clone_more_info (task);
<a name="l00536"></a>00536 
<a name="l00537"></a>00537     repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id);
<a name="l00538"></a>00538 
<a name="l00539"></a>00539     <span class="keywordflow">if</span> (repo != NULL &amp;&amp; repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a> != NULL) {
<a name="l00540"></a>00540         transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8af1c3a28143f803ec77f12421a745c80e">CLONE_STATE_DONE</a>);
<a name="l00541"></a>00541         <span class="keywordflow">return</span> TRUE;
<a name="l00542"></a>00542     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3df88d84e57f0b8508144a5ff151ed19">enable_http_sync</a> &amp;&amp; task-&gt;<a class="code" href="struct__CloneTask.html#af967b4a19b18b8dca0ad7c471ba98581">repo_version</a> &gt; 0 &amp;&amp; task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a>)
<a name="l00543"></a>00543         check_http_protocol (task);
<a name="l00544"></a>00544     <span class="keywordflow">else</span>
<a name="l00545"></a>00545         connect_non_http_server (task);
<a name="l00546"></a>00546 
<a name="l00547"></a>00547     g_hash_table_insert (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#ac27110eab926004781f02c7b5e4d0370">tasks</a>, g_strdup(task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>), task);
<a name="l00548"></a>00548 
<a name="l00549"></a>00549     <span class="keywordflow">return</span> TRUE;
<a name="l00550"></a>00550 }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 <span class="keywordtype">int</span>
<a name="l00553"></a><a class="code" href="clone-mgr_8h.html#ad7860d1243e7f8ee8e9d3b8e6c032378">00553</a> <a class="code" href="clone-mgr_8c.html#ad7860d1243e7f8ee8e9d3b8e6c032378">seaf_clone_manager_init</a> (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr)
<a name="l00554"></a>00554 {
<a name="l00555"></a>00555     <span class="keyword">const</span> <span class="keywordtype">char</span> *sql;
<a name="l00556"></a>00556 
<a name="l00557"></a>00557     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS CloneTasks &quot;</span>
<a name="l00558"></a>00558         <span class="stringliteral">&quot;(repo_id TEXT PRIMARY KEY, repo_name TEXT, &quot;</span>
<a name="l00559"></a>00559         <span class="stringliteral">&quot;token TEXT, dest_id TEXT,&quot;</span>
<a name="l00560"></a>00560         <span class="stringliteral">&quot;worktree_parent TEXT, passwd TEXT, &quot;</span>
<a name="l00561"></a>00561         <span class="stringliteral">&quot;server_addr TEXT, server_port TEXT, email TEXT);&quot;</span>;
<a name="l00562"></a>00562     <span class="keywordflow">if</span> (<a class="code" href="seafile_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#a58b6344d07f7bbaa4fbd81b570cfbe65">db</a>, sql) &lt; 0)
<a name="l00563"></a>00563         <span class="keywordflow">return</span> -1;
<a name="l00564"></a>00564 
<a name="l00565"></a>00565     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS CloneTasksMoreInfo &quot;</span>
<a name="l00566"></a>00566         <span class="stringliteral">&quot;(repo_id TEXT PRIMARY KEY, more_info TEXT);&quot;</span>;
<a name="l00567"></a>00567     <span class="keywordflow">if</span> (<a class="code" href="seafile_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#a58b6344d07f7bbaa4fbd81b570cfbe65">db</a>, sql) &lt; 0)
<a name="l00568"></a>00568         <span class="keywordflow">return</span> -1;
<a name="l00569"></a>00569 
<a name="l00570"></a>00570     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS CloneEncInfo &quot;</span>
<a name="l00571"></a>00571         <span class="stringliteral">&quot;(repo_id TEXT PRIMARY KEY, enc_version INTEGER, random_key TEXT);&quot;</span>;
<a name="l00572"></a>00572     <span class="keywordflow">if</span> (<a class="code" href="seafile_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#a58b6344d07f7bbaa4fbd81b570cfbe65">db</a>, sql) &lt; 0)
<a name="l00573"></a>00573         <span class="keywordflow">return</span> -1;
<a name="l00574"></a>00574 
<a name="l00575"></a>00575     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS CloneVersionInfo &quot;</span>
<a name="l00576"></a>00576         <span class="stringliteral">&quot;(repo_id TEXT PRIMARY KEY, repo_version INTEGER);&quot;</span>;
<a name="l00577"></a>00577     <span class="keywordflow">if</span> (<a class="code" href="seafile_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#a58b6344d07f7bbaa4fbd81b570cfbe65">db</a>, sql) &lt; 0)
<a name="l00578"></a>00578         <span class="keywordflow">return</span> -1;
<a name="l00579"></a>00579 
<a name="l00580"></a>00580     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS CloneServerURL &quot;</span>
<a name="l00581"></a>00581         <span class="stringliteral">&quot;(repo_id TEXT PRIMARY KEY, server_url TEXT);&quot;</span>;
<a name="l00582"></a>00582     <span class="keywordflow">if</span> (<a class="code" href="seafile_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#a58b6344d07f7bbaa4fbd81b570cfbe65">db</a>, sql) &lt; 0)
<a name="l00583"></a>00583         <span class="keywordflow">return</span> -1;
<a name="l00584"></a>00584 
<a name="l00585"></a>00585     <span class="keywordflow">return</span> 0;
<a name="l00586"></a>00586 }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00589"></a>00589 continue_task_when_peer_connected (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task)
<a name="l00590"></a>00590 {
<a name="l00591"></a>00591     <span class="keywordflow">if</span> (<a class="code" href="ccnet_8h.html#aaf2e8f3b63d6ad9fb1012b23d4e242b0">ccnet_peer_is_ready</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#add541d96cca483ad72ff56ad061d1d32">ccnetrpc_client</a>, task-&gt;<a class="code" href="struct__CloneTask.html#a96fa052d9fc866a313ecad95b93a4197">peer_id</a>))
<a name="l00592"></a>00592         start_check_protocol_proc (task-&gt;<a class="code" href="struct__CloneTask.html#a96fa052d9fc866a313ecad95b93a4197">peer_id</a>, task);
<a name="l00593"></a>00593 }
<a name="l00594"></a>00594 
<a name="l00595"></a>00595 <span class="keyword">static</span> <span class="keywordtype">int</span> check_connect_pulse (<span class="keywordtype">void</span> *vmanager)
<a name="l00596"></a>00596 {
<a name="l00597"></a>00597     <a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr = vmanager;
<a name="l00598"></a>00598     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task;
<a name="l00599"></a>00599     GHashTableIter iter;
<a name="l00600"></a>00600     gpointer key, value;
<a name="l00601"></a>00601 
<a name="l00602"></a>00602     g_hash_table_iter_init (&amp;iter, mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#ac27110eab926004781f02c7b5e4d0370">tasks</a>);
<a name="l00603"></a>00603     <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
<a name="l00604"></a>00604         task = value;
<a name="l00605"></a>00605         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> == <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8afd7df49789f27957a882d91822b78eff">CLONE_STATE_CONNECT</a>) {
<a name="l00606"></a>00606             continue_task_when_peer_connected (task);
<a name="l00607"></a>00607         }
<a name="l00608"></a>00608     }
<a name="l00609"></a>00609 
<a name="l00610"></a>00610     <span class="keywordflow">return</span> TRUE;
<a name="l00611"></a>00611 }
<a name="l00612"></a>00612 
<a name="l00613"></a>00613 <span class="keywordtype">int</span>
<a name="l00614"></a><a class="code" href="clone-mgr_8h.html#af1cec3356abdd2c8a92e8edc7ae79269">00614</a> <a class="code" href="clone-mgr_8c.html#af1cec3356abdd2c8a92e8edc7ae79269">seaf_clone_manager_start</a> (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr)
<a name="l00615"></a>00615 {
<a name="l00616"></a>00616     <a class="code" href="include_2ccnet_2proc-factory_8h.html#aa8eba73e6627b33e2cb2d91fd0ea9922">ccnet_proc_factory_register_processor</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>,
<a name="l00617"></a>00617                                            <span class="stringliteral">&quot;seafile-checkff&quot;</span>,
<a name="l00618"></a>00618                                            <a class="code" href="daemon_2processors_2checkff-proc_8h.html#a5fd38032a5f483b89c1c0a13b0477eff">SEAFILE_TYPE_CHECKFF_PROC</a>);
<a name="l00619"></a>00619 
<a name="l00620"></a>00620     mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#ad242e9e88dab10ffea500f6155816836">check_timer</a> = <a class="code" href="timer_8h.html#a68b6afb704a7f56b625ed78146691b7c">ccnet_timer_new</a> (check_connect_pulse, mgr,
<a name="l00621"></a>00621                                         <a class="code" href="clone-mgr_8c.html#a50841e5a1d701383bf3b5c0302545d9b">CHECK_CONNECT_INTERVAL</a> * 1000);
<a name="l00622"></a>00622 
<a name="l00623"></a>00623     <span class="keywordtype">char</span> *sql = <span class="stringliteral">&quot;SELECT * FROM CloneTasks&quot;</span>;
<a name="l00624"></a>00624     <span class="keywordflow">if</span> (<a class="code" href="seafile_2lib_2db_8c.html#a17cffec15ffa34446ad00f950eab6fe2">sqlite_foreach_selected_row</a> (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#a58b6344d07f7bbaa4fbd81b570cfbe65">db</a>, sql, restart_task, mgr) &lt; 0)
<a name="l00625"></a>00625         <span class="keywordflow">return</span> -1;
<a name="l00626"></a>00626 
<a name="l00627"></a>00627     g_signal_connect (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>, <span class="stringliteral">&quot;repo-fetched&quot;</span>,
<a name="l00628"></a>00628                       (GCallback)on_repo_fetched, mgr);
<a name="l00629"></a>00629     g_signal_connect (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>, <span class="stringliteral">&quot;repo-http-fetched&quot;</span>,
<a name="l00630"></a>00630                       (GCallback)on_repo_http_fetched, mgr);
<a name="l00631"></a>00631 
<a name="l00632"></a>00632     <span class="keywordflow">return</span> 0;
<a name="l00633"></a>00633 }
<a name="l00634"></a>00634 
<a name="l00635"></a>00635 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00636"></a>00636 save_task_to_db (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr, <a class="code" href="struct__CloneTask.html">CloneTask</a> *task)
<a name="l00637"></a>00637 {
<a name="l00638"></a>00638     <span class="keywordtype">char</span> *sql;
<a name="l00639"></a>00639 
<a name="l00640"></a>00640     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#a474148b59212fcf1716cc6b975593264">passwd</a>)
<a name="l00641"></a>00641         sql = sqlite3_mprintf (<span class="stringliteral">&quot;REPLACE INTO CloneTasks VALUES &quot;</span>
<a name="l00642"></a>00642             <span class="stringliteral">&quot;(&#39;%q&#39;, &#39;%q&#39;, &#39;%q&#39;, &#39;%q&#39;, &#39;%q&#39;, &#39;%q&#39;, &#39;%q&#39;, &#39;%q&#39;, &#39;%q&#39;)&quot;</span>,
<a name="l00643"></a>00643                                 task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>, task-&gt;<a class="code" href="struct__CloneTask.html#af4f2887a7ddd497587e0bfbe0d51018f">repo_name</a>,
<a name="l00644"></a>00644                                 task-&gt;<a class="code" href="struct__CloneTask.html#a8e19296e76e4b3dec6b4dfcf4fab5342">token</a>, task-&gt;<a class="code" href="struct__CloneTask.html#a96fa052d9fc866a313ecad95b93a4197">peer_id</a>,
<a name="l00645"></a>00645                                 task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>, task-&gt;<a class="code" href="struct__CloneTask.html#a474148b59212fcf1716cc6b975593264">passwd</a>,
<a name="l00646"></a>00646                                 task-&gt;<a class="code" href="struct__CloneTask.html#a42281f48e42f5e3766d31dfdca199bb1">peer_addr</a>, task-&gt;<a class="code" href="struct__CloneTask.html#af6e520f57dd7b32106a88ebd42f3d5b1">peer_port</a>, task-&gt;<a class="code" href="struct__CloneTask.html#a4b875dabcf508a393d9bf8696c204dae">email</a>);
<a name="l00647"></a>00647     <span class="keywordflow">else</span>
<a name="l00648"></a>00648         sql = sqlite3_mprintf (<span class="stringliteral">&quot;REPLACE INTO CloneTasks VALUES &quot;</span>
<a name="l00649"></a>00649             <span class="stringliteral">&quot;(&#39;%q&#39;, &#39;%q&#39;, &#39;%q&#39;, &#39;%q&#39;, &#39;%q&#39;, NULL, &#39;%q&#39;, &#39;%q&#39;, &#39;%q&#39;)&quot;</span>,
<a name="l00650"></a>00650                                 task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>, task-&gt;<a class="code" href="struct__CloneTask.html#af4f2887a7ddd497587e0bfbe0d51018f">repo_name</a>,
<a name="l00651"></a>00651                                 task-&gt;<a class="code" href="struct__CloneTask.html#a8e19296e76e4b3dec6b4dfcf4fab5342">token</a>, task-&gt;<a class="code" href="struct__CloneTask.html#a96fa052d9fc866a313ecad95b93a4197">peer_id</a>,
<a name="l00652"></a>00652                                 task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>, task-&gt;<a class="code" href="struct__CloneTask.html#a42281f48e42f5e3766d31dfdca199bb1">peer_addr</a>,
<a name="l00653"></a>00653                                 task-&gt;<a class="code" href="struct__CloneTask.html#af6e520f57dd7b32106a88ebd42f3d5b1">peer_port</a>, task-&gt;<a class="code" href="struct__CloneTask.html#a4b875dabcf508a393d9bf8696c204dae">email</a>);
<a name="l00654"></a>00654 
<a name="l00655"></a>00655     <span class="keywordflow">if</span> (<a class="code" href="seafile_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#a58b6344d07f7bbaa4fbd81b570cfbe65">db</a>, sql) &lt; 0) {
<a name="l00656"></a>00656         sqlite3_free (sql);
<a name="l00657"></a>00657         <span class="keywordflow">return</span> -1;
<a name="l00658"></a>00658     }
<a name="l00659"></a>00659     sqlite3_free (sql);
<a name="l00660"></a>00660 
<a name="l00661"></a>00661     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#a474148b59212fcf1716cc6b975593264">passwd</a> &amp;&amp; task-&gt;<a class="code" href="struct__CloneTask.html#aeac6a9af6d9734c17efa7027e4661d55">enc_version</a> == 2 &amp;&amp; task-&gt;<a class="code" href="struct__CloneTask.html#aa75c409cf11d38d6d6753a53a416a94d">random_key</a>) {
<a name="l00662"></a>00662         sql = sqlite3_mprintf (<span class="stringliteral">&quot;REPLACE INTO CloneEncInfo VALUES &quot;</span>
<a name="l00663"></a>00663                                <span class="stringliteral">&quot;(&#39;%q&#39;, %d, &#39;%q&#39;)&quot;</span>,
<a name="l00664"></a>00664                                task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>, task-&gt;<a class="code" href="struct__CloneTask.html#aeac6a9af6d9734c17efa7027e4661d55">enc_version</a>, task-&gt;<a class="code" href="struct__CloneTask.html#aa75c409cf11d38d6d6753a53a416a94d">random_key</a>);
<a name="l00665"></a>00665         <span class="keywordflow">if</span> (<a class="code" href="seafile_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#a58b6344d07f7bbaa4fbd81b570cfbe65">db</a>, sql) &lt; 0) {
<a name="l00666"></a>00666             sqlite3_free (sql);
<a name="l00667"></a>00667             <span class="keywordflow">return</span> -1;
<a name="l00668"></a>00668         }
<a name="l00669"></a>00669         sqlite3_free (sql);
<a name="l00670"></a>00670     }
<a name="l00671"></a>00671 
<a name="l00672"></a>00672     sql = sqlite3_mprintf (<span class="stringliteral">&quot;REPLACE INTO CloneVersionInfo VALUES &quot;</span>
<a name="l00673"></a>00673                            <span class="stringliteral">&quot;(&#39;%q&#39;, %d)&quot;</span>,
<a name="l00674"></a>00674                            task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>, task-&gt;<a class="code" href="struct__CloneTask.html#af967b4a19b18b8dca0ad7c471ba98581">repo_version</a>);
<a name="l00675"></a>00675     <span class="keywordflow">if</span> (<a class="code" href="seafile_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#a58b6344d07f7bbaa4fbd81b570cfbe65">db</a>, sql) &lt; 0) {
<a name="l00676"></a>00676         sqlite3_free (sql);
<a name="l00677"></a>00677         <span class="keywordflow">return</span> -1;
<a name="l00678"></a>00678     }
<a name="l00679"></a>00679     sqlite3_free (sql);
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#af9ee5390751896c41183f53735bb05bc">is_readonly</a> || task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a>) {
<a name="l00682"></a>00682         <span class="comment">/* need to store more info */</span>
<a name="l00683"></a>00683         json_t *<span class="keywordtype">object</span> = NULL;
<a name="l00684"></a>00684         gchar *info = NULL;
<a name="l00685"></a>00685 
<a name="l00686"></a>00686         <span class="keywordtype">object</span> = json_object ();
<a name="l00687"></a>00687         json_object_set_new (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;is_readonly&quot;</span>, json_integer (task-&gt;<a class="code" href="struct__CloneTask.html#af9ee5390751896c41183f53735bb05bc">is_readonly</a>));
<a name="l00688"></a>00688         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a>)
<a name="l00689"></a>00689             json_object_set_new (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;server_url&quot;</span>, json_string(task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a>));
<a name="l00690"></a>00690     
<a name="l00691"></a>00691         info = json_dumps (<span class="keywordtype">object</span>, 0);
<a name="l00692"></a>00692         json_decref (<span class="keywordtype">object</span>);
<a name="l00693"></a>00693         sql = sqlite3_mprintf (<span class="stringliteral">&quot;REPLACE INTO CloneTasksMoreInfo VALUES &quot;</span>
<a name="l00694"></a>00694                            <span class="stringliteral">&quot;(&#39;%q&#39;, &#39;%q&#39;)&quot;</span>, task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>, info);
<a name="l00695"></a>00695         <span class="keywordflow">if</span> (<a class="code" href="seafile_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#a58b6344d07f7bbaa4fbd81b570cfbe65">db</a>, sql) &lt; 0) {
<a name="l00696"></a>00696             sqlite3_free (sql);
<a name="l00697"></a>00697             g_free (info);
<a name="l00698"></a>00698             <span class="keywordflow">return</span> -1;
<a name="l00699"></a>00699         }
<a name="l00700"></a>00700         sqlite3_free (sql);
<a name="l00701"></a>00701         g_free (info);
<a name="l00702"></a>00702     }
<a name="l00703"></a>00703 
<a name="l00704"></a>00704     <span class="keywordflow">return</span> 0;
<a name="l00705"></a>00705 }
<a name="l00706"></a>00706 
<a name="l00707"></a>00707 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00708"></a>00708 remove_task_from_db (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr, <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l00709"></a>00709 {
<a name="l00710"></a>00710     <span class="keywordtype">char</span> sql[256];
<a name="l00711"></a>00711 
<a name="l00712"></a>00712     snprintf (sql, <span class="keyword">sizeof</span>(sql), 
<a name="l00713"></a>00713               <span class="stringliteral">&quot;DELETE FROM CloneTasks WHERE repo_id=&#39;%s&#39;&quot;</span>,
<a name="l00714"></a>00714               repo_id);
<a name="l00715"></a>00715     <span class="keywordflow">if</span> (<a class="code" href="seafile_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#a58b6344d07f7bbaa4fbd81b570cfbe65">db</a>, sql) &lt; 0)
<a name="l00716"></a>00716         <span class="keywordflow">return</span> -1;
<a name="l00717"></a>00717 
<a name="l00718"></a>00718     snprintf (sql, <span class="keyword">sizeof</span>(sql), 
<a name="l00719"></a>00719               <span class="stringliteral">&quot;DELETE FROM CloneEncInfo WHERE repo_id=&#39;%s&#39;&quot;</span>,
<a name="l00720"></a>00720               repo_id);
<a name="l00721"></a>00721     <span class="keywordflow">if</span> (<a class="code" href="seafile_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#a58b6344d07f7bbaa4fbd81b570cfbe65">db</a>, sql) &lt; 0)
<a name="l00722"></a>00722         <span class="keywordflow">return</span> -1;
<a name="l00723"></a>00723 
<a name="l00724"></a>00724     snprintf (sql, <span class="keyword">sizeof</span>(sql), 
<a name="l00725"></a>00725               <span class="stringliteral">&quot;DELETE FROM CloneVersionInfo WHERE repo_id=&#39;%s&#39;&quot;</span>,
<a name="l00726"></a>00726               repo_id);
<a name="l00727"></a>00727     <span class="keywordflow">if</span> (<a class="code" href="seafile_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#a58b6344d07f7bbaa4fbd81b570cfbe65">db</a>, sql) &lt; 0)
<a name="l00728"></a>00728         <span class="keywordflow">return</span> -1;
<a name="l00729"></a>00729 
<a name="l00730"></a>00730     snprintf (sql, <span class="keyword">sizeof</span>(sql), 
<a name="l00731"></a>00731               <span class="stringliteral">&quot;DELETE FROM CloneTasksMoreInfo WHERE repo_id=&#39;%s&#39;&quot;</span>,
<a name="l00732"></a>00732               repo_id);
<a name="l00733"></a>00733     <span class="keywordflow">if</span> (<a class="code" href="seafile_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#a58b6344d07f7bbaa4fbd81b570cfbe65">db</a>, sql) &lt; 0)
<a name="l00734"></a>00734         <span class="keywordflow">return</span> -1;
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     <span class="keywordflow">return</span> 0;
<a name="l00737"></a>00737 }
<a name="l00738"></a>00738 
<a name="l00739"></a>00739 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00740"></a>00740 transition_state (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task, <span class="keywordtype">int</span> new_state)
<a name="l00741"></a>00741 {
<a name="l00742"></a>00742     seaf_message (<span class="stringliteral">&quot;Transition clone state for %.8s from [%s] to [%s].\n&quot;</span>,
<a name="l00743"></a>00743                   task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>,
<a name="l00744"></a>00744                   state_str[task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a>], state_str[new_state]);
<a name="l00745"></a>00745 
<a name="l00746"></a>00746     <span class="keywordflow">if</span> (new_state == <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8af1c3a28143f803ec77f12421a745c80e">CLONE_STATE_DONE</a> ||
<a name="l00747"></a>00747         new_state == <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8aed32a49a21c225e3aa62f83b837e2e33">CLONE_STATE_ERROR</a> ||
<a name="l00748"></a>00748         new_state == <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a5b171455c76672ef5f3808bbc9267cc3">CLONE_STATE_CANCELED</a>) {
<a name="l00749"></a>00749         <span class="comment">/* Remove from db but leave in memory. */</span>
<a name="l00750"></a>00750         remove_task_from_db (task-&gt;<a class="code" href="struct__CloneTask.html#a3028c18408cdca62d9f0cc68d03bd121">manager</a>, task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>);
<a name="l00751"></a>00751     }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753     task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> = new_state;
<a name="l00754"></a>00754 }
<a name="l00755"></a>00755 
<a name="l00756"></a>00756 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00757"></a>00757 transition_to_error (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task, <span class="keywordtype">int</span> error)
<a name="l00758"></a>00758 {
<a name="l00759"></a>00759     seaf_message (<span class="stringliteral">&quot;Transition clone state for %.8s from [%s] to [error]: %s.\n&quot;</span>,
<a name="l00760"></a>00760                   task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>,
<a name="l00761"></a>00761                   state_str[task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a>], 
<a name="l00762"></a>00762                   error_str[error]);
<a name="l00763"></a>00763 
<a name="l00764"></a>00764     <span class="comment">/* Remove from db but leave in memory. */</span>
<a name="l00765"></a>00765     remove_task_from_db (task-&gt;<a class="code" href="struct__CloneTask.html#a3028c18408cdca62d9f0cc68d03bd121">manager</a>, task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>);
<a name="l00766"></a>00766 
<a name="l00767"></a>00767     task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> = <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8aed32a49a21c225e3aa62f83b837e2e33">CLONE_STATE_ERROR</a>;
<a name="l00768"></a>00768     task-&gt;<a class="code" href="struct__CloneTask.html#a548b9ed6700d5a29ac2b1211a8e79d9e">error</a> = error;
<a name="l00769"></a>00769 }
<a name="l00770"></a>00770 
<a name="l00771"></a>00771 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00772"></a>00772 add_transfer_task (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task, GError **error)
<a name="l00773"></a>00773 {
<a name="l00774"></a>00774     <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__CloneTask.html#ae9ed3b204a7c4364ef44b16a7056ccd1">http_sync</a>) {
<a name="l00775"></a>00775         task-&gt;<a class="code" href="struct__CloneTask.html#a6ffe70c7ca5bbb71b617eecb53c0244f">tx_id</a> = <a class="code" href="transfer-mgr_8c.html#a7c1421651b69da119fab63e9f1d5bf55">seaf_transfer_manager_add_download</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa04a8214ef989d1e5d68799dc19cbf22">transfer_mgr</a>,
<a name="l00776"></a>00776                                                           task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>,
<a name="l00777"></a>00777                                                           task-&gt;<a class="code" href="struct__CloneTask.html#af967b4a19b18b8dca0ad7c471ba98581">repo_version</a>,
<a name="l00778"></a>00778                                                           task-&gt;<a class="code" href="struct__CloneTask.html#a96fa052d9fc866a313ecad95b93a4197">peer_id</a>,
<a name="l00779"></a>00779                                                           <span class="stringliteral">&quot;fetch_head&quot;</span>,
<a name="l00780"></a>00780                                                           <span class="stringliteral">&quot;master&quot;</span>,
<a name="l00781"></a>00781                                                           task-&gt;<a class="code" href="struct__CloneTask.html#a8e19296e76e4b3dec6b4dfcf4fab5342">token</a>,
<a name="l00782"></a>00782                                                           task-&gt;<a class="code" href="struct__CloneTask.html#a3ed371dcb52612faf91b1ff4501a8f66">server_side_merge</a>,
<a name="l00783"></a>00783                                                           task-&gt;<a class="code" href="struct__CloneTask.html#a474148b59212fcf1716cc6b975593264">passwd</a>,
<a name="l00784"></a>00784                                                           task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>,
<a name="l00785"></a>00785                                                           error);
<a name="l00786"></a>00786         <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__CloneTask.html#a6ffe70c7ca5bbb71b617eecb53c0244f">tx_id</a>)
<a name="l00787"></a>00787             <span class="keywordflow">return</span> -1;
<a name="l00788"></a>00788     } <span class="keywordflow">else</span> {
<a name="l00789"></a>00789         <span class="keywordtype">int</span> ret = <a class="code" href="http-tx-mgr_8c.html#a0bd2d454a6270528980a22372d300ddb">http_tx_manager_add_download</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>,
<a name="l00790"></a>00790                                                 task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>,
<a name="l00791"></a>00791                                                 task-&gt;<a class="code" href="struct__CloneTask.html#af967b4a19b18b8dca0ad7c471ba98581">repo_version</a>,
<a name="l00792"></a>00792                                                 task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a>,
<a name="l00793"></a>00793                                                 task-&gt;<a class="code" href="struct__CloneTask.html#a8e19296e76e4b3dec6b4dfcf4fab5342">token</a>,
<a name="l00794"></a>00794                                                 task-&gt;<a class="code" href="struct__CloneTask.html#acbccf574778b2c3241d627352a657eda">server_head_id</a>,
<a name="l00795"></a>00795                                                 TRUE,
<a name="l00796"></a>00796                                                 task-&gt;<a class="code" href="struct__CloneTask.html#a474148b59212fcf1716cc6b975593264">passwd</a>,
<a name="l00797"></a>00797                                                 task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>,
<a name="l00798"></a>00798                                                 task-&gt;<a class="code" href="struct__CloneTask.html#a287b2603a5596a4f3a5cf94fb8c745e8">http_protocol_version</a>,
<a name="l00799"></a>00799                                                 error);
<a name="l00800"></a>00800         <span class="keywordflow">if</span> (ret &lt; 0)
<a name="l00801"></a>00801             <span class="keywordflow">return</span> -1;
<a name="l00802"></a>00802         task-&gt;<a class="code" href="struct__CloneTask.html#a6ffe70c7ca5bbb71b617eecb53c0244f">tx_id</a> = g_strdup(task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>);
<a name="l00803"></a>00803     }
<a name="l00804"></a>00804 
<a name="l00805"></a>00805     <span class="keywordflow">return</span> 0;
<a name="l00806"></a>00806 }
<a name="l00807"></a>00807 
<a name="l00808"></a><a class="code" href="structIndexAux.html">00808</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00809"></a><a class="code" href="structIndexAux.html#a2e8f18933b64010c6ae719ce7df328ff">00809</a>     <a class="code" href="struct__CloneTask.html">CloneTask</a> *<a class="code" href="structIndexAux.html#a2e8f18933b64010c6ae719ce7df328ff">task</a>;
<a name="l00810"></a><a class="code" href="structIndexAux.html#a3cf2ed4b8d7f4ad1db98dbe5344a16c4">00810</a>     gboolean <a class="code" href="structIndexAux.html#a3cf2ed4b8d7f4ad1db98dbe5344a16c4">success</a>;
<a name="l00811"></a>00811 } <a class="code" href="structIndexAux.html">IndexAux</a>;
<a name="l00812"></a>00812 
<a name="l00813"></a>00813 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l00814"></a>00814 index_files_job (<span class="keywordtype">void</span> *data)
<a name="l00815"></a>00815 {
<a name="l00816"></a>00816     <a class="code" href="structIndexAux.html">IndexAux</a> *aux = data;
<a name="l00817"></a>00817     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task = aux-&gt;<a class="code" href="structIndexAux.html#a2e8f18933b64010c6ae719ce7df328ff">task</a>;
<a name="l00818"></a>00818 
<a name="l00819"></a>00819     <span class="keywordflow">if</span> (<a class="code" href="daemon_2repo-mgr_8c.html#aadbf4eb74b53f6423e7eabf716f5f4fb">seaf_repo_index_worktree_files</a> (task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>, task-&gt;<a class="code" href="struct__CloneTask.html#af967b4a19b18b8dca0ad7c471ba98581">repo_version</a>,
<a name="l00820"></a>00820                                         task-&gt;<a class="code" href="struct__CloneTask.html#a4b875dabcf508a393d9bf8696c204dae">email</a>,
<a name="l00821"></a>00821                                         task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>,
<a name="l00822"></a>00822                                         task-&gt;<a class="code" href="struct__CloneTask.html#a474148b59212fcf1716cc6b975593264">passwd</a>, task-&gt;<a class="code" href="struct__CloneTask.html#aeac6a9af6d9734c17efa7027e4661d55">enc_version</a>,
<a name="l00823"></a>00823                                         task-&gt;<a class="code" href="struct__CloneTask.html#aa75c409cf11d38d6d6753a53a416a94d">random_key</a>,
<a name="l00824"></a>00824                                         task-&gt;<a class="code" href="struct__CloneTask.html#ababd2533c456b735b93e76d0b7eac4dc">root_id</a>) == 0)
<a name="l00825"></a>00825         aux-&gt;<a class="code" href="structIndexAux.html#a3cf2ed4b8d7f4ad1db98dbe5344a16c4">success</a> = TRUE;
<a name="l00826"></a>00826 
<a name="l00827"></a>00827     <span class="keywordflow">return</span> data;
<a name="l00828"></a>00828 }
<a name="l00829"></a>00829 
<a name="l00830"></a>00830 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00831"></a>00831 index_files_done (<span class="keywordtype">void</span> *result)
<a name="l00832"></a>00832 {
<a name="l00833"></a>00833     <a class="code" href="structIndexAux.html">IndexAux</a> *aux = result;
<a name="l00834"></a>00834     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task = aux-&gt;<a class="code" href="structIndexAux.html#a2e8f18933b64010c6ae719ce7df328ff">task</a>;
<a name="l00835"></a>00835 
<a name="l00836"></a>00836     <span class="keywordflow">if</span> (!aux-&gt;<a class="code" href="structIndexAux.html#a3cf2ed4b8d7f4ad1db98dbe5344a16c4">success</a>) {
<a name="l00837"></a>00837         transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea51bf1541a0bc7170d828ae4457e516d3">CLONE_ERROR_INDEX</a>);
<a name="l00838"></a>00838         <span class="keywordflow">goto</span> out;
<a name="l00839"></a>00839     }
<a name="l00840"></a>00840 
<a name="l00841"></a>00841     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> == <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a7c3d6e2ad24a7e0f2adf534a42b235bc">CLONE_STATE_CANCEL_PENDING</a>) {
<a name="l00842"></a>00842         transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a5b171455c76672ef5f3808bbc9267cc3">CLONE_STATE_CANCELED</a>);
<a name="l00843"></a>00843         <span class="keywordflow">goto</span> out;
<a name="l00844"></a>00844     }
<a name="l00845"></a>00845 
<a name="l00846"></a>00846     <span class="keywordflow">if</span> (add_transfer_task (task, NULL) &lt; 0) {
<a name="l00847"></a>00847         transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea970814942feca38b0d4dbced3393be65">CLONE_ERROR_FETCH</a>);
<a name="l00848"></a>00848         <span class="keywordflow">goto</span> out;
<a name="l00849"></a>00849     }
<a name="l00850"></a>00850 
<a name="l00851"></a>00851     transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8ae67f39ebed40e85b2d90de1f3119edca">CLONE_STATE_FETCH</a>);
<a name="l00852"></a>00852 
<a name="l00853"></a>00853 out:
<a name="l00854"></a>00854     g_free (aux);
<a name="l00855"></a>00855     <span class="keywordflow">return</span>;
<a name="l00856"></a>00856 }
<a name="l00857"></a>00857 
<a name="l00858"></a>00858 <span class="preprocessor">#ifndef WIN32</span>
<a name="l00859"></a>00859 <span class="preprocessor"></span>
<a name="l00860"></a>00860 <span class="keyword">static</span> gboolean
<a name="l00861"></a>00861 is_non_empty_directory (<span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l00862"></a>00862 {
<a name="l00863"></a>00863     GDir *dir;
<a name="l00864"></a>00864     GError *error = NULL;
<a name="l00865"></a>00865     gboolean ret = FALSE;
<a name="l00866"></a>00866 
<a name="l00867"></a>00867     dir = g_dir_open (path, 0, &amp;error);
<a name="l00868"></a>00868     <span class="keywordflow">if</span> (dir != NULL &amp;&amp; g_dir_read_name (dir) != NULL)
<a name="l00869"></a>00869         ret = TRUE;
<a name="l00870"></a>00870     <span class="keywordflow">if</span> (dir)
<a name="l00871"></a>00871         g_dir_close (dir);
<a name="l00872"></a>00872 
<a name="l00873"></a>00873     <span class="keywordflow">return</span> ret;
<a name="l00874"></a>00874 }
<a name="l00875"></a>00875 
<a name="l00876"></a>00876 <span class="preprocessor">#else</span>
<a name="l00877"></a>00877 <span class="preprocessor"></span>
<a name="l00878"></a>00878 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00879"></a>00879 check_empty_cb (<span class="keywordtype">wchar_t</span> *parent, <span class="keywordtype">wchar_t</span> *dname, <span class="keywordtype">void</span> *user_data, gboolean *stop)
<a name="l00880"></a>00880 {
<a name="l00881"></a>00881     gboolean *res = user_data;
<a name="l00882"></a>00882 
<a name="l00883"></a>00883     *res = TRUE;
<a name="l00884"></a>00884     *stop = TRUE;
<a name="l00885"></a>00885 
<a name="l00886"></a>00886     <span class="keywordflow">return</span> 0;
<a name="l00887"></a>00887 }
<a name="l00888"></a>00888 
<a name="l00889"></a>00889 <span class="keyword">static</span> gboolean
<a name="l00890"></a>00890 is_non_empty_directory (<span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l00891"></a>00891 {
<a name="l00892"></a>00892     <span class="keywordtype">wchar_t</span> *wpath = win32_long_path (path);
<a name="l00893"></a>00893     gboolean ret = FALSE;
<a name="l00894"></a>00894 
<a name="l00895"></a>00895     traverse_directory_win32 (wpath, check_empty_cb, &amp;ret);
<a name="l00896"></a>00896 
<a name="l00897"></a>00897     <span class="keywordflow">return</span> ret;
<a name="l00898"></a>00898 }
<a name="l00899"></a>00899 
<a name="l00900"></a>00900 <span class="preprocessor">#endif  </span><span class="comment">/* WIN32 */</span>
<a name="l00901"></a>00901 
<a name="l00902"></a>00902 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00903"></a>00903 start_index_or_transfer (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr, <a class="code" href="struct__CloneTask.html">CloneTask</a> *task, GError **error)
<a name="l00904"></a>00904 {
<a name="l00905"></a>00905     <a class="code" href="structIndexAux.html">IndexAux</a> *aux;
<a name="l00906"></a>00906     <span class="keywordtype">int</span> ret = 0;
<a name="l00907"></a>00907 
<a name="l00908"></a>00908     <span class="keywordflow">if</span> (is_non_empty_directory (task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>)) {
<a name="l00909"></a>00909         transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8aae34ed29b33feeb3d64a3e5efe2d8ff0">CLONE_STATE_INDEX</a>);
<a name="l00910"></a>00910 
<a name="l00911"></a>00911         aux = g_new0 (<a class="code" href="structIndexAux.html">IndexAux</a>, 1);
<a name="l00912"></a>00912         aux-&gt;<a class="code" href="structIndexAux.html#a2e8f18933b64010c6ae719ce7df328ff">task</a> = task;
<a name="l00913"></a>00913 
<a name="l00914"></a>00914         <a class="code" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768">ccnet_job_manager_schedule_job</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#abcbb9886e315abb16c620ce49808a0b2">job_mgr</a>,
<a name="l00915"></a>00915                                         index_files_job,
<a name="l00916"></a>00916                                         index_files_done,
<a name="l00917"></a>00917                                         aux);
<a name="l00918"></a>00918     } <span class="keywordflow">else</span> {
<a name="l00919"></a>00919         ret = add_transfer_task (task, error);
<a name="l00920"></a>00920         <span class="keywordflow">if</span> (ret == 0)
<a name="l00921"></a>00921             transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8ae67f39ebed40e85b2d90de1f3119edca">CLONE_STATE_FETCH</a>);
<a name="l00922"></a>00922         <span class="keywordflow">else</span>
<a name="l00923"></a>00923             transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea970814942feca38b0d4dbced3393be65">CLONE_ERROR_FETCH</a>);
<a name="l00924"></a>00924     }
<a name="l00925"></a>00925 
<a name="l00926"></a>00926     <span class="keywordflow">return</span> ret;
<a name="l00927"></a>00927 }
<a name="l00928"></a>00928 
<a name="l00929"></a>00929 <span class="keyword">static</span> gboolean
<a name="l00930"></a>00930 is_duplicate_task (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr, <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l00931"></a>00931 {
<a name="l00932"></a>00932     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task = g_hash_table_lookup (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#ac27110eab926004781f02c7b5e4d0370">tasks</a>, repo_id);
<a name="l00933"></a>00933     <span class="keywordflow">if</span> (task != NULL &amp;&amp;
<a name="l00934"></a>00934         task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> != <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8af1c3a28143f803ec77f12421a745c80e">CLONE_STATE_DONE</a> &amp;&amp;
<a name="l00935"></a>00935         task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> != <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8aed32a49a21c225e3aa62f83b837e2e33">CLONE_STATE_ERROR</a> &amp;&amp;
<a name="l00936"></a>00936         task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> != <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a5b171455c76672ef5f3808bbc9267cc3">CLONE_STATE_CANCELED</a>)
<a name="l00937"></a>00937         <span class="keywordflow">return</span> TRUE;
<a name="l00938"></a>00938     <span class="keywordflow">return</span> FALSE;
<a name="l00939"></a>00939 }
<a name="l00940"></a>00940 
<a name="l00941"></a>00941 <span class="keyword">static</span> gboolean
<a name="l00942"></a>00942 is_worktree_of_repo (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr, <span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l00943"></a>00943 {
<a name="l00944"></a>00944     GList *repos, *ptr;
<a name="l00945"></a>00945     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l00946"></a>00946     GHashTableIter iter;
<a name="l00947"></a>00947     gpointer key, value;
<a name="l00948"></a>00948     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task;
<a name="l00949"></a>00949 
<a name="l00950"></a>00950     repos = <a class="code" href="daemon_2repo-mgr_8c.html#a5fe41fb7382995f3f335e408ba4ddb30">seaf_repo_manager_get_repo_list</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, -1, -1);
<a name="l00951"></a>00951     <span class="keywordflow">for</span> (ptr = repos; ptr != NULL; ptr = ptr-&gt;next) {
<a name="l00952"></a>00952         repo = ptr-&gt;data;
<a name="l00953"></a>00953         <span class="keywordflow">if</span> (g_strcmp0 (path, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>) == 0) {
<a name="l00954"></a>00954             g_list_free (repos);
<a name="l00955"></a>00955             <span class="keywordflow">return</span> TRUE;
<a name="l00956"></a>00956         }
<a name="l00957"></a>00957     }
<a name="l00958"></a>00958     g_list_free (repos);
<a name="l00959"></a>00959 
<a name="l00960"></a>00960     g_hash_table_iter_init (&amp;iter, mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#ac27110eab926004781f02c7b5e4d0370">tasks</a>);
<a name="l00961"></a>00961     <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
<a name="l00962"></a>00962         task = value;
<a name="l00963"></a>00963         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> == <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8af1c3a28143f803ec77f12421a745c80e">CLONE_STATE_DONE</a> ||
<a name="l00964"></a>00964             task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> == <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8aed32a49a21c225e3aa62f83b837e2e33">CLONE_STATE_ERROR</a> ||
<a name="l00965"></a>00965             task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> == <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a5b171455c76672ef5f3808bbc9267cc3">CLONE_STATE_CANCELED</a>)
<a name="l00966"></a>00966             <span class="keywordflow">continue</span>;
<a name="l00967"></a>00967         <span class="keywordflow">if</span> (g_strcmp0 (path, task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>) == 0)
<a name="l00968"></a>00968             <span class="keywordflow">return</span> TRUE;
<a name="l00969"></a>00969     }
<a name="l00970"></a>00970 
<a name="l00971"></a>00971     <span class="keywordflow">return</span> FALSE;
<a name="l00972"></a>00972 }
<a name="l00973"></a>00973 
<a name="l00974"></a>00974 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l00975"></a>00975 try_worktree (<span class="keyword">const</span> <span class="keywordtype">char</span> *worktree)
<a name="l00976"></a>00976 {
<a name="l00977"></a>00977     <span class="keywordtype">char</span> *tmp;
<a name="l00978"></a>00978     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cnt;
<a name="l00979"></a>00979 
<a name="l00980"></a>00980     <span class="comment">/* There is a repo name conflict, so we try to add a postfix */</span>
<a name="l00981"></a>00981     cnt = 1;
<a name="l00982"></a>00982     <span class="keywordflow">while</span> (1) {
<a name="l00983"></a>00983         tmp = g_strdup_printf(<span class="stringliteral">&quot;%s-%d&quot;</span>, worktree, cnt++);
<a name="l00984"></a>00984         <span class="keywordflow">if</span> (g_access(tmp, F_OK) &lt; 0) {
<a name="l00985"></a>00985             <span class="keywordflow">return</span> tmp;
<a name="l00986"></a>00986         }
<a name="l00987"></a>00987 
<a name="l00988"></a>00988         <span class="keywordflow">if</span> (cnt == -1U) {
<a name="l00989"></a>00989             <span class="comment">/* we have tried too much times, so give up */</span>
<a name="l00990"></a>00990             g_free(tmp);
<a name="l00991"></a>00991             <span class="keywordflow">return</span> NULL;
<a name="l00992"></a>00992         }
<a name="l00993"></a>00993 
<a name="l00994"></a>00994         g_free(tmp);
<a name="l00995"></a>00995     }
<a name="l00996"></a>00996 
<a name="l00997"></a>00997     <span class="comment">/* XXX: never reach here */</span>
<a name="l00998"></a>00998 }
<a name="l00999"></a>00999 
<a name="l01000"></a>01000 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l01001"></a>01001 remove_trail_slash (<span class="keywordtype">char</span> *path)
<a name="l01002"></a>01002 {
<a name="l01003"></a>01003     <span class="keywordtype">int</span> tail = strlen (path) - 1;
<a name="l01004"></a>01004     <span class="keywordflow">while</span> (tail &gt;= 0 &amp;&amp; (path[tail] == <span class="charliteral">&#39;/&#39;</span> || path[tail] == <span class="charliteral">&#39;\\&#39;</span>))
<a name="l01005"></a>01005         path[tail--] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l01006"></a>01006 }
<a name="l01007"></a>01007 
<a name="l01008"></a>01008 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l01009"></a>01009 make_worktree (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr,
<a name="l01010"></a>01010                <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree,
<a name="l01011"></a>01011                gboolean dry_run,
<a name="l01012"></a>01012                GError **error)
<a name="l01013"></a>01013 {
<a name="l01014"></a>01014     <span class="keywordtype">char</span> *wt = g_strdup (worktree);
<a name="l01015"></a>01015     <a class="code" href="seafile_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l01016"></a>01016     <span class="keywordtype">int</span> rc;
<a name="l01017"></a>01017     <span class="keywordtype">char</span> *ret;
<a name="l01018"></a>01018 
<a name="l01019"></a>01019     remove_trail_slash (wt);
<a name="l01020"></a>01020 
<a name="l01021"></a>01021     rc = <a class="code" href="seafile_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (wt, &amp;st);
<a name="l01022"></a>01022     <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01023"></a>01023         ret = wt;
<a name="l01024"></a>01024         <span class="keywordflow">return</span> ret;
<a name="l01025"></a>01025     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!S_ISDIR(st.st_mode)) {
<a name="l01026"></a>01026         <span class="keywordflow">if</span> (!dry_run) {
<a name="l01027"></a>01027             g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l01028"></a>01028                          <span class="stringliteral">&quot;Invalid local directory&quot;</span>);
<a name="l01029"></a>01029             g_free (wt);
<a name="l01030"></a>01030             <span class="keywordflow">return</span> NULL;
<a name="l01031"></a>01031         }
<a name="l01032"></a>01032         ret = try_worktree (wt);
<a name="l01033"></a>01033         g_free (wt);
<a name="l01034"></a>01034         <span class="keywordflow">return</span> ret;
<a name="l01035"></a>01035     }
<a name="l01036"></a>01036 
<a name="l01037"></a>01037     <span class="comment">/* OK, wt is an existing dir. Let&#39;s see if it&#39;s the worktree for</span>
<a name="l01038"></a>01038 <span class="comment">     * another repo. */</span>
<a name="l01039"></a>01039     <span class="keywordflow">if</span> (is_worktree_of_repo (mgr, wt)) {
<a name="l01040"></a>01040         <span class="keywordflow">if</span> (!dry_run) {
<a name="l01041"></a>01041             g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l01042"></a>01042                          <span class="stringliteral">&quot;Already in sync&quot;</span>);
<a name="l01043"></a>01043             g_free (wt);
<a name="l01044"></a>01044             <span class="keywordflow">return</span> NULL;
<a name="l01045"></a>01045         }
<a name="l01046"></a>01046         ret = try_worktree (wt);
<a name="l01047"></a>01047         g_free (wt);
<a name="l01048"></a>01048     } <span class="keywordflow">else</span> {
<a name="l01049"></a>01049         <span class="keywordflow">return</span> wt;
<a name="l01050"></a>01050     }
<a name="l01051"></a>01051 
<a name="l01052"></a>01052     <span class="keywordflow">return</span> ret;
<a name="l01053"></a>01053 }
<a name="l01054"></a>01054 
<a name="l01055"></a>01055 <span class="comment">/*</span>
<a name="l01056"></a>01056 <span class="comment"> * Generate a conflict-free path to be used as worktree.</span>
<a name="l01057"></a>01057 <span class="comment"> * This worktree path can be used as the @worktree parameter</span>
<a name="l01058"></a>01058 <span class="comment"> * for seaf_clone_manager_add_task().</span>
<a name="l01059"></a>01059 <span class="comment"> */</span>
<a name="l01060"></a>01060 <span class="keywordtype">char</span> *
<a name="l01061"></a><a class="code" href="clone-mgr_8h.html#aaac97c14f78e703fd118de5bea1745e6">01061</a> <a class="code" href="clone-mgr_8c.html#aaac97c14f78e703fd118de5bea1745e6">seaf_clone_manager_gen_default_worktree</a> (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr,
<a name="l01062"></a>01062                                          <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree_parent,
<a name="l01063"></a>01063                                          <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_name)
<a name="l01064"></a>01064 {
<a name="l01065"></a>01065     <span class="keywordtype">char</span> *wt = g_build_filename (worktree_parent, repo_name, NULL);
<a name="l01066"></a>01066     <span class="keywordtype">char</span> *worktree;
<a name="l01067"></a>01067 
<a name="l01068"></a>01068     worktree = make_worktree (mgr, wt, TRUE, NULL);
<a name="l01069"></a>01069     <span class="keywordflow">if</span> (!worktree)
<a name="l01070"></a>01070         <span class="keywordflow">return</span> wt;
<a name="l01071"></a>01071 
<a name="l01072"></a>01072     g_free (wt);
<a name="l01073"></a>01073     <span class="keywordflow">return</span> worktree;
<a name="l01074"></a>01074 }
<a name="l01075"></a>01075 
<a name="l01076"></a>01076 <span class="keyword">inline</span> <span class="keyword">static</span> gboolean is_separator (<span class="keywordtype">char</span> c)
<a name="l01077"></a>01077 {
<a name="l01078"></a>01078     <span class="keywordflow">return</span> (c == <span class="charliteral">&#39;/&#39;</span> || c == <span class="charliteral">&#39;\\&#39;</span>);
<a name="l01079"></a>01079 }
<a name="l01080"></a>01080 
<a name="l01081"></a>01081 <span class="comment">/*</span>
<a name="l01082"></a>01082 <span class="comment"> * Returns &lt; 0 if dira includes dirb or dira == dirb;</span>
<a name="l01083"></a>01083 <span class="comment"> * Returns 0 if no inclusive relationship;</span>
<a name="l01084"></a>01084 <span class="comment"> * Returns &gt; 0 if dirb includes dira.</span>
<a name="l01085"></a>01085 <span class="comment"> */</span>
<a name="l01086"></a>01086 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01087"></a>01087 check_dir_inclusiveness (<span class="keyword">const</span> <span class="keywordtype">char</span> *dira, <span class="keyword">const</span> <span class="keywordtype">char</span> *dirb)
<a name="l01088"></a>01088 {
<a name="l01089"></a>01089     <span class="keywordtype">char</span> *a, *b;
<a name="l01090"></a>01090     <span class="keywordtype">char</span> *p1, *p2;
<a name="l01091"></a>01091     <span class="keywordtype">int</span> ret = 0;
<a name="l01092"></a>01092 
<a name="l01093"></a>01093     a = g_strdup(dira);
<a name="l01094"></a>01094     b = g_strdup(dirb);
<a name="l01095"></a>01095     remove_trail_slash (a);
<a name="l01096"></a>01096     remove_trail_slash (b);
<a name="l01097"></a>01097 
<a name="l01098"></a>01098     p1 = a;
<a name="l01099"></a>01099     p2 = b;
<a name="l01100"></a>01100     <span class="keywordflow">while</span> (*p1 != 0 &amp;&amp; *p2 != 0) {
<a name="l01101"></a>01101         <span class="comment">/* Go to the last one in a path separator sequence. */</span>
<a name="l01102"></a>01102         <span class="keywordflow">while</span> (is_separator(*p1) &amp;&amp; is_separator(p1[1]))
<a name="l01103"></a>01103             ++p1;
<a name="l01104"></a>01104         <span class="keywordflow">while</span> (is_separator(*p2) &amp;&amp; is_separator(p2[1]))
<a name="l01105"></a>01105             ++p2;
<a name="l01106"></a>01106 
<a name="l01107"></a>01107         <span class="keywordflow">if</span> (!(is_separator(*p1) &amp;&amp; is_separator(*p2)) &amp;&amp; *p1 != *p2)
<a name="l01108"></a>01108             <span class="keywordflow">goto</span> out;
<a name="l01109"></a>01109 
<a name="l01110"></a>01110         ++p1;
<a name="l01111"></a>01111         ++p2;
<a name="l01112"></a>01112     }
<a name="l01113"></a>01113 
<a name="l01114"></a>01114     <span class="comment">/* Example:</span>
<a name="l01115"></a>01115 <span class="comment">     *            p1</span>
<a name="l01116"></a>01116 <span class="comment">     * a: /abc/def/ghi</span>
<a name="l01117"></a>01117 <span class="comment">     *            p2</span>
<a name="l01118"></a>01118 <span class="comment">     * b: /abc/def</span>
<a name="l01119"></a>01119 <span class="comment">     */</span>
<a name="l01120"></a>01120     <span class="keywordflow">if</span> (*p1 == 0 &amp;&amp; *p2 == 0)
<a name="l01121"></a>01121         ret = -1;
<a name="l01122"></a>01122     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*p1 != 0 &amp;&amp; is_separator(*p1))
<a name="l01123"></a>01123         ret = 1;
<a name="l01124"></a>01124     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*p2 != 0 &amp;&amp; is_separator(*p2))
<a name="l01125"></a>01125         ret = -1;
<a name="l01126"></a>01126 
<a name="l01127"></a>01127 out:
<a name="l01128"></a>01128     g_free (a);
<a name="l01129"></a>01129     g_free (b);
<a name="l01130"></a>01130     <span class="keywordflow">return</span> ret;
<a name="l01131"></a>01131 }
<a name="l01132"></a>01132 
<a name="l01133"></a>01133 gboolean
<a name="l01134"></a><a class="code" href="clone-mgr_8h.html#a45fe95b1bbe19ee533a8f9e57884658e">01134</a> <a class="code" href="clone-mgr_8c.html#a45fe95b1bbe19ee533a8f9e57884658e">seaf_clone_manager_check_worktree_path</a> (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr, <span class="keyword">const</span> <span class="keywordtype">char</span> *path, GError **error)
<a name="l01135"></a>01135 {
<a name="l01136"></a>01136     GList *repos, *ptr;
<a name="l01137"></a>01137     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l01138"></a>01138     GHashTableIter iter;
<a name="l01139"></a>01139     gpointer key, value;
<a name="l01140"></a>01140     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task;
<a name="l01141"></a>01141 
<a name="l01142"></a>01142     <span class="keywordflow">if</span> (check_dir_inclusiveness (path, <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ae4df188e5674e3e4b405f14d0ee1bf9f">seaf_dir</a>) != 0 ||
<a name="l01143"></a>01143         <span class="comment">/* It&#39;s OK if path is included by the default worktree parent. */</span>
<a name="l01144"></a>01144         check_dir_inclusiveness (path, <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a1675cecb3e52d94845f2ae1b28fd011a">worktree_dir</a>) &lt; 0 ||
<a name="l01145"></a>01145         check_dir_inclusiveness (path, <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a3cef20728e78352e5fe1819b692ed8e3">config_dir</a>) != 0) {
<a name="l01146"></a>01146         seaf_warning (<span class="stringliteral">&quot;Worktree path conflicts with seafile system path.\n&quot;</span>);
<a name="l01147"></a>01147         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l01148"></a>01148                      <span class="stringliteral">&quot;Worktree conflicts system path&quot;</span>);
<a name="l01149"></a>01149         <span class="keywordflow">return</span> FALSE;
<a name="l01150"></a>01150     }
<a name="l01151"></a>01151 
<a name="l01152"></a>01152     repos = <a class="code" href="daemon_2repo-mgr_8c.html#a5fe41fb7382995f3f335e408ba4ddb30">seaf_repo_manager_get_repo_list</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, -1, -1);
<a name="l01153"></a>01153     <span class="keywordflow">for</span> (ptr = repos; ptr != NULL; ptr = ptr-&gt;next) {
<a name="l01154"></a>01154         repo = ptr-&gt;data;
<a name="l01155"></a>01155         <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a> != NULL &amp;&amp;
<a name="l01156"></a>01156             check_dir_inclusiveness (path, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>) != 0) {
<a name="l01157"></a>01157             seaf_warning (<span class="stringliteral">&quot;Worktree path conflict with repo %s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>);
<a name="l01158"></a>01158             g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l01159"></a>01159                          <span class="stringliteral">&quot;Worktree conflicts existing repo&quot;</span>);
<a name="l01160"></a>01160             g_list_free (repos);
<a name="l01161"></a>01161             <span class="keywordflow">return</span> FALSE;
<a name="l01162"></a>01162         }
<a name="l01163"></a>01163     }
<a name="l01164"></a>01164     g_list_free (repos);
<a name="l01165"></a>01165 
<a name="l01166"></a>01166     g_hash_table_iter_init (&amp;iter, mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#ac27110eab926004781f02c7b5e4d0370">tasks</a>);
<a name="l01167"></a>01167     <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
<a name="l01168"></a>01168         task = value;
<a name="l01169"></a>01169         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> == <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8af1c3a28143f803ec77f12421a745c80e">CLONE_STATE_DONE</a> ||
<a name="l01170"></a>01170             task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> == <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8aed32a49a21c225e3aa62f83b837e2e33">CLONE_STATE_ERROR</a> ||
<a name="l01171"></a>01171             task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> == <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a5b171455c76672ef5f3808bbc9267cc3">CLONE_STATE_CANCELED</a>)
<a name="l01172"></a>01172             <span class="keywordflow">continue</span>;
<a name="l01173"></a>01173         <span class="keywordflow">if</span> (check_dir_inclusiveness (path, task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>) != 0) {
<a name="l01174"></a>01174             seaf_warning (<span class="stringliteral">&quot;Worktree path conflict with clone %.8s.\n&quot;</span>,
<a name="l01175"></a>01175                           task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>);
<a name="l01176"></a>01176             g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l01177"></a>01177                          <span class="stringliteral">&quot;Worktree conflicts existing repo&quot;</span>);
<a name="l01178"></a>01178             <span class="keywordflow">return</span> FALSE;
<a name="l01179"></a>01179         }
<a name="l01180"></a>01180     }
<a name="l01181"></a>01181 
<a name="l01182"></a>01182     <span class="keywordflow">return</span> TRUE;
<a name="l01183"></a>01183 }
<a name="l01184"></a>01184 
<a name="l01185"></a>01185 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l01186"></a>01186 canonical_server_url (<span class="keyword">const</span> <span class="keywordtype">char</span> *url_in)
<a name="l01187"></a>01187 {
<a name="l01188"></a>01188     <span class="keywordtype">char</span> *url = g_strdup(url_in);
<a name="l01189"></a>01189     <span class="keywordtype">int</span> len = strlen(url);
<a name="l01190"></a>01190 
<a name="l01191"></a>01191     <span class="keywordflow">if</span> (url[len - 1] == <span class="charliteral">&#39;/&#39;</span>)
<a name="l01192"></a>01192         url[len - 1] = 0;
<a name="l01193"></a>01193 
<a name="l01194"></a>01194     <span class="keywordflow">return</span> url;
<a name="l01195"></a>01195 }
<a name="l01196"></a>01196 
<a name="l01197"></a>01197 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l01198"></a>01198 add_task_common (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr, 
<a name="l01199"></a>01199                  <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l01200"></a>01200                  <span class="keywordtype">int</span> repo_version,
<a name="l01201"></a>01201                  <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id,
<a name="l01202"></a>01202                  <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_name,
<a name="l01203"></a>01203                  <span class="keyword">const</span> <span class="keywordtype">char</span> *token,
<a name="l01204"></a>01204                  <span class="keyword">const</span> <span class="keywordtype">char</span> *passwd,
<a name="l01205"></a>01205                  <span class="keywordtype">int</span> enc_version,
<a name="l01206"></a>01206                  <span class="keyword">const</span> <span class="keywordtype">char</span> *random_key,
<a name="l01207"></a>01207                  <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree,
<a name="l01208"></a>01208                  <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_addr,
<a name="l01209"></a>01209                  <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_port,
<a name="l01210"></a>01210                  <span class="keyword">const</span> <span class="keywordtype">char</span> *email,
<a name="l01211"></a>01211                  <span class="keyword">const</span> <span class="keywordtype">char</span> *more_info,
<a name="l01212"></a>01212                  GError **error)
<a name="l01213"></a>01213 {
<a name="l01214"></a>01214     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task;
<a name="l01215"></a>01215 
<a name="l01216"></a>01216     task = clone_task_new (repo_id, peer_id, repo_name,
<a name="l01217"></a>01217                            token, worktree, passwd,
<a name="l01218"></a>01218                            peer_addr, peer_port, email);
<a name="l01219"></a>01219     task-&gt;<a class="code" href="struct__CloneTask.html#a3028c18408cdca62d9f0cc68d03bd121">manager</a> = mgr;
<a name="l01220"></a>01220     task-&gt;<a class="code" href="struct__CloneTask.html#aeac6a9af6d9734c17efa7027e4661d55">enc_version</a> = enc_version;
<a name="l01221"></a>01221     task-&gt;<a class="code" href="struct__CloneTask.html#aa75c409cf11d38d6d6753a53a416a94d">random_key</a> = g_strdup (random_key);
<a name="l01222"></a>01222     task-&gt;<a class="code" href="struct__CloneTask.html#af967b4a19b18b8dca0ad7c471ba98581">repo_version</a> = repo_version;
<a name="l01223"></a>01223     <span class="keywordflow">if</span> (more_info) {
<a name="l01224"></a>01224         json_error_t jerror;
<a name="l01225"></a>01225         json_t *<span class="keywordtype">object</span> = NULL;
<a name="l01226"></a>01226 
<a name="l01227"></a>01227         <span class="keywordtype">object</span> = json_loads (more_info, 0, &amp;jerror);
<a name="l01228"></a>01228         <span class="keywordflow">if</span> (!<span class="keywordtype">object</span>) {
<a name="l01229"></a>01229             <span class="keywordflow">if</span> (jerror.text)
<a name="l01230"></a>01230                 seaf_warning (<span class="stringliteral">&quot;Failed to load more sync info from json: %s.\n&quot;</span>, jerror.text);
<a name="l01231"></a>01231             <span class="keywordflow">else</span>
<a name="l01232"></a>01232                 seaf_warning (<span class="stringliteral">&quot;Failed to load more sync info from json.\n&quot;</span>);
<a name="l01233"></a>01233 
<a name="l01234"></a>01234             clone_task_free (task);
<a name="l01235"></a>01235             <span class="keywordflow">return</span> NULL;
<a name="l01236"></a>01236         }
<a name="l01237"></a>01237         
<a name="l01238"></a>01238         json_t *integer = json_object_get (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;is_readonly&quot;</span>);
<a name="l01239"></a>01239         task-&gt;<a class="code" href="struct__CloneTask.html#af9ee5390751896c41183f53735bb05bc">is_readonly</a> = json_integer_value (integer);
<a name="l01240"></a>01240         json_t *<span class="keywordtype">string</span> = json_object_get (<span class="keywordtype">object</span>, <span class="stringliteral">&quot;server_url&quot;</span>);
<a name="l01241"></a>01241         <span class="keywordflow">if</span> (<span class="keywordtype">string</span>)
<a name="l01242"></a>01242             task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a> = canonical_server_url (json_string_value (<span class="keywordtype">string</span>));
<a name="l01243"></a>01243         json_decref (<span class="keywordtype">object</span>);
<a name="l01244"></a>01244     }
<a name="l01245"></a>01245 
<a name="l01246"></a>01246     <span class="keywordflow">if</span> (save_task_to_db (mgr, task) &lt; 0) {
<a name="l01247"></a>01247         seaf_warning (<span class="stringliteral">&quot;[Clone mgr] failed to save task.\n&quot;</span>);
<a name="l01248"></a>01248         clone_task_free (task);
<a name="l01249"></a>01249         <span class="keywordflow">return</span> NULL;
<a name="l01250"></a>01250     }
<a name="l01251"></a>01251 
<a name="l01252"></a>01252     <span class="keywordflow">if</span> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3df88d84e57f0b8508144a5ff151ed19">enable_http_sync</a> &amp;&amp; task-&gt;<a class="code" href="struct__CloneTask.html#af967b4a19b18b8dca0ad7c471ba98581">repo_version</a> &gt; 0 &amp;&amp; task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a>)
<a name="l01253"></a>01253         check_http_protocol (task);
<a name="l01254"></a>01254     <span class="keywordflow">else</span>
<a name="l01255"></a>01255         connect_non_http_server (task);
<a name="l01256"></a>01256 
<a name="l01257"></a>01257     <span class="comment">/* The old task for this repo will be freed. */</span>
<a name="l01258"></a>01258     g_hash_table_insert (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#ac27110eab926004781f02c7b5e4d0370">tasks</a>, g_strdup(task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>), task);
<a name="l01259"></a>01259 
<a name="l01260"></a>01260     <span class="keywordflow">return</span> g_strdup(repo_id);
<a name="l01261"></a>01261 }
<a name="l01262"></a>01262 
<a name="l01263"></a>01263 <span class="keyword">static</span> gboolean
<a name="l01264"></a>01264 check_encryption_args (<span class="keyword">const</span> <span class="keywordtype">char</span> *magic, <span class="keywordtype">int</span> enc_version, <span class="keyword">const</span> <span class="keywordtype">char</span> *random_key,
<a name="l01265"></a>01265                        GError **error)
<a name="l01266"></a>01266 {
<a name="l01267"></a>01267     <span class="keywordflow">if</span> (!magic) {
<a name="l01268"></a>01268         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
<a name="l01269"></a>01269                      <span class="stringliteral">&quot;Magic must be specified&quot;</span>);
<a name="l01270"></a>01270         <span class="keywordflow">return</span> FALSE;
<a name="l01271"></a>01271     }
<a name="l01272"></a>01272 
<a name="l01273"></a>01273     <span class="keywordflow">if</span> (enc_version != 1 &amp;&amp; enc_version != 2) {
<a name="l01274"></a>01274         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
<a name="l01275"></a>01275                      <span class="stringliteral">&quot;Unsupported enc version&quot;</span>);
<a name="l01276"></a>01276         <span class="keywordflow">return</span> FALSE;
<a name="l01277"></a>01277     }
<a name="l01278"></a>01278 
<a name="l01279"></a>01279     <span class="keywordflow">if</span> (enc_version == 2) {
<a name="l01280"></a>01280         <span class="keywordflow">if</span> (!random_key || strlen(random_key) != 96) {
<a name="l01281"></a>01281             g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
<a name="l01282"></a>01282                          <span class="stringliteral">&quot;Random key not specified&quot;</span>);
<a name="l01283"></a>01283             <span class="keywordflow">return</span> FALSE;
<a name="l01284"></a>01284         }
<a name="l01285"></a>01285     }
<a name="l01286"></a>01286 
<a name="l01287"></a>01287     <span class="keywordflow">return</span> TRUE;
<a name="l01288"></a>01288 }
<a name="l01289"></a>01289 
<a name="l01290"></a>01290 <span class="keywordtype">char</span> *
<a name="l01291"></a><a class="code" href="clone-mgr_8h.html#a6b3ef937f8308db69c87bb650cb42fe9">01291</a> <a class="code" href="clone-mgr_8c.html#a06b26730e317a268b3127067ee545307">seaf_clone_manager_add_task</a> (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr, 
<a name="l01292"></a>01292                              <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l01293"></a>01293                              <span class="keywordtype">int</span> repo_version,
<a name="l01294"></a>01294                              <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id,
<a name="l01295"></a>01295                              <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_name,
<a name="l01296"></a>01296                              <span class="keyword">const</span> <span class="keywordtype">char</span> *token,
<a name="l01297"></a>01297                              <span class="keyword">const</span> <span class="keywordtype">char</span> *passwd,
<a name="l01298"></a>01298                              <span class="keyword">const</span> <span class="keywordtype">char</span> *magic,
<a name="l01299"></a>01299                              <span class="keywordtype">int</span> enc_version,
<a name="l01300"></a>01300                              <span class="keyword">const</span> <span class="keywordtype">char</span> *random_key,
<a name="l01301"></a>01301                              <span class="keyword">const</span> <span class="keywordtype">char</span> *worktree_in,
<a name="l01302"></a>01302                              <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_addr,
<a name="l01303"></a>01303                              <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_port,
<a name="l01304"></a>01304                              <span class="keyword">const</span> <span class="keywordtype">char</span> *email,
<a name="l01305"></a>01305                              <span class="keyword">const</span> <span class="keywordtype">char</span> *more_info,
<a name="l01306"></a>01306                              GError **error)
<a name="l01307"></a>01307 {
<a name="l01308"></a>01308     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l01309"></a>01309     <span class="keywordtype">char</span> *worktree;
<a name="l01310"></a>01310     <span class="keywordtype">char</span> *ret;
<a name="l01311"></a>01311 
<a name="l01312"></a>01312     <span class="keywordflow">if</span> (!<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a5432788378b921624977855244c63a85">started</a>) {
<a name="l01313"></a>01313         seaf_message (<span class="stringliteral">&quot;System not started, skip adding clone task.\n&quot;</span>);
<a name="l01314"></a>01314         <span class="keywordflow">return</span> NULL;
<a name="l01315"></a>01315     }
<a name="l01316"></a>01316 
<a name="l01317"></a>01317     <span class="keywordflow">if</span> (passwd &amp;&amp;
<a name="l01318"></a>01318         !check_encryption_args (magic, enc_version, random_key, error))
<a name="l01319"></a>01319         <span class="keywordflow">return</span> NULL;
<a name="l01320"></a>01320 
<a name="l01321"></a>01321     <span class="comment">/* After a repo was unsynced, the sync task may still be blocked in the</span>
<a name="l01322"></a>01322 <span class="comment">     * network, so the repo is not actually deleted yet.</span>
<a name="l01323"></a>01323 <span class="comment">     * In this case just return an error to the user.</span>
<a name="l01324"></a>01324 <span class="comment">     */</span>
<a name="l01325"></a>01325     <a class="code" href="struct__SyncInfo.html">SyncInfo</a> *sync_info = <a class="code" href="sync-mgr_8c.html#afb758dbde64ac4505ad259f95601d45e">seaf_sync_manager_get_sync_info</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a6b2a5e1e723955885f9fb27c5f064df4">sync_mgr</a>,
<a name="l01326"></a>01326                                                            repo_id);
<a name="l01327"></a>01327     <span class="keywordflow">if</span> (sync_info &amp;&amp; sync_info-&gt;<a class="code" href="struct__SyncInfo.html#ad0f77a2b8e799b3a0abc417fce88843a">in_sync</a>) {
<a name="l01328"></a>01328         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l01329"></a>01329                      <span class="stringliteral">&quot;Repo already exists&quot;</span>);
<a name="l01330"></a>01330         <span class="keywordflow">return</span> NULL;
<a name="l01331"></a>01331     }
<a name="l01332"></a>01332 
<a name="l01333"></a>01333     repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id);
<a name="l01334"></a>01334 
<a name="l01335"></a>01335     <span class="keywordflow">if</span> (repo != NULL &amp;&amp; repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a> != NULL) {
<a name="l01336"></a>01336         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l01337"></a>01337                      <span class="stringliteral">&quot;Repo already exists&quot;</span>);
<a name="l01338"></a>01338         <span class="keywordflow">return</span> NULL;
<a name="l01339"></a>01339     }   
<a name="l01340"></a>01340 
<a name="l01341"></a>01341     <span class="keywordflow">if</span> (is_duplicate_task (mgr, repo_id)) {
<a name="l01342"></a>01342         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, 
<a name="l01343"></a>01343                      <span class="stringliteral">&quot;Task is already in progress&quot;</span>);
<a name="l01344"></a>01344         <span class="keywordflow">return</span> NULL;
<a name="l01345"></a>01345     }
<a name="l01346"></a>01346 
<a name="l01347"></a>01347     <span class="keywordflow">if</span> (passwd &amp;&amp;
<a name="l01348"></a>01348         <a class="code" href="seafile-crypt_8c.html#a9ada7f42f1f31b91dabdc5edde6b73f9">seafile_verify_repo_passwd</a>(repo_id, passwd, magic, enc_version) &lt; 0) {
<a name="l01349"></a>01349         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l01350"></a>01350                      <span class="stringliteral">&quot;Incorrect password&quot;</span>);
<a name="l01351"></a>01351         <span class="keywordflow">return</span> NULL;
<a name="l01352"></a>01352     }
<a name="l01353"></a>01353 
<a name="l01354"></a>01354     <span class="keywordflow">if</span> (!<a class="code" href="clone-mgr_8c.html#a45fe95b1bbe19ee533a8f9e57884658e">seaf_clone_manager_check_worktree_path</a> (mgr, worktree_in, error))
<a name="l01355"></a>01355         <span class="keywordflow">return</span> NULL;
<a name="l01356"></a>01356 
<a name="l01357"></a>01357     <span class="comment">/* Return error if worktree_in conflicts with another repo or</span>
<a name="l01358"></a>01358 <span class="comment">     * is not a directory.</span>
<a name="l01359"></a>01359 <span class="comment">     */</span>
<a name="l01360"></a>01360     worktree = make_worktree (mgr, worktree_in, FALSE, error);
<a name="l01361"></a>01361     <span class="keywordflow">if</span> (!worktree) {
<a name="l01362"></a>01362         <span class="keywordflow">return</span> NULL;
<a name="l01363"></a>01363     }
<a name="l01364"></a>01364 
<a name="l01365"></a>01365     <span class="comment">/* If a repo was unsynced and then downloaded again, there may be</span>
<a name="l01366"></a>01366 <span class="comment">     * a garbage record for this repo. We don&#39;t want the downloaded blocks</span>
<a name="l01367"></a>01367 <span class="comment">     * be removed by GC.</span>
<a name="l01368"></a>01368 <span class="comment">     */</span>
<a name="l01369"></a>01369     <span class="keywordflow">if</span> (repo_version &gt; 0)
<a name="l01370"></a>01370         <a class="code" href="daemon_2repo-mgr_8c.html#a7d2cf85f06fa2e7d459730f7494c1a65">seaf_repo_manager_remove_garbage_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id);
<a name="l01371"></a>01371 
<a name="l01372"></a>01372     <span class="comment">/* Delete orphan information in the db in case the repo was corrupt. */</span>
<a name="l01373"></a>01373     <span class="keywordflow">if</span> (!repo)
<a name="l01374"></a>01374         <a class="code" href="daemon_2repo-mgr_8c.html#a008f145440cf3620f7883d1fe109f69c">seaf_repo_manager_remove_repo_ondisk</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id, FALSE);
<a name="l01375"></a>01375 
<a name="l01376"></a>01376     ret = add_task_common (mgr, repo_id, repo_version,
<a name="l01377"></a>01377                            peer_id, repo_name, token, passwd,
<a name="l01378"></a>01378                            enc_version, random_key,
<a name="l01379"></a>01379                            worktree, peer_addr, peer_port,
<a name="l01380"></a>01380                            email, more_info,
<a name="l01381"></a>01381                            error);
<a name="l01382"></a>01382     g_free (worktree);
<a name="l01383"></a>01383 
<a name="l01384"></a>01384     <span class="keywordflow">return</span> ret;
<a name="l01385"></a>01385 }
<a name="l01386"></a>01386 
<a name="l01387"></a>01387 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l01388"></a>01388 make_worktree_for_download (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr,
<a name="l01389"></a>01389                             <span class="keyword">const</span> <span class="keywordtype">char</span> *wt_tmp,
<a name="l01390"></a>01390                             GError **error)
<a name="l01391"></a>01391 {
<a name="l01392"></a>01392     <span class="keywordtype">char</span> *worktree;
<a name="l01393"></a>01393 
<a name="l01394"></a>01394     <span class="keywordflow">if</span> (g_access (wt_tmp, F_OK) == 0) {
<a name="l01395"></a>01395         worktree = try_worktree (wt_tmp);
<a name="l01396"></a>01396     } <span class="keywordflow">else</span> {
<a name="l01397"></a>01397         worktree = g_strdup(wt_tmp);
<a name="l01398"></a>01398     }
<a name="l01399"></a>01399 
<a name="l01400"></a>01400     <span class="keywordflow">if</span> (!<a class="code" href="clone-mgr_8c.html#a45fe95b1bbe19ee533a8f9e57884658e">seaf_clone_manager_check_worktree_path</a> (mgr, worktree, error)) {
<a name="l01401"></a>01401         g_free (worktree);
<a name="l01402"></a>01402         <span class="keywordflow">return</span> NULL;
<a name="l01403"></a>01403     }
<a name="l01404"></a>01404 
<a name="l01405"></a>01405     <span class="keywordflow">return</span> worktree;
<a name="l01406"></a>01406 }
<a name="l01407"></a>01407 
<a name="l01408"></a>01408 <span class="keywordtype">char</span> *
<a name="l01409"></a><a class="code" href="clone-mgr_8h.html#ab6b5a2b4f13b382b9c7034131fa92783">01409</a> <a class="code" href="clone-mgr_8c.html#ab6b5a2b4f13b382b9c7034131fa92783">seaf_clone_manager_add_download_task</a> (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr, 
<a name="l01410"></a>01410                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l01411"></a>01411                                       <span class="keywordtype">int</span> repo_version,
<a name="l01412"></a>01412                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id,
<a name="l01413"></a>01413                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_name,
<a name="l01414"></a>01414                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *token,
<a name="l01415"></a>01415                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *passwd,
<a name="l01416"></a>01416                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *magic,
<a name="l01417"></a>01417                                       <span class="keywordtype">int</span> enc_version,
<a name="l01418"></a>01418                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *random_key,
<a name="l01419"></a>01419                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *wt_parent,
<a name="l01420"></a>01420                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_addr,
<a name="l01421"></a>01421                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_port,
<a name="l01422"></a>01422                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *email,
<a name="l01423"></a>01423                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *more_info,
<a name="l01424"></a>01424                                       GError **error)
<a name="l01425"></a>01425 {
<a name="l01426"></a>01426     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l01427"></a>01427     <span class="keywordtype">char</span> *wt_tmp, *worktree;
<a name="l01428"></a>01428     <span class="keywordtype">char</span> *ret;
<a name="l01429"></a>01429 
<a name="l01430"></a>01430     <span class="keywordflow">if</span> (!<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a5432788378b921624977855244c63a85">started</a>) {
<a name="l01431"></a>01431         seaf_message (<span class="stringliteral">&quot;System not started, skip adding clone task.\n&quot;</span>);
<a name="l01432"></a>01432         <span class="keywordflow">return</span> NULL;
<a name="l01433"></a>01433     }
<a name="l01434"></a>01434 
<a name="l01435"></a>01435     <span class="keywordflow">if</span> (passwd &amp;&amp;
<a name="l01436"></a>01436         !check_encryption_args (magic, enc_version, random_key, error))
<a name="l01437"></a>01437         <span class="keywordflow">return</span> NULL;
<a name="l01438"></a>01438 
<a name="l01439"></a>01439     <span class="comment">/* After a repo was unsynced, the sync task may still be blocked in the</span>
<a name="l01440"></a>01440 <span class="comment">     * network, so the repo is not actually deleted yet.</span>
<a name="l01441"></a>01441 <span class="comment">     * In this case just return an error to the user.</span>
<a name="l01442"></a>01442 <span class="comment">     */</span>
<a name="l01443"></a>01443     <a class="code" href="struct__SyncInfo.html">SyncInfo</a> *sync_info = <a class="code" href="sync-mgr_8c.html#afb758dbde64ac4505ad259f95601d45e">seaf_sync_manager_get_sync_info</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a6b2a5e1e723955885f9fb27c5f064df4">sync_mgr</a>,
<a name="l01444"></a>01444                                                            repo_id);
<a name="l01445"></a>01445     <span class="keywordflow">if</span> (sync_info &amp;&amp; sync_info-&gt;<a class="code" href="struct__SyncInfo.html#ad0f77a2b8e799b3a0abc417fce88843a">in_sync</a>) {
<a name="l01446"></a>01446         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l01447"></a>01447                      <span class="stringliteral">&quot;Repo already exists&quot;</span>);
<a name="l01448"></a>01448         <span class="keywordflow">return</span> NULL;
<a name="l01449"></a>01449     }
<a name="l01450"></a>01450 
<a name="l01451"></a>01451     repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id);
<a name="l01452"></a>01452 
<a name="l01453"></a>01453     <span class="keywordflow">if</span> (repo != NULL &amp;&amp; repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a> != NULL) {
<a name="l01454"></a>01454         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l01455"></a>01455                      <span class="stringliteral">&quot;Repo already exists&quot;</span>);
<a name="l01456"></a>01456         <span class="keywordflow">return</span> NULL;
<a name="l01457"></a>01457     }   
<a name="l01458"></a>01458 
<a name="l01459"></a>01459     <span class="keywordflow">if</span> (is_duplicate_task (mgr, repo_id)) {
<a name="l01460"></a>01460         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, 
<a name="l01461"></a>01461                      <span class="stringliteral">&quot;Task is already in progress&quot;</span>);
<a name="l01462"></a>01462         <span class="keywordflow">return</span> NULL;
<a name="l01463"></a>01463     }
<a name="l01464"></a>01464 
<a name="l01465"></a>01465     <span class="keywordflow">if</span> (passwd &amp;&amp;
<a name="l01466"></a>01466         <a class="code" href="seafile-crypt_8c.html#a9ada7f42f1f31b91dabdc5edde6b73f9">seafile_verify_repo_passwd</a>(repo_id, passwd, magic, enc_version) &lt; 0) {
<a name="l01467"></a>01467         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l01468"></a>01468                      <span class="stringliteral">&quot;Incorrect password&quot;</span>);
<a name="l01469"></a>01469         <span class="keywordflow">return</span> NULL;
<a name="l01470"></a>01470     }
<a name="l01471"></a>01471 
<a name="l01472"></a>01472     wt_tmp = g_build_filename (wt_parent, repo_name, NULL);
<a name="l01473"></a>01473 
<a name="l01474"></a>01474     worktree = make_worktree_for_download (mgr, wt_tmp, error);
<a name="l01475"></a>01475     <span class="keywordflow">if</span> (!worktree) {
<a name="l01476"></a>01476         g_free (wt_tmp);
<a name="l01477"></a>01477         <span class="keywordflow">return</span> NULL;
<a name="l01478"></a>01478     }
<a name="l01479"></a>01479 
<a name="l01480"></a>01480     <span class="comment">/* If a repo was unsynced and then downloaded again, there may be</span>
<a name="l01481"></a>01481 <span class="comment">     * a garbage record for this repo. We don&#39;t want the downloaded blocks</span>
<a name="l01482"></a>01482 <span class="comment">     * be removed by GC.</span>
<a name="l01483"></a>01483 <span class="comment">     */</span>
<a name="l01484"></a>01484     <span class="keywordflow">if</span> (repo_version &gt; 0)
<a name="l01485"></a>01485         <a class="code" href="daemon_2repo-mgr_8c.html#a7d2cf85f06fa2e7d459730f7494c1a65">seaf_repo_manager_remove_garbage_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id);
<a name="l01486"></a>01486 
<a name="l01487"></a>01487     <span class="comment">/* Delete orphan information in the db in case the repo was corrupt. */</span>
<a name="l01488"></a>01488     <span class="keywordflow">if</span> (!repo)
<a name="l01489"></a>01489         <a class="code" href="daemon_2repo-mgr_8c.html#a008f145440cf3620f7883d1fe109f69c">seaf_repo_manager_remove_repo_ondisk</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id, FALSE);
<a name="l01490"></a>01490 
<a name="l01491"></a>01491     ret = add_task_common (mgr, repo_id, repo_version,
<a name="l01492"></a>01492                            peer_id, repo_name, token, passwd,
<a name="l01493"></a>01493                            enc_version, random_key,
<a name="l01494"></a>01494                            worktree, peer_addr, peer_port,
<a name="l01495"></a>01495                            email, more_info, error);
<a name="l01496"></a>01496     g_free (worktree);
<a name="l01497"></a>01497     g_free (wt_tmp);
<a name="l01498"></a>01498 
<a name="l01499"></a>01499     <span class="keywordflow">return</span> ret;
<a name="l01500"></a>01500 }
<a name="l01501"></a>01501 
<a name="l01502"></a>01502 <span class="keywordtype">int</span>
<a name="l01503"></a><a class="code" href="clone-mgr_8h.html#a2849d011d1f918b3108c30495c98254b">01503</a> <a class="code" href="clone-mgr_8c.html#a2849d011d1f918b3108c30495c98254b">seaf_clone_manager_cancel_task</a> (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr,
<a name="l01504"></a>01504                                 <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l01505"></a>01505 {
<a name="l01506"></a>01506     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task;
<a name="l01507"></a>01507 
<a name="l01508"></a>01508     <span class="keywordflow">if</span> (!<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a5432788378b921624977855244c63a85">started</a>) {
<a name="l01509"></a>01509         seaf_message (<span class="stringliteral">&quot;System not started, skip canceling clone task.\n&quot;</span>);
<a name="l01510"></a>01510         <span class="keywordflow">return</span> -1;
<a name="l01511"></a>01511     }
<a name="l01512"></a>01512 
<a name="l01513"></a>01513     task = g_hash_table_lookup (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#ac27110eab926004781f02c7b5e4d0370">tasks</a>, repo_id);
<a name="l01514"></a>01514     <span class="keywordflow">if</span> (!task)
<a name="l01515"></a>01515         <span class="keywordflow">return</span> -1;
<a name="l01516"></a>01516 
<a name="l01517"></a>01517     <span class="keywordflow">switch</span> (task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a>) {
<a name="l01518"></a>01518     <span class="keywordflow">case</span> <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a15a782f2367c11ca3a9ee11a3f9c4eec">CLONE_STATE_INIT</a>:
<a name="l01519"></a>01519     <span class="keywordflow">case</span> <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8afd7df49789f27957a882d91822b78eff">CLONE_STATE_CONNECT</a>:
<a name="l01520"></a>01520         transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a5b171455c76672ef5f3808bbc9267cc3">CLONE_STATE_CANCELED</a>);
<a name="l01521"></a>01521         <span class="keywordflow">break</span>;
<a name="l01522"></a>01522     <span class="keywordflow">case</span> <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8ae67f39ebed40e85b2d90de1f3119edca">CLONE_STATE_FETCH</a>:
<a name="l01523"></a>01523         <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__CloneTask.html#ae9ed3b204a7c4364ef44b16a7056ccd1">http_sync</a>)
<a name="l01524"></a>01524             <a class="code" href="transfer-mgr_8c.html#af834de917c22d13996383431bef032a0">seaf_transfer_manager_cancel_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa04a8214ef989d1e5d68799dc19cbf22">transfer_mgr</a>,
<a name="l01525"></a>01525                                                task-&gt;<a class="code" href="struct__CloneTask.html#a6ffe70c7ca5bbb71b617eecb53c0244f">tx_id</a>,
<a name="l01526"></a>01526                                                <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa68841d8280724b9623db3dea4a78dde5">TASK_TYPE_DOWNLOAD</a>);
<a name="l01527"></a>01527         <span class="keywordflow">else</span>
<a name="l01528"></a>01528             <a class="code" href="http-tx-mgr_8c.html#a1333f1b023ba910df52c75f6ec51c41d">http_tx_manager_cancel_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>,
<a name="l01529"></a>01529                                          task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>,
<a name="l01530"></a>01530                                          <a class="code" href="http-tx-mgr_8h.html#a16af7b253440dadd46a80a4b9fddba4da429731c6953f215203cf1b17fe92ebb1">HTTP_TASK_TYPE_DOWNLOAD</a>);
<a name="l01531"></a>01531         transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a7c3d6e2ad24a7e0f2adf534a42b235bc">CLONE_STATE_CANCEL_PENDING</a>);
<a name="l01532"></a>01532         <span class="keywordflow">break</span>;
<a name="l01533"></a>01533     <span class="keywordflow">case</span> <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8aae34ed29b33feeb3d64a3e5efe2d8ff0">CLONE_STATE_INDEX</a>:
<a name="l01534"></a>01534     <span class="keywordflow">case</span> <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8ad8e45ae1a104379cb606fd2c05a7c6cd">CLONE_STATE_CHECKOUT</a>:
<a name="l01535"></a>01535     <span class="keywordflow">case</span> <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a54946986c45281155e2e59421c8a8a77">CLONE_STATE_MERGE</a>:
<a name="l01536"></a>01536         <span class="comment">/* We cannot cancel an in-progress checkout, just</span>
<a name="l01537"></a>01537 <span class="comment">         * wait until it finishes.</span>
<a name="l01538"></a>01538 <span class="comment">         */</span>
<a name="l01539"></a>01539         transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a7c3d6e2ad24a7e0f2adf534a42b235bc">CLONE_STATE_CANCEL_PENDING</a>);
<a name="l01540"></a>01540         <span class="keywordflow">break</span>;
<a name="l01541"></a>01541     <span class="keywordflow">case</span> <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a7c3d6e2ad24a7e0f2adf534a42b235bc">CLONE_STATE_CANCEL_PENDING</a>:
<a name="l01542"></a>01542         <span class="keywordflow">break</span>;
<a name="l01543"></a>01543     <span class="keywordflow">default</span>:
<a name="l01544"></a>01544         seaf_warning (<span class="stringliteral">&quot;[Clone mgr] cannot cancel a not-running task.\n&quot;</span>);
<a name="l01545"></a>01545         <span class="keywordflow">return</span> -1;
<a name="l01546"></a>01546     }
<a name="l01547"></a>01547 
<a name="l01548"></a>01548     <span class="keywordflow">return</span> 0;
<a name="l01549"></a>01549 }
<a name="l01550"></a>01550 
<a name="l01551"></a>01551 <span class="keywordtype">int</span>
<a name="l01552"></a><a class="code" href="clone-mgr_8h.html#a131d57446fac0ffddf9dd4dbebe985ae">01552</a> <a class="code" href="clone-mgr_8c.html#a131d57446fac0ffddf9dd4dbebe985ae">seaf_clone_manager_remove_task</a> (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr,
<a name="l01553"></a>01553                                 <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l01554"></a>01554 {
<a name="l01555"></a>01555     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task;
<a name="l01556"></a>01556 
<a name="l01557"></a>01557     <span class="keywordflow">if</span> (!<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a5432788378b921624977855244c63a85">started</a>) {
<a name="l01558"></a>01558         seaf_message (<span class="stringliteral">&quot;System not started, skip removing clone task.\n&quot;</span>);
<a name="l01559"></a>01559         <span class="keywordflow">return</span> -1;
<a name="l01560"></a>01560     }
<a name="l01561"></a>01561 
<a name="l01562"></a>01562     task = g_hash_table_lookup (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#ac27110eab926004781f02c7b5e4d0370">tasks</a>, repo_id);
<a name="l01563"></a>01563     <span class="keywordflow">if</span> (!task)
<a name="l01564"></a>01564         <span class="keywordflow">return</span> -1;
<a name="l01565"></a>01565 
<a name="l01566"></a>01566     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> != <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8af1c3a28143f803ec77f12421a745c80e">CLONE_STATE_DONE</a> &amp;&amp;
<a name="l01567"></a>01567         task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> != <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8aed32a49a21c225e3aa62f83b837e2e33">CLONE_STATE_ERROR</a> &amp;&amp;
<a name="l01568"></a>01568         task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> != <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a5b171455c76672ef5f3808bbc9267cc3">CLONE_STATE_CANCELED</a>) {
<a name="l01569"></a>01569         seaf_warning (<span class="stringliteral">&quot;[Clone mgr] cannot remove running task.\n&quot;</span>);
<a name="l01570"></a>01570         <span class="keywordflow">return</span> -1;
<a name="l01571"></a>01571     }
<a name="l01572"></a>01572 
<a name="l01573"></a>01573     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#a6ffe70c7ca5bbb71b617eecb53c0244f">tx_id</a>)
<a name="l01574"></a>01574         <a class="code" href="transfer-mgr_8c.html#ad58e56f4396d154be75bdb37bf4a53ae">seaf_transfer_manager_remove_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa04a8214ef989d1e5d68799dc19cbf22">transfer_mgr</a>,
<a name="l01575"></a>01575                                            task-&gt;<a class="code" href="struct__CloneTask.html#a6ffe70c7ca5bbb71b617eecb53c0244f">tx_id</a>,
<a name="l01576"></a>01576                                            <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa68841d8280724b9623db3dea4a78dde5">TASK_TYPE_DOWNLOAD</a>);
<a name="l01577"></a>01577 
<a name="l01578"></a>01578     <span class="comment">/* On-disk task should have been removed. */</span>
<a name="l01579"></a>01579 
<a name="l01580"></a>01580     g_hash_table_remove (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#ac27110eab926004781f02c7b5e4d0370">tasks</a>, repo_id);
<a name="l01581"></a>01581 
<a name="l01582"></a>01582     <span class="keywordflow">return</span> 0;
<a name="l01583"></a>01583 }
<a name="l01584"></a>01584 
<a name="l01585"></a>01585 <a class="code" href="struct__CloneTask.html">CloneTask</a> *
<a name="l01586"></a><a class="code" href="clone-mgr_8h.html#acb26f43fecfbf4f3b0c81ea6f7a6195f">01586</a> <a class="code" href="clone-mgr_8c.html#acb26f43fecfbf4f3b0c81ea6f7a6195f">seaf_clone_manager_get_task</a> (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr,
<a name="l01587"></a>01587                              <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l01588"></a>01588 {
<a name="l01589"></a>01589     <span class="keywordflow">return</span> (<a class="code" href="struct__CloneTask.html">CloneTask</a> *) g_hash_table_lookup (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#ac27110eab926004781f02c7b5e4d0370">tasks</a>, repo_id);
<a name="l01590"></a>01590 }
<a name="l01591"></a>01591 
<a name="l01592"></a>01592 GList *
<a name="l01593"></a><a class="code" href="clone-mgr_8h.html#a6b295c7d97d0c650eb97ea7a9c7eb98f">01593</a> <a class="code" href="clone-mgr_8c.html#a6b295c7d97d0c650eb97ea7a9c7eb98f">seaf_clone_manager_get_tasks</a> (<a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr)
<a name="l01594"></a>01594 {
<a name="l01595"></a>01595     <span class="keywordflow">return</span> g_hash_table_get_values (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#ac27110eab926004781f02c7b5e4d0370">tasks</a>);
<a name="l01596"></a>01596 }
<a name="l01597"></a>01597 
<a name="l01598"></a><a class="code" href="structMergeAux.html">01598</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l01599"></a><a class="code" href="structMergeAux.html#a30a4e39242274c7ec372e39ad7e602b0">01599</a>     gboolean <a class="code" href="structMergeAux.html#a30a4e39242274c7ec372e39ad7e602b0">is_fast_forward</a>;
<a name="l01600"></a><a class="code" href="structMergeAux.html#a6355a80568182d386f1630582298afdd">01600</a>     gboolean <a class="code" href="structMergeAux.html#a6355a80568182d386f1630582298afdd">check_ff_in_thread</a>;
<a name="l01601"></a><a class="code" href="structMergeAux.html#a78b01e9fbebdec145226205797739e32">01601</a>     <a class="code" href="struct__CloneTask.html">CloneTask</a> *<a class="code" href="structMergeAux.html#a78b01e9fbebdec145226205797739e32">task</a>;
<a name="l01602"></a><a class="code" href="structMergeAux.html#a9f6ce9ad11838dedc3c61d06bd923ca2">01602</a>     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *<a class="code" href="structMergeAux.html#a9f6ce9ad11838dedc3c61d06bd923ca2">repo</a>;
<a name="l01603"></a><a class="code" href="structMergeAux.html#aae68089a96de72f370fcc130e24c06c0">01603</a>     gboolean <a class="code" href="structMergeAux.html#aae68089a96de72f370fcc130e24c06c0">success</a>;
<a name="l01604"></a>01604 } <a class="code" href="structMergeAux.html">MergeAux</a>;
<a name="l01605"></a>01605 
<a name="l01606"></a><a class="code" href="structCompareAux.html">01606</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l01607"></a><a class="code" href="structCompareAux.html#a2f83e953abe4ecabfc7a5cdc3b379f33">01607</a>     gboolean <a class="code" href="structCompareAux.html#a2f83e953abe4ecabfc7a5cdc3b379f33">fast_forward</a>;
<a name="l01608"></a><a class="code" href="structCompareAux.html#a98a59b08f11456b26fc7e2266f86b3f3">01608</a>     <span class="keywordtype">char</span> root_id[41];
<a name="l01609"></a>01609 } <a class="code" href="structCompareAux.html">CompareAux</a>;
<a name="l01610"></a>01610 
<a name="l01611"></a>01611 <span class="keyword">static</span> gboolean
<a name="l01612"></a>01612 compare_root (<a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit, <span class="keywordtype">void</span> *data, gboolean *stop)
<a name="l01613"></a>01613 {
<a name="l01614"></a>01614     <a class="code" href="structCompareAux.html">CompareAux</a> *aux = data;
<a name="l01615"></a>01615 
<a name="l01616"></a>01616     <span class="comment">/* If we&#39;ve found a match in another branch, stop traversing. */</span>
<a name="l01617"></a>01617     <span class="keywordflow">if</span> (aux-&gt;<a class="code" href="structCompareAux.html#a2f83e953abe4ecabfc7a5cdc3b379f33">fast_forward</a>) {
<a name="l01618"></a>01618         *stop = TRUE;
<a name="l01619"></a>01619         <span class="keywordflow">return</span> TRUE;
<a name="l01620"></a>01620     }
<a name="l01621"></a>01621 
<a name="l01622"></a>01622     <span class="keywordflow">if</span> (strcmp (commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, aux-&gt;<a class="code" href="structCompareAux.html#a98a59b08f11456b26fc7e2266f86b3f3">root_id</a>) == 0) {
<a name="l01623"></a>01623         aux-&gt;<a class="code" href="structCompareAux.html#a2f83e953abe4ecabfc7a5cdc3b379f33">fast_forward</a> = TRUE;
<a name="l01624"></a>01624         *stop = TRUE;
<a name="l01625"></a>01625     }
<a name="l01626"></a>01626 
<a name="l01627"></a>01627     <span class="keywordflow">return</span> TRUE;
<a name="l01628"></a>01628 }
<a name="l01629"></a>01629 
<a name="l01630"></a>01630 <span class="keyword">static</span> gboolean
<a name="l01631"></a>01631 check_fast_forward (<a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head, <span class="keyword">const</span> <span class="keywordtype">char</span> *root_id)
<a name="l01632"></a>01632 {
<a name="l01633"></a>01633     <a class="code" href="structCompareAux.html">CompareAux</a> *aux = g_new0 (<a class="code" href="structCompareAux.html">CompareAux</a>, 1);
<a name="l01634"></a>01634     gboolean ret;
<a name="l01635"></a>01635 
<a name="l01636"></a>01636     memcpy (aux-&gt;<a class="code" href="structCompareAux.html#a98a59b08f11456b26fc7e2266f86b3f3">root_id</a>, root_id, 41);
<a name="l01637"></a>01637     <span class="keywordflow">if</span> (!<a class="code" href="commit-mgr_8c.html#ac6547d5546781608b39446d9a2077fed">seaf_commit_manager_traverse_commit_tree</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l01638"></a>01638                                                    head-&gt;<a class="code" href="struct__SeafCommit.html#af9c51057516029191941d47985df7f5f">repo_id</a>,
<a name="l01639"></a>01639                                                    head-&gt;<a class="code" href="struct__SeafCommit.html#abc83f168ce2b43fa864522bf0ea26d6d">version</a>,
<a name="l01640"></a>01640                                                    head-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>,
<a name="l01641"></a>01641                                                    compare_root,
<a name="l01642"></a>01642                                                    aux, FALSE)) {
<a name="l01643"></a>01643         g_free (aux);
<a name="l01644"></a>01644         <span class="keywordflow">return</span> FALSE;
<a name="l01645"></a>01645     }
<a name="l01646"></a>01646 
<a name="l01647"></a>01647     ret = aux-&gt;<a class="code" href="structCompareAux.html#a2f83e953abe4ecabfc7a5cdc3b379f33">fast_forward</a>;
<a name="l01648"></a>01648     g_free (aux);
<a name="l01649"></a>01649     <span class="keywordflow">return</span> ret;
<a name="l01650"></a>01650 }
<a name="l01651"></a>01651 
<a name="l01652"></a>01652 <span class="preprocessor">#if 0</span>
<a name="l01653"></a>01653 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> 
<a name="l01654"></a>01654 print_index (<span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate)
<a name="l01655"></a>01655 {
<a name="l01656"></a>01656     <span class="keywordtype">int</span> i;
<a name="l01657"></a>01657     <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *ce;
<a name="l01658"></a>01658     <span class="keywordtype">char</span> <span class="keywordtype">id</span>[41];
<a name="l01659"></a>01659     g_message (<span class="stringliteral">&quot;Totally %u entries in index, version %u.\n&quot;</span>,
<a name="l01660"></a>01660                istate-&gt;<a class="code" href="structindex__state.html#a15b38cdd30ad2374bc12da429f39312f">cache_nr</a>, istate-&gt;<a class="code" href="structindex__state.html#a0fb0d6a2dabae448b68f04e75ffc1612">version</a>);
<a name="l01661"></a>01661     <span class="keywordflow">for</span> (i = 0; i &lt; istate-&gt;<a class="code" href="structindex__state.html#a15b38cdd30ad2374bc12da429f39312f">cache_nr</a>; ++i) {
<a name="l01662"></a>01662         ce = istate-&gt;<a class="code" href="structindex__state.html#a8aa7a8aa984ec5a39ff2eee96412db07">cache</a>[i];
<a name="l01663"></a>01663         <a class="code" href="seafile_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a> (ce-&gt;<a class="code" href="structcache__entry.html#a119ab5c5e9db495e6e5f8d301f01421c">sha1</a>, <span class="keywordtype">id</span>, 20);
<a name="l01664"></a>01664         g_message (<span class="stringliteral">&quot;%s, %s, %o, %&quot;</span>G_GUINT64_FORMAT<span class="stringliteral">&quot;, %s, %d\n&quot;</span>,
<a name="l01665"></a>01665                    ce-&gt;<a class="code" href="structcache__entry.html#a792e4ea24cb16c76abe3229651e414a0">name</a>, <span class="keywordtype">id</span>, ce-&gt;<a class="code" href="structcache__entry.html#a5fcbcc4e7265ae8150f136380ed92c05">ce_mode</a>, 
<a name="l01666"></a>01666                    ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a>, ce-&gt;<a class="code" href="structcache__entry.html#a786aa5bc6234542fe202023bcf721afd">modifier</a>, <a class="code" href="index_8h.html#a0379c411a3dc56c2d5ac0b1fcce22ead">ce_stage</a>(ce));
<a name="l01667"></a>01667     }
<a name="l01668"></a>01668 
<a name="l01669"></a>01669     <span class="keywordflow">return</span> 0;
<a name="l01670"></a>01670 }
<a name="l01671"></a>01671 <span class="preprocessor">#endif</span>
<a name="l01672"></a>01672 <span class="preprocessor"></span>
<a name="l01673"></a>01673 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01674"></a>01674 real_merge (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head, <a class="code" href="struct__CloneTask.html">CloneTask</a> *task)
<a name="l01675"></a>01675 {
<a name="l01676"></a>01676     <span class="keyword">struct </span><a class="code" href="structmerge__options.html">merge_options</a> opts;
<a name="l01677"></a>01677     <span class="keywordtype">char</span> <a class="code" href="index_8c.html#a35caece3e3575d32521f820a8f0a24a7">index_path</a>[<a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
<a name="l01678"></a>01678     <span class="keyword">struct </span><a class="code" href="structindex__state.html">index_state</a> istate;
<a name="l01679"></a>01679     <span class="keywordtype">char</span> *root_id = NULL;
<a name="l01680"></a>01680     <span class="keywordtype">int</span> clean;
<a name="l01681"></a>01681     <span class="keywordtype">int</span> ret = 0;
<a name="l01682"></a>01682 
<a name="l01683"></a>01683     memset (&amp;istate, 0, <span class="keyword">sizeof</span>(istate));
<a name="l01684"></a>01684     snprintf (index_path, <a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01685"></a>01685     <span class="keywordflow">if</span> (<a class="code" href="index_8c.html#a0f9de2761514c9136fb4b9c5541ef6f8">read_index_from</a> (&amp;istate, index_path, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>) &lt; 0) {
<a name="l01686"></a>01686         seaf_warning (<span class="stringliteral">&quot;Failed to load index.\n&quot;</span>);
<a name="l01687"></a>01687         <span class="keywordflow">return</span> -1;
<a name="l01688"></a>01688     }
<a name="l01689"></a>01689 
<a name="l01690"></a>01690     <a class="code" href="merge-recursive_8c.html#ad9f59a097408f4a821a7dfc305ffa244">init_merge_options</a> (&amp;opts);
<a name="l01691"></a>01691     memcpy (opts.repo_id, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, 36);
<a name="l01692"></a>01692     opts.version = repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>;
<a name="l01693"></a>01693     opts.index = &amp;istate;
<a name="l01694"></a>01694     opts.worktree = task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>;
<a name="l01695"></a>01695     opts.ancestor = <span class="stringliteral">&quot;common ancestor&quot;</span>;
<a name="l01696"></a>01696     opts.branch1 = <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a7acba9a9723ea082afbcd1032be5b6de">base</a>.<a class="code" href="struct__CcnetSessionBase.html#acb921a00a3498928d68d4a5b42c1ece4">user_name</a>;
<a name="l01697"></a>01697     opts.branch2 = head-&gt;<a class="code" href="struct__SeafCommit.html#ab19d020b7c936d11821fe0b836aa548e">creator_name</a>;
<a name="l01698"></a>01698     opts.remote_head = head-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>;
<a name="l01699"></a>01699     <span class="comment">/* Don&#39;t need to check locked files on windows. */</span>
<a name="l01700"></a>01700     opts.force_merge = TRUE;
<a name="l01701"></a>01701     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
<a name="l01702"></a>01702         opts.crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>, 
<a name="l01703"></a>01703                                         repo-&gt;<a class="code" href="struct__SeafRepo.html#ad951f63e287f0ea14c863937afea6779">enc_key</a>, 
<a name="l01704"></a>01704                                         repo-&gt;<a class="code" href="struct__SeafRepo.html#a7ad105e1fab206035f1c585c25e0dc94">enc_iv</a>);
<a name="l01705"></a>01705     }
<a name="l01706"></a>01706 
<a name="l01707"></a>01707     <span class="comment">/* Merge the downloaded branch with the current worktree contents.</span>
<a name="l01708"></a>01708 <span class="comment">     * EMPTY_SHA1 represents an empty common ancestor tree.</span>
<a name="l01709"></a>01709 <span class="comment">     */</span>
<a name="l01710"></a>01710     <a class="code" href="merge-recursive_8c.html#ac5c545b083f8e950f4e13cb31b4a74d1">merge_recursive</a> (&amp;opts,
<a name="l01711"></a>01711                      task-&gt;<a class="code" href="struct__CloneTask.html#ababd2533c456b735b93e76d0b7eac4dc">root_id</a>, head-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, <a class="code" href="seafile_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>,
<a name="l01712"></a>01712                      &amp;clean, &amp;root_id);
<a name="l01713"></a>01713     g_free (root_id);
<a name="l01714"></a>01714 
<a name="l01715"></a>01715     <span class="keywordflow">if</span> (<a class="code" href="vc-utils_8c.html#ab93fff6b962d6fd7482c95d17c8bf6eb">update_index</a> (&amp;istate, index_path) &lt; 0) {
<a name="l01716"></a>01716         seaf_warning (<span class="stringliteral">&quot;Failed to update index.\n&quot;</span>);
<a name="l01717"></a>01717         ret = -1;
<a name="l01718"></a>01718     }
<a name="l01719"></a>01719 
<a name="l01720"></a>01720     <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
<a name="l01721"></a>01721     g_free (opts.crypt);
<a name="l01722"></a>01722     <a class="code" href="merge-recursive_8c.html#a2cd0784c81c09200949dd6f61cc80d67">clear_merge_options</a> (&amp;opts);
<a name="l01723"></a>01723 
<a name="l01724"></a>01724     <span class="keywordflow">return</span> ret;
<a name="l01725"></a>01725 }
<a name="l01726"></a>01726 
<a name="l01727"></a>01727 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01728"></a>01728 fast_forward_checkout (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head, <a class="code" href="struct__CloneTask.html">CloneTask</a> *task)
<a name="l01729"></a>01729 {
<a name="l01730"></a>01730     <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>;
<a name="l01731"></a>01731     <span class="keywordtype">char</span> index_path[<a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
<a name="l01732"></a>01732     <span class="keyword">struct </span><a class="code" href="structtree__desc.html">tree_desc</a> trees[2];
<a name="l01733"></a>01733     <span class="keyword">struct </span><a class="code" href="structunpack__trees__options.html">unpack_trees_options</a> topts;
<a name="l01734"></a>01734     <span class="keyword">struct </span><a class="code" href="structindex__state.html">index_state</a> istate;
<a name="l01735"></a>01735     <span class="keywordtype">int</span> ret = 0;
<a name="l01736"></a>01736 
<a name="l01737"></a>01737     <span class="keywordflow">if</span> (strcmp (head-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, task-&gt;<a class="code" href="struct__CloneTask.html#ababd2533c456b735b93e76d0b7eac4dc">root_id</a>) == 0)
<a name="l01738"></a>01738         <span class="keywordflow">return</span> 0;
<a name="l01739"></a>01739 
<a name="l01740"></a>01740     memset (&amp;istate, 0, <span class="keyword">sizeof</span>(istate));
<a name="l01741"></a>01741     snprintf (index_path, <a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01742"></a>01742     <span class="keywordflow">if</span> (<a class="code" href="index_8c.html#a0f9de2761514c9136fb4b9c5541ef6f8">read_index_from</a> (&amp;istate, index_path, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>) &lt; 0) {
<a name="l01743"></a>01743         seaf_warning (<span class="stringliteral">&quot;Failed to load index.\n&quot;</span>);
<a name="l01744"></a>01744         <span class="keywordflow">return</span> -1;
<a name="l01745"></a>01745     }
<a name="l01746"></a>01746     repo-&gt;<a class="code" href="struct__SeafRepo.html#a5377f474b9e1cc96a69ab26d5da8e244">index_corrupted</a> = FALSE;
<a name="l01747"></a>01747 
<a name="l01748"></a>01748     <a class="code" href="seaf-tree-walk_8c.html#a7b310abaeb185b8918eb2a9fc843e097">fill_tree_descriptor</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, &amp;trees[0], task-&gt;<a class="code" href="struct__CloneTask.html#ababd2533c456b735b93e76d0b7eac4dc">root_id</a>);
<a name="l01749"></a>01749     <a class="code" href="seaf-tree-walk_8c.html#a7b310abaeb185b8918eb2a9fc843e097">fill_tree_descriptor</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, &amp;trees[1], head-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>);
<a name="l01750"></a>01750 
<a name="l01751"></a>01751     memset(&amp;topts, 0, <span class="keyword">sizeof</span>(topts));
<a name="l01752"></a>01752     memcpy (topts.repo_id, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, 36);
<a name="l01753"></a>01753     topts.version = repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>;
<a name="l01754"></a>01754     topts.base = task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>;
<a name="l01755"></a>01755     topts.head_idx = -1;
<a name="l01756"></a>01756     topts.src_index = &amp;istate;
<a name="l01757"></a>01757     topts.update = 1;
<a name="l01758"></a>01758     topts.merge = 1;
<a name="l01759"></a>01759     topts.fn = <a class="code" href="unpack-trees_8c.html#a37f4950a59ff1ce85ed1bf91eeea7054">twoway_merge</a>;
<a name="l01760"></a>01760     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
<a name="l01761"></a>01761         topts.crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>, 
<a name="l01762"></a>01762                                          repo-&gt;<a class="code" href="struct__SeafRepo.html#ad951f63e287f0ea14c863937afea6779">enc_key</a>, 
<a name="l01763"></a>01763                                          repo-&gt;<a class="code" href="struct__SeafRepo.html#a7ad105e1fab206035f1c585c25e0dc94">enc_iv</a>);
<a name="l01764"></a>01764     }
<a name="l01765"></a>01765 
<a name="l01766"></a>01766     <span class="keywordflow">if</span> (<a class="code" href="unpack-trees_8c.html#a5bfe365644fb33537027e988fb891e08">unpack_trees</a> (2, trees, &amp;topts) &lt; 0) {
<a name="l01767"></a>01767         seaf_warning (<span class="stringliteral">&quot;Failed to merge commit %s with work tree.\n&quot;</span>, head-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>);
<a name="l01768"></a>01768         ret = -1;
<a name="l01769"></a>01769         <span class="keywordflow">goto</span> out;
<a name="l01770"></a>01770     }
<a name="l01771"></a>01771 
<a name="l01772"></a>01772     <span class="keywordflow">if</span> (<a class="code" href="vc-utils_8c.html#a4b8dc271b94740a5cb1e32827ee88d29">update_worktree</a> (&amp;topts, FALSE,
<a name="l01773"></a>01773                          head-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>,
<a name="l01774"></a>01774                          head-&gt;<a class="code" href="struct__SeafCommit.html#ab19d020b7c936d11821fe0b836aa548e">creator_name</a>,
<a name="l01775"></a>01775                          NULL) &lt; 0) {
<a name="l01776"></a>01776         seaf_warning (<span class="stringliteral">&quot;Failed to update worktree.\n&quot;</span>);
<a name="l01777"></a>01777         <span class="comment">/* Still finishe checkout even have I/O errors. */</span>
<a name="l01778"></a>01778     }
<a name="l01779"></a>01779 
<a name="l01780"></a>01780     <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
<a name="l01781"></a>01781     istate = topts.result;
<a name="l01782"></a>01782 
<a name="l01783"></a>01783     <span class="keywordflow">if</span> (<a class="code" href="vc-utils_8c.html#ab93fff6b962d6fd7482c95d17c8bf6eb">update_index</a> (&amp;istate, index_path) &lt; 0) {
<a name="l01784"></a>01784         seaf_warning (<span class="stringliteral">&quot;Failed to update index.\n&quot;</span>);
<a name="l01785"></a>01785         ret = -1;
<a name="l01786"></a>01786     }
<a name="l01787"></a>01787 
<a name="l01788"></a>01788 out:
<a name="l01789"></a>01789     tree_desc_free (&amp;trees[0]);
<a name="l01790"></a>01790     tree_desc_free (&amp;trees[1]);
<a name="l01791"></a>01791 
<a name="l01792"></a>01792     g_free (topts.crypt);
<a name="l01793"></a>01793 
<a name="l01794"></a>01794     <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
<a name="l01795"></a>01795 
<a name="l01796"></a>01796     <span class="keywordflow">return</span> ret;
<a name="l01797"></a>01797 }
<a name="l01798"></a>01798 
<a name="l01799"></a>01799 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01800"></a>01800 create_index_branch (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <span class="keyword">const</span> <span class="keywordtype">char</span> *root_id)
<a name="l01801"></a>01801 {
<a name="l01802"></a>01802     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit = NULL;
<a name="l01803"></a>01803     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch = NULL;
<a name="l01804"></a>01804     <span class="keywordtype">int</span> ret = 0;
<a name="l01805"></a>01805 
<a name="l01806"></a>01806     commit = <a class="code" href="commit-mgr_8c.html#afe68dfa15b1bbd8557b044b1b1b58dc2">seaf_commit_new</a> (NULL, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, root_id,
<a name="l01807"></a>01807                               repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a> ? repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a>
<a name="l01808"></a>01808                               : <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a7acba9a9723ea082afbcd1032be5b6de">base</a>.<a class="code" href="struct__CcnetSessionBase.html#acb921a00a3498928d68d4a5b42c1ece4">user_name</a>,
<a name="l01809"></a>01809                               <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a7acba9a9723ea082afbcd1032be5b6de">base</a>.<a class="code" href="struct__CcnetSessionBase.html#a00a892cc14aa52514c079730b460852e">id</a>,
<a name="l01810"></a>01810                               <span class="stringliteral">&quot;Temp commit for index&quot;</span>, 0);
<a name="l01811"></a>01811     <a class="code" href="daemon_2repo-mgr_8c.html#a39a9a41ffdfc324f3c935251d9e14d51">seaf_repo_to_commit</a> (repo, commit);
<a name="l01812"></a>01812     <span class="keywordflow">if</span> (<a class="code" href="commit-mgr_8c.html#a7c138604e615440b65741b77e71248c6">seaf_commit_manager_add_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>, commit) &lt; 0) {
<a name="l01813"></a>01813         seaf_warning (<span class="stringliteral">&quot;Failed to add commit.\n&quot;</span>);
<a name="l01814"></a>01814         ret = -1;
<a name="l01815"></a>01815         <span class="keywordflow">goto</span> out;
<a name="l01816"></a>01816     }
<a name="l01817"></a>01817 
<a name="l01818"></a>01818     branch = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="stringliteral">&quot;index&quot;</span>);
<a name="l01819"></a>01819     <span class="keywordflow">if</span> (!branch) {
<a name="l01820"></a>01820         branch = <a class="code" href="branch-mgr_8c.html#a4d213520d8a22d5191051715ccbfd1dd">seaf_branch_new</a> (<span class="stringliteral">&quot;index&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>);
<a name="l01821"></a>01821         <span class="keywordflow">if</span> (<a class="code" href="branch-mgr_8c.html#ab67819118ec82d96e51f6c2cadd7a632">seaf_branch_manager_add_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, branch) &lt; 0) {
<a name="l01822"></a>01822             seaf_warning (<span class="stringliteral">&quot;Failed to add branch.\n&quot;</span>);
<a name="l01823"></a>01823             ret = -1;
<a name="l01824"></a>01824             <span class="keywordflow">goto</span> out;
<a name="l01825"></a>01825         }
<a name="l01826"></a>01826     } <span class="keywordflow">else</span> {
<a name="l01827"></a>01827         <a class="code" href="branch-mgr_8c.html#a7a776ebd084d2335050c68d9a2e10c18">seaf_branch_set_commit</a> (branch, commit-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>);
<a name="l01828"></a>01828         <a class="code" href="branch-mgr_8c.html#aab1588f5228eaf4405efb239a9ed5680">seaf_branch_manager_update_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, branch);
<a name="l01829"></a>01829     }
<a name="l01830"></a>01830 
<a name="l01831"></a>01831 out:
<a name="l01832"></a>01832     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
<a name="l01833"></a>01833     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l01834"></a>01834     <span class="keywordflow">return</span> ret;
<a name="l01835"></a>01835 }
<a name="l01836"></a>01836 
<a name="l01837"></a>01837 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l01838"></a>01838 merge_job (<span class="keywordtype">void</span> *data)
<a name="l01839"></a>01839 {
<a name="l01840"></a>01840     <a class="code" href="structMergeAux.html">MergeAux</a> *aux = data;
<a name="l01841"></a>01841     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task = aux-&gt;<a class="code" href="structMergeAux.html#a78b01e9fbebdec145226205797739e32">task</a>;
<a name="l01842"></a>01842     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = aux-&gt;<a class="code" href="structMergeAux.html#a9f6ce9ad11838dedc3c61d06bd923ca2">repo</a>;
<a name="l01843"></a>01843     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *local = NULL;
<a name="l01844"></a>01844     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head = NULL;
<a name="l01845"></a>01845     gboolean is_ff;
<a name="l01846"></a>01846 
<a name="l01847"></a>01847     local = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="stringliteral">&quot;local&quot;</span>);
<a name="l01848"></a>01848     <span class="keywordflow">if</span> (!local) {
<a name="l01849"></a>01849         aux-&gt;<a class="code" href="structMergeAux.html#aae68089a96de72f370fcc130e24c06c0">success</a> = FALSE;
<a name="l01850"></a>01850         <span class="keywordflow">goto</span> out;
<a name="l01851"></a>01851     }
<a name="l01852"></a>01852 
<a name="l01853"></a>01853     head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l01854"></a>01854                                            repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
<a name="l01855"></a>01855                                            local-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l01856"></a>01856     <span class="keywordflow">if</span> (!head) {
<a name="l01857"></a>01857         aux-&gt;<a class="code" href="structMergeAux.html#aae68089a96de72f370fcc130e24c06c0">success</a> = FALSE;
<a name="l01858"></a>01858         <span class="keywordflow">goto</span> out;
<a name="l01859"></a>01859     }
<a name="l01860"></a>01860 
<a name="l01861"></a>01861     <span class="keywordflow">if</span> (aux-&gt;<a class="code" href="structMergeAux.html#a6355a80568182d386f1630582298afdd">check_ff_in_thread</a>)
<a name="l01862"></a>01862         is_ff = check_fast_forward (head, task-&gt;<a class="code" href="struct__CloneTask.html#ababd2533c456b735b93e76d0b7eac4dc">root_id</a>);
<a name="l01863"></a>01863     <span class="keywordflow">else</span>
<a name="l01864"></a>01864         is_ff = aux-&gt;<a class="code" href="structMergeAux.html#a30a4e39242274c7ec372e39ad7e602b0">is_fast_forward</a>;
<a name="l01865"></a>01865 
<a name="l01866"></a>01866     <span class="keywordflow">if</span> (is_ff) {
<a name="l01867"></a>01867         seaf_debug (<span class="stringliteral">&quot;[clone mgr] Fast forward.\n&quot;</span>);
<a name="l01868"></a>01868         <span class="keywordflow">if</span> (fast_forward_checkout (repo, head, task) &lt; 0)
<a name="l01869"></a>01869             <span class="keywordflow">goto</span> out;
<a name="l01870"></a>01870     } <span class="keywordflow">else</span> {
<a name="l01871"></a>01871         <span class="keywordflow">if</span> (real_merge (repo, head, task) &lt; 0)
<a name="l01872"></a>01872             <span class="keywordflow">goto</span> out;
<a name="l01873"></a>01873 
<a name="l01874"></a>01874         <span class="comment">/* Create a temp branch &quot;index&quot; which references to task-&gt;root_id,</span>
<a name="l01875"></a>01875 <span class="comment">         * so that new changes from the worktree won&#39;t be removed by GC.</span>
<a name="l01876"></a>01876 <span class="comment">         * This branch should be deleted on the first commit operation of</span>
<a name="l01877"></a>01877 <span class="comment">         * the repo.</span>
<a name="l01878"></a>01878 <span class="comment">         */</span>
<a name="l01879"></a>01879         <span class="keywordflow">if</span> (create_index_branch (repo, task-&gt;<a class="code" href="struct__CloneTask.html#ababd2533c456b735b93e76d0b7eac4dc">root_id</a>) &lt; 0)
<a name="l01880"></a>01880             <span class="keywordflow">goto</span> out;
<a name="l01881"></a>01881     }
<a name="l01882"></a>01882 
<a name="l01883"></a>01883     <span class="comment">/* Save head id for GC. */</span>
<a name="l01884"></a>01884     <a class="code" href="daemon_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l01885"></a>01885                                          repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l01886"></a>01886                                          <a class="code" href="daemon_2repo-mgr_8h.html#af63040384723b88eb87e261c8ebb298b">REPO_REMOTE_HEAD</a>,
<a name="l01887"></a>01887                                          head-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>);
<a name="l01888"></a>01888     <a class="code" href="daemon_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l01889"></a>01889                                          repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l01890"></a>01890                                          <a class="code" href="daemon_2repo-mgr_8h.html#ab09a088f0dfff9872d5dfb605ed1cade">REPO_LOCAL_HEAD</a>,
<a name="l01891"></a>01891                                          head-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>);
<a name="l01892"></a>01892 
<a name="l01893"></a>01893     aux-&gt;<a class="code" href="structMergeAux.html#aae68089a96de72f370fcc130e24c06c0">success</a> = TRUE;
<a name="l01894"></a>01894 
<a name="l01895"></a>01895 out:
<a name="l01896"></a>01896     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (local);
<a name="l01897"></a>01897     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (head);
<a name="l01898"></a>01898     <span class="keywordflow">return</span> aux;
<a name="l01899"></a>01899 }
<a name="l01900"></a>01900 
<a name="l01901"></a>01901 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01902"></a>01902 merge_job_done (<span class="keywordtype">void</span> *data)
<a name="l01903"></a>01903 {
<a name="l01904"></a>01904     <a class="code" href="structMergeAux.html">MergeAux</a> *aux = data;
<a name="l01905"></a>01905     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task = aux-&gt;<a class="code" href="structMergeAux.html#a78b01e9fbebdec145226205797739e32">task</a>;
<a name="l01906"></a>01906     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = aux-&gt;<a class="code" href="structMergeAux.html#a9f6ce9ad11838dedc3c61d06bd923ca2">repo</a>;
<a name="l01907"></a>01907     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *local = NULL;
<a name="l01908"></a>01908 
<a name="l01909"></a>01909     <span class="keywordflow">if</span> (!aux-&gt;<a class="code" href="structMergeAux.html#aae68089a96de72f370fcc130e24c06c0">success</a>) {
<a name="l01910"></a>01910         <span class="keywordflow">goto</span> error;
<a name="l01911"></a>01911     }
<a name="l01912"></a>01912 
<a name="l01913"></a>01913     <a class="code" href="daemon_2repo-mgr_8c.html#a6ed05df6501a326fc58a0fefb91aef3d">seaf_repo_manager_set_repo_worktree</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>,
<a name="l01914"></a>01914                                          repo,
<a name="l01915"></a>01915                                          task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>);
<a name="l01916"></a>01916 
<a name="l01917"></a>01917     local = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="stringliteral">&quot;local&quot;</span>);
<a name="l01918"></a>01918     <span class="keywordflow">if</span> (!local) {
<a name="l01919"></a>01919         seaf_warning (<span class="stringliteral">&quot;Cannot get branch local for repo %s(%.10s).\n&quot;</span>,
<a name="l01920"></a>01920                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01921"></a>01921         <span class="keywordflow">goto</span> error;
<a name="l01922"></a>01922     }
<a name="l01923"></a>01923     <span class="comment">/* Set repo head to mark checkout done. */</span>
<a name="l01924"></a>01924     <a class="code" href="daemon_2repo-mgr_8c.html#a6c47d6277897f6afbe866f2755f9762d">seaf_repo_set_head</a> (repo, local);
<a name="l01925"></a>01925     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (local);
<a name="l01926"></a>01926 
<a name="l01927"></a>01927     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a>) {
<a name="l01928"></a>01928         <span class="keywordflow">if</span> (<a class="code" href="wt-monitor_8c.html#aa6375a36881f0c171399a5116e64f061">seaf_wt_monitor_watch_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a64fc6ad3e80ab34bd2d5ac10dfc1aa66">wt_monitor</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>) &lt; 0) {
<a name="l01929"></a>01929             seaf_warning (<span class="stringliteral">&quot;failed to watch repo %s(%.10s).\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01930"></a>01930             <span class="keywordflow">goto</span> error;
<a name="l01931"></a>01931         }
<a name="l01932"></a>01932     }
<a name="l01933"></a>01933 
<a name="l01934"></a>01934     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> == <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a7c3d6e2ad24a7e0f2adf534a42b235bc">CLONE_STATE_CANCEL_PENDING</a>)
<a name="l01935"></a>01935         transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a5b171455c76672ef5f3808bbc9267cc3">CLONE_STATE_CANCELED</a>);
<a name="l01936"></a>01936     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> == <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a54946986c45281155e2e59421c8a8a77">CLONE_STATE_MERGE</a>) {
<a name="l01937"></a>01937         transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8af1c3a28143f803ec77f12421a745c80e">CLONE_STATE_DONE</a>);
<a name="l01938"></a>01938     }
<a name="l01939"></a>01939 
<a name="l01940"></a>01940     g_free (aux);
<a name="l01941"></a>01941     <span class="keywordflow">return</span>;
<a name="l01942"></a>01942 
<a name="l01943"></a>01943 error:
<a name="l01944"></a>01944     g_free (aux);
<a name="l01945"></a>01945     transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea89d696de87ac7ac0a518b578847dc888">CLONE_ERROR_MERGE</a>);
<a name="l01946"></a>01946     <span class="keywordflow">return</span>;
<a name="l01947"></a>01947 }
<a name="l01948"></a>01948 
<a name="l01949"></a>01949 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01950"></a>01950 setup_repo_without_checkout (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *local, <a class="code" href="struct__CloneTask.html">CloneTask</a> *task)
<a name="l01951"></a>01951 {
<a name="l01952"></a>01952     <span class="keywordflow">if</span> (create_index_branch (repo, task-&gt;<a class="code" href="struct__CloneTask.html#ababd2533c456b735b93e76d0b7eac4dc">root_id</a>) &lt; 0) {
<a name="l01953"></a>01953         transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea89d696de87ac7ac0a518b578847dc888">CLONE_ERROR_MERGE</a>);
<a name="l01954"></a>01954         <span class="keywordflow">return</span>;
<a name="l01955"></a>01955     }
<a name="l01956"></a>01956 
<a name="l01957"></a>01957     <a class="code" href="daemon_2repo-mgr_8c.html#a6ed05df6501a326fc58a0fefb91aef3d">seaf_repo_manager_set_repo_worktree</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>,
<a name="l01958"></a>01958                                          repo,
<a name="l01959"></a>01959                                          task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>);
<a name="l01960"></a>01960 
<a name="l01961"></a>01961     <span class="comment">/* Set repo head to mark checkout done. */</span>
<a name="l01962"></a>01962     <a class="code" href="daemon_2repo-mgr_8c.html#a6c47d6277897f6afbe866f2755f9762d">seaf_repo_set_head</a> (repo, local);
<a name="l01963"></a>01963 
<a name="l01964"></a>01964     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a>) {
<a name="l01965"></a>01965         <span class="keywordflow">if</span> (<a class="code" href="wt-monitor_8c.html#aa6375a36881f0c171399a5116e64f061">seaf_wt_monitor_watch_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a64fc6ad3e80ab34bd2d5ac10dfc1aa66">wt_monitor</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>) &lt; 0) {
<a name="l01966"></a>01966             seaf_warning (<span class="stringliteral">&quot;failed to watch repo %s(%.10s).\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01967"></a>01967         }
<a name="l01968"></a>01968     }
<a name="l01969"></a>01969 
<a name="l01970"></a>01970     <span class="comment">/* Save head id for GC. */</span>
<a name="l01971"></a>01971     <a class="code" href="daemon_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l01972"></a>01972                                          repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l01973"></a>01973                                          <a class="code" href="daemon_2repo-mgr_8h.html#af63040384723b88eb87e261c8ebb298b">REPO_REMOTE_HEAD</a>,
<a name="l01974"></a>01974                                          local-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l01975"></a>01975     <a class="code" href="daemon_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l01976"></a>01976                                          repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l01977"></a>01977                                          <a class="code" href="daemon_2repo-mgr_8h.html#ab09a088f0dfff9872d5dfb605ed1cade">REPO_LOCAL_HEAD</a>,
<a name="l01978"></a>01978                                          local-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l01979"></a>01979 
<a name="l01980"></a>01980     transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8af1c3a28143f803ec77f12421a745c80e">CLONE_STATE_DONE</a>);
<a name="l01981"></a>01981 }
<a name="l01982"></a>01982 
<a name="l01983"></a>01983 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01984"></a>01984 checkff_done (<a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor, gboolean success, <span class="keywordtype">void</span> *data)
<a name="l01985"></a>01985 {
<a name="l01986"></a>01986     <a class="code" href="struct__SeafileCheckffProc.html">SeafileCheckffProc</a> *proc = (<a class="code" href="struct__SeafileCheckffProc.html">SeafileCheckffProc</a> *)processor;
<a name="l01987"></a>01987     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task = data;
<a name="l01988"></a>01988 
<a name="l01989"></a>01989     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> == <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a7c3d6e2ad24a7e0f2adf534a42b235bc">CLONE_STATE_CANCEL_PENDING</a>) {
<a name="l01990"></a>01990         transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a5b171455c76672ef5f3808bbc9267cc3">CLONE_STATE_CANCELED</a>);
<a name="l01991"></a>01991         <span class="keywordflow">return</span>;
<a name="l01992"></a>01992     }
<a name="l01993"></a>01993 
<a name="l01994"></a>01994     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>);
<a name="l01995"></a>01995     <span class="keywordflow">if</span> (!repo) {
<a name="l01996"></a>01996         seaf_warning (<span class="stringliteral">&quot;Failed to get repo %s.\n&quot;</span>, task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>);
<a name="l01997"></a>01997         transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea89d696de87ac7ac0a518b578847dc888">CLONE_ERROR_MERGE</a>);
<a name="l01998"></a>01998         <span class="keywordflow">return</span>;
<a name="l01999"></a>01999     }
<a name="l02000"></a>02000 
<a name="l02001"></a>02001     <a class="code" href="structMergeAux.html">MergeAux</a> *aux = g_new0 (<a class="code" href="structMergeAux.html">MergeAux</a>, 1);
<a name="l02002"></a>02002     aux-&gt;<a class="code" href="structMergeAux.html#a78b01e9fbebdec145226205797739e32">task</a> = task;
<a name="l02003"></a>02003     aux-&gt;<a class="code" href="structMergeAux.html#a9f6ce9ad11838dedc3c61d06bd923ca2">repo</a> = repo;
<a name="l02004"></a>02004 
<a name="l02005"></a>02005     <span class="comment">/* If checkff proc fails, we&#39;re talking to an older server which doesn&#39;t support</span>
<a name="l02006"></a>02006 <span class="comment">     * this processor. In that case transfer manager should have downloaded</span>
<a name="l02007"></a>02007 <span class="comment">     * all history commits from the server. So we can still check ff locally in the</span>
<a name="l02008"></a>02008 <span class="comment">     * merge thread.</span>
<a name="l02009"></a>02009 <span class="comment">     */</span>
<a name="l02010"></a>02010     <span class="keywordflow">if</span> (success) {
<a name="l02011"></a>02011         aux-&gt;<a class="code" href="structMergeAux.html#a30a4e39242274c7ec372e39ad7e602b0">is_fast_forward</a> = proc-&gt;<a class="code" href="struct__SeafileCheckffProc.html#a8ce4ab770f788cd5ef7ea9c0e827fba3">is_fast_forward</a>;
<a name="l02012"></a>02012         aux-&gt;<a class="code" href="structMergeAux.html#a6355a80568182d386f1630582298afdd">check_ff_in_thread</a> = FALSE;
<a name="l02013"></a>02013     } <span class="keywordflow">else</span> {
<a name="l02014"></a>02014         aux-&gt;<a class="code" href="structMergeAux.html#a30a4e39242274c7ec372e39ad7e602b0">is_fast_forward</a> = FALSE;
<a name="l02015"></a>02015         aux-&gt;<a class="code" href="structMergeAux.html#a6355a80568182d386f1630582298afdd">check_ff_in_thread</a> = TRUE;
<a name="l02016"></a>02016     }
<a name="l02017"></a>02017 
<a name="l02018"></a>02018     <a class="code" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768">ccnet_job_manager_schedule_job</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#abcbb9886e315abb16c620ce49808a0b2">job_mgr</a>,
<a name="l02019"></a>02019                                     merge_job,
<a name="l02020"></a>02020                                     merge_job_done,
<a name="l02021"></a>02021                                     aux);
<a name="l02022"></a>02022 }
<a name="l02023"></a>02023 
<a name="l02024"></a>02024 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02025"></a>02025 start_checkff_proc (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task)
<a name="l02026"></a>02026 {
<a name="l02027"></a>02027     <a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor;
<a name="l02028"></a>02028 
<a name="l02029"></a>02029     processor = <a class="code" href="include_2ccnet_2proc-factory_8h.html#a4e77de8f2768695e93845129041759c7">ccnet_proc_factory_create_remote_master_processor</a> (
<a name="l02030"></a>02030         <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>, <span class="stringliteral">&quot;seafile-checkff&quot;</span>, task-&gt;<a class="code" href="struct__CloneTask.html#a96fa052d9fc866a313ecad95b93a4197">peer_id</a>);
<a name="l02031"></a>02031     <span class="keywordflow">if</span> (!processor) {
<a name="l02032"></a>02032         seaf_warning (<span class="stringliteral">&quot;failed to create checkff proc.\n&quot;</span>);
<a name="l02033"></a>02033         <span class="keywordflow">return</span> -1;
<a name="l02034"></a>02034     }
<a name="l02035"></a>02035 
<a name="l02036"></a>02036     g_signal_connect (processor, <span class="stringliteral">&quot;done&quot;</span>, (GCallback)checkff_done, task);
<a name="l02037"></a>02037 
<a name="l02038"></a>02038     <span class="keywordflow">if</span> (<a class="code" href="include_2ccnet_2processor_8h.html#ae2bb4b51c8e7dd43366b777ca9b00cf6">ccnet_processor_startl</a> (processor, task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>, task-&gt;<a class="code" href="struct__CloneTask.html#ababd2533c456b735b93e76d0b7eac4dc">root_id</a>, NULL) &lt; 0) {
<a name="l02039"></a>02039         seaf_warning (<span class="stringliteral">&quot;failed to start checkff proc.\n&quot;</span>);
<a name="l02040"></a>02040         <span class="keywordflow">return</span> -1;
<a name="l02041"></a>02041     }
<a name="l02042"></a>02042 
<a name="l02043"></a>02043     <span class="keywordflow">return</span> 0;
<a name="l02044"></a>02044 }
<a name="l02045"></a>02045 
<a name="l02046"></a>02046 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02047"></a>02047 index_files_before_merge_done (<span class="keywordtype">void</span> *result)
<a name="l02048"></a>02048 {
<a name="l02049"></a>02049     <a class="code" href="structIndexAux.html">IndexAux</a> *aux = result;
<a name="l02050"></a>02050     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task = aux-&gt;<a class="code" href="structIndexAux.html#a2e8f18933b64010c6ae719ce7df328ff">task</a>;
<a name="l02051"></a>02051 
<a name="l02052"></a>02052     <span class="keywordflow">if</span> (!aux-&gt;<a class="code" href="structIndexAux.html#a3cf2ed4b8d7f4ad1db98dbe5344a16c4">success</a>) {
<a name="l02053"></a>02053         transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea89d696de87ac7ac0a518b578847dc888">CLONE_ERROR_MERGE</a>);
<a name="l02054"></a>02054         <span class="keywordflow">goto</span> out;
<a name="l02055"></a>02055     }
<a name="l02056"></a>02056 
<a name="l02057"></a>02057     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> == <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a7c3d6e2ad24a7e0f2adf534a42b235bc">CLONE_STATE_CANCEL_PENDING</a>) {
<a name="l02058"></a>02058         transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a5b171455c76672ef5f3808bbc9267cc3">CLONE_STATE_CANCELED</a>);
<a name="l02059"></a>02059         <span class="keywordflow">goto</span> out;
<a name="l02060"></a>02060     }
<a name="l02061"></a>02061 
<a name="l02062"></a>02062     <span class="keywordflow">if</span> (start_checkff_proc (task) &lt; 0) {
<a name="l02063"></a>02063         transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea89d696de87ac7ac0a518b578847dc888">CLONE_ERROR_MERGE</a>);
<a name="l02064"></a>02064         <span class="keywordflow">goto</span> out;
<a name="l02065"></a>02065     }
<a name="l02066"></a>02066 
<a name="l02067"></a>02067 out:
<a name="l02068"></a>02068     g_free (aux);
<a name="l02069"></a>02069 }
<a name="l02070"></a>02070 
<a name="l02071"></a>02071 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02072"></a>02072 start_checkout (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <a class="code" href="struct__CloneTask.html">CloneTask</a> *task)
<a name="l02073"></a>02073 {
<a name="l02074"></a>02074     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a> &amp;&amp; task-&gt;<a class="code" href="struct__CloneTask.html#a474148b59212fcf1716cc6b975593264">passwd</a> != NULL) {
<a name="l02075"></a>02075         <span class="keywordflow">if</span> (<a class="code" href="daemon_2repo-mgr_8c.html#a683d25df06076d282da2f7ae01e05a49">seaf_repo_manager_set_repo_passwd</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l02076"></a>02076                                                repo,
<a name="l02077"></a>02077                                                task-&gt;<a class="code" href="struct__CloneTask.html#a474148b59212fcf1716cc6b975593264">passwd</a>) &lt; 0) {
<a name="l02078"></a>02078             seaf_warning (<span class="stringliteral">&quot;[Clone mgr] failed to set passwd for %s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02079"></a>02079             transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9eacb3d74adef1000d6f681754a40837713">CLONE_ERROR_INTERNAL</a>);
<a name="l02080"></a>02080             <span class="keywordflow">return</span>;
<a name="l02081"></a>02081         }
<a name="l02082"></a>02082     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
<a name="l02083"></a>02083         seaf_warning (<span class="stringliteral">&quot;[Clone mgr] Password is empty for encrypted repo %s.\n&quot;</span>,
<a name="l02084"></a>02084                    repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02085"></a>02085         transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea0e461a7a7140950d9f64c79e4bdd671e">CLONE_ERROR_PASSWD</a>);
<a name="l02086"></a>02086         <span class="keywordflow">return</span>;
<a name="l02087"></a>02087     }
<a name="l02088"></a>02088 
<a name="l02089"></a>02089     <span class="keywordflow">if</span> (g_access (task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>, F_OK) != 0 &amp;&amp;
<a name="l02090"></a>02090         g_mkdir_with_parents (task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>, 0777) &lt; 0) {
<a name="l02091"></a>02091         seaf_warning (<span class="stringliteral">&quot;[clone mgr] Failed to create worktree %s.\n&quot;</span>,
<a name="l02092"></a>02092                       task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>);
<a name="l02093"></a>02093         transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9eae9353f3bf90283c2d72cc51481fcaf46">CLONE_ERROR_CHECKOUT</a>);
<a name="l02094"></a>02094         <span class="keywordflow">return</span>;
<a name="l02095"></a>02095     }
<a name="l02096"></a>02096 
<a name="l02097"></a>02097     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *local;
<a name="l02098"></a>02098     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit;
<a name="l02099"></a>02099 
<a name="l02100"></a>02100     local = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="stringliteral">&quot;local&quot;</span>);
<a name="l02101"></a>02101     <span class="keywordflow">if</span> (!local) {
<a name="l02102"></a>02102         seaf_warning (<span class="stringliteral">&quot;Cannot get branch local for repo %s(%.10s).\n&quot;</span>,
<a name="l02103"></a>02103                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02104"></a>02104         transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9eae9353f3bf90283c2d72cc51481fcaf46">CLONE_ERROR_CHECKOUT</a>);
<a name="l02105"></a>02105         <span class="keywordflow">return</span>;
<a name="l02106"></a>02106     }
<a name="l02107"></a>02107 
<a name="l02108"></a>02108     commit = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l02109"></a>02109                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
<a name="l02110"></a>02110                                              local-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l02111"></a>02111     <span class="keywordflow">if</span> (!commit) {
<a name="l02112"></a>02112         seaf_warning (<span class="stringliteral">&quot;Failed to get commit %.8s.\n&quot;</span>, local-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l02113"></a>02113         transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9eae9353f3bf90283c2d72cc51481fcaf46">CLONE_ERROR_CHECKOUT</a>);
<a name="l02114"></a>02114         <span class="keywordflow">return</span>;
<a name="l02115"></a>02115     }
<a name="l02116"></a>02116 
<a name="l02117"></a>02117     <span class="comment">/* If remote head&#39;s tree is empty, we don&#39;t need to checkout or merge.</span>
<a name="l02118"></a>02118 <span class="comment">     * The result would be the current state of worktree anyway.</span>
<a name="l02119"></a>02119 <span class="comment">     */</span>
<a name="l02120"></a>02120     <span class="keywordflow">if</span> (strcmp (commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, <a class="code" href="seafile_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>) == 0) {
<a name="l02121"></a>02121         setup_repo_without_checkout (repo, local, task);
<a name="l02122"></a>02122         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (local);
<a name="l02123"></a>02123         <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
<a name="l02124"></a>02124         <span class="keywordflow">return</span>;
<a name="l02125"></a>02125     }
<a name="l02126"></a>02126 
<a name="l02127"></a>02127     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (local);
<a name="l02128"></a>02128     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
<a name="l02129"></a>02129 
<a name="l02130"></a>02130     <span class="keywordflow">if</span> (!is_non_empty_directory (task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>)) {
<a name="l02131"></a>02131         transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8ad8e45ae1a104379cb606fd2c05a7c6cd">CLONE_STATE_CHECKOUT</a>);
<a name="l02132"></a>02132         <a class="code" href="daemon_2repo-mgr_8c.html#ae2b1438737e8d1bebeb1e674013b02b5">seaf_repo_manager_add_checkout_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l02133"></a>02133                                              repo,
<a name="l02134"></a>02134                                              task-&gt;<a class="code" href="struct__CloneTask.html#a1d415384ea992d92e436c07bfc72a69d">worktree</a>,
<a name="l02135"></a>02135                                              on_checkout_done,
<a name="l02136"></a>02136                                              task-&gt;<a class="code" href="struct__CloneTask.html#a3028c18408cdca62d9f0cc68d03bd121">manager</a>);
<a name="l02137"></a>02137     } <span class="keywordflow">else</span> {
<a name="l02138"></a>02138         transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a54946986c45281155e2e59421c8a8a77">CLONE_STATE_MERGE</a>);
<a name="l02139"></a>02139 
<a name="l02140"></a>02140         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#ababd2533c456b735b93e76d0b7eac4dc">root_id</a>[0] == 0) {
<a name="l02141"></a>02141             <span class="comment">/* If the task is restarted, root_id may not be calculated yet. */</span>
<a name="l02142"></a>02142             <a class="code" href="structIndexAux.html">IndexAux</a> *aux = g_new0 (<a class="code" href="structIndexAux.html">IndexAux</a>, 1);
<a name="l02143"></a>02143             aux-&gt;<a class="code" href="structIndexAux.html#a2e8f18933b64010c6ae719ce7df328ff">task</a> = task;
<a name="l02144"></a>02144 
<a name="l02145"></a>02145             <a class="code" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768">ccnet_job_manager_schedule_job</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#abcbb9886e315abb16c620ce49808a0b2">job_mgr</a>,
<a name="l02146"></a>02146                                             index_files_job,
<a name="l02147"></a>02147                                             index_files_before_merge_done,
<a name="l02148"></a>02148                                             aux);
<a name="l02149"></a>02149         } <span class="keywordflow">else</span> {
<a name="l02150"></a>02150             <span class="comment">/* Since we don&#39;t have complete history on the client, start a </span>
<a name="l02151"></a>02151 <span class="comment">             * processor to check if task-&gt;root_id exist in the history on the server.</span>
<a name="l02152"></a>02152 <span class="comment">             * That means there is no change in the worktree after the last unsync.</span>
<a name="l02153"></a>02153 <span class="comment">             */</span>
<a name="l02154"></a>02154             <span class="keywordflow">if</span> (start_checkff_proc (task) &lt; 0) {
<a name="l02155"></a>02155                 transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea89d696de87ac7ac0a518b578847dc888">CLONE_ERROR_MERGE</a>);
<a name="l02156"></a>02156                 <span class="keywordflow">return</span>;
<a name="l02157"></a>02157             }
<a name="l02158"></a>02158         }
<a name="l02159"></a>02159     }
<a name="l02160"></a>02160 }
<a name="l02161"></a>02161 
<a name="l02162"></a>02162 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02163"></a>02163 check_folder_permissions (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task);
<a name="l02164"></a>02164 
<a name="l02165"></a>02165 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02166"></a>02166 on_repo_fetched (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>,
<a name="l02167"></a>02167                  <a class="code" href="struct__TransferTask.html">TransferTask</a> *tx_task,
<a name="l02168"></a>02168                  <a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr)
<a name="l02169"></a>02169 {
<a name="l02170"></a>02170     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task;
<a name="l02171"></a>02171 
<a name="l02172"></a>02172     <span class="comment">/* Only handle clone task. */</span>
<a name="l02173"></a>02173     <span class="keywordflow">if</span> (!tx_task-&gt;<a class="code" href="struct__TransferTask.html#a4462883da6780feae2b41060e5b48456">is_clone</a>)
<a name="l02174"></a>02174         <span class="keywordflow">return</span>;
<a name="l02175"></a>02175 
<a name="l02176"></a>02176     task = g_hash_table_lookup (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#ac27110eab926004781f02c7b5e4d0370">tasks</a>, tx_task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>);
<a name="l02177"></a>02177     g_return_if_fail (task != NULL);
<a name="l02178"></a>02178 
<a name="l02179"></a>02179     <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> == <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaae36dd6c8f3e2e25e7946660ec15cf7d">TASK_STATE_CANCELED</a>) {
<a name="l02180"></a>02180         <span class="comment">/* g_assert (task-&gt;state == CLONE_STATE_CANCEL_PENDING); */</span>
<a name="l02181"></a>02181         transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a5b171455c76672ef5f3808bbc9267cc3">CLONE_STATE_CANCELED</a>);
<a name="l02182"></a>02182         <span class="keywordflow">return</span>;
<a name="l02183"></a>02183     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> == <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaeef2d65ee28a06d4dad01ed46ab8c213">TASK_STATE_ERROR</a>) {
<a name="l02184"></a>02184         <span class="comment">/* transition_to_error (task, CLONE_ERROR_FETCH); */</span>
<a name="l02185"></a>02185         <span class="comment">/* Always restart failed clone task. */</span>
<a name="l02186"></a>02186         <span class="keywordflow">if</span> (add_transfer_task (task, NULL) == 0)
<a name="l02187"></a>02187             transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8ae67f39ebed40e85b2d90de1f3119edca">CLONE_STATE_FETCH</a>);
<a name="l02188"></a>02188         <span class="keywordflow">else</span>
<a name="l02189"></a>02189             transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea970814942feca38b0d4dbced3393be65">CLONE_ERROR_FETCH</a>);
<a name="l02190"></a>02190         <span class="keywordflow">return</span>;
<a name="l02191"></a>02191     }
<a name="l02192"></a>02192 
<a name="l02193"></a>02193     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l02194"></a>02194                                                  tx_task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>);
<a name="l02195"></a>02195     <span class="keywordflow">if</span> (repo == NULL) {
<a name="l02196"></a>02196         seaf_warning (<span class="stringliteral">&quot;[Clone mgr] cannot find repo %s after fetched.\n&quot;</span>, 
<a name="l02197"></a>02197                    tx_task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>);
<a name="l02198"></a>02198         transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9eacb3d74adef1000d6f681754a40837713">CLONE_ERROR_INTERNAL</a>);
<a name="l02199"></a>02199         <span class="keywordflow">return</span>;
<a name="l02200"></a>02200     }
<a name="l02201"></a>02201 
<a name="l02202"></a>02202     <a class="code" href="daemon_2repo-mgr_8c.html#a4fdafbeb326de99eec7160b72bcc3dd4">seaf_repo_manager_set_repo_token</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo, task-&gt;<a class="code" href="struct__CloneTask.html#a8e19296e76e4b3dec6b4dfcf4fab5342">token</a>);
<a name="l02203"></a>02203     <a class="code" href="daemon_2repo-mgr_8c.html#a4f525e2d8e12d4d8afab74b4291c24d3">seaf_repo_manager_set_repo_email</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo, task-&gt;<a class="code" href="struct__CloneTask.html#a4b875dabcf508a393d9bf8696c204dae">email</a>);
<a name="l02204"></a>02204     <a class="code" href="daemon_2repo-mgr_8c.html#a8539157b5ddbb1e183886ac3f03b0f0d">seaf_repo_manager_set_repo_relay_info</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l02205"></a>02205                                            task-&gt;<a class="code" href="struct__CloneTask.html#a42281f48e42f5e3766d31dfdca199bb1">peer_addr</a>, task-&gt;<a class="code" href="struct__CloneTask.html#af6e520f57dd7b32106a88ebd42f3d5b1">peer_port</a>);
<a name="l02206"></a>02206     <a class="code" href="daemon_2repo-mgr_8c.html#ad2263393047e4ea1f5226842b11e7b05">seaf_repo_manager_set_repo_relay_id</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo, task-&gt;<a class="code" href="struct__CloneTask.html#a96fa052d9fc866a313ecad95b93a4197">peer_id</a>);
<a name="l02207"></a>02207     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a>) {
<a name="l02208"></a>02208         <a class="code" href="daemon_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l02209"></a>02209                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l02210"></a>02210                                              <a class="code" href="daemon_2repo-mgr_8h.html#a55797c21d6209596736b5a81a8411ff9">REPO_PROP_SERVER_URL</a>,
<a name="l02211"></a>02211                                              task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a>);
<a name="l02212"></a>02212     }
<a name="l02213"></a>02213 
<a name="l02214"></a>02214     <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__CloneTask.html#a3ed371dcb52612faf91b1ff4501a8f66">server_side_merge</a>)
<a name="l02215"></a>02215         start_checkout (repo, task);
<a name="l02216"></a>02216     <span class="keywordflow">else</span>
<a name="l02217"></a>02217         check_folder_permissions (task);
<a name="l02218"></a>02218 }
<a name="l02219"></a>02219 
<a name="l02220"></a>02220 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02221"></a>02221 on_repo_http_fetched (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *seaf,
<a name="l02222"></a>02222                       <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *tx_task,
<a name="l02223"></a>02223                       <a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr)
<a name="l02224"></a>02224 {
<a name="l02225"></a>02225     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task;
<a name="l02226"></a>02226 
<a name="l02227"></a>02227     <span class="comment">/* Only handle clone task. */</span>
<a name="l02228"></a>02228     <span class="keywordflow">if</span> (!tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#a8dc7ba305c249ab73ce9424725776d41">is_clone</a>)
<a name="l02229"></a>02229         <span class="keywordflow">return</span>;
<a name="l02230"></a>02230 
<a name="l02231"></a>02231     task = g_hash_table_lookup (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#ac27110eab926004781f02c7b5e4d0370">tasks</a>, tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02232"></a>02232     g_return_if_fail (task != NULL);
<a name="l02233"></a>02233 
<a name="l02234"></a>02234     <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>) {
<a name="l02235"></a>02235         <span class="comment">/* g_assert (task-&gt;state == CLONE_STATE_CANCEL_PENDING); */</span>
<a name="l02236"></a>02236         transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a5b171455c76672ef5f3808bbc9267cc3">CLONE_STATE_CANCELED</a>);
<a name="l02237"></a>02237         <span class="keywordflow">return</span>;
<a name="l02238"></a>02238     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5a7829485480889c6958e5ddd2996b05ff">HTTP_TASK_STATE_ERROR</a>) {
<a name="l02239"></a>02239         transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea970814942feca38b0d4dbced3393be65">CLONE_ERROR_FETCH</a>);
<a name="l02240"></a>02240         <span class="keywordflow">return</span>;
<a name="l02241"></a>02241     }
<a name="l02242"></a>02242 
<a name="l02243"></a>02243     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l02244"></a>02244                                                  tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02245"></a>02245     <span class="keywordflow">if</span> (repo == NULL) {
<a name="l02246"></a>02246         seaf_warning (<span class="stringliteral">&quot;[Clone mgr] cannot find repo %s after fetched.\n&quot;</span>, 
<a name="l02247"></a>02247                    tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02248"></a>02248         transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9eacb3d74adef1000d6f681754a40837713">CLONE_ERROR_INTERNAL</a>);
<a name="l02249"></a>02249         <span class="keywordflow">return</span>;
<a name="l02250"></a>02250     }
<a name="l02251"></a>02251 
<a name="l02252"></a>02252     <a class="code" href="daemon_2repo-mgr_8c.html#a4fdafbeb326de99eec7160b72bcc3dd4">seaf_repo_manager_set_repo_token</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo, task-&gt;<a class="code" href="struct__CloneTask.html#a8e19296e76e4b3dec6b4dfcf4fab5342">token</a>);
<a name="l02253"></a>02253     <a class="code" href="daemon_2repo-mgr_8c.html#a4f525e2d8e12d4d8afab74b4291c24d3">seaf_repo_manager_set_repo_email</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo, task-&gt;<a class="code" href="struct__CloneTask.html#a4b875dabcf508a393d9bf8696c204dae">email</a>);
<a name="l02254"></a>02254     <a class="code" href="daemon_2repo-mgr_8c.html#a8539157b5ddbb1e183886ac3f03b0f0d">seaf_repo_manager_set_repo_relay_info</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l02255"></a>02255                                            task-&gt;<a class="code" href="struct__CloneTask.html#a42281f48e42f5e3766d31dfdca199bb1">peer_addr</a>, task-&gt;<a class="code" href="struct__CloneTask.html#af6e520f57dd7b32106a88ebd42f3d5b1">peer_port</a>);
<a name="l02256"></a>02256     <a class="code" href="daemon_2repo-mgr_8c.html#ad2263393047e4ea1f5226842b11e7b05">seaf_repo_manager_set_repo_relay_id</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo, task-&gt;<a class="code" href="struct__CloneTask.html#a96fa052d9fc866a313ecad95b93a4197">peer_id</a>);
<a name="l02257"></a>02257     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a>) {
<a name="l02258"></a>02258         <a class="code" href="daemon_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l02259"></a>02259                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l02260"></a>02260                                              <a class="code" href="daemon_2repo-mgr_8h.html#a55797c21d6209596736b5a81a8411ff9">REPO_PROP_SERVER_URL</a>,
<a name="l02261"></a>02261                                              task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a>);
<a name="l02262"></a>02262     }
<a name="l02263"></a>02263 
<a name="l02264"></a>02264     check_folder_permissions (task);
<a name="l02265"></a>02265 }
<a name="l02266"></a>02266 
<a name="l02267"></a>02267 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02268"></a>02268 on_checkout_done (<a class="code" href="structCheckoutTask.html">CheckoutTask</a> *ctask, <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <span class="keywordtype">void</span> *data)
<a name="l02269"></a>02269 {
<a name="l02270"></a>02270     <a class="code" href="struct__SeafCloneManager.html">SeafCloneManager</a> *mgr = data;
<a name="l02271"></a>02271     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task = g_hash_table_lookup (mgr-&gt;<a class="code" href="struct__SeafCloneManager.html#ac27110eab926004781f02c7b5e4d0370">tasks</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02272"></a>02272     g_return_if_fail (task != NULL);
<a name="l02273"></a>02273 
<a name="l02274"></a>02274     <span class="keywordflow">if</span> (!ctask-&gt;<a class="code" href="structCheckoutTask.html#a1a6e214f7718e025a661ded5f5b9214d">success</a>) {
<a name="l02275"></a>02275         transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9eae9353f3bf90283c2d72cc51481fcaf46">CLONE_ERROR_CHECKOUT</a>);
<a name="l02276"></a>02276         <span class="keywordflow">return</span>;
<a name="l02277"></a>02277     }
<a name="l02278"></a>02278 
<a name="l02279"></a>02279     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> == <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a7c3d6e2ad24a7e0f2adf534a42b235bc">CLONE_STATE_CANCEL_PENDING</a>)
<a name="l02280"></a>02280         transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8a5b171455c76672ef5f3808bbc9267cc3">CLONE_STATE_CANCELED</a>);
<a name="l02281"></a>02281     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__CloneTask.html#aba8f694c35ee581602d51889dfcc6851">state</a> == <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8ad8e45ae1a104379cb606fd2c05a7c6cd">CLONE_STATE_CHECKOUT</a>) {
<a name="l02282"></a>02282         <span class="comment">/* Save repo head if for GC. */</span>
<a name="l02283"></a>02283         <a class="code" href="daemon_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l02284"></a>02284                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l02285"></a>02285                                              <a class="code" href="daemon_2repo-mgr_8h.html#af63040384723b88eb87e261c8ebb298b">REPO_REMOTE_HEAD</a>,
<a name="l02286"></a>02286                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l02287"></a>02287         <a class="code" href="daemon_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l02288"></a>02288                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l02289"></a>02289                                              <a class="code" href="daemon_2repo-mgr_8h.html#ab09a088f0dfff9872d5dfb605ed1cade">REPO_LOCAL_HEAD</a>,
<a name="l02290"></a>02290                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l02291"></a>02291         transition_state (task, <a class="code" href="clone-mgr_8h.html#ac36f475ca5b446f4fde4c9b90bec77c8af1c3a28143f803ec77f12421a745c80e">CLONE_STATE_DONE</a>);
<a name="l02292"></a>02292     }
<a name="l02293"></a>02293 }
<a name="l02294"></a>02294 
<a name="l02295"></a>02295 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02296"></a>02296 check_folder_perms_done (<a class="code" href="struct__HttpFolderPerms.html">HttpFolderPerms</a> *result, <span class="keywordtype">void</span> *user_data)
<a name="l02297"></a>02297 {
<a name="l02298"></a>02298     <a class="code" href="struct__CloneTask.html">CloneTask</a> *task = user_data;
<a name="l02299"></a>02299     GList *ptr;
<a name="l02300"></a>02300     <a class="code" href="struct__HttpFolderPermRes.html">HttpFolderPermRes</a> *res;
<a name="l02301"></a>02301 
<a name="l02302"></a>02302     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l02303"></a>02303                                                  task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>);
<a name="l02304"></a>02304     <span class="keywordflow">if</span> (repo == NULL) {
<a name="l02305"></a>02305         seaf_warning (<span class="stringliteral">&quot;[Clone mgr] cannot find repo %s after fetched.\n&quot;</span>, 
<a name="l02306"></a>02306                    task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>);
<a name="l02307"></a>02307         transition_to_error (task, <a class="code" href="clone-mgr_8h.html#a05589fbab0657f08285ebdfe93f5ec9eacb3d74adef1000d6f681754a40837713">CLONE_ERROR_INTERNAL</a>);
<a name="l02308"></a>02308         <span class="keywordflow">return</span>;
<a name="l02309"></a>02309     }
<a name="l02310"></a>02310 
<a name="l02311"></a>02311     <span class="keywordflow">if</span> (!result-&gt;<a class="code" href="struct__HttpFolderPerms.html#a9379fb92d03bba941e2769bf9b7eb7da">success</a>) {
<a name="l02312"></a>02312         <span class="keywordflow">goto</span> out;
<a name="l02313"></a>02313     }
<a name="l02314"></a>02314 
<a name="l02315"></a>02315     <span class="keywordflow">for</span> (ptr = result-&gt;<a class="code" href="struct__HttpFolderPerms.html#ae86a1a8d2d956bf938be35e1fc4d4a9f">results</a>; ptr; ptr = ptr-&gt;next) {
<a name="l02316"></a>02316         res = ptr-&gt;data;
<a name="l02317"></a>02317 
<a name="l02318"></a>02318         <a class="code" href="daemon_2repo-mgr_8c.html#a446e8f23cdec415146a604f1b954c1a3">seaf_repo_manager_update_folder_perms</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, res-&gt;<a class="code" href="struct__HttpFolderPermRes.html#a5494ec0e4cf8755ccc3a7b5695622de0">repo_id</a>,
<a name="l02319"></a>02319                                                <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa664ef9343772c1e5e20606d23a2f696a">FOLDER_PERM_TYPE_USER</a>,
<a name="l02320"></a>02320                                                res-&gt;<a class="code" href="struct__HttpFolderPermRes.html#a02929f1af633e277256696ffc7ec3220">user_perms</a>);
<a name="l02321"></a>02321         <a class="code" href="daemon_2repo-mgr_8c.html#a446e8f23cdec415146a604f1b954c1a3">seaf_repo_manager_update_folder_perms</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, res-&gt;<a class="code" href="struct__HttpFolderPermRes.html#a5494ec0e4cf8755ccc3a7b5695622de0">repo_id</a>,
<a name="l02322"></a>02322                                                <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa55b4f2e55f412aa138091a6f350d16de">FOLDER_PERM_TYPE_GROUP</a>,
<a name="l02323"></a>02323                                                res-&gt;<a class="code" href="struct__HttpFolderPermRes.html#a739b8d7b0272f8a9a59bced0f202b533">group_perms</a>);
<a name="l02324"></a>02324         <a class="code" href="daemon_2repo-mgr_8c.html#af7adb54d2ed6bcfd5b722428bfcfb6d6">seaf_repo_manager_update_folder_perm_timestamp</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l02325"></a>02325                                                         res-&gt;<a class="code" href="struct__HttpFolderPermRes.html#a5494ec0e4cf8755ccc3a7b5695622de0">repo_id</a>,
<a name="l02326"></a>02326                                                         res-&gt;<a class="code" href="struct__HttpFolderPermRes.html#a677f775892b98905ea3cacfa9454e8a0">timestamp</a>);
<a name="l02327"></a>02327     }
<a name="l02328"></a>02328 
<a name="l02329"></a>02329 out:
<a name="l02330"></a>02330     mark_clone_done_v2 (repo, task);
<a name="l02331"></a>02331 }
<a name="l02332"></a>02332 
<a name="l02333"></a>02333 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02334"></a>02334 check_folder_permissions (<a class="code" href="struct__CloneTask.html">CloneTask</a> *task)
<a name="l02335"></a>02335 {
<a name="l02336"></a>02336     <a class="code" href="struct__HttpFolderPermReq.html">HttpFolderPermReq</a> *req;
<a name="l02337"></a>02337     GList *requests = NULL;
<a name="l02338"></a>02338 
<a name="l02339"></a>02339     req = g_new0 (<a class="code" href="struct__HttpFolderPermReq.html">HttpFolderPermReq</a>, 1);
<a name="l02340"></a>02340     memcpy (req-&gt;<a class="code" href="struct__HttpFolderPermReq.html#ac1e67df051ff5a1a9c41488633b842e1">repo_id</a>, task-&gt;<a class="code" href="struct__CloneTask.html#ad7e57c9ed10d8e043c61b3382dc7c76a">repo_id</a>, 36);
<a name="l02341"></a>02341     req-&gt;<a class="code" href="struct__HttpFolderPermReq.html#aa33db724e9d1c9b0f37cbd297ed76063">token</a> = g_strdup(task-&gt;<a class="code" href="struct__CloneTask.html#a8e19296e76e4b3dec6b4dfcf4fab5342">token</a>);
<a name="l02342"></a>02342     req-&gt;<a class="code" href="struct__HttpFolderPermReq.html#ae33fa9e631483b84321249871cff9a03">timestamp</a> = 0;
<a name="l02343"></a>02343 
<a name="l02344"></a>02344     requests = g_list_append (requests, req);
<a name="l02345"></a>02345 
<a name="l02346"></a>02346     <span class="comment">/* The requests list will be freed in http tx manager. */</span>
<a name="l02347"></a>02347     <a class="code" href="http-tx-mgr_8c.html#a24eb2fd0df4be5e88734649f6ff73fc3">http_tx_manager_get_folder_perms</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>,
<a name="l02348"></a>02348                                       task-&gt;<a class="code" href="struct__CloneTask.html#aacaddadde0f333c4181e7485872effe5">server_url</a>,
<a name="l02349"></a>02349                                       requests,
<a name="l02350"></a>02350                                       check_folder_perms_done,
<a name="l02351"></a>02351                                       task);
<a name="l02352"></a>02352 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Wed Aug 19 2015 03:19:03 for My Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
