<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>My Project: seafile/server/repo-mgr.h File Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">My Project
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#define-members">Defines</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">seafile/server/repo-mgr.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="seafile-object_8h_source.html">seafile-object.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="commit-mgr_8h_source.html">commit-mgr.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="branch-mgr_8h_source.html">branch-mgr.h</a>&quot;</code><br/>
</div>
<p><a href="server_2repo-mgr_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structSeafVirtRepo.html">SeafVirtRepo</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct__SeafRepo.html">_SeafRepo</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct__SeafRepoManager.html">_SeafRepoManager</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structGroupPerm.html">GroupPerm</a></td></tr>
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a2d6340e4ada61e93d58c0411fa6fcfe5">REPO_AUTO_SYNC</a>&#160;&#160;&#160;&quot;auto-sync&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a502b8f6b8ad6882683294f590b302cc0">REPO_AUTO_FETCH</a>&#160;&#160;&#160;&quot;auto-fetch&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ade9494be6db68ada29c0b9812da1f762">REPO_AUTO_UPLOAD</a>&#160;&#160;&#160;&quot;auto-upload&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ae570b1e2acc8cfd7c3433f974674cfa9">REPO_AUTO_MERGE</a>&#160;&#160;&#160;&quot;auto-merge&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ac5d086060283109eedf8bb27d3e7965c">REPO_AUTO_COMMIT</a>&#160;&#160;&#160;&quot;auto-commit&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a88e179c17ec642b434e82bb40403a6ba">REPO_RELAY_ID</a>&#160;&#160;&#160;&quot;relay-id&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a4dc57106ac24f4cf008c10b85ae1e384">REPO_NET_BROWSABLE</a>&#160;&#160;&#160;&quot;net-browsable&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ae717be3f43ee1abacd91e3703906d518">REPO_DOUBLE_SYNC</a>&#160;&#160;&#160;&quot;double-sync&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#af63040384723b88eb87e261c8ebb298b">REPO_REMOTE_HEAD</a>&#160;&#160;&#160;&quot;remote-head&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a913fa2a61a58336164c1d2538e12f60e">REPO_ENCRYPTED</a>&#160;&#160;&#160;0x1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a1d3305b8bae92ef04cfac74707b663d7">MAX_REPO_TOKEN</a>&#160;&#160;&#160;64</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#afa2f07ad83586c04020cc7fa2760ff1a">DEFAULT_REPO_TOKEN</a>&#160;&#160;&#160;&quot;default&quot;</td></tr>
<tr><td colspan="2"><h2><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct__SeafRepo.html">_SeafRepo</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structSeafVirtRepo.html">SeafVirtRepo</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a40426440d590ec0161993d5850b3ec47">SeafVirtRepo</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct__SeafRepoManager.html">_SeafRepoManager</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct__SeafRepoManagerPriv.html">_SeafRepoManagerPriv</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a4c34a185eca37d07c53358b27bd439f2">SeafRepoManagerPriv</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structGroupPerm.html">GroupPerm</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ae1cbacc908575b028ec23e07d1c5df94">GroupPerm</a></td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gboolean&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a35ce9f51287bbd5f961c261516c1c5f0">is_repo_id_valid</a> (const char *id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a63ab9fe4694e3d967376c911cbe2c655">seaf_repo_new</a> (const char *id, const char *<a class="el" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>, const char *desc)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ad0a65514ad80789ff244b20c66460b96">seaf_repo_free</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ab8f60cbbd6c35ee55ea72acbbd3a1608">seaf_repo_ref</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a6c47d6277897f6afbe866f2755f9762d">seaf_repo_set_head</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, <a class="el" href="branch-mgr_8h.html#a43063fab0cfaf940abc07b1cd941fb85">SeafBranch</a> *branch)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a9c8ead9892374c87ece888d76e810197">seaf_repo_from_commit</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, <a class="el" href="commit-mgr_8h.html#ab20cfcee12e164d94824e8be23c2c8ea">SeafCommit</a> *commit)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a39a9a41ffdfc324f3c935251d9e14d51">seaf_repo_to_commit</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, <a class="el" href="commit-mgr_8h.html#ab20cfcee12e164d94824e8be23c2c8ea">SeafCommit</a> *commit)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#adc55911231fbdbb9d54f39d7f0e60dca">seaf_repo_get_commits</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a168ba33665e04b18089dd5a5d2a18fe3">seaf_repo_diff</a> (<a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo, const char *arg1, const char *arg2, int fold_dir_diff, char **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a640edf431de146c19d5ac2cff6321397">seaf_repo_manager_new</a> (struct <a class="el" href="struct__SeafileSession.html">_SeafileSession</a> *<a class="el" href="server_2seafile-session_8h.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a8dab773e289d1148e7afec7c8614278a">seaf_repo_manager_init</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a2e049cfa3d0546aaf51e7f6792e1467d">seaf_repo_manager_start</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a2c0a60c4eefbb0b4bc68bf871856f32d">seaf_repo_manager_add_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, <a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a512a79980f7d3698e591cf87aeccd314">seaf_repo_manager_del_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a69efc9d099ac370fff9fe9e4caea05ea">seaf_repo_manager_del_virtual_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const gchar *id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a11cc1a4ecd45778ea5a10af0cb72b347">seaf_repo_manager_get_repo_ex</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const gchar *id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gboolean&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a4b2497e6cdde50c4ce3cb642370e06eb">seaf_repo_manager_repo_exists</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const gchar *id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#aa692b1e331cad063425d676afe1ae121">seaf_repo_manager_get_repo_list</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, int start, int limit)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a8fec30cb36491cb94d968df3ce06d5d7">seaf_repo_manager_get_trash_repo_list</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, int start, int limit, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a507c39fec59f1a4672a0cdd5493c6887">seaf_repo_manager_get_trash_repos_by_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *owner, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a94469a7522aa5a67fbc58440544e299a">seaf_repo_manager_del_repo_from_trash</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a47fd08ad688d035ae95e11545bb0a68b">seaf_repo_manager_empty_repo_trash</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a99f0a8fafd75a617d03ea745d36df9be">seaf_repo_manager_empty_repo_trash_by_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *owner, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a4db874916fe89f6b839e389d74034288">seaf_repo_manager_restore_repo_from_trash</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a928ca86df93e60744ca6edacb33a386f">seaf_repo_manager_get_repo_id_list</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ae586fb5fbd61d6b44be3e47e7b6c86da">seaf_repo_manager_branch_repo_unmap</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, <a class="el" href="branch-mgr_8h.html#a43063fab0cfaf940abc07b1cd941fb85">SeafBranch</a> *branch)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a2413f0a10a33c5de4d82193c9c8b7f08">seaf_repo_manager_get_email_by_token</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *manager, const char *repo_id, const char *token)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a7899787e6f32bc1f2c578c740b2d716e">seaf_repo_manager_generate_repo_token</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *email, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a673a63eb50ecebd6c689aaadaea5c5e5">seaf_repo_manager_add_token_peer_info</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *token, const char *peer_id, const char *peer_ip, const char *peer_name, gint64 sync_time)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a33b75eede501da0a4c6100b30b9facf0">seaf_repo_manager_update_token_peer_info</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *token, const char *peer_ip, gint64 sync_time)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gboolean&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#aa40635ee3473d593c5edc1a9e9976cd7">seaf_repo_manager_token_peer_info_exists</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *token)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#aab7412302b0f206f7717a29d86d80e0f">seaf_repo_manager_delete_token</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *token, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#afab1803ccaa8885ec65db8075e87a40a">seaf_repo_manager_list_repo_tokens</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a754dc377da1101690257dd8be7fbe78f">seaf_repo_manager_list_repo_tokens_by_email</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *email, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ab1d760446ae882d377b26dcd36eac582">seaf_repo_manager_delete_repo_tokens_by_peer_id</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *email, const char *peer_id, GList **tokens, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#abd2450d97efc42795b87ad7b4624ae63">seaf_repo_manager_delete_repo_tokens_by_email</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *email, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gint64&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ae37e80051d587e921a003fc06c21d540">seaf_repo_manager_get_repo_size</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ac78c13c68a1a9d1d025e45f4e51193ac">seaf_repo_manager_set_repo_history_limit</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, int days)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a0f63ca499435a0d01f03c8c3a2d86c44">seaf_repo_manager_get_repo_history_limit</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#aeeda6cf1cb41515388afd8a10c6297e1">seaf_repo_manager_set_repo_valid_since</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, gint64 timestamp)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gint64&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#aa8aafa2da81a00419443a068fe98958b">seaf_repo_manager_get_repo_valid_since</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gint64&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a774e0a8ea59c07c94dc8014612b3f948">seaf_repo_manager_get_repo_truncate_time</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a75071fddf41a1371d4f89be8d2b59b88">seaf_repo_manager_revert_on_server</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *commit_id, const char *user_name, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a3128bd2930667427a22976b6a2b85743">seaf_repo_manager_post_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *temp_file_path, const char *parent_dir, const char *file_name, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a248a05b4a54ff2d9302d0779cbcc3542">seaf_repo_manager_post_multi_files</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *filenames_json, const char *paths_json, const char *user, int replace_existed, char **new_ids, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a0d6750947e09a7c4f4eb2146147e9db1">seaf_repo_manager_post_file_blocks</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *file_name, const char *blockids_json, const char *paths_json, const char *user, gint64 <a class="el" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>, int replace_existed, char **new_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a2e0e32263ad7bbeaa4ab13a62135c46a">seaf_repo_manager_post_empty_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *new_file_name, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#aa870306d94f3e7b16e66229040590138">seaf_repo_manager_post_dir</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *new_dir_name, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a46c094895964e060809372262c9b9923">seaf_repo_manager_put_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *temp_file_path, const char *parent_dir, const char *file_name, const char *user, const char *head_id, char **new_file_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#aad15cfaf3210b47e9f59a481073aafbc">seaf_repo_manager_put_file_blocks</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *file_name, const char *blockids_json, const char *paths_json, const char *user, const char *head_id, gint64 <a class="el" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>, char **new_file_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ad6564c23b0e50d8a34dd425432b80db4">seaf_repo_manager_del_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *file_name, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="copy-task_8c.html#a464af47cf9e39f4bd55f0f0dd0ee506a">SeafileCopyResult</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ab7eae6af688907f68212dca114549c4b">seaf_repo_manager_copy_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *src_repo_id, const char *src_dir, const char *src_filename, const char *dst_repo_id, const char *dst_dir, const char *dst_filename, const char *user, int need_progress, int synchronous, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="copy-task_8c.html#a464af47cf9e39f4bd55f0f0dd0ee506a">SeafileCopyResult</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a056b45d63edfafbc5287012a2a1062ec">seaf_repo_manager_move_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *src_repo_id, const char *src_dir, const char *src_filename, const char *dst_repo_id, const char *dst_dir, const char *dst_filename, const char *user, int need_progress, int synchronous, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ae68e4b6427bb239b697e515c8617cbfb">seaf_repo_manager_rename_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, const char *oldname, const char *newname, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a7e2d25a533ae3eeced99134a7ffb5dbe">seaf_repo_manager_is_valid_filename</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *filename, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a3706de93ba77e5068dba6a1dd073a0fd">seaf_repo_manager_create_new_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_name, const char *repo_desc, const char *owner_email, const char *passwd, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ad9feaba8f2f873b6685560fd86f4c40d">seaf_repo_manager_create_enc_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *repo_name, const char *repo_desc, const char *owner_email, const char *magic, const char *random_key, int enc_version, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#afa299e57b701699e37969cc2e674290e">seaf_repo_manager_list_file_revisions</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *start_commit_id, const char *path, int max_revision, int limit, int show_days, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ad00a42c20e1baadf267215e7e683f9e4">seaf_repo_manager_calc_files_last_modified</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *parent_dir, int limit, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a246dc6695f1ee0c1806de54109848096">seaf_repo_manager_revert_file</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *commit_id, const char *path, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#abf48f3efee4705f32fa8f3a95098921e">seaf_repo_manager_revert_dir</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *old_commit_id, const char *dir_path, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#aa21f88c4616547e974cd8c65c512781c">seaf_repo_manager_get_deleted_entries</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, int show_days, const char *path, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a3702d0c75995d0221e33b9ba673b99fd">seaf_repo_manager_update_dir</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *dir_path, const char *new_dir_id, const char *user, const char *head_id, char *new_commit_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a5f096821f41a339e41e9341fc0c4010d">seaf_repo_manager_set_repo_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *email)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#af227a31082c71908bf0a0ac35cfeb294">seaf_repo_manager_get_repo_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#aa30a874076b81b802de8763e30433c97">seaf_repo_manager_get_orphan_repo_list</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a7cf33a85dd9c77b44a83d6c8ed300948">seaf_repo_manager_get_repos_by_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *email)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a6a2b07102342d3acc5722e059635aacb">seaf_repo_manager_get_repo_ids_by_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *email)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ae90467b188b67b2c7dd720a159cbbbaa">seaf_repo_manager_add_group_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, int group_id, const char *owner, const char *permission, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a1085e1b2d057850d0a87132107a0e741">seaf_repo_manager_del_group_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, int group_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a404f7522a538d92d2ac68e49956a5a9b">seaf_repo_manager_get_groups_by_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a82d76d79aed153b9165b48e12dc2f2d0">seaf_repo_manager_get_group_perm_by_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a6c5f4f43e7e198238b3b24dff3e9c389">seaf_repo_manager_set_group_repo_perm</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, int group_id, const char *permission, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a9ef2e3d497a572ee1642e6e6dc0c2977">seaf_repo_manager_get_group_repo_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a8e5e47e57afc5432400aeac4e42494b3">seaf_repo_manager_get_group_repoids</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, int group_id, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a9b3550e6d994e1ab95cbd65e454b8614">seaf_repo_manager_get_group_repos_by_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *owner, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a921cbac599e1c80869659e545d99b62f">seaf_repo_manager_remove_group_repos</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, int group_id, const char *owner, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ab4740f8bce8f9f3571adf0adfb63590b">seaf_repo_manager_set_inner_pub_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *permission)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a4a3708ac06f2c015cc665f5ba61ee36a">seaf_repo_manager_unset_inner_pub_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gboolean&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a4f04f29fd9180ef2982cc0d7bfeee5e4">seaf_repo_manager_is_inner_pub_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a715b426c9fadfc393ece3afdec8587f7">seaf_repo_manager_list_inner_pub_repos</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gint64&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a2365b6daa6aef0d8476fa90f2aeca051">seaf_repo_manager_count_inner_pub_repos</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a8be31ce1507a9a9fb63e15123961acdb">seaf_repo_manager_list_inner_pub_repos_by_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *user)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a24cf3ec157b1edc047b115b28ee8bd0c">seaf_repo_manager_get_inner_pub_repo_perm</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a6a318e5a5bcb0d46286030040ab6e23b">seaf_repo_manager_check_permission</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *user, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#adcbb183301f879ab82eea84aaf8d88b6">seaf_repo_manager_list_dir_with_perm</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *dir_path, const char *dir_id, const char *user, int offset, int limit, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#aaabba29e879e5e4e53ff753e86b5427b">seaf_repo_manager_set_access_property</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *ap)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a3f3921eba68da813d0d1a583c8923396">seaf_repo_manager_query_access_property</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a26b82474124b9be618ec1564097e5e95">seaf_repo_manager_add_decrypted_token</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *encrypted_token, const char *session_key, const char *decrypted_token)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#af52386548dacb8d7b466e1c75c79a208">seaf_repo_manager_get_decrypted_token</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *encrypted_token, const char *session_key)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a9a8dcda29ee6cd28d92c1897ad12f268">seaf_repo_manager_create_virtual_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *origin_repo_id, const char *path, const char *repo_name, const char *repo_desc, const char *owner, const char *passwd, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structSeafVirtRepo.html">SeafVirtRepo</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a316db228b35dde3dc88ae9dab9ec9c22">seaf_repo_manager_get_virtual_repo_info</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a5e7e933b737fca2ccdb657124812fc90">seaf_repo_manager_get_virtual_info_by_origin</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *origin_repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a66a6ccfc59462f4c59fd322c693c3d5a">seaf_virtual_repo_info_free</a> (<a class="el" href="structSeafVirtRepo.html">SeafVirtRepo</a> *vinfo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">gboolean&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a0b9efffb3301d72133b4a3fdd28fc69c">seaf_repo_manager_is_virtual_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#ab6ef9796edaf6e7e5b53f3633dc88fa8">seaf_repo_manager_get_virtual_repo_id</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *origin_repo, const char *path, const char *owner)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a89c9b19ae91ea15fe9aa684c5509d4ec">seaf_repo_manager_get_virtual_repos_by_owner</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *owner, GError **error)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">GList *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a0e2fecd8fae5355455342e43f6588967">seaf_repo_manager_get_virtual_repo_ids_by_origin</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *origin_repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *repo_id, const char *exclude_repo)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a1cd4a8c70076d40d2a778dda774a2263">seaf_repo_manager_cleanup_virtual_repos</a> (<a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *mgr, const char *origin_repo_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="server_2repo-mgr_8h.html#a9545839eb2c54af7e7e2e3948647f47c">seaf_repo_manager_init_merge_scheduler</a> ()</td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="afa2f07ad83586c04020cc7fa2760ff1a"></a><!-- doxytag: member="repo&#45;mgr.h::DEFAULT_REPO_TOKEN" ref="afa2f07ad83586c04020cc7fa2760ff1a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#afa2f07ad83586c04020cc7fa2760ff1a">DEFAULT_REPO_TOKEN</a>&#160;&#160;&#160;&quot;default&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00185">185</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="a1d3305b8bae92ef04cfac74707b663d7"></a><!-- doxytag: member="repo&#45;mgr.h::MAX_REPO_TOKEN" ref="a1d3305b8bae92ef04cfac74707b663d7" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#a1d3305b8bae92ef04cfac74707b663d7">MAX_REPO_TOKEN</a>&#160;&#160;&#160;64</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00184">184</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="ac5d086060283109eedf8bb27d3e7965c"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_AUTO_COMMIT" ref="ac5d086060283109eedf8bb27d3e7965c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#ac5d086060283109eedf8bb27d3e7965c">REPO_AUTO_COMMIT</a>&#160;&#160;&#160;&quot;auto-commit&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00014">14</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="a502b8f6b8ad6882683294f590b302cc0"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_AUTO_FETCH" ref="a502b8f6b8ad6882683294f590b302cc0" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#a502b8f6b8ad6882683294f590b302cc0">REPO_AUTO_FETCH</a>&#160;&#160;&#160;&quot;auto-fetch&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00011">11</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="ae570b1e2acc8cfd7c3433f974674cfa9"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_AUTO_MERGE" ref="ae570b1e2acc8cfd7c3433f974674cfa9" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#ae570b1e2acc8cfd7c3433f974674cfa9">REPO_AUTO_MERGE</a>&#160;&#160;&#160;&quot;auto-merge&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00013">13</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="a2d6340e4ada61e93d58c0411fa6fcfe5"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_AUTO_SYNC" ref="a2d6340e4ada61e93d58c0411fa6fcfe5" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#a2d6340e4ada61e93d58c0411fa6fcfe5">REPO_AUTO_SYNC</a>&#160;&#160;&#160;&quot;auto-sync&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00010">10</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="ade9494be6db68ada29c0b9812da1f762"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_AUTO_UPLOAD" ref="ade9494be6db68ada29c0b9812da1f762" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#ade9494be6db68ada29c0b9812da1f762">REPO_AUTO_UPLOAD</a>&#160;&#160;&#160;&quot;auto-upload&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00012">12</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="ae717be3f43ee1abacd91e3703906d518"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_DOUBLE_SYNC" ref="ae717be3f43ee1abacd91e3703906d518" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#ae717be3f43ee1abacd91e3703906d518">REPO_DOUBLE_SYNC</a>&#160;&#160;&#160;&quot;double-sync&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00017">17</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="a913fa2a61a58336164c1d2538e12f60e"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_ENCRYPTED" ref="a913fa2a61a58336164c1d2538e12f60e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#a913fa2a61a58336164c1d2538e12f60e">REPO_ENCRYPTED</a>&#160;&#160;&#160;0x1</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00019">19</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="a4dc57106ac24f4cf008c10b85ae1e384"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_NET_BROWSABLE" ref="a4dc57106ac24f4cf008c10b85ae1e384" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#a4dc57106ac24f4cf008c10b85ae1e384">REPO_NET_BROWSABLE</a>&#160;&#160;&#160;&quot;net-browsable&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00016">16</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="a88e179c17ec642b434e82bb40403a6ba"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_RELAY_ID" ref="a88e179c17ec642b434e82bb40403a6ba" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#a88e179c17ec642b434e82bb40403a6ba">REPO_RELAY_ID</a>&#160;&#160;&#160;&quot;relay-id&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00015">15</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="af63040384723b88eb87e261c8ebb298b"></a><!-- doxytag: member="repo&#45;mgr.h::REPO_REMOTE_HEAD" ref="af63040384723b88eb87e261c8ebb298b" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="server_2repo-mgr_8h.html#af63040384723b88eb87e261c8ebb298b">REPO_REMOTE_HEAD</a>&#160;&#160;&#160;&quot;remote-head&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00018">18</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<hr/><h2>Typedef Documentation</h2>
<a class="anchor" id="ae1cbacc908575b028ec23e07d1c5df94"></a><!-- doxytag: member="repo&#45;mgr.h::GroupPerm" ref="ae1cbacc908575b028ec23e07d1c5df94" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structGroupPerm.html">GroupPerm</a>  <a class="el" href="structGroupPerm.html">GroupPerm</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a3e8b6c8c2a077518a17c75c6ace3ae1c"></a><!-- doxytag: member="repo&#45;mgr.h::SeafRepo" ref="a3e8b6c8c2a077518a17c75c6ace3ae1c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct__SeafRepo.html">_SeafRepo</a> <a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00022">22</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="af5833aac28a20ee1e1217fc33b9c3a54"></a><!-- doxytag: member="repo&#45;mgr.h::SeafRepoManager" ref="af5833aac28a20ee1e1217fc33b9c3a54" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct__SeafRepoManager.html">_SeafRepoManager</a> <a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00098">98</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="a4c34a185eca37d07c53358b27bd439f2"></a><!-- doxytag: member="repo&#45;mgr.h::SeafRepoManagerPriv" ref="a4c34a185eca37d07c53358b27bd439f2" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct__SeafRepoManagerPriv.html">_SeafRepoManagerPriv</a> <a class="el" href="daemon_2repo-mgr_8h.html#a4c34a185eca37d07c53358b27bd439f2">SeafRepoManagerPriv</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8h_source.html#l00099">99</a> of file <a class="el" href="server_2repo-mgr_8h_source.html">repo-mgr.h</a>.</p>

</div>
</div>
<a class="anchor" id="a40426440d590ec0161993d5850b3ec47"></a><!-- doxytag: member="repo&#45;mgr.h::SeafVirtRepo" ref="a40426440d590ec0161993d5850b3ec47" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structSeafVirtRepo.html">SeafVirtRepo</a>  <a class="el" href="structSeafVirtRepo.html">SeafVirtRepo</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a35ce9f51287bbd5f961c261516c1c5f0"></a><!-- doxytag: member="repo&#45;mgr.h::is_repo_id_valid" ref="a35ce9f51287bbd5f961c261516c1c5f0" args="(const char *id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gboolean <a class="el" href="server_2repo-mgr_8h.html#a35ce9f51287bbd5f961c261516c1c5f0">is_repo_id_valid</a> </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2repo-mgr_8c_source.html#l00527">527</a> of file <a class="el" href="daemon_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (!<span class="keywordtype">id</span>)
        <span class="keywordflow">return</span> FALSE;

    <span class="keywordflow">return</span> <a class="code" href="seafile_2lib_2utils_8c.html#a48ecdc72b727191abafbbf2ec1f70ace">is_uuid_valid</a> (<span class="keywordtype">id</span>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a168ba33665e04b18089dd5a5d2a18fe3"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_diff" ref="a168ba33665e04b18089dd5a5d2a18fe3" args="(SeafRepo *repo, const char *arg1, const char *arg2, int fold_dir_diff, char **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="repo-op_8c.html#ab69fe2104c734bb5d32b025e3f444736">seaf_repo_diff</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>arg1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>arg2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>fold_dir_diff</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="repo-op_8c_source.html#l04975">4975</a> of file <a class="el" href="repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *c1 = NULL, *c2 = NULL;
    <span class="keywordtype">int</span> ret = 0;
    GList *diff_entries = NULL;

    g_return_val_if_fail (*error == NULL, NULL);

    c2 = get_commit (repo, <span class="keyword">new</span>);
    <span class="keywordflow">if</span> (!c2) {
        *error = g_strdup(<span class="stringliteral">&quot;Can&#39;t find new commit&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }
    
    <span class="keywordflow">if</span> (old == NULL || old[0] == <span class="charliteral">&#39;\0&#39;</span>) {
        <span class="keywordflow">if</span> (c2-&gt;parent_id &amp;&amp; c2-&gt;second_parent_id) {
            ret = <a class="code" href="diff-simple_8c.html#a8c800ee63c23c5ff78d838974f678e47">diff_merge</a> (c2, &amp;diff_entries, fold_dir_diff);
            <span class="keywordflow">if</span> (ret &lt; 0) {
                *error = g_strdup(<span class="stringliteral">&quot;Failed to do diff&quot;</span>);
                <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (c2);
                <span class="keywordflow">return</span> NULL;
            }
            <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (c2);
            <span class="keywordflow">return</span> diff_entries;
        }

        <span class="keywordflow">if</span> (!c2-&gt;parent_id) {
            <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (c2);
            <span class="keywordflow">return</span> NULL;
        }
        c1 = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                             repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, 
                                             c2-&gt;parent_id);
    } <span class="keywordflow">else</span> {
        c1 = get_commit (repo, old);
    }

    <span class="keywordflow">if</span> (!c1) {
        *error = g_strdup(<span class="stringliteral">&quot;Can&#39;t find old commit&quot;</span>);
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (c2);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="comment">/* do diff */</span>
    ret = <a class="code" href="diff-simple_8c.html#a9e9cbe6847c88fc7bca7035f45a0a50e">diff_commits</a> (c1, c2, &amp;diff_entries, fold_dir_diff);
    <span class="keywordflow">if</span> (ret &lt; 0)
        *error = g_strdup(<span class="stringliteral">&quot;Failed to do diff&quot;</span>);

    <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (c1);
    <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (c2);

    <span class="keywordflow">return</span> diff_entries;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad0a65514ad80789ff244b20c66460b96"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_free" ref="ad0a65514ad80789ff244b20c66460b96" args="(SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="server_2repo-mgr_8h.html#ad0a65514ad80789ff244b20c66460b96">seaf_repo_free</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2repo-mgr_8c_source.html#l00607">607</a> of file <a class="el" href="daemon_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>) <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>);

    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>);
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a>);
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4d7c42c5644eb9dbfd24bf43adb9316c">category</a>);
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>);
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>);
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#aaeff5900edfc0f7bcb9c97592b70d247">email</a>);
    g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a0ce3b61cb31e78ffea429615379b3eb4">token</a>);
    g_free (repo);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a9c8ead9892374c87ece888d76e810197"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_from_commit" ref="a9c8ead9892374c87ece888d76e810197" args="(SeafRepo *repo, SeafCommit *commit)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="server_2repo-mgr_8h.html#a9c8ead9892374c87ece888d76e810197">seaf_repo_from_commit</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="commit-mgr_8h.html#ab20cfcee12e164d94824e8be23c2c8ea">SeafCommit</a> *&#160;</td>
          <td class="paramname"><em>commit</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2repo-mgr_8c_source.html#l00663">663</a> of file <a class="el" href="daemon_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a> = g_strdup (commit-&gt;<a class="code" href="struct__SeafCommit.html#aacd7b88f8a3e72446cd7352396eaa09e">repo_name</a>);
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a> = g_strdup (commit-&gt;<a class="code" href="struct__SeafCommit.html#aa3d8e868c630cfbecbcb9158c4bbe2e4">repo_desc</a>);
    repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#a906e77d2a658f4337437ff8694a4bfc0">encrypted</a>;
    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
        repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a>;
        <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> == 1)
            memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a>, 32);
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> == 2) {
            memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a>, 64);
            memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#a83e0a2366ba320396f2deb6faa167b84">random_key</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#ab1d44814bc44472105aef8761656e3d7">random_key</a>, 96);
        }
    }
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a4710aaee11c7887df402fffa7ca6c54f">no_local_history</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#a383ea4a4b94417c7d9e9827d60420d64">no_local_history</a>;
    repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#abc83f168ce2b43fa864522bf0ea26d6d">version</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="adc55911231fbdbb9d54f39d7f0e60dca"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_get_commits" ref="adc55911231fbdbb9d54f39d7f0e60dca" args="(SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#adc55911231fbdbb9d54f39d7f0e60dca">seaf_repo_get_commits</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2repo-mgr_8c_source.html#l00713">713</a> of file <a class="el" href="daemon_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *branches;
    GList *ptr;
    <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch;
    GList *commits = NULL;

    branches = <a class="code" href="branch-mgr_8c.html#ad5bd62cbe17cb8fe91bcd993956a1fbf">seaf_branch_manager_get_branch_list</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
    <span class="keywordflow">if</span> (branches == NULL) {
        g_warning (<span class="stringliteral">&quot;Failed to get branch list of repo %s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">for</span> (ptr = branches; ptr != NULL; ptr = ptr-&gt;next) {
        branch = ptr-&gt;data;
        gboolean res = <a class="code" href="commit-mgr_8c.html#ac6547d5546781608b39446d9a2077fed">seaf_commit_manager_traverse_commit_tree</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                                                 repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
                                                                 repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                                 branch-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>,
                                                                 collect_commit,
                                                                 &amp;commits, FALSE);
        <span class="keywordflow">if</span> (!res) {
            <span class="keywordflow">for</span> (ptr = commits; ptr != NULL; ptr = ptr-&gt;next)
                <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> ((<a class="code" href="struct__SeafCommit.html">SeafCommit</a> *)(ptr-&gt;data));
            g_list_free (commits);
            <span class="keywordflow">goto</span> out;
        }
    }

    commits = g_list_reverse (commits);

out:
    <span class="keywordflow">for</span> (ptr = branches; ptr != NULL; ptr = ptr-&gt;next) {
        <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> ((<a class="code" href="struct__SeafBranch.html">SeafBranch</a> *)ptr-&gt;data);
    }
    <span class="keywordflow">return</span> commits;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a26b82474124b9be618ec1564097e5e95"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_add_decrypted_token" ref="a26b82474124b9be618ec1564097e5e95" args="(SeafRepoManager *mgr, const char *encrypted_token, const char *session_key, const char *decrypted_token)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="server_2repo-mgr_8h.html#a26b82474124b9be618ec1564097e5e95">seaf_repo_manager_add_decrypted_token</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>encrypted_token</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>session_key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>decrypted_token</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02859">2859</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> key[256];
    <a class="code" href="structDecryptedToken.html">DecryptedToken</a> *token;

    snprintf (key, <span class="keyword">sizeof</span>(key), <span class="stringliteral">&quot;%s%s&quot;</span>, encrypted_token, session_key);
    key[255] = 0;

    pthread_rwlock_wrlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);

    token = g_new0 (<a class="code" href="structDecryptedToken.html">DecryptedToken</a>, 1);
    token-&gt;<a class="code" href="structDecryptedToken.html#a616524db801f9ed7ee2b7b9095bf7cd1">token</a> = g_strdup(decrypted_token);
    token-&gt;<a class="code" href="structDecryptedToken.html#ac28926407787ff9b8f9e85f677c02447">reap_time</a> = (gint64)time(NULL) + <a class="code" href="server_2repo-mgr_8c.html#a6e0d8a1f0eba39caca9c0b6745241644">DECRYPTED_TOKEN_TTL</a>;

    g_hash_table_insert (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a000e23969980c4dcc63654c2fd0e37d0">decrypted_tokens</a>,
                         g_strdup(key),
                         token);

    pthread_rwlock_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae90467b188b67b2c7dd720a159cbbbaa"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_add_group_repo" ref="ae90467b188b67b2c7dd720a159cbbbaa" args="(SeafRepoManager *mgr, const char *repo_id, int group_id, const char *owner, const char *permission, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#ae90467b188b67b2c7dd720a159cbbbaa">seaf_repo_manager_add_group_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>group_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>permission</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02208">2208</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                 <span class="stringliteral">&quot;INSERT INTO RepoGroup VALUES (?, ?, ?, ?)&quot;</span>,
                                 4, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;int&quot;</span>, group_id,
                                 <span class="stringliteral">&quot;string&quot;</span>, owner, <span class="stringliteral">&quot;string&quot;</span>, permission) &lt; 0)
        <span class="keywordflow">return</span> -1;

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a2c0a60c4eefbb0b4bc68bf871856f32d"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_add_repo" ref="a2c0a60c4eefbb0b4bc68bf871856f32d" args="(SeafRepoManager *mgr, SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a2c0a60c4eefbb0b4bc68bf871856f32d">seaf_repo_manager_add_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2repo-mgr_8c_source.html#l04002">4002</a> of file <a class="el" href="daemon_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];
    sqlite3 *db = manager-&gt;priv-&gt;db;

    pthread_mutex_lock (&amp;manager-&gt;priv-&gt;db_lock);

    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;REPLACE INTO Repo VALUES (&#39;%s&#39;);&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
    <a class="code" href="seafile_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql);

    pthread_mutex_unlock (&amp;manager-&gt;priv-&gt;db_lock);

    <span class="comment">/* There may be a &quot;deletion record&quot; for this repo when it was deleted</span>
<span class="comment">     * last time.</span>
<span class="comment">     */</span>
    <a class="code" href="daemon_2repo-mgr_8c.html#a7d2cf85f06fa2e7d459730f7494c1a65">seaf_repo_manager_remove_garbage_repo</a> (manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);

    repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a> = manager;

    <span class="keywordflow">if</span> (pthread_rwlock_wrlock (&amp;manager-&gt;priv-&gt;lock) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;[repo mgr] failed to lock repo cache.\n&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    g_hash_table_insert (manager-&gt;priv-&gt;repo_hash, g_strdup(repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>), repo);

    pthread_rwlock_unlock (&amp;manager-&gt;priv-&gt;lock);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a673a63eb50ecebd6c689aaadaea5c5e5"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_add_token_peer_info" ref="a673a63eb50ecebd6c689aaadaea5c5e5" args="(SeafRepoManager *mgr, const char *token, const char *peer_id, const char *peer_ip, const char *peer_name, gint64 sync_time)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a673a63eb50ecebd6c689aaadaea5c5e5">seaf_repo_manager_add_token_peer_info</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>token</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>peer_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>peer_ip</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>peer_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gint64&#160;</td>
          <td class="paramname"><em>sync_time</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l01099">1099</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> ret = 0;

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                 <span class="stringliteral">&quot;INSERT INTO RepoTokenPeerInfo VALUES (&quot;</span>
                                 <span class="stringliteral">&quot;?, ?, ?, ?, ?)&quot;</span>,
                                 5, <span class="stringliteral">&quot;string&quot;</span>, token,
                                 <span class="stringliteral">&quot;string&quot;</span>, peer_id,
                                 <span class="stringliteral">&quot;string&quot;</span>, peer_ip,
                                 <span class="stringliteral">&quot;string&quot;</span>, peer_name,
                                 <span class="stringliteral">&quot;int64&quot;</span>, sync_time) &lt; 0)
        ret = -1;

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae586fb5fbd61d6b44be3e47e7b6c86da"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_branch_repo_unmap" ref="ae586fb5fbd61d6b44be3e47e7b6c86da" args="(SeafRepoManager *manager, SeafBranch *branch)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#ae586fb5fbd61d6b44be3e47e7b6c86da">seaf_repo_manager_branch_repo_unmap</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="branch-mgr_8h.html#a43063fab0cfaf940abc07b1cd941fb85">SeafBranch</a> *&#160;</td>
          <td class="paramname"><em>branch</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2repo-mgr_8c_source.html#l04397">4397</a> of file <a class="el" href="daemon_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    sqlite3 *db = manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a564132cff6405324fa2a118c2368bbc0">db</a>;

    pthread_mutex_lock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    sql = sqlite3_mprintf (<span class="stringliteral">&quot;DELETE FROM RepoBranch WHERE branch_name = %Q&quot;</span>
                           <span class="stringliteral">&quot; AND repo_id = %Q&quot;</span>,
                           branch-&gt;<a class="code" href="struct__SeafBranch.html#ae6af0006b9b80ded4f0525a3be06ccda">name</a>, branch-&gt;<a class="code" href="struct__SeafBranch.html#a88717f46308eb12629b99f9ff91740c2">repo_id</a>);
    <span class="keywordflow">if</span> (<a class="code" href="seafile_2lib_2db_8c.html#a34065420d7e15be3dd4e8bff5cb51fe9">sqlite_query_exec</a> (db, sql) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;Unmap branch repo failed\n&quot;</span>);
        pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);
        sqlite3_free (sql);
        <span class="keywordflow">return</span> -1;
    }

    sqlite3_free (sql);
    pthread_mutex_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad00a42c20e1baadf267215e7e683f9e4"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_calc_files_last_modified" ref="ad00a42c20e1baadf267215e7e683f9e4" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, int limit, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="repo-op_8c.html#ad00a42c20e1baadf267215e7e683f9e4">seaf_repo_manager_calc_files_last_modified</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>limit</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Give a directory, return the last modification timestamps of all the files under this directory.</p>
<p>First we record the current id of every file, then traverse the commit tree. Give a commit, for each file, if the file id in that commit is different than its current id, then this file is last modified in the commit previous to that commit. </p>

<p>Definition at line <a class="el" href="repo-op_8c_source.html#l04372">4372</a> of file <a class="el" href="repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <a class="code" href="struct__SeafDir.html">SeafDir</a> *dir = NULL;
    GList *ptr = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *dent = NULL; 
    <a class="code" href="structCalcFilesLastModifiedParam.html">CalcFilesLastModifiedParam</a> data = {0};
    GList *ret_list = NULL;

    repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (!repo) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;No such repo %s&quot;</span>, repo_id);
        <span class="keywordflow">goto</span> out;
    }

    head_commit = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, 
                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
    <span class="keywordflow">if</span> (!head_commit) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to get commit %s&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
        <span class="keywordflow">goto</span> out;
    }

    dir = <a class="code" href="fs-mgr_8c.html#a033b8831db7345eec0ff09216b63593d">seaf_fs_manager_get_seafdir_by_path</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                               repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                               head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                               parent_dir, error);
    <span class="keywordflow">if</span> (*error || !dir) {
        <span class="keywordflow">goto</span> out;
    }

    data.<a class="code" href="structCalcFilesLastModifiedParam.html#a3412c63b55952d96b97003e9b7f0a554">repo</a> = repo;
    
    <span class="comment">/* A hash table of pattern (file_name, current_file_id) */</span>
    data.<a class="code" href="structCalcFilesLastModifiedParam.html#a3df140a9e3aa77f2a0358882608b45e7">current_file_id_hash</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
                                                       g_free, g_free);
    <span class="comment">/* A (file_name, last_modified) hashtable. &lt;last_modified&gt; is a heap</span>
<span class="comment">       allocated gint64</span>
<span class="comment">    */</span>
    data.<a class="code" href="structCalcFilesLastModifiedParam.html#a3dc0d21efbfe255dd2ed12f62aafb01c">last_modified_hash</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
                                                     g_free, g_free);
    <span class="keywordflow">for</span> (ptr = dir-&gt;<a class="code" href="struct__SeafDir.html#ae45d2a99b493e8a080e910d2fd580df4">entries</a>; ptr; ptr = ptr-&gt;next) {
        dent = ptr-&gt;data;
        g_hash_table_insert (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a3df140a9e3aa77f2a0358882608b45e7">current_file_id_hash</a>,
                             g_strdup(dent-&gt;<a class="code" href="struct__SeafDirent.html#a400094123179edfd24b0db4925780624">name</a>),
                             g_strdup(dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>));

        gint64 *<a class="code" href="index_8h.html#a774773e5c25d1b44dac32468246cc980">ctime</a> = g_new (gint64, 1);
        *ctime = head_commit-&gt;<a class="code" href="struct__SeafCommit.html#ae3f1657ab475921889a1e9c74b94e7a2">ctime</a>;
        g_hash_table_insert (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a3dc0d21efbfe255dd2ed12f62aafb01c">last_modified_hash</a>,
                             g_strdup(dent-&gt;<a class="code" href="struct__SeafDirent.html#a400094123179edfd24b0db4925780624">name</a>), 
                             ctime);
    }

    <span class="keywordflow">if</span> (g_hash_table_size (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a3df140a9e3aa77f2a0358882608b45e7">current_file_id_hash</a>) == 0) {
        <span class="comment">/* An empty directory, no need to traverse */</span>
        <span class="keywordflow">goto</span> out;
    }

    data.<a class="code" href="structCalcFilesLastModifiedParam.html#a0a95fb889cc871fa3eda698384b44678">parent_dir</a> = parent_dir;
    data.<a class="code" href="structCalcFilesLastModifiedParam.html#affad5250344d1c5b6c6e0ee393bdb258">error</a> = error;

    <span class="keywordflow">if</span> (!<a class="code" href="commit-mgr_8c.html#a032f260db46d5566e78dfcbbc4b2859a">seaf_commit_manager_traverse_commit_tree_with_limit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, 
                                                        repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>,
                                (<a class="code" href="commit-mgr_8h.html#ace73a042fe8571009de1750edb729c83">CommitTraverseFunc</a>)collect_files_last_modified,
                                                              limit, &amp;data, FALSE)) {
        <span class="keywordflow">if</span> (*error)
            seaf_warning (<span class="stringliteral">&quot;error when traversing commits: %s\n&quot;</span>, (*error)-&gt;message);
        <span class="keywordflow">else</span>
            seaf_warning (<span class="stringliteral">&quot;error when traversing commits.\n&quot;</span>);
        g_clear_error (error);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;failed to traverse commit of repo %s&quot;</span>, repo_id);
        <span class="keywordflow">goto</span> out;
    }

    GHashTableIter iter;
    gpointer key, value;

    g_hash_table_iter_init (&amp;iter, data.<a class="code" href="structCalcFilesLastModifiedParam.html#a3dc0d21efbfe255dd2ed12f62aafb01c">last_modified_hash</a>);
    <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
        <a class="code" href="struct__SeafileFileLastModifiedInfo.html">SeafileFileLastModifiedInfo</a> *info;
        gint64 last_modified = *(gint64 *)value;
        info = g_object_new (<a class="code" href="dirent_8c.html#a03d67508624048467d5661a891a563d9">SEAFILE_TYPE_FILE_LAST_MODIFIED_INFO</a>,
                             <span class="stringliteral">&quot;file_name&quot;</span>, key,
                             <span class="stringliteral">&quot;last_modified&quot;</span>, last_modified,
                             NULL);
        ret_list = g_list_prepend (ret_list, info);
    }

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <span class="keywordflow">if</span> (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a3dc0d21efbfe255dd2ed12f62aafb01c">last_modified_hash</a>)
        g_hash_table_destroy (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a3dc0d21efbfe255dd2ed12f62aafb01c">last_modified_hash</a>);
    <span class="keywordflow">if</span> (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a3df140a9e3aa77f2a0358882608b45e7">current_file_id_hash</a>)
        g_hash_table_destroy (data.<a class="code" href="structCalcFilesLastModifiedParam.html#a3df140a9e3aa77f2a0358882608b45e7">current_file_id_hash</a>);
    <span class="keywordflow">if</span> (dir)
        <a class="code" href="fs-mgr_8c.html#ae04d3c4669cd7b0fc691cd2da6dc2de1">seaf_dir_free</a> (dir);

    <span class="keywordflow">return</span> g_list_reverse(ret_list);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a6a318e5a5bcb0d46286030040ab6e23b"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_check_permission" ref="a6a318e5a5bcb0d46286030040ab6e23b" args="(SeafRepoManager *mgr, const char *repo_id, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="repo-perm_8c.html#a6a318e5a5bcb0d46286030040ab6e23b">seaf_repo_manager_check_permission</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="repo-perm_8c_source.html#l00134">134</a> of file <a class="el" href="repo-perm_8c_source.html">repo-perm.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="structSeafVirtRepo.html">SeafVirtRepo</a> *vinfo;
    <span class="keywordtype">char</span> *owner = NULL;
    <span class="keywordtype">char</span> *permission = NULL;

    <span class="comment">/* This is a virtual repo.*/</span>
    vinfo = <a class="code" href="server_2gc_2repo-mgr_8c.html#a316db228b35dde3dc88ae9dab9ec9c22">seaf_repo_manager_get_virtual_repo_info</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (vinfo) {
        permission = check_virtual_repo_permission (mgr, repo_id,
                                                    vinfo-&gt;<a class="code" href="structSeafVirtRepo.html#a23bc0205036c7a0c807c4f89145794b1">origin_repo_id</a>,
                                                    user, error);
        <span class="keywordflow">goto</span> out;
    }

    owner = <a class="code" href="server_2repo-mgr_8c.html#af227a31082c71908bf0a0ac35cfeb294">seaf_repo_manager_get_repo_owner</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (owner != NULL) {
        <span class="keywordflow">if</span> (strcmp (owner, user) == 0)
            permission = g_strdup(<span class="stringliteral">&quot;rw&quot;</span>);
        <span class="keywordflow">else</span>
            permission = check_repo_share_permission (mgr, repo_id, user);
    }

out:
    <a class="code" href="server_2gc_2repo-mgr_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a">seaf_virtual_repo_info_free</a> (vinfo);
    g_free (owner);
    <span class="keywordflow">return</span> permission;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a1cd4a8c70076d40d2a778dda774a2263"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_cleanup_virtual_repos" ref="a1cd4a8c70076d40d2a778dda774a2263" args="(SeafRepoManager *mgr, const char *origin_repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="virtual-repo_8c.html#a1cd4a8c70076d40d2a778dda774a2263">seaf_repo_manager_cleanup_virtual_repos</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>origin_repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="virtual-repo_8c_source.html#l00619">619</a> of file <a class="el" href="virtual-repo_8c_source.html">virtual-repo.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head = NULL;
    GList *vinfo_list = NULL, *ptr;
    <a class="code" href="structSeafVirtRepo.html">SeafVirtRepo</a> *vinfo;
    <a class="code" href="struct__SeafDir.html">SeafDir</a> *dir;
    GError *error = NULL;

    repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, origin_repo_id);
    <span class="keywordflow">if</span> (!repo) {
        seaf_warning (<span class="stringliteral">&quot;Failed to get repo %.10s.\n&quot;</span>, origin_repo_id);
        <span class="keywordflow">goto</span> out;
    }

    head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                           repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
                                           repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                           repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
    <span class="keywordflow">if</span> (!head) {
        seaf_warning (<span class="stringliteral">&quot;Failed to get commit %.8s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
        <span class="keywordflow">goto</span> out;
    }

    vinfo_list = <a class="code" href="server_2repo-mgr_8h.html#a5e7e933b737fca2ccdb657124812fc90">seaf_repo_manager_get_virtual_info_by_origin</a> (mgr,
                                                               origin_repo_id);
    <span class="keywordflow">for</span> (ptr = vinfo_list; ptr; ptr = ptr-&gt;next) {
        vinfo = ptr-&gt;data;
        dir = <a class="code" href="fs-mgr_8c.html#a033b8831db7345eec0ff09216b63593d">seaf_fs_manager_get_seafdir_by_path</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>,
                                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                   head-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                                   vinfo-&gt;<a class="code" href="structSeafVirtRepo.html#abd2d9ee29b9d78255cd52b8f7aa053ec">path</a>,
                                                   &amp;error);
        <span class="keywordflow">if</span> (error) {
            <span class="keywordflow">if</span> (error-&gt;code == <a class="code" href="seafile-error_8h.html#aabbb62a1d7a32a24a7d227ad7cc46535">SEAF_ERR_PATH_NO_EXIST</a>) {
                handle_missing_virtual_repo (mgr, repo, head, vinfo);
            }
            g_clear_error (&amp;error);
        } <span class="keywordflow">else</span>
            <a class="code" href="fs-mgr_8c.html#ae04d3c4669cd7b0fc691cd2da6dc2de1">seaf_dir_free</a> (dir);
        <a class="code" href="server_2gc_2repo-mgr_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a">seaf_virtual_repo_info_free</a> (vinfo);
    }

out:
    <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (head);
    g_list_free (vinfo_list);
}
</pre></div>
</div>
</div>
<a class="anchor" id="ab7eae6af688907f68212dca114549c4b"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_copy_file" ref="ab7eae6af688907f68212dca114549c4b" args="(SeafRepoManager *mgr, const char *src_repo_id, const char *src_dir, const char *src_filename, const char *dst_repo_id, const char *dst_dir, const char *dst_filename, const char *user, int need_progress, int synchronous, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="copy-task_8c.html#a464af47cf9e39f4bd55f0f0dd0ee506a">SeafileCopyResult</a>* <a class="el" href="repo-op_8c.html#a88f5fdc80a71e558b5508387eafbb6de">seaf_repo_manager_copy_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>src_repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>src_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>src_filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dst_repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dst_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dst_filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>need_progress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>synchronous</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Copy a SeafDirent from a SeafDir to another.</p>
<p>1. When  and  are not the same repo, neither of them should be encrypted.</p>
<p>2. the file being copied must not exist in the dst path of the dst repo. </p>

<p>Definition at line <a class="el" href="repo-op_8c_source.html#l01756">1756</a> of file <a class="el" href="repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *src_repo = NULL, *dst_repo = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *src_dent = NULL, *dst_dent = NULL;
    <span class="keywordtype">char</span> *src_canon_path = NULL, *dst_canon_path = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *dst_head_commit = NULL;
    <span class="keywordtype">int</span> ret = 0;
    gboolean background = FALSE;
    <span class="keywordtype">char</span> *task_id = NULL;
    <a class="code" href="struct__SeafileCopyResult.html">SeafileCopyResult</a> *res= NULL;

    <a class="code" href="repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(src_repo, src_repo_id);

    <span class="keywordflow">if</span> (strcmp(src_repo_id, dst_repo_id) != 0) {
        <a class="code" href="repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(dst_repo, dst_repo_id);

        <span class="keywordflow">if</span> (src_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a> || dst_repo-&gt;encrypted) {
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                         <span class="stringliteral">&quot;Can&#39;t copy files between encrypted repo(s)&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
        
    } <span class="keywordflow">else</span> {
        <a class="code" href="fuse_2repo-mgr_8c.html#ab8f60cbbd6c35ee55ea72acbbd3a1608">seaf_repo_ref</a> (src_repo);
        dst_repo = src_repo;
    }
    
    src_canon_path = get_canonical_path (src_path);
    dst_canon_path = get_canonical_path (dst_path);

    <span class="comment">/* first check whether a file with file_name already exists in destination dir */</span>
    <a class="code" href="repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(dst_head_commit,
                       dst_repo-&gt;id, dst_repo-&gt;<a class="code" href="struct__SeafCommit.html#abc83f168ce2b43fa864522bf0ea26d6d">version</a>, 
                       dst_repo-&gt;head-&gt;commit_id);
    
    <a class="code" href="repo-op_8c.html#a897aab32c75a36b188922b8726831ccf">FAIL_IF_FILE_EXISTS</a>(dst_repo-&gt;store_id, dst_repo-&gt;version,
                        dst_head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, dst_canon_path, dst_filename, NULL);

    <span class="comment">/* get src dirent */</span>
    src_dent = get_dirent_by_path (src_repo, NULL,
                                   src_canon_path, src_filename, error);
    <span class="keywordflow">if</span> (!src_dent) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (strcmp (src_repo_id, dst_repo_id) == 0 ||
        is_virtual_repo_and_origin (src_repo, dst_repo)) {

        gint64 <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a> = (src_dent-&gt;<a class="code" href="struct__SeafDirent.html#afc58a80e040b009230ce1d3d500e2f1f">version</a> &gt; 0) ? src_dent-&gt;<a class="code" href="struct__SeafDirent.html#abf0e9b6fade594b7897cb9896d370961">size</a> : -1;

        <span class="comment">/* duplicate src dirent with new name */</span>
        dst_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(dst_repo-&gt;version),
                                    src_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>, src_dent-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>, dst_filename,
                                    (gint64)time(NULL), user, <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>);

        <span class="keywordflow">if</span> (put_dirent_and_commit (dst_repo,
                                   dst_canon_path,
                                   dst_dent,
                                   user,
                                   error) &lt; 0) {
            <span class="keywordflow">if</span> (!error)
                g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                             <span class="stringliteral">&quot;failed to put dirent&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }

        <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, dst_repo_id, NULL);

        update_repo_size (dst_repo_id);
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!synchronous) {
        background = TRUE;

        gint64 total_files = -1;
        <span class="keywordflow">if</span> (S_ISDIR(src_dent-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>))
            total_files = <a class="code" href="fs-mgr_8c.html#afa141245d62ac11820ad120fef68d01e">seaf_fs_manager_count_fs_files</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                                          src_repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>,
                                                          src_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                          src_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
        <span class="keywordflow">else</span>
            total_files = 1;
        <span class="keywordflow">if</span> (total_files &lt; 0) {
            seaf_warning (<span class="stringliteral">&quot;Failed to get file count.\n&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }

        <span class="keywordflow">if</span> (!check_file_count_and_size (src_repo, src_dent, total_files, error)) {
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }

        task_id = <a class="code" href="copy-mgr_8c.html#ae731d17024807023ab2689f9ffca5e99">seaf_copy_manager_add_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a1826aa8bcba056a4f41755627b270751">copy_mgr</a>,
                                              src_repo_id,
                                              src_canon_path,
                                              src_filename,
                                              dst_repo_id,
                                              dst_canon_path,
                                              dst_filename,
                                              user,
                                              total_files,
                                              cross_repo_copy,
                                              need_progress);
        <span class="keywordflow">if</span> (need_progress &amp;&amp; !task_id) {
            seaf_warning (<span class="stringliteral">&quot;Failed to start copy task.\n&quot;</span>);
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;failed to start copy task&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    } <span class="keywordflow">else</span> {
        <span class="comment">/* Synchronous for cross-repo move */</span>
        <span class="keywordflow">if</span> (cross_repo_copy (src_repo_id,
                             src_canon_path,
                             src_filename,
                             dst_repo_id,
                             dst_canon_path,
                             dst_filename,
                             user,
                             NULL) &lt; 0) {
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;Failed to move&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

out:
    <span class="keywordflow">if</span> (src_repo)
        <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (src_repo);
    <span class="keywordflow">if</span> (dst_repo)
        <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (dst_repo);
    <span class="keywordflow">if</span> (dst_head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(dst_head_commit);
    <span class="keywordflow">if</span> (src_canon_path)
        g_free (src_canon_path);
    <span class="keywordflow">if</span> (dst_canon_path)
        g_free (dst_canon_path);
    <span class="keywordflow">if</span> (src_dent)
        <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a>(src_dent);
    <span class="keywordflow">if</span> (dst_dent)
        <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a>(dst_dent);

    <span class="keywordflow">if</span> (ret == 0) {
        res = <a class="code" href="copy-task_8c.html#a828878066e3a11e3b2587b55cb00ee54">seafile_copy_result_new</a> ();
        g_object_set (res, <span class="stringliteral">&quot;background&quot;</span>, background, <span class="stringliteral">&quot;task_id&quot;</span>, task_id, NULL);
        g_free (task_id);
    }

    <span class="keywordflow">return</span> res;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a2365b6daa6aef0d8476fa90f2aeca051"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_count_inner_pub_repos" ref="a2365b6daa6aef0d8476fa90f2aeca051" args="(SeafRepoManager *mgr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gint64 <a class="el" href="server_2repo-mgr_8h.html#a2365b6daa6aef0d8476fa90f2aeca051">seaf_repo_manager_count_inner_pub_repos</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02587">2587</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];

    snprintf (sql, 256, <span class="stringliteral">&quot;SELECT COUNT(*) FROM InnerPubRepo&quot;</span>);

    <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a401edd7e7937648d96ffb06486097020">seaf_db_get_int64</a>(mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql);
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad9feaba8f2f873b6685560fd86f4c40d"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_create_enc_repo" ref="ad9feaba8f2f873b6685560fd86f4c40d" args="(SeafRepoManager *mgr, const char *repo_id, const char *repo_name, const char *repo_desc, const char *owner_email, const char *magic, const char *random_key, int enc_version, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="server_2repo-mgr_8h.html#ad9feaba8f2f873b6685560fd86f4c40d">seaf_repo_manager_create_enc_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_desc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner_email</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>magic</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>random_key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>enc_version</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02789">2789</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (!repo_id || !<a class="code" href="seafile_2lib_2utils_8c.html#a48ecdc72b727191abafbbf2ec1f70ace">is_uuid_valid</a> (repo_id)) {
        seaf_warning (<span class="stringliteral">&quot;Invalid repo_id.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid repo id&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">if</span> (<a class="code" href="daemon_2repo-mgr_8c.html#a4b2497e6cdde50c4ce3cb642370e06eb">seaf_repo_manager_repo_exists</a> (mgr, repo_id)) {
        seaf_warning (<span class="stringliteral">&quot;Repo %s exists, refuse to create.\n&quot;</span>, repo_id);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Repo already exists&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">if</span> (create_repo_common (mgr, repo_id, repo_name, repo_desc, owner_email,
                            magic, random_key, enc_version, error) &lt; 0)
        <span class="keywordflow">return</span> NULL;

    <span class="keywordflow">if</span> (<a class="code" href="server_2repo-mgr_8c.html#a5f096821f41a339e41e9341fc0c4010d">seaf_repo_manager_set_repo_owner</a> (mgr, repo_id, owner_email) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;Failed to set repo owner.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to set repo owner.&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> g_strdup (repo_id);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a3706de93ba77e5068dba6a1dd073a0fd"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_create_new_repo" ref="a3706de93ba77e5068dba6a1dd073a0fd" args="(SeafRepoManager *mgr, const char *repo_name, const char *repo_desc, const char *owner_email, const char *passwd, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="server_2repo-mgr_8h.html#a3706de93ba77e5068dba6a1dd073a0fd">seaf_repo_manager_create_new_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_desc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner_email</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>passwd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02746">2746</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *repo_id = NULL;
    <span class="keywordtype">char</span> magic[65], random_key[97];

    repo_id = <a class="code" href="seafile_2lib_2utils_8c.html#af64020f0be33abde6a2a076ff9808809">gen_uuid</a> ();

    <span class="keywordflow">if</span> (passwd &amp;&amp; passwd[0] != 0) {
        <a class="code" href="seafile-crypt_8c.html#a4f67d65d3f21019477c1a0d8d7ec2477">seafile_generate_magic</a> (2, repo_id, passwd, magic);
        <a class="code" href="seafile-crypt_8c.html#ae58dda89366c1a52a611cee06b487f89">seafile_generate_random_key</a> (passwd, random_key);
    }

    <span class="keywordtype">int</span> rc;
    <span class="keywordflow">if</span> (passwd)
        rc = create_repo_common (mgr, repo_id, repo_name, repo_desc, owner_email,
                                 magic, random_key, <a class="code" href="seafile_2common_2common_8h.html#a79d3ddb90929fe8420a585a0105a50ec">CURRENT_ENC_VERSION</a>, error);
    <span class="keywordflow">else</span>
        rc = create_repo_common (mgr, repo_id, repo_name, repo_desc, owner_email,
                                 NULL, NULL, -1, error);
    <span class="keywordflow">if</span> (rc &lt; 0)
        <span class="keywordflow">goto</span> bad;

    <span class="keywordflow">if</span> (<a class="code" href="server_2repo-mgr_8c.html#a5f096821f41a339e41e9341fc0c4010d">seaf_repo_manager_set_repo_owner</a> (mgr, repo_id, owner_email) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;Failed to set repo owner.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to set repo owner.&quot;</span>);
        <span class="keywordflow">goto</span> bad;
    }

    <span class="keywordflow">return</span> repo_id;
    
bad:
    <span class="keywordflow">if</span> (repo_id)
        g_free (repo_id);
    <span class="keywordflow">return</span> NULL;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a9a8dcda29ee6cd28d92c1897ad12f268"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_create_virtual_repo" ref="a9a8dcda29ee6cd28d92c1897ad12f268" args="(SeafRepoManager *mgr, const char *origin_repo_id, const char *path, const char *repo_name, const char *repo_desc, const char *owner, const char *passwd, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="virtual-repo_8c.html#a9a8dcda29ee6cd28d92c1897ad12f268">seaf_repo_manager_create_virtual_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>origin_repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_desc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>passwd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="virtual-repo_8c_source.html#l00168">168</a> of file <a class="el" href="virtual-repo_8c_source.html">virtual-repo.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *origin_repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *origin_head = NULL;
    <span class="keywordtype">char</span> *repo_id = NULL;
    <span class="keywordtype">char</span> *dir_id = NULL;
    <span class="keywordtype">char</span> *orig_owner = NULL;

    <span class="keywordflow">if</span> (<a class="code" href="fuse_2repo-mgr_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c">seaf_repo_manager_is_virtual_repo</a> (mgr, origin_repo_id)) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Cannot create sub-library from a sub-library&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    repo_id = get_existing_virtual_repo (mgr, origin_repo_id, path);
    <span class="keywordflow">if</span> (repo_id) {
        <span class="keywordflow">return</span> repo_id;
    }

    origin_repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, origin_repo_id);
    <span class="keywordflow">if</span> (!origin_repo) {
        seaf_warning (<span class="stringliteral">&quot;Failed to get origin repo %.10s\n&quot;</span>, origin_repo_id);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Origin library not exists&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">if</span> (origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
        <span class="keywordflow">if</span> (origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> &lt; 2) {
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                         <span class="stringliteral">&quot;Library encryption version must be higher than 2&quot;</span>);
            <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (origin_repo);
            <span class="keywordflow">return</span> NULL;
        }

        <span class="keywordflow">if</span> (!passwd || passwd[0] == 0) {
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                         <span class="stringliteral">&quot;Password is not set&quot;</span>);
            <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (origin_repo);
            <span class="keywordflow">return</span> NULL;
        }

        <span class="keywordflow">if</span> (<a class="code" href="seafile-crypt_8c.html#a9ada7f42f1f31b91dabdc5edde6b73f9">seafile_verify_repo_passwd</a> (origin_repo_id,
                                        passwd,
                                        origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>,
                                        origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>) &lt; 0) {
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;Incorrect password&quot;</span>);
            <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (origin_repo);
            <span class="keywordflow">return</span> NULL;
        }
    }

    origin_head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                                  origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
                                                  origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                  origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
    <span class="keywordflow">if</span> (!origin_head) {
        seaf_warning (<span class="stringliteral">&quot;Failed to get head commit %.8s.\n&quot;</span>,
                      origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Bad origin repo head&quot;</span>);
        <span class="keywordflow">goto</span> error;
    }

    dir_id = <a class="code" href="fs-mgr_8c.html#a3fbd81f579b4a8594861cbc0595595ca">seaf_fs_manager_get_seafdir_id_by_path</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                                     origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>,
                                                     origin_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                     origin_head-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                                     path, NULL);
    <span class="keywordflow">if</span> (!dir_id) {
        seaf_warning (<span class="stringliteral">&quot;Path %s doesn&#39;t exist or is not a dir in repo %.10s.\n&quot;</span>,
                      path, origin_repo_id);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Bad path&quot;</span>);
        <span class="keywordflow">goto</span> error;
    }

    repo_id = <a class="code" href="seafile_2lib_2utils_8c.html#af64020f0be33abde6a2a076ff9808809">gen_uuid</a>();

    <span class="comment">/* Save virtual repo info before actually create the repo.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (save_virtual_repo_info (mgr, repo_id, origin_repo_id,
                                path, origin_head-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;Failed to save virtual repo info for %.10s:%s&quot;</span>,
                      origin_repo_id, path);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;Internal error&quot;</span>);
        <span class="keywordflow">goto</span> error;
    }

    orig_owner = <a class="code" href="server_2repo-mgr_8c.html#af227a31082c71908bf0a0ac35cfeb294">seaf_repo_manager_get_repo_owner</a> (mgr, origin_repo_id);

    <span class="keywordflow">if</span> (do_create_virtual_repo (mgr, origin_repo, repo_id, repo_name, repo_desc,
                                dir_id, orig_owner, passwd, error) &lt; 0)
        <span class="keywordflow">goto</span> error;

    <span class="keywordflow">if</span> (<a class="code" href="server_2repo-mgr_8c.html#a5f096821f41a339e41e9341fc0c4010d">seaf_repo_manager_set_repo_owner</a> (mgr, repo_id, orig_owner) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;Failed to set repo owner for %.10s.\n&quot;</span>, repo_id);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to set repo owner.&quot;</span>);
        <span class="keywordflow">goto</span> error;
    }

    <span class="comment">/* The size of virtual repo is non-zero at the beginning. */</span>
    update_repo_size (repo_id);

    <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (origin_repo);
    <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (origin_head);
    g_free (dir_id);
    g_free (orig_owner);
    <span class="keywordflow">return</span> repo_id;

error:
    <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (origin_repo);
    <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (origin_head);
    g_free (repo_id);
    g_free (dir_id);
    g_free (orig_owner);
    <span class="keywordflow">return</span> NULL;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ad6564c23b0e50d8a34dd425432b80db4"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_del_file" ref="ad6564c23b0e50d8a34dd425432b80db4" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *file_name, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#ad6564c23b0e50d8a34dd425432b80db4">seaf_repo_manager_del_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="repo-op_8c_source.html#l01318">1318</a> of file <a class="el" href="repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <span class="keywordtype">int</span> <a class="code" href="index_8h.html#ac1b4d694fc07a39e06900e82872aac7f">mode</a> = 0;
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    <span class="keywordflow">if</span> (!canon_path)
        canon_path = get_canonical_path (parent_dir);
    
    <span class="keywordflow">if</span> (!check_file_exists(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                           head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, file_name, &amp;mode)) {
        seaf_warning (<span class="stringliteral">&quot;[del file] target file %s/%s does not exist, skip\n&quot;</span>,
                      canon_path, file_name);
        <span class="keywordflow">goto</span> out;
    }

    root_id = do_del_file (repo,
                           head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, file_name);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[del file] Failed to del file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to del file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    <span class="keywordflow">if</span> (S_ISDIR(mode)) {
        snprintf(buf, <a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Removed directory \&quot;%s\&quot;&quot;</span>, file_name);
    } <span class="keywordflow">else</span> {
        snprintf(buf, <a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Deleted \&quot;%s\&quot;&quot;</span>, file_name);
    }

    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a1cd4a8c70076d40d2a778dda774a2263">seaf_repo_manager_cleanup_virtual_repos</a> (mgr, repo_id);

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    g_free (root_id);
    g_free (canon_path);

    <span class="keywordflow">if</span> (ret == 0) {
        update_repo_size (repo_id);
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a1085e1b2d057850d0a87132107a0e741"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_del_group_repo" ref="a1085e1b2d057850d0a87132107a0e741" args="(SeafRepoManager *mgr, const char *repo_id, int group_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a1085e1b2d057850d0a87132107a0e741">seaf_repo_manager_del_group_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>group_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02225">2225</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                    <span class="stringliteral">&quot;DELETE FROM RepoGroup WHERE group_id=? &quot;</span>
                                    <span class="stringliteral">&quot;AND repo_id=?&quot;</span>,
                                    2, <span class="stringliteral">&quot;int&quot;</span>, group_id, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a512a79980f7d3698e591cf87aeccd314"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_del_repo" ref="a512a79980f7d3698e591cf87aeccd314" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a512a79980f7d3698e591cf87aeccd314">seaf_repo_manager_del_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l00445">445</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (add_deleted_repo_to_trash (mgr, repo_id) &lt; 0)
        <span class="keywordflow">return</span> -1;

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM Repo WHERE repo_id = ?&quot;</span>,
                                 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0)
        <span class="keywordflow">return</span> -1;

    <span class="comment">/* Repo branches are not removed at this point. */</span>

    <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM RepoOwner WHERE repo_id = ?&quot;</span>,
                             1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);

    <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM SharedRepo WHERE repo_id = ?&quot;</span>,
                             1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);

    <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM RepoGroup WHERE repo_id = ?&quot;</span>,
                             1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);

    <span class="keywordflow">if</span> (!<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a65f4d1d214fce9bd718d84aa87b9bd9c">cloud_mode</a>) {
        <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM InnerPubRepo WHERE repo_id = ?&quot;</span>,
                                 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
    }

    <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM RepoUserToken WHERE repo_id = ?&quot;</span>,
                             1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);

    <span class="comment">/* Remove virtual repos when origin repo is deleted. */</span>
    GList *vrepos, *ptr;
    vrepos = <a class="code" href="server_2gc_2repo-mgr_8c.html#a0e2fecd8fae5355455342e43f6588967">seaf_repo_manager_get_virtual_repo_ids_by_origin</a> (mgr, repo_id);
    <span class="keywordflow">for</span> (ptr = vrepos; ptr != NULL; ptr = ptr-&gt;next)
        remove_virtual_repo_ondisk (mgr, (<span class="keywordtype">char</span> *)ptr-&gt;data);
    <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (vrepos);

    <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM VirtualRepo &quot;</span>
                             <span class="stringliteral">&quot;WHERE repo_id=? OR origin_repo=?&quot;</span>,
                             2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;string&quot;</span>, repo_id);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a94469a7522aa5a67fbc58440544e299a"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_del_repo_from_trash" ref="a94469a7522aa5a67fbc58440544e299a" args="(SeafRepoManager *mgr, const char *repo_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a94469a7522aa5a67fbc58440544e299a">seaf_repo_manager_del_repo_from_trash</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l01995">1995</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> ret = 0;

    <span class="comment">/* As long as the repo is successfully moved into GarbageRepo table,</span>
<span class="comment">     * we consider this operation successful.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (add_deleted_repo_record (mgr, repo_id) &lt; 0) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;DB error: Add deleted record&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    <span class="comment">/* remove branch */</span>
    GList *p;
    GList *branch_list = <a class="code" href="branch-mgr_8c.html#ad5bd62cbe17cb8fe91bcd993956a1fbf">seaf_branch_manager_get_branch_list</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo_id);
    <span class="keywordflow">for</span> (p = branch_list; p; p = p-&gt;next) {
        <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *b = (<a class="code" href="struct__SeafBranch.html">SeafBranch</a> *)p-&gt;data;
        <a class="code" href="daemon_2repo-mgr_8c.html#ae586fb5fbd61d6b44be3e47e7b6c86da">seaf_repo_manager_branch_repo_unmap</a> (mgr, b);
        <a class="code" href="branch-mgr_8c.html#a16b2df7708f3a4c4b96e9135ec7e1a3d">seaf_branch_manager_del_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo_id, b-&gt;<a class="code" href="struct__SeafBranch.html#ae6af0006b9b80ded4f0525a3be06ccda">name</a>);
    }
    <a class="code" href="branch-mgr_8c.html#ac6476414064e0ff0c429629aaab0bfc9">seaf_branch_list_free</a> (branch_list);

    <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                             <span class="stringliteral">&quot;DELETE FROM RepoTrash WHERE repo_id = ?&quot;</span>,
                             1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a69efc9d099ac370fff9fe9e4caea05ea"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_del_virtual_repo" ref="a69efc9d099ac370fff9fe9e4caea05ea" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a69efc9d099ac370fff9fe9e4caea05ea">seaf_repo_manager_del_virtual_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l00489">489</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">return</span> remove_virtual_repo_ondisk (mgr, repo_id);
}
</pre></div>
</div>
</div>
<a class="anchor" id="abd2450d97efc42795b87ad7b4624ae63"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_delete_repo_tokens_by_email" ref="abd2450d97efc42795b87ad7b4624ae63" args="(SeafRepoManager *mgr, const char *email, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#abd2450d97efc42795b87ad7b4624ae63">seaf_repo_manager_delete_repo_tokens_by_email</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>email</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l01403">1403</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> ret = 0;
    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">template</span>;
    GList *token_list = NULL;
    GList *ptr;
    GString *token_list_str = g_string_new (<span class="stringliteral">&quot;&quot;</span>);
    GString *sql = g_string_new (<span class="stringliteral">&quot;&quot;</span>);
    <span class="keywordtype">int</span> rc;

    <span class="keyword">template</span> = <span class="stringliteral">&quot;SELECT u.token &quot;</span>
        <span class="stringliteral">&quot;FROM RepoUserToken as u, RepoTokenPeerInfo as p &quot;</span>
        <span class="stringliteral">&quot;WHERE u.token = p.token &quot;</span>
        <span class="stringliteral">&quot;AND u.email = ?&quot;</span>;
    rc = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="keyword">template</span>,
                                        collect_token_list, &amp;token_list,
                                        1, <span class="stringliteral">&quot;string&quot;</span>, email);
    <span class="keywordflow">if</span> (rc &lt; 0) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (rc == 0)
        <span class="keywordflow">goto</span> out;

    <span class="keywordflow">for</span> (ptr = token_list; ptr; ptr = ptr-&gt;next) {
        <span class="keyword">const</span> <span class="keywordtype">char</span> *token = (<span class="keywordtype">char</span> *)ptr-&gt;data;
        if (token_list_str-&gt;len == 0)
            g_string_append_printf (token_list_str, <span class="stringliteral">&quot;&#39;%s&#39;&quot;</span>, token);
        <span class="keywordflow">else</span>
            g_string_append_printf (token_list_str, <span class="stringliteral">&quot;,&#39;%s&#39;&quot;</span>, token);
    }

    <span class="comment">/* Note that there is a size limit on sql query. In MySQL it&#39;s 1MB by default.</span>
<span class="comment">     * Normally the token_list won&#39;t be that long.</span>
<span class="comment">     */</span>
    g_string_printf (sql, <span class="stringliteral">&quot;DELETE FROM RepoUserToken WHERE token in (%s)&quot;</span>,
                     token_list_str-&gt;str);
    rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql-&gt;str, 0);
    <span class="keywordflow">if</span> (rc &lt; 0) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
        <span class="keywordflow">goto</span> out;
    }

    g_string_printf (sql, <span class="stringliteral">&quot;DELETE FROM RepoTokenPeerInfo WHERE token in (%s)&quot;</span>,
                     token_list_str-&gt;str);
    rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql-&gt;str, 0);
    <span class="keywordflow">if</span> (rc &lt; 0) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="http-server_8c.html#a4b50fa8bc6c458c1a5bdc640cc71b6cb">seaf_http_server_invalidate_tokens</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a0309f60018b54c38ec8d3275ee1d6666">http_server</a>, token_list);

out:
    g_string_free (token_list_str, TRUE);
    g_string_free (sql, TRUE);
    g_list_free_full (token_list, (GDestroyNotify)g_free);

    <span class="keywordflow">if</span> (rc &lt; 0) {
        ret = -1;
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ab1d760446ae882d377b26dcd36eac582"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_delete_repo_tokens_by_peer_id" ref="ab1d760446ae882d377b26dcd36eac582" args="(SeafRepoManager *mgr, const char *email, const char *peer_id, GList **tokens, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#ab1d760446ae882d377b26dcd36eac582">seaf_repo_manager_delete_repo_tokens_by_peer_id</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>email</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>peer_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GList **&#160;</td>
          <td class="paramname"><em>tokens</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Delete all repo tokens for a given user on a given client </p>

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l01334">1334</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> ret = 0;
    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">template</span>;
    GList *token_list = NULL;
    GString *token_list_str = g_string_new (<span class="stringliteral">&quot;&quot;</span>);
    GString *sql = g_string_new (<span class="stringliteral">&quot;&quot;</span>);
    GList *ptr;
    <span class="keywordtype">int</span> rc = 0;

    <span class="keyword">template</span> = <span class="stringliteral">&quot;SELECT u.token &quot;</span>
        <span class="stringliteral">&quot;FROM RepoUserToken as u, RepoTokenPeerInfo as p &quot;</span>
        <span class="stringliteral">&quot;WHERE u.token = p.token &quot;</span>
        <span class="stringliteral">&quot;AND u.email = ? AND p.peer_id = ?&quot;</span>;
    rc = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="keyword">template</span>,
                                        collect_token_list, &amp;token_list,
                                        2, <span class="stringliteral">&quot;string&quot;</span>, email, <span class="stringliteral">&quot;string&quot;</span>, peer_id);
    <span class="keywordflow">if</span> (rc &lt; 0) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (rc == 0)
        <span class="keywordflow">goto</span> out;

    <span class="keywordflow">for</span> (ptr = token_list; ptr; ptr = ptr-&gt;next) {
        <span class="keyword">const</span> <span class="keywordtype">char</span> *token = (<span class="keywordtype">char</span> *)ptr-&gt;data;
        if (token_list_str-&gt;len == 0)
            g_string_append_printf (token_list_str, <span class="stringliteral">&quot;&#39;%s&#39;&quot;</span>, token);
        <span class="keywordflow">else</span>
            g_string_append_printf (token_list_str, <span class="stringliteral">&quot;,&#39;%s&#39;&quot;</span>, token);
    }

    <span class="comment">/* Note that there is a size limit on sql query. In MySQL it&#39;s 1MB by default.</span>
<span class="comment">     * Normally the token_list won&#39;t be that long.</span>
<span class="comment">     */</span>
    g_string_printf (sql, <span class="stringliteral">&quot;DELETE FROM RepoUserToken WHERE token in (%s)&quot;</span>,
                     token_list_str-&gt;str);
    rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql-&gt;str, 0);
    <span class="keywordflow">if</span> (rc &lt; 0) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
        <span class="keywordflow">goto</span> out;
    }

    g_string_printf (sql, <span class="stringliteral">&quot;DELETE FROM RepoTokenPeerInfo WHERE token in (%s)&quot;</span>,
                     token_list_str-&gt;str);
    rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql-&gt;str, 0);
    <span class="keywordflow">if</span> (rc &lt; 0)
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);

out:
    g_string_free (token_list_str, TRUE);
    g_string_free (sql, TRUE);

    <span class="keywordflow">if</span> (rc &lt; 0) {
        ret = -1;
        g_list_free_full (token_list, (GDestroyNotify)g_free);
    } <span class="keywordflow">else</span> {
        *tokens = token_list;
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aab7412302b0f206f7717a29d86d80e0f"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_delete_token" ref="aab7412302b0f206f7717a29d86d80e0f" args="(SeafRepoManager *mgr, const char *repo_id, const char *token, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#aab7412302b0f206f7717a29d86d80e0f">seaf_repo_manager_delete_token</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>token</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l01152">1152</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *token_owner;

    token_owner = <a class="code" href="server_2repo-mgr_8c.html#a2413f0a10a33c5de4d82193c9c8b7f08">seaf_repo_manager_get_email_by_token</a> (mgr, repo_id, token);
    <span class="keywordflow">if</span> (!token_owner || strcmp (user, token_owner) != 0) {
        seaf_warning (<span class="stringliteral">&quot;Requesting user is %s, token owner is %s, &quot;</span>
                      <span class="stringliteral">&quot;refuse to delete token %.10s.\n&quot;</span>, user, token_owner, token);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;Permission denied&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                 <span class="stringliteral">&quot;DELETE FROM RepoUserToken &quot;</span>
                                 <span class="stringliteral">&quot;WHERE repo_id=? and token=?&quot;</span>,
                                 2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;string&quot;</span>, token) &lt; 0) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                 <span class="stringliteral">&quot;DELETE FROM RepoTokenPeerInfo WHERE token=?&quot;</span>,
                                 1, <span class="stringliteral">&quot;string&quot;</span>, token) &lt; 0) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    GList *tokens = NULL;
    tokens = g_list_append (tokens, g_strdup(token));
    <a class="code" href="http-server_8c.html#a4b50fa8bc6c458c1a5bdc640cc71b6cb">seaf_http_server_invalidate_tokens</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a0309f60018b54c38ec8d3275ee1d6666">http_server</a>, tokens);
    g_list_free_full (tokens, (GDestroyNotify)g_free);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a47fd08ad688d035ae95e11545bb0a68b"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_empty_repo_trash" ref="a47fd08ad688d035ae95e11545bb0a68b" args="(SeafRepoManager *mgr, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a47fd08ad688d035ae95e11545bb0a68b">seaf_repo_manager_empty_repo_trash</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02028">2028</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *trash_repos = NULL, *ptr;
    <a class="code" href="struct__SeafileTrashRepo.html">SeafileTrashRepo</a> *repo;

    trash_repos = <a class="code" href="server_2repo-mgr_8c.html#a8fec30cb36491cb94d968df3ce06d5d7">seaf_repo_manager_get_trash_repo_list</a> (mgr, -1, -1, error);
    <span class="keywordflow">if</span> (*error)
        <span class="keywordflow">return</span> -1;

    <span class="keywordflow">for</span> (ptr = trash_repos; ptr; ptr = ptr-&gt;next) {
        repo = ptr-&gt;data;
        <a class="code" href="server_2repo-mgr_8c.html#a94469a7522aa5a67fbc58440544e299a">seaf_repo_manager_del_repo_from_trash</a> (mgr,
                                               <a class="code" href="repo_8c.html#aa833417b3ced164bf21722143e7c3a78">seafile_trash_repo_get_repo_id</a>(repo),
                                               NULL);
        g_object_unref (repo);
    }

    g_list_free (trash_repos);
    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a99f0a8fafd75a617d03ea745d36df9be"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_empty_repo_trash_by_owner" ref="a99f0a8fafd75a617d03ea745d36df9be" args="(SeafRepoManager *mgr, const char *owner, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a99f0a8fafd75a617d03ea745d36df9be">seaf_repo_manager_empty_repo_trash_by_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02050">2050</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *trash_repos = NULL, *ptr;
    <a class="code" href="struct__SeafileTrashRepo.html">SeafileTrashRepo</a> *repo;

    trash_repos = <a class="code" href="server_2repo-mgr_8c.html#a507c39fec59f1a4672a0cdd5493c6887">seaf_repo_manager_get_trash_repos_by_owner</a> (mgr, owner, error);
    <span class="keywordflow">if</span> (*error)
        <span class="keywordflow">return</span> -1;

    <span class="keywordflow">for</span> (ptr = trash_repos; ptr; ptr = ptr-&gt;next) {
        repo = ptr-&gt;data;
        <a class="code" href="server_2repo-mgr_8c.html#a94469a7522aa5a67fbc58440544e299a">seaf_repo_manager_del_repo_from_trash</a> (mgr,
                                               <a class="code" href="repo_8c.html#aa833417b3ced164bf21722143e7c3a78">seafile_trash_repo_get_repo_id</a>(repo),
                                               NULL);
        g_object_unref (repo);
    }

    g_list_free (trash_repos);
    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a7899787e6f32bc1f2c578c740b2d716e"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_generate_repo_token" ref="a7899787e6f32bc1f2c578c740b2d716e" args="(SeafRepoManager *mgr, const char *repo_id, const char *email, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="server_2repo-mgr_8h.html#a7899787e6f32bc1f2c578c740b2d716e">seaf_repo_manager_generate_repo_token</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>email</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l01084">1084</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *token = generate_repo_token ();
    <span class="keywordflow">if</span> (add_repo_token (mgr, repo_id, email, token, error) &lt; 0) {
        g_free (token);        
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> token;
}
</pre></div>
</div>
</div>
<a class="anchor" id="af52386548dacb8d7b466e1c75c79a208"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_decrypted_token" ref="af52386548dacb8d7b466e1c75c79a208" args="(SeafRepoManager *mgr, const char *encrypted_token, const char *session_key)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="server_2repo-mgr_8h.html#af52386548dacb8d7b466e1c75c79a208">seaf_repo_manager_get_decrypted_token</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>encrypted_token</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>session_key</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02884">2884</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> key[256];
    <a class="code" href="structDecryptedToken.html">DecryptedToken</a> *token;

    snprintf (key, <span class="keyword">sizeof</span>(key), <span class="stringliteral">&quot;%s%s&quot;</span>, encrypted_token, session_key);
    key[255] = 0;

    pthread_rwlock_rdlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);
    token = g_hash_table_lookup (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a000e23969980c4dcc63654c2fd0e37d0">decrypted_tokens</a>, key);
    pthread_rwlock_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);

    <span class="keywordflow">if</span> (token)
        <span class="keywordflow">return</span> g_strdup(token-&gt;<a class="code" href="structDecryptedToken.html#a616524db801f9ed7ee2b7b9095bf7cd1">token</a>);
    <span class="keywordflow">return</span> NULL;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa21f88c4616547e974cd8c65c512781c"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_deleted_entries" ref="aa21f88c4616547e974cd8c65c512781c" args="(SeafRepoManager *mgr, const char *repo_id, int show_days, const char *path, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="repo-op_8c.html#aa21f88c4616547e974cd8c65c512781c">seaf_repo_manager_get_deleted_entries</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>show_days</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="repo-op_8c_source.html#l04869">4869</a> of file <a class="el" href="repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
    gint64 truncate_time, show_time;
    GList *ret = NULL;

    truncate_time = <a class="code" href="server_2gc_2repo-mgr_8c.html#a774e0a8ea59c07c94dc8014612b3f948">seaf_repo_manager_get_repo_truncate_time</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (truncate_time == 0)
        <span class="keywordflow">return</span> NULL;

    <span class="keywordflow">if</span> (show_days &lt;= 0)
        show_time = -1;
    <span class="keywordflow">else</span>
        show_time = (gint64)time(NULL) - show_days * 24 * 3600;

    repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (!repo) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Invalid repo id&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <a class="code" href="structCollectDelData.html">CollectDelData</a> data = {0};
    GHashTable *entries = g_hash_table_new_full (g_str_hash, g_str_equal,
                                                 g_free, g_object_unref);
    data.<a class="code" href="structCollectDelData.html#af1c2cc72ab4ea66c3ca592edab74c7d0">repo</a> = repo;
    data.<a class="code" href="structCollectDelData.html#ae8de7bab51b5cb81d4ca8ff60ac410e6">entries</a> = entries;
    data.<a class="code" href="structCollectDelData.html#a68ae2e7913cdf780efc859ec5eb218e9">truncate_time</a> = MAX (show_time, truncate_time);
    <span class="keywordflow">if</span> (path) {
        <span class="keywordflow">if</span> (path[strlen(path) - 1] == <span class="charliteral">&#39;/&#39;</span>) {
            data.<a class="code" href="structCollectDelData.html#acdc70855241ee5c292bae1e013dc6218">path</a> = g_strdup (path);
        } <span class="keywordflow">else</span> {
            data.<a class="code" href="structCollectDelData.html#acdc70855241ee5c292bae1e013dc6218">path</a> = g_strconcat (path, <span class="stringliteral">&quot;/&quot;</span>, NULL);
        }
    } <span class="keywordflow">else</span> {
        data.<a class="code" href="structCollectDelData.html#acdc70855241ee5c292bae1e013dc6218">path</a> = g_strdup (<span class="stringliteral">&quot;/&quot;</span>);
    }

    <span class="keywordflow">if</span> (!<a class="code" href="commit-mgr_8c.html#ac6547d5546781608b39446d9a2077fed">seaf_commit_manager_traverse_commit_tree</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>,
                                                   collect_deleted,
                                                   &amp;data,
                                                   TRUE))
    {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>,
                     <span class="stringliteral">&quot;Internal error&quot;</span>);
        g_hash_table_destroy (entries);
        <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
        g_free (data.<a class="code" href="structCollectDelData.html#acdc70855241ee5c292bae1e013dc6218">path</a>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="comment">/* Remove entries exist in the current commit.</span>
<span class="comment">     * This is necessary because some files may be added back after deletion.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (filter_out_existing_entries (entries, repo,
                                     repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>) == 0) {
        <span class="comment">// filter success, then add collected result to list</span>
        g_hash_table_foreach_steal (entries, hash_to_list, &amp;ret);
    }

    g_hash_table_destroy (entries);

    <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    g_free (data.<a class="code" href="structCollectDelData.html#acdc70855241ee5c292bae1e013dc6218">path</a>);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a2413f0a10a33c5de4d82193c9c8b7f08"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_email_by_token" ref="a2413f0a10a33c5de4d82193c9c8b7f08" args="(SeafRepoManager *manager, const char *repo_id, const char *token)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="server_2repo-mgr_8h.html#a2413f0a10a33c5de4d82193c9c8b7f08">seaf_repo_manager_get_email_by_token</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>token</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l01483">1483</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (!repo_id || !token)
        <span class="keywordflow">return</span> NULL;
    
    <span class="keywordtype">char</span> *email = NULL;
    <span class="keywordtype">char</span> *sql;

    sql = <span class="stringliteral">&quot;SELECT email FROM RepoUserToken &quot;</span>
        <span class="stringliteral">&quot;WHERE repo_id = ? AND token = ?&quot;</span>;

    <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                   get_email_by_token_cb, &amp;email,
                                   2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;string&quot;</span>, token);

    <span class="keywordflow">return</span> email;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a82d76d79aed153b9165b48e12dc2f2d0"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_group_perm_by_repo" ref="a82d76d79aed153b9165b48e12dc2f2d0" args="(SeafRepoManager *mgr, const char *repo_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a82d76d79aed153b9165b48e12dc2f2d0">seaf_repo_manager_get_group_perm_by_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02283">2283</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    GList *group_perms = NULL, *p;
    
    sql = <span class="stringliteral">&quot;SELECT group_id, permission FROM RepoGroup WHERE repo_id = ?&quot;</span>;
    
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, get_group_perms_cb,
                                       &amp;group_perms, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0) {
        <span class="keywordflow">for</span> (p = group_perms; p != NULL; p = p-&gt;next)
            g_free (p-&gt;data);
        g_list_free (group_perms);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> g_list_reverse (group_perms);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a9ef2e3d497a572ee1642e6e6dc0c2977"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_group_repo_owner" ref="a9ef2e3d497a572ee1642e6e6dc0c2977" args="(SeafRepoManager *mgr, const char *repo_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="server_2repo-mgr_8h.html#a9ef2e3d497a572ee1642e6e6dc0c2977">seaf_repo_manager_get_group_repo_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02424">2424</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    <span class="keywordtype">char</span> *ret = NULL;

    sql = <span class="stringliteral">&quot;SELECT user_name FROM RepoGroup WHERE repo_id = ?&quot;</span>;
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                       get_group_repo_owner, &amp;ret,
                                       1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;DB error when get repo share from for repo %s.\n&quot;</span>,
                   repo_id);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a8e5e47e57afc5432400aeac4e42494b3"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_group_repoids" ref="a8e5e47e57afc5432400aeac4e42494b3" args="(SeafRepoManager *mgr, int group_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a8e5e47e57afc5432400aeac4e42494b3">seaf_repo_manager_get_group_repoids</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>group_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02330">2330</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    GList *repo_ids = NULL;

    sql =  <span class="stringliteral">&quot;SELECT repo_id FROM RepoGroup WHERE group_id = ?&quot;</span>;
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, get_group_repoids_cb,
                                       &amp;repo_ids, 1, <span class="stringliteral">&quot;int&quot;</span>, group_id) &lt; 0)
        <span class="keywordflow">return</span> NULL;

    <span class="keywordflow">return</span> g_list_reverse (repo_ids);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a9b3550e6d994e1ab95cbd65e454b8614"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_group_repos_by_owner" ref="a9b3550e6d994e1ab95cbd65e454b8614" args="(SeafRepoManager *mgr, const char *owner, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a9b3550e6d994e1ab95cbd65e454b8614">seaf_repo_manager_get_group_repos_by_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02390">2390</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    GList *repos = NULL;

    sql = <span class="stringliteral">&quot;SELECT RepoGroup.repo_id, VirtualRepo.repo_id, &quot;</span>
        <span class="stringliteral">&quot;group_id, user_name, permission, commit_id &quot;</span>
        <span class="stringliteral">&quot;FROM RepoGroup LEFT JOIN VirtualRepo ON &quot;</span>
        <span class="stringliteral">&quot;RepoGroup.repo_id = VirtualRepo.repo_id, &quot;</span>
        <span class="stringliteral">&quot;Branch &quot;</span>
        <span class="stringliteral">&quot;WHERE user_name = ? AND &quot;</span>
        <span class="stringliteral">&quot;RepoGroup.repo_id = Branch.repo_id AND &quot;</span>
        <span class="stringliteral">&quot;Branch.name = &#39;master&#39;&quot;</span>;
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, get_group_repos_cb,
                                       &amp;repos, 1, <span class="stringliteral">&quot;string&quot;</span>, owner) &lt; 0)
        <span class="keywordflow">return</span> NULL;

    <span class="keywordflow">return</span> g_list_reverse (repos);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a404f7522a538d92d2ac68e49956a5a9b"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_groups_by_repo" ref="a404f7522a538d92d2ac68e49956a5a9b" args="(SeafRepoManager *mgr, const char *repo_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a404f7522a538d92d2ac68e49956a5a9b">seaf_repo_manager_get_groups_by_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02249">2249</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    GList *group_ids = NULL;
    
    sql =  <span class="stringliteral">&quot;SELECT group_id FROM RepoGroup WHERE repo_id = ?&quot;</span>;
    
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, get_group_ids_cb,
                                       &amp;group_ids, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0) {
        g_list_free (group_ids);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> g_list_reverse (group_ids);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a24cf3ec157b1edc047b115b28ee8bd0c"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_inner_pub_repo_perm" ref="a24cf3ec157b1edc047b115b28ee8bd0c" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="server_2repo-mgr_8h.html#a24cf3ec157b1edc047b115b28ee8bd0c">seaf_repo_manager_get_inner_pub_repo_perm</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02623">2623</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;

    sql = <span class="stringliteral">&quot;SELECT permission FROM InnerPubRepo WHERE repo_id=?&quot;</span>;
    <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a86087185f6d613c62c740d1f58cfb574">seaf_db_statement_get_string</a>(mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa30a874076b81b802de8763e30433c97"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_orphan_repo_list" ref="aa30a874076b81b802de8763e30433c97" args="(SeafRepoManager *mgr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#aa30a874076b81b802de8763e30433c97">seaf_repo_manager_get_orphan_repo_list</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l01751">1751</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *id_list = NULL, *ptr;
    GList *ret = NULL;
    <span class="keywordtype">char</span> sql[256];

    snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT Repo.repo_id FROM Repo LEFT JOIN &quot;</span>
              <span class="stringliteral">&quot;RepoOwner ON Repo.repo_id = RepoOwner.repo_id WHERE &quot;</span>
              <span class="stringliteral">&quot;RepoOwner.owner_id is NULL&quot;</span>);

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4">seaf_db_foreach_selected_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                      collect_repo_id, &amp;id_list) &lt; 0)
        <span class="keywordflow">return</span> NULL;

    <span class="keywordflow">for</span> (ptr = id_list; ptr; ptr = ptr-&gt;next) {
        <span class="keywordtype">char</span> *repo_id = ptr-&gt;data;
        <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
        <span class="keywordflow">if</span> (repo != NULL)
            ret = g_list_prepend (ret, repo);
    }

    <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (id_list);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="af0276c036723560e3e8b9aa5529133d6"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo" ref="af0276c036723560e3e8b9aa5529133d6" args="(SeafRepoManager *manager, const gchar *id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a>* <a class="el" href="server_2repo-mgr_8h.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const gchar *&#160;</td>
          <td class="paramname"><em>id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2repo-mgr_8c_source.html#l04208">4208</a> of file <a class="el" href="daemon_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *res;

    <span class="keywordflow">if</span> (pthread_rwlock_rdlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;[repo mgr] failed to lock repo cache.\n&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    res = g_hash_table_lookup (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2f794f66ac8c2ae2d902a881cf505a80">repo_hash</a>, <span class="keywordtype">id</span>);

    pthread_rwlock_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);

    <span class="keywordflow">if</span> (res &amp;&amp; !res-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>)
        <span class="keywordflow">return</span> res;

    <span class="keywordflow">return</span> NULL;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a11cc1a4ecd45778ea5a10af0cb72b347"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo_ex" ref="a11cc1a4ecd45778ea5a10af0cb72b347" args="(SeafRepoManager *manager, const gchar *id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a>* <a class="el" href="server_2repo-mgr_8h.html#a11cc1a4ecd45778ea5a10af0cb72b347">seaf_repo_manager_get_repo_ex</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const gchar *&#160;</td>
          <td class="paramname"><em>id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2gc_2repo-mgr_8c_source.html#l00249">249</a> of file <a class="el" href="server_2gc_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> len = strlen(<span class="keywordtype">id</span>);
    gboolean db_err = FALSE, exists;
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *ret = NULL;

    <span class="keywordflow">if</span> (len &gt;= 37)
        <span class="keywordflow">return</span> NULL;

    exists = repo_exists_in_db_ex (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="keywordtype">id</span>, &amp;db_err);

    <span class="keywordflow">if</span> (db_err) {
        ret = <a class="code" href="daemon_2repo-mgr_8c.html#a63ab9fe4694e3d967376c911cbe2c655">seaf_repo_new</a>(<span class="keywordtype">id</span>, NULL, NULL);
        ret-&gt;<a class="code" href="struct__SeafRepo.html#a30acbbe15ec4e36a8b3bb31581c333e5">is_corrupted</a> = TRUE;
        <span class="keywordflow">return</span> ret;
    }

    <span class="keywordflow">if</span> (exists) {
        ret = load_repo (manager, <span class="keywordtype">id</span>, TRUE);
        <span class="keywordflow">return</span> ret;
    }

    <span class="keywordflow">return</span> NULL;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a0f63ca499435a0d01f03c8c3a2d86c44"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo_history_limit" ref="a0f63ca499435a0d01f03c8c3a2d86c44" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a0f63ca499435a0d01f03c8c3a2d86c44">seaf_repo_manager_get_repo_history_limit</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2gc_2repo-mgr_8c_source.html#l00471">471</a> of file <a class="el" href="server_2gc_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="structSeafVirtRepo.html">SeafVirtRepo</a> *vinfo;
    <span class="keyword">const</span> <span class="keywordtype">char</span> *r_repo_id = repo_id;
    <span class="keywordtype">char</span> sql[256];
    <span class="keywordtype">int</span> per_repo_days = -1;

    vinfo = <a class="code" href="server_2gc_2repo-mgr_8c.html#a316db228b35dde3dc88ae9dab9ec9c22">seaf_repo_manager_get_virtual_repo_info</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (vinfo)
        r_repo_id = vinfo-&gt;<a class="code" href="structSeafVirtRepo.html#a23bc0205036c7a0c807c4f89145794b1">origin_repo_id</a>;

    snprintf (sql, <span class="keyword">sizeof</span>(sql),
              <span class="stringliteral">&quot;SELECT days FROM RepoHistoryLimit WHERE repo_id=&#39;%s&#39;&quot;</span>,
              r_repo_id);
    <a class="code" href="server_2gc_2repo-mgr_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a">seaf_virtual_repo_info_free</a> (vinfo);

    <span class="comment">/* We don&#39;t use seaf_db_get_int() because we need to differ DB error</span>
<span class="comment">     * from not exist.</span>
<span class="comment">     * We can&#39;t just return global config value if DB error occured,</span>
<span class="comment">     * since the global value may be smaller than per repo one.</span>
<span class="comment">     * This can lead to data lose in GC.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4">seaf_db_foreach_selected_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                      get_limit, &amp;per_repo_days) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;DB error.\n&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    <span class="comment">/* If per repo value is not set, return the global one. */</span>
    <span class="keywordflow">if</span> (per_repo_days &lt; 0)
        <span class="keywordflow">return</span> mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ad1d597138a7b676e94cd273a4a446776">keep_history_days</a>;

    <span class="keywordflow">return</span> per_repo_days;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a928ca86df93e60744ca6edacb33a386f"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo_id_list" ref="a928ca86df93e60744ca6edacb33a386f" args="(SeafRepoManager *mgr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a928ca86df93e60744ca6edacb33a386f">seaf_repo_manager_get_repo_id_list</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="fuse_2repo-mgr_8c_source.html#l00350">350</a> of file <a class="el" href="fuse_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *ret = NULL;
    <span class="keywordtype">char</span> sql[256];

    snprintf (sql, 256, <span class="stringliteral">&quot;SELECT repo_id FROM Repo&quot;</span>);

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4">seaf_db_foreach_selected_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 
                                      collect_repo_id, &amp;ret) &lt; 0)
        <span class="keywordflow">return</span> NULL;

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a6a2b07102342d3acc5722e059635aacb"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo_ids_by_owner" ref="a6a2b07102342d3acc5722e059635aacb" args="(SeafRepoManager *mgr, const char *email)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a6a2b07102342d3acc5722e059635aacb">seaf_repo_manager_get_repo_ids_by_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>email</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l01855">1855</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *ret = NULL;
    <span class="keywordtype">char</span> *sql;

    sql = <span class="stringliteral">&quot;SELECT repo_id FROM RepoOwner WHERE owner_id=?&quot;</span>;

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 
                                       collect_repo_id, &amp;ret,
                                       1, <span class="stringliteral">&quot;string&quot;</span>, email) &lt; 0) {
        <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (ret);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa692b1e331cad063425d676afe1ae121"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo_list" ref="aa692b1e331cad063425d676afe1ae121" args="(SeafRepoManager *mgr, int start, int limit)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#aa692b1e331cad063425d676afe1ae121">seaf_repo_manager_get_repo_list</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>start</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>limit</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2repo-mgr_8c_source.html#l05161">5161</a> of file <a class="el" href="daemon_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *repo_list = NULL;
    GHashTableIter iter;
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
    gpointer key, value;

    <span class="keywordflow">if</span> (pthread_rwlock_rdlock (&amp;manager-&gt;priv-&gt;lock) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;[repo mgr] failed to lock repo cache.\n&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }
    g_hash_table_iter_init (&amp;iter, manager-&gt;priv-&gt;repo_hash);

    <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
        repo = value;
        <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>)
            repo_list = g_list_prepend (repo_list, repo);
    }

    pthread_rwlock_unlock (&amp;manager-&gt;priv-&gt;lock);

    <span class="keywordflow">return</span> repo_list;
}
</pre></div>
</div>
</div>
<a class="anchor" id="af227a31082c71908bf0a0ac35cfeb294"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo_owner" ref="af227a31082c71908bf0a0ac35cfeb294" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="server_2repo-mgr_8h.html#af227a31082c71908bf0a0ac35cfeb294">seaf_repo_manager_get_repo_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l01721">1721</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    <span class="keywordtype">char</span> *ret = NULL;

    sql = <span class="stringliteral">&quot;SELECT owner_id FROM RepoOwner WHERE repo_id=?&quot;</span>;
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                       get_owner, &amp;ret,
                                       1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;Failed to get owner id for repo %s.\n&quot;</span>, repo_id);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae37e80051d587e921a003fc06c21d540"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo_size" ref="ae37e80051d587e921a003fc06c21d540" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gint64 <a class="el" href="server_2repo-mgr_8h.html#ae37e80051d587e921a003fc06c21d540">seaf_repo_manager_get_repo_size</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l01514">1514</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    gint64 <a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a> = 0;
    <span class="keywordtype">char</span> *sql;

    sql = <span class="stringliteral">&quot;SELECT size FROM RepoSize WHERE repo_id=?&quot;</span>;

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                       get_repo_size, &amp;size,
                                       1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0)
        <span class="keywordflow">return</span> -1;

    <span class="keywordflow">return</span> <a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a774e0a8ea59c07c94dc8014612b3f948"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo_truncate_time" ref="a774e0a8ea59c07c94dc8014612b3f948" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gint64 <a class="el" href="server_2repo-mgr_8h.html#a774e0a8ea59c07c94dc8014612b3f948">seaf_repo_manager_get_repo_truncate_time</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2gc_2repo-mgr_8c_source.html#l00557">557</a> of file <a class="el" href="server_2gc_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> days;
    gint64 timestamp;

    days = <a class="code" href="server_2gc_2repo-mgr_8c.html#a0f63ca499435a0d01f03c8c3a2d86c44">seaf_repo_manager_get_repo_history_limit</a> (mgr, repo_id);
    timestamp = <a class="code" href="server_2gc_2repo-mgr_8c.html#aa8aafa2da81a00419443a068fe98958b">seaf_repo_manager_get_repo_valid_since</a> (mgr, repo_id);

    gint64 now = (gint64)time(NULL);
    <span class="keywordflow">if</span> (days &gt; 0)
        <span class="keywordflow">return</span> MAX (now - days * 24 * 3600, timestamp);
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (days &lt; 0)
        <span class="keywordflow">return</span> timestamp;
    <span class="keywordflow">else</span>
        <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa8aafa2da81a00419443a068fe98958b"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repo_valid_since" ref="aa8aafa2da81a00419443a068fe98958b" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gint64 <a class="el" href="server_2repo-mgr_8h.html#aa8aafa2da81a00419443a068fe98958b">seaf_repo_manager_get_repo_valid_since</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2gc_2repo-mgr_8c_source.html#l00544">544</a> of file <a class="el" href="server_2gc_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];

    snprintf (sql, <span class="keyword">sizeof</span>(sql),
              <span class="stringliteral">&quot;SELECT timestamp FROM RepoValidSince WHERE repo_id=&#39;%s&#39;&quot;</span>,
              repo_id);
    <span class="comment">/* Also return -1 if DB error. */</span>
    <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a401edd7e7937648d96ffb06486097020">seaf_db_get_int64</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a7cf33a85dd9c77b44a83d6c8ed300948"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_repos_by_owner" ref="a7cf33a85dd9c77b44a83d6c8ed300948" args="(SeafRepoManager *mgr, const char *email)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a7cf33a85dd9c77b44a83d6c8ed300948">seaf_repo_manager_get_repos_by_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>email</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="fuse_2repo-mgr_8c_source.html#l00393">393</a> of file <a class="el" href="fuse_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *id_list = NULL, *ptr;
    GList *ret = NULL;
    <span class="keywordtype">char</span> sql[256];

    snprintf (sql, 256, <span class="stringliteral">&quot;SELECT repo_id FROM RepoOwner WHERE owner_id=&#39;%s&#39;&quot;</span>,
              email);

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4">seaf_db_foreach_selected_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 
                                      collect_repo_id, &amp;id_list) &lt; 0)
        <span class="keywordflow">return</span> NULL;

    <span class="keywordflow">for</span> (ptr = id_list; ptr; ptr = ptr-&gt;next) {
        <span class="keywordtype">char</span> *repo_id = ptr-&gt;data;
        <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
        <span class="keywordflow">if</span> (repo != NULL)
            ret = g_list_prepend (ret, repo);
    }

    <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (id_list);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a8fec30cb36491cb94d968df3ce06d5d7"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_trash_repo_list" ref="a8fec30cb36491cb94d968df3ce06d5d7" args="(SeafRepoManager *mgr, int start, int limit, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a8fec30cb36491cb94d968df3ce06d5d7">seaf_repo_manager_get_trash_repo_list</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>start</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>limit</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l01908">1908</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *trash_repos = NULL;
    <span class="keywordtype">int</span> rc;

    <span class="keywordflow">if</span> (start == -1 &amp;&amp; limit == -1)
        rc = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                            <span class="stringliteral">&quot;SELECT repo_id, repo_name, head_id, owner_id, &quot;</span>
                                            <span class="stringliteral">&quot;size FROM RepoTrash&quot;</span>,
                                            collect_trash_repo, &amp;trash_repos,
                                            0);
    <span class="keywordflow">else</span>
        rc = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                            <span class="stringliteral">&quot;SELECT repo_id, repo_name, head_id, owner_id, &quot;</span>
                                            <span class="stringliteral">&quot;size FROM RepoTrash &quot;</span>
                                            <span class="stringliteral">&quot;ORDER BY repo_id LIMIT ? OFFSET ?&quot;</span>,
                                            collect_trash_repo, &amp;trash_repos,
                                            2, <span class="stringliteral">&quot;int&quot;</span>, limit, <span class="stringliteral">&quot;int&quot;</span>, start);

    <span class="keywordflow">if</span> (rc &lt; 0) {
        <span class="keywordflow">while</span> (trash_repos) {
            g_object_unref (trash_repos-&gt;data);
            trash_repos = g_list_delete_link (trash_repos, trash_repos);
        }
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to get trashed repo from db.&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> trash_repos;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a507c39fec59f1a4672a0cdd5493c6887"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_trash_repos_by_owner" ref="a507c39fec59f1a4672a0cdd5493c6887" args="(SeafRepoManager *mgr, const char *owner, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a507c39fec59f1a4672a0cdd5493c6887">seaf_repo_manager_get_trash_repos_by_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l01944">1944</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *trash_repos = NULL;
    <span class="keywordtype">int</span> rc;

    rc = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                        <span class="stringliteral">&quot;SELECT repo_id, repo_name, head_id, owner_id, &quot;</span>
                                        <span class="stringliteral">&quot;size FROM RepoTrash WHERE owner_id = ?&quot;</span>,
                                        collect_trash_repo, &amp;trash_repos,
                                        1, <span class="stringliteral">&quot;string&quot;</span>, owner);

    <span class="keywordflow">if</span> (rc &lt; 0) {
        <span class="keywordflow">while</span> (trash_repos) {
            g_object_unref (trash_repos-&gt;data);
            trash_repos = g_list_delete_link (trash_repos, trash_repos);
        }
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to get trashed repo from db.&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> trash_repos;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a5e7e933b737fca2ccdb657124812fc90"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_virtual_info_by_origin" ref="a5e7e933b737fca2ccdb657124812fc90" args="(SeafRepoManager *mgr, const char *origin_repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="virtual-repo_8c.html#a5e7e933b737fca2ccdb657124812fc90">seaf_repo_manager_get_virtual_info_by_origin</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>origin_repo</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="virtual-repo_8c_source.html#l00457">457</a> of file <a class="el" href="virtual-repo_8c_source.html">virtual-repo.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *ret = NULL;
    <span class="keywordtype">char</span> *sql;

    sql = <span class="stringliteral">&quot;SELECT repo_id, origin_repo, path, base_commit &quot;</span>
        <span class="stringliteral">&quot;FROM VirtualRepo WHERE origin_repo=?&quot;</span>;
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 
                                       collect_virtual_info, &amp;ret,
                                       1, <span class="stringliteral">&quot;string&quot;</span>, origin_repo) &lt; 0) {
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> g_list_reverse (ret);
}
</pre></div>
</div>
</div>
<a class="anchor" id="ab6ef9796edaf6e7e5b53f3633dc88fa8"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_virtual_repo_id" ref="ab6ef9796edaf6e7e5b53f3633dc88fa8" args="(SeafRepoManager *mgr, const char *origin_repo, const char *path, const char *owner)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="virtual-repo_8c.html#ab6ef9796edaf6e7e5b53f3633dc88fa8">seaf_repo_manager_get_virtual_repo_id</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>origin_repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="virtual-repo_8c_source.html#l00352">352</a> of file <a class="el" href="virtual-repo_8c_source.html">virtual-repo.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    <span class="keywordtype">char</span> *ret;

    sql = <span class="stringliteral">&quot;SELECT RepoOwner.repo_id FROM RepoOwner, VirtualRepo &quot;</span>
        <span class="stringliteral">&quot;WHERE owner_id=? AND origin_repo=? AND path=? &quot;</span>
        <span class="stringliteral">&quot;AND RepoOwner.repo_id = VirtualRepo.repo_id&quot;</span>;

    ret = <a class="code" href="seaf-db_8c.html#a86087185f6d613c62c740d1f58cfb574">seaf_db_statement_get_string</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                        3, <span class="stringliteral">&quot;string&quot;</span>, owner, <span class="stringliteral">&quot;string&quot;</span>, origin_repo,
                                        <span class="stringliteral">&quot;string&quot;</span>, path);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a0e2fecd8fae5355455342e43f6588967"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_virtual_repo_ids_by_origin" ref="a0e2fecd8fae5355455342e43f6588967" args="(SeafRepoManager *mgr, const char *origin_repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="virtual-repo_8c.html#a0e2fecd8fae5355455342e43f6588967">seaf_repo_manager_get_virtual_repo_ids_by_origin</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>origin_repo</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2gc_2repo-mgr_8c_source.html#l00632">632</a> of file <a class="el" href="server_2gc_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *ret = NULL;
    <span class="keywordtype">char</span> sql[256];

    snprintf (sql, 256,
              <span class="stringliteral">&quot;SELECT repo_id FROM VirtualRepo WHERE origin_repo=&#39;%s&#39;&quot;</span>,
              origin_repo);
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4">seaf_db_foreach_selected_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 
                                      collect_virtual_repo_ids, &amp;ret) &lt; 0) {
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> g_list_reverse (ret);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a316db228b35dde3dc88ae9dab9ec9c22"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_virtual_repo_info" ref="a316db228b35dde3dc88ae9dab9ec9c22" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structSeafVirtRepo.html">SeafVirtRepo</a>* <a class="el" href="virtual-repo_8c.html#a316db228b35dde3dc88ae9dab9ec9c22">seaf_repo_manager_get_virtual_repo_info</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2gc_2repo-mgr_8c_source.html#l00596">596</a> of file <a class="el" href="server_2gc_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];
    <a class="code" href="structSeafVirtRepo.html">SeafVirtRepo</a> *vinfo = NULL;

    snprintf (sql, 256,
              <span class="stringliteral">&quot;SELECT origin_repo, path, base_commit FROM VirtualRepo &quot;</span>
              <span class="stringliteral">&quot;WHERE repo_id = &#39;%s&#39;&quot;</span>, repo_id);
    <a class="code" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4">seaf_db_foreach_selected_row</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, load_virtual_info, &amp;vinfo);

    <span class="keywordflow">return</span> vinfo;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a89c9b19ae91ea15fe9aa684c5509d4ec"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_get_virtual_repos_by_owner" ref="a89c9b19ae91ea15fe9aa684c5509d4ec" args="(SeafRepoManager *mgr, const char *owner, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="virtual-repo_8c.html#a89c9b19ae91ea15fe9aa684c5509d4ec">seaf_repo_manager_get_virtual_repos_by_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="virtual-repo_8c_source.html#l00384">384</a> of file <a class="el" href="virtual-repo_8c_source.html">virtual-repo.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *id_list = NULL, *ptr;
    GList *ret = NULL;
    <span class="keywordtype">char</span> *sql;

    sql = <span class="stringliteral">&quot;SELECT RepoOwner.repo_id FROM RepoOwner, VirtualRepo &quot;</span>
        <span class="stringliteral">&quot;WHERE owner_id=? &quot;</span>
        <span class="stringliteral">&quot;AND RepoOwner.repo_id = VirtualRepo.repo_id&quot;</span>;

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 
                                       collect_virtual_repo_ids, &amp;id_list,
                                       1, <span class="stringliteral">&quot;string&quot;</span>, owner) &lt; 0) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordtype">char</span> *repo_id;
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
    <span class="keywordflow">for</span> (ptr = id_list; ptr; ptr = ptr-&gt;next) {
        repo_id = ptr-&gt;data;
        repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
        <span class="keywordflow">if</span> (repo != NULL)
            ret = g_list_prepend (ret, repo);
    }

    <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (id_list);
    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a8dab773e289d1148e7afec7c8614278a"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_init" ref="a8dab773e289d1148e7afec7c8614278a" args="(SeafRepoManager *mgr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a8dab773e289d1148e7afec7c8614278a">seaf_repo_manager_init</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2repo-mgr_8c_source.html#l03932">3932</a> of file <a class="el" href="daemon_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (<a class="code" href="seafile_2lib_2utils_8c.html#ace0bdb78b60b2d088517a3e03a448e8b">checkdir_with_mkdir</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;Index dir %s does not exist and is unable to create\n&quot;</span>,
                   mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>);
        <span class="keywordflow">return</span> -1;
    }

    <span class="comment">/* Load all the repos into memory on the client side. */</span>
    load_repos (mgr, mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ae4df188e5674e3e4b405f14d0ee1bf9f">seaf_dir</a>);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a9545839eb2c54af7e7e2e3948647f47c"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_init_merge_scheduler" ref="a9545839eb2c54af7e7e2e3948647f47c" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="virtual-repo_8c.html#a9545839eb2c54af7e7e2e3948647f47c">seaf_repo_manager_init_merge_scheduler</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="virtual-repo_8c_source.html#l00967">967</a> of file <a class="el" href="virtual-repo_8c_source.html">virtual-repo.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    scheduler = g_new0 (<a class="code" href="structMergeScheduler.html">MergeScheduler</a>, 1);
    <span class="keywordflow">if</span> (!scheduler)
        <span class="keywordflow">return</span> -1;

    pthread_mutex_init (&amp;scheduler-&gt;<a class="code" href="structMergeScheduler.html#a83d1e13daf7c64ac3fb1e3c2859ac9f9">q_lock</a>, NULL);

    scheduler-&gt;<a class="code" href="structMergeScheduler.html#a6982da78986ec10f326f4fd82e21301f">queue</a> = g_queue_new ();
    scheduler-&gt;<a class="code" href="structMergeScheduler.html#a04c5f9e5c29f3a5c8387217e2c9fc327">running</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
                                                g_free, g_free);

    scheduler-&gt;<a class="code" href="structMergeScheduler.html#a8e2741aaec76ea29ca430e2defbdd1e1">tpool</a> = <a class="code" href="job-mgr_8h.html#af6f650ef4b54aace587f2e3e4bd1e622">ccnet_job_manager_new</a> (<a class="code" href="virtual-repo_8c.html#ab3a5a8b3812ad5665b82e89aa83bd880">MAX_RUNNING_TASKS</a>);
    scheduler-&gt;<a class="code" href="structMergeScheduler.html#a82de20ac4f4c2a7f9b9336e2f4322e41">timer</a> = <a class="code" href="timer_8h.html#a68b6afb704a7f56b625ed78146691b7c">ccnet_timer_new</a> (schedule_merge_tasks,
                                        scheduler,
                                        <a class="code" href="virtual-repo_8c.html#af66ade775b3232f46645be3b78ac46de">SCHEDULE_INTERVAL</a>);
    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a4f04f29fd9180ef2982cc0d7bfeee5e4"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_is_inner_pub_repo" ref="a4f04f29fd9180ef2982cc0d7bfeee5e4" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gboolean <a class="el" href="server_2repo-mgr_8h.html#a4f04f29fd9180ef2982cc0d7bfeee5e4">seaf_repo_manager_is_inner_pub_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02510">2510</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    gboolean db_err = FALSE;

    <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#af77a76302b3316a4d71e418de27843c4">seaf_db_statement_exists</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                     <span class="stringliteral">&quot;SELECT repo_id FROM InnerPubRepo WHERE repo_id=?&quot;</span>,
                                     &amp;db_err, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a7e2d25a533ae3eeced99134a7ffb5dbe"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_is_valid_filename" ref="a7e2d25a533ae3eeced99134a7ffb5dbe" args="(SeafRepoManager *mgr, const char *repo_id, const char *filename, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a7e2d25a533ae3eeced99134a7ffb5dbe">seaf_repo_manager_is_valid_filename</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02634">2634</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (<a class="code" href="server_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a>(filename, NULL))
        <span class="keywordflow">return</span> 0;
    <span class="keywordflow">else</span>
        <span class="keywordflow">return</span> 1;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a0b9efffb3301d72133b4a3fdd28fc69c"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_is_virtual_repo" ref="a0b9efffb3301d72133b4a3fdd28fc69c" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gboolean <a class="el" href="virtual-repo_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c">seaf_repo_manager_is_virtual_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="fuse_2repo-mgr_8c_source.html#l00420">420</a> of file <a class="el" href="fuse_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> sql[256];
    gboolean db_err;

    snprintf (sql, 256,
              <span class="stringliteral">&quot;SELECT 1 FROM VirtualRepo WHERE repo_id = &#39;%s&#39;&quot;</span>, repo_id);
    <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a6410cd243563343861ba3c6c16fc06a7">seaf_db_check_for_existence</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, &amp;db_err);
}
</pre></div>
</div>
</div>
<a class="anchor" id="adcbb183301f879ab82eea84aaf8d88b6"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_list_dir_with_perm" ref="adcbb183301f879ab82eea84aaf8d88b6" args="(SeafRepoManager *mgr, const char *repo_id, const char *dir_path, const char *dir_id, const char *user, int offset, int limit, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="repo-perm_8c.html#adcbb183301f879ab82eea84aaf8d88b6">seaf_repo_manager_list_dir_with_perm</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dir_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dir_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>offset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>limit</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="repo-perm_8c_source.html#l00184">184</a> of file <a class="el" href="repo-perm_8c_source.html">repo-perm.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
    <span class="keywordtype">char</span> *perm = NULL;
    <a class="code" href="struct__SeafDir.html">SeafDir</a> *dir;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *dent;
    <a class="code" href="struct__SeafileDirent.html">SeafileDirent</a> *d;
    GList *res = NULL;
    GList *p;

    <span class="keywordflow">if</span> (!repo_id || !<a class="code" href="seafile_2lib_2utils_8c.html#a48ecdc72b727191abafbbf2ec1f70ace">is_uuid_valid</a>(repo_id) || dir_id == NULL || !user) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a3524852b444777db39daa4b6e65403a9">SEAF_ERR_BAD_DIR_ID</a>, <span class="stringliteral">&quot;Bad dir id&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    perm = <a class="code" href="server_2repo-mgr_8h.html#a6a318e5a5bcb0d46286030040ab6e23b">seaf_repo_manager_check_permission</a> (mgr, repo_id, user, error);
    <span class="keywordflow">if</span> (!perm) {
        <span class="keywordflow">if</span> (*error == NULL)
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Access denied&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id);
    <span class="keywordflow">if</span> (!repo) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Bad repo id&quot;</span>);
        g_free (perm);
        <span class="keywordflow">return</span> NULL;
    }

    dir = <a class="code" href="fs-mgr_8c.html#a08103ffc3a5cd19b70167404c39ce3e4">seaf_fs_manager_get_seafdir</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, dir_id);
    <span class="keywordflow">if</span> (!dir) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a3524852b444777db39daa4b6e65403a9">SEAF_ERR_BAD_DIR_ID</a>, <span class="stringliteral">&quot;Bad dir id&quot;</span>);
        <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
        g_free (perm);
        <span class="keywordflow">return</span> NULL;
    }

    dir-&gt;<a class="code" href="struct__SeafDir.html#ae45d2a99b493e8a080e910d2fd580df4">entries</a> = g_list_sort (dir-&gt;<a class="code" href="struct__SeafDir.html#ae45d2a99b493e8a080e910d2fd580df4">entries</a>, comp_dirent_func);

    <span class="keywordflow">if</span> (offset &lt; 0) {
        offset = 0;
    }

    <span class="keywordtype">int</span> index = 0;
    <span class="keywordflow">for</span> (p = dir-&gt;<a class="code" href="struct__SeafDir.html#ae45d2a99b493e8a080e910d2fd580df4">entries</a>; p != NULL; p = p-&gt;next, index++) {
        <span class="keywordflow">if</span> (index &lt; offset) {
            <span class="keywordflow">continue</span>;
        }

        <span class="keywordflow">if</span> (limit &gt; 0) {
            <span class="keywordflow">if</span> (index &gt;= offset + limit)
                <span class="keywordflow">break</span>;
        }

        dent = p-&gt;data;
        d = g_object_new (<a class="code" href="dir_8c.html#af4a34b4cb65b9bd0de24f86245420dc4">SEAFILE_TYPE_DIRENT</a>,
                          <span class="stringliteral">&quot;obj_id&quot;</span>, dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>,
                          <span class="stringliteral">&quot;obj_name&quot;</span>, dent-&gt;<a class="code" href="struct__SeafDirent.html#a400094123179edfd24b0db4925780624">name</a>,
                          <span class="stringliteral">&quot;mode&quot;</span>, dent-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>,
                          <span class="stringliteral">&quot;version&quot;</span>, dent-&gt;<a class="code" href="struct__SeafDirent.html#afc58a80e040b009230ce1d3d500e2f1f">version</a>,
                          <span class="stringliteral">&quot;mtime&quot;</span>, dent-&gt;<a class="code" href="struct__SeafDirent.html#a42acf83af54b1c20696b5f288bbdd681">mtime</a>,
                          <span class="stringliteral">&quot;size&quot;</span>, dent-&gt;<a class="code" href="struct__SeafDirent.html#abf0e9b6fade594b7897cb9896d370961">size</a>,
                          <span class="stringliteral">&quot;permission&quot;</span>, perm,
                          NULL);
        res = g_list_prepend (res, d);
    }

    <a class="code" href="fs-mgr_8c.html#ae04d3c4669cd7b0fc691cd2da6dc2de1">seaf_dir_free</a> (dir);
    <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    g_free (perm);
    res = g_list_reverse (res);
    <span class="keywordflow">return</span> res;
}
</pre></div>
</div>
</div>
<a class="anchor" id="afa299e57b701699e37969cc2e674290e"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_list_file_revisions" ref="afa299e57b701699e37969cc2e674290e" args="(SeafRepoManager *mgr, const char *repo_id, const char *start_commit_id, const char *path, int max_revision, int limit, int show_days, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="repo-op_8c.html#afa299e57b701699e37969cc2e674290e">seaf_repo_manager_list_file_revisions</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>start_commit_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>max_revision</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>limit</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>show_days</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="repo-op_8c_source.html#l04150">4150</a> of file <a class="el" href="repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    GList *commit_list = NULL, *file_id_list = NULL, *file_size_list = NULL;
    GList *ret = NULL, *ptr;
    <a class="code" href="structCollectRevisionParam.html">CollectRevisionParam</a> data = {0};
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *last_commit = NULL;
    <span class="keyword">const</span> <span class="keywordtype">char</span> *head_id;
    gboolean is_renamed = FALSE;
    <span class="keywordtype">char</span> *parent_id = NULL, *old_path = NULL;
    GList *old_revisions = NULL;
    <span class="keywordtype">int</span> show_time;

    repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (!repo) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;No such repo %s&quot;</span>, repo_id);
        <span class="keywordflow">goto</span> out;
    }

    data.<a class="code" href="structCollectRevisionParam.html#aefdd21c923c8e2ded6bbedd873330917">repo</a> = repo;

    <span class="keywordflow">if</span> (!start_commit_id)
        head_id = repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>;
    <span class="keywordflow">else</span>
        head_id = start_commit_id;

    data.<a class="code" href="structCollectRevisionParam.html#a7effc9fefdddf4fb6ff33a8b4d0d89f4">path</a> = path;
    data.<a class="code" href="structCollectRevisionParam.html#ac0bbd922f51e1ef92702fed289b16199">error</a> = error;
    data.<a class="code" href="structCollectRevisionParam.html#a8f727a17d75f4a2459d65ee3513a319c">max_revision</a> = max_revision;

    show_time = show_days &gt; 0 ? time(NULL) - show_days*24*3600 : -1;
    data.<a class="code" href="structCollectRevisionParam.html#ac3711b50d3a73a6f766fe2bcaa6d378c">truncate_time</a> = MAX (show_time,
                              <a class="code" href="server_2gc_2repo-mgr_8c.html#a774e0a8ea59c07c94dc8014612b3f948">seaf_repo_manager_get_repo_truncate_time</a> (mgr, repo_id));
    data.<a class="code" href="structCollectRevisionParam.html#afb48d0273a311d406762eb7107c4db5b">wanted_commits</a> = NULL;
    data.<a class="code" href="structCollectRevisionParam.html#a0e5ad481f5fdfce7e9cb8cca877a09b7">file_id_list</a> = NULL;
    data.<a class="code" href="structCollectRevisionParam.html#a4a0f3abda0eee160546db7df68971b92">file_size_list</a> = NULL;

    <span class="comment">/* A hash table to cache caculated file info of &lt;path&gt; in &lt;commit&gt; */</span>
    data.<a class="code" href="structCollectRevisionParam.html#a8b2e38b75301d5e0228fd3f903489741">file_info_cache</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
                                                  g_free, free_file_info);

    <span class="keywordflow">if</span> (!<a class="code" href="commit-mgr_8c.html#a032f260db46d5566e78dfcbbc4b2859a">seaf_commit_manager_traverse_commit_tree_with_limit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
                                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                              head_id,
                                                              (<a class="code" href="commit-mgr_8h.html#ace73a042fe8571009de1750edb729c83">CommitTraverseFunc</a>)collect_file_revisions,
                                                              limit, &amp;data, TRUE)) {
        g_clear_error (error);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;failed to traverse commit of repo %s&quot;</span>, repo_id);
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (!data.<a class="code" href="structCollectRevisionParam.html#afb48d0273a311d406762eb7107c4db5b">wanted_commits</a>) {
        g_clear_error (error);
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* commit list in descending commit time order. */</span>
    last_commit = data.<a class="code" href="structCollectRevisionParam.html#afb48d0273a311d406762eb7107c4db5b">wanted_commits</a>-&gt;data;

    is_renamed = detect_rename_revision (repo,
                                         last_commit, path, &amp;parent_id, &amp;old_path);

    commit_list = g_list_reverse (data.<a class="code" href="structCollectRevisionParam.html#afb48d0273a311d406762eb7107c4db5b">wanted_commits</a>);
    file_id_list = g_list_reverse (data.<a class="code" href="structCollectRevisionParam.html#a0e5ad481f5fdfce7e9cb8cca877a09b7">file_id_list</a>);
    file_size_list = g_list_reverse (data.<a class="code" href="structCollectRevisionParam.html#a4a0f3abda0eee160546db7df68971b92">file_size_list</a>);

    ret = convert_rpc_commit_list (commit_list, file_id_list, file_size_list,
                                   is_renamed, old_path);

    <span class="keywordflow">if</span> (is_renamed) {
        <span class="comment">/* Get the revisions of the old path, starting from parent commit. */</span>
        old_revisions = <a class="code" href="server_2repo-mgr_8h.html#afa299e57b701699e37969cc2e674290e">seaf_repo_manager_list_file_revisions</a> (mgr, repo_id,
                                                               parent_id, old_path,
                                                               -1, -1, show_days,
                                                               error);
        ret = g_list_concat (ret, old_revisions);
        g_free (parent_id);
        g_free (old_path);
    }

    g_clear_error (error);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">for</span> (ptr = commit_list; ptr; ptr = ptr-&gt;next)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> ((<a class="code" href="struct__SeafCommit.html">SeafCommit</a> *)ptr-&gt;data);
    g_list_free (commit_list);
    <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (file_id_list);
    <span class="keywordflow">for</span> (ptr = file_size_list; ptr; ptr = ptr-&gt;next)
        g_free (ptr-&gt;data);
    g_list_free (file_size_list);
    <span class="keywordflow">if</span> (data.<a class="code" href="structCollectRevisionParam.html#a8b2e38b75301d5e0228fd3f903489741">file_info_cache</a>)
        g_hash_table_destroy (data.<a class="code" href="structCollectRevisionParam.html#a8b2e38b75301d5e0228fd3f903489741">file_info_cache</a>);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a715b426c9fadfc393ece3afdec8587f7"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_list_inner_pub_repos" ref="a715b426c9fadfc393ece3afdec8587f7" args="(SeafRepoManager *mgr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a715b426c9fadfc393ece3afdec8587f7">seaf_repo_manager_list_inner_pub_repos</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02562">2562</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *ret = NULL, *p;
    <span class="keywordtype">char</span> *sql;

    sql = <span class="stringliteral">&quot;SELECT InnerPubRepo.repo_id, VirtualRepo.repo_id, &quot;</span>
        <span class="stringliteral">&quot;owner_id, permission, commit_id &quot;</span>
        <span class="stringliteral">&quot;FROM InnerPubRepo LEFT JOIN VirtualRepo ON &quot;</span>
        <span class="stringliteral">&quot;InnerPubRepo.repo_id=VirtualRepo.repo_id, RepoOwner, Branch &quot;</span>
        <span class="stringliteral">&quot;WHERE InnerPubRepo.repo_id=RepoOwner.repo_id AND &quot;</span>
        <span class="stringliteral">&quot;InnerPubRepo.repo_id = Branch.repo_id AND Branch.name = &#39;master&#39;&quot;</span>;

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                       collect_public_repos, &amp;ret,
                                       0) &lt; 0) {
        <span class="keywordflow">for</span> (p = ret; p != NULL; p = p-&gt;next)
            g_object_unref (p-&gt;data);
        g_list_free (ret);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> g_list_reverse (ret);    
}
</pre></div>
</div>
</div>
<a class="anchor" id="a8be31ce1507a9a9fb63e15123961acdb"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_list_inner_pub_repos_by_owner" ref="a8be31ce1507a9a9fb63e15123961acdb" args="(SeafRepoManager *mgr, const char *user)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a8be31ce1507a9a9fb63e15123961acdb">seaf_repo_manager_list_inner_pub_repos_by_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02597">2597</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *ret = NULL, *p;
    <span class="keywordtype">char</span> *sql;

    sql = <span class="stringliteral">&quot;SELECT InnerPubRepo.repo_id, VirtualRepo.repo_id, &quot;</span>
        <span class="stringliteral">&quot;owner_id, permission, commit_id &quot;</span>
        <span class="stringliteral">&quot;FROM InnerPubRepo LEFT JOIN VirtualRepo ON &quot;</span>
        <span class="stringliteral">&quot;InnerPubRepo.repo_id=VirtualRepo.repo_id, RepoOwner, Branch &quot;</span>
        <span class="stringliteral">&quot;WHERE InnerPubRepo.repo_id=RepoOwner.repo_id AND owner_id=? &quot;</span>
        <span class="stringliteral">&quot;AND InnerPubRepo.repo_id = Branch.repo_id AND Branch.name = &#39;master&#39;&quot;</span>;

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                       collect_public_repos, &amp;ret,
                                       1, <span class="stringliteral">&quot;string&quot;</span>, user) &lt; 0) {
        <span class="keywordflow">for</span> (p = ret; p != NULL; p = p-&gt;next)
            g_object_unref (p-&gt;data);
        g_list_free (ret);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> g_list_reverse (ret);    
}
</pre></div>
</div>
</div>
<a class="anchor" id="afab1803ccaa8885ec65db8075e87a40a"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_list_repo_tokens" ref="afab1803ccaa8885ec65db8075e87a40a" args="(SeafRepoManager *mgr, const char *repo_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#afab1803ccaa8885ec65db8075e87a40a">seaf_repo_manager_list_repo_tokens</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l01253">1253</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *ret_list = NULL;
    <span class="keywordtype">char</span> *sql;
    gboolean db_err = FALSE;

    <span class="keywordflow">if</span> (!repo_exists_in_db (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, repo_id, &amp;db_err)) {
        <span class="keywordflow">if</span> (db_err) {
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
        }
        <span class="keywordflow">return</span> NULL;
    }

    sql = <span class="stringliteral">&quot;SELECT u.repo_id, o.owner_id, u.email, u.token, &quot;</span>
        <span class="stringliteral">&quot;p.peer_id, p.peer_ip, p.peer_name, p.sync_time &quot;</span>
        <span class="stringliteral">&quot;FROM RepoUserToken u LEFT JOIN RepoTokenPeerInfo p &quot;</span>
        <span class="stringliteral">&quot;ON u.token = p.token, RepoOwner o &quot;</span>
        <span class="stringliteral">&quot;WHERE u.repo_id = ? and o.repo_id = ? &quot;</span>;

    <span class="keywordtype">int</span> n_row = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                              collect_repo_token, &amp;ret_list,
                                              2, <span class="stringliteral">&quot;string&quot;</span>, repo_id,
                                              <span class="stringliteral">&quot;string&quot;</span>, repo_id);
    <span class="keywordflow">if</span> (n_row &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;DB error when get token info for repo %.10s.\n&quot;</span>,
                      repo_id);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
    }

    fill_in_token_info (ret_list);

    <span class="keywordflow">return</span> g_list_reverse(ret_list);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a754dc377da1101690257dd8be7fbe78f"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_list_repo_tokens_by_email" ref="a754dc377da1101690257dd8be7fbe78f" args="(SeafRepoManager *mgr, const char *email, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">GList* <a class="el" href="server_2repo-mgr_8h.html#a754dc377da1101690257dd8be7fbe78f">seaf_repo_manager_list_repo_tokens_by_email</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>email</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l01290">1290</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *ret_list = NULL;
    <span class="keywordtype">char</span> *sql;

    sql = <span class="stringliteral">&quot;SELECT u.repo_id, o.owner_id, u.email, u.token, &quot;</span>
        <span class="stringliteral">&quot;p.peer_id, p.peer_ip, p.peer_name, p.sync_time &quot;</span>
        <span class="stringliteral">&quot;FROM RepoUserToken u LEFT JOIN RepoTokenPeerInfo p &quot;</span>
        <span class="stringliteral">&quot;ON u.token = p.token, RepoOwner o &quot;</span>
        <span class="stringliteral">&quot;WHERE u.email = ? and u.repo_id = o.repo_id&quot;</span>;

    <span class="keywordtype">int</span> n_row = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
                                              collect_repo_token, &amp;ret_list,
                                              1, <span class="stringliteral">&quot;string&quot;</span>, email);
    <span class="keywordflow">if</span> (n_row &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;DB error when get token info for email %s.\n&quot;</span>,
                      email);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
    }

    fill_in_token_info (ret_list);

    <span class="keywordflow">return</span> g_list_reverse(ret_list);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a30755ff2c01595d4927715310beaee04"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_merge_virtual_repo" ref="a30755ff2c01595d4927715310beaee04" args="(SeafRepoManager *mgr, const char *repo_id, const char *exclude_repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="virtual-repo_8c.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>exclude_repo</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="virtual-repo_8c_source.html#l00485">485</a> of file <a class="el" href="virtual-repo_8c_source.html">virtual-repo.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    GList *vrepos = NULL, *ptr;
    <span class="keywordtype">char</span> *vrepo_id;
    <span class="keywordtype">int</span> ret = 0;

    <span class="keywordflow">if</span> (<a class="code" href="fuse_2repo-mgr_8c.html#a0b9efffb3301d72133b4a3fdd28fc69c">seaf_repo_manager_is_virtual_repo</a> (mgr, repo_id)) {
        add_merge_task (repo_id);
        <span class="keywordflow">return</span> 0;
    }

    vrepos = <a class="code" href="server_2gc_2repo-mgr_8c.html#a0e2fecd8fae5355455342e43f6588967">seaf_repo_manager_get_virtual_repo_ids_by_origin</a> (mgr, repo_id);
    <span class="keywordflow">for</span> (ptr = vrepos; ptr; ptr = ptr-&gt;next) {
        vrepo_id = ptr-&gt;data;

        <span class="keywordflow">if</span> (g_strcmp0 (exclude_repo, vrepo_id) == 0)
            <span class="keywordflow">continue</span>;

        add_merge_task (vrepo_id);
    }

    <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (vrepos);
    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a056b45d63edfafbc5287012a2a1062ec"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_move_file" ref="a056b45d63edfafbc5287012a2a1062ec" args="(SeafRepoManager *mgr, const char *src_repo_id, const char *src_dir, const char *src_filename, const char *dst_repo_id, const char *dst_dir, const char *dst_filename, const char *user, int need_progress, int synchronous, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="copy-task_8c.html#a464af47cf9e39f4bd55f0f0dd0ee506a">SeafileCopyResult</a>* <a class="el" href="repo-op_8c.html#ac11bd852cc7cc4f30e40123b7bae901e">seaf_repo_manager_move_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>src_repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>src_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>src_filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dst_repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dst_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dst_filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>need_progress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>synchronous</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="repo-op_8c_source.html#l02063">2063</a> of file <a class="el" href="repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *src_repo = NULL, *dst_repo = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *src_dent = NULL, *dst_dent = NULL;
    <span class="keywordtype">char</span> *src_canon_path = NULL, *dst_canon_path = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *dst_head_commit = NULL;
    <span class="keywordtype">int</span> ret = 0;
    gboolean background = FALSE;
    <span class="keywordtype">char</span> *task_id = NULL;
    <a class="code" href="struct__SeafileCopyResult.html">SeafileCopyResult</a> *res = NULL;

    <a class="code" href="repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(src_repo, src_repo_id);

    <span class="keywordflow">if</span> (strcmp(src_repo_id, dst_repo_id) != 0) {
        <a class="code" href="repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(dst_repo, dst_repo_id);

        <span class="keywordflow">if</span> (src_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a> || dst_repo-&gt;encrypted) {
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                         <span class="stringliteral">&quot;Can&#39;t copy files between encrypted repo(s)&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
        
    } <span class="keywordflow">else</span> {
        <a class="code" href="fuse_2repo-mgr_8c.html#ab8f60cbbd6c35ee55ea72acbbd3a1608">seaf_repo_ref</a> (src_repo);
        dst_repo = src_repo;
    }
    
    src_canon_path = get_canonical_path (src_path);
    dst_canon_path = get_canonical_path (dst_path);
    <span class="comment">/* first check whether a file with file_name already exists in destination dir */</span>
    <a class="code" href="repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(dst_head_commit,
                       dst_repo-&gt;id, dst_repo-&gt;<a class="code" href="struct__SeafCommit.html#abc83f168ce2b43fa864522bf0ea26d6d">version</a>, 
                       dst_repo-&gt;head-&gt;commit_id);
    <a class="code" href="repo-op_8c.html#a897aab32c75a36b188922b8726831ccf">FAIL_IF_FILE_EXISTS</a>(dst_repo-&gt;store_id, dst_repo-&gt;version,
                        dst_head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, dst_canon_path, dst_filename, NULL);

    <span class="comment">/* get src dirent */</span>
    src_dent = get_dirent_by_path (src_repo, NULL,
                                   src_canon_path, src_filename, error);
    <span class="keywordflow">if</span> (!src_dent) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    gint64 <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a> = (src_dent-&gt;<a class="code" href="struct__SeafDirent.html#afc58a80e040b009230ce1d3d500e2f1f">version</a> &gt; 0) ? src_dent-&gt;<a class="code" href="struct__SeafDirent.html#abf0e9b6fade594b7897cb9896d370961">size</a> : -1;

    if (src_repo == dst_repo) {
        <span class="comment">/* duplicate src dirent with new name */</span>
        dst_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a> (dst_repo-&gt;version),
                                    src_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>, src_dent-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>, dst_filename,
                                    (gint64)time(NULL), user, file_size);

        <span class="comment">/* move file within the same repo */</span>
        <span class="keywordflow">if</span> (move_file_same_repo (src_repo_id,
                                 src_canon_path, src_dent,
                                 dst_canon_path, dst_dent,
                                 user, error) &lt; 0) {
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }

        <a class="code" href="server_2repo-mgr_8h.html#a1cd4a8c70076d40d2a778dda774a2263">seaf_repo_manager_cleanup_virtual_repos</a> (mgr, src_repo_id);
        <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, src_repo_id, NULL);

        update_repo_size (dst_repo_id);
    } <span class="keywordflow">else</span> {
        <span class="comment">/* move between different repos */</span>

        <span class="keywordflow">if</span> (is_virtual_repo_and_origin (src_repo, dst_repo)) {
            <span class="comment">/* duplicate src dirent with new name */</span>
            dst_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(dst_repo-&gt;version),
                                        src_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>, src_dent-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>, dst_filename,
                                        (gint64)time(NULL), user, file_size);

            <span class="comment">/* add this dirent to dst repo */</span>
            <span class="keywordflow">if</span> (put_dirent_and_commit (dst_repo,
                                       dst_canon_path,
                                       dst_dent,
                                       user,
                                       error) &lt; 0) {
                <span class="keywordflow">if</span> (!error)
                    g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                                 <span class="stringliteral">&quot;failed to put dirent&quot;</span>);
                ret = -1;
                <span class="keywordflow">goto</span> out;
            }

            <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, dst_repo_id, NULL);

            <span class="keywordflow">if</span> (<a class="code" href="server_2repo-mgr_8h.html#ad6564c23b0e50d8a34dd425432b80db4">seaf_repo_manager_del_file</a> (mgr, src_repo_id, src_path,
                                            src_filename, user, error) &lt; 0) {
                ret = -1;
                <span class="keywordflow">goto</span> out;
            }

            <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, src_repo_id, NULL);

            update_repo_size (dst_repo_id);
        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!synchronous) {
            background = TRUE;

            gint64 total_files = -1;
            <span class="keywordflow">if</span> (S_ISDIR(src_dent-&gt;<a class="code" href="struct__SeafDirent.html#a823df197de2c76627746de18e9b6ce02">mode</a>))
                total_files = <a class="code" href="fs-mgr_8c.html#afa141245d62ac11820ad120fef68d01e">seaf_fs_manager_count_fs_files</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                                              src_repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>,
                                                              src_repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                              src_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
            <span class="keywordflow">else</span>
                total_files = 1;
            <span class="keywordflow">if</span> (total_files &lt; 0) {
                seaf_warning (<span class="stringliteral">&quot;Failed to get file count.\n&quot;</span>);
                ret = -1;
                <span class="keywordflow">goto</span> out;
            }

            <span class="keywordflow">if</span> (!check_file_count_and_size (src_repo, src_dent, total_files, error)) {
                ret = -1;
                <span class="keywordflow">goto</span> out;
            }

            task_id = <a class="code" href="copy-mgr_8c.html#ae731d17024807023ab2689f9ffca5e99">seaf_copy_manager_add_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a1826aa8bcba056a4f41755627b270751">copy_mgr</a>,
                                                  src_repo_id,
                                                  src_canon_path,
                                                  src_filename,
                                                  dst_repo_id,
                                                  dst_canon_path,
                                                  dst_filename,
                                                  user,
                                                  total_files,
                                                  cross_repo_move,
                                                  need_progress);
            <span class="keywordflow">if</span> (need_progress &amp;&amp; !task_id) {
                seaf_warning (<span class="stringliteral">&quot;Failed to start copy task.\n&quot;</span>);
                g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                             <span class="stringliteral">&quot;failed to start copy task&quot;</span>);
                ret = -1;
                <span class="keywordflow">goto</span> out;
            }
        } <span class="keywordflow">else</span> {
            <span class="comment">/* Synchronous for cross-repo move */</span>
            <span class="keywordflow">if</span> (cross_repo_move (src_repo_id,
                                 src_canon_path,
                                 src_filename,
                                 dst_repo_id,
                                 dst_canon_path,
                                 dst_filename,
                                 user,
                                 NULL) &lt; 0) {
                g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                             <span class="stringliteral">&quot;Failed to move&quot;</span>);
                ret = -1;
                <span class="keywordflow">goto</span> out;
            }
        }
    }

out:
    <span class="keywordflow">if</span> (src_repo) <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (src_repo);
    <span class="keywordflow">if</span> (dst_repo) <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (dst_repo);

    <span class="keywordflow">if</span> (dst_head_commit) <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(dst_head_commit);
    
    <span class="keywordflow">if</span> (src_canon_path) g_free (src_canon_path);
    <span class="keywordflow">if</span> (dst_canon_path) g_free (dst_canon_path);
    
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a>(src_dent);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a>(dst_dent);

    <span class="keywordflow">if</span> (ret == 0) {
        res = <a class="code" href="copy-task_8c.html#a828878066e3a11e3b2587b55cb00ee54">seafile_copy_result_new</a> ();
        g_object_set (res, <span class="stringliteral">&quot;background&quot;</span>, background, <span class="stringliteral">&quot;task_id&quot;</span>, task_id, NULL);
        g_free (task_id);
    }

    <span class="keywordflow">return</span> res;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a640edf431de146c19d5ac2cff6321397"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_new" ref="a640edf431de146c19d5ac2cff6321397" args="(struct _SeafileSession *seaf)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a>* <a class="el" href="server_2repo-mgr_8h.html#a640edf431de146c19d5ac2cff6321397">seaf_repo_manager_new</a> </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="struct__SeafileSession.html">_SeafileSession</a> *&#160;</td>
          <td class="paramname"><em>seaf</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2repo-mgr_8c_source.html#l03899">3899</a> of file <a class="el" href="daemon_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = g_new0 (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a>, 1);

    mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a> = g_new0 (<a class="code" href="struct__SeafRepoManagerPriv.html">SeafRepoManagerPriv</a>, 1);
    mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a> = <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>;
    mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a> = g_build_path (<a class="code" href="vc-utils_8h.html#aa7da4cdc6796b13fca1a4b263488dfdd">PATH_SEPERATOR</a>, seaf-&gt;<a class="code" href="struct__SeafileSession.html#ae4df188e5674e3e4b405f14d0ee1bf9f">seaf_dir</a>, <a class="code" href="daemon_2repo-mgr_8c.html#a823aa5bebe4b4b836619cae12751b8a5">INDEX_DIR</a>, NULL);

    pthread_mutex_init (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2d296323690da59659d544a5064a7f86">db_lock</a>, NULL);

    mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a838d8143e2728faf6cd40dcd4e6a2f3e">checkout_tasks_hash</a> = g_hash_table_new_full
        (g_str_hash, g_str_equal, g_free, g_free);

    ignore_patterns = g_new0 (GPatternSpec*, G_N_ELEMENTS(ignore_table));
    <span class="keywordtype">int</span> i;
    <span class="keywordflow">for</span> (i = 0; ignore_table[i] != NULL; i++) {
        ignore_patterns[i] = g_pattern_spec_new (ignore_table[i]);
    }

    office_temp_ignore_patterns[0] = g_pattern_spec_new(<span class="stringliteral">&quot;~$*&quot;</span>);
    <span class="comment">/* for files like ~WRL0001.tmp */</span>
    office_temp_ignore_patterns[1] = g_pattern_spec_new(<span class="stringliteral">&quot;~*.tmp&quot;</span>);
    office_temp_ignore_patterns[2] = g_pattern_spec_new(<span class="stringliteral">&quot;.~lock*#&quot;</span>);
    office_temp_ignore_patterns[3] = NULL;

    mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2f794f66ac8c2ae2d902a881cf505a80">repo_hash</a> = g_hash_table_new_full (g_str_hash, g_str_equal, g_free, NULL);

    pthread_rwlock_init (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>, NULL);

    <span class="keywordflow">return</span> mgr;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa870306d94f3e7b16e66229040590138"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_post_dir" ref="aa870306d94f3e7b16e66229040590138" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *new_dir_name, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#aa870306d94f3e7b16e66229040590138">seaf_repo_manager_post_dir</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new_dir_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="repo-op_8c_source.html#l02252">2252</a> of file <a class="el" href="repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (new_dir_name, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[post dir] Invalid dir name %s.\n&quot;</span>, new_dir_name);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid dir name&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="repo-op_8c.html#a897aab32c75a36b188922b8726831ccf">FAIL_IF_FILE_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                        head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dir_name, NULL);

    <span class="keywordflow">if</span> (!new_dent) {
        new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                    <a class="code" href="seafile_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>, S_IFDIR, new_dir_name,
                                    (gint64)time(NULL), NULL, -1);
    }

    root_id = do_post_file (repo,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[put dir] Failed to put dir.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to put dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    snprintf(buf, <a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Added directory \&quot;%s\&quot;&quot;</span>, new_dir_name);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (root_id);
    g_free (canon_path);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a2e0e32263ad7bbeaa4ab13a62135c46a"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_post_empty_file" ref="a2e0e32263ad7bbeaa4ab13a62135c46a" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *new_file_name, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a2e0e32263ad7bbeaa4ab13a62135c46a">seaf_repo_manager_post_empty_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new_file_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="repo-op_8c_source.html#l02322">2322</a> of file <a class="el" href="repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    <span class="keywordflow">if</span> (!canon_path)
        <span class="comment">/* no need to call get_canonical_path again when retry */</span>
        canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (new_file_name, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[post file] Invalid file name %s.\n&quot;</span>, new_file_name);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid file name&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="repo-op_8c.html#a897aab32c75a36b188922b8726831ccf">FAIL_IF_FILE_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                        head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_file_name, NULL);

    <span class="keywordflow">if</span> (!new_dent) {
        new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                    <a class="code" href="seafile_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>, <a class="code" href="repo-op_8c.html#a68c7bdf3d604f5310c1a353eab98692f">STD_FILE_MODE</a>, new_file_name,
                                    (gint64)time(NULL), user, 0);
    }

    root_id = do_post_file (repo,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[put dir] Failed to create empty file dir.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to put dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    snprintf(buf, <a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Added \&quot;%s\&quot;&quot;</span>, new_file_name);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (root_id);
    g_free (canon_path);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a3128bd2930667427a22976b6a2b85743"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_post_file" ref="a3128bd2930667427a22976b6a2b85743" args="(SeafRepoManager *mgr, const char *repo_id, const char *temp_file_path, const char *parent_dir, const char *file_name, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a3128bd2930667427a22976b6a2b85743">seaf_repo_manager_post_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>temp_file_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Add a new file in a repo. The content of the file is stored in a temporary file. : id of the repo : path of the temporary file : the directory to add this file : the name of the new file : author of this operation </p>

<p>Definition at line <a class="el" href="repo-op_8c_source.html#l00598">598</a> of file <a class="el" href="repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="index_8h.html#a96e76167c968d38441e90ee0488ee4aa">sha1</a>[20];
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    <span class="keywordtype">char</span> hex[41];
    <span class="keywordtype">int</span> ret = 0;

    <span class="keywordflow">if</span> (g_access (temp_file_path, R_OK) != 0) {
        seaf_warning (<span class="stringliteral">&quot;[post file] File %s doesn&#39;t exist or not readable.\n&quot;</span>,
                      temp_file_path);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid input file&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    <a class="code" href="repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    <span class="keywordflow">if</span> (!canon_path)
        canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (file_name, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[post file] Invalid filename %s.\n&quot;</span>, file_name);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid filename&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (strstr (parent_dir, <span class="stringliteral">&quot;//&quot;</span>) != NULL) {
        seaf_warning (<span class="stringliteral">&quot;[post file] parent_dir cantains // sequence.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid parent dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }
    
    <span class="comment">/* Write blocks. */</span>
    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> key[32], iv[16];
        <span class="keywordflow">if</span> (<a class="code" href="passwd-mgr_8c.html#a4f5b6064abbc55dff4873b288e4ea834">seaf_passwd_manager_get_decrypt_key_raw</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa6154751a20cdaa84110e1a8370c1164">passwd_mgr</a>,
                                                     repo_id, user,
                                                     key, iv) &lt; 0) {
            seaf_warning (<span class="stringliteral">&quot;Passwd for repo %s is not set.\n&quot;</span>, repo_id);
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;Passwd is not set&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
        crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>, key, iv);
    }

    gint64 <a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a>;
    <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#af41e85bce809b9f05ed5b20ac5eeb745">seaf_fs_manager_index_blocks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                      repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                      temp_file_path,
                                      sha1, &amp;size, crypt, TRUE) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;failed to index blocks&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to index blocks&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="seafile_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a>(sha1, hex, 20);
    new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                hex, <a class="code" href="repo-op_8c.html#a68c7bdf3d604f5310c1a353eab98692f">STD_FILE_MODE</a>, file_name,
                                (gint64)time(NULL), user, size);

    root_id = do_post_file (repo,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[post file] Failed to put file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to put file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    snprintf(buf, <a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Added \&quot;%s\&quot;&quot;</span>, file_name);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (root_id);
    g_free (canon_path);
    g_free (crypt);

    <span class="keywordflow">if</span> (ret == 0)
        update_repo_size(repo_id);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a0d6750947e09a7c4f4eb2146147e9db1"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_post_file_blocks" ref="a0d6750947e09a7c4f4eb2146147e9db1" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *file_name, const char *blockids_json, const char *paths_json, const char *user, gint64 file_size, int replace_existed, char **new_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a0d6750947e09a7c4f4eb2146147e9db1">seaf_repo_manager_post_file_blocks</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>blockids_json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>paths_json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gint64&#160;</td>
          <td class="paramname"><em>file_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>replace_existed</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>new_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="repo-op_8c_source.html#l01099">1099</a> of file <a class="el" href="repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="index_8h.html#a96e76167c968d38441e90ee0488ee4aa">sha1</a>[20];
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    GList *blockids = NULL, *paths = NULL, *ptr;
    <span class="keywordtype">char</span> hex[41];
    <span class="keywordtype">int</span> ret = 0;

    blockids = json_to_file_list (blockids_json);
    paths = json_to_file_list (paths_json);
    <span class="keywordflow">if</span> (g_list_length(blockids) != g_list_length(paths)) {
        seaf_warning (<span class="stringliteral">&quot;[post-blks] Invalid blockids or paths.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Invalid files&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">for</span> (ptr = paths; ptr; ptr = ptr-&gt;next) {
        <span class="keywordtype">char</span> *temp_file_path = ptr-&gt;data;
        <span class="keywordflow">if</span> (g_access (temp_file_path, R_OK) != 0) {
            seaf_warning (<span class="stringliteral">&quot;[post-blks] File block %s doesn&#39;t exist or not readable.\n&quot;</span>,
                          temp_file_path);
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                         <span class="stringliteral">&quot;Invalid input file&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    <a class="code" href="repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    <span class="keywordflow">if</span> (!canon_path)
        canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (file_name, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[post-blks] Invalid filename %s.\n&quot;</span>, file_name);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid filename&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (strstr (parent_dir, <span class="stringliteral">&quot;//&quot;</span>) != NULL) {
        seaf_warning (<span class="stringliteral">&quot;[post-blks] parent_dir cantains // sequence.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid parent dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Write blocks. */</span>
    <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#a562e73b605551b411fc8ccd333e26d36">seaf_fs_manager_index_file_blocks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                           repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                           paths,
                                           blockids, sha1, <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;Failed to index file blocks&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to index blocks&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="seafile_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a>(sha1, hex, 20);
    new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                hex, <a class="code" href="repo-op_8c.html#a68c7bdf3d604f5310c1a353eab98692f">STD_FILE_MODE</a>, file_name,
                                (gint64)time(NULL), user, <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>);

    root_id = do_post_file_replace (repo, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                    canon_path, replace_existed, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[post-blks] Failed to post file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to put file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    *new_id = g_strdup(hex);
    snprintf(buf, <a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Added \&quot;%s\&quot;&quot;</span>, file_name);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0)
        ret = -1;

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (blockids);
    <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (paths);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (root_id);
    g_free (canon_path);

    <span class="keywordflow">if</span> (ret == 0)
        update_repo_size(repo_id);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a248a05b4a54ff2d9302d0779cbcc3542"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_post_multi_files" ref="a248a05b4a54ff2d9302d0779cbcc3542" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *filenames_json, const char *paths_json, const char *user, int replace_existed, char **new_ids, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#ae7346d14d7ad21fef1537bf44b50273e">seaf_repo_manager_post_multi_files</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>filenames_json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>paths_json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>replace_existed</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>new_ids</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="repo-op_8c_source.html#l00950">950</a> of file <a class="el" href="repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    GList *filenames = NULL, *paths = NULL, *id_list = NULL, *name_list = NULL,
        *size_list = NULL, *ptr;
    <span class="keywordtype">char</span> *filename, *path;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="index_8h.html#a96e76167c968d38441e90ee0488ee4aa">sha1</a>[20];
    GString *buf = g_string_new (NULL);
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt = NULL;
    <span class="keywordtype">char</span> hex[41];
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    canon_path = get_canonical_path (parent_dir);

    <span class="comment">/* Decode file name and tmp file paths from json. */</span>
    filenames = json_to_file_list (filenames_json);
    paths = json_to_file_list (paths_json);
    <span class="keywordflow">if</span> (!filenames || !paths) {
        seaf_warning (<span class="stringliteral">&quot;[post files] Invalid filenames or paths.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Invalid files&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Check inputs. */</span>
    <span class="keywordflow">for</span> (ptr = filenames; ptr; ptr = ptr-&gt;next) {
        filename = ptr-&gt;data;
        <span class="keywordflow">if</span> (<a class="code" href="server_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (filename, NULL)) {
            seaf_warning (<span class="stringliteral">&quot;[post files] Invalid filename %s.\n&quot;</span>, filename);
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile_8h.html#a9bfa592ef51a797800aae08840640fc8">POST_FILE_ERR_FILENAME</a>,
                         <span class="stringliteral">&quot;%s&quot;</span>, filename);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    <span class="keywordflow">if</span> (strstr (parent_dir, <span class="stringliteral">&quot;//&quot;</span>) != NULL) {
        seaf_warning (<span class="stringliteral">&quot;[post file] parent_dir cantains // sequence.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid parent dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Index tmp files and get file id list. */</span>
    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> key[32], iv[16];
        <span class="keywordflow">if</span> (<a class="code" href="passwd-mgr_8c.html#a4f5b6064abbc55dff4873b288e4ea834">seaf_passwd_manager_get_decrypt_key_raw</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa6154751a20cdaa84110e1a8370c1164">passwd_mgr</a>,
                                                     repo_id, user,
                                                     key, iv) &lt; 0) {
            seaf_warning (<span class="stringliteral">&quot;Passwd for repo %s is not set.\n&quot;</span>, repo_id);
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;Passwd is not set&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
        crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>, key, iv);
    }

    gint64 *<a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a>;
    <span class="keywordflow">for</span> (ptr = paths; ptr; ptr = ptr-&gt;next) {
        path = ptr-&gt;data;

        size = g_new (gint64, 1);
        <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#af41e85bce809b9f05ed5b20ac5eeb745">seaf_fs_manager_index_blocks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                          repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                          path, sha1, size, crypt, TRUE) &lt; 0) {
            seaf_warning (<span class="stringliteral">&quot;failed to index blocks&quot;</span>);
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;Failed to index blocks&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }

        <a class="code" href="seafile_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a>(sha1, hex, 20);
        id_list = g_list_prepend (id_list, g_strdup(hex));
        size_list = g_list_prepend (size_list, size);
    }
    id_list = g_list_reverse (id_list);
    size_list = g_list_reverse (size_list);

    <span class="comment">/* Add the files to parent dir and commit. */</span>
    root_id = do_post_multi_files (repo, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path,
                                   filenames, id_list, size_list, user,
                                   replace_existed, &amp;name_list);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[post file] Failed to put file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>,
                     <span class="stringliteral">&quot;Failed to put file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    guint len = g_list_length (filenames);
    <span class="keywordflow">if</span> (len &gt; 1)
        g_string_printf (buf, <span class="stringliteral">&quot;Added \&quot;%s\&quot; and %u more files.&quot;</span>,
                         (<span class="keywordtype">char</span> *)(filenames-&gt;data), len - 1);
    <span class="keywordflow">else</span>
        g_string_printf (buf, <span class="stringliteral">&quot;Added \&quot;%s\&quot;.&quot;</span>, (<span class="keywordtype">char</span> *)(filenames-&gt;data));

    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf-&gt;str, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

    <span class="keywordflow">if</span> (ret_json)
        *ret_json = format_json_ret (name_list, id_list, size_list);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (filenames);
    <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (paths);
    <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (id_list);
    <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (name_list);
    <span class="keywordflow">for</span> (ptr = size_list; ptr; ptr = ptr-&gt;next)
        g_free (ptr-&gt;data);
    g_list_free (size_list);
    g_string_free (buf, TRUE);
    g_free (root_id);
    g_free (canon_path);
    g_free (crypt);

    <span class="keywordflow">if</span> (ret == 0)
        update_repo_size(repo_id);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a46c094895964e060809372262c9b9923"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_put_file" ref="a46c094895964e060809372262c9b9923" args="(SeafRepoManager *mgr, const char *repo_id, const char *temp_file_path, const char *parent_dir, const char *file_name, const char *user, const char *head_id, char **new_file_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a46c094895964e060809372262c9b9923">seaf_repo_manager_put_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>temp_file_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>head_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>new_file_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Update an existing file in a repo : same as seaf_repo_manager_post_file : the commit id for the original file version. It's optional. If it's NULL, the current repo head will be used. : The return location of the new file id </p>

<p>Definition at line <a class="el" href="repo-op_8c_source.html#l02688">2688</a> of file <a class="el" href="repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="index_8h.html#a96e76167c968d38441e90ee0488ee4aa">sha1</a>[20];
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    <span class="keywordtype">char</span> hex[41];
    <span class="keywordtype">char</span> *old_file_id = NULL, *fullpath = NULL;
    <span class="keywordtype">int</span> ret = 0;

    <span class="keywordflow">if</span> (g_access (temp_file_path, R_OK) != 0) {
        seaf_warning (<span class="stringliteral">&quot;[put file] File %s doesn&#39;t exist or not readable.\n&quot;</span>,
                      temp_file_path);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid input file&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    <a class="code" href="repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <span class="keyword">const</span> <span class="keywordtype">char</span> *base = head_id ? head_id : repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>;
    <a class="code" href="repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, base);

    <span class="keywordflow">if</span> (!canon_path)
        canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (file_name, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[put file] Invalid filename %s.\n&quot;</span>, file_name);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid filename&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (strstr (parent_dir, <span class="stringliteral">&quot;//&quot;</span>) != NULL) {
        seaf_warning (<span class="stringliteral">&quot;[put file] parent_dir cantains // sequence.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid parent dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }
    
    <a class="code" href="repo-op_8c.html#a5b81d4727cc3ed61fabaf57e9ec58fbc">FAIL_IF_FILE_NOT_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, file_name, NULL);

    <span class="comment">/* Write blocks. */</span>
    <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> key[32], iv[16];
        <span class="keywordflow">if</span> (<a class="code" href="passwd-mgr_8c.html#a4f5b6064abbc55dff4873b288e4ea834">seaf_passwd_manager_get_decrypt_key_raw</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa6154751a20cdaa84110e1a8370c1164">passwd_mgr</a>,
                                                     repo_id, user,
                                                     key, iv) &lt; 0) {
            seaf_warning (<span class="stringliteral">&quot;Passwd for repo %s is not set.\n&quot;</span>, repo_id);
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;Passwd is not set&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
        crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>, key, iv);
    }

    gint64 <a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a>;
    <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#af41e85bce809b9f05ed5b20ac5eeb745">seaf_fs_manager_index_blocks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                      repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                      temp_file_path,
                                      sha1, &amp;size, crypt, TRUE) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;failed to index blocks&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to index blocks&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }
        
    <a class="code" href="seafile_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a>(sha1, hex, 20);
    new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                hex, <a class="code" href="repo-op_8c.html#a68c7bdf3d604f5310c1a353eab98692f">STD_FILE_MODE</a>, file_name,
                                (gint64)time(NULL), user, size);

    <span class="keywordflow">if</span> (!fullpath)
        fullpath = g_build_filename(parent_dir, file_name, NULL);

    old_file_id = <a class="code" href="fs-mgr_8c.html#a60a96b2445ab49d626baac6b16e75fe9">seaf_fs_manager_path_to_obj_id</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                  head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                                  fullpath, NULL, NULL);

    <span class="keywordflow">if</span> (g_strcmp0(old_file_id, new_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>) == 0) {
        <span class="keywordflow">if</span> (new_file_id)
            *new_file_id = g_strdup(new_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
        <span class="keywordflow">goto</span> out;
    }

    root_id = do_put_file (repo, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[put file] Failed to put file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to put file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    snprintf(buf, <a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Modified \&quot;%s\&quot;&quot;</span>, file_name);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id, user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;       
    }

    <span class="keywordflow">if</span> (new_file_id)
        *new_file_id = g_strdup(new_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (root_id);
    g_free (canon_path);
    g_free (crypt);
    g_free (old_file_id);
    g_free (fullpath);

    <span class="keywordflow">if</span> (ret == 0) {
        update_repo_size (repo_id);
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aad15cfaf3210b47e9f59a481073aafbc"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_put_file_blocks" ref="aad15cfaf3210b47e9f59a481073aafbc" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *file_name, const char *blockids_json, const char *paths_json, const char *user, const char *head_id, gint64 file_size, char **new_file_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#aad15cfaf3210b47e9f59a481073aafbc">seaf_repo_manager_put_file_blocks</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>file_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>blockids_json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>paths_json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>head_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gint64&#160;</td>
          <td class="paramname"><em>file_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>new_file_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="repo-op_8c_source.html#l02938">2938</a> of file <a class="el" href="repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="index_8h.html#a96e76167c968d38441e90ee0488ee4aa">sha1</a>[20];
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> *root_id = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    <span class="keywordtype">char</span> hex[41];
    GList *blockids = NULL, *paths = NULL, *ptr;
    <span class="keywordtype">char</span> *old_file_id = NULL, *fullpath = NULL;
    <span class="keywordtype">int</span> ret = 0;

    blockids = json_to_file_list (blockids_json);
    paths = json_to_file_list (paths_json);
    <span class="keywordflow">if</span> (g_list_length(blockids) != g_list_length(paths)) {
        seaf_warning (<span class="stringliteral">&quot;[put-blks] Invalid blockids or paths.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>, <span class="stringliteral">&quot;Invalid files&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }


    <span class="keywordflow">for</span> (ptr = paths; ptr; ptr = ptr-&gt;next) {
        <span class="keywordtype">char</span> *temp_file_path = ptr-&gt;data;
        <span class="keywordflow">if</span> (g_access (temp_file_path, R_OK) != 0) {
            seaf_warning (<span class="stringliteral">&quot;[put-blks] File block %s doesn&#39;t exist or not readable.\n&quot;</span>,
                          temp_file_path);
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                         <span class="stringliteral">&quot;Invalid input file&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    <a class="code" href="repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <span class="keyword">const</span> <span class="keywordtype">char</span> *base = head_id ? head_id : repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>;
    <a class="code" href="repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, base);

    <span class="keywordflow">if</span> (!canon_path)
        canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (file_name, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[put-blks] Invalid filename %s.\n&quot;</span>, file_name);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid filename&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (strstr (parent_dir, <span class="stringliteral">&quot;//&quot;</span>) != NULL) {
        seaf_warning (<span class="stringliteral">&quot;[put-blks] parent_dir cantains // sequence.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid parent dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="repo-op_8c.html#a5b81d4727cc3ed61fabaf57e9ec58fbc">FAIL_IF_FILE_NOT_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, file_name, NULL);

    <span class="comment">/* Write blocks. */</span>
    <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#a562e73b605551b411fc8ccd333e26d36">seaf_fs_manager_index_file_blocks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                           repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                           paths,
                                           blockids, sha1, <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;failed to index blocks&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to index blocks&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="seafile_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a>(sha1, hex, 20);
    new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                hex, <a class="code" href="repo-op_8c.html#a68c7bdf3d604f5310c1a353eab98692f">STD_FILE_MODE</a>, file_name,
                                (gint64)time(NULL), user, <a class="code" href="fs-mgr_8c.html#a719775aaf4a8b8ffb6ce082b24375db0">file_size</a>);

    <span class="keywordflow">if</span> (!fullpath)
        fullpath = g_build_filename(parent_dir, file_name, NULL);

    old_file_id = <a class="code" href="fs-mgr_8c.html#a60a96b2445ab49d626baac6b16e75fe9">seaf_fs_manager_path_to_obj_id</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                                                  head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                                  fullpath, NULL, NULL);

    <span class="keywordflow">if</span> (g_strcmp0(old_file_id, new_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>) == 0) {
        <span class="keywordflow">if</span> (new_file_id)
            *new_file_id = g_strdup(new_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);
        <span class="keywordflow">goto</span> out;
    }

    root_id = do_put_file (repo, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[put-blks] Failed to put file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to put file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    snprintf(buf, <a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Modified \&quot;%s\&quot;&quot;</span>, file_name);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id, user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (new_file_id)
        *new_file_id = g_strdup(new_dent-&gt;<a class="code" href="struct__SeafDirent.html#ae85b031142d8a9360ba9c2ab8961a451">id</a>);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a>(head_commit);
    <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (blockids);
    <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (paths);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (root_id);
    g_free (canon_path);
    g_free (old_file_id);
    g_free (fullpath);

    <span class="keywordflow">if</span> (ret == 0) {
        update_repo_size (repo_id);
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a3f3921eba68da813d0d1a583c8923396"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_query_access_property" ref="a3f3921eba68da813d0d1a583c8923396" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="server_2repo-mgr_8h.html#a3f3921eba68da813d0d1a583c8923396">seaf_repo_manager_query_access_property</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02189">2189</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">char</span> *sql;
    <span class="keywordtype">char</span> *ret = NULL;

    sql =  <span class="stringliteral">&quot;SELECT access_property FROM WebAP WHERE repo_id=?&quot;</span>;
 
    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, get_ap, &amp;ret,
                                       1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;DB error when get access property for repo %s.\n&quot;</span>, repo_id);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a921cbac599e1c80869659e545d99b62f"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_remove_group_repos" ref="a921cbac599e1c80869659e545d99b62f" args="(SeafRepoManager *mgr, int group_id, const char *owner, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a921cbac599e1c80869659e545d99b62f">seaf_repo_manager_remove_group_repos</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>group_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>owner</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02444">2444</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;
    <span class="keywordtype">int</span> rc;

    <span class="keywordflow">if</span> (!owner) {
        rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db, <span class="stringliteral">&quot;DELETE FROM RepoGroup WHERE group_id=?&quot;</span>,
                                      1, <span class="stringliteral">&quot;int&quot;</span>, group_id);
    } <span class="keywordflow">else</span> {
        rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db,
                                      <span class="stringliteral">&quot;DELETE FROM RepoGroup WHERE group_id=? AND &quot;</span>
                                      <span class="stringliteral">&quot;user_name = ?&quot;</span>,
                                      2, <span class="stringliteral">&quot;int&quot;</span>, group_id, <span class="stringliteral">&quot;string&quot;</span>, owner);
    }

    <span class="keywordflow">return</span> rc;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae68e4b6427bb239b697e515c8617cbfb"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_rename_file" ref="ae68e4b6427bb239b697e515c8617cbfb" args="(SeafRepoManager *mgr, const char *repo_id, const char *parent_dir, const char *oldname, const char *newname, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#ae68e4b6427bb239b697e515c8617cbfb">seaf_repo_manager_rename_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>parent_dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>oldname</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>newname</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="repo-op_8c_source.html#l02510">2510</a> of file <a class="el" href="repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *root_id = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">int</span> <a class="code" href="index_8h.html#ac1b4d694fc07a39e06900e82872aac7f">mode</a> = 0;
    <span class="keywordtype">int</span> ret = 0;

    <span class="keywordflow">if</span> (strcmp(oldname, newname) == 0)
        <span class="keywordflow">return</span> 0;
    
    <a class="code" href="repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
    
    <span class="keywordflow">if</span> (!canon_path)
        canon_path = get_canonical_path (parent_dir);

    <span class="keywordflow">if</span> (<a class="code" href="server_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a> (newname, NULL)) {
        seaf_warning (<span class="stringliteral">&quot;[rename file] Invalid filename %s.\n&quot;</span>, newname);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;Invalid filename&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="repo-op_8c.html#a5b81d4727cc3ed61fabaf57e9ec58fbc">FAIL_IF_FILE_NOT_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, oldname, &amp;mode);
    <a class="code" href="repo-op_8c.html#a897aab32c75a36b188922b8726831ccf">FAIL_IF_FILE_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                        head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, newname, NULL);

    root_id = do_rename_file (repo, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path,
                              oldname, newname);
    <span class="keywordflow">if</span> (!root_id) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
                     <span class="stringliteral">&quot;faile to rename file %s&quot;</span>, oldname);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    <span class="keywordflow">if</span> (S_ISDIR(mode)) {
        snprintf(buf, <a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Renamed directory \&quot;%s\&quot;&quot;</span>, oldname);
    } <span class="keywordflow">else</span> {
        snprintf(buf, <a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Renamed \&quot;%s\&quot;&quot;</span>, oldname);
    }

    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a1cd4a8c70076d40d2a778dda774a2263">seaf_repo_manager_cleanup_virtual_repos</a> (mgr, repo_id);
    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (head_commit);
    g_free (canon_path);
    g_free (root_id);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a4b2497e6cdde50c4ce3cb642370e06eb"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_repo_exists" ref="a4b2497e6cdde50c4ce3cb642370e06eb" args="(SeafRepoManager *manager, const gchar *id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gboolean <a class="el" href="server_2repo-mgr_8h.html#a4b2497e6cdde50c4ce3cb642370e06eb">seaf_repo_manager_repo_exists</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const gchar *&#160;</td>
          <td class="paramname"><em>id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2repo-mgr_8c_source.html#l04228">4228</a> of file <a class="el" href="daemon_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *res;

    <span class="keywordflow">if</span> (pthread_rwlock_rdlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>) &lt; 0) {
        g_warning (<span class="stringliteral">&quot;[repo mgr] failed to lock repo cache.\n&quot;</span>);
        <span class="keywordflow">return</span> FALSE;
    }

    res = g_hash_table_lookup (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a2f794f66ac8c2ae2d902a881cf505a80">repo_hash</a>, <span class="keywordtype">id</span>);

    pthread_rwlock_unlock (&amp;manager-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);

    <span class="keywordflow">if</span> (res &amp;&amp; !res-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>)
        <span class="keywordflow">return</span> TRUE;
    
    <span class="keywordflow">return</span> FALSE;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a4db874916fe89f6b839e389d74034288"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_restore_repo_from_trash" ref="a4db874916fe89f6b839e389d74034288" args="(SeafRepoManager *mgr, const char *repo_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a4db874916fe89f6b839e389d74034288">seaf_repo_manager_restore_repo_from_trash</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02074">2074</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafileTrashRepo.html">SeafileTrashRepo</a> *repo = NULL;
    <span class="keywordtype">int</span> ret = 0;
    gboolean exists = FALSE;
    gboolean db_err;

    repo = <a class="code" href="server_2repo-mgr_8c.html#a8326627abe60741e456d4acf6e5ac244">seaf_repo_manager_get_repo_from_trash</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (!repo) {
        seaf_warning (<span class="stringliteral">&quot;Repo %.8s not found in trash.\n&quot;</span>, repo_id);
        <span class="keywordflow">return</span> -1;
    }

    <a class="code" href="structSeafDBTrans.html">SeafDBTrans</a> *trans = <a class="code" href="seaf-db_8c.html#a3f672ef795004a79886871b1d7e36862">seaf_db_begin_transaction</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>);

    exists = <a class="code" href="seaf-db_8c.html#a85906acba812801fd6ef8137920d3dcc">seaf_db_trans_check_for_existence</a> (trans,
                                                <span class="stringliteral">&quot;SELECT 1 FROM Repo WHERE repo_id=?&quot;</span>,
                                                &amp;db_err, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);

    <span class="keywordflow">if</span> (!exists) {
        ret = <a class="code" href="seaf-db_8c.html#abfa65542f46d16df51de1e82fefcebb3">seaf_db_trans_query</a> (trans,
                                   <span class="stringliteral">&quot;INSERT INTO Repo(repo_id) VALUES (?)&quot;</span>,
                                   1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0;
        <span class="keywordflow">if</span> (ret &lt; 0) {
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;DB error: Insert Repo.&quot;</span>);
            <a class="code" href="seaf-db_8c.html#a2786c0aa2d6f3629bc9ed8960e8de288">seaf_db_rollback</a> (trans);
            <a class="code" href="seaf-db_8c.html#af47f83c610aa48fca8f2f667fe2d096d">seaf_db_trans_close</a> (trans);
            <span class="keywordflow">goto</span> out;
        }
    }

    exists = <a class="code" href="seaf-db_8c.html#a85906acba812801fd6ef8137920d3dcc">seaf_db_trans_check_for_existence</a> (trans,
                                                <span class="stringliteral">&quot;SELECT 1 FROM RepoOwner WHERE repo_id=?&quot;</span>,
                                                &amp;db_err, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);

    <span class="keywordflow">if</span> (!exists) {
        ret = <a class="code" href="seaf-db_8c.html#abfa65542f46d16df51de1e82fefcebb3">seaf_db_trans_query</a> (trans,
                                   <span class="stringliteral">&quot;INSERT INTO RepoOwner VALUES (?, ?)&quot;</span>,
                                   2, <span class="stringliteral">&quot;string&quot;</span>, repo_id,
                                   <span class="stringliteral">&quot;string&quot;</span>, <a class="code" href="repo_8c.html#a3b3e8fbdb003fab44ba2ed1d3f4d0cd3">seafile_trash_repo_get_owner_id</a>(repo));
        <span class="keywordflow">if</span> (ret &lt; 0) {
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;DB error: Insert Repo Owner.&quot;</span>);
            <a class="code" href="seaf-db_8c.html#a2786c0aa2d6f3629bc9ed8960e8de288">seaf_db_rollback</a> (trans);
            <a class="code" href="seaf-db_8c.html#af47f83c610aa48fca8f2f667fe2d096d">seaf_db_trans_close</a> (trans);
            <span class="keywordflow">goto</span> out;
        }
    }

    ret = <a class="code" href="seaf-db_8c.html#abfa65542f46d16df51de1e82fefcebb3">seaf_db_trans_query</a> (trans,
                               <span class="stringliteral">&quot;DELETE FROM RepoTrash WHERE repo_id = ?&quot;</span>,
                               1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
    <span class="keywordflow">if</span> (ret &lt; 0) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;DB error: delete from RepoTrash.&quot;</span>);
        <a class="code" href="seaf-db_8c.html#a2786c0aa2d6f3629bc9ed8960e8de288">seaf_db_rollback</a> (trans);
        <a class="code" href="seaf-db_8c.html#af47f83c610aa48fca8f2f667fe2d096d">seaf_db_trans_close</a> (trans);
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a8f67506e6cc01be4aa0a2a9fc5b08bd2">seaf_db_commit</a> (trans) &lt; 0) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;DB error: Failed to commit.&quot;</span>);
        <a class="code" href="seaf-db_8c.html#a2786c0aa2d6f3629bc9ed8960e8de288">seaf_db_rollback</a> (trans);
        ret = -1;
    }

    <a class="code" href="seaf-db_8c.html#af47f83c610aa48fca8f2f667fe2d096d">seaf_db_trans_close</a> (trans);

out:
    g_object_unref (repo);
    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="abf48f3efee4705f32fa8f3a95098921e"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_revert_dir" ref="abf48f3efee4705f32fa8f3a95098921e" args="(SeafRepoManager *mgr, const char *repo_id, const char *old_commit_id, const char *dir_path, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#abf48f3efee4705f32fa8f3a95098921e">seaf_repo_manager_revert_dir</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>old_commit_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dir_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="repo-op_8c_source.html#l03496">3496</a> of file <a class="el" href="repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL, *old_commit = NULL;
    <span class="keywordtype">char</span> *parent_dir = NULL, *dirname = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *old_dent = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL, *root_id = NULL;
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    gboolean parent_dir_exist = FALSE;
    gboolean revert_to_root = FALSE;
    gboolean skipped = FALSE;
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    <span class="comment">/* If old_commit_id is head commit, do nothing. */</span>
    <span class="keywordflow">if</span> (strcmp(repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>, old_commit_id) == 0) {
        <a class="code" href="seafile_2lib_2include_8h.html#ae5a5c3cadbc1f6e2363d25fc0fb46084">g_debug</a> (<span class="stringliteral">&quot;[revert dir] commit is head, do nothing\n&quot;</span>);
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (!old_commit) {
        <a class="code" href="repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(old_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, old_commit_id);
        <span class="keywordflow">if</span> (strcmp(old_commit-&gt;repo_id, repo_id) != 0) {
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a53023377dfe455de5672c199e9f2e831">SEAF_ERR_BAD_COMMIT</a>,
                         <span class="stringliteral">&quot;bad commit id&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    <span class="keywordflow">if</span> (!canon_path) {
        canon_path = get_canonical_path (dir_path);

        parent_dir  = g_path_get_dirname(canon_path);
        dirname = g_path_get_basename(canon_path);

        old_dent = get_dirent_by_path (repo, old_commit-&gt;root_id,
                                       parent_dir, dirname, error);
        <span class="keywordflow">if</span> (*error) {
            seaf_warning (<span class="stringliteral">&quot;[revert dir] error: %s\n&quot;</span>, (*error)-&gt;message);
            g_clear_error (error);
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;internal error&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    parent_dir_exist = detect_path_exist (repo,
                                          head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                          parent_dir, error);
    <span class="keywordflow">if</span> (*error) {
        seaf_warning (<span class="stringliteral">&quot;[revert dir] error: %s\n&quot;</span>, (*error)-&gt;message);
        g_clear_error (error);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;internal error&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }
    
    <span class="keywordflow">if</span> (!parent_dir_exist) {
        <span class="comment">/* When parent dir does not exist, revert this file to root dir. */</span>
        revert_to_root = TRUE;
        root_id = revert_dir (repo,
                              head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                              <span class="stringliteral">&quot;/&quot;</span>,
                              old_dent,
                              &amp;skipped, error);
    } <span class="keywordflow">else</span> {
        revert_to_root = FALSE;
        root_id = revert_dir (repo,
                              head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                              parent_dir,
                              old_dent,
                              &amp;skipped, error);
    }

    <span class="keywordflow">if</span> (*error) {
        seaf_warning (<span class="stringliteral">&quot;[revert dir] error: %s\n&quot;</span>, (*error)-&gt;message);
        g_clear_error (error);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;internal error&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (skipped) {
        <span class="keywordflow">goto</span> out;
    }
    
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[revert dir] Failed to revert dir.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to revert dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
    snprintf(buf, <a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Recovered deleted directory \&quot;%s\&quot;&quot;</span>, dirname);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (head_commit);
    <span class="keywordflow">if</span> (old_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (old_commit);

    g_free (root_id);
    g_free (parent_dir);
    g_free (dirname);

    g_free (canon_path);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (old_dent);

<span class="preprocessor">#define REVERT_TO_ROOT              0x1</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (ret == 0) {
        <span class="keywordflow">if</span> (revert_to_root)
            ret |= <a class="code" href="repo-op_8c.html#a65c9627aee501057c2e4968adbd34c71">REVERT_TO_ROOT</a>;
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a246dc6695f1ee0c1806de54109848096"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_revert_file" ref="a246dc6695f1ee0c1806de54109848096" args="(SeafRepoManager *mgr, const char *repo_id, const char *commit_id, const char *path, const char *user, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a352b05f8d991d13b5d5e1f0ee1b7616c">seaf_repo_manager_revert_file</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>commit_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="repo-op_8c_source.html#l03281">3281</a> of file <a class="el" href="repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL, *old_commit = NULL;
    <span class="keywordtype">char</span> *parent_dir = NULL, *filename = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *old_dent = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL, *root_id = NULL;
    <span class="keywordtype">char</span> buf[<a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
    <span class="keywordtype">char</span> time_str[512];
    gboolean parent_dir_exist = FALSE;
    gboolean revert_to_root = FALSE;
    gboolean skipped = FALSE;
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <a class="code" href="repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);

    <span class="comment">/* If old_commit_id is head commit, do nothing. */</span>
    <span class="keywordflow">if</span> (strcmp(repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>, old_commit_id) == 0) {
        <a class="code" href="seafile_2lib_2include_8h.html#ae5a5c3cadbc1f6e2363d25fc0fb46084">g_debug</a> (<span class="stringliteral">&quot;[revert file] commit is head, do nothing\n&quot;</span>);
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (!old_commit) {
        <a class="code" href="repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(old_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, old_commit_id);
        <span class="keywordflow">if</span> (strcmp(old_commit-&gt;repo_id, repo_id) != 0) {
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a53023377dfe455de5672c199e9f2e831">SEAF_ERR_BAD_COMMIT</a>,
                         <span class="stringliteral">&quot;bad commit id&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    <span class="keywordflow">if</span> (!canon_path) {
        canon_path = get_canonical_path (file_path);
        <span class="keywordflow">if</span> (canon_path[strlen(canon_path) -1 ] == <span class="charliteral">&#39;/&#39;</span>) {
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a53023377dfe455de5672c199e9f2e831">SEAF_ERR_BAD_COMMIT</a>,
                         <span class="stringliteral">&quot;bad target file path&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }

        parent_dir  = g_path_get_dirname(canon_path);
        filename = g_path_get_basename(canon_path);

        old_dent = get_dirent_by_path (repo, old_commit-&gt;root_id,
                                       parent_dir, filename, error);
        <span class="keywordflow">if</span> (*error) {
            seaf_warning (<span class="stringliteral">&quot;[revert file] error: %s\n&quot;</span>, (*error)-&gt;message);
            g_clear_error (error);
            g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                         <span class="stringliteral">&quot;internal error&quot;</span>);
            ret = -1;
            <span class="keywordflow">goto</span> out;
        }
    }

    parent_dir_exist = detect_path_exist (repo,
                                          head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                          parent_dir, error);
    <span class="keywordflow">if</span> (*error) {
        seaf_warning (<span class="stringliteral">&quot;[revert file] error: %s\n&quot;</span>, (*error)-&gt;message);
        g_clear_error (error);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;internal error&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }
    
    <span class="keywordflow">if</span> (!parent_dir_exist) {
        <span class="comment">/* When parent dir does not exist, revert this file to root dir. */</span>
        revert_to_root = TRUE;
        root_id = revert_file_to_root (repo,
                                       head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                       old_dent,
                                       &amp;skipped, error);
    } <span class="keywordflow">else</span> {
        revert_to_root = FALSE;
        root_id = revert_file_to_parent_dir (repo,
                                             head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, parent_dir,
                                             old_dent,
                                             &amp;skipped, error);
    }

    <span class="keywordflow">if</span> (*error) {
        seaf_warning (<span class="stringliteral">&quot;[revert file] error: %s\n&quot;</span>, (*error)-&gt;message);
        g_clear_error (error);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;internal error&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="keywordflow">if</span> (skipped) {
        <span class="keywordflow">goto</span> out;
    }
    
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[revert file] Failed to revert file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to revert file&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <span class="comment">/* Commit. */</span>
<span class="preprocessor">#ifndef WIN32</span>
<span class="preprocessor"></span>    strftime (time_str, <span class="keyword">sizeof</span>(time_str), <span class="stringliteral">&quot;%F %T&quot;</span>,
              localtime((time_t *)(&amp;old_commit-&gt;ctime)));
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>    strftime (time_str, <span class="keyword">sizeof</span>(time_str), <span class="stringliteral">&quot;%Y-%m-%d %H:%M:%S&quot;</span>,
              localtime((time_t *)(&amp;old_commit-&gt;ctime)));
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    snprintf(buf, <a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;Reverted file \&quot;%s\&quot; to status at %s&quot;</span>, filename, time_str);
    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, buf, NULL, error) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <span class="keywordflow">if</span> (head_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (head_commit);
    <span class="keywordflow">if</span> (old_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (old_commit);

    g_free (root_id);
    g_free (parent_dir);
    g_free (filename);

    g_free (canon_path);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (old_dent);

<span class="preprocessor">#define REVERT_TO_ROOT              0x1</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (ret == 0) {
        <span class="keywordflow">if</span> (revert_to_root)
            ret |= <a class="code" href="repo-op_8c.html#a65c9627aee501057c2e4968adbd34c71">REVERT_TO_ROOT</a>;
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a75071fddf41a1371d4f89be8d2b59b88"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_revert_on_server" ref="a75071fddf41a1371d4f89be8d2b59b88" args="(SeafRepoManager *mgr, const char *repo_id, const char *commit_id, const char *user_name, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a75071fddf41a1371d4f89be8d2b59b88">seaf_repo_manager_revert_on_server</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>commit_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="repo-op_8c_source.html#l04486">4486</a> of file <a class="el" href="repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit = NULL, *new_commit = NULL;
    <span class="keywordtype">char</span> desc[512];
    <span class="keywordtype">int</span> ret = 0;

retry:
    repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (!repo) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;No such repo&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    commit = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
                                             repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, 
                                             commit_id);
    <span class="keywordflow">if</span> (!commit) {
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Commit doesn&#39;t exist&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

<span class="preprocessor">#ifndef WIN32</span>
<span class="preprocessor"></span>    strftime (desc, <span class="keyword">sizeof</span>(desc), <span class="stringliteral">&quot;Reverted repo to status at %F %T.&quot;</span>, 
              localtime((time_t *)(&amp;commit-&gt;<a class="code" href="struct__SeafCommit.html#ae3f1657ab475921889a1e9c74b94e7a2">ctime</a>)));
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>    strftime (desc, <span class="keyword">sizeof</span>(desc), <span class="stringliteral">&quot;Reverted repo to status at %Y-%m-%d %H:%M:%S.&quot;</span>,
              localtime((time_t *)(&amp;commit-&gt;<a class="code" href="struct__SeafCommit.html#ae3f1657ab475921889a1e9c74b94e7a2">ctime</a>)));
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    new_commit = <a class="code" href="commit-mgr_8c.html#afe68dfa15b1bbd8557b044b1b1b58dc2">seaf_commit_new</a> (NULL, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>,
                                  user_name, <a class="code" href="seafile_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>,
                                  desc, 0);

    new_commit-&gt;parent_id = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
    <a class="code" href="daemon_2repo-mgr_8c.html#a39a9a41ffdfc324f3c935251d9e14d51">seaf_repo_to_commit</a> (repo, new_commit);

    <span class="keywordflow">if</span> (<a class="code" href="commit-mgr_8c.html#a7c138604e615440b65741b77e71248c6">seaf_commit_manager_add_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>, new_commit) &lt; 0) {
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    <a class="code" href="branch-mgr_8c.html#a7a776ebd084d2335050c68d9a2e10c18">seaf_branch_set_commit</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>, new_commit-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
    <span class="keywordflow">if</span> (seaf_branch_manager_test_and_update_branch (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>,
                                                    repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>,
                                                    new_commit-&gt;parent_id) &lt; 0)
    {
        seaf_warning (<span class="stringliteral">&quot;[revert] Concurrent branch update, retry.\n&quot;</span>);
        <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (new_commit);
        repo = NULL;
        commit = new_commit = NULL;
        <span class="keywordflow">goto</span> retry;
    }

    <a class="code" href="server_2repo-mgr_8h.html#a30755ff2c01595d4927715310beaee04">seaf_repo_manager_merge_virtual_repo</a> (mgr, repo_id, NULL);

out:
    <span class="keywordflow">if</span> (new_commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (new_commit);
    <span class="keywordflow">if</span> (commit)
        <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
    <span class="keywordflow">if</span> (repo)
        <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);

    <span class="keywordflow">if</span> (ret == 0) {
        update_repo_size (repo_id);
    }

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aaabba29e879e5e4e53ff753e86b5427b"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_set_access_property" ref="aaabba29e879e5e4e53ff753e86b5427b" args="(SeafRepoManager *mgr, const char *repo_id, const char *ap)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#aaabba29e879e5e4e53ff753e86b5427b">seaf_repo_manager_set_access_property</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>ap</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02154">2154</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> rc;

    <span class="keywordflow">if</span> (<a class="code" href="server_2repo-mgr_8c.html#a3f3921eba68da813d0d1a583c8923396">seaf_repo_manager_query_access_property</a> (mgr, repo_id) == NULL) {
        rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                      <span class="stringliteral">&quot;INSERT INTO WebAP VALUES (?, ?)&quot;</span>,
                                      2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;string&quot;</span>, ap);
    } <span class="keywordflow">else</span> {
        rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                      <span class="stringliteral">&quot;UPDATE WebAP SET access_property=? &quot;</span>
                                      <span class="stringliteral">&quot;WHERE repo_id=?&quot;</span>,
                                      2, <span class="stringliteral">&quot;string&quot;</span>, ap, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
    }

    <span class="keywordflow">if</span> (rc &lt; 0) {
        seaf_warning (<span class="stringliteral">&quot;DB error when set access property for repo %s, %s.\n&quot;</span>, repo_id, ap);
        <span class="keywordflow">return</span> -1;
    }
    
    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a6c5f4f43e7e198238b3b24dff3e9c389"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_set_group_repo_perm" ref="a6c5f4f43e7e198238b3b24dff3e9c389" args="(SeafRepoManager *mgr, const char *repo_id, int group_id, const char *permission, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a6c5f4f43e7e198238b3b24dff3e9c389">seaf_repo_manager_set_group_repo_perm</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>group_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>permission</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02304">2304</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                    <span class="stringliteral">&quot;UPDATE RepoGroup SET permission=? WHERE &quot;</span>
                                    <span class="stringliteral">&quot;repo_id=? AND group_id=?&quot;</span>,
                                    3, <span class="stringliteral">&quot;string&quot;</span>, permission, <span class="stringliteral">&quot;string&quot;</span>, repo_id,
                                    <span class="stringliteral">&quot;int&quot;</span>, group_id);
}
</pre></div>
</div>
</div>
<a class="anchor" id="ab4740f8bce8f9f3571adf0adfb63590b"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_set_inner_pub_repo" ref="ab4740f8bce8f9f3571adf0adfb63590b" args="(SeafRepoManager *mgr, const char *repo_id, const char *permission)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#ab4740f8bce8f9f3571adf0adfb63590b">seaf_repo_manager_set_inner_pub_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>permission</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02468">2468</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;
    <span class="keywordtype">char</span> sql[256];

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae183a9c45ec082962bdd361491b0a8cb">seaf_db_type</a>(db) == <a class="code" href="seaf-db_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da62ce2e8a052406ede3fcf39ec407ccf8">SEAF_DB_TYPE_PGSQL</a>) {
        gboolean err;
        snprintf(sql, <span class="keyword">sizeof</span>(sql),
                 <span class="stringliteral">&quot;SELECT repo_id FROM InnerPubRepo WHERE repo_id=&#39;%s&#39;&quot;</span>,
                 repo_id);
        <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a6410cd243563343861ba3c6c16fc06a7">seaf_db_check_for_existence</a>(db, sql, &amp;err))
            snprintf(sql, <span class="keyword">sizeof</span>(sql),
                     <span class="stringliteral">&quot;UPDATE InnerPubRepo SET permission=&#39;%s&#39; &quot;</span>
                     <span class="stringliteral">&quot;WHERE repo_id=&#39;%s&#39;&quot;</span>, permission, repo_id);
        <span class="keywordflow">else</span>
            snprintf(sql, <span class="keyword">sizeof</span>(sql),
                     <span class="stringliteral">&quot;INSERT INTO InnerPubRepo VALUES &quot;</span>
                     <span class="stringliteral">&quot;(&#39;%s&#39;, &#39;%s&#39;)&quot;</span>, repo_id, permission);
        <span class="keywordflow">if</span> (err)
            <span class="keywordflow">return</span> -1;
        <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql);
    } <span class="keywordflow">else</span> {
        <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db,
                                        <span class="stringliteral">&quot;REPLACE INTO InnerPubRepo VALUES (?, ?)&quot;</span>,
                                        2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;string&quot;</span>, permission);
    }

    <span class="keywordflow">return</span> -1;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ac78c13c68a1a9d1d025e45f4e51193ac"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_set_repo_history_limit" ref="ac78c13c68a1a9d1d025e45f4e51193ac" args="(SeafRepoManager *mgr, const char *repo_id, int days)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#ac78c13c68a1a9d1d025e45f4e51193ac">seaf_repo_manager_set_repo_history_limit</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>days</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2gc_2repo-mgr_8c_source.html#l00419">419</a> of file <a class="el" href="server_2gc_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="structSeafVirtRepo.html">SeafVirtRepo</a> *vinfo;
    <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;
    <span class="keywordtype">char</span> sql[256];

    vinfo = <a class="code" href="server_2gc_2repo-mgr_8c.html#a316db228b35dde3dc88ae9dab9ec9c22">seaf_repo_manager_get_virtual_repo_info</a> (mgr, repo_id);
    <span class="keywordflow">if</span> (vinfo) {
        <a class="code" href="server_2gc_2repo-mgr_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a">seaf_virtual_repo_info_free</a> (vinfo);
        <span class="keywordflow">return</span> 0;
    }

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae183a9c45ec082962bdd361491b0a8cb">seaf_db_type</a>(db) == <a class="code" href="seaf-db_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da62ce2e8a052406ede3fcf39ec407ccf8">SEAF_DB_TYPE_PGSQL</a>) {
        gboolean err;
        snprintf(sql, <span class="keyword">sizeof</span>(sql),
                 <span class="stringliteral">&quot;SELECT repo_id FROM RepoHistoryLimit &quot;</span>
                 <span class="stringliteral">&quot;WHERE repo_id=&#39;%s&#39;&quot;</span>, repo_id);
        <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a6410cd243563343861ba3c6c16fc06a7">seaf_db_check_for_existence</a>(db, sql, &amp;err))
            snprintf(sql, <span class="keyword">sizeof</span>(sql),
                     <span class="stringliteral">&quot;UPDATE RepoHistoryLimit SET days=%d&quot;</span>
                     <span class="stringliteral">&quot;WHERE repo_id=&#39;%s&#39;&quot;</span>, days, repo_id);
        <span class="keywordflow">else</span>
            snprintf(sql, <span class="keyword">sizeof</span>(sql),
                     <span class="stringliteral">&quot;INSERT INTO RepoHistoryLimit VALUES &quot;</span>
                     <span class="stringliteral">&quot;(&#39;%s&#39;, %d)&quot;</span>, repo_id, days);
        <span class="keywordflow">if</span> (err)
            <span class="keywordflow">return</span> -1;
        <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a>(db, sql);
    } <span class="keywordflow">else</span> {
        snprintf (sql, <span class="keyword">sizeof</span>(sql),
                  <span class="stringliteral">&quot;REPLACE INTO RepoHistoryLimit VALUES (&#39;%s&#39;, %d)&quot;</span>,
                  repo_id, days);
        <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
            <span class="keywordflow">return</span> -1;
    }

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a5f096821f41a339e41e9341fc0c4010d"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_set_repo_owner" ref="a5f096821f41a339e41e9341fc0c4010d" args="(SeafRepoManager *mgr, const char *repo_id, const char *email)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a5f096821f41a339e41e9341fc0c4010d">seaf_repo_manager_set_repo_owner</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>email</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l01677">1677</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;
    <span class="keywordtype">char</span> sql[256];

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae183a9c45ec082962bdd361491b0a8cb">seaf_db_type</a>(db) == <a class="code" href="seaf-db_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da62ce2e8a052406ede3fcf39ec407ccf8">SEAF_DB_TYPE_PGSQL</a>) {
        gboolean err;
        snprintf(sql, <span class="keyword">sizeof</span>(sql),
                 <span class="stringliteral">&quot;SELECT repo_id FROM RepoOwner WHERE repo_id=&#39;%s&#39;&quot;</span>, repo_id);
        <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a6410cd243563343861ba3c6c16fc06a7">seaf_db_check_for_existence</a>(db, sql, &amp;err))
            snprintf(sql, <span class="keyword">sizeof</span>(sql),
                     <span class="stringliteral">&quot;UPDATE RepoOwner SET owner_id=&#39;%s&#39; WHERE &quot;</span>
                     <span class="stringliteral">&quot;repo_id=&#39;%s&#39;&quot;</span>, email, repo_id);
        <span class="keywordflow">else</span>
            snprintf(sql, <span class="keyword">sizeof</span>(sql),
                     <span class="stringliteral">&quot;INSERT INTO RepoOwner VALUES (&#39;%s&#39;, &#39;%s&#39;)&quot;</span>,
                     repo_id, email);
        <span class="keywordflow">if</span> (err)
            <span class="keywordflow">return</span> -1;
        <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
            <span class="keywordflow">return</span> -1;
    } <span class="keywordflow">else</span> {
        <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db, <span class="stringliteral">&quot;REPLACE INTO RepoOwner VALUES (?, ?)&quot;</span>,
                                     2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;string&quot;</span>, email) &lt; 0)
            <span class="keywordflow">return</span> -1;
    }

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aeeda6cf1cb41515388afd8a10c6297e1"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_set_repo_valid_since" ref="aeeda6cf1cb41515388afd8a10c6297e1" args="(SeafRepoManager *mgr, const char *repo_id, gint64 timestamp)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#aeeda6cf1cb41515388afd8a10c6297e1">seaf_repo_manager_set_repo_valid_since</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gint64&#160;</td>
          <td class="paramname"><em>timestamp</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2gc_2repo-mgr_8c_source.html#l00508">508</a> of file <a class="el" href="server_2gc_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;
    <span class="keywordtype">char</span> sql[256];

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae183a9c45ec082962bdd361491b0a8cb">seaf_db_type</a>(db) == <a class="code" href="seaf-db_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da62ce2e8a052406ede3fcf39ec407ccf8">SEAF_DB_TYPE_PGSQL</a>) {
        gboolean err;
        snprintf(sql, <span class="keyword">sizeof</span>(sql),
                 <span class="stringliteral">&quot;SELECT repo_id FROM RepoValidSince WHERE &quot;</span>
                 <span class="stringliteral">&quot;repo_id=&#39;%s&#39;&quot;</span>, repo_id);
        <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a6410cd243563343861ba3c6c16fc06a7">seaf_db_check_for_existence</a>(db, sql, &amp;err))
            snprintf(sql, <span class="keyword">sizeof</span>(sql),
                     <span class="stringliteral">&quot;UPDATE RepoValidSince SET timestamp=%&quot;</span>G_GINT64_FORMAT
                     <span class="stringliteral">&quot; WHERE repo_id=&#39;%s&#39;&quot;</span>, timestamp, repo_id);
        <span class="keywordflow">else</span>
            snprintf(sql, <span class="keyword">sizeof</span>(sql),
                     <span class="stringliteral">&quot;INSERT INTO RepoValidSince VALUES &quot;</span>
                     <span class="stringliteral">&quot;(&#39;%s&#39;, %&quot;</span>G_GINT64_FORMAT<span class="stringliteral">&quot;)&quot;</span>, repo_id, timestamp);
        <span class="keywordflow">if</span> (err)
            <span class="keywordflow">return</span> -1;
        <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
            <span class="keywordflow">return</span> -1;
    } <span class="keywordflow">else</span> {
        snprintf (sql, <span class="keyword">sizeof</span>(sql),
                  <span class="stringliteral">&quot;REPLACE INTO RepoValidSince VALUES (&#39;%s&#39;, %&quot;</span>G_GINT64_FORMAT<span class="stringliteral">&quot;)&quot;</span>,
                  repo_id, timestamp);
        <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
            <span class="keywordflow">return</span> -1;
    }

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a2e049cfa3d0546aaf51e7f6792e1467d"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_start" ref="a2e049cfa3d0546aaf51e7f6792e1467d" args="(SeafRepoManager *mgr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a2e049cfa3d0546aaf51e7f6792e1467d">seaf_repo_manager_start</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2repo-mgr_8c_source.html#l03968">3968</a> of file <a class="el" href="daemon_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    watch_repos (mgr);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa40635ee3473d593c5edc1a9e9976cd7"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_token_peer_info_exists" ref="aa40635ee3473d593c5edc1a9e9976cd7" args="(SeafRepoManager *mgr, const char *token)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">gboolean <a class="el" href="server_2repo-mgr_8h.html#aa40635ee3473d593c5edc1a9e9976cd7">seaf_repo_manager_token_peer_info_exists</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>token</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l01141">1141</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    gboolean db_error = FALSE;

    <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#af77a76302b3316a4d71e418de27843c4">seaf_db_statement_exists</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                     <span class="stringliteral">&quot;SELECT token FROM RepoTokenPeerInfo WHERE token=?&quot;</span>,
                                     &amp;db_error, 1, <span class="stringliteral">&quot;string&quot;</span>, token);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a4a3708ac06f2c015cc665f5ba61ee36a"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_unset_inner_pub_repo" ref="a4a3708ac06f2c015cc665f5ba61ee36a" args="(SeafRepoManager *mgr, const char *repo_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a4a3708ac06f2c015cc665f5ba61ee36a">seaf_repo_manager_unset_inner_pub_repo</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l02501">2501</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                    <span class="stringliteral">&quot;DELETE FROM InnerPubRepo WHERE repo_id = ?&quot;</span>,
                                    1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a3702d0c75995d0221e33b9ba673b99fd"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_update_dir" ref="a3702d0c75995d0221e33b9ba673b99fd" args="(SeafRepoManager *mgr, const char *repo_id, const char *dir_path, const char *new_dir_id, const char *user, const char *head_id, char *new_commit_id, GError **error)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="repo-op_8c.html#a3702d0c75995d0221e33b9ba673b99fd">seaf_repo_manager_update_dir</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>repo_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dir_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>new_dir_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>user</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>head_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>new_commit_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">GError **&#160;</td>
          <td class="paramname"><em>error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="repo-op_8c_source.html#l02854">2854</a> of file <a class="el" href="repo-op_8c_source.html">repo-op.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
    <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head_commit = NULL;
    <span class="keywordtype">char</span> *canon_path = NULL;
    <span class="keywordtype">char</span> *parent = NULL, *dirname = NULL;
    <a class="code" href="struct__SeafDirent.html">SeafDirent</a> *new_dent = NULL;
    <span class="keywordtype">char</span> *root_id = NULL;
    <span class="keywordtype">char</span> *commit_desc = NULL;
    <span class="keywordtype">int</span> ret = 0;

    <a class="code" href="repo-op_8c.html#ad4fe8ea6d1a020206fd349111f94f2c7">GET_REPO_OR_FAIL</a>(repo, repo_id);
    <span class="keyword">const</span> <span class="keywordtype">char</span> *base = head_id ? head_id : repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>;
    <a class="code" href="repo-op_8c.html#a8e5a75fd7079c7668a1e39b9b57bafed">GET_COMMIT_OR_FAIL</a>(head_commit, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, base);

    <span class="comment">/* Are we updating the root? */</span>
    <span class="keywordflow">if</span> (strcmp (dir_path, <span class="stringliteral">&quot;/&quot;</span>) == 0) {
        commit_desc = gen_commit_description (repo, new_dir_id, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>);
        <span class="keywordflow">if</span> (!commit_desc)
            commit_desc = g_strdup(<span class="stringliteral">&quot;Auto merge by system&quot;</span>);

        <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, new_dir_id,
                            user, commit_desc, new_commit_id, error) &lt; 0)
            ret = -1;
        g_free (commit_desc);
        <span class="keywordflow">goto</span> out;
    }

    parent = g_path_get_dirname (dir_path);
    canon_path = get_canonical_path (parent);
    g_free (parent);

    dirname = g_path_get_basename (dir_path);

    <a class="code" href="repo-op_8c.html#a5b81d4727cc3ed61fabaf57e9ec58fbc">FAIL_IF_FILE_NOT_EXISTS</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
                            head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, dirname, NULL);

    new_dent = <a class="code" href="fs-mgr_8c.html#a07b91f8db9de0262970252a95f5e9f2f">seaf_dirent_new</a> (<a class="code" href="fs-mgr_8c.html#aed9f5302d562729d419a4ef8f60ffbd1">dir_version_from_repo_version</a>(repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>),
                                new_dir_id, S_IFDIR, dirname,
                                (gint64)time(NULL), NULL, -1);

    root_id = do_put_file (repo, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>, canon_path, new_dent);
    <span class="keywordflow">if</span> (!root_id) {
        seaf_warning (<span class="stringliteral">&quot;[update dir] Failed to put file.\n&quot;</span>);
        g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
                     <span class="stringliteral">&quot;Failed to update dir&quot;</span>);
        ret = -1;
        <span class="keywordflow">goto</span> out;
    }

    commit_desc = gen_commit_description (repo, root_id, head_commit-&gt;<a class="code" href="struct__SeafCommit.html#a2268a50b170dc23bfa0f5108a2b764e5">root_id</a>);
    <span class="keywordflow">if</span> (!commit_desc)
        commit_desc = g_strdup(<span class="stringliteral">&quot;Auto merge by system&quot;</span>);

    <span class="keywordflow">if</span> (gen_new_commit (repo_id, head_commit, root_id,
                        user, commit_desc, new_commit_id, error) &lt; 0) {
        ret = -1;
        g_free (commit_desc);
        <span class="keywordflow">goto</span> out;
    }
    g_free (commit_desc);

out:
    <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
    <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (head_commit);
    <a class="code" href="fs-mgr_8c.html#aef77f199fa9eccfe322f1ff978a9055a">seaf_dirent_free</a> (new_dent);
    g_free (canon_path);
    g_free (dirname);
    g_free (root_id);

    <span class="keywordflow">if</span> (ret == 0)
        update_repo_size (repo_id);

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a33b75eede501da0a4c6100b30b9facf0"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_manager_update_token_peer_info" ref="a33b75eede501da0a4c6100b30b9facf0" args="(SeafRepoManager *mgr, const char *token, const char *peer_ip, gint64 sync_time)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a33b75eede501da0a4c6100b30b9facf0">seaf_repo_manager_update_token_peer_info</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#af5833aac28a20ee1e1217fc33b9c3a54">SeafRepoManager</a> *&#160;</td>
          <td class="paramname"><em>mgr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>token</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>peer_ip</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">gint64&#160;</td>
          <td class="paramname"><em>sync_time</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2repo-mgr_8c_source.html#l01122">1122</a> of file <a class="el" href="server_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> ret = 0;

    <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
                                 <span class="stringliteral">&quot;UPDATE RepoTokenPeerInfo SET &quot;</span>
                                 <span class="stringliteral">&quot;peer_ip=?, sync_time=? WHERE token=?&quot;</span>,
                                 3, <span class="stringliteral">&quot;string&quot;</span>, peer_ip,
                                 <span class="stringliteral">&quot;int64&quot;</span>, sync_time,
                                 <span class="stringliteral">&quot;string&quot;</span>, token) &lt; 0)
        ret = -1;

    <span class="keywordflow">return</span> ret;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a63ab9fe4694e3d967376c911cbe2c655"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_new" ref="a63ab9fe4694e3d967376c911cbe2c655" args="(const char *id, const char *name, const char *desc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a>* <a class="el" href="server_2repo-mgr_8h.html#a63ab9fe4694e3d967376c911cbe2c655">seaf_repo_new</a> </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>desc</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2repo-mgr_8c_source.html#l00536">536</a> of file <a class="el" href="daemon_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="struct__SeafRepo.html">SeafRepo</a>* repo;

    <span class="comment">/* valid check */</span>
  
    
    repo = g_new0 (<a class="code" href="struct__SeafRepo.html">SeafRepo</a>, 1);
    memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="keywordtype">id</span>, 36);
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>[36] = <span class="charliteral">&#39;\0&#39;</span>;

    repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a> = g_strdup(<a class="code" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>);
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a> = g_strdup(desc);

    repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a> = TRUE;
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a> = 1;
    repo-&gt;<a class="code" href="struct__SeafRepo.html#a575e562d38b7fc0adc79a6b24ea00ac1">net_browsable</a> = 0;
    pthread_mutex_init (&amp;repo-&gt;<a class="code" href="struct__SeafRepo.html#aaa93119bb8b7b6038e9feb3c3a78b0ab">lock</a>, NULL);

    <span class="keywordflow">return</span> repo;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ab8f60cbbd6c35ee55ea72acbbd3a1608"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_ref" ref="ab8f60cbbd6c35ee55ea72acbbd3a1608" args="(SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="server_2repo-mgr_8h.html#ab8f60cbbd6c35ee55ea72acbbd3a1608">seaf_repo_ref</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="fuse_2repo-mgr_8c_source.html#l00068">68</a> of file <a class="el" href="fuse_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    g_atomic_int_inc (&amp;repo-&gt;<a class="code" href="struct__SeafRepo.html#a73ff67300bff9e51d98f02e0729e569d">ref_cnt</a>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a6c47d6277897f6afbe866f2755f9762d"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_set_head" ref="a6c47d6277897f6afbe866f2755f9762d" args="(SeafRepo *repo, SeafBranch *branch)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="server_2repo-mgr_8h.html#a6c47d6277897f6afbe866f2755f9762d">seaf_repo_set_head</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="branch-mgr_8h.html#a43063fab0cfaf940abc07b1cd941fb85">SeafBranch</a> *&#160;</td>
          <td class="paramname"><em>branch</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2repo-mgr_8c_source.html#l00631">631</a> of file <a class="el" href="daemon_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (save_branch_repo_map (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>, branch) &lt; 0)
        <span class="keywordflow">return</span> -1;
    set_head_common (repo, branch);
    <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a39a9a41ffdfc324f3c935251d9e14d51"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_to_commit" ref="a39a9a41ffdfc324f3c935251d9e14d51" args="(SeafRepo *repo, SeafCommit *commit)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="server_2repo-mgr_8h.html#a39a9a41ffdfc324f3c935251d9e14d51">seaf_repo_to_commit</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="commit-mgr_8h.html#ab20cfcee12e164d94824e8be23c2c8ea">SeafCommit</a> *&#160;</td>
          <td class="paramname"><em>commit</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="daemon_2repo-mgr_8c_source.html#l00682">682</a> of file <a class="el" href="daemon_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    commit-&gt;<a class="code" href="struct__SeafCommit.html#aacd7b88f8a3e72446cd7352396eaa09e">repo_name</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>);
    commit-&gt;<a class="code" href="struct__SeafCommit.html#aa3d8e868c630cfbecbcb9158c4bbe2e4">repo_desc</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a>);
    commit-&gt;<a class="code" href="struct__SeafCommit.html#a906e77d2a658f4337437ff8694a4bfc0">encrypted</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>;
    <span class="keywordflow">if</span> (commit-&gt;<a class="code" href="struct__SeafCommit.html#a906e77d2a658f4337437ff8694a4bfc0">encrypted</a>) {
        commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>;
        <span class="keywordflow">if</span> (commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a> == 1)
            commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>);
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a> == 2) {
            commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>);
            commit-&gt;<a class="code" href="struct__SeafCommit.html#ab1d44814bc44472105aef8761656e3d7">random_key</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a83e0a2366ba320396f2deb6faa167b84">random_key</a>);
        }
    }
    commit-&gt;<a class="code" href="struct__SeafCommit.html#a383ea4a4b94417c7d9e9827d60420d64">no_local_history</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#a4710aaee11c7887df402fffa7ca6c54f">no_local_history</a>;
    commit-&gt;<a class="code" href="struct__SeafCommit.html#abc83f168ce2b43fa864522bf0ea26d6d">version</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="af6bedb063685823d91f2a335c6882e07"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_repo_unref" ref="af6bedb063685823d91f2a335c6882e07" args="(SeafRepo *repo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="server_2repo-mgr_8h.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="daemon_2repo-mgr_8h.html#a3e8b6c8c2a077518a17c75c6ace3ae1c">SeafRepo</a> *&#160;</td>
          <td class="paramname"><em>repo</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="fuse_2repo-mgr_8c_source.html#l00074">74</a> of file <a class="el" href="fuse_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (!repo)
        <span class="keywordflow">return</span>;

    <span class="keywordflow">if</span> (g_atomic_int_dec_and_test (&amp;repo-&gt;<a class="code" href="struct__SeafRepo.html#a73ff67300bff9e51d98f02e0729e569d">ref_cnt</a>))
        <a class="code" href="daemon_2repo-mgr_8c.html#ad0a65514ad80789ff244b20c66460b96">seaf_repo_free</a> (repo);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a66a6ccfc59462f4c59fd322c693c3d5a"></a><!-- doxytag: member="repo&#45;mgr.h::seaf_virtual_repo_info_free" ref="a66a6ccfc59462f4c59fd322c693c3d5a" args="(SeafVirtRepo *vinfo)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="virtual-repo_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a">seaf_virtual_repo_info_free</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSeafVirtRepo.html">SeafVirtRepo</a> *&#160;</td>
          <td class="paramname"><em>vinfo</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="server_2gc_2repo-mgr_8c_source.html#l00611">611</a> of file <a class="el" href="server_2gc_2repo-mgr_8c_source.html">repo-mgr.c</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (!vinfo) <span class="keywordflow">return</span>;

    g_free (vinfo-&gt;<a class="code" href="structSeafVirtRepo.html#abd2d9ee29b9d78255cd52b8f7aa053ec">path</a>);
    g_free (vinfo);
}
</pre></div>
</div>
</div>
</div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Wed Aug 19 2015 03:19:06 for My Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
