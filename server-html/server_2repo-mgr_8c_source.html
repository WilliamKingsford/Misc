<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>My Project: seafile/server/repo-mgr.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">My Project
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">seafile/server/repo-mgr.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="server_2repo-mgr_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="preprocessor">#include &quot;common.h&quot;</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;glib/gstdio.h&gt;</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;openssl/sha.h&gt;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;openssl/rand.h&gt;</span>
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;<a class="code" href="ccnet_8h.html">ccnet.h</a>&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;ccnet/ccnet-object.h&gt;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;utils.h&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;log.h&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="seafile_8h.html">seafile.h</a>&quot;</span>
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;<a class="code" href="server_2seafile-session_8h.html">seafile-session.h</a>&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="commit-mgr_8h.html">commit-mgr.h</a>&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="branch-mgr_8h.html">branch-mgr.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="server_2repo-mgr_8h.html">repo-mgr.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="fs-mgr_8h.html">fs-mgr.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="seafile-error_8h.html">seafile-error.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="seafile-crypt_8h.html">seafile-crypt.h</a>&quot;</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="monitor-rpc-wrappers_8h.html">monitor-rpc-wrappers.h</a>&quot;</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="seaf-db_8h.html">seaf-db.h</a>&quot;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a><a class="code" href="server_2repo-mgr_8c.html#a086f525a24dc070dfb2b44cfcdd432e0">00028</a> <span class="preprocessor">#define REAP_TOKEN_INTERVAL 300 </span><span class="comment">/* 5 mins */</span>
<a name="l00029"></a><a class="code" href="server_2repo-mgr_8c.html#a6e0d8a1f0eba39caca9c0b6745241644">00029</a> <span class="preprocessor">#define DECRYPTED_TOKEN_TTL 3600 </span><span class="comment">/* 1 hour */</span>
<a name="l00030"></a>00030 
<a name="l00031"></a><a class="code" href="structDecryptedToken.html">00031</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structDecryptedToken.html">DecryptedToken</a> {
<a name="l00032"></a><a class="code" href="structDecryptedToken.html#a616524db801f9ed7ee2b7b9095bf7cd1">00032</a>     <span class="keywordtype">char</span> *<a class="code" href="structDecryptedToken.html#a616524db801f9ed7ee2b7b9095bf7cd1">token</a>;
<a name="l00033"></a><a class="code" href="structDecryptedToken.html#ac28926407787ff9b8f9e85f677c02447">00033</a>     gint64 <a class="code" href="structDecryptedToken.html#ac28926407787ff9b8f9e85f677c02447">reap_time</a>;
<a name="l00034"></a>00034 } <a class="code" href="server_2repo-mgr_8c.html#a22b1dde2dcc65cf3b6ff8661ecf8033a">DecryptedToken</a>;
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="keyword">struct </span><a class="code" href="struct__SeafRepoManagerPriv.html">_SeafRepoManagerPriv</a> {
<a name="l00037"></a>00037     <span class="comment">/* (encrypted_token, session_key) -&gt; decrypted token */</span>
<a name="l00038"></a><a class="code" href="struct__SeafRepoManagerPriv.html#a000e23969980c4dcc63654c2fd0e37d0">00038</a>     GHashTable *<a class="code" href="struct__SeafRepoManagerPriv.html#a000e23969980c4dcc63654c2fd0e37d0">decrypted_tokens</a>;
<a name="l00039"></a>00039     pthread_rwlock_t <a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>;
<a name="l00040"></a><a class="code" href="struct__SeafRepoManagerPriv.html#ac7a22edf1508a618322e36564e876c28">00040</a>     <a class="code" href="structCcnetTimer.html">CcnetTimer</a> *<a class="code" href="struct__SeafRepoManagerPriv.html#ac7a22edf1508a618322e36564e876c28">reap_token_timer</a>;
<a name="l00041"></a>00041 };
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *ignore_table[] = {
<a name="l00044"></a>00044     <span class="comment">/* tmp files under Linux */</span>
<a name="l00045"></a>00045     <span class="stringliteral">&quot;*~&quot;</span>,
<a name="l00046"></a>00046     <span class="comment">/* Emacs tmp files */</span>
<a name="l00047"></a>00047     <span class="stringliteral">&quot;#*#&quot;</span>,
<a name="l00048"></a>00048     <span class="comment">/* ms office tmp files */</span>
<a name="l00049"></a>00049     <span class="stringliteral">&quot;~$*&quot;</span>,
<a name="l00050"></a>00050     <span class="stringliteral">&quot;~*.tmp&quot;</span>, <span class="comment">/* for files like ~WRL0001.tmp */</span>
<a name="l00051"></a>00051     <span class="comment">/* windows image cache */</span>
<a name="l00052"></a>00052     <span class="stringliteral">&quot;Thumbs.db&quot;</span>,
<a name="l00053"></a>00053     <span class="comment">/* For Mac */</span>
<a name="l00054"></a>00054     <span class="stringliteral">&quot;.DS_Store&quot;</span>,
<a name="l00055"></a>00055     NULL,
<a name="l00056"></a>00056 };
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="keyword">static</span> GPatternSpec** ignore_patterns;
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="keyword">static</span> <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *
<a name="l00061"></a>00061 load_repo (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id, gboolean ret_corrupt);
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 <span class="keyword">static</span> <span class="keywordtype">int</span> create_db_tables_if_not_exist (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr);
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="keyword">static</span> <span class="keywordtype">int</span> save_branch_repo_map (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch);
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="keyword">static</span> <span class="keywordtype">int</span> reap_token (<span class="keywordtype">void</span> *data);
<a name="l00068"></a>00068 <span class="keyword">static</span> <span class="keywordtype">void</span> decrypted_token_free (<a class="code" href="structDecryptedToken.html">DecryptedToken</a> *token);
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 gboolean
<a name="l00071"></a><a class="code" href="server_2repo-mgr_8c.html#a35ce9f51287bbd5f961c261516c1c5f0">00071</a> <a class="code" href="daemon_2repo-mgr_8c.html#a35ce9f51287bbd5f961c261516c1c5f0">is_repo_id_valid</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>)
<a name="l00072"></a>00072 {
<a name="l00073"></a>00073     <span class="keywordflow">if</span> (!<span class="keywordtype">id</span>)
<a name="l00074"></a>00074         <span class="keywordflow">return</span> FALSE;
<a name="l00075"></a>00075 
<a name="l00076"></a>00076     <span class="keywordflow">return</span> <a class="code" href="seafile_2lib_2utils_8c.html#a48ecdc72b727191abafbbf2ec1f70ace">is_uuid_valid</a> (<span class="keywordtype">id</span>);
<a name="l00077"></a>00077 }
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <a class="code" href="struct__SeafRepo.html">SeafRepo</a>*
<a name="l00080"></a><a class="code" href="server_2repo-mgr_8c.html#a63ab9fe4694e3d967376c911cbe2c655">00080</a> <a class="code" href="daemon_2repo-mgr_8c.html#a63ab9fe4694e3d967376c911cbe2c655">seaf_repo_new</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *desc)
<a name="l00081"></a>00081 {
<a name="l00082"></a>00082     <a class="code" href="struct__SeafRepo.html">SeafRepo</a>* repo;
<a name="l00083"></a>00083 
<a name="l00084"></a>00084     <span class="comment">/* valid check */</span>
<a name="l00085"></a>00085   
<a name="l00086"></a>00086     
<a name="l00087"></a>00087     repo = g_new0 (<a class="code" href="struct__SeafRepo.html">SeafRepo</a>, 1);
<a name="l00088"></a>00088     memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="keywordtype">id</span>, 36);
<a name="l00089"></a>00089     repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>[36] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00090"></a>00090 
<a name="l00091"></a>00091     repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a> = g_strdup(name);
<a name="l00092"></a>00092     repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a> = g_strdup(desc);
<a name="l00093"></a>00093 
<a name="l00094"></a>00094     repo-&gt;<a class="code" href="struct__SeafRepo.html#a73ff67300bff9e51d98f02e0729e569d">ref_cnt</a> = 1;
<a name="l00095"></a>00095 
<a name="l00096"></a>00096     <span class="keywordflow">return</span> repo;
<a name="l00097"></a>00097 }
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <span class="keywordtype">void</span>
<a name="l00100"></a><a class="code" href="server_2repo-mgr_8c.html#ad0a65514ad80789ff244b20c66460b96">00100</a> <a class="code" href="daemon_2repo-mgr_8c.html#ad0a65514ad80789ff244b20c66460b96">seaf_repo_free</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l00101"></a>00101 {
<a name="l00102"></a>00102     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>) g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>);
<a name="l00103"></a>00103     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a>) g_free (repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a>);
<a name="l00104"></a>00104     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>) <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>);
<a name="l00105"></a>00105     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#aa433b0ea3af1b2f6781dc78b06d40618">virtual_info</a>)
<a name="l00106"></a>00106         <a class="code" href="server_2gc_2repo-mgr_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a">seaf_virtual_repo_info_free</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#aa433b0ea3af1b2f6781dc78b06d40618">virtual_info</a>);
<a name="l00107"></a>00107     g_free (repo);
<a name="l00108"></a>00108 }
<a name="l00109"></a>00109 
<a name="l00110"></a>00110 <span class="keywordtype">void</span>
<a name="l00111"></a><a class="code" href="server_2repo-mgr_8c.html#ab8f60cbbd6c35ee55ea72acbbd3a1608">00111</a> <a class="code" href="fuse_2repo-mgr_8c.html#ab8f60cbbd6c35ee55ea72acbbd3a1608">seaf_repo_ref</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l00112"></a>00112 {
<a name="l00113"></a>00113     g_atomic_int_inc (&amp;repo-&gt;<a class="code" href="struct__SeafRepo.html#a73ff67300bff9e51d98f02e0729e569d">ref_cnt</a>);
<a name="l00114"></a>00114 }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 <span class="keywordtype">void</span>
<a name="l00117"></a><a class="code" href="server_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">00117</a> <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l00118"></a>00118 {
<a name="l00119"></a>00119     <span class="keywordflow">if</span> (!repo)
<a name="l00120"></a>00120         <span class="keywordflow">return</span>;
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     <span class="keywordflow">if</span> (g_atomic_int_dec_and_test (&amp;repo-&gt;<a class="code" href="struct__SeafRepo.html#a73ff67300bff9e51d98f02e0729e569d">ref_cnt</a>))
<a name="l00123"></a>00123         <a class="code" href="daemon_2repo-mgr_8c.html#ad0a65514ad80789ff244b20c66460b96">seaf_repo_free</a> (repo);
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00127"></a>00127 set_head_common (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch)
<a name="l00128"></a>00128 {
<a name="l00129"></a>00129     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>)
<a name="l00130"></a>00130         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>);
<a name="l00131"></a>00131     repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a> = branch;
<a name="l00132"></a>00132     <a class="code" href="branch-mgr_8c.html#a25fb6e7971efc301cfed3ef286f29746">seaf_branch_ref</a>(branch);
<a name="l00133"></a>00133 }
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="keywordtype">int</span>
<a name="l00136"></a><a class="code" href="server_2repo-mgr_8c.html#a6c47d6277897f6afbe866f2755f9762d">00136</a> <a class="code" href="daemon_2repo-mgr_8c.html#a6c47d6277897f6afbe866f2755f9762d">seaf_repo_set_head</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch)
<a name="l00137"></a>00137 {
<a name="l00138"></a>00138     <span class="keywordflow">if</span> (save_branch_repo_map (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>, branch) &lt; 0)
<a name="l00139"></a>00139         <span class="keywordflow">return</span> -1;
<a name="l00140"></a>00140     set_head_common (repo, branch);
<a name="l00141"></a>00141     <span class="keywordflow">return</span> 0;
<a name="l00142"></a>00142 }
<a name="l00143"></a>00143 
<a name="l00144"></a>00144 <span class="keywordtype">void</span>
<a name="l00145"></a><a class="code" href="server_2repo-mgr_8c.html#a9c8ead9892374c87ece888d76e810197">00145</a> <a class="code" href="daemon_2repo-mgr_8c.html#a9c8ead9892374c87ece888d76e810197">seaf_repo_from_commit</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit)
<a name="l00146"></a>00146 {
<a name="l00147"></a>00147     repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a> = g_strdup (commit-&gt;<a class="code" href="struct__SeafCommit.html#aacd7b88f8a3e72446cd7352396eaa09e">repo_name</a>);
<a name="l00148"></a>00148     repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a> = g_strdup (commit-&gt;<a class="code" href="struct__SeafCommit.html#aa3d8e868c630cfbecbcb9158c4bbe2e4">repo_desc</a>);
<a name="l00149"></a>00149     repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#a906e77d2a658f4337437ff8694a4bfc0">encrypted</a>;
<a name="l00150"></a>00150     repo-&gt;<a class="code" href="struct__SeafRepo.html#a87797d053b04a8d37b9dde3fb78eb996">repaired</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#aa95f8525261994a831111f8456998700">repaired</a>;
<a name="l00151"></a>00151     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>) {
<a name="l00152"></a>00152         repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a>;
<a name="l00153"></a>00153         <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> == 1)
<a name="l00154"></a>00154             memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a>, 32);
<a name="l00155"></a>00155         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> == 2) {
<a name="l00156"></a>00156             memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a>, 64);
<a name="l00157"></a>00157             memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#a83e0a2366ba320396f2deb6faa167b84">random_key</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#ab1d44814bc44472105aef8761656e3d7">random_key</a>, 96);
<a name="l00158"></a>00158         }
<a name="l00159"></a>00159     }
<a name="l00160"></a>00160     repo-&gt;<a class="code" href="struct__SeafRepo.html#a4710aaee11c7887df402fffa7ca6c54f">no_local_history</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#a383ea4a4b94417c7d9e9827d60420d64">no_local_history</a>;
<a name="l00161"></a>00161     repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a> = commit-&gt;<a class="code" href="struct__SeafCommit.html#abc83f168ce2b43fa864522bf0ea26d6d">version</a>;
<a name="l00162"></a>00162 }
<a name="l00163"></a>00163 
<a name="l00164"></a>00164 <span class="keywordtype">void</span>
<a name="l00165"></a><a class="code" href="server_2repo-mgr_8c.html#a39a9a41ffdfc324f3c935251d9e14d51">00165</a> <a class="code" href="daemon_2repo-mgr_8c.html#a39a9a41ffdfc324f3c935251d9e14d51">seaf_repo_to_commit</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit)
<a name="l00166"></a>00166 {
<a name="l00167"></a>00167     commit-&gt;<a class="code" href="struct__SeafCommit.html#aacd7b88f8a3e72446cd7352396eaa09e">repo_name</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>);
<a name="l00168"></a>00168     commit-&gt;<a class="code" href="struct__SeafCommit.html#aa3d8e868c630cfbecbcb9158c4bbe2e4">repo_desc</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a2bcd0258d3e8deb15a45aa8403c9156d">desc</a>);
<a name="l00169"></a>00169     commit-&gt;<a class="code" href="struct__SeafCommit.html#a906e77d2a658f4337437ff8694a4bfc0">encrypted</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>;
<a name="l00170"></a>00170     commit-&gt;<a class="code" href="struct__SeafCommit.html#aa95f8525261994a831111f8456998700">repaired</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#a87797d053b04a8d37b9dde3fb78eb996">repaired</a>;
<a name="l00171"></a>00171     <span class="keywordflow">if</span> (commit-&gt;<a class="code" href="struct__SeafCommit.html#a906e77d2a658f4337437ff8694a4bfc0">encrypted</a>) {
<a name="l00172"></a>00172         commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>;
<a name="l00173"></a>00173         <span class="keywordflow">if</span> (commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a> == 1)
<a name="l00174"></a>00174             commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>);
<a name="l00175"></a>00175         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (commit-&gt;<a class="code" href="struct__SeafCommit.html#a52953918e881ce013cd741deff721a70">enc_version</a> == 2) {
<a name="l00176"></a>00176             commit-&gt;<a class="code" href="struct__SeafCommit.html#a8e7caa10438ce42d7d39f57090768a9e">magic</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>);
<a name="l00177"></a>00177             commit-&gt;<a class="code" href="struct__SeafCommit.html#ab1d44814bc44472105aef8761656e3d7">random_key</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a83e0a2366ba320396f2deb6faa167b84">random_key</a>);
<a name="l00178"></a>00178         }
<a name="l00179"></a>00179     }
<a name="l00180"></a>00180     commit-&gt;<a class="code" href="struct__SeafCommit.html#a383ea4a4b94417c7d9e9827d60420d64">no_local_history</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#a4710aaee11c7887df402fffa7ca6c54f">no_local_history</a>;
<a name="l00181"></a>00181     commit-&gt;<a class="code" href="struct__SeafCommit.html#abc83f168ce2b43fa864522bf0ea26d6d">version</a> = repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>;
<a name="l00182"></a>00182 }
<a name="l00183"></a>00183 
<a name="l00184"></a>00184 <span class="keyword">static</span> gboolean
<a name="l00185"></a>00185 collect_commit (<a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit, <span class="keywordtype">void</span> *vlist, gboolean *stop)
<a name="l00186"></a>00186 {
<a name="l00187"></a>00187     GList **commits = vlist;
<a name="l00188"></a>00188 
<a name="l00189"></a>00189     <span class="comment">/* The traverse function will unref the commit, so we need to ref it.</span>
<a name="l00190"></a>00190 <span class="comment">     */</span>
<a name="l00191"></a>00191     <a class="code" href="commit-mgr_8c.html#a2b1cc305cf40cb64c341a0e64d0fe921">seaf_commit_ref</a> (commit);
<a name="l00192"></a>00192     *commits = g_list_prepend (*commits, commit);
<a name="l00193"></a>00193     <span class="keywordflow">return</span> TRUE;
<a name="l00194"></a>00194 }
<a name="l00195"></a>00195 
<a name="l00196"></a>00196 GList *
<a name="l00197"></a><a class="code" href="server_2repo-mgr_8c.html#adc55911231fbdbb9d54f39d7f0e60dca">00197</a> <a class="code" href="daemon_2repo-mgr_8c.html#adc55911231fbdbb9d54f39d7f0e60dca">seaf_repo_get_commits</a> (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l00198"></a>00198 {
<a name="l00199"></a>00199     GList *branches;
<a name="l00200"></a>00200     GList *ptr;
<a name="l00201"></a>00201     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch;
<a name="l00202"></a>00202     GList *commits = NULL;
<a name="l00203"></a>00203 
<a name="l00204"></a>00204     branches = <a class="code" href="branch-mgr_8c.html#ad5bd62cbe17cb8fe91bcd993956a1fbf">seaf_branch_manager_get_branch_list</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00205"></a>00205     <span class="keywordflow">if</span> (branches == NULL) {
<a name="l00206"></a>00206         seaf_warning (<span class="stringliteral">&quot;Failed to get branch list of repo %s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00207"></a>00207         <span class="keywordflow">return</span> NULL;
<a name="l00208"></a>00208     }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <span class="keywordflow">for</span> (ptr = branches; ptr != NULL; ptr = ptr-&gt;next) {
<a name="l00211"></a>00211         branch = ptr-&gt;data;
<a name="l00212"></a>00212         gboolean res = <a class="code" href="commit-mgr_8c.html#ac6547d5546781608b39446d9a2077fed">seaf_commit_manager_traverse_commit_tree</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l00213"></a>00213                                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l00214"></a>00214                                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
<a name="l00215"></a>00215                                                                  branch-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>,
<a name="l00216"></a>00216                                                                  collect_commit,
<a name="l00217"></a>00217                                                                  &amp;commits,
<a name="l00218"></a>00218                                                                  FALSE);
<a name="l00219"></a>00219         <span class="keywordflow">if</span> (!res) {
<a name="l00220"></a>00220             <span class="keywordflow">for</span> (ptr = commits; ptr != NULL; ptr = ptr-&gt;next)
<a name="l00221"></a>00221                 <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> ((<a class="code" href="struct__SeafCommit.html">SeafCommit</a> *)(ptr-&gt;data));
<a name="l00222"></a>00222             g_list_free (commits);
<a name="l00223"></a>00223             <span class="keywordflow">goto</span> out;
<a name="l00224"></a>00224         }
<a name="l00225"></a>00225     }
<a name="l00226"></a>00226 
<a name="l00227"></a>00227     commits = g_list_reverse (commits);
<a name="l00228"></a>00228 
<a name="l00229"></a>00229 out:
<a name="l00230"></a>00230     <span class="keywordflow">for</span> (ptr = branches; ptr != NULL; ptr = ptr-&gt;next) {
<a name="l00231"></a>00231         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> ((<a class="code" href="struct__SeafBranch.html">SeafBranch</a> *)ptr-&gt;data);
<a name="l00232"></a>00232     }
<a name="l00233"></a>00233     <span class="keywordflow">return</span> commits;
<a name="l00234"></a>00234 }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236 gboolean
<a name="l00237"></a><a class="code" href="repo-op_8c.html#a77f4492f1c388625ccf09d84f053913f">00237</a> <a class="code" href="server_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keywordtype">void</span> *data)
<a name="l00238"></a>00238 {
<a name="l00239"></a>00239     <span class="comment">/* GPatternSpec **spec = ignore_patterns; */</span>
<a name="l00240"></a>00240 
<a name="l00241"></a>00241     <span class="keywordflow">if</span> (!g_utf8_validate (filename, -1, NULL)) {
<a name="l00242"></a>00242         seaf_warning (<span class="stringliteral">&quot;File name %s contains non-UTF8 characters, skip.\n&quot;</span>, filename);
<a name="l00243"></a>00243         <span class="keywordflow">return</span> TRUE;
<a name="l00244"></a>00244     }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     <span class="comment">/* Ignore file/dir if its name is too long. */</span>
<a name="l00247"></a>00247     <span class="keywordflow">if</span> (strlen(filename) &gt;= <a class="code" href="fs-mgr_8h.html#ae95c413b4d740d94ac0cc8becc46e61e">SEAF_DIR_NAME_LEN</a>)
<a name="l00248"></a>00248         <span class="keywordflow">return</span> TRUE;
<a name="l00249"></a>00249 
<a name="l00250"></a>00250     <span class="keywordflow">if</span> (strchr (filename, <span class="charliteral">&#39;/&#39;</span>))
<a name="l00251"></a>00251         <span class="keywordflow">return</span> TRUE;
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     <span class="keywordflow">return</span> FALSE;
<a name="l00254"></a>00254 }
<a name="l00255"></a>00255 
<a name="l00256"></a>00256 <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a>*
<a name="l00257"></a><a class="code" href="server_2repo-mgr_8c.html#a8f91693d20dfa77546527064cb1097e3">00257</a> <a class="code" href="daemon_2repo-mgr_8c.html#a8f91693d20dfa77546527064cb1097e3">seaf_repo_manager_new</a> (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>)
<a name="l00258"></a>00258 {
<a name="l00259"></a>00259     <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = g_new0 (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a>, 1);
<a name="l00260"></a>00260 
<a name="l00261"></a>00261     mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a> = g_new0 (<a class="code" href="struct__SeafRepoManagerPriv.html">SeafRepoManagerPriv</a>, 1);
<a name="l00262"></a>00262     mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a> = <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>;
<a name="l00263"></a>00263 
<a name="l00264"></a>00264     mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a000e23969980c4dcc63654c2fd0e37d0">decrypted_tokens</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
<a name="l00265"></a>00265                                                          g_free,
<a name="l00266"></a>00266                                                          (GDestroyNotify)decrypted_token_free);
<a name="l00267"></a>00267     pthread_rwlock_init (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>, NULL);
<a name="l00268"></a>00268     mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#ac7a22edf1508a618322e36564e876c28">reap_token_timer</a> = <a class="code" href="timer_8h.html#a68b6afb704a7f56b625ed78146691b7c">ccnet_timer_new</a> (reap_token, mgr,
<a name="l00269"></a>00269                                                    <a class="code" href="server_2repo-mgr_8c.html#a086f525a24dc070dfb2b44cfcdd432e0">REAP_TOKEN_INTERVAL</a> * 1000);
<a name="l00270"></a>00270 
<a name="l00271"></a>00271     <span class="comment">/* ignore_patterns = g_new0 (GPatternSpec*, G_N_ELEMENTS(ignore_table)); */</span>
<a name="l00272"></a>00272     <span class="comment">/* int i; */</span>
<a name="l00273"></a>00273     <span class="comment">/* for (i = 0; ignore_table[i] != NULL; i++) { */</span>
<a name="l00274"></a>00274     <span class="comment">/*     ignore_patterns[i] = g_pattern_spec_new (ignore_table[i]); */</span>
<a name="l00275"></a>00275     <span class="comment">/* } */</span>
<a name="l00276"></a>00276 
<a name="l00277"></a>00277     <span class="keywordflow">return</span> mgr;
<a name="l00278"></a>00278 }
<a name="l00279"></a>00279 
<a name="l00280"></a>00280 <span class="keywordtype">int</span>
<a name="l00281"></a><a class="code" href="server_2repo-mgr_8c.html#a8dab773e289d1148e7afec7c8614278a">00281</a> <a class="code" href="daemon_2repo-mgr_8c.html#a8dab773e289d1148e7afec7c8614278a">seaf_repo_manager_init</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr)
<a name="l00282"></a>00282 {
<a name="l00283"></a>00283     <span class="comment">/* On the server, we load repos into memory on-demand, because</span>
<a name="l00284"></a>00284 <span class="comment">     * there are too many repos.</span>
<a name="l00285"></a>00285 <span class="comment">     */</span>
<a name="l00286"></a>00286     <span class="keywordflow">if</span> (create_db_tables_if_not_exist (mgr) &lt; 0) {
<a name="l00287"></a>00287         seaf_warning (<span class="stringliteral">&quot;[repo mgr] failed to create tables.\n&quot;</span>);
<a name="l00288"></a>00288         <span class="keywordflow">return</span> -1;
<a name="l00289"></a>00289     }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291     <span class="keywordflow">if</span> (<a class="code" href="server_2repo-mgr_8h.html#a9545839eb2c54af7e7e2e3948647f47c">seaf_repo_manager_init_merge_scheduler</a>() &lt; 0) {
<a name="l00292"></a>00292         seaf_warning (<span class="stringliteral">&quot;Failed to init merge scheduler.\n&quot;</span>);
<a name="l00293"></a>00293         <span class="keywordflow">return</span> -1;
<a name="l00294"></a>00294     }
<a name="l00295"></a>00295 
<a name="l00296"></a>00296     <span class="keywordflow">return</span> 0;
<a name="l00297"></a>00297 }
<a name="l00298"></a>00298 
<a name="l00299"></a>00299 <span class="keywordtype">int</span>
<a name="l00300"></a><a class="code" href="server_2repo-mgr_8c.html#a2e049cfa3d0546aaf51e7f6792e1467d">00300</a> <a class="code" href="daemon_2repo-mgr_8c.html#a2e049cfa3d0546aaf51e7f6792e1467d">seaf_repo_manager_start</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr)
<a name="l00301"></a>00301 {
<a name="l00302"></a>00302     <span class="keywordflow">return</span> 0;
<a name="l00303"></a>00303 }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305 <span class="keywordtype">int</span>
<a name="l00306"></a><a class="code" href="server_2repo-mgr_8c.html#a140616a89d5a02935665f86cf3bb744c">00306</a> <a class="code" href="daemon_2repo-mgr_8c.html#a140616a89d5a02935665f86cf3bb744c">seaf_repo_manager_add_repo</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l00307"></a>00307                             <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l00308"></a>00308 {
<a name="l00309"></a>00309     <a class="code" href="structSeafDB.html">SeafDB</a> *db = manager-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;
<a name="l00310"></a>00310 
<a name="l00311"></a>00311     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db, <span class="stringliteral">&quot;INSERT INTO Repo VALUES (?)&quot;</span>,
<a name="l00312"></a>00312                                  1, <span class="stringliteral">&quot;string&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>) &lt; 0)
<a name="l00313"></a>00313         <span class="keywordflow">return</span> -1;
<a name="l00314"></a>00314 
<a name="l00315"></a>00315     repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a> = manager;
<a name="l00316"></a>00316 
<a name="l00317"></a>00317     <span class="keywordflow">return</span> 0;
<a name="l00318"></a>00318 }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00321"></a>00321 add_deleted_repo_record (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr, <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l00322"></a>00322 {
<a name="l00323"></a>00323     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae183a9c45ec082962bdd361491b0a8cb">seaf_db_type</a>(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>) == <a class="code" href="seaf-db_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da62ce2e8a052406ede3fcf39ec407ccf8">SEAF_DB_TYPE_PGSQL</a>) {
<a name="l00324"></a>00324         gboolean exists, err;
<a name="l00325"></a>00325 
<a name="l00326"></a>00326         exists = <a class="code" href="seaf-db_8c.html#af77a76302b3316a4d71e418de27843c4">seaf_db_statement_exists</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l00327"></a>00327                                            <span class="stringliteral">&quot;SELECT repo_id FROM GarbageRepos &quot;</span>
<a name="l00328"></a>00328                                            <span class="stringliteral">&quot;WHERE repo_id=?&quot;</span>,
<a name="l00329"></a>00329                                            &amp;err, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l00330"></a>00330         <span class="keywordflow">if</span> (err)
<a name="l00331"></a>00331             <span class="keywordflow">return</span> -1;
<a name="l00332"></a>00332 
<a name="l00333"></a>00333         <span class="keywordflow">if</span> (!exists) {
<a name="l00334"></a>00334             <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a>(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l00335"></a>00335                                            <span class="stringliteral">&quot;INSERT INTO GarbageRepos VALUES (?)&quot;</span>,
<a name="l00336"></a>00336                                            1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l00337"></a>00337         }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339         <span class="keywordflow">return</span> 0;
<a name="l00340"></a>00340     } <span class="keywordflow">else</span> {
<a name="l00341"></a>00341         <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l00342"></a>00342                                         <span class="stringliteral">&quot;REPLACE INTO GarbageRepos VALUES (?)&quot;</span>,
<a name="l00343"></a>00343                                         1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l00344"></a>00344     }
<a name="l00345"></a>00345 }
<a name="l00346"></a>00346 
<a name="l00347"></a>00347 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00348"></a>00348 add_deleted_repo_to_trash (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr, <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l00349"></a>00349 {
<a name="l00350"></a>00350     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch = NULL;
<a name="l00351"></a>00351     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit = NULL;
<a name="l00352"></a>00352     <span class="keywordtype">char</span> *owner = NULL;
<a name="l00353"></a>00353     <span class="keywordtype">int</span> ret = -1;
<a name="l00354"></a>00354 
<a name="l00355"></a>00355     branch = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>,
<a name="l00356"></a>00356                                              repo_id, <span class="stringliteral">&quot;master&quot;</span>);
<a name="l00357"></a>00357     <span class="keywordflow">if</span> (!branch) {
<a name="l00358"></a>00358         seaf_warning (<span class="stringliteral">&quot;Failed to get branch for repo %.8s.\n&quot;</span>, repo_id);
<a name="l00359"></a>00359         <span class="keywordflow">return</span> ret;
<a name="l00360"></a>00360     }
<a name="l00361"></a>00361 
<a name="l00362"></a>00362     commit = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l00363"></a>00363                                              repo_id, 1, branch-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l00364"></a>00364     <span class="keywordflow">if</span> (!commit) {
<a name="l00365"></a>00365         seaf_warning (<span class="stringliteral">&quot;Failed to get commit %s from repo %.8s.\n&quot;</span>,
<a name="l00366"></a>00366                       branch-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>, repo_id);
<a name="l00367"></a>00367         <span class="keywordflow">goto</span> out;
<a name="l00368"></a>00368     }
<a name="l00369"></a>00369 
<a name="l00370"></a>00370     owner = <a class="code" href="server_2repo-mgr_8c.html#af227a31082c71908bf0a0ac35cfeb294">seaf_repo_manager_get_repo_owner</a> (mgr, repo_id);
<a name="l00371"></a>00371     <span class="keywordflow">if</span> (!owner) {
<a name="l00372"></a>00372         seaf_warning (<span class="stringliteral">&quot;Failed to get owner for repo %.8s.\n&quot;</span>, repo_id);
<a name="l00373"></a>00373         <span class="keywordflow">goto</span> out;
<a name="l00374"></a>00374     }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376     gint64 <a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a> = <a class="code" href="server_2repo-mgr_8c.html#ae37e80051d587e921a003fc06c21d540">seaf_repo_manager_get_repo_size</a> (mgr, repo_id);
<a name="l00377"></a>00377     <span class="keywordflow">if</span> (size == -1) {
<a name="l00378"></a>00378         seaf_warning (<span class="stringliteral">&quot;Failed to get size of repo %.8s.\n&quot;</span>, repo_id);
<a name="l00379"></a>00379         <span class="keywordflow">goto</span> out;
<a name="l00380"></a>00380     }
<a name="l00381"></a>00381 
<a name="l00382"></a>00382     ret =  <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l00383"></a>00383                                     <span class="stringliteral">&quot;INSERT INTO RepoTrash (repo_id, repo_name, head_id, &quot;</span>
<a name="l00384"></a>00384                                     <span class="stringliteral">&quot;owner_id, size, org_id) &quot;</span>
<a name="l00385"></a>00385                                     <span class="stringliteral">&quot;values (?, ?, ?, ?, ?, -1)&quot;</span>, 5,
<a name="l00386"></a>00386                                     <span class="stringliteral">&quot;string&quot;</span>, repo_id,
<a name="l00387"></a>00387                                     <span class="stringliteral">&quot;string&quot;</span>, commit-&gt;<a class="code" href="struct__SeafCommit.html#aacd7b88f8a3e72446cd7352396eaa09e">repo_name</a>,
<a name="l00388"></a>00388                                     <span class="stringliteral">&quot;string&quot;</span>, branch-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>,
<a name="l00389"></a>00389                                     <span class="stringliteral">&quot;string&quot;</span>, owner,
<a name="l00390"></a>00390                                     <span class="stringliteral">&quot;int64&quot;</span>, size);
<a name="l00391"></a>00391 out:
<a name="l00392"></a>00392     g_free (owner);
<a name="l00393"></a>00393     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
<a name="l00394"></a>00394     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l00395"></a>00395 
<a name="l00396"></a>00396     <span class="keywordflow">return</span> ret;
<a name="l00397"></a>00397 }
<a name="l00398"></a>00398 
<a name="l00399"></a>00399 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00400"></a>00400 remove_virtual_repo_ondisk (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l00401"></a>00401                             <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l00402"></a>00402 {
<a name="l00403"></a>00403     <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;
<a name="l00404"></a>00404 
<a name="l00405"></a>00405     <span class="comment">/* Remove record in repo table first.</span>
<a name="l00406"></a>00406 <span class="comment">     * Once this is commited, we can gc the other tables later even if</span>
<a name="l00407"></a>00407 <span class="comment">     * we&#39;re interrupted.</span>
<a name="l00408"></a>00408 <span class="comment">     */</span>
<a name="l00409"></a>00409     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db, <span class="stringliteral">&quot;DELETE FROM Repo WHERE repo_id = ?&quot;</span>,
<a name="l00410"></a>00410                                  1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0)
<a name="l00411"></a>00411         <span class="keywordflow">return</span> -1;
<a name="l00412"></a>00412 
<a name="l00413"></a>00413     <span class="comment">/* remove branch */</span>
<a name="l00414"></a>00414     GList *p;
<a name="l00415"></a>00415     GList *branch_list = 
<a name="l00416"></a>00416         <a class="code" href="branch-mgr_8c.html#ad5bd62cbe17cb8fe91bcd993956a1fbf">seaf_branch_manager_get_branch_list</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo_id);
<a name="l00417"></a>00417     <span class="keywordflow">for</span> (p = branch_list; p; p = p-&gt;next) {
<a name="l00418"></a>00418         <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *b = (<a class="code" href="struct__SeafBranch.html">SeafBranch</a> *)p-&gt;data;
<a name="l00419"></a>00419         <a class="code" href="daemon_2repo-mgr_8c.html#ae586fb5fbd61d6b44be3e47e7b6c86da">seaf_repo_manager_branch_repo_unmap</a> (mgr, b);
<a name="l00420"></a>00420         <a class="code" href="branch-mgr_8c.html#a16b2df7708f3a4c4b96e9135ec7e1a3d">seaf_branch_manager_del_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo_id, b-&gt;<a class="code" href="struct__SeafBranch.html#ae6af0006b9b80ded4f0525a3be06ccda">name</a>);
<a name="l00421"></a>00421     }
<a name="l00422"></a>00422     <a class="code" href="branch-mgr_8c.html#ac6476414064e0ff0c429629aaab0bfc9">seaf_branch_list_free</a> (branch_list);
<a name="l00423"></a>00423 
<a name="l00424"></a>00424     <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db, <span class="stringliteral">&quot;DELETE FROM RepoOwner WHERE repo_id = ?&quot;</span>,
<a name="l00425"></a>00425                    1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l00426"></a>00426 
<a name="l00427"></a>00427     <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db, <span class="stringliteral">&quot;DELETE FROM SharedRepo WHERE repo_id = ?&quot;</span>,
<a name="l00428"></a>00428                    1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l00429"></a>00429 
<a name="l00430"></a>00430     <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db, <span class="stringliteral">&quot;DELETE FROM RepoGroup WHERE repo_id = ?&quot;</span>,
<a name="l00431"></a>00431                    1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l00432"></a>00432 
<a name="l00433"></a>00433     <span class="keywordflow">if</span> (!<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a65f4d1d214fce9bd718d84aa87b9bd9c">cloud_mode</a>) {
<a name="l00434"></a>00434         <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db, <span class="stringliteral">&quot;DELETE FROM InnerPubRepo WHERE repo_id = ?&quot;</span>,
<a name="l00435"></a>00435                                  1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l00436"></a>00436     }
<a name="l00437"></a>00437 
<a name="l00438"></a>00438     <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db, <span class="stringliteral">&quot;DELETE FROM RepoUserToken WHERE repo_id = ?&quot;</span>,
<a name="l00439"></a>00439                              1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l00440"></a>00440 
<a name="l00441"></a>00441     <span class="keywordflow">return</span> 0;
<a name="l00442"></a>00442 }
<a name="l00443"></a>00443 
<a name="l00444"></a>00444 <span class="keywordtype">int</span>
<a name="l00445"></a><a class="code" href="server_2repo-mgr_8h.html#a512a79980f7d3698e591cf87aeccd314">00445</a> <a class="code" href="daemon_2repo-mgr_8c.html#afdce2de6ee36dcf6b6264ac35fb17f7a">seaf_repo_manager_del_repo</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l00446"></a>00446                             <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l00447"></a>00447 {
<a name="l00448"></a>00448     <span class="keywordflow">if</span> (add_deleted_repo_to_trash (mgr, repo_id) &lt; 0)
<a name="l00449"></a>00449         <span class="keywordflow">return</span> -1;
<a name="l00450"></a>00450 
<a name="l00451"></a>00451     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM Repo WHERE repo_id = ?&quot;</span>,
<a name="l00452"></a>00452                                  1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0)
<a name="l00453"></a>00453         <span class="keywordflow">return</span> -1;
<a name="l00454"></a>00454 
<a name="l00455"></a>00455     <span class="comment">/* Repo branches are not removed at this point. */</span>
<a name="l00456"></a>00456 
<a name="l00457"></a>00457     <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM RepoOwner WHERE repo_id = ?&quot;</span>,
<a name="l00458"></a>00458                              1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l00459"></a>00459 
<a name="l00460"></a>00460     <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM SharedRepo WHERE repo_id = ?&quot;</span>,
<a name="l00461"></a>00461                              1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l00462"></a>00462 
<a name="l00463"></a>00463     <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM RepoGroup WHERE repo_id = ?&quot;</span>,
<a name="l00464"></a>00464                              1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l00465"></a>00465 
<a name="l00466"></a>00466     <span class="keywordflow">if</span> (!<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a65f4d1d214fce9bd718d84aa87b9bd9c">cloud_mode</a>) {
<a name="l00467"></a>00467         <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM InnerPubRepo WHERE repo_id = ?&quot;</span>,
<a name="l00468"></a>00468                                  1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471     <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM RepoUserToken WHERE repo_id = ?&quot;</span>,
<a name="l00472"></a>00472                              1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l00473"></a>00473 
<a name="l00474"></a>00474     <span class="comment">/* Remove virtual repos when origin repo is deleted. */</span>
<a name="l00475"></a>00475     GList *vrepos, *ptr;
<a name="l00476"></a>00476     vrepos = <a class="code" href="server_2gc_2repo-mgr_8c.html#a0e2fecd8fae5355455342e43f6588967">seaf_repo_manager_get_virtual_repo_ids_by_origin</a> (mgr, repo_id);
<a name="l00477"></a>00477     <span class="keywordflow">for</span> (ptr = vrepos; ptr != NULL; ptr = ptr-&gt;next)
<a name="l00478"></a>00478         remove_virtual_repo_ondisk (mgr, (<span class="keywordtype">char</span> *)ptr-&gt;data);
<a name="l00479"></a>00479     <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (vrepos);
<a name="l00480"></a>00480 
<a name="l00481"></a>00481     <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="stringliteral">&quot;DELETE FROM VirtualRepo &quot;</span>
<a name="l00482"></a>00482                              <span class="stringliteral">&quot;WHERE repo_id=? OR origin_repo=?&quot;</span>,
<a name="l00483"></a>00483                              2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l00484"></a>00484 
<a name="l00485"></a>00485     <span class="keywordflow">return</span> 0;
<a name="l00486"></a>00486 }
<a name="l00487"></a>00487 
<a name="l00488"></a>00488 <span class="keywordtype">int</span>
<a name="l00489"></a><a class="code" href="server_2repo-mgr_8h.html#a69efc9d099ac370fff9fe9e4caea05ea">00489</a> <a class="code" href="server_2repo-mgr_8c.html#a69efc9d099ac370fff9fe9e4caea05ea">seaf_repo_manager_del_virtual_repo</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l00490"></a>00490                                     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l00491"></a>00491 {
<a name="l00492"></a>00492     <span class="keywordflow">return</span> remove_virtual_repo_ondisk (mgr, repo_id);
<a name="l00493"></a>00493 }
<a name="l00494"></a>00494 
<a name="l00495"></a>00495 <span class="keyword">static</span> gboolean
<a name="l00496"></a>00496 repo_exists_in_db (<a class="code" href="structSeafDB.html">SeafDB</a> *db, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>, gboolean *db_err)
<a name="l00497"></a>00497 {
<a name="l00498"></a>00498     <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#af77a76302b3316a4d71e418de27843c4">seaf_db_statement_exists</a> (db,
<a name="l00499"></a>00499                                      <span class="stringliteral">&quot;SELECT repo_id FROM Repo WHERE repo_id = ?&quot;</span>,
<a name="l00500"></a>00500                                      db_err, 1, <span class="stringliteral">&quot;string&quot;</span>, <span class="keywordtype">id</span>);
<a name="l00501"></a>00501 }
<a name="l00502"></a>00502 
<a name="l00503"></a>00503 <a class="code" href="struct__SeafRepo.html">SeafRepo</a>*
<a name="l00504"></a><a class="code" href="server_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">00504</a> <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <span class="keyword">const</span> gchar *<span class="keywordtype">id</span>)
<a name="l00505"></a>00505 {
<a name="l00506"></a>00506     <span class="keywordtype">int</span> len = strlen(<span class="keywordtype">id</span>);
<a name="l00507"></a>00507     gboolean db_err = FALSE;
<a name="l00508"></a>00508 
<a name="l00509"></a>00509     <span class="keywordflow">if</span> (len &gt;= 37)
<a name="l00510"></a>00510         <span class="keywordflow">return</span> NULL;
<a name="l00511"></a>00511 
<a name="l00512"></a>00512     <span class="keywordflow">if</span> (repo_exists_in_db (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="keywordtype">id</span>, &amp;db_err)) {
<a name="l00513"></a>00513         <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *ret = load_repo (manager, <span class="keywordtype">id</span>, FALSE);
<a name="l00514"></a>00514         <span class="keywordflow">if</span> (!ret)
<a name="l00515"></a>00515             <span class="keywordflow">return</span> NULL;
<a name="l00516"></a>00516         <span class="comment">/* seaf_repo_ref (ret); */</span>
<a name="l00517"></a>00517         <span class="keywordflow">return</span> ret;
<a name="l00518"></a>00518     }
<a name="l00519"></a>00519 
<a name="l00520"></a>00520     <span class="keywordflow">return</span> NULL;
<a name="l00521"></a>00521 }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523 <a class="code" href="struct__SeafRepo.html">SeafRepo</a>*
<a name="l00524"></a><a class="code" href="server_2repo-mgr_8c.html#a11cc1a4ecd45778ea5a10af0cb72b347">00524</a> <a class="code" href="server_2gc_2repo-mgr_8c.html#a11cc1a4ecd45778ea5a10af0cb72b347">seaf_repo_manager_get_repo_ex</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <span class="keyword">const</span> gchar *<span class="keywordtype">id</span>)
<a name="l00525"></a>00525 {
<a name="l00526"></a>00526     <span class="keywordtype">int</span> len = strlen(<span class="keywordtype">id</span>);
<a name="l00527"></a>00527     gboolean db_err = FALSE, exists;
<a name="l00528"></a>00528     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *ret = NULL;
<a name="l00529"></a>00529 
<a name="l00530"></a>00530     <span class="keywordflow">if</span> (len &gt;= 37)
<a name="l00531"></a>00531         <span class="keywordflow">return</span> NULL;
<a name="l00532"></a>00532 
<a name="l00533"></a>00533     exists = repo_exists_in_db (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="keywordtype">id</span>, &amp;db_err);
<a name="l00534"></a>00534 
<a name="l00535"></a>00535     <span class="keywordflow">if</span> (db_err) {
<a name="l00536"></a>00536         ret = <a class="code" href="daemon_2repo-mgr_8c.html#a63ab9fe4694e3d967376c911cbe2c655">seaf_repo_new</a>(<span class="keywordtype">id</span>, NULL, NULL);
<a name="l00537"></a>00537         ret-&gt;<a class="code" href="struct__SeafRepo.html#a30acbbe15ec4e36a8b3bb31581c333e5">is_corrupted</a> = TRUE;
<a name="l00538"></a>00538         <span class="keywordflow">return</span> ret;
<a name="l00539"></a>00539     }
<a name="l00540"></a>00540 
<a name="l00541"></a>00541     <span class="keywordflow">if</span> (exists) {
<a name="l00542"></a>00542         ret = load_repo (manager, <span class="keywordtype">id</span>, TRUE);
<a name="l00543"></a>00543         <span class="keywordflow">return</span> ret;
<a name="l00544"></a>00544     }
<a name="l00545"></a>00545 
<a name="l00546"></a>00546     <span class="keywordflow">return</span> NULL;
<a name="l00547"></a>00547 }
<a name="l00548"></a>00548 
<a name="l00549"></a>00549 gboolean
<a name="l00550"></a><a class="code" href="server_2repo-mgr_8c.html#a4b2497e6cdde50c4ce3cb642370e06eb">00550</a> <a class="code" href="daemon_2repo-mgr_8c.html#a4b2497e6cdde50c4ce3cb642370e06eb">seaf_repo_manager_repo_exists</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <span class="keyword">const</span> gchar *<span class="keywordtype">id</span>)
<a name="l00551"></a>00551 {
<a name="l00552"></a>00552     gboolean db_err = FALSE;
<a name="l00553"></a>00553     <span class="keywordflow">return</span> repo_exists_in_db (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="keywordtype">id</span>, &amp;db_err);
<a name="l00554"></a>00554 }
<a name="l00555"></a>00555 
<a name="l00556"></a>00556 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00557"></a>00557 save_branch_repo_map (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch)
<a name="l00558"></a>00558 {
<a name="l00559"></a>00559     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae183a9c45ec082962bdd361491b0a8cb">seaf_db_type</a>(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>) == <a class="code" href="seaf-db_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da62ce2e8a052406ede3fcf39ec407ccf8">SEAF_DB_TYPE_PGSQL</a>) {
<a name="l00560"></a>00560         gboolean exists, err;
<a name="l00561"></a>00561         <span class="keywordtype">int</span> rc;
<a name="l00562"></a>00562 
<a name="l00563"></a>00563         exists = <a class="code" href="seaf-db_8c.html#af77a76302b3316a4d71e418de27843c4">seaf_db_statement_exists</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l00564"></a>00564                                            <span class="stringliteral">&quot;SELECT repo_id FROM RepoHead WHERE repo_id=?&quot;</span>,
<a name="l00565"></a>00565                                            &amp;err, 1, <span class="stringliteral">&quot;string&quot;</span>, branch-&gt;<a class="code" href="struct__SeafBranch.html#a88717f46308eb12629b99f9ff91740c2">repo_id</a>);
<a name="l00566"></a>00566         <span class="keywordflow">if</span> (err)
<a name="l00567"></a>00567             <span class="keywordflow">return</span> -1;
<a name="l00568"></a>00568 
<a name="l00569"></a>00569         <span class="keywordflow">if</span> (exists)
<a name="l00570"></a>00570             rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l00571"></a>00571                                           <span class="stringliteral">&quot;UPDATE RepoHead SET branch_name=? &quot;</span>
<a name="l00572"></a>00572                                           <span class="stringliteral">&quot;WHERE repo_id=?&quot;</span>,
<a name="l00573"></a>00573                                           2, <span class="stringliteral">&quot;string&quot;</span>, branch-&gt;<a class="code" href="struct__SeafBranch.html#ae6af0006b9b80ded4f0525a3be06ccda">name</a>,
<a name="l00574"></a>00574                                           <span class="stringliteral">&quot;string&quot;</span>, branch-&gt;<a class="code" href="struct__SeafBranch.html#a88717f46308eb12629b99f9ff91740c2">repo_id</a>);
<a name="l00575"></a>00575         <span class="keywordflow">else</span>
<a name="l00576"></a>00576             rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l00577"></a>00577                                           <span class="stringliteral">&quot;INSERT INTO RepoHead VALUES (?, ?)&quot;</span>,
<a name="l00578"></a>00578                                           2, <span class="stringliteral">&quot;string&quot;</span>, branch-&gt;<a class="code" href="struct__SeafBranch.html#a88717f46308eb12629b99f9ff91740c2">repo_id</a>,
<a name="l00579"></a>00579                                           <span class="stringliteral">&quot;string&quot;</span>, branch-&gt;<a class="code" href="struct__SeafBranch.html#ae6af0006b9b80ded4f0525a3be06ccda">name</a>);
<a name="l00580"></a>00580         <span class="keywordflow">return</span> rc;
<a name="l00581"></a>00581     } <span class="keywordflow">else</span> {
<a name="l00582"></a>00582         <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l00583"></a>00583                                         <span class="stringliteral">&quot;REPLACE INTO RepoHead VALUES (?, ?)&quot;</span>,
<a name="l00584"></a>00584                                         2, <span class="stringliteral">&quot;string&quot;</span>, branch-&gt;<a class="code" href="struct__SeafBranch.html#a88717f46308eb12629b99f9ff91740c2">repo_id</a>,
<a name="l00585"></a>00585                                         <span class="stringliteral">&quot;string&quot;</span>, branch-&gt;<a class="code" href="struct__SeafBranch.html#ae6af0006b9b80ded4f0525a3be06ccda">name</a>);
<a name="l00586"></a>00586     }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588     <span class="keywordflow">return</span> -1;
<a name="l00589"></a>00589 }
<a name="l00590"></a>00590 
<a name="l00591"></a>00591 <span class="keywordtype">int</span>
<a name="l00592"></a><a class="code" href="server_2repo-mgr_8c.html#ae586fb5fbd61d6b44be3e47e7b6c86da">00592</a> <a class="code" href="daemon_2repo-mgr_8c.html#ae586fb5fbd61d6b44be3e47e7b6c86da">seaf_repo_manager_branch_repo_unmap</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch)
<a name="l00593"></a>00593 {
<a name="l00594"></a>00594     <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l00595"></a>00595                                     <span class="stringliteral">&quot;DELETE FROM RepoHead WHERE branch_name = ?&quot;</span>
<a name="l00596"></a>00596                                     <span class="stringliteral">&quot; AND repo_id = ?&quot;</span>,
<a name="l00597"></a>00597                                     2, <span class="stringliteral">&quot;string&quot;</span>, branch-&gt;<a class="code" href="struct__SeafBranch.html#ae6af0006b9b80ded4f0525a3be06ccda">name</a>,
<a name="l00598"></a>00598                                     <span class="stringliteral">&quot;string&quot;</span>, branch-&gt;<a class="code" href="struct__SeafBranch.html#a88717f46308eb12629b99f9ff91740c2">repo_id</a>);
<a name="l00599"></a>00599 }
<a name="l00600"></a>00600 
<a name="l00601"></a>00601 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00602"></a>00602 load_repo_commit (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l00603"></a>00603                   <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo,
<a name="l00604"></a>00604                   <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch)
<a name="l00605"></a>00605 {
<a name="l00606"></a>00606     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit;
<a name="l00607"></a>00607 
<a name="l00608"></a>00608     commit = <a class="code" href="commit-mgr_8c.html#af797c5d03d9c32cd3a4c5ebcf376a855">seaf_commit_manager_get_commit_compatible</a> (manager-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l00609"></a>00609                                                         repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l00610"></a>00610                                                         branch-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l00611"></a>00611     <span class="keywordflow">if</span> (!commit) {
<a name="l00612"></a>00612         seaf_warning (<span class="stringliteral">&quot;Commit %s is missing\n&quot;</span>, branch-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l00613"></a>00613         repo-&gt;<a class="code" href="struct__SeafRepo.html#a30acbbe15ec4e36a8b3bb31581c333e5">is_corrupted</a> = TRUE;
<a name="l00614"></a>00614         <span class="keywordflow">return</span>;
<a name="l00615"></a>00615     }
<a name="l00616"></a>00616 
<a name="l00617"></a>00617     set_head_common (repo, branch);
<a name="l00618"></a>00618     <a class="code" href="daemon_2repo-mgr_8c.html#a9c8ead9892374c87ece888d76e810197">seaf_repo_from_commit</a> (repo, commit);
<a name="l00619"></a>00619 
<a name="l00620"></a>00620     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
<a name="l00621"></a>00621 }
<a name="l00622"></a>00622 
<a name="l00623"></a>00623 <span class="keyword">static</span> <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *
<a name="l00624"></a>00624 load_repo (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager, <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id, gboolean ret_corrupt)
<a name="l00625"></a>00625 {
<a name="l00626"></a>00626     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l00627"></a>00627     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *branch;
<a name="l00628"></a>00628 
<a name="l00629"></a>00629     repo = <a class="code" href="daemon_2repo-mgr_8c.html#a63ab9fe4694e3d967376c911cbe2c655">seaf_repo_new</a>(repo_id, NULL, NULL);
<a name="l00630"></a>00630     <span class="keywordflow">if</span> (!repo) {
<a name="l00631"></a>00631         seaf_warning (<span class="stringliteral">&quot;[repo mgr] failed to alloc repo.\n&quot;</span>);
<a name="l00632"></a>00632         <span class="keywordflow">return</span> NULL;
<a name="l00633"></a>00633     }
<a name="l00634"></a>00634 
<a name="l00635"></a>00635     repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a> = manager;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637     branch = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo_id, <span class="stringliteral">&quot;master&quot;</span>);
<a name="l00638"></a>00638     <span class="keywordflow">if</span> (!branch) {
<a name="l00639"></a>00639         g_warning (<span class="stringliteral">&quot;Failed to get master branch of repo %.8s.\n&quot;</span>, repo_id);
<a name="l00640"></a>00640         repo-&gt;<a class="code" href="struct__SeafRepo.html#a30acbbe15ec4e36a8b3bb31581c333e5">is_corrupted</a> = TRUE;
<a name="l00641"></a>00641     } <span class="keywordflow">else</span> {
<a name="l00642"></a>00642         load_repo_commit (manager, repo, branch);
<a name="l00643"></a>00643         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (branch);
<a name="l00644"></a>00644     }
<a name="l00645"></a>00645 
<a name="l00646"></a>00646     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a30acbbe15ec4e36a8b3bb31581c333e5">is_corrupted</a>) {
<a name="l00647"></a>00647         <span class="keywordflow">if</span> (!ret_corrupt) {
<a name="l00648"></a>00648             <a class="code" href="daemon_2repo-mgr_8c.html#ad0a65514ad80789ff244b20c66460b96">seaf_repo_free</a> (repo);
<a name="l00649"></a>00649             <span class="keywordflow">return</span> NULL;
<a name="l00650"></a>00650         }
<a name="l00651"></a>00651         <span class="keywordflow">return</span> repo;
<a name="l00652"></a>00652     }
<a name="l00653"></a>00653 
<a name="l00654"></a>00654     <span class="comment">/* Load virtual repo info if any. */</span>
<a name="l00655"></a>00655     repo-&gt;<a class="code" href="struct__SeafRepo.html#aa433b0ea3af1b2f6781dc78b06d40618">virtual_info</a> = <a class="code" href="server_2gc_2repo-mgr_8c.html#a316db228b35dde3dc88ae9dab9ec9c22">seaf_repo_manager_get_virtual_repo_info</a> (manager, repo_id);
<a name="l00656"></a>00656     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#aa433b0ea3af1b2f6781dc78b06d40618">virtual_info</a>)
<a name="l00657"></a>00657         memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#aa433b0ea3af1b2f6781dc78b06d40618">virtual_info</a>-&gt;<a class="code" href="structSeafVirtRepo.html#a23bc0205036c7a0c807c4f89145794b1">origin_repo_id</a>, 36);
<a name="l00658"></a>00658     <span class="keywordflow">else</span>
<a name="l00659"></a>00659         memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, 36);
<a name="l00660"></a>00660 
<a name="l00661"></a>00661     <span class="keywordflow">return</span> repo;
<a name="l00662"></a>00662 }
<a name="l00663"></a>00663 
<a name="l00664"></a>00664 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00665"></a>00665 create_tables_mysql (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr)
<a name="l00666"></a>00666 {
<a name="l00667"></a>00667     <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;
<a name="l00668"></a>00668     <span class="keywordtype">char</span> *sql;
<a name="l00669"></a>00669 
<a name="l00670"></a>00670     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS Repo (repo_id CHAR(37) PRIMARY KEY)&quot;</span>
<a name="l00671"></a>00671         <span class="stringliteral">&quot;ENGINE=INNODB&quot;</span>;
<a name="l00672"></a>00672     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00673"></a>00673         <span class="keywordflow">return</span> -1;
<a name="l00674"></a>00674 
<a name="l00675"></a>00675     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoOwner (&quot;</span>
<a name="l00676"></a>00676         <span class="stringliteral">&quot;repo_id CHAR(37) PRIMARY KEY, &quot;</span>
<a name="l00677"></a>00677         <span class="stringliteral">&quot;owner_id VARCHAR(255),&quot;</span>
<a name="l00678"></a>00678         <span class="stringliteral">&quot;INDEX (owner_id))&quot;</span>
<a name="l00679"></a>00679         <span class="stringliteral">&quot;ENGINE=INNODB&quot;</span>;
<a name="l00680"></a>00680     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00681"></a>00681         <span class="keywordflow">return</span> -1;
<a name="l00682"></a>00682 
<a name="l00683"></a>00683     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoGroup (repo_id CHAR(37), &quot;</span>
<a name="l00684"></a>00684         <span class="stringliteral">&quot;group_id INTEGER, user_name VARCHAR(255), permission CHAR(15), &quot;</span>
<a name="l00685"></a>00685         <span class="stringliteral">&quot;UNIQUE INDEX (group_id, repo_id), &quot;</span>
<a name="l00686"></a>00686         <span class="stringliteral">&quot;INDEX (repo_id), INDEX (user_name))&quot;</span>
<a name="l00687"></a>00687         <span class="stringliteral">&quot;ENGINE=INNODB&quot;</span>;
<a name="l00688"></a>00688     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00689"></a>00689         <span class="keywordflow">return</span> -1;
<a name="l00690"></a>00690 
<a name="l00691"></a>00691     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS InnerPubRepo (&quot;</span>
<a name="l00692"></a>00692         <span class="stringliteral">&quot;repo_id CHAR(37) PRIMARY KEY,&quot;</span>
<a name="l00693"></a>00693         <span class="stringliteral">&quot;permission CHAR(15))&quot;</span>
<a name="l00694"></a>00694         <span class="stringliteral">&quot;ENGINE=INNODB&quot;</span>;
<a name="l00695"></a>00695     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00696"></a>00696         <span class="keywordflow">return</span> -1;
<a name="l00697"></a>00697 
<a name="l00698"></a>00698     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoUserToken (&quot;</span>
<a name="l00699"></a>00699         <span class="stringliteral">&quot;repo_id CHAR(37), &quot;</span>
<a name="l00700"></a>00700         <span class="stringliteral">&quot;email VARCHAR(255), &quot;</span>
<a name="l00701"></a>00701         <span class="stringliteral">&quot;token CHAR(41), &quot;</span>
<a name="l00702"></a>00702         <span class="stringliteral">&quot;UNIQUE INDEX (repo_id, token), INDEX (email))&quot;</span>
<a name="l00703"></a>00703         <span class="stringliteral">&quot;ENGINE=INNODB&quot;</span>;
<a name="l00704"></a>00704     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00705"></a>00705         <span class="keywordflow">return</span> -1;
<a name="l00706"></a>00706 
<a name="l00707"></a>00707     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoTokenPeerInfo (&quot;</span>
<a name="l00708"></a>00708         <span class="stringliteral">&quot;token CHAR(41) PRIMARY KEY, &quot;</span>
<a name="l00709"></a>00709         <span class="stringliteral">&quot;peer_id CHAR(41), &quot;</span>
<a name="l00710"></a>00710         <span class="stringliteral">&quot;peer_ip VARCHAR(41), &quot;</span>
<a name="l00711"></a>00711         <span class="stringliteral">&quot;peer_name VARCHAR(255), &quot;</span>
<a name="l00712"></a>00712         <span class="stringliteral">&quot;sync_time BIGINT)&quot;</span>;
<a name="l00713"></a>00713     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00714"></a>00714         <span class="keywordflow">return</span> -1;
<a name="l00715"></a>00715 
<a name="l00716"></a>00716     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoHead (&quot;</span>
<a name="l00717"></a>00717         <span class="stringliteral">&quot;repo_id CHAR(37) PRIMARY KEY, branch_name VARCHAR(10))&quot;</span>
<a name="l00718"></a>00718         <span class="stringliteral">&quot;ENGINE=INNODB&quot;</span>;
<a name="l00719"></a>00719     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00720"></a>00720         <span class="keywordflow">return</span> -1;
<a name="l00721"></a>00721 
<a name="l00722"></a>00722     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoSize (&quot;</span>
<a name="l00723"></a>00723         <span class="stringliteral">&quot;repo_id CHAR(37) PRIMARY KEY,&quot;</span>
<a name="l00724"></a>00724         <span class="stringliteral">&quot;size BIGINT UNSIGNED,&quot;</span>
<a name="l00725"></a>00725         <span class="stringliteral">&quot;head_id CHAR(41))&quot;</span>
<a name="l00726"></a>00726         <span class="stringliteral">&quot;ENGINE=INNODB&quot;</span>;
<a name="l00727"></a>00727     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00728"></a>00728         <span class="keywordflow">return</span> -1;
<a name="l00729"></a>00729 
<a name="l00730"></a>00730     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoHistoryLimit (&quot;</span>
<a name="l00731"></a>00731         <span class="stringliteral">&quot;repo_id CHAR(37) PRIMARY KEY, days INTEGER)&quot;</span>
<a name="l00732"></a>00732         <span class="stringliteral">&quot;ENGINE=INNODB&quot;</span>;
<a name="l00733"></a>00733     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00734"></a>00734         <span class="keywordflow">return</span> -1;
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoValidSince (&quot;</span>
<a name="l00737"></a>00737         <span class="stringliteral">&quot;repo_id CHAR(37) PRIMARY KEY, timestamp BIGINT)&quot;</span>
<a name="l00738"></a>00738         <span class="stringliteral">&quot;ENGINE=INNODB&quot;</span>;
<a name="l00739"></a>00739     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00740"></a>00740         <span class="keywordflow">return</span> -1;
<a name="l00741"></a>00741 
<a name="l00742"></a>00742     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS WebAP (repo_id CHAR(37) PRIMARY KEY, &quot;</span>
<a name="l00743"></a>00743         <span class="stringliteral">&quot;access_property CHAR(10))&quot;</span>
<a name="l00744"></a>00744         <span class="stringliteral">&quot;ENGINE=INNODB&quot;</span>;
<a name="l00745"></a>00745     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00746"></a>00746         <span class="keywordflow">return</span> -1;
<a name="l00747"></a>00747 
<a name="l00748"></a>00748     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS VirtualRepo (repo_id CHAR(36) PRIMARY KEY,&quot;</span>
<a name="l00749"></a>00749         <span class="stringliteral">&quot;origin_repo CHAR(36), path TEXT, base_commit CHAR(40), INDEX(origin_repo))&quot;</span>
<a name="l00750"></a>00750         <span class="stringliteral">&quot;ENGINE=INNODB&quot;</span>;
<a name="l00751"></a>00751     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00752"></a>00752         <span class="keywordflow">return</span> -1;
<a name="l00753"></a>00753 
<a name="l00754"></a>00754     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS GarbageRepos (repo_id CHAR(36) PRIMARY KEY)&quot;</span>;
<a name="l00755"></a>00755     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00756"></a>00756         <span class="keywordflow">return</span> -1;
<a name="l00757"></a>00757 
<a name="l00758"></a>00758     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoTrash (repo_id CHAR(36) PRIMARY KEY,&quot;</span>
<a name="l00759"></a>00759         <span class="stringliteral">&quot;repo_name VARCHAR(255), head_id CHAR(40), owner_id VARCHAR(255),&quot;</span>
<a name="l00760"></a>00760         <span class="stringliteral">&quot;size bigint(20), org_id INTEGER, INDEX(owner_id), INDEX(org_id))ENGINE=INNODB&quot;</span>;
<a name="l00761"></a>00761     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00762"></a>00762         <span class="keywordflow">return</span> -1;
<a name="l00763"></a>00763 
<a name="l00764"></a>00764     <span class="keywordflow">return</span> 0;
<a name="l00765"></a>00765 }
<a name="l00766"></a>00766 
<a name="l00767"></a>00767 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00768"></a>00768 create_tables_sqlite (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr)
<a name="l00769"></a>00769 {
<a name="l00770"></a>00770     <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;
<a name="l00771"></a>00771     <span class="keywordtype">char</span> *sql;
<a name="l00772"></a>00772 
<a name="l00773"></a>00773     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS Repo (repo_id CHAR(37) PRIMARY KEY)&quot;</span>;
<a name="l00774"></a>00774     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00775"></a>00775         <span class="keywordflow">return</span> -1;
<a name="l00776"></a>00776 
<a name="l00777"></a>00777     <span class="comment">/* Owner */</span>
<a name="l00778"></a>00778 
<a name="l00779"></a>00779     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoOwner (&quot;</span>
<a name="l00780"></a>00780         <span class="stringliteral">&quot;repo_id CHAR(37) PRIMARY KEY, &quot;</span>
<a name="l00781"></a>00781         <span class="stringliteral">&quot;owner_id TEXT)&quot;</span>;
<a name="l00782"></a>00782     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00783"></a>00783         <span class="keywordflow">return</span> -1;
<a name="l00784"></a>00784     sql = <span class="stringliteral">&quot;CREATE INDEX IF NOT EXISTS OwnerIndex ON RepoOwner (owner_id)&quot;</span>;
<a name="l00785"></a>00785     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00786"></a>00786         <span class="keywordflow">return</span> -1;
<a name="l00787"></a>00787 
<a name="l00788"></a>00788     <span class="comment">/* Group repo */</span>
<a name="l00789"></a>00789 
<a name="l00790"></a>00790     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoGroup (repo_id CHAR(37), &quot;</span>
<a name="l00791"></a>00791         <span class="stringliteral">&quot;group_id INTEGER, user_name TEXT, permission CHAR(15))&quot;</span>;
<a name="l00792"></a>00792     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00793"></a>00793         <span class="keywordflow">return</span> -1;
<a name="l00794"></a>00794 
<a name="l00795"></a>00795     sql = <span class="stringliteral">&quot;CREATE UNIQUE INDEX IF NOT EXISTS groupid_repoid_indx on &quot;</span>
<a name="l00796"></a>00796         <span class="stringliteral">&quot;RepoGroup (group_id, repo_id)&quot;</span>;
<a name="l00797"></a>00797     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00798"></a>00798         <span class="keywordflow">return</span> -1;
<a name="l00799"></a>00799 
<a name="l00800"></a>00800     sql = <span class="stringliteral">&quot;CREATE INDEX IF NOT EXISTS repogroup_repoid_index on &quot;</span>
<a name="l00801"></a>00801         <span class="stringliteral">&quot;RepoGroup (repo_id)&quot;</span>;
<a name="l00802"></a>00802     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00803"></a>00803         <span class="keywordflow">return</span> -1;
<a name="l00804"></a>00804 
<a name="l00805"></a>00805     sql = <span class="stringliteral">&quot;CREATE INDEX IF NOT EXISTS repogroup_username_indx on &quot;</span>
<a name="l00806"></a>00806         <span class="stringliteral">&quot;RepoGroup (user_name)&quot;</span>;
<a name="l00807"></a>00807     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00808"></a>00808         <span class="keywordflow">return</span> -1;
<a name="l00809"></a>00809 
<a name="l00810"></a>00810     <span class="comment">/* Public repo */</span>
<a name="l00811"></a>00811 
<a name="l00812"></a>00812     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS InnerPubRepo (&quot;</span>
<a name="l00813"></a>00813         <span class="stringliteral">&quot;repo_id CHAR(37) PRIMARY KEY,&quot;</span>
<a name="l00814"></a>00814         <span class="stringliteral">&quot;permission CHAR(15))&quot;</span>;
<a name="l00815"></a>00815     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00816"></a>00816         <span class="keywordflow">return</span> -1;
<a name="l00817"></a>00817 
<a name="l00818"></a>00818     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoUserToken (&quot;</span>
<a name="l00819"></a>00819         <span class="stringliteral">&quot;repo_id CHAR(37), &quot;</span>
<a name="l00820"></a>00820         <span class="stringliteral">&quot;email VARCHAR(255), &quot;</span>
<a name="l00821"></a>00821         <span class="stringliteral">&quot;token CHAR(41))&quot;</span>;
<a name="l00822"></a>00822     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00823"></a>00823         <span class="keywordflow">return</span> -1;
<a name="l00824"></a>00824 
<a name="l00825"></a>00825     sql = <span class="stringliteral">&quot;CREATE UNIQUE INDEX IF NOT EXISTS repo_token_indx on &quot;</span>
<a name="l00826"></a>00826         <span class="stringliteral">&quot;RepoUserToken (repo_id, token)&quot;</span>;
<a name="l00827"></a>00827     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00828"></a>00828         <span class="keywordflow">return</span> -1;
<a name="l00829"></a>00829 
<a name="l00830"></a>00830     sql = <span class="stringliteral">&quot;CREATE INDEX IF NOT EXISTS repo_token_email_indx on &quot;</span>
<a name="l00831"></a>00831         <span class="stringliteral">&quot;RepoUserToken (email)&quot;</span>;
<a name="l00832"></a>00832     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00833"></a>00833         <span class="keywordflow">return</span> -1;
<a name="l00834"></a>00834 
<a name="l00835"></a>00835     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoTokenPeerInfo (&quot;</span>
<a name="l00836"></a>00836         <span class="stringliteral">&quot;token CHAR(41) PRIMARY KEY, &quot;</span>
<a name="l00837"></a>00837         <span class="stringliteral">&quot;peer_id CHAR(41), &quot;</span>
<a name="l00838"></a>00838         <span class="stringliteral">&quot;peer_ip VARCHAR(41), &quot;</span>
<a name="l00839"></a>00839         <span class="stringliteral">&quot;peer_name VARCHAR(255), &quot;</span>
<a name="l00840"></a>00840         <span class="stringliteral">&quot;sync_time BIGINT)&quot;</span>;
<a name="l00841"></a>00841     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00842"></a>00842         <span class="keywordflow">return</span> -1;
<a name="l00843"></a>00843 
<a name="l00844"></a>00844     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoHead (&quot;</span>
<a name="l00845"></a>00845         <span class="stringliteral">&quot;repo_id CHAR(37) PRIMARY KEY, branch_name VARCHAR(10))&quot;</span>;
<a name="l00846"></a>00846     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00847"></a>00847         <span class="keywordflow">return</span> -1;
<a name="l00848"></a>00848 
<a name="l00849"></a>00849     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoSize (&quot;</span>
<a name="l00850"></a>00850         <span class="stringliteral">&quot;repo_id CHAR(37) PRIMARY KEY,&quot;</span>
<a name="l00851"></a>00851         <span class="stringliteral">&quot;size BIGINT UNSIGNED,&quot;</span>
<a name="l00852"></a>00852         <span class="stringliteral">&quot;head_id CHAR(41))&quot;</span>;
<a name="l00853"></a>00853     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00854"></a>00854         <span class="keywordflow">return</span> -1;
<a name="l00855"></a>00855 
<a name="l00856"></a>00856     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoHistoryLimit (&quot;</span>
<a name="l00857"></a>00857         <span class="stringliteral">&quot;repo_id CHAR(37) PRIMARY KEY, days INTEGER)&quot;</span>;
<a name="l00858"></a>00858     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00859"></a>00859         <span class="keywordflow">return</span> -1;
<a name="l00860"></a>00860 
<a name="l00861"></a>00861     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoValidSince (&quot;</span>
<a name="l00862"></a>00862         <span class="stringliteral">&quot;repo_id CHAR(37) PRIMARY KEY, timestamp BIGINT)&quot;</span>;
<a name="l00863"></a>00863     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00864"></a>00864         <span class="keywordflow">return</span> -1;
<a name="l00865"></a>00865 
<a name="l00866"></a>00866     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS WebAP (repo_id CHAR(37) PRIMARY KEY, &quot;</span>
<a name="l00867"></a>00867         <span class="stringliteral">&quot;access_property CHAR(10))&quot;</span>;
<a name="l00868"></a>00868     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00869"></a>00869         <span class="keywordflow">return</span> -1;
<a name="l00870"></a>00870 
<a name="l00871"></a>00871     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS VirtualRepo (repo_id CHAR(36) PRIMARY KEY,&quot;</span>
<a name="l00872"></a>00872         <span class="stringliteral">&quot;origin_repo CHAR(36), path TEXT, base_commit CHAR(40))&quot;</span>;
<a name="l00873"></a>00873     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00874"></a>00874         <span class="keywordflow">return</span> -1;
<a name="l00875"></a>00875 
<a name="l00876"></a>00876     sql = <span class="stringliteral">&quot;CREATE INDEX IF NOT EXISTS virtualrepo_origin_repo_idx &quot;</span>
<a name="l00877"></a>00877         <span class="stringliteral">&quot;ON VirtualRepo (origin_repo)&quot;</span>;
<a name="l00878"></a>00878     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00879"></a>00879         <span class="keywordflow">return</span> -1;
<a name="l00880"></a>00880 
<a name="l00881"></a>00881     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS GarbageRepos (repo_id CHAR(36) PRIMARY KEY)&quot;</span>;
<a name="l00882"></a>00882     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00883"></a>00883         <span class="keywordflow">return</span> -1;
<a name="l00884"></a>00884 
<a name="l00885"></a>00885     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoTrash (repo_id CHAR(36) PRIMARY KEY,&quot;</span>
<a name="l00886"></a>00886         <span class="stringliteral">&quot;repo_name VARCHAR(255), head_id CHAR(40), owner_id VARCHAR(255), size BIGINT UNSIGNED,&quot;</span>
<a name="l00887"></a>00887         <span class="stringliteral">&quot;org_id INTEGER)&quot;</span>;
<a name="l00888"></a>00888     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00889"></a>00889         <span class="keywordflow">return</span> -1;
<a name="l00890"></a>00890 
<a name="l00891"></a>00891     sql = <span class="stringliteral">&quot;CREATE INDEX IF NOT EXISTS repotrash_owner_id_idx ON RepoTrash(owner_id)&quot;</span>;
<a name="l00892"></a>00892     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00893"></a>00893         <span class="keywordflow">return</span> -1;
<a name="l00894"></a>00894 
<a name="l00895"></a>00895     sql = <span class="stringliteral">&quot;CREATE INDEX IF NOT EXISTS repotrash_org_id_idx ON RepoTrash(org_id)&quot;</span>;
<a name="l00896"></a>00896     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00897"></a>00897         <span class="keywordflow">return</span> -1;
<a name="l00898"></a>00898 
<a name="l00899"></a>00899     <span class="keywordflow">return</span> 0;
<a name="l00900"></a>00900 }
<a name="l00901"></a>00901 
<a name="l00902"></a>00902 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00903"></a>00903 create_tables_pgsql (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr)
<a name="l00904"></a>00904 {
<a name="l00905"></a>00905     <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;
<a name="l00906"></a>00906     <span class="keywordtype">char</span> *sql;
<a name="l00907"></a>00907 
<a name="l00908"></a>00908     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS Repo (repo_id CHAR(36) PRIMARY KEY)&quot;</span>;
<a name="l00909"></a>00909     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00910"></a>00910         <span class="keywordflow">return</span> -1;
<a name="l00911"></a>00911 
<a name="l00912"></a>00912     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoOwner (&quot;</span>
<a name="l00913"></a>00913         <span class="stringliteral">&quot;repo_id CHAR(36) PRIMARY KEY, &quot;</span>
<a name="l00914"></a>00914         <span class="stringliteral">&quot;owner_id VARCHAR(255))&quot;</span>;
<a name="l00915"></a>00915     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00916"></a>00916         <span class="keywordflow">return</span> -1;
<a name="l00917"></a>00917 
<a name="l00918"></a>00918     <span class="keywordflow">if</span> (!<a class="code" href="seaf-db_8c.html#aea6c6bba56350bc53e898fb4f859bc4e">pgsql_index_exists</a> (db, <span class="stringliteral">&quot;repoowner_owner_idx&quot;</span>)) {
<a name="l00919"></a>00919         sql = <span class="stringliteral">&quot;CREATE INDEX repoowner_owner_idx ON RepoOwner (owner_id)&quot;</span>;
<a name="l00920"></a>00920         <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00921"></a>00921             <span class="keywordflow">return</span> -1;
<a name="l00922"></a>00922     }
<a name="l00923"></a>00923 
<a name="l00924"></a>00924     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoGroup (repo_id CHAR(36), &quot;</span>
<a name="l00925"></a>00925         <span class="stringliteral">&quot;group_id INTEGER, user_name VARCHAR(255), permission VARCHAR(15), &quot;</span>
<a name="l00926"></a>00926         <span class="stringliteral">&quot;UNIQUE (group_id, repo_id))&quot;</span>;
<a name="l00927"></a>00927     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00928"></a>00928         <span class="keywordflow">return</span> -1;
<a name="l00929"></a>00929 
<a name="l00930"></a>00930     <span class="keywordflow">if</span> (!<a class="code" href="seaf-db_8c.html#aea6c6bba56350bc53e898fb4f859bc4e">pgsql_index_exists</a> (db, <span class="stringliteral">&quot;repogroup_repoid_idx&quot;</span>)) {
<a name="l00931"></a>00931         sql = <span class="stringliteral">&quot;CREATE INDEX repogroup_repoid_idx ON RepoGroup (repo_id)&quot;</span>;
<a name="l00932"></a>00932         <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00933"></a>00933             <span class="keywordflow">return</span> -1;
<a name="l00934"></a>00934     }
<a name="l00935"></a>00935 
<a name="l00936"></a>00936     <span class="keywordflow">if</span> (!<a class="code" href="seaf-db_8c.html#aea6c6bba56350bc53e898fb4f859bc4e">pgsql_index_exists</a> (db, <span class="stringliteral">&quot;repogroup_username_idx&quot;</span>)) {
<a name="l00937"></a>00937         sql = <span class="stringliteral">&quot;CREATE INDEX repogroup_username_idx ON RepoGroup (user_name)&quot;</span>;
<a name="l00938"></a>00938         <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00939"></a>00939             <span class="keywordflow">return</span> -1;
<a name="l00940"></a>00940     }
<a name="l00941"></a>00941 
<a name="l00942"></a>00942     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS InnerPubRepo (&quot;</span>
<a name="l00943"></a>00943         <span class="stringliteral">&quot;repo_id CHAR(36) PRIMARY KEY,&quot;</span>
<a name="l00944"></a>00944         <span class="stringliteral">&quot;permission VARCHAR(15))&quot;</span>;
<a name="l00945"></a>00945     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00946"></a>00946         <span class="keywordflow">return</span> -1;
<a name="l00947"></a>00947 
<a name="l00948"></a>00948     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoUserToken (&quot;</span>
<a name="l00949"></a>00949         <span class="stringliteral">&quot;repo_id CHAR(36), &quot;</span>
<a name="l00950"></a>00950         <span class="stringliteral">&quot;email VARCHAR(255), &quot;</span>
<a name="l00951"></a>00951         <span class="stringliteral">&quot;token CHAR(40), &quot;</span>
<a name="l00952"></a>00952         <span class="stringliteral">&quot;UNIQUE (repo_id, token))&quot;</span>;
<a name="l00953"></a>00953     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00954"></a>00954         <span class="keywordflow">return</span> -1;
<a name="l00955"></a>00955 
<a name="l00956"></a>00956     <span class="keywordflow">if</span> (!<a class="code" href="seaf-db_8c.html#aea6c6bba56350bc53e898fb4f859bc4e">pgsql_index_exists</a> (db, <span class="stringliteral">&quot;repousertoken_email_idx&quot;</span>)) {
<a name="l00957"></a>00957         sql = <span class="stringliteral">&quot;CREATE INDEX repousertoken_email_idx ON RepoUserToken (email)&quot;</span>;
<a name="l00958"></a>00958         <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00959"></a>00959             <span class="keywordflow">return</span> -1;
<a name="l00960"></a>00960     }
<a name="l00961"></a>00961 
<a name="l00962"></a>00962     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoTokenPeerInfo (&quot;</span>
<a name="l00963"></a>00963         <span class="stringliteral">&quot;token CHAR(40) PRIMARY KEY, &quot;</span>
<a name="l00964"></a>00964         <span class="stringliteral">&quot;peer_id CHAR(40), &quot;</span>
<a name="l00965"></a>00965         <span class="stringliteral">&quot;peer_ip VARCHAR(40), &quot;</span>
<a name="l00966"></a>00966         <span class="stringliteral">&quot;peer_name VARCHAR(255), &quot;</span>
<a name="l00967"></a>00967         <span class="stringliteral">&quot;sync_time BIGINT)&quot;</span>;
<a name="l00968"></a>00968     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00969"></a>00969         <span class="keywordflow">return</span> -1;
<a name="l00970"></a>00970 
<a name="l00971"></a>00971     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoHead (&quot;</span>
<a name="l00972"></a>00972         <span class="stringliteral">&quot;repo_id CHAR(36) PRIMARY KEY, branch_name VARCHAR(10))&quot;</span>;
<a name="l00973"></a>00973     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00974"></a>00974         <span class="keywordflow">return</span> -1;
<a name="l00975"></a>00975 
<a name="l00976"></a>00976     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoSize (&quot;</span>
<a name="l00977"></a>00977         <span class="stringliteral">&quot;repo_id CHAR(36) PRIMARY KEY,&quot;</span>
<a name="l00978"></a>00978         <span class="stringliteral">&quot;size BIGINT,&quot;</span>
<a name="l00979"></a>00979         <span class="stringliteral">&quot;head_id CHAR(40))&quot;</span>;
<a name="l00980"></a>00980     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00981"></a>00981         <span class="keywordflow">return</span> -1;
<a name="l00982"></a>00982 
<a name="l00983"></a>00983     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoHistoryLimit (&quot;</span>
<a name="l00984"></a>00984         <span class="stringliteral">&quot;repo_id CHAR(36) PRIMARY KEY, days INTEGER)&quot;</span>;
<a name="l00985"></a>00985     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00986"></a>00986         <span class="keywordflow">return</span> -1;
<a name="l00987"></a>00987 
<a name="l00988"></a>00988     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoValidSince (&quot;</span>
<a name="l00989"></a>00989         <span class="stringliteral">&quot;repo_id CHAR(36) PRIMARY KEY, timestamp BIGINT)&quot;</span>;
<a name="l00990"></a>00990     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00991"></a>00991         <span class="keywordflow">return</span> -1;
<a name="l00992"></a>00992 
<a name="l00993"></a>00993     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS WebAP (repo_id CHAR(36) PRIMARY KEY, &quot;</span>
<a name="l00994"></a>00994         <span class="stringliteral">&quot;access_property VARCHAR(10))&quot;</span>;
<a name="l00995"></a>00995     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l00996"></a>00996         <span class="keywordflow">return</span> -1;
<a name="l00997"></a>00997 
<a name="l00998"></a>00998     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS VirtualRepo (repo_id CHAR(36) PRIMARY KEY,&quot;</span>
<a name="l00999"></a>00999         <span class="stringliteral">&quot;origin_repo CHAR(36), path TEXT, base_commit CHAR(40))&quot;</span>;
<a name="l01000"></a>01000     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l01001"></a>01001         <span class="keywordflow">return</span> -1;
<a name="l01002"></a>01002 
<a name="l01003"></a>01003     <span class="keywordflow">if</span> (!<a class="code" href="seaf-db_8c.html#aea6c6bba56350bc53e898fb4f859bc4e">pgsql_index_exists</a> (db, <span class="stringliteral">&quot;virtualrepo_origin_repo_idx&quot;</span>)) {
<a name="l01004"></a>01004         sql = <span class="stringliteral">&quot;CREATE INDEX virtualrepo_origin_repo_idx ON VirtualRepo (origin_repo)&quot;</span>;
<a name="l01005"></a>01005         <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l01006"></a>01006             <span class="keywordflow">return</span> -1;
<a name="l01007"></a>01007     }
<a name="l01008"></a>01008 
<a name="l01009"></a>01009     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS GarbageRepos (repo_id CHAR(36) PRIMARY KEY)&quot;</span>;
<a name="l01010"></a>01010     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l01011"></a>01011         <span class="keywordflow">return</span> -1;
<a name="l01012"></a>01012 
<a name="l01013"></a>01013     sql = <span class="stringliteral">&quot;CREATE TABLE IF NOT EXISTS RepoTrash (repo_id CHAR(36) PRIMARY KEY,&quot;</span>
<a name="l01014"></a>01014         <span class="stringliteral">&quot;repo_name VARCHAR(255), head_id CHAR(40), owner_id VARCHAR(255), size bigint,&quot;</span>
<a name="l01015"></a>01015         <span class="stringliteral">&quot;org_id INTEGER, INDEX(owner_id), INDEX(org_id))&quot;</span>;
<a name="l01016"></a>01016     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l01017"></a>01017         <span class="keywordflow">return</span> -1;
<a name="l01018"></a>01018 
<a name="l01019"></a>01019     <span class="keywordflow">return</span> 0;
<a name="l01020"></a>01020 }
<a name="l01021"></a>01021 
<a name="l01022"></a>01022 <span class="keyword">static</span> <span class="keywordtype">int</span> 
<a name="l01023"></a>01023 create_db_tables_if_not_exist (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr)
<a name="l01024"></a>01024 {
<a name="l01025"></a>01025     <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;
<a name="l01026"></a>01026     <span class="keywordtype">int</span> db_type = <a class="code" href="seaf-db_8c.html#ae183a9c45ec082962bdd361491b0a8cb">seaf_db_type</a> (db);
<a name="l01027"></a>01027 
<a name="l01028"></a>01028     <span class="keywordflow">if</span> (db_type == <a class="code" href="seaf-db_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da0c0dc9e09cf6ebc3580aa45e4f45119f">SEAF_DB_TYPE_MYSQL</a>)
<a name="l01029"></a>01029         <span class="keywordflow">return</span> create_tables_mysql (mgr);
<a name="l01030"></a>01030     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (db_type == <a class="code" href="seaf-db_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2dab22fc00463491c2d6d4afb607a5e716f">SEAF_DB_TYPE_SQLITE</a>)
<a name="l01031"></a>01031         <span class="keywordflow">return</span> create_tables_sqlite (mgr);
<a name="l01032"></a>01032     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (db_type == <a class="code" href="seaf-db_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da62ce2e8a052406ede3fcf39ec407ccf8">SEAF_DB_TYPE_PGSQL</a>)
<a name="l01033"></a>01033         <span class="keywordflow">return</span> create_tables_pgsql (mgr);
<a name="l01034"></a>01034 
<a name="l01035"></a>01035     g_return_val_if_reached (-1);
<a name="l01036"></a>01036 }
<a name="l01037"></a>01037 
<a name="l01038"></a>01038 <span class="comment">/*</span>
<a name="l01039"></a>01039 <span class="comment"> * Repo properties functions.</span>
<a name="l01040"></a>01040 <span class="comment"> */</span>
<a name="l01041"></a>01041 
<a name="l01042"></a>01042 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">char</span> *
<a name="l01043"></a>01043 generate_repo_token ()
<a name="l01044"></a>01044 {
<a name="l01045"></a>01045     <span class="keywordtype">char</span> *uuid = <a class="code" href="seafile_2lib_2utils_8c.html#af64020f0be33abde6a2a076ff9808809">gen_uuid</a> ();
<a name="l01046"></a>01046     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="index_8h.html#a96e76167c968d38441e90ee0488ee4aa">sha1</a>[20];
<a name="l01047"></a>01047     <span class="keywordtype">char</span> token[41];
<a name="l01048"></a>01048     SHA_CTX s;
<a name="l01049"></a>01049 
<a name="l01050"></a>01050     SHA1_Init (&amp;s);
<a name="l01051"></a>01051     SHA1_Update (&amp;s, uuid, strlen(uuid));
<a name="l01052"></a>01052     SHA1_Final (sha1, &amp;s);
<a name="l01053"></a>01053 
<a name="l01054"></a>01054     <a class="code" href="seafile_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a> (sha1, token, 20);
<a name="l01055"></a>01055 
<a name="l01056"></a>01056     g_free (uuid);
<a name="l01057"></a>01057 
<a name="l01058"></a>01058     <span class="keywordflow">return</span> g_strdup (token);
<a name="l01059"></a>01059 }
<a name="l01060"></a>01060 
<a name="l01061"></a>01061 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01062"></a>01062 add_repo_token (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01063"></a>01063                 <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l01064"></a>01064                 <span class="keyword">const</span> <span class="keywordtype">char</span> *email,
<a name="l01065"></a>01065                 <span class="keyword">const</span> <span class="keywordtype">char</span> *token,
<a name="l01066"></a>01066                 GError **error)
<a name="l01067"></a>01067 {
<a name="l01068"></a>01068     <span class="keywordtype">int</span> rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l01069"></a>01069                                       <span class="stringliteral">&quot;INSERT INTO RepoUserToken VALUES (?, ?, ?)&quot;</span>,
<a name="l01070"></a>01070                                       3, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;string&quot;</span>, email,
<a name="l01071"></a>01071                                       <span class="stringliteral">&quot;string&quot;</span>, token);
<a name="l01072"></a>01072 
<a name="l01073"></a>01073     <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01074"></a>01074         seaf_warning (<span class="stringliteral">&quot;failed to add repo token. repo = %s, email = %s\n&quot;</span>,
<a name="l01075"></a>01075                       repo_id, email);
<a name="l01076"></a>01076         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
<a name="l01077"></a>01077         <span class="keywordflow">return</span> -1;
<a name="l01078"></a>01078     }
<a name="l01079"></a>01079 
<a name="l01080"></a>01080     <span class="keywordflow">return</span> 0;
<a name="l01081"></a>01081 }
<a name="l01082"></a>01082 
<a name="l01083"></a>01083 <span class="keywordtype">char</span> *
<a name="l01084"></a><a class="code" href="server_2repo-mgr_8h.html#a7899787e6f32bc1f2c578c740b2d716e">01084</a> <a class="code" href="server_2repo-mgr_8c.html#a7899787e6f32bc1f2c578c740b2d716e">seaf_repo_manager_generate_repo_token</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01085"></a>01085                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l01086"></a>01086                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *email,
<a name="l01087"></a>01087                                        GError **error)
<a name="l01088"></a>01088 {
<a name="l01089"></a>01089     <span class="keywordtype">char</span> *token = generate_repo_token ();
<a name="l01090"></a>01090     <span class="keywordflow">if</span> (add_repo_token (mgr, repo_id, email, token, error) &lt; 0) {
<a name="l01091"></a>01091         g_free (token);        
<a name="l01092"></a>01092         <span class="keywordflow">return</span> NULL;
<a name="l01093"></a>01093     }
<a name="l01094"></a>01094 
<a name="l01095"></a>01095     <span class="keywordflow">return</span> token;
<a name="l01096"></a>01096 }
<a name="l01097"></a>01097 
<a name="l01098"></a>01098 <span class="keywordtype">int</span>
<a name="l01099"></a><a class="code" href="server_2repo-mgr_8h.html#a673a63eb50ecebd6c689aaadaea5c5e5">01099</a> <a class="code" href="server_2repo-mgr_8c.html#a673a63eb50ecebd6c689aaadaea5c5e5">seaf_repo_manager_add_token_peer_info</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01100"></a>01100                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *token,
<a name="l01101"></a>01101                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id,
<a name="l01102"></a>01102                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_ip,
<a name="l01103"></a>01103                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_name,
<a name="l01104"></a>01104                                        gint64 sync_time)
<a name="l01105"></a>01105 {
<a name="l01106"></a>01106     <span class="keywordtype">int</span> ret = 0;
<a name="l01107"></a>01107 
<a name="l01108"></a>01108     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l01109"></a>01109                                  <span class="stringliteral">&quot;INSERT INTO RepoTokenPeerInfo VALUES (&quot;</span>
<a name="l01110"></a>01110                                  <span class="stringliteral">&quot;?, ?, ?, ?, ?)&quot;</span>,
<a name="l01111"></a>01111                                  5, <span class="stringliteral">&quot;string&quot;</span>, token,
<a name="l01112"></a>01112                                  <span class="stringliteral">&quot;string&quot;</span>, peer_id,
<a name="l01113"></a>01113                                  <span class="stringliteral">&quot;string&quot;</span>, peer_ip,
<a name="l01114"></a>01114                                  <span class="stringliteral">&quot;string&quot;</span>, peer_name,
<a name="l01115"></a>01115                                  <span class="stringliteral">&quot;int64&quot;</span>, sync_time) &lt; 0)
<a name="l01116"></a>01116         ret = -1;
<a name="l01117"></a>01117 
<a name="l01118"></a>01118     <span class="keywordflow">return</span> ret;
<a name="l01119"></a>01119 }
<a name="l01120"></a>01120 
<a name="l01121"></a>01121 <span class="keywordtype">int</span>
<a name="l01122"></a><a class="code" href="server_2repo-mgr_8h.html#a33b75eede501da0a4c6100b30b9facf0">01122</a> <a class="code" href="server_2repo-mgr_8c.html#a33b75eede501da0a4c6100b30b9facf0">seaf_repo_manager_update_token_peer_info</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01123"></a>01123                                           <span class="keyword">const</span> <span class="keywordtype">char</span> *token,
<a name="l01124"></a>01124                                           <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_ip,
<a name="l01125"></a>01125                                           gint64 sync_time)
<a name="l01126"></a>01126 {
<a name="l01127"></a>01127     <span class="keywordtype">int</span> ret = 0;
<a name="l01128"></a>01128 
<a name="l01129"></a>01129     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l01130"></a>01130                                  <span class="stringliteral">&quot;UPDATE RepoTokenPeerInfo SET &quot;</span>
<a name="l01131"></a>01131                                  <span class="stringliteral">&quot;peer_ip=?, sync_time=? WHERE token=?&quot;</span>,
<a name="l01132"></a>01132                                  3, <span class="stringliteral">&quot;string&quot;</span>, peer_ip,
<a name="l01133"></a>01133                                  <span class="stringliteral">&quot;int64&quot;</span>, sync_time,
<a name="l01134"></a>01134                                  <span class="stringliteral">&quot;string&quot;</span>, token) &lt; 0)
<a name="l01135"></a>01135         ret = -1;
<a name="l01136"></a>01136 
<a name="l01137"></a>01137     <span class="keywordflow">return</span> ret;
<a name="l01138"></a>01138 }
<a name="l01139"></a>01139 
<a name="l01140"></a>01140 gboolean
<a name="l01141"></a><a class="code" href="server_2repo-mgr_8h.html#aa40635ee3473d593c5edc1a9e9976cd7">01141</a> <a class="code" href="server_2repo-mgr_8c.html#aa40635ee3473d593c5edc1a9e9976cd7">seaf_repo_manager_token_peer_info_exists</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01142"></a>01142                                           <span class="keyword">const</span> <span class="keywordtype">char</span> *token)
<a name="l01143"></a>01143 {
<a name="l01144"></a>01144     gboolean db_error = FALSE;
<a name="l01145"></a>01145 
<a name="l01146"></a>01146     <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#af77a76302b3316a4d71e418de27843c4">seaf_db_statement_exists</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l01147"></a>01147                                      <span class="stringliteral">&quot;SELECT token FROM RepoTokenPeerInfo WHERE token=?&quot;</span>,
<a name="l01148"></a>01148                                      &amp;db_error, 1, <span class="stringliteral">&quot;string&quot;</span>, token);
<a name="l01149"></a>01149 }
<a name="l01150"></a>01150 
<a name="l01151"></a>01151 <span class="keywordtype">int</span>
<a name="l01152"></a><a class="code" href="server_2repo-mgr_8h.html#aab7412302b0f206f7717a29d86d80e0f">01152</a> <a class="code" href="server_2repo-mgr_8c.html#aab7412302b0f206f7717a29d86d80e0f">seaf_repo_manager_delete_token</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01153"></a>01153                                 <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l01154"></a>01154                                 <span class="keyword">const</span> <span class="keywordtype">char</span> *token,
<a name="l01155"></a>01155                                 <span class="keyword">const</span> <span class="keywordtype">char</span> *user,
<a name="l01156"></a>01156                                 GError **error)
<a name="l01157"></a>01157 {
<a name="l01158"></a>01158     <span class="keywordtype">char</span> *token_owner;
<a name="l01159"></a>01159 
<a name="l01160"></a>01160     token_owner = <a class="code" href="server_2repo-mgr_8c.html#a2413f0a10a33c5de4d82193c9c8b7f08">seaf_repo_manager_get_email_by_token</a> (mgr, repo_id, token);
<a name="l01161"></a>01161     <span class="keywordflow">if</span> (!token_owner || strcmp (user, token_owner) != 0) {
<a name="l01162"></a>01162         seaf_warning (<span class="stringliteral">&quot;Requesting user is %s, token owner is %s, &quot;</span>
<a name="l01163"></a>01163                       <span class="stringliteral">&quot;refuse to delete token %.10s.\n&quot;</span>, user, token_owner, token);
<a name="l01164"></a>01164         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;Permission denied&quot;</span>);
<a name="l01165"></a>01165         <span class="keywordflow">return</span> -1;
<a name="l01166"></a>01166     }
<a name="l01167"></a>01167 
<a name="l01168"></a>01168     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l01169"></a>01169                                  <span class="stringliteral">&quot;DELETE FROM RepoUserToken &quot;</span>
<a name="l01170"></a>01170                                  <span class="stringliteral">&quot;WHERE repo_id=? and token=?&quot;</span>,
<a name="l01171"></a>01171                                  2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;string&quot;</span>, token) &lt; 0) {
<a name="l01172"></a>01172         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
<a name="l01173"></a>01173         <span class="keywordflow">return</span> -1;
<a name="l01174"></a>01174     }
<a name="l01175"></a>01175 
<a name="l01176"></a>01176     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l01177"></a>01177                                  <span class="stringliteral">&quot;DELETE FROM RepoTokenPeerInfo WHERE token=?&quot;</span>,
<a name="l01178"></a>01178                                  1, <span class="stringliteral">&quot;string&quot;</span>, token) &lt; 0) {
<a name="l01179"></a>01179         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
<a name="l01180"></a>01180         <span class="keywordflow">return</span> -1;
<a name="l01181"></a>01181     }
<a name="l01182"></a>01182 
<a name="l01183"></a>01183     GList *tokens = NULL;
<a name="l01184"></a>01184     tokens = g_list_append (tokens, g_strdup(token));
<a name="l01185"></a>01185     <a class="code" href="http-server_8c.html#a4b50fa8bc6c458c1a5bdc640cc71b6cb">seaf_http_server_invalidate_tokens</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a0309f60018b54c38ec8d3275ee1d6666">http_server</a>, tokens);
<a name="l01186"></a>01186     g_list_free_full (tokens, (GDestroyNotify)g_free);
<a name="l01187"></a>01187 
<a name="l01188"></a>01188     <span class="keywordflow">return</span> 0;
<a name="l01189"></a>01189 }
<a name="l01190"></a>01190 
<a name="l01191"></a>01191 <span class="keyword">static</span> gboolean
<a name="l01192"></a>01192 collect_repo_token (<a class="code" href="structSeafDBRow.html">SeafDBRow</a> *row, <span class="keywordtype">void</span> *data)
<a name="l01193"></a>01193 {
<a name="l01194"></a>01194     GList **ret_list = data;
<a name="l01195"></a>01195     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id, *repo_owner, *email, *token;
<a name="l01196"></a>01196     <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id, *peer_ip, *peer_name;
<a name="l01197"></a>01197     gint64 sync_time;
<a name="l01198"></a>01198 
<a name="l01199"></a>01199     repo_id = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 0);
<a name="l01200"></a>01200     repo_owner = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 1);
<a name="l01201"></a>01201     email = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 2);
<a name="l01202"></a>01202     token = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 3);
<a name="l01203"></a>01203 
<a name="l01204"></a>01204     peer_id = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 4);
<a name="l01205"></a>01205     peer_ip = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 5);
<a name="l01206"></a>01206     peer_name = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 6);
<a name="l01207"></a>01207     sync_time = <a class="code" href="seaf-db_8c.html#ac9d9437b19d33c23ce45ec6b1f4d8a05">seaf_db_row_get_column_int64</a> (row, 7);
<a name="l01208"></a>01208 
<a name="l01209"></a>01209     <span class="keywordtype">char</span> *owner_l = g_ascii_strdown (repo_owner, -1);
<a name="l01210"></a>01210     <span class="keywordtype">char</span> *email_l = g_ascii_strdown (email, -1);
<a name="l01211"></a>01211 
<a name="l01212"></a>01212     <a class="code" href="struct__SeafileRepoTokenInfo.html">SeafileRepoTokenInfo</a> *repo_token_info;
<a name="l01213"></a>01213     repo_token_info = g_object_new (<a class="code" href="repo_8c.html#a4c542988b2a8d7fbb13e90719c73205c">SEAFILE_TYPE_REPO_TOKEN_INFO</a>,
<a name="l01214"></a>01214                                     <span class="stringliteral">&quot;repo_id&quot;</span>, repo_id,
<a name="l01215"></a>01215                                     <span class="stringliteral">&quot;repo_owner&quot;</span>, owner_l,
<a name="l01216"></a>01216                                     <span class="stringliteral">&quot;email&quot;</span>, email_l,
<a name="l01217"></a>01217                                     <span class="stringliteral">&quot;token&quot;</span>, token,
<a name="l01218"></a>01218                                     <span class="stringliteral">&quot;peer_id&quot;</span>, peer_id,
<a name="l01219"></a>01219                                     <span class="stringliteral">&quot;peer_ip&quot;</span>, peer_ip,
<a name="l01220"></a>01220                                     <span class="stringliteral">&quot;peer_name&quot;</span>, peer_name,
<a name="l01221"></a>01221                                     <span class="stringliteral">&quot;sync_time&quot;</span>, sync_time,
<a name="l01222"></a>01222                                     NULL);
<a name="l01223"></a>01223 
<a name="l01224"></a>01224     *ret_list = g_list_prepend (*ret_list, repo_token_info);
<a name="l01225"></a>01225     
<a name="l01226"></a>01226     <span class="keywordflow">return</span> TRUE;
<a name="l01227"></a>01227 }
<a name="l01228"></a>01228 
<a name="l01229"></a>01229 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01230"></a>01230 fill_in_token_info (GList *info_list)
<a name="l01231"></a>01231 {
<a name="l01232"></a>01232     GList *ptr;
<a name="l01233"></a>01233     <a class="code" href="struct__SeafileRepoTokenInfo.html">SeafileRepoTokenInfo</a> *info;
<a name="l01234"></a>01234     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l01235"></a>01235     <span class="keywordtype">char</span> *repo_name;
<a name="l01236"></a>01236 
<a name="l01237"></a>01237     <span class="keywordflow">for</span> (ptr = info_list; ptr; ptr = ptr-&gt;next) {
<a name="l01238"></a>01238         info = ptr-&gt;data;
<a name="l01239"></a>01239         repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l01240"></a>01240                                            <a class="code" href="repo_8c.html#afabcfde60047cf15b123e06189d9fea7">seafile_repo_token_info_get_repo_id</a>(info));
<a name="l01241"></a>01241         <span class="keywordflow">if</span> (repo)
<a name="l01242"></a>01242             repo_name = g_strdup(repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>);
<a name="l01243"></a>01243         <span class="keywordflow">else</span>
<a name="l01244"></a>01244             repo_name = g_strdup(<span class="stringliteral">&quot;Unknown&quot;</span>);
<a name="l01245"></a>01245         <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
<a name="l01246"></a>01246 
<a name="l01247"></a>01247         g_object_set (info, <span class="stringliteral">&quot;repo_name&quot;</span>, repo_name, NULL);
<a name="l01248"></a>01248         g_free (repo_name);
<a name="l01249"></a>01249     }
<a name="l01250"></a>01250 }
<a name="l01251"></a>01251 
<a name="l01252"></a>01252 GList *
<a name="l01253"></a><a class="code" href="server_2repo-mgr_8h.html#afab1803ccaa8885ec65db8075e87a40a">01253</a> <a class="code" href="server_2repo-mgr_8c.html#afab1803ccaa8885ec65db8075e87a40a">seaf_repo_manager_list_repo_tokens</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01254"></a>01254                                     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l01255"></a>01255                                     GError **error)
<a name="l01256"></a>01256 {
<a name="l01257"></a>01257     GList *ret_list = NULL;
<a name="l01258"></a>01258     <span class="keywordtype">char</span> *sql;
<a name="l01259"></a>01259     gboolean db_err = FALSE;
<a name="l01260"></a>01260 
<a name="l01261"></a>01261     <span class="keywordflow">if</span> (!repo_exists_in_db (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, repo_id, &amp;db_err)) {
<a name="l01262"></a>01262         <span class="keywordflow">if</span> (db_err) {
<a name="l01263"></a>01263             g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
<a name="l01264"></a>01264         }
<a name="l01265"></a>01265         <span class="keywordflow">return</span> NULL;
<a name="l01266"></a>01266     }
<a name="l01267"></a>01267 
<a name="l01268"></a>01268     sql = <span class="stringliteral">&quot;SELECT u.repo_id, o.owner_id, u.email, u.token, &quot;</span>
<a name="l01269"></a>01269         <span class="stringliteral">&quot;p.peer_id, p.peer_ip, p.peer_name, p.sync_time &quot;</span>
<a name="l01270"></a>01270         <span class="stringliteral">&quot;FROM RepoUserToken u LEFT JOIN RepoTokenPeerInfo p &quot;</span>
<a name="l01271"></a>01271         <span class="stringliteral">&quot;ON u.token = p.token, RepoOwner o &quot;</span>
<a name="l01272"></a>01272         <span class="stringliteral">&quot;WHERE u.repo_id = ? and o.repo_id = ? &quot;</span>;
<a name="l01273"></a>01273 
<a name="l01274"></a>01274     <span class="keywordtype">int</span> n_row = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
<a name="l01275"></a>01275                                               collect_repo_token, &amp;ret_list,
<a name="l01276"></a>01276                                               2, <span class="stringliteral">&quot;string&quot;</span>, repo_id,
<a name="l01277"></a>01277                                               <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l01278"></a>01278     <span class="keywordflow">if</span> (n_row &lt; 0) {
<a name="l01279"></a>01279         seaf_warning (<span class="stringliteral">&quot;DB error when get token info for repo %.10s.\n&quot;</span>,
<a name="l01280"></a>01280                       repo_id);
<a name="l01281"></a>01281         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
<a name="l01282"></a>01282     }
<a name="l01283"></a>01283 
<a name="l01284"></a>01284     fill_in_token_info (ret_list);
<a name="l01285"></a>01285 
<a name="l01286"></a>01286     <span class="keywordflow">return</span> g_list_reverse(ret_list);
<a name="l01287"></a>01287 }
<a name="l01288"></a>01288 
<a name="l01289"></a>01289 GList *
<a name="l01290"></a><a class="code" href="server_2repo-mgr_8h.html#a754dc377da1101690257dd8be7fbe78f">01290</a> <a class="code" href="server_2repo-mgr_8c.html#a754dc377da1101690257dd8be7fbe78f">seaf_repo_manager_list_repo_tokens_by_email</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01291"></a>01291                                              <span class="keyword">const</span> <span class="keywordtype">char</span> *email,
<a name="l01292"></a>01292                                              GError **error)
<a name="l01293"></a>01293 {
<a name="l01294"></a>01294     GList *ret_list = NULL;
<a name="l01295"></a>01295     <span class="keywordtype">char</span> *sql;
<a name="l01296"></a>01296 
<a name="l01297"></a>01297     sql = <span class="stringliteral">&quot;SELECT u.repo_id, o.owner_id, u.email, u.token, &quot;</span>
<a name="l01298"></a>01298         <span class="stringliteral">&quot;p.peer_id, p.peer_ip, p.peer_name, p.sync_time &quot;</span>
<a name="l01299"></a>01299         <span class="stringliteral">&quot;FROM RepoUserToken u LEFT JOIN RepoTokenPeerInfo p &quot;</span>
<a name="l01300"></a>01300         <span class="stringliteral">&quot;ON u.token = p.token, RepoOwner o &quot;</span>
<a name="l01301"></a>01301         <span class="stringliteral">&quot;WHERE u.email = ? and u.repo_id = o.repo_id&quot;</span>;
<a name="l01302"></a>01302 
<a name="l01303"></a>01303     <span class="keywordtype">int</span> n_row = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
<a name="l01304"></a>01304                                               collect_repo_token, &amp;ret_list,
<a name="l01305"></a>01305                                               1, <span class="stringliteral">&quot;string&quot;</span>, email);
<a name="l01306"></a>01306     <span class="keywordflow">if</span> (n_row &lt; 0) {
<a name="l01307"></a>01307         seaf_warning (<span class="stringliteral">&quot;DB error when get token info for email %s.\n&quot;</span>,
<a name="l01308"></a>01308                       email);
<a name="l01309"></a>01309         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
<a name="l01310"></a>01310     }
<a name="l01311"></a>01311 
<a name="l01312"></a>01312     fill_in_token_info (ret_list);
<a name="l01313"></a>01313 
<a name="l01314"></a>01314     <span class="keywordflow">return</span> g_list_reverse(ret_list);
<a name="l01315"></a>01315 }
<a name="l01316"></a>01316 
<a name="l01317"></a>01317 <span class="keyword">static</span> gboolean
<a name="l01318"></a>01318 collect_token_list (<a class="code" href="structSeafDBRow.html">SeafDBRow</a> *row, <span class="keywordtype">void</span> *data)
<a name="l01319"></a>01319 {
<a name="l01320"></a>01320     GList **p_tokens = data;
<a name="l01321"></a>01321     <span class="keyword">const</span> <span class="keywordtype">char</span> *token;
<a name="l01322"></a>01322 
<a name="l01323"></a>01323     token = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 0);
<a name="l01324"></a>01324     *p_tokens = g_list_prepend (*p_tokens, g_strdup(token));
<a name="l01325"></a>01325 
<a name="l01326"></a>01326     <span class="keywordflow">return</span> TRUE;
<a name="l01327"></a>01327 }
<a name="l01328"></a>01328 
<a name="l01333"></a>01333 <span class="keywordtype">int</span>
<a name="l01334"></a><a class="code" href="server_2repo-mgr_8h.html#ab1d760446ae882d377b26dcd36eac582">01334</a> <a class="code" href="server_2repo-mgr_8c.html#ab1d760446ae882d377b26dcd36eac582">seaf_repo_manager_delete_repo_tokens_by_peer_id</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01335"></a>01335                                                  <span class="keyword">const</span> <span class="keywordtype">char</span> *email,
<a name="l01336"></a>01336                                                  <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id,
<a name="l01337"></a>01337                                                  GList **tokens,
<a name="l01338"></a>01338                                                  GError **error)
<a name="l01339"></a>01339 {
<a name="l01340"></a>01340     <span class="keywordtype">int</span> ret = 0;
<a name="l01341"></a>01341     <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">template</span>;
<a name="l01342"></a>01342     GList *token_list = NULL;
<a name="l01343"></a>01343     GString *token_list_str = g_string_new (<span class="stringliteral">&quot;&quot;</span>);
<a name="l01344"></a>01344     GString *sql = g_string_new (<span class="stringliteral">&quot;&quot;</span>);
<a name="l01345"></a>01345     GList *ptr;
<a name="l01346"></a>01346     <span class="keywordtype">int</span> rc = 0;
<a name="l01347"></a>01347 
<a name="l01348"></a>01348     <span class="keyword">template</span> = <span class="stringliteral">&quot;SELECT u.token &quot;</span>
<a name="l01349"></a>01349         <span class="stringliteral">&quot;FROM RepoUserToken as u, RepoTokenPeerInfo as p &quot;</span>
<a name="l01350"></a>01350         <span class="stringliteral">&quot;WHERE u.token = p.token &quot;</span>
<a name="l01351"></a>01351         <span class="stringliteral">&quot;AND u.email = ? AND p.peer_id = ?&quot;</span>;
<a name="l01352"></a>01352     rc = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="keyword">template</span>,
<a name="l01353"></a>01353                                         collect_token_list, &amp;token_list,
<a name="l01354"></a>01354                                         2, <span class="stringliteral">&quot;string&quot;</span>, email, <span class="stringliteral">&quot;string&quot;</span>, peer_id);
<a name="l01355"></a>01355     <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01356"></a>01356         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
<a name="l01357"></a>01357         <span class="keywordflow">goto</span> out;
<a name="l01358"></a>01358     }
<a name="l01359"></a>01359 
<a name="l01360"></a>01360     <span class="keywordflow">if</span> (rc == 0)
<a name="l01361"></a>01361         <span class="keywordflow">goto</span> out;
<a name="l01362"></a>01362 
<a name="l01363"></a>01363     <span class="keywordflow">for</span> (ptr = token_list; ptr; ptr = ptr-&gt;next) {
<a name="l01364"></a>01364         <span class="keyword">const</span> <span class="keywordtype">char</span> *token = (<span class="keywordtype">char</span> *)ptr-&gt;data;
<a name="l01365"></a>01365         if (token_list_str-&gt;len == 0)
<a name="l01366"></a>01366             g_string_append_printf (token_list_str, <span class="stringliteral">&quot;&#39;%s&#39;&quot;</span>, token);
<a name="l01367"></a>01367         <span class="keywordflow">else</span>
<a name="l01368"></a>01368             g_string_append_printf (token_list_str, <span class="stringliteral">&quot;,&#39;%s&#39;&quot;</span>, token);
<a name="l01369"></a>01369     }
<a name="l01370"></a>01370 
<a name="l01371"></a>01371     <span class="comment">/* Note that there is a size limit on sql query. In MySQL it&#39;s 1MB by default.</span>
<a name="l01372"></a>01372 <span class="comment">     * Normally the token_list won&#39;t be that long.</span>
<a name="l01373"></a>01373 <span class="comment">     */</span>
<a name="l01374"></a>01374     g_string_printf (sql, <span class="stringliteral">&quot;DELETE FROM RepoUserToken WHERE token in (%s)&quot;</span>,
<a name="l01375"></a>01375                      token_list_str-&gt;str);
<a name="l01376"></a>01376     rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql-&gt;str, 0);
<a name="l01377"></a>01377     <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01378"></a>01378         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
<a name="l01379"></a>01379         <span class="keywordflow">goto</span> out;
<a name="l01380"></a>01380     }
<a name="l01381"></a>01381 
<a name="l01382"></a>01382     g_string_printf (sql, <span class="stringliteral">&quot;DELETE FROM RepoTokenPeerInfo WHERE token in (%s)&quot;</span>,
<a name="l01383"></a>01383                      token_list_str-&gt;str);
<a name="l01384"></a>01384     rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql-&gt;str, 0);
<a name="l01385"></a>01385     <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l01386"></a>01386         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
<a name="l01387"></a>01387 
<a name="l01388"></a>01388 out:
<a name="l01389"></a>01389     g_string_free (token_list_str, TRUE);
<a name="l01390"></a>01390     g_string_free (sql, TRUE);
<a name="l01391"></a>01391 
<a name="l01392"></a>01392     <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01393"></a>01393         ret = -1;
<a name="l01394"></a>01394         g_list_free_full (token_list, (GDestroyNotify)g_free);
<a name="l01395"></a>01395     } <span class="keywordflow">else</span> {
<a name="l01396"></a>01396         *tokens = token_list;
<a name="l01397"></a>01397     }
<a name="l01398"></a>01398 
<a name="l01399"></a>01399     <span class="keywordflow">return</span> ret;
<a name="l01400"></a>01400 }
<a name="l01401"></a>01401 
<a name="l01402"></a>01402 <span class="keywordtype">int</span>
<a name="l01403"></a><a class="code" href="server_2repo-mgr_8h.html#abd2450d97efc42795b87ad7b4624ae63">01403</a> <a class="code" href="server_2repo-mgr_8c.html#abd2450d97efc42795b87ad7b4624ae63">seaf_repo_manager_delete_repo_tokens_by_email</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01404"></a>01404                                                <span class="keyword">const</span> <span class="keywordtype">char</span> *email,
<a name="l01405"></a>01405                                                GError **error)
<a name="l01406"></a>01406 {
<a name="l01407"></a>01407     <span class="keywordtype">int</span> ret = 0;
<a name="l01408"></a>01408     <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">template</span>;
<a name="l01409"></a>01409     GList *token_list = NULL;
<a name="l01410"></a>01410     GList *ptr;
<a name="l01411"></a>01411     GString *token_list_str = g_string_new (<span class="stringliteral">&quot;&quot;</span>);
<a name="l01412"></a>01412     GString *sql = g_string_new (<span class="stringliteral">&quot;&quot;</span>);
<a name="l01413"></a>01413     <span class="keywordtype">int</span> rc;
<a name="l01414"></a>01414 
<a name="l01415"></a>01415     <span class="keyword">template</span> = <span class="stringliteral">&quot;SELECT u.token &quot;</span>
<a name="l01416"></a>01416         <span class="stringliteral">&quot;FROM RepoUserToken as u, RepoTokenPeerInfo as p &quot;</span>
<a name="l01417"></a>01417         <span class="stringliteral">&quot;WHERE u.token = p.token &quot;</span>
<a name="l01418"></a>01418         <span class="stringliteral">&quot;AND u.email = ?&quot;</span>;
<a name="l01419"></a>01419     rc = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, <span class="keyword">template</span>,
<a name="l01420"></a>01420                                         collect_token_list, &amp;token_list,
<a name="l01421"></a>01421                                         1, <span class="stringliteral">&quot;string&quot;</span>, email);
<a name="l01422"></a>01422     <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01423"></a>01423         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
<a name="l01424"></a>01424         <span class="keywordflow">goto</span> out;
<a name="l01425"></a>01425     }
<a name="l01426"></a>01426 
<a name="l01427"></a>01427     <span class="keywordflow">if</span> (rc == 0)
<a name="l01428"></a>01428         <span class="keywordflow">goto</span> out;
<a name="l01429"></a>01429 
<a name="l01430"></a>01430     <span class="keywordflow">for</span> (ptr = token_list; ptr; ptr = ptr-&gt;next) {
<a name="l01431"></a>01431         <span class="keyword">const</span> <span class="keywordtype">char</span> *token = (<span class="keywordtype">char</span> *)ptr-&gt;data;
<a name="l01432"></a>01432         if (token_list_str-&gt;len == 0)
<a name="l01433"></a>01433             g_string_append_printf (token_list_str, <span class="stringliteral">&quot;&#39;%s&#39;&quot;</span>, token);
<a name="l01434"></a>01434         <span class="keywordflow">else</span>
<a name="l01435"></a>01435             g_string_append_printf (token_list_str, <span class="stringliteral">&quot;,&#39;%s&#39;&quot;</span>, token);
<a name="l01436"></a>01436     }
<a name="l01437"></a>01437 
<a name="l01438"></a>01438     <span class="comment">/* Note that there is a size limit on sql query. In MySQL it&#39;s 1MB by default.</span>
<a name="l01439"></a>01439 <span class="comment">     * Normally the token_list won&#39;t be that long.</span>
<a name="l01440"></a>01440 <span class="comment">     */</span>
<a name="l01441"></a>01441     g_string_printf (sql, <span class="stringliteral">&quot;DELETE FROM RepoUserToken WHERE token in (%s)&quot;</span>,
<a name="l01442"></a>01442                      token_list_str-&gt;str);
<a name="l01443"></a>01443     rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql-&gt;str, 0);
<a name="l01444"></a>01444     <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01445"></a>01445         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
<a name="l01446"></a>01446         <span class="keywordflow">goto</span> out;
<a name="l01447"></a>01447     }
<a name="l01448"></a>01448 
<a name="l01449"></a>01449     g_string_printf (sql, <span class="stringliteral">&quot;DELETE FROM RepoTokenPeerInfo WHERE token in (%s)&quot;</span>,
<a name="l01450"></a>01450                      token_list_str-&gt;str);
<a name="l01451"></a>01451     rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql-&gt;str, 0);
<a name="l01452"></a>01452     <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01453"></a>01453         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a7aec187daf50bdbbf10c9eb4ca50c981">SEAF_ERR_INTERNAL</a>, <span class="stringliteral">&quot;DB error&quot;</span>);
<a name="l01454"></a>01454         <span class="keywordflow">goto</span> out;
<a name="l01455"></a>01455     }
<a name="l01456"></a>01456 
<a name="l01457"></a>01457     <a class="code" href="http-server_8c.html#a4b50fa8bc6c458c1a5bdc640cc71b6cb">seaf_http_server_invalidate_tokens</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a0309f60018b54c38ec8d3275ee1d6666">http_server</a>, token_list);
<a name="l01458"></a>01458 
<a name="l01459"></a>01459 out:
<a name="l01460"></a>01460     g_string_free (token_list_str, TRUE);
<a name="l01461"></a>01461     g_string_free (sql, TRUE);
<a name="l01462"></a>01462     g_list_free_full (token_list, (GDestroyNotify)g_free);
<a name="l01463"></a>01463 
<a name="l01464"></a>01464     <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01465"></a>01465         ret = -1;
<a name="l01466"></a>01466     }
<a name="l01467"></a>01467 
<a name="l01468"></a>01468     <span class="keywordflow">return</span> ret;
<a name="l01469"></a>01469 }
<a name="l01470"></a>01470 
<a name="l01471"></a>01471 <span class="keyword">static</span> gboolean
<a name="l01472"></a>01472 get_email_by_token_cb (<a class="code" href="structSeafDBRow.html">SeafDBRow</a> *row, <span class="keywordtype">void</span> *data)
<a name="l01473"></a>01473 {
<a name="l01474"></a>01474     <span class="keywordtype">char</span> **email_ptr = data;
<a name="l01475"></a>01475 
<a name="l01476"></a>01476     <span class="keyword">const</span> <span class="keywordtype">char</span> *email = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 0);
<a name="l01477"></a>01477     *email_ptr = g_ascii_strdown (email, -1);
<a name="l01478"></a>01478     <span class="comment">/* There should be only one result. */</span>
<a name="l01479"></a>01479     <span class="keywordflow">return</span> FALSE;
<a name="l01480"></a>01480 }
<a name="l01481"></a>01481 
<a name="l01482"></a>01482 <span class="keywordtype">char</span> *
<a name="l01483"></a><a class="code" href="server_2repo-mgr_8h.html#a2413f0a10a33c5de4d82193c9c8b7f08">01483</a> <a class="code" href="server_2repo-mgr_8c.html#a2413f0a10a33c5de4d82193c9c8b7f08">seaf_repo_manager_get_email_by_token</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *manager,
<a name="l01484"></a>01484                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l01485"></a>01485                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *token)
<a name="l01486"></a>01486 {
<a name="l01487"></a>01487     <span class="keywordflow">if</span> (!repo_id || !token)
<a name="l01488"></a>01488         <span class="keywordflow">return</span> NULL;
<a name="l01489"></a>01489     
<a name="l01490"></a>01490     <span class="keywordtype">char</span> *email = NULL;
<a name="l01491"></a>01491     <span class="keywordtype">char</span> *sql;
<a name="l01492"></a>01492 
<a name="l01493"></a>01493     sql = <span class="stringliteral">&quot;SELECT email FROM RepoUserToken &quot;</span>
<a name="l01494"></a>01494         <span class="stringliteral">&quot;WHERE repo_id = ? AND token = ?&quot;</span>;
<a name="l01495"></a>01495 
<a name="l01496"></a>01496     <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
<a name="l01497"></a>01497                                    get_email_by_token_cb, &amp;email,
<a name="l01498"></a>01498                                    2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;string&quot;</span>, token);
<a name="l01499"></a>01499 
<a name="l01500"></a>01500     <span class="keywordflow">return</span> email;
<a name="l01501"></a>01501 }
<a name="l01502"></a>01502 
<a name="l01503"></a>01503 <span class="keyword">static</span> gboolean
<a name="l01504"></a>01504 get_repo_size (<a class="code" href="structSeafDBRow.html">SeafDBRow</a> *row, <span class="keywordtype">void</span> *vsize)
<a name="l01505"></a>01505 {
<a name="l01506"></a>01506     gint64 *psize = vsize;
<a name="l01507"></a>01507 
<a name="l01508"></a>01508     *psize = <a class="code" href="seaf-db_8c.html#ac9d9437b19d33c23ce45ec6b1f4d8a05">seaf_db_row_get_column_int64</a> (row, 0);
<a name="l01509"></a>01509 
<a name="l01510"></a>01510     <span class="keywordflow">return</span> FALSE;
<a name="l01511"></a>01511 }
<a name="l01512"></a>01512 
<a name="l01513"></a>01513 gint64
<a name="l01514"></a><a class="code" href="server_2repo-mgr_8h.html#ae37e80051d587e921a003fc06c21d540">01514</a> <a class="code" href="server_2repo-mgr_8c.html#ae37e80051d587e921a003fc06c21d540">seaf_repo_manager_get_repo_size</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr, <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l01515"></a>01515 {
<a name="l01516"></a>01516     gint64 size = 0;
<a name="l01517"></a>01517     <span class="keywordtype">char</span> *sql;
<a name="l01518"></a>01518 
<a name="l01519"></a>01519     sql = <span class="stringliteral">&quot;SELECT size FROM RepoSize WHERE repo_id=?&quot;</span>;
<a name="l01520"></a>01520 
<a name="l01521"></a>01521     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
<a name="l01522"></a>01522                                        get_repo_size, &amp;size,
<a name="l01523"></a>01523                                        1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0)
<a name="l01524"></a>01524         <span class="keywordflow">return</span> -1;
<a name="l01525"></a>01525 
<a name="l01526"></a>01526     <span class="keywordflow">return</span> <a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a>;
<a name="l01527"></a>01527 }
<a name="l01528"></a>01528 
<a name="l01529"></a>01529 <span class="keywordtype">int</span>
<a name="l01530"></a><a class="code" href="server_2repo-mgr_8c.html#ac78c13c68a1a9d1d025e45f4e51193ac">01530</a> <a class="code" href="server_2gc_2repo-mgr_8c.html#ac78c13c68a1a9d1d025e45f4e51193ac">seaf_repo_manager_set_repo_history_limit</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01531"></a>01531                                           <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l01532"></a>01532                                           <span class="keywordtype">int</span> days)
<a name="l01533"></a>01533 {
<a name="l01534"></a>01534     <a class="code" href="structSeafVirtRepo.html">SeafVirtRepo</a> *vinfo;
<a name="l01535"></a>01535     <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;
<a name="l01536"></a>01536 
<a name="l01537"></a>01537     vinfo = <a class="code" href="server_2gc_2repo-mgr_8c.html#a316db228b35dde3dc88ae9dab9ec9c22">seaf_repo_manager_get_virtual_repo_info</a> (mgr, repo_id);
<a name="l01538"></a>01538     <span class="keywordflow">if</span> (vinfo) {
<a name="l01539"></a>01539         <a class="code" href="server_2gc_2repo-mgr_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a">seaf_virtual_repo_info_free</a> (vinfo);
<a name="l01540"></a>01540         <span class="keywordflow">return</span> 0;
<a name="l01541"></a>01541     }
<a name="l01542"></a>01542 
<a name="l01543"></a>01543     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae183a9c45ec082962bdd361491b0a8cb">seaf_db_type</a>(db) == <a class="code" href="seaf-db_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da62ce2e8a052406ede3fcf39ec407ccf8">SEAF_DB_TYPE_PGSQL</a>) {
<a name="l01544"></a>01544         gboolean exists, err;
<a name="l01545"></a>01545         <span class="keywordtype">int</span> rc;
<a name="l01546"></a>01546 
<a name="l01547"></a>01547         exists = <a class="code" href="seaf-db_8c.html#af77a76302b3316a4d71e418de27843c4">seaf_db_statement_exists</a> (db,
<a name="l01548"></a>01548                                            <span class="stringliteral">&quot;SELECT repo_id FROM RepoHistoryLimit &quot;</span>
<a name="l01549"></a>01549                                            <span class="stringliteral">&quot;WHERE repo_id=?&quot;</span>,
<a name="l01550"></a>01550                                            &amp;err, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l01551"></a>01551         <span class="keywordflow">if</span> (err)
<a name="l01552"></a>01552             <span class="keywordflow">return</span> -1;
<a name="l01553"></a>01553 
<a name="l01554"></a>01554         <span class="keywordflow">if</span> (exists)
<a name="l01555"></a>01555             rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db,
<a name="l01556"></a>01556                                           <span class="stringliteral">&quot;UPDATE RepoHistoryLimit SET days=%d&quot;</span>
<a name="l01557"></a>01557                                           <span class="stringliteral">&quot;WHERE repo_id=?&quot;</span>,
<a name="l01558"></a>01558                                           2, <span class="stringliteral">&quot;int&quot;</span>, days, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l01559"></a>01559         <span class="keywordflow">else</span>
<a name="l01560"></a>01560             rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db,
<a name="l01561"></a>01561                                           <span class="stringliteral">&quot;INSERT INTO RepoHistoryLimit VALUES &quot;</span>
<a name="l01562"></a>01562                                           <span class="stringliteral">&quot;(?, ?)&quot;</span>,
<a name="l01563"></a>01563                                           2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;int&quot;</span>, days);
<a name="l01564"></a>01564         <span class="keywordflow">return</span> rc;
<a name="l01565"></a>01565     } <span class="keywordflow">else</span> {
<a name="l01566"></a>01566         <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db,
<a name="l01567"></a>01567                                      <span class="stringliteral">&quot;REPLACE INTO RepoHistoryLimit VALUES (?, ?)&quot;</span>,
<a name="l01568"></a>01568                                      2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;int&quot;</span>, days) &lt; 0)
<a name="l01569"></a>01569             <span class="keywordflow">return</span> -1;
<a name="l01570"></a>01570     }
<a name="l01571"></a>01571 
<a name="l01572"></a>01572     <span class="keywordflow">return</span> 0;
<a name="l01573"></a>01573 }
<a name="l01574"></a>01574 
<a name="l01575"></a>01575 <span class="keywordtype">int</span>
<a name="l01576"></a><a class="code" href="server_2repo-mgr_8c.html#a0f63ca499435a0d01f03c8c3a2d86c44">01576</a> <a class="code" href="server_2gc_2repo-mgr_8c.html#a0f63ca499435a0d01f03c8c3a2d86c44">seaf_repo_manager_get_repo_history_limit</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01577"></a>01577                                           <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l01578"></a>01578 {
<a name="l01579"></a>01579     <a class="code" href="structSeafVirtRepo.html">SeafVirtRepo</a> *vinfo;
<a name="l01580"></a>01580     <span class="keyword">const</span> <span class="keywordtype">char</span> *r_repo_id = repo_id;
<a name="l01581"></a>01581     <span class="keywordtype">char</span> *sql;
<a name="l01582"></a>01582     <span class="keywordtype">int</span> per_repo_days;
<a name="l01583"></a>01583 
<a name="l01584"></a>01584     vinfo = <a class="code" href="server_2gc_2repo-mgr_8c.html#a316db228b35dde3dc88ae9dab9ec9c22">seaf_repo_manager_get_virtual_repo_info</a> (mgr, repo_id);
<a name="l01585"></a>01585     <span class="keywordflow">if</span> (vinfo)
<a name="l01586"></a>01586         r_repo_id = vinfo-&gt;<a class="code" href="structSeafVirtRepo.html#a23bc0205036c7a0c807c4f89145794b1">origin_repo_id</a>;
<a name="l01587"></a>01587 
<a name="l01588"></a>01588     sql = <span class="stringliteral">&quot;SELECT days FROM RepoHistoryLimit WHERE repo_id=?&quot;</span>;
<a name="l01589"></a>01589     per_repo_days = <a class="code" href="seaf-db_8c.html#a69eb3d0620dabc0731b9e00ce06d1a3e">seaf_db_statement_get_int</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
<a name="l01590"></a>01590                                                1, <span class="stringliteral">&quot;string&quot;</span>, r_repo_id);
<a name="l01591"></a>01591 
<a name="l01592"></a>01592     <a class="code" href="server_2gc_2repo-mgr_8c.html#a66a6ccfc59462f4c59fd322c693c3d5a">seaf_virtual_repo_info_free</a> (vinfo);
<a name="l01593"></a>01593 
<a name="l01594"></a>01594     <span class="comment">/* If per repo value is not set or DB error, return the global one. */</span>
<a name="l01595"></a>01595     <span class="keywordflow">if</span> (per_repo_days &lt; 0)
<a name="l01596"></a>01596         <span class="keywordflow">return</span> mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ad1d597138a7b676e94cd273a4a446776">keep_history_days</a>;
<a name="l01597"></a>01597 
<a name="l01598"></a>01598     <span class="keywordflow">return</span> per_repo_days;
<a name="l01599"></a>01599 }
<a name="l01600"></a>01600 
<a name="l01601"></a>01601 <span class="keywordtype">int</span>
<a name="l01602"></a><a class="code" href="server_2repo-mgr_8c.html#aeeda6cf1cb41515388afd8a10c6297e1">01602</a> <a class="code" href="server_2gc_2repo-mgr_8c.html#aeeda6cf1cb41515388afd8a10c6297e1">seaf_repo_manager_set_repo_valid_since</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01603"></a>01603                                         <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l01604"></a>01604                                         gint64 timestamp)
<a name="l01605"></a>01605 {
<a name="l01606"></a>01606     <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;
<a name="l01607"></a>01607 
<a name="l01608"></a>01608     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae183a9c45ec082962bdd361491b0a8cb">seaf_db_type</a>(db) == <a class="code" href="seaf-db_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da62ce2e8a052406ede3fcf39ec407ccf8">SEAF_DB_TYPE_PGSQL</a>) {
<a name="l01609"></a>01609         gboolean exists, err;
<a name="l01610"></a>01610         <span class="keywordtype">int</span> rc;
<a name="l01611"></a>01611 
<a name="l01612"></a>01612         exists = <a class="code" href="seaf-db_8c.html#af77a76302b3316a4d71e418de27843c4">seaf_db_statement_exists</a> (db,
<a name="l01613"></a>01613                                            <span class="stringliteral">&quot;SELECT repo_id FROM RepoValidSince WHERE &quot;</span>
<a name="l01614"></a>01614                                            <span class="stringliteral">&quot;repo_id=?&quot;</span>, &amp;err, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l01615"></a>01615         <span class="keywordflow">if</span> (err)
<a name="l01616"></a>01616             <span class="keywordflow">return</span> -1;
<a name="l01617"></a>01617 
<a name="l01618"></a>01618         <span class="keywordflow">if</span> (exists)
<a name="l01619"></a>01619             rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db,
<a name="l01620"></a>01620                                           <span class="stringliteral">&quot;UPDATE RepoValidSince SET timestamp=?&quot;</span>
<a name="l01621"></a>01621                                           <span class="stringliteral">&quot; WHERE repo_id=?&quot;</span>,
<a name="l01622"></a>01622                                           2, <span class="stringliteral">&quot;int64&quot;</span>, timestamp, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l01623"></a>01623         <span class="keywordflow">else</span>
<a name="l01624"></a>01624             rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db,
<a name="l01625"></a>01625                                           <span class="stringliteral">&quot;INSERT INTO RepoValidSince VALUES &quot;</span>
<a name="l01626"></a>01626                                           <span class="stringliteral">&quot;(?, ?)&quot;</span>, 2, <span class="stringliteral">&quot;string&quot;</span>, repo_id,
<a name="l01627"></a>01627                                           <span class="stringliteral">&quot;int64&quot;</span>, timestamp);
<a name="l01628"></a>01628         <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l01629"></a>01629             <span class="keywordflow">return</span> -1;
<a name="l01630"></a>01630     } <span class="keywordflow">else</span> {
<a name="l01631"></a>01631         <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db,
<a name="l01632"></a>01632                            <span class="stringliteral">&quot;REPLACE INTO RepoValidSince VALUES (?, ?)&quot;</span>,
<a name="l01633"></a>01633                            2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;int64&quot;</span>, timestamp) &lt; 0)
<a name="l01634"></a>01634             <span class="keywordflow">return</span> -1;
<a name="l01635"></a>01635     }
<a name="l01636"></a>01636 
<a name="l01637"></a>01637     <span class="keywordflow">return</span> 0;
<a name="l01638"></a>01638 }
<a name="l01639"></a>01639 
<a name="l01640"></a>01640 gint64
<a name="l01641"></a><a class="code" href="server_2repo-mgr_8c.html#aa8aafa2da81a00419443a068fe98958b">01641</a> <a class="code" href="server_2gc_2repo-mgr_8c.html#aa8aafa2da81a00419443a068fe98958b">seaf_repo_manager_get_repo_valid_since</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01642"></a>01642                                         <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l01643"></a>01643 {
<a name="l01644"></a>01644     <span class="keywordtype">char</span> *sql;
<a name="l01645"></a>01645 
<a name="l01646"></a>01646     sql = <span class="stringliteral">&quot;SELECT timestamp FROM RepoValidSince WHERE repo_id=?&quot;</span>;
<a name="l01647"></a>01647     <span class="comment">/* Also return -1 if doesn&#39;t exist. */</span>
<a name="l01648"></a>01648     <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a148dee5d529525afa53d208d2f9d4b86">seaf_db_statement_get_int64</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l01649"></a>01649 }
<a name="l01650"></a>01650 
<a name="l01651"></a>01651 gint64
<a name="l01652"></a><a class="code" href="server_2repo-mgr_8c.html#a774e0a8ea59c07c94dc8014612b3f948">01652</a> <a class="code" href="server_2gc_2repo-mgr_8c.html#a774e0a8ea59c07c94dc8014612b3f948">seaf_repo_manager_get_repo_truncate_time</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01653"></a>01653                                           <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l01654"></a>01654 {
<a name="l01655"></a>01655     <span class="keywordtype">int</span> days;
<a name="l01656"></a>01656     gint64 timestamp;
<a name="l01657"></a>01657 
<a name="l01658"></a>01658     days = <a class="code" href="server_2gc_2repo-mgr_8c.html#a0f63ca499435a0d01f03c8c3a2d86c44">seaf_repo_manager_get_repo_history_limit</a> (mgr, repo_id);
<a name="l01659"></a>01659     timestamp = <a class="code" href="server_2gc_2repo-mgr_8c.html#aa8aafa2da81a00419443a068fe98958b">seaf_repo_manager_get_repo_valid_since</a> (mgr, repo_id);
<a name="l01660"></a>01660 
<a name="l01661"></a>01661     gint64 now = (gint64)time(NULL);
<a name="l01662"></a>01662     <span class="keywordflow">if</span> (days &gt; 0)
<a name="l01663"></a>01663         <span class="keywordflow">return</span> MAX (now - days * 24 * 3600, timestamp);
<a name="l01664"></a>01664     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (days &lt; 0)
<a name="l01665"></a>01665         <span class="keywordflow">return</span> timestamp;
<a name="l01666"></a>01666     <span class="keywordflow">else</span>
<a name="l01667"></a>01667         <span class="keywordflow">return</span> 0;
<a name="l01668"></a>01668 }
<a name="l01669"></a>01669 
<a name="l01670"></a>01670 <span class="comment">/*</span>
<a name="l01671"></a>01671 <span class="comment"> * Permission related functions.</span>
<a name="l01672"></a>01672 <span class="comment"> */</span>
<a name="l01673"></a>01673 
<a name="l01674"></a>01674 <span class="comment">/* Owner functions. */</span>
<a name="l01675"></a>01675 
<a name="l01676"></a>01676 <span class="keywordtype">int</span>
<a name="l01677"></a><a class="code" href="server_2repo-mgr_8h.html#a5f096821f41a339e41e9341fc0c4010d">01677</a> <a class="code" href="server_2repo-mgr_8c.html#a5f096821f41a339e41e9341fc0c4010d">seaf_repo_manager_set_repo_owner</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01678"></a>01678                                   <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l01679"></a>01679                                   <span class="keyword">const</span> <span class="keywordtype">char</span> *email)
<a name="l01680"></a>01680 {
<a name="l01681"></a>01681     <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;
<a name="l01682"></a>01682     <span class="keywordtype">char</span> sql[256];
<a name="l01683"></a>01683 
<a name="l01684"></a>01684     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae183a9c45ec082962bdd361491b0a8cb">seaf_db_type</a>(db) == <a class="code" href="seaf-db_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da62ce2e8a052406ede3fcf39ec407ccf8">SEAF_DB_TYPE_PGSQL</a>) {
<a name="l01685"></a>01685         gboolean err;
<a name="l01686"></a>01686         snprintf(sql, <span class="keyword">sizeof</span>(sql),
<a name="l01687"></a>01687                  <span class="stringliteral">&quot;SELECT repo_id FROM RepoOwner WHERE repo_id=&#39;%s&#39;&quot;</span>, repo_id);
<a name="l01688"></a>01688         <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a6410cd243563343861ba3c6c16fc06a7">seaf_db_check_for_existence</a>(db, sql, &amp;err))
<a name="l01689"></a>01689             snprintf(sql, <span class="keyword">sizeof</span>(sql),
<a name="l01690"></a>01690                      <span class="stringliteral">&quot;UPDATE RepoOwner SET owner_id=&#39;%s&#39; WHERE &quot;</span>
<a name="l01691"></a>01691                      <span class="stringliteral">&quot;repo_id=&#39;%s&#39;&quot;</span>, email, repo_id);
<a name="l01692"></a>01692         <span class="keywordflow">else</span>
<a name="l01693"></a>01693             snprintf(sql, <span class="keyword">sizeof</span>(sql),
<a name="l01694"></a>01694                      <span class="stringliteral">&quot;INSERT INTO RepoOwner VALUES (&#39;%s&#39;, &#39;%s&#39;)&quot;</span>,
<a name="l01695"></a>01695                      repo_id, email);
<a name="l01696"></a>01696         <span class="keywordflow">if</span> (err)
<a name="l01697"></a>01697             <span class="keywordflow">return</span> -1;
<a name="l01698"></a>01698         <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql) &lt; 0)
<a name="l01699"></a>01699             <span class="keywordflow">return</span> -1;
<a name="l01700"></a>01700     } <span class="keywordflow">else</span> {
<a name="l01701"></a>01701         <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db, <span class="stringliteral">&quot;REPLACE INTO RepoOwner VALUES (?, ?)&quot;</span>,
<a name="l01702"></a>01702                                      2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;string&quot;</span>, email) &lt; 0)
<a name="l01703"></a>01703             <span class="keywordflow">return</span> -1;
<a name="l01704"></a>01704     }
<a name="l01705"></a>01705 
<a name="l01706"></a>01706     <span class="keywordflow">return</span> 0;
<a name="l01707"></a>01707 }
<a name="l01708"></a>01708 
<a name="l01709"></a>01709 <span class="keyword">static</span> gboolean
<a name="l01710"></a>01710 get_owner (<a class="code" href="structSeafDBRow.html">SeafDBRow</a> *row, <span class="keywordtype">void</span> *data)
<a name="l01711"></a>01711 {
<a name="l01712"></a>01712     <span class="keywordtype">char</span> **owner_id = data;
<a name="l01713"></a>01713 
<a name="l01714"></a>01714     <span class="keyword">const</span> <span class="keywordtype">char</span> *owner = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 0);
<a name="l01715"></a>01715     *owner_id = g_ascii_strdown (owner, -1);
<a name="l01716"></a>01716     <span class="comment">/* There should be only one result. */</span>
<a name="l01717"></a>01717     <span class="keywordflow">return</span> FALSE;
<a name="l01718"></a>01718 }
<a name="l01719"></a>01719 
<a name="l01720"></a>01720 <span class="keywordtype">char</span> *
<a name="l01721"></a><a class="code" href="server_2repo-mgr_8h.html#af227a31082c71908bf0a0ac35cfeb294">01721</a> <a class="code" href="server_2repo-mgr_8c.html#af227a31082c71908bf0a0ac35cfeb294">seaf_repo_manager_get_repo_owner</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01722"></a>01722                                   <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l01723"></a>01723 {
<a name="l01724"></a>01724     <span class="keywordtype">char</span> *sql;
<a name="l01725"></a>01725     <span class="keywordtype">char</span> *ret = NULL;
<a name="l01726"></a>01726 
<a name="l01727"></a>01727     sql = <span class="stringliteral">&quot;SELECT owner_id FROM RepoOwner WHERE repo_id=?&quot;</span>;
<a name="l01728"></a>01728     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
<a name="l01729"></a>01729                                        get_owner, &amp;ret,
<a name="l01730"></a>01730                                        1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0) {
<a name="l01731"></a>01731         seaf_warning (<span class="stringliteral">&quot;Failed to get owner id for repo %s.\n&quot;</span>, repo_id);
<a name="l01732"></a>01732         <span class="keywordflow">return</span> NULL;
<a name="l01733"></a>01733     }
<a name="l01734"></a>01734 
<a name="l01735"></a>01735     <span class="keywordflow">return</span> ret;
<a name="l01736"></a>01736 }
<a name="l01737"></a>01737 
<a name="l01738"></a>01738 <span class="keyword">static</span> gboolean
<a name="l01739"></a>01739 collect_repo_id (<a class="code" href="structSeafDBRow.html">SeafDBRow</a> *row, <span class="keywordtype">void</span> *data)
<a name="l01740"></a>01740 {
<a name="l01741"></a>01741     GList **p_ids = data;
<a name="l01742"></a>01742     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id;
<a name="l01743"></a>01743 
<a name="l01744"></a>01744     repo_id = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 0);
<a name="l01745"></a>01745     *p_ids = g_list_prepend (*p_ids, g_strdup(repo_id));
<a name="l01746"></a>01746 
<a name="l01747"></a>01747     <span class="keywordflow">return</span> TRUE;
<a name="l01748"></a>01748 }
<a name="l01749"></a>01749 
<a name="l01750"></a>01750 GList *
<a name="l01751"></a><a class="code" href="server_2repo-mgr_8h.html#aa30a874076b81b802de8763e30433c97">01751</a> <a class="code" href="server_2repo-mgr_8c.html#aa30a874076b81b802de8763e30433c97">seaf_repo_manager_get_orphan_repo_list</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr)
<a name="l01752"></a>01752 {
<a name="l01753"></a>01753     GList *id_list = NULL, *ptr;
<a name="l01754"></a>01754     GList *ret = NULL;
<a name="l01755"></a>01755     <span class="keywordtype">char</span> sql[256];
<a name="l01756"></a>01756 
<a name="l01757"></a>01757     snprintf (sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT Repo.repo_id FROM Repo LEFT JOIN &quot;</span>
<a name="l01758"></a>01758               <span class="stringliteral">&quot;RepoOwner ON Repo.repo_id = RepoOwner.repo_id WHERE &quot;</span>
<a name="l01759"></a>01759               <span class="stringliteral">&quot;RepoOwner.owner_id is NULL&quot;</span>);
<a name="l01760"></a>01760 
<a name="l01761"></a>01761     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4">seaf_db_foreach_selected_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
<a name="l01762"></a>01762                                       collect_repo_id, &amp;id_list) &lt; 0)
<a name="l01763"></a>01763         <span class="keywordflow">return</span> NULL;
<a name="l01764"></a>01764 
<a name="l01765"></a>01765     <span class="keywordflow">for</span> (ptr = id_list; ptr; ptr = ptr-&gt;next) {
<a name="l01766"></a>01766         <span class="keywordtype">char</span> *repo_id = ptr-&gt;data;
<a name="l01767"></a>01767         <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
<a name="l01768"></a>01768         <span class="keywordflow">if</span> (repo != NULL)
<a name="l01769"></a>01769             ret = g_list_prepend (ret, repo);
<a name="l01770"></a>01770     }
<a name="l01771"></a>01771 
<a name="l01772"></a>01772     <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (id_list);
<a name="l01773"></a>01773 
<a name="l01774"></a>01774     <span class="keywordflow">return</span> ret;
<a name="l01775"></a>01775 }
<a name="l01776"></a>01776 
<a name="l01777"></a>01777 GList *
<a name="l01778"></a><a class="code" href="server_2repo-mgr_8c.html#a7cf33a85dd9c77b44a83d6c8ed300948">01778</a> <a class="code" href="fuse_2repo-mgr_8c.html#a7cf33a85dd9c77b44a83d6c8ed300948">seaf_repo_manager_get_repos_by_owner</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01779"></a>01779                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *email)
<a name="l01780"></a>01780 {
<a name="l01781"></a>01781     GList *id_list = NULL, *ptr;
<a name="l01782"></a>01782     GList *ret = NULL;
<a name="l01783"></a>01783     <span class="keywordtype">char</span> *sql;
<a name="l01784"></a>01784 
<a name="l01785"></a>01785     sql = <span class="stringliteral">&quot;SELECT repo_id FROM RepoOwner WHERE owner_id=?&quot;</span>;
<a name="l01786"></a>01786 
<a name="l01787"></a>01787     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 
<a name="l01788"></a>01788                                        collect_repo_id, &amp;id_list,
<a name="l01789"></a>01789                                        1, <span class="stringliteral">&quot;string&quot;</span>, email) &lt; 0)
<a name="l01790"></a>01790         <span class="keywordflow">return</span> NULL;
<a name="l01791"></a>01791 
<a name="l01792"></a>01792     <span class="keywordflow">for</span> (ptr = id_list; ptr; ptr = ptr-&gt;next) {
<a name="l01793"></a>01793         <span class="keywordtype">char</span> *repo_id = ptr-&gt;data;
<a name="l01794"></a>01794         <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (mgr, repo_id);
<a name="l01795"></a>01795         <span class="keywordflow">if</span> (repo != NULL)
<a name="l01796"></a>01796             ret = g_list_prepend (ret, repo);
<a name="l01797"></a>01797     }
<a name="l01798"></a>01798 
<a name="l01799"></a>01799     <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (id_list);
<a name="l01800"></a>01800 
<a name="l01801"></a>01801     <span class="keywordflow">return</span> ret;
<a name="l01802"></a>01802 }
<a name="l01803"></a>01803 
<a name="l01804"></a>01804 GList *
<a name="l01805"></a><a class="code" href="server_2repo-mgr_8c.html#a928ca86df93e60744ca6edacb33a386f">01805</a> <a class="code" href="fuse_2repo-mgr_8c.html#a928ca86df93e60744ca6edacb33a386f">seaf_repo_manager_get_repo_id_list</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr)
<a name="l01806"></a>01806 {
<a name="l01807"></a>01807     GList *ret = NULL;
<a name="l01808"></a>01808     <span class="keywordtype">char</span> sql[256];
<a name="l01809"></a>01809 
<a name="l01810"></a>01810     snprintf (sql, 256, <span class="stringliteral">&quot;SELECT repo_id FROM Repo&quot;</span>);
<a name="l01811"></a>01811 
<a name="l01812"></a>01812     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a2b045ec7501c5141b95a01ba752947d4">seaf_db_foreach_selected_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 
<a name="l01813"></a>01813                                       collect_repo_id, &amp;ret) &lt; 0)
<a name="l01814"></a>01814         <span class="keywordflow">return</span> NULL;
<a name="l01815"></a>01815 
<a name="l01816"></a>01816     <span class="keywordflow">return</span> ret;
<a name="l01817"></a>01817 }
<a name="l01818"></a>01818 
<a name="l01819"></a>01819 GList *
<a name="l01820"></a><a class="code" href="server_2repo-mgr_8c.html#aa692b1e331cad063425d676afe1ae121">01820</a> <a class="code" href="daemon_2repo-mgr_8c.html#a5fe41fb7382995f3f335e408ba4ddb30">seaf_repo_manager_get_repo_list</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr, <span class="keywordtype">int</span> start, <span class="keywordtype">int</span> limit)
<a name="l01821"></a>01821 {
<a name="l01822"></a>01822     GList *id_list = NULL, *ptr;
<a name="l01823"></a>01823     GList *ret = NULL;
<a name="l01824"></a>01824     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l01825"></a>01825     <span class="keywordtype">int</span> rc;
<a name="l01826"></a>01826 
<a name="l01827"></a>01827     <span class="keywordflow">if</span> (start == -1 &amp;&amp; limit == -1)
<a name="l01828"></a>01828         rc = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l01829"></a>01829                                        <span class="stringliteral">&quot;SELECT repo_id FROM Repo&quot;</span>,
<a name="l01830"></a>01830                                        collect_repo_id, &amp;id_list,
<a name="l01831"></a>01831                                        0);
<a name="l01832"></a>01832     <span class="keywordflow">else</span>
<a name="l01833"></a>01833         rc = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l01834"></a>01834                                             <span class="stringliteral">&quot;SELECT repo_id FROM Repo &quot;</span>
<a name="l01835"></a>01835                                             <span class="stringliteral">&quot;ORDER BY repo_id LIMIT ? OFFSET ?&quot;</span>,
<a name="l01836"></a>01836                                             collect_repo_id, &amp;id_list,
<a name="l01837"></a>01837                                             2, <span class="stringliteral">&quot;int&quot;</span>, limit, <span class="stringliteral">&quot;int&quot;</span>, start);
<a name="l01838"></a>01838 
<a name="l01839"></a>01839     <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l01840"></a>01840         <span class="keywordflow">return</span> NULL;
<a name="l01841"></a>01841 
<a name="l01842"></a>01842     <span class="keywordflow">for</span> (ptr = id_list; ptr; ptr = ptr-&gt;next) {
<a name="l01843"></a>01843         <span class="keywordtype">char</span> *repo_id = ptr-&gt;data;
<a name="l01844"></a>01844         repo = <a class="code" href="server_2gc_2repo-mgr_8c.html#a11cc1a4ecd45778ea5a10af0cb72b347">seaf_repo_manager_get_repo_ex</a> (mgr, repo_id);
<a name="l01845"></a>01845         <span class="keywordflow">if</span> (repo != NULL)
<a name="l01846"></a>01846             ret = g_list_prepend (ret, repo);
<a name="l01847"></a>01847     }
<a name="l01848"></a>01848 
<a name="l01849"></a>01849     <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (id_list);
<a name="l01850"></a>01850 
<a name="l01851"></a>01851     <span class="keywordflow">return</span> ret;
<a name="l01852"></a>01852 }
<a name="l01853"></a>01853 
<a name="l01854"></a>01854 GList *
<a name="l01855"></a><a class="code" href="server_2repo-mgr_8h.html#a6a2b07102342d3acc5722e059635aacb">01855</a> <a class="code" href="server_2repo-mgr_8c.html#a6a2b07102342d3acc5722e059635aacb">seaf_repo_manager_get_repo_ids_by_owner</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01856"></a>01856                                          <span class="keyword">const</span> <span class="keywordtype">char</span> *email)
<a name="l01857"></a>01857 {
<a name="l01858"></a>01858     GList *ret = NULL;
<a name="l01859"></a>01859     <span class="keywordtype">char</span> *sql;
<a name="l01860"></a>01860 
<a name="l01861"></a>01861     sql = <span class="stringliteral">&quot;SELECT repo_id FROM RepoOwner WHERE owner_id=?&quot;</span>;
<a name="l01862"></a>01862 
<a name="l01863"></a>01863     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 
<a name="l01864"></a>01864                                        collect_repo_id, &amp;ret,
<a name="l01865"></a>01865                                        1, <span class="stringliteral">&quot;string&quot;</span>, email) &lt; 0) {
<a name="l01866"></a>01866         <a class="code" href="seafile_2lib_2utils_8c.html#af85d9a3e4ab846a6eedfb509508367f2">string_list_free</a> (ret);
<a name="l01867"></a>01867         <span class="keywordflow">return</span> NULL;
<a name="l01868"></a>01868     }
<a name="l01869"></a>01869 
<a name="l01870"></a>01870     <span class="keywordflow">return</span> ret;
<a name="l01871"></a>01871 }
<a name="l01872"></a>01872 
<a name="l01873"></a>01873 <span class="keyword">static</span> gboolean
<a name="l01874"></a>01874 collect_trash_repo (<a class="code" href="structSeafDBRow.html">SeafDBRow</a> *row, <span class="keywordtype">void</span> *data)
<a name="l01875"></a>01875 {
<a name="l01876"></a>01876     GList **trash_repos = data;
<a name="l01877"></a>01877     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id;
<a name="l01878"></a>01878     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_name;
<a name="l01879"></a>01879     <span class="keyword">const</span> <span class="keywordtype">char</span> *head_id;
<a name="l01880"></a>01880     <span class="keyword">const</span> <span class="keywordtype">char</span> *owner_id;
<a name="l01881"></a>01881     gint64 <a class="code" href="index_8h.html#af931a8871310b4dad23f0f0b0f623560">size</a>;
<a name="l01882"></a>01882 
<a name="l01883"></a>01883     repo_id = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 0);
<a name="l01884"></a>01884     repo_name = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 1);
<a name="l01885"></a>01885     head_id = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 2);
<a name="l01886"></a>01886     owner_id = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 3);
<a name="l01887"></a>01887     size = <a class="code" href="seaf-db_8c.html#ac9d9437b19d33c23ce45ec6b1f4d8a05">seaf_db_row_get_column_int64</a> (row, 4);
<a name="l01888"></a>01888 
<a name="l01889"></a>01889     <span class="keywordflow">if</span> (!repo_id || !repo_name || !head_id || !owner_id)
<a name="l01890"></a>01890         <span class="keywordflow">return</span> FALSE;
<a name="l01891"></a>01891 
<a name="l01892"></a>01892     <a class="code" href="struct__SeafileTrashRepo.html">SeafileTrashRepo</a> *trash_repo = g_object_new (<a class="code" href="repo_8c.html#a54821cdb6f7261b689cfc2cb2c631d35">SEAFILE_TYPE_TRASH_REPO</a>,
<a name="l01893"></a>01893                                                  <span class="stringliteral">&quot;repo_id&quot;</span>, repo_id,
<a name="l01894"></a>01894                                                  <span class="stringliteral">&quot;repo_name&quot;</span>, repo_name,
<a name="l01895"></a>01895                                                  <span class="stringliteral">&quot;head_id&quot;</span>, head_id,
<a name="l01896"></a>01896                                                  <span class="stringliteral">&quot;owner_id&quot;</span>, owner_id,
<a name="l01897"></a>01897                                                  <span class="stringliteral">&quot;size&quot;</span>, size,
<a name="l01898"></a>01898                                                  NULL);
<a name="l01899"></a>01899     <span class="keywordflow">if</span> (!trash_repo)
<a name="l01900"></a>01900         <span class="keywordflow">return</span> FALSE;
<a name="l01901"></a>01901 
<a name="l01902"></a>01902     *trash_repos = g_list_prepend (*trash_repos, trash_repo);
<a name="l01903"></a>01903 
<a name="l01904"></a>01904     <span class="keywordflow">return</span> TRUE;
<a name="l01905"></a>01905 }
<a name="l01906"></a>01906 
<a name="l01907"></a>01907 GList *
<a name="l01908"></a><a class="code" href="server_2repo-mgr_8h.html#a8fec30cb36491cb94d968df3ce06d5d7">01908</a> <a class="code" href="server_2repo-mgr_8c.html#a8fec30cb36491cb94d968df3ce06d5d7">seaf_repo_manager_get_trash_repo_list</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01909"></a>01909                                        <span class="keywordtype">int</span> start,
<a name="l01910"></a>01910                                        <span class="keywordtype">int</span> limit,
<a name="l01911"></a>01911                                        GError **error)
<a name="l01912"></a>01912 {
<a name="l01913"></a>01913     GList *trash_repos = NULL;
<a name="l01914"></a>01914     <span class="keywordtype">int</span> rc;
<a name="l01915"></a>01915 
<a name="l01916"></a>01916     <span class="keywordflow">if</span> (start == -1 &amp;&amp; limit == -1)
<a name="l01917"></a>01917         rc = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l01918"></a>01918                                             <span class="stringliteral">&quot;SELECT repo_id, repo_name, head_id, owner_id, &quot;</span>
<a name="l01919"></a>01919                                             <span class="stringliteral">&quot;size FROM RepoTrash&quot;</span>,
<a name="l01920"></a>01920                                             collect_trash_repo, &amp;trash_repos,
<a name="l01921"></a>01921                                             0);
<a name="l01922"></a>01922     <span class="keywordflow">else</span>
<a name="l01923"></a>01923         rc = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l01924"></a>01924                                             <span class="stringliteral">&quot;SELECT repo_id, repo_name, head_id, owner_id, &quot;</span>
<a name="l01925"></a>01925                                             <span class="stringliteral">&quot;size FROM RepoTrash &quot;</span>
<a name="l01926"></a>01926                                             <span class="stringliteral">&quot;ORDER BY repo_id LIMIT ? OFFSET ?&quot;</span>,
<a name="l01927"></a>01927                                             collect_trash_repo, &amp;trash_repos,
<a name="l01928"></a>01928                                             2, <span class="stringliteral">&quot;int&quot;</span>, limit, <span class="stringliteral">&quot;int&quot;</span>, start);
<a name="l01929"></a>01929 
<a name="l01930"></a>01930     <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01931"></a>01931         <span class="keywordflow">while</span> (trash_repos) {
<a name="l01932"></a>01932             g_object_unref (trash_repos-&gt;data);
<a name="l01933"></a>01933             trash_repos = g_list_delete_link (trash_repos, trash_repos);
<a name="l01934"></a>01934         }
<a name="l01935"></a>01935         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l01936"></a>01936                      <span class="stringliteral">&quot;Failed to get trashed repo from db.&quot;</span>);
<a name="l01937"></a>01937         <span class="keywordflow">return</span> NULL;
<a name="l01938"></a>01938     }
<a name="l01939"></a>01939 
<a name="l01940"></a>01940     <span class="keywordflow">return</span> trash_repos;
<a name="l01941"></a>01941 }
<a name="l01942"></a>01942 
<a name="l01943"></a>01943 GList *
<a name="l01944"></a><a class="code" href="server_2repo-mgr_8h.html#a507c39fec59f1a4672a0cdd5493c6887">01944</a> <a class="code" href="server_2repo-mgr_8c.html#a507c39fec59f1a4672a0cdd5493c6887">seaf_repo_manager_get_trash_repos_by_owner</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01945"></a>01945                                             <span class="keyword">const</span> <span class="keywordtype">char</span> *owner,
<a name="l01946"></a>01946                                             GError **error)
<a name="l01947"></a>01947 {
<a name="l01948"></a>01948     GList *trash_repos = NULL;
<a name="l01949"></a>01949     <span class="keywordtype">int</span> rc;
<a name="l01950"></a>01950 
<a name="l01951"></a>01951     rc = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l01952"></a>01952                                         <span class="stringliteral">&quot;SELECT repo_id, repo_name, head_id, owner_id, &quot;</span>
<a name="l01953"></a>01953                                         <span class="stringliteral">&quot;size FROM RepoTrash WHERE owner_id = ?&quot;</span>,
<a name="l01954"></a>01954                                         collect_trash_repo, &amp;trash_repos,
<a name="l01955"></a>01955                                         1, <span class="stringliteral">&quot;string&quot;</span>, owner);
<a name="l01956"></a>01956 
<a name="l01957"></a>01957     <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01958"></a>01958         <span class="keywordflow">while</span> (trash_repos) {
<a name="l01959"></a>01959             g_object_unref (trash_repos-&gt;data);
<a name="l01960"></a>01960             trash_repos = g_list_delete_link (trash_repos, trash_repos);
<a name="l01961"></a>01961         }
<a name="l01962"></a>01962         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l01963"></a>01963                      <span class="stringliteral">&quot;Failed to get trashed repo from db.&quot;</span>);
<a name="l01964"></a>01964         <span class="keywordflow">return</span> NULL;
<a name="l01965"></a>01965     }
<a name="l01966"></a>01966 
<a name="l01967"></a>01967     <span class="keywordflow">return</span> trash_repos;
<a name="l01968"></a>01968 }
<a name="l01969"></a>01969 
<a name="l01970"></a>01970 <a class="code" href="struct__SeafileTrashRepo.html">SeafileTrashRepo</a> *
<a name="l01971"></a><a class="code" href="server_2repo-mgr_8c.html#a8326627abe60741e456d4acf6e5ac244">01971</a> <a class="code" href="server_2repo-mgr_8c.html#a8326627abe60741e456d4acf6e5ac244">seaf_repo_manager_get_repo_from_trash</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01972"></a>01972                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l01973"></a>01973 {
<a name="l01974"></a>01974     <a class="code" href="struct__SeafileTrashRepo.html">SeafileTrashRepo</a> *ret = NULL;
<a name="l01975"></a>01975     GList *trash_repos = NULL;
<a name="l01976"></a>01976     <span class="keywordtype">char</span> *sql;
<a name="l01977"></a>01977     <span class="keywordtype">int</span> rc;
<a name="l01978"></a>01978 
<a name="l01979"></a>01979     sql = <span class="stringliteral">&quot;SELECT repo_id, repo_name, head_id, owner_id, size FROM RepoTrash &quot;</span>
<a name="l01980"></a>01980         <span class="stringliteral">&quot;WHERE repo_id = ?&quot;</span>;
<a name="l01981"></a>01981     rc = <a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
<a name="l01982"></a>01982                                         collect_trash_repo, &amp;trash_repos,
<a name="l01983"></a>01983                                         1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l01984"></a>01984     <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l01985"></a>01985         <span class="keywordflow">return</span> NULL;
<a name="l01986"></a>01986 
<a name="l01987"></a>01987     <span class="comment">/* There should be only one results, since repo_id is a PK. */</span>
<a name="l01988"></a>01988     ret = trash_repos-&gt;data;
<a name="l01989"></a>01989 
<a name="l01990"></a>01990     g_list_free (trash_repos);
<a name="l01991"></a>01991     <span class="keywordflow">return</span> ret;
<a name="l01992"></a>01992 }
<a name="l01993"></a>01993 
<a name="l01994"></a>01994 <span class="keywordtype">int</span>
<a name="l01995"></a><a class="code" href="server_2repo-mgr_8h.html#a94469a7522aa5a67fbc58440544e299a">01995</a> <a class="code" href="server_2repo-mgr_8c.html#a94469a7522aa5a67fbc58440544e299a">seaf_repo_manager_del_repo_from_trash</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l01996"></a>01996                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l01997"></a>01997                                        GError **error)
<a name="l01998"></a>01998 {
<a name="l01999"></a>01999     <span class="keywordtype">int</span> ret = 0;
<a name="l02000"></a>02000 
<a name="l02001"></a>02001     <span class="comment">/* As long as the repo is successfully moved into GarbageRepo table,</span>
<a name="l02002"></a>02002 <span class="comment">     * we consider this operation successful.</span>
<a name="l02003"></a>02003 <span class="comment">     */</span>
<a name="l02004"></a>02004     <span class="keywordflow">if</span> (add_deleted_repo_record (mgr, repo_id) &lt; 0) {
<a name="l02005"></a>02005         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l02006"></a>02006                      <span class="stringliteral">&quot;DB error: Add deleted record&quot;</span>);
<a name="l02007"></a>02007         <span class="keywordflow">return</span> -1;
<a name="l02008"></a>02008     }
<a name="l02009"></a>02009 
<a name="l02010"></a>02010     <span class="comment">/* remove branch */</span>
<a name="l02011"></a>02011     GList *p;
<a name="l02012"></a>02012     GList *branch_list = <a class="code" href="branch-mgr_8c.html#ad5bd62cbe17cb8fe91bcd993956a1fbf">seaf_branch_manager_get_branch_list</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo_id);
<a name="l02013"></a>02013     <span class="keywordflow">for</span> (p = branch_list; p; p = p-&gt;next) {
<a name="l02014"></a>02014         <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *b = (<a class="code" href="struct__SeafBranch.html">SeafBranch</a> *)p-&gt;data;
<a name="l02015"></a>02015         <a class="code" href="daemon_2repo-mgr_8c.html#ae586fb5fbd61d6b44be3e47e7b6c86da">seaf_repo_manager_branch_repo_unmap</a> (mgr, b);
<a name="l02016"></a>02016         <a class="code" href="branch-mgr_8c.html#a16b2df7708f3a4c4b96e9135ec7e1a3d">seaf_branch_manager_del_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo_id, b-&gt;<a class="code" href="struct__SeafBranch.html#ae6af0006b9b80ded4f0525a3be06ccda">name</a>);
<a name="l02017"></a>02017     }
<a name="l02018"></a>02018     <a class="code" href="branch-mgr_8c.html#ac6476414064e0ff0c429629aaab0bfc9">seaf_branch_list_free</a> (branch_list);
<a name="l02019"></a>02019 
<a name="l02020"></a>02020     <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l02021"></a>02021                              <span class="stringliteral">&quot;DELETE FROM RepoTrash WHERE repo_id = ?&quot;</span>,
<a name="l02022"></a>02022                              1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l02023"></a>02023 
<a name="l02024"></a>02024     <span class="keywordflow">return</span> 0;
<a name="l02025"></a>02025 }
<a name="l02026"></a>02026 
<a name="l02027"></a>02027 <span class="keywordtype">int</span>
<a name="l02028"></a><a class="code" href="server_2repo-mgr_8h.html#a47fd08ad688d035ae95e11545bb0a68b">02028</a> <a class="code" href="server_2repo-mgr_8c.html#a47fd08ad688d035ae95e11545bb0a68b">seaf_repo_manager_empty_repo_trash</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr, GError **error)
<a name="l02029"></a>02029 {
<a name="l02030"></a>02030     GList *trash_repos = NULL, *ptr;
<a name="l02031"></a>02031     <a class="code" href="struct__SeafileTrashRepo.html">SeafileTrashRepo</a> *repo;
<a name="l02032"></a>02032 
<a name="l02033"></a>02033     trash_repos = <a class="code" href="server_2repo-mgr_8c.html#a8fec30cb36491cb94d968df3ce06d5d7">seaf_repo_manager_get_trash_repo_list</a> (mgr, -1, -1, error);
<a name="l02034"></a>02034     <span class="keywordflow">if</span> (*error)
<a name="l02035"></a>02035         <span class="keywordflow">return</span> -1;
<a name="l02036"></a>02036 
<a name="l02037"></a>02037     <span class="keywordflow">for</span> (ptr = trash_repos; ptr; ptr = ptr-&gt;next) {
<a name="l02038"></a>02038         repo = ptr-&gt;data;
<a name="l02039"></a>02039         <a class="code" href="server_2repo-mgr_8c.html#a94469a7522aa5a67fbc58440544e299a">seaf_repo_manager_del_repo_from_trash</a> (mgr,
<a name="l02040"></a>02040                                                <a class="code" href="repo_8c.html#aa833417b3ced164bf21722143e7c3a78">seafile_trash_repo_get_repo_id</a>(repo),
<a name="l02041"></a>02041                                                NULL);
<a name="l02042"></a>02042         g_object_unref (repo);
<a name="l02043"></a>02043     }
<a name="l02044"></a>02044 
<a name="l02045"></a>02045     g_list_free (trash_repos);
<a name="l02046"></a>02046     <span class="keywordflow">return</span> 0;
<a name="l02047"></a>02047 }
<a name="l02048"></a>02048 
<a name="l02049"></a>02049 <span class="keywordtype">int</span>
<a name="l02050"></a><a class="code" href="server_2repo-mgr_8h.html#a99f0a8fafd75a617d03ea745d36df9be">02050</a> <a class="code" href="server_2repo-mgr_8c.html#a99f0a8fafd75a617d03ea745d36df9be">seaf_repo_manager_empty_repo_trash_by_owner</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02051"></a>02051                                              <span class="keyword">const</span> <span class="keywordtype">char</span> *owner,
<a name="l02052"></a>02052                                              GError **error)
<a name="l02053"></a>02053 {
<a name="l02054"></a>02054     GList *trash_repos = NULL, *ptr;
<a name="l02055"></a>02055     <a class="code" href="struct__SeafileTrashRepo.html">SeafileTrashRepo</a> *repo;
<a name="l02056"></a>02056 
<a name="l02057"></a>02057     trash_repos = <a class="code" href="server_2repo-mgr_8c.html#a507c39fec59f1a4672a0cdd5493c6887">seaf_repo_manager_get_trash_repos_by_owner</a> (mgr, owner, error);
<a name="l02058"></a>02058     <span class="keywordflow">if</span> (*error)
<a name="l02059"></a>02059         <span class="keywordflow">return</span> -1;
<a name="l02060"></a>02060 
<a name="l02061"></a>02061     <span class="keywordflow">for</span> (ptr = trash_repos; ptr; ptr = ptr-&gt;next) {
<a name="l02062"></a>02062         repo = ptr-&gt;data;
<a name="l02063"></a>02063         <a class="code" href="server_2repo-mgr_8c.html#a94469a7522aa5a67fbc58440544e299a">seaf_repo_manager_del_repo_from_trash</a> (mgr,
<a name="l02064"></a>02064                                                <a class="code" href="repo_8c.html#aa833417b3ced164bf21722143e7c3a78">seafile_trash_repo_get_repo_id</a>(repo),
<a name="l02065"></a>02065                                                NULL);
<a name="l02066"></a>02066         g_object_unref (repo);
<a name="l02067"></a>02067     }
<a name="l02068"></a>02068 
<a name="l02069"></a>02069     g_list_free (trash_repos);
<a name="l02070"></a>02070     <span class="keywordflow">return</span> 0;
<a name="l02071"></a>02071 }
<a name="l02072"></a>02072 
<a name="l02073"></a>02073 <span class="keywordtype">int</span>
<a name="l02074"></a><a class="code" href="server_2repo-mgr_8h.html#a4db874916fe89f6b839e389d74034288">02074</a> <a class="code" href="server_2repo-mgr_8c.html#a4db874916fe89f6b839e389d74034288">seaf_repo_manager_restore_repo_from_trash</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02075"></a>02075                                            <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l02076"></a>02076                                            GError **error)
<a name="l02077"></a>02077 {
<a name="l02078"></a>02078     <a class="code" href="struct__SeafileTrashRepo.html">SeafileTrashRepo</a> *repo = NULL;
<a name="l02079"></a>02079     <span class="keywordtype">int</span> ret = 0;
<a name="l02080"></a>02080     gboolean exists = FALSE;
<a name="l02081"></a>02081     gboolean db_err;
<a name="l02082"></a>02082 
<a name="l02083"></a>02083     repo = <a class="code" href="server_2repo-mgr_8c.html#a8326627abe60741e456d4acf6e5ac244">seaf_repo_manager_get_repo_from_trash</a> (mgr, repo_id);
<a name="l02084"></a>02084     <span class="keywordflow">if</span> (!repo) {
<a name="l02085"></a>02085         seaf_warning (<span class="stringliteral">&quot;Repo %.8s not found in trash.\n&quot;</span>, repo_id);
<a name="l02086"></a>02086         <span class="keywordflow">return</span> -1;
<a name="l02087"></a>02087     }
<a name="l02088"></a>02088 
<a name="l02089"></a>02089     <a class="code" href="structSeafDBTrans.html">SeafDBTrans</a> *trans = <a class="code" href="seaf-db_8c.html#a3f672ef795004a79886871b1d7e36862">seaf_db_begin_transaction</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>);
<a name="l02090"></a>02090 
<a name="l02091"></a>02091     exists = <a class="code" href="seaf-db_8c.html#a85906acba812801fd6ef8137920d3dcc">seaf_db_trans_check_for_existence</a> (trans,
<a name="l02092"></a>02092                                                 <span class="stringliteral">&quot;SELECT 1 FROM Repo WHERE repo_id=?&quot;</span>,
<a name="l02093"></a>02093                                                 &amp;db_err, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l02094"></a>02094 
<a name="l02095"></a>02095     <span class="keywordflow">if</span> (!exists) {
<a name="l02096"></a>02096         ret = <a class="code" href="seaf-db_8c.html#abfa65542f46d16df51de1e82fefcebb3">seaf_db_trans_query</a> (trans,
<a name="l02097"></a>02097                                    <span class="stringliteral">&quot;INSERT INTO Repo(repo_id) VALUES (?)&quot;</span>,
<a name="l02098"></a>02098                                    1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0;
<a name="l02099"></a>02099         <span class="keywordflow">if</span> (ret &lt; 0) {
<a name="l02100"></a>02100             g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l02101"></a>02101                          <span class="stringliteral">&quot;DB error: Insert Repo.&quot;</span>);
<a name="l02102"></a>02102             <a class="code" href="seaf-db_8c.html#a2786c0aa2d6f3629bc9ed8960e8de288">seaf_db_rollback</a> (trans);
<a name="l02103"></a>02103             <a class="code" href="seaf-db_8c.html#af47f83c610aa48fca8f2f667fe2d096d">seaf_db_trans_close</a> (trans);
<a name="l02104"></a>02104             <span class="keywordflow">goto</span> out;
<a name="l02105"></a>02105         }
<a name="l02106"></a>02106     }
<a name="l02107"></a>02107 
<a name="l02108"></a>02108     exists = <a class="code" href="seaf-db_8c.html#a85906acba812801fd6ef8137920d3dcc">seaf_db_trans_check_for_existence</a> (trans,
<a name="l02109"></a>02109                                                 <span class="stringliteral">&quot;SELECT 1 FROM RepoOwner WHERE repo_id=?&quot;</span>,
<a name="l02110"></a>02110                                                 &amp;db_err, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l02111"></a>02111 
<a name="l02112"></a>02112     <span class="keywordflow">if</span> (!exists) {
<a name="l02113"></a>02113         ret = <a class="code" href="seaf-db_8c.html#abfa65542f46d16df51de1e82fefcebb3">seaf_db_trans_query</a> (trans,
<a name="l02114"></a>02114                                    <span class="stringliteral">&quot;INSERT INTO RepoOwner VALUES (?, ?)&quot;</span>,
<a name="l02115"></a>02115                                    2, <span class="stringliteral">&quot;string&quot;</span>, repo_id,
<a name="l02116"></a>02116                                    <span class="stringliteral">&quot;string&quot;</span>, <a class="code" href="repo_8c.html#a3b3e8fbdb003fab44ba2ed1d3f4d0cd3">seafile_trash_repo_get_owner_id</a>(repo));
<a name="l02117"></a>02117         <span class="keywordflow">if</span> (ret &lt; 0) {
<a name="l02118"></a>02118             g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l02119"></a>02119                          <span class="stringliteral">&quot;DB error: Insert Repo Owner.&quot;</span>);
<a name="l02120"></a>02120             <a class="code" href="seaf-db_8c.html#a2786c0aa2d6f3629bc9ed8960e8de288">seaf_db_rollback</a> (trans);
<a name="l02121"></a>02121             <a class="code" href="seaf-db_8c.html#af47f83c610aa48fca8f2f667fe2d096d">seaf_db_trans_close</a> (trans);
<a name="l02122"></a>02122             <span class="keywordflow">goto</span> out;
<a name="l02123"></a>02123         }
<a name="l02124"></a>02124     }
<a name="l02125"></a>02125 
<a name="l02126"></a>02126     ret = <a class="code" href="seaf-db_8c.html#abfa65542f46d16df51de1e82fefcebb3">seaf_db_trans_query</a> (trans,
<a name="l02127"></a>02127                                <span class="stringliteral">&quot;DELETE FROM RepoTrash WHERE repo_id = ?&quot;</span>,
<a name="l02128"></a>02128                                1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l02129"></a>02129     <span class="keywordflow">if</span> (ret &lt; 0) {
<a name="l02130"></a>02130         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l02131"></a>02131                      <span class="stringliteral">&quot;DB error: delete from RepoTrash.&quot;</span>);
<a name="l02132"></a>02132         <a class="code" href="seaf-db_8c.html#a2786c0aa2d6f3629bc9ed8960e8de288">seaf_db_rollback</a> (trans);
<a name="l02133"></a>02133         <a class="code" href="seaf-db_8c.html#af47f83c610aa48fca8f2f667fe2d096d">seaf_db_trans_close</a> (trans);
<a name="l02134"></a>02134         <span class="keywordflow">goto</span> out;
<a name="l02135"></a>02135     }
<a name="l02136"></a>02136 
<a name="l02137"></a>02137     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a8f67506e6cc01be4aa0a2a9fc5b08bd2">seaf_db_commit</a> (trans) &lt; 0) {
<a name="l02138"></a>02138         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l02139"></a>02139                      <span class="stringliteral">&quot;DB error: Failed to commit.&quot;</span>);
<a name="l02140"></a>02140         <a class="code" href="seaf-db_8c.html#a2786c0aa2d6f3629bc9ed8960e8de288">seaf_db_rollback</a> (trans);
<a name="l02141"></a>02141         ret = -1;
<a name="l02142"></a>02142     }
<a name="l02143"></a>02143 
<a name="l02144"></a>02144     <a class="code" href="seaf-db_8c.html#af47f83c610aa48fca8f2f667fe2d096d">seaf_db_trans_close</a> (trans);
<a name="l02145"></a>02145 
<a name="l02146"></a>02146 out:
<a name="l02147"></a>02147     g_object_unref (repo);
<a name="l02148"></a>02148     <span class="keywordflow">return</span> ret;
<a name="l02149"></a>02149 }
<a name="l02150"></a>02150 
<a name="l02151"></a>02151 <span class="comment">/* Web access permission. */</span>
<a name="l02152"></a>02152 
<a name="l02153"></a>02153 <span class="keywordtype">int</span>
<a name="l02154"></a><a class="code" href="server_2repo-mgr_8h.html#aaabba29e879e5e4e53ff753e86b5427b">02154</a> <a class="code" href="server_2repo-mgr_8c.html#aaabba29e879e5e4e53ff753e86b5427b">seaf_repo_manager_set_access_property</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr, <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l02155"></a>02155                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *ap)
<a name="l02156"></a>02156 {
<a name="l02157"></a>02157     <span class="keywordtype">int</span> rc;
<a name="l02158"></a>02158 
<a name="l02159"></a>02159     <span class="keywordflow">if</span> (<a class="code" href="server_2repo-mgr_8c.html#a3f3921eba68da813d0d1a583c8923396">seaf_repo_manager_query_access_property</a> (mgr, repo_id) == NULL) {
<a name="l02160"></a>02160         rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l02161"></a>02161                                       <span class="stringliteral">&quot;INSERT INTO WebAP VALUES (?, ?)&quot;</span>,
<a name="l02162"></a>02162                                       2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;string&quot;</span>, ap);
<a name="l02163"></a>02163     } <span class="keywordflow">else</span> {
<a name="l02164"></a>02164         rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l02165"></a>02165                                       <span class="stringliteral">&quot;UPDATE WebAP SET access_property=? &quot;</span>
<a name="l02166"></a>02166                                       <span class="stringliteral">&quot;WHERE repo_id=?&quot;</span>,
<a name="l02167"></a>02167                                       2, <span class="stringliteral">&quot;string&quot;</span>, ap, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l02168"></a>02168     }
<a name="l02169"></a>02169 
<a name="l02170"></a>02170     <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l02171"></a>02171         seaf_warning (<span class="stringliteral">&quot;DB error when set access property for repo %s, %s.\n&quot;</span>, repo_id, ap);
<a name="l02172"></a>02172         <span class="keywordflow">return</span> -1;
<a name="l02173"></a>02173     }
<a name="l02174"></a>02174     
<a name="l02175"></a>02175     <span class="keywordflow">return</span> 0;
<a name="l02176"></a>02176 }
<a name="l02177"></a>02177 
<a name="l02178"></a>02178 <span class="keyword">static</span> gboolean
<a name="l02179"></a>02179 get_ap (<a class="code" href="structSeafDBRow.html">SeafDBRow</a> *row, <span class="keywordtype">void</span> *data)
<a name="l02180"></a>02180 {
<a name="l02181"></a>02181     <span class="keywordtype">char</span> **ap = data;
<a name="l02182"></a>02182 
<a name="l02183"></a>02183     *ap = g_strdup (<a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 0));
<a name="l02184"></a>02184 
<a name="l02185"></a>02185     <span class="keywordflow">return</span> FALSE;
<a name="l02186"></a>02186 }
<a name="l02187"></a>02187 
<a name="l02188"></a>02188 <span class="keywordtype">char</span> *
<a name="l02189"></a><a class="code" href="server_2repo-mgr_8h.html#a3f3921eba68da813d0d1a583c8923396">02189</a> <a class="code" href="server_2repo-mgr_8c.html#a3f3921eba68da813d0d1a583c8923396">seaf_repo_manager_query_access_property</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr, <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l02190"></a>02190 {
<a name="l02191"></a>02191     <span class="keywordtype">char</span> *sql;
<a name="l02192"></a>02192     <span class="keywordtype">char</span> *ret = NULL;
<a name="l02193"></a>02193 
<a name="l02194"></a>02194     sql =  <span class="stringliteral">&quot;SELECT access_property FROM WebAP WHERE repo_id=?&quot;</span>;
<a name="l02195"></a>02195  
<a name="l02196"></a>02196     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, get_ap, &amp;ret,
<a name="l02197"></a>02197                                        1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0) {
<a name="l02198"></a>02198         seaf_warning (<span class="stringliteral">&quot;DB error when get access property for repo %s.\n&quot;</span>, repo_id);
<a name="l02199"></a>02199         <span class="keywordflow">return</span> NULL;
<a name="l02200"></a>02200     }
<a name="l02201"></a>02201 
<a name="l02202"></a>02202     <span class="keywordflow">return</span> ret;
<a name="l02203"></a>02203 }
<a name="l02204"></a>02204 
<a name="l02205"></a>02205 <span class="comment">/* Group repos. */</span>
<a name="l02206"></a>02206 
<a name="l02207"></a>02207 <span class="keywordtype">int</span>
<a name="l02208"></a><a class="code" href="server_2repo-mgr_8h.html#ae90467b188b67b2c7dd720a159cbbbaa">02208</a> <a class="code" href="server_2repo-mgr_8c.html#ae90467b188b67b2c7dd720a159cbbbaa">seaf_repo_manager_add_group_repo</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02209"></a>02209                                   <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l02210"></a>02210                                   <span class="keywordtype">int</span> group_id,
<a name="l02211"></a>02211                                   <span class="keyword">const</span> <span class="keywordtype">char</span> *owner,
<a name="l02212"></a>02212                                   <span class="keyword">const</span> <span class="keywordtype">char</span> *permission,
<a name="l02213"></a>02213                                   GError **error)
<a name="l02214"></a>02214 {
<a name="l02215"></a>02215     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l02216"></a>02216                                  <span class="stringliteral">&quot;INSERT INTO RepoGroup VALUES (?, ?, ?, ?)&quot;</span>,
<a name="l02217"></a>02217                                  4, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;int&quot;</span>, group_id,
<a name="l02218"></a>02218                                  <span class="stringliteral">&quot;string&quot;</span>, owner, <span class="stringliteral">&quot;string&quot;</span>, permission) &lt; 0)
<a name="l02219"></a>02219         <span class="keywordflow">return</span> -1;
<a name="l02220"></a>02220 
<a name="l02221"></a>02221     <span class="keywordflow">return</span> 0;
<a name="l02222"></a>02222 }
<a name="l02223"></a>02223 
<a name="l02224"></a>02224 <span class="keywordtype">int</span>
<a name="l02225"></a><a class="code" href="server_2repo-mgr_8h.html#a1085e1b2d057850d0a87132107a0e741">02225</a> <a class="code" href="server_2repo-mgr_8c.html#a1085e1b2d057850d0a87132107a0e741">seaf_repo_manager_del_group_repo</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02226"></a>02226                                   <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l02227"></a>02227                                   <span class="keywordtype">int</span> group_id,
<a name="l02228"></a>02228                                   GError **error)
<a name="l02229"></a>02229 {
<a name="l02230"></a>02230     <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l02231"></a>02231                                     <span class="stringliteral">&quot;DELETE FROM RepoGroup WHERE group_id=? &quot;</span>
<a name="l02232"></a>02232                                     <span class="stringliteral">&quot;AND repo_id=?&quot;</span>,
<a name="l02233"></a>02233                                     2, <span class="stringliteral">&quot;int&quot;</span>, group_id, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l02234"></a>02234 }
<a name="l02235"></a>02235 
<a name="l02236"></a>02236 <span class="keyword">static</span> gboolean
<a name="l02237"></a>02237 get_group_ids_cb (<a class="code" href="structSeafDBRow.html">SeafDBRow</a> *row, <span class="keywordtype">void</span> *data)
<a name="l02238"></a>02238 {
<a name="l02239"></a>02239     GList **plist = data;
<a name="l02240"></a>02240 
<a name="l02241"></a>02241     <span class="keywordtype">int</span> group_id = <a class="code" href="seaf-db_8c.html#a1a5b664c767155460f4f61cc7602f6f7">seaf_db_row_get_column_int</a> (row, 0);
<a name="l02242"></a>02242 
<a name="l02243"></a>02243     *plist = g_list_prepend (*plist, (gpointer)(<span class="keywordtype">long</span>)group_id);
<a name="l02244"></a>02244 
<a name="l02245"></a>02245     <span class="keywordflow">return</span> TRUE;
<a name="l02246"></a>02246 }
<a name="l02247"></a>02247 
<a name="l02248"></a>02248 GList *
<a name="l02249"></a><a class="code" href="server_2repo-mgr_8h.html#a404f7522a538d92d2ac68e49956a5a9b">02249</a> <a class="code" href="server_2repo-mgr_8c.html#a404f7522a538d92d2ac68e49956a5a9b">seaf_repo_manager_get_groups_by_repo</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02250"></a>02250                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l02251"></a>02251                                       GError **error)
<a name="l02252"></a>02252 {
<a name="l02253"></a>02253     <span class="keywordtype">char</span> *sql;
<a name="l02254"></a>02254     GList *group_ids = NULL;
<a name="l02255"></a>02255     
<a name="l02256"></a>02256     sql =  <span class="stringliteral">&quot;SELECT group_id FROM RepoGroup WHERE repo_id = ?&quot;</span>;
<a name="l02257"></a>02257     
<a name="l02258"></a>02258     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, get_group_ids_cb,
<a name="l02259"></a>02259                                        &amp;group_ids, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0) {
<a name="l02260"></a>02260         g_list_free (group_ids);
<a name="l02261"></a>02261         <span class="keywordflow">return</span> NULL;
<a name="l02262"></a>02262     }
<a name="l02263"></a>02263 
<a name="l02264"></a>02264     <span class="keywordflow">return</span> g_list_reverse (group_ids);
<a name="l02265"></a>02265 }
<a name="l02266"></a>02266 
<a name="l02267"></a>02267 <span class="keyword">static</span> gboolean
<a name="l02268"></a>02268 get_group_perms_cb (<a class="code" href="structSeafDBRow.html">SeafDBRow</a> *row, <span class="keywordtype">void</span> *data)
<a name="l02269"></a>02269 {
<a name="l02270"></a>02270     GList **plist = data;
<a name="l02271"></a>02271     <a class="code" href="structGroupPerm.html">GroupPerm</a> *perm = g_new0 (<a class="code" href="structGroupPerm.html">GroupPerm</a>, 1);
<a name="l02272"></a>02272 
<a name="l02273"></a>02273     perm-&gt;<a class="code" href="structGroupPerm.html#a3042c55692774424561f1dd69df5988d">group_id</a> = <a class="code" href="seaf-db_8c.html#a1a5b664c767155460f4f61cc7602f6f7">seaf_db_row_get_column_int</a> (row, 0);
<a name="l02274"></a>02274     <span class="keyword">const</span> <span class="keywordtype">char</span> *permission = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a>(row, 1);
<a name="l02275"></a>02275     g_strlcpy (perm-&gt;<a class="code" href="structGroupPerm.html#af6b38b561601355e005dac8c494b77d6">permission</a>, permission, <span class="keyword">sizeof</span>(perm-&gt;<a class="code" href="structGroupPerm.html#af6b38b561601355e005dac8c494b77d6">permission</a>));
<a name="l02276"></a>02276 
<a name="l02277"></a>02277     *plist = g_list_prepend (*plist, perm);
<a name="l02278"></a>02278 
<a name="l02279"></a>02279     <span class="keywordflow">return</span> TRUE;
<a name="l02280"></a>02280 }
<a name="l02281"></a>02281 
<a name="l02282"></a>02282 GList *
<a name="l02283"></a><a class="code" href="server_2repo-mgr_8h.html#a82d76d79aed153b9165b48e12dc2f2d0">02283</a> <a class="code" href="server_2repo-mgr_8c.html#a82d76d79aed153b9165b48e12dc2f2d0">seaf_repo_manager_get_group_perm_by_repo</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02284"></a>02284                                           <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l02285"></a>02285                                           GError **error)
<a name="l02286"></a>02286 {
<a name="l02287"></a>02287     <span class="keywordtype">char</span> *sql;
<a name="l02288"></a>02288     GList *group_perms = NULL, *p;
<a name="l02289"></a>02289     
<a name="l02290"></a>02290     sql = <span class="stringliteral">&quot;SELECT group_id, permission FROM RepoGroup WHERE repo_id = ?&quot;</span>;
<a name="l02291"></a>02291     
<a name="l02292"></a>02292     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, get_group_perms_cb,
<a name="l02293"></a>02293                                        &amp;group_perms, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0) {
<a name="l02294"></a>02294         <span class="keywordflow">for</span> (p = group_perms; p != NULL; p = p-&gt;next)
<a name="l02295"></a>02295             g_free (p-&gt;data);
<a name="l02296"></a>02296         g_list_free (group_perms);
<a name="l02297"></a>02297         <span class="keywordflow">return</span> NULL;
<a name="l02298"></a>02298     }
<a name="l02299"></a>02299 
<a name="l02300"></a>02300     <span class="keywordflow">return</span> g_list_reverse (group_perms);
<a name="l02301"></a>02301 }
<a name="l02302"></a>02302 
<a name="l02303"></a>02303 <span class="keywordtype">int</span>
<a name="l02304"></a><a class="code" href="server_2repo-mgr_8h.html#a6c5f4f43e7e198238b3b24dff3e9c389">02304</a> <a class="code" href="server_2repo-mgr_8c.html#a6c5f4f43e7e198238b3b24dff3e9c389">seaf_repo_manager_set_group_repo_perm</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02305"></a>02305                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l02306"></a>02306                                        <span class="keywordtype">int</span> group_id,
<a name="l02307"></a>02307                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *permission,
<a name="l02308"></a>02308                                        GError **error)
<a name="l02309"></a>02309 {
<a name="l02310"></a>02310     <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l02311"></a>02311                                     <span class="stringliteral">&quot;UPDATE RepoGroup SET permission=? WHERE &quot;</span>
<a name="l02312"></a>02312                                     <span class="stringliteral">&quot;repo_id=? AND group_id=?&quot;</span>,
<a name="l02313"></a>02313                                     3, <span class="stringliteral">&quot;string&quot;</span>, permission, <span class="stringliteral">&quot;string&quot;</span>, repo_id,
<a name="l02314"></a>02314                                     <span class="stringliteral">&quot;int&quot;</span>, group_id);
<a name="l02315"></a>02315 }
<a name="l02316"></a>02316 
<a name="l02317"></a>02317 <span class="keyword">static</span> gboolean
<a name="l02318"></a>02318 get_group_repoids_cb (<a class="code" href="structSeafDBRow.html">SeafDBRow</a> *row, <span class="keywordtype">void</span> *data)
<a name="l02319"></a>02319 {
<a name="l02320"></a>02320     GList **p_list = data;
<a name="l02321"></a>02321 
<a name="l02322"></a>02322     <span class="keywordtype">char</span> *repo_id = g_strdup ((<span class="keyword">const</span> <span class="keywordtype">char</span> *)<a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 0));
<a name="l02323"></a>02323 
<a name="l02324"></a>02324     *p_list = g_list_prepend (*p_list, repo_id);
<a name="l02325"></a>02325 
<a name="l02326"></a>02326     <span class="keywordflow">return</span> TRUE;
<a name="l02327"></a>02327 }
<a name="l02328"></a>02328 
<a name="l02329"></a>02329 GList *
<a name="l02330"></a><a class="code" href="server_2repo-mgr_8h.html#a8e5e47e57afc5432400aeac4e42494b3">02330</a> <a class="code" href="server_2repo-mgr_8c.html#a8e5e47e57afc5432400aeac4e42494b3">seaf_repo_manager_get_group_repoids</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02331"></a>02331                                      <span class="keywordtype">int</span> group_id,
<a name="l02332"></a>02332                                      GError **error)
<a name="l02333"></a>02333 {
<a name="l02334"></a>02334     <span class="keywordtype">char</span> *sql;
<a name="l02335"></a>02335     GList *repo_ids = NULL;
<a name="l02336"></a>02336 
<a name="l02337"></a>02337     sql =  <span class="stringliteral">&quot;SELECT repo_id FROM RepoGroup WHERE group_id = ?&quot;</span>;
<a name="l02338"></a>02338     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, get_group_repoids_cb,
<a name="l02339"></a>02339                                        &amp;repo_ids, 1, <span class="stringliteral">&quot;int&quot;</span>, group_id) &lt; 0)
<a name="l02340"></a>02340         <span class="keywordflow">return</span> NULL;
<a name="l02341"></a>02341 
<a name="l02342"></a>02342     <span class="keywordflow">return</span> g_list_reverse (repo_ids);
<a name="l02343"></a>02343 }
<a name="l02344"></a>02344 
<a name="l02345"></a>02345 <span class="keyword">static</span> gboolean
<a name="l02346"></a>02346 get_group_repos_cb (<a class="code" href="structSeafDBRow.html">SeafDBRow</a> *row, <span class="keywordtype">void</span> *data)
<a name="l02347"></a>02347 {
<a name="l02348"></a>02348     GList **p_list = data;
<a name="l02349"></a>02349     <a class="code" href="struct__SeafileSharedRepo.html">SeafileSharedRepo</a> *srepo = NULL;
<a name="l02350"></a>02350     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit;
<a name="l02351"></a>02351     
<a name="l02352"></a>02352     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 0);
<a name="l02353"></a>02353     <span class="keyword">const</span> <span class="keywordtype">char</span> *vrepo_id = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 1);
<a name="l02354"></a>02354     <span class="keywordtype">int</span> group_id = <a class="code" href="seaf-db_8c.html#a1a5b664c767155460f4f61cc7602f6f7">seaf_db_row_get_column_int</a> (row, 2);
<a name="l02355"></a>02355     <span class="keyword">const</span> <span class="keywordtype">char</span> *user_name = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 3);
<a name="l02356"></a>02356     <span class="keyword">const</span> <span class="keywordtype">char</span> *permission = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 4);
<a name="l02357"></a>02357     <span class="keyword">const</span> <span class="keywordtype">char</span> *commit_id = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 5);
<a name="l02358"></a>02358 
<a name="l02359"></a>02359     commit = <a class="code" href="commit-mgr_8c.html#af797c5d03d9c32cd3a4c5ebcf376a855">seaf_commit_manager_get_commit_compatible</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l02360"></a>02360                                                         repo_id,
<a name="l02361"></a>02361                                                         commit_id);
<a name="l02362"></a>02362     <span class="keywordflow">if</span> (!commit)
<a name="l02363"></a>02363         <span class="keywordflow">return</span> TRUE;
<a name="l02364"></a>02364 
<a name="l02365"></a>02365     <span class="keywordtype">char</span> *user_name_l = g_ascii_strdown (user_name, -1);
<a name="l02366"></a>02366 
<a name="l02367"></a>02367     srepo = g_object_new (<a class="code" href="repo_8c.html#aca1cb21876352b21731f8d77f2bfa5eb">SEAFILE_TYPE_SHARED_REPO</a>,
<a name="l02368"></a>02368                           <span class="stringliteral">&quot;share_type&quot;</span>, <span class="stringliteral">&quot;group&quot;</span>,
<a name="l02369"></a>02369                           <span class="stringliteral">&quot;repo_id&quot;</span>, repo_id,
<a name="l02370"></a>02370                           <span class="stringliteral">&quot;group_id&quot;</span>, group_id,
<a name="l02371"></a>02371                           <span class="stringliteral">&quot;user&quot;</span>, user_name_l,
<a name="l02372"></a>02372                           <span class="stringliteral">&quot;permission&quot;</span>, permission,
<a name="l02373"></a>02373                           <span class="stringliteral">&quot;repo_name&quot;</span>, commit-&gt;<a class="code" href="struct__SeafCommit.html#aacd7b88f8a3e72446cd7352396eaa09e">repo_name</a>,
<a name="l02374"></a>02374                           <span class="stringliteral">&quot;repo_desc&quot;</span>, commit-&gt;<a class="code" href="struct__SeafCommit.html#aa3d8e868c630cfbecbcb9158c4bbe2e4">repo_desc</a>,
<a name="l02375"></a>02375                           <span class="stringliteral">&quot;encrypted&quot;</span>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a906e77d2a658f4337437ff8694a4bfc0">encrypted</a>,
<a name="l02376"></a>02376                           <span class="stringliteral">&quot;last_modified&quot;</span>, commit-&gt;<a class="code" href="struct__SeafCommit.html#ae3f1657ab475921889a1e9c74b94e7a2">ctime</a>,
<a name="l02377"></a>02377                           <span class="stringliteral">&quot;is_virtual&quot;</span>, (vrepo_id != NULL),
<a name="l02378"></a>02378                           NULL);
<a name="l02379"></a>02379     g_free (user_name_l);
<a name="l02380"></a>02380     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
<a name="l02381"></a>02381 
<a name="l02382"></a>02382     <span class="keywordflow">if</span> (srepo != NULL) {
<a name="l02383"></a>02383         *p_list = g_list_prepend (*p_list, srepo);
<a name="l02384"></a>02384     }
<a name="l02385"></a>02385 
<a name="l02386"></a>02386     <span class="keywordflow">return</span> TRUE;
<a name="l02387"></a>02387 }
<a name="l02388"></a>02388 
<a name="l02389"></a>02389 GList *
<a name="l02390"></a><a class="code" href="server_2repo-mgr_8h.html#a9b3550e6d994e1ab95cbd65e454b8614">02390</a> <a class="code" href="server_2repo-mgr_8c.html#a9b3550e6d994e1ab95cbd65e454b8614">seaf_repo_manager_get_group_repos_by_owner</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02391"></a>02391                                             <span class="keyword">const</span> <span class="keywordtype">char</span> *owner,
<a name="l02392"></a>02392                                             GError **error)
<a name="l02393"></a>02393 {
<a name="l02394"></a>02394     <span class="keywordtype">char</span> *sql;
<a name="l02395"></a>02395     GList *repos = NULL;
<a name="l02396"></a>02396 
<a name="l02397"></a>02397     sql = <span class="stringliteral">&quot;SELECT RepoGroup.repo_id, VirtualRepo.repo_id, &quot;</span>
<a name="l02398"></a>02398         <span class="stringliteral">&quot;group_id, user_name, permission, commit_id &quot;</span>
<a name="l02399"></a>02399         <span class="stringliteral">&quot;FROM RepoGroup LEFT JOIN VirtualRepo ON &quot;</span>
<a name="l02400"></a>02400         <span class="stringliteral">&quot;RepoGroup.repo_id = VirtualRepo.repo_id, &quot;</span>
<a name="l02401"></a>02401         <span class="stringliteral">&quot;Branch &quot;</span>
<a name="l02402"></a>02402         <span class="stringliteral">&quot;WHERE user_name = ? AND &quot;</span>
<a name="l02403"></a>02403         <span class="stringliteral">&quot;RepoGroup.repo_id = Branch.repo_id AND &quot;</span>
<a name="l02404"></a>02404         <span class="stringliteral">&quot;Branch.name = &#39;master&#39;&quot;</span>;
<a name="l02405"></a>02405     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, get_group_repos_cb,
<a name="l02406"></a>02406                                        &amp;repos, 1, <span class="stringliteral">&quot;string&quot;</span>, owner) &lt; 0)
<a name="l02407"></a>02407         <span class="keywordflow">return</span> NULL;
<a name="l02408"></a>02408 
<a name="l02409"></a>02409     <span class="keywordflow">return</span> g_list_reverse (repos);
<a name="l02410"></a>02410 }
<a name="l02411"></a>02411 
<a name="l02412"></a>02412 <span class="keyword">static</span> gboolean
<a name="l02413"></a>02413 get_group_repo_owner (<a class="code" href="structSeafDBRow.html">SeafDBRow</a> *row, <span class="keywordtype">void</span> *data)
<a name="l02414"></a>02414 {
<a name="l02415"></a>02415     <span class="keywordtype">char</span> **share_from = data;
<a name="l02416"></a>02416 
<a name="l02417"></a>02417     <span class="keyword">const</span> <span class="keywordtype">char</span> *owner = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 0);
<a name="l02418"></a>02418     *share_from = g_ascii_strdown (owner, -1);
<a name="l02419"></a>02419     <span class="comment">/* There should be only one result. */</span>
<a name="l02420"></a>02420     <span class="keywordflow">return</span> FALSE;
<a name="l02421"></a>02421 }
<a name="l02422"></a>02422 
<a name="l02423"></a>02423 <span class="keywordtype">char</span> *
<a name="l02424"></a><a class="code" href="server_2repo-mgr_8h.html#a9ef2e3d497a572ee1642e6e6dc0c2977">02424</a> <a class="code" href="server_2repo-mgr_8c.html#a9ef2e3d497a572ee1642e6e6dc0c2977">seaf_repo_manager_get_group_repo_owner</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02425"></a>02425                                         <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l02426"></a>02426                                         GError **error)
<a name="l02427"></a>02427 {
<a name="l02428"></a>02428     <span class="keywordtype">char</span> *sql;
<a name="l02429"></a>02429     <span class="keywordtype">char</span> *ret = NULL;
<a name="l02430"></a>02430 
<a name="l02431"></a>02431     sql = <span class="stringliteral">&quot;SELECT user_name FROM RepoGroup WHERE repo_id = ?&quot;</span>;
<a name="l02432"></a>02432     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
<a name="l02433"></a>02433                                        get_group_repo_owner, &amp;ret,
<a name="l02434"></a>02434                                        1, <span class="stringliteral">&quot;string&quot;</span>, repo_id) &lt; 0) {
<a name="l02435"></a>02435         seaf_warning (<span class="stringliteral">&quot;DB error when get repo share from for repo %s.\n&quot;</span>,
<a name="l02436"></a>02436                    repo_id);
<a name="l02437"></a>02437         <span class="keywordflow">return</span> NULL;
<a name="l02438"></a>02438     }
<a name="l02439"></a>02439 
<a name="l02440"></a>02440     <span class="keywordflow">return</span> ret;
<a name="l02441"></a>02441 }
<a name="l02442"></a>02442 
<a name="l02443"></a>02443 <span class="keywordtype">int</span>
<a name="l02444"></a><a class="code" href="server_2repo-mgr_8h.html#a921cbac599e1c80869659e545d99b62f">02444</a> <a class="code" href="server_2repo-mgr_8c.html#a921cbac599e1c80869659e545d99b62f">seaf_repo_manager_remove_group_repos</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02445"></a>02445                                       <span class="keywordtype">int</span> group_id,
<a name="l02446"></a>02446                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *owner,
<a name="l02447"></a>02447                                       GError **error)
<a name="l02448"></a>02448 {
<a name="l02449"></a>02449     <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;
<a name="l02450"></a>02450     <span class="keywordtype">int</span> rc;
<a name="l02451"></a>02451 
<a name="l02452"></a>02452     <span class="keywordflow">if</span> (!owner) {
<a name="l02453"></a>02453         rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db, <span class="stringliteral">&quot;DELETE FROM RepoGroup WHERE group_id=?&quot;</span>,
<a name="l02454"></a>02454                                       1, <span class="stringliteral">&quot;int&quot;</span>, group_id);
<a name="l02455"></a>02455     } <span class="keywordflow">else</span> {
<a name="l02456"></a>02456         rc = <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db,
<a name="l02457"></a>02457                                       <span class="stringliteral">&quot;DELETE FROM RepoGroup WHERE group_id=? AND &quot;</span>
<a name="l02458"></a>02458                                       <span class="stringliteral">&quot;user_name = ?&quot;</span>,
<a name="l02459"></a>02459                                       2, <span class="stringliteral">&quot;int&quot;</span>, group_id, <span class="stringliteral">&quot;string&quot;</span>, owner);
<a name="l02460"></a>02460     }
<a name="l02461"></a>02461 
<a name="l02462"></a>02462     <span class="keywordflow">return</span> rc;
<a name="l02463"></a>02463 }
<a name="l02464"></a>02464 
<a name="l02465"></a>02465 <span class="comment">/* Inner public repos */</span>
<a name="l02466"></a>02466 
<a name="l02467"></a>02467 <span class="keywordtype">int</span>
<a name="l02468"></a><a class="code" href="server_2repo-mgr_8h.html#ab4740f8bce8f9f3571adf0adfb63590b">02468</a> <a class="code" href="server_2repo-mgr_8c.html#ab4740f8bce8f9f3571adf0adfb63590b">seaf_repo_manager_set_inner_pub_repo</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02469"></a>02469                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l02470"></a>02470                                       <span class="keyword">const</span> <span class="keywordtype">char</span> *permission)
<a name="l02471"></a>02471 {
<a name="l02472"></a>02472     <a class="code" href="structSeafDB.html">SeafDB</a> *db = mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>;
<a name="l02473"></a>02473     <span class="keywordtype">char</span> sql[256];
<a name="l02474"></a>02474 
<a name="l02475"></a>02475     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae183a9c45ec082962bdd361491b0a8cb">seaf_db_type</a>(db) == <a class="code" href="seaf-db_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da62ce2e8a052406ede3fcf39ec407ccf8">SEAF_DB_TYPE_PGSQL</a>) {
<a name="l02476"></a>02476         gboolean err;
<a name="l02477"></a>02477         snprintf(sql, <span class="keyword">sizeof</span>(sql),
<a name="l02478"></a>02478                  <span class="stringliteral">&quot;SELECT repo_id FROM InnerPubRepo WHERE repo_id=&#39;%s&#39;&quot;</span>,
<a name="l02479"></a>02479                  repo_id);
<a name="l02480"></a>02480         <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#a6410cd243563343861ba3c6c16fc06a7">seaf_db_check_for_existence</a>(db, sql, &amp;err))
<a name="l02481"></a>02481             snprintf(sql, <span class="keyword">sizeof</span>(sql),
<a name="l02482"></a>02482                      <span class="stringliteral">&quot;UPDATE InnerPubRepo SET permission=&#39;%s&#39; &quot;</span>
<a name="l02483"></a>02483                      <span class="stringliteral">&quot;WHERE repo_id=&#39;%s&#39;&quot;</span>, permission, repo_id);
<a name="l02484"></a>02484         <span class="keywordflow">else</span>
<a name="l02485"></a>02485             snprintf(sql, <span class="keyword">sizeof</span>(sql),
<a name="l02486"></a>02486                      <span class="stringliteral">&quot;INSERT INTO InnerPubRepo VALUES &quot;</span>
<a name="l02487"></a>02487                      <span class="stringliteral">&quot;(&#39;%s&#39;, &#39;%s&#39;)&quot;</span>, repo_id, permission);
<a name="l02488"></a>02488         <span class="keywordflow">if</span> (err)
<a name="l02489"></a>02489             <span class="keywordflow">return</span> -1;
<a name="l02490"></a>02490         <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a07daa0cca6663aa1fde0faca4b77969d">seaf_db_query</a> (db, sql);
<a name="l02491"></a>02491     } <span class="keywordflow">else</span> {
<a name="l02492"></a>02492         <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (db,
<a name="l02493"></a>02493                                         <span class="stringliteral">&quot;REPLACE INTO InnerPubRepo VALUES (?, ?)&quot;</span>,
<a name="l02494"></a>02494                                         2, <span class="stringliteral">&quot;string&quot;</span>, repo_id, <span class="stringliteral">&quot;string&quot;</span>, permission);
<a name="l02495"></a>02495     }
<a name="l02496"></a>02496 
<a name="l02497"></a>02497     <span class="keywordflow">return</span> -1;
<a name="l02498"></a>02498 }
<a name="l02499"></a>02499 
<a name="l02500"></a>02500 <span class="keywordtype">int</span>
<a name="l02501"></a><a class="code" href="server_2repo-mgr_8h.html#a4a3708ac06f2c015cc665f5ba61ee36a">02501</a> <a class="code" href="server_2repo-mgr_8c.html#a4a3708ac06f2c015cc665f5ba61ee36a">seaf_repo_manager_unset_inner_pub_repo</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02502"></a>02502                                         <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l02503"></a>02503 {
<a name="l02504"></a>02504     <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a5b034a1fc119b2c3a989a03e7bb220e5">seaf_db_statement_query</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l02505"></a>02505                                     <span class="stringliteral">&quot;DELETE FROM InnerPubRepo WHERE repo_id = ?&quot;</span>,
<a name="l02506"></a>02506                                     1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l02507"></a>02507 }
<a name="l02508"></a>02508 
<a name="l02509"></a>02509 gboolean
<a name="l02510"></a><a class="code" href="server_2repo-mgr_8h.html#a4f04f29fd9180ef2982cc0d7bfeee5e4">02510</a> <a class="code" href="server_2repo-mgr_8c.html#a4f04f29fd9180ef2982cc0d7bfeee5e4">seaf_repo_manager_is_inner_pub_repo</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02511"></a>02511                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l02512"></a>02512 {
<a name="l02513"></a>02513     gboolean db_err = FALSE;
<a name="l02514"></a>02514 
<a name="l02515"></a>02515     <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#af77a76302b3316a4d71e418de27843c4">seaf_db_statement_exists</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>,
<a name="l02516"></a>02516                                      <span class="stringliteral">&quot;SELECT repo_id FROM InnerPubRepo WHERE repo_id=?&quot;</span>,
<a name="l02517"></a>02517                                      &amp;db_err, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l02518"></a>02518 }
<a name="l02519"></a>02519 
<a name="l02520"></a>02520 <span class="keyword">static</span> gboolean
<a name="l02521"></a>02521 collect_public_repos (<a class="code" href="structSeafDBRow.html">SeafDBRow</a> *row, <span class="keywordtype">void</span> *data)
<a name="l02522"></a>02522 {
<a name="l02523"></a>02523     GList **ret = (GList **)data;
<a name="l02524"></a>02524     <a class="code" href="struct__SeafileSharedRepo.html">SeafileSharedRepo</a> *srepo;
<a name="l02525"></a>02525     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id, *vrepo_id, *owner, *permission, *commit_id;
<a name="l02526"></a>02526     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit;
<a name="l02527"></a>02527 
<a name="l02528"></a>02528     repo_id = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 0);
<a name="l02529"></a>02529     vrepo_id = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 1);
<a name="l02530"></a>02530     owner = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 2);
<a name="l02531"></a>02531     permission = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 3);
<a name="l02532"></a>02532     commit_id = <a class="code" href="seaf-db_8c.html#a46219fd85b58550b735922b8afcf757c">seaf_db_row_get_column_text</a> (row, 4);
<a name="l02533"></a>02533 
<a name="l02534"></a>02534     commit = <a class="code" href="commit-mgr_8c.html#af797c5d03d9c32cd3a4c5ebcf376a855">seaf_commit_manager_get_commit_compatible</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l02535"></a>02535                                                         repo_id,
<a name="l02536"></a>02536                                                         commit_id);
<a name="l02537"></a>02537     <span class="keywordflow">if</span> (!commit)
<a name="l02538"></a>02538         <span class="keywordflow">return</span> TRUE;
<a name="l02539"></a>02539 
<a name="l02540"></a>02540     <span class="keywordtype">char</span> *owner_l = g_ascii_strdown (owner, -1);
<a name="l02541"></a>02541 
<a name="l02542"></a>02542     srepo = g_object_new (<a class="code" href="repo_8c.html#aca1cb21876352b21731f8d77f2bfa5eb">SEAFILE_TYPE_SHARED_REPO</a>,
<a name="l02543"></a>02543                           <span class="stringliteral">&quot;share_type&quot;</span>, <span class="stringliteral">&quot;public&quot;</span>,
<a name="l02544"></a>02544                           <span class="stringliteral">&quot;repo_id&quot;</span>, repo_id,
<a name="l02545"></a>02545                           <span class="stringliteral">&quot;permission&quot;</span>, permission,
<a name="l02546"></a>02546                           <span class="stringliteral">&quot;user&quot;</span>, owner_l,
<a name="l02547"></a>02547                           <span class="stringliteral">&quot;repo_name&quot;</span>, commit-&gt;<a class="code" href="struct__SeafCommit.html#aacd7b88f8a3e72446cd7352396eaa09e">repo_name</a>,
<a name="l02548"></a>02548                           <span class="stringliteral">&quot;repo_desc&quot;</span>, commit-&gt;<a class="code" href="struct__SeafCommit.html#aa3d8e868c630cfbecbcb9158c4bbe2e4">repo_desc</a>,
<a name="l02549"></a>02549                           <span class="stringliteral">&quot;encrypted&quot;</span>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a906e77d2a658f4337437ff8694a4bfc0">encrypted</a>,
<a name="l02550"></a>02550                           <span class="stringliteral">&quot;last_modified&quot;</span>, commit-&gt;<a class="code" href="struct__SeafCommit.html#ae3f1657ab475921889a1e9c74b94e7a2">ctime</a>,
<a name="l02551"></a>02551                           <span class="stringliteral">&quot;is_virtual&quot;</span>, (vrepo_id != NULL),
<a name="l02552"></a>02552                           NULL);
<a name="l02553"></a>02553     g_free (owner_l);
<a name="l02554"></a>02554     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
<a name="l02555"></a>02555 
<a name="l02556"></a>02556     *ret = g_list_prepend (*ret, srepo);
<a name="l02557"></a>02557 
<a name="l02558"></a>02558     <span class="keywordflow">return</span> TRUE;
<a name="l02559"></a>02559 }
<a name="l02560"></a>02560 
<a name="l02561"></a>02561 GList *
<a name="l02562"></a><a class="code" href="server_2repo-mgr_8h.html#a715b426c9fadfc393ece3afdec8587f7">02562</a> <a class="code" href="server_2repo-mgr_8c.html#a715b426c9fadfc393ece3afdec8587f7">seaf_repo_manager_list_inner_pub_repos</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr)
<a name="l02563"></a>02563 {
<a name="l02564"></a>02564     GList *ret = NULL, *p;
<a name="l02565"></a>02565     <span class="keywordtype">char</span> *sql;
<a name="l02566"></a>02566 
<a name="l02567"></a>02567     sql = <span class="stringliteral">&quot;SELECT InnerPubRepo.repo_id, VirtualRepo.repo_id, &quot;</span>
<a name="l02568"></a>02568         <span class="stringliteral">&quot;owner_id, permission, commit_id &quot;</span>
<a name="l02569"></a>02569         <span class="stringliteral">&quot;FROM InnerPubRepo LEFT JOIN VirtualRepo ON &quot;</span>
<a name="l02570"></a>02570         <span class="stringliteral">&quot;InnerPubRepo.repo_id=VirtualRepo.repo_id, RepoOwner, Branch &quot;</span>
<a name="l02571"></a>02571         <span class="stringliteral">&quot;WHERE InnerPubRepo.repo_id=RepoOwner.repo_id AND &quot;</span>
<a name="l02572"></a>02572         <span class="stringliteral">&quot;InnerPubRepo.repo_id = Branch.repo_id AND Branch.name = &#39;master&#39;&quot;</span>;
<a name="l02573"></a>02573 
<a name="l02574"></a>02574     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
<a name="l02575"></a>02575                                        collect_public_repos, &amp;ret,
<a name="l02576"></a>02576                                        0) &lt; 0) {
<a name="l02577"></a>02577         <span class="keywordflow">for</span> (p = ret; p != NULL; p = p-&gt;next)
<a name="l02578"></a>02578             g_object_unref (p-&gt;data);
<a name="l02579"></a>02579         g_list_free (ret);
<a name="l02580"></a>02580         <span class="keywordflow">return</span> NULL;
<a name="l02581"></a>02581     }
<a name="l02582"></a>02582 
<a name="l02583"></a>02583     <span class="keywordflow">return</span> g_list_reverse (ret);    
<a name="l02584"></a>02584 }
<a name="l02585"></a>02585 
<a name="l02586"></a>02586 gint64
<a name="l02587"></a><a class="code" href="server_2repo-mgr_8h.html#a2365b6daa6aef0d8476fa90f2aeca051">02587</a> <a class="code" href="server_2repo-mgr_8c.html#a2365b6daa6aef0d8476fa90f2aeca051">seaf_repo_manager_count_inner_pub_repos</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr)
<a name="l02588"></a>02588 {
<a name="l02589"></a>02589     <span class="keywordtype">char</span> sql[256];
<a name="l02590"></a>02590 
<a name="l02591"></a>02591     snprintf (sql, 256, <span class="stringliteral">&quot;SELECT COUNT(*) FROM InnerPubRepo&quot;</span>);
<a name="l02592"></a>02592 
<a name="l02593"></a>02593     <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a401edd7e7937648d96ffb06486097020">seaf_db_get_int64</a>(mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql);
<a name="l02594"></a>02594 }
<a name="l02595"></a>02595 
<a name="l02596"></a>02596 GList *
<a name="l02597"></a><a class="code" href="server_2repo-mgr_8h.html#a8be31ce1507a9a9fb63e15123961acdb">02597</a> <a class="code" href="server_2repo-mgr_8c.html#a8be31ce1507a9a9fb63e15123961acdb">seaf_repo_manager_list_inner_pub_repos_by_owner</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02598"></a>02598                                                  <span class="keyword">const</span> <span class="keywordtype">char</span> *user)
<a name="l02599"></a>02599 {
<a name="l02600"></a>02600     GList *ret = NULL, *p;
<a name="l02601"></a>02601     <span class="keywordtype">char</span> *sql;
<a name="l02602"></a>02602 
<a name="l02603"></a>02603     sql = <span class="stringliteral">&quot;SELECT InnerPubRepo.repo_id, VirtualRepo.repo_id, &quot;</span>
<a name="l02604"></a>02604         <span class="stringliteral">&quot;owner_id, permission, commit_id &quot;</span>
<a name="l02605"></a>02605         <span class="stringliteral">&quot;FROM InnerPubRepo LEFT JOIN VirtualRepo ON &quot;</span>
<a name="l02606"></a>02606         <span class="stringliteral">&quot;InnerPubRepo.repo_id=VirtualRepo.repo_id, RepoOwner, Branch &quot;</span>
<a name="l02607"></a>02607         <span class="stringliteral">&quot;WHERE InnerPubRepo.repo_id=RepoOwner.repo_id AND owner_id=? &quot;</span>
<a name="l02608"></a>02608         <span class="stringliteral">&quot;AND InnerPubRepo.repo_id = Branch.repo_id AND Branch.name = &#39;master&#39;&quot;</span>;
<a name="l02609"></a>02609 
<a name="l02610"></a>02610     <span class="keywordflow">if</span> (<a class="code" href="seaf-db_8c.html#ae0564388defaeffdf5628e60a074f224">seaf_db_statement_foreach_row</a> (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql,
<a name="l02611"></a>02611                                        collect_public_repos, &amp;ret,
<a name="l02612"></a>02612                                        1, <span class="stringliteral">&quot;string&quot;</span>, user) &lt; 0) {
<a name="l02613"></a>02613         <span class="keywordflow">for</span> (p = ret; p != NULL; p = p-&gt;next)
<a name="l02614"></a>02614             g_object_unref (p-&gt;data);
<a name="l02615"></a>02615         g_list_free (ret);
<a name="l02616"></a>02616         <span class="keywordflow">return</span> NULL;
<a name="l02617"></a>02617     }
<a name="l02618"></a>02618 
<a name="l02619"></a>02619     <span class="keywordflow">return</span> g_list_reverse (ret);    
<a name="l02620"></a>02620 }
<a name="l02621"></a>02621 
<a name="l02622"></a>02622 <span class="keywordtype">char</span> *
<a name="l02623"></a><a class="code" href="server_2repo-mgr_8h.html#a24cf3ec157b1edc047b115b28ee8bd0c">02623</a> <a class="code" href="server_2repo-mgr_8c.html#a24cf3ec157b1edc047b115b28ee8bd0c">seaf_repo_manager_get_inner_pub_repo_perm</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02624"></a>02624                                            <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l02625"></a>02625 {
<a name="l02626"></a>02626     <span class="keywordtype">char</span> *sql;
<a name="l02627"></a>02627 
<a name="l02628"></a>02628     sql = <span class="stringliteral">&quot;SELECT permission FROM InnerPubRepo WHERE repo_id=?&quot;</span>;
<a name="l02629"></a>02629     <span class="keywordflow">return</span> <a class="code" href="seaf-db_8c.html#a86087185f6d613c62c740d1f58cfb574">seaf_db_statement_get_string</a>(mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#a16f3c4659df75ed4fe76acba492f1865">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a840b013453371c1f53bb2eb3860b1b82">db</a>, sql, 1, <span class="stringliteral">&quot;string&quot;</span>, repo_id);
<a name="l02630"></a>02630 }
<a name="l02631"></a>02631 
<a name="l02632"></a>02632 
<a name="l02633"></a>02633 <span class="keywordtype">int</span>
<a name="l02634"></a><a class="code" href="server_2repo-mgr_8h.html#a7e2d25a533ae3eeced99134a7ffb5dbe">02634</a> <a class="code" href="server_2repo-mgr_8c.html#a7e2d25a533ae3eeced99134a7ffb5dbe">seaf_repo_manager_is_valid_filename</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02635"></a>02635                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l02636"></a>02636                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *filename,
<a name="l02637"></a>02637                                      GError **error)
<a name="l02638"></a>02638 {
<a name="l02639"></a>02639     <span class="keywordflow">if</span> (<a class="code" href="server_2repo-mgr_8c.html#a77f4492f1c388625ccf09d84f053913f">should_ignore_file</a>(filename, NULL))
<a name="l02640"></a>02640         <span class="keywordflow">return</span> 0;
<a name="l02641"></a>02641     <span class="keywordflow">else</span>
<a name="l02642"></a>02642         <span class="keywordflow">return</span> 1;
<a name="l02643"></a>02643 }
<a name="l02644"></a>02644 
<a name="l02645"></a>02645 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02646"></a>02646 create_repo_common (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02647"></a>02647                     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l02648"></a>02648                     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_name,
<a name="l02649"></a>02649                     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_desc,
<a name="l02650"></a>02650                     <span class="keyword">const</span> <span class="keywordtype">char</span> *user,
<a name="l02651"></a>02651                     <span class="keyword">const</span> <span class="keywordtype">char</span> *magic,
<a name="l02652"></a>02652                     <span class="keyword">const</span> <span class="keywordtype">char</span> *random_key,
<a name="l02653"></a>02653                     <span class="keywordtype">int</span> enc_version,
<a name="l02654"></a>02654                     GError **error)
<a name="l02655"></a>02655 {
<a name="l02656"></a>02656     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = NULL;
<a name="l02657"></a>02657     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit = NULL;
<a name="l02658"></a>02658     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *master = NULL;
<a name="l02659"></a>02659     <span class="keywordtype">int</span> ret = -1;
<a name="l02660"></a>02660 
<a name="l02661"></a>02661     <span class="keywordflow">if</span> (enc_version != 2 &amp;&amp; enc_version != -1) {
<a name="l02662"></a>02662         seaf_warning (<span class="stringliteral">&quot;Unsupported enc version %d.\n&quot;</span>, enc_version);
<a name="l02663"></a>02663         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
<a name="l02664"></a>02664                      <span class="stringliteral">&quot;Unsupported encryption version&quot;</span>);
<a name="l02665"></a>02665         <span class="keywordflow">return</span> -1;
<a name="l02666"></a>02666     }
<a name="l02667"></a>02667 
<a name="l02668"></a>02668     <span class="keywordflow">if</span> (enc_version == 2) {
<a name="l02669"></a>02669         <span class="keywordflow">if</span> (!magic || strlen(magic) != 64) {
<a name="l02670"></a>02670             seaf_warning (<span class="stringliteral">&quot;Bad magic.\n&quot;</span>);
<a name="l02671"></a>02671             g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
<a name="l02672"></a>02672                          <span class="stringliteral">&quot;Bad magic&quot;</span>);
<a name="l02673"></a>02673             <span class="keywordflow">return</span> -1;
<a name="l02674"></a>02674         }
<a name="l02675"></a>02675         <span class="keywordflow">if</span> (!random_key || strlen(random_key) != 96) {
<a name="l02676"></a>02676             seaf_warning (<span class="stringliteral">&quot;Bad random key.\n&quot;</span>);
<a name="l02677"></a>02677             g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
<a name="l02678"></a>02678                          <span class="stringliteral">&quot;Bad random key&quot;</span>);
<a name="l02679"></a>02679             <span class="keywordflow">return</span> -1;
<a name="l02680"></a>02680         }
<a name="l02681"></a>02681     }
<a name="l02682"></a>02682 
<a name="l02683"></a>02683     repo = <a class="code" href="daemon_2repo-mgr_8c.html#a63ab9fe4694e3d967376c911cbe2c655">seaf_repo_new</a> (repo_id, repo_name, repo_desc);
<a name="l02684"></a>02684 
<a name="l02685"></a>02685     repo-&gt;<a class="code" href="struct__SeafRepo.html#a4710aaee11c7887df402fffa7ca6c54f">no_local_history</a> = TRUE;
<a name="l02686"></a>02686     <span class="keywordflow">if</span> (enc_version == 2) {
<a name="l02687"></a>02687         repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a> = TRUE;
<a name="l02688"></a>02688         repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a> = enc_version;
<a name="l02689"></a>02689         memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab067d494e7ac35fb57f0a3c448e816d2">magic</a>, magic, 64);
<a name="l02690"></a>02690         memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#a83e0a2366ba320396f2deb6faa167b84">random_key</a>, random_key, 96);
<a name="l02691"></a>02691     }
<a name="l02692"></a>02692 
<a name="l02693"></a>02693     repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a> = <a class="code" href="seafile_2common_2common_8h.html#a23ab99328e95a2efa669ee1ac3d1b380">CURRENT_REPO_VERSION</a>;
<a name="l02694"></a>02694     memcpy (repo-&gt;<a class="code" href="struct__SeafRepo.html#a806d8d4c51581a0a06e7b675023178ae">store_id</a>, repo_id, 36);
<a name="l02695"></a>02695 
<a name="l02696"></a>02696     commit = <a class="code" href="commit-mgr_8c.html#afe68dfa15b1bbd8557b044b1b1b58dc2">seaf_commit_new</a> (NULL, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l02697"></a>02697                               <a class="code" href="seafile_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>, <span class="comment">/* root id */</span>
<a name="l02698"></a>02698                               user, <span class="comment">/* creator */</span>
<a name="l02699"></a>02699                               <a class="code" href="seafile_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>, <span class="comment">/* creator id */</span>
<a name="l02700"></a>02700                               repo_desc,  <span class="comment">/* description */</span>
<a name="l02701"></a>02701                               0);         <span class="comment">/* ctime */</span>
<a name="l02702"></a>02702 
<a name="l02703"></a>02703     <a class="code" href="daemon_2repo-mgr_8c.html#a39a9a41ffdfc324f3c935251d9e14d51">seaf_repo_to_commit</a> (repo, commit);
<a name="l02704"></a>02704     <span class="keywordflow">if</span> (<a class="code" href="commit-mgr_8c.html#a7c138604e615440b65741b77e71248c6">seaf_commit_manager_add_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>, commit) &lt; 0) {
<a name="l02705"></a>02705         seaf_warning (<span class="stringliteral">&quot;Failed to add commit.\n&quot;</span>);
<a name="l02706"></a>02706         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l02707"></a>02707                      <span class="stringliteral">&quot;Failed to add commit&quot;</span>);
<a name="l02708"></a>02708         <span class="keywordflow">goto</span> out;
<a name="l02709"></a>02709     }
<a name="l02710"></a>02710 
<a name="l02711"></a>02711     master = <a class="code" href="branch-mgr_8c.html#a4d213520d8a22d5191051715ccbfd1dd">seaf_branch_new</a> (<span class="stringliteral">&quot;master&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, commit-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>);
<a name="l02712"></a>02712     <span class="keywordflow">if</span> (<a class="code" href="branch-mgr_8c.html#ab67819118ec82d96e51f6c2cadd7a632">seaf_branch_manager_add_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, master) &lt; 0) {
<a name="l02713"></a>02713         seaf_warning (<span class="stringliteral">&quot;Failed to add branch.\n&quot;</span>);
<a name="l02714"></a>02714         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l02715"></a>02715                      <span class="stringliteral">&quot;Failed to add branch&quot;</span>);
<a name="l02716"></a>02716         <span class="keywordflow">goto</span> out;
<a name="l02717"></a>02717     }
<a name="l02718"></a>02718 
<a name="l02719"></a>02719     <span class="keywordflow">if</span> (<a class="code" href="daemon_2repo-mgr_8c.html#a6c47d6277897f6afbe866f2755f9762d">seaf_repo_set_head</a> (repo, master) &lt; 0) {
<a name="l02720"></a>02720         seaf_warning (<span class="stringliteral">&quot;Failed to set repo head.\n&quot;</span>);
<a name="l02721"></a>02721         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l02722"></a>02722                      <span class="stringliteral">&quot;Failed to set repo head.&quot;</span>);
<a name="l02723"></a>02723         <span class="keywordflow">goto</span> out;
<a name="l02724"></a>02724     }
<a name="l02725"></a>02725 
<a name="l02726"></a>02726     <span class="keywordflow">if</span> (<a class="code" href="daemon_2repo-mgr_8c.html#a140616a89d5a02935665f86cf3bb744c">seaf_repo_manager_add_repo</a> (mgr, repo) &lt; 0) {
<a name="l02727"></a>02727         seaf_warning (<span class="stringliteral">&quot;Failed to add repo.\n&quot;</span>);
<a name="l02728"></a>02728         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l02729"></a>02729                      <span class="stringliteral">&quot;Failed to add repo.&quot;</span>);
<a name="l02730"></a>02730         <span class="keywordflow">goto</span> out;
<a name="l02731"></a>02731     }
<a name="l02732"></a>02732 
<a name="l02733"></a>02733     ret = 0;
<a name="l02734"></a>02734 out:
<a name="l02735"></a>02735     <span class="keywordflow">if</span> (repo)
<a name="l02736"></a>02736         <a class="code" href="fuse_2repo-mgr_8c.html#af6bedb063685823d91f2a335c6882e07">seaf_repo_unref</a> (repo);
<a name="l02737"></a>02737     <span class="keywordflow">if</span> (commit)
<a name="l02738"></a>02738         <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (commit);
<a name="l02739"></a>02739     <span class="keywordflow">if</span> (master)
<a name="l02740"></a>02740         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (master);
<a name="l02741"></a>02741     
<a name="l02742"></a>02742     <span class="keywordflow">return</span> ret;    
<a name="l02743"></a>02743 }
<a name="l02744"></a>02744 
<a name="l02745"></a>02745 <span class="keywordtype">char</span> *
<a name="l02746"></a><a class="code" href="server_2repo-mgr_8h.html#a3706de93ba77e5068dba6a1dd073a0fd">02746</a> <a class="code" href="daemon_2repo-mgr_8c.html#ab599ba29e40bdb918ac78060d1165c2d">seaf_repo_manager_create_new_repo</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02747"></a>02747                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_name,
<a name="l02748"></a>02748                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_desc,
<a name="l02749"></a>02749                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *owner_email,
<a name="l02750"></a>02750                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *passwd,
<a name="l02751"></a>02751                                    GError **error)
<a name="l02752"></a>02752 {
<a name="l02753"></a>02753     <span class="keywordtype">char</span> *repo_id = NULL;
<a name="l02754"></a>02754     <span class="keywordtype">char</span> magic[65], random_key[97];
<a name="l02755"></a>02755 
<a name="l02756"></a>02756     repo_id = <a class="code" href="seafile_2lib_2utils_8c.html#af64020f0be33abde6a2a076ff9808809">gen_uuid</a> ();
<a name="l02757"></a>02757 
<a name="l02758"></a>02758     <span class="keywordflow">if</span> (passwd &amp;&amp; passwd[0] != 0) {
<a name="l02759"></a>02759         <a class="code" href="seafile-crypt_8c.html#a4f67d65d3f21019477c1a0d8d7ec2477">seafile_generate_magic</a> (2, repo_id, passwd, magic);
<a name="l02760"></a>02760         <a class="code" href="seafile-crypt_8c.html#ae58dda89366c1a52a611cee06b487f89">seafile_generate_random_key</a> (passwd, random_key);
<a name="l02761"></a>02761     }
<a name="l02762"></a>02762 
<a name="l02763"></a>02763     <span class="keywordtype">int</span> rc;
<a name="l02764"></a>02764     <span class="keywordflow">if</span> (passwd)
<a name="l02765"></a>02765         rc = create_repo_common (mgr, repo_id, repo_name, repo_desc, owner_email,
<a name="l02766"></a>02766                                  magic, random_key, <a class="code" href="seafile_2common_2common_8h.html#a79d3ddb90929fe8420a585a0105a50ec">CURRENT_ENC_VERSION</a>, error);
<a name="l02767"></a>02767     <span class="keywordflow">else</span>
<a name="l02768"></a>02768         rc = create_repo_common (mgr, repo_id, repo_name, repo_desc, owner_email,
<a name="l02769"></a>02769                                  NULL, NULL, -1, error);
<a name="l02770"></a>02770     <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l02771"></a>02771         <span class="keywordflow">goto</span> bad;
<a name="l02772"></a>02772 
<a name="l02773"></a>02773     <span class="keywordflow">if</span> (<a class="code" href="server_2repo-mgr_8c.html#a5f096821f41a339e41e9341fc0c4010d">seaf_repo_manager_set_repo_owner</a> (mgr, repo_id, owner_email) &lt; 0) {
<a name="l02774"></a>02774         seaf_warning (<span class="stringliteral">&quot;Failed to set repo owner.\n&quot;</span>);
<a name="l02775"></a>02775         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l02776"></a>02776                      <span class="stringliteral">&quot;Failed to set repo owner.&quot;</span>);
<a name="l02777"></a>02777         <span class="keywordflow">goto</span> bad;
<a name="l02778"></a>02778     }
<a name="l02779"></a>02779 
<a name="l02780"></a>02780     <span class="keywordflow">return</span> repo_id;
<a name="l02781"></a>02781     
<a name="l02782"></a>02782 bad:
<a name="l02783"></a>02783     <span class="keywordflow">if</span> (repo_id)
<a name="l02784"></a>02784         g_free (repo_id);
<a name="l02785"></a>02785     <span class="keywordflow">return</span> NULL;
<a name="l02786"></a>02786 }
<a name="l02787"></a>02787 
<a name="l02788"></a>02788 <span class="keywordtype">char</span> *
<a name="l02789"></a><a class="code" href="server_2repo-mgr_8h.html#ad9feaba8f2f873b6685560fd86f4c40d">02789</a> <a class="code" href="server_2repo-mgr_8c.html#ad9feaba8f2f873b6685560fd86f4c40d">seaf_repo_manager_create_enc_repo</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02790"></a>02790                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l02791"></a>02791                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_name,
<a name="l02792"></a>02792                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_desc,
<a name="l02793"></a>02793                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *owner_email,
<a name="l02794"></a>02794                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *magic,
<a name="l02795"></a>02795                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *random_key,
<a name="l02796"></a>02796                                    <span class="keywordtype">int</span> enc_version,
<a name="l02797"></a>02797                                    GError **error)
<a name="l02798"></a>02798 {
<a name="l02799"></a>02799     <span class="keywordflow">if</span> (!repo_id || !<a class="code" href="seafile_2lib_2utils_8c.html#a48ecdc72b727191abafbbf2ec1f70ace">is_uuid_valid</a> (repo_id)) {
<a name="l02800"></a>02800         seaf_warning (<span class="stringliteral">&quot;Invalid repo_id.\n&quot;</span>);
<a name="l02801"></a>02801         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
<a name="l02802"></a>02802                      <span class="stringliteral">&quot;Invalid repo id&quot;</span>);
<a name="l02803"></a>02803         <span class="keywordflow">return</span> NULL;
<a name="l02804"></a>02804     }
<a name="l02805"></a>02805 
<a name="l02806"></a>02806     <span class="keywordflow">if</span> (<a class="code" href="daemon_2repo-mgr_8c.html#a4b2497e6cdde50c4ce3cb642370e06eb">seaf_repo_manager_repo_exists</a> (mgr, repo_id)) {
<a name="l02807"></a>02807         seaf_warning (<span class="stringliteral">&quot;Repo %s exists, refuse to create.\n&quot;</span>, repo_id);
<a name="l02808"></a>02808         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#acf817c9ac99e8c572fa9ed3648a7db66">SEAF_ERR_BAD_ARGS</a>,
<a name="l02809"></a>02809                      <span class="stringliteral">&quot;Repo already exists&quot;</span>);
<a name="l02810"></a>02810         <span class="keywordflow">return</span> NULL;
<a name="l02811"></a>02811     }
<a name="l02812"></a>02812 
<a name="l02813"></a>02813     <span class="keywordflow">if</span> (create_repo_common (mgr, repo_id, repo_name, repo_desc, owner_email,
<a name="l02814"></a>02814                             magic, random_key, enc_version, error) &lt; 0)
<a name="l02815"></a>02815         <span class="keywordflow">return</span> NULL;
<a name="l02816"></a>02816 
<a name="l02817"></a>02817     <span class="keywordflow">if</span> (<a class="code" href="server_2repo-mgr_8c.html#a5f096821f41a339e41e9341fc0c4010d">seaf_repo_manager_set_repo_owner</a> (mgr, repo_id, owner_email) &lt; 0) {
<a name="l02818"></a>02818         seaf_warning (<span class="stringliteral">&quot;Failed to set repo owner.\n&quot;</span>);
<a name="l02819"></a>02819         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a88b2b3e2f6be1400399fbb41c341f1cd">SEAF_ERR_GENERAL</a>,
<a name="l02820"></a>02820                      <span class="stringliteral">&quot;Failed to set repo owner.&quot;</span>);
<a name="l02821"></a>02821         <span class="keywordflow">return</span> NULL;
<a name="l02822"></a>02822     }
<a name="l02823"></a>02823 
<a name="l02824"></a>02824     <span class="keywordflow">return</span> g_strdup (repo_id);
<a name="l02825"></a>02825 }
<a name="l02826"></a>02826 
<a name="l02827"></a>02827 <span class="keyword">static</span> <span class="keywordtype">int</span> reap_token (<span class="keywordtype">void</span> *data)
<a name="l02828"></a>02828 {
<a name="l02829"></a>02829     <a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr = data;
<a name="l02830"></a>02830     GHashTableIter iter;
<a name="l02831"></a>02831     gpointer key, value;
<a name="l02832"></a>02832     <a class="code" href="structDecryptedToken.html">DecryptedToken</a> *t;
<a name="l02833"></a>02833 
<a name="l02834"></a>02834     pthread_rwlock_wrlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);
<a name="l02835"></a>02835 
<a name="l02836"></a>02836     gint64 now = (gint64)time(NULL);
<a name="l02837"></a>02837 
<a name="l02838"></a>02838     g_hash_table_iter_init (&amp;iter, mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a000e23969980c4dcc63654c2fd0e37d0">decrypted_tokens</a>);
<a name="l02839"></a>02839     <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
<a name="l02840"></a>02840         t = value;
<a name="l02841"></a>02841         <span class="keywordflow">if</span> (now &gt;= t-&gt;<a class="code" href="structDecryptedToken.html#ac28926407787ff9b8f9e85f677c02447">reap_time</a>)
<a name="l02842"></a>02842             g_hash_table_iter_remove (&amp;iter);
<a name="l02843"></a>02843     }
<a name="l02844"></a>02844 
<a name="l02845"></a>02845     pthread_rwlock_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);
<a name="l02846"></a>02846 
<a name="l02847"></a>02847     <span class="keywordflow">return</span> TRUE;
<a name="l02848"></a>02848 }
<a name="l02849"></a>02849 
<a name="l02850"></a>02850 <span class="keyword">static</span> <span class="keywordtype">void</span> decrypted_token_free (<a class="code" href="structDecryptedToken.html">DecryptedToken</a> *token)
<a name="l02851"></a>02851 {
<a name="l02852"></a>02852     <span class="keywordflow">if</span> (!token)
<a name="l02853"></a>02853         <span class="keywordflow">return</span>;
<a name="l02854"></a>02854     g_free (token-&gt;<a class="code" href="structDecryptedToken.html#a616524db801f9ed7ee2b7b9095bf7cd1">token</a>);
<a name="l02855"></a>02855     g_free (token);
<a name="l02856"></a>02856 }
<a name="l02857"></a>02857 
<a name="l02858"></a>02858 <span class="keywordtype">void</span>
<a name="l02859"></a><a class="code" href="server_2repo-mgr_8h.html#a26b82474124b9be618ec1564097e5e95">02859</a> <a class="code" href="server_2repo-mgr_8c.html#a26b82474124b9be618ec1564097e5e95">seaf_repo_manager_add_decrypted_token</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02860"></a>02860                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *encrypted_token,
<a name="l02861"></a>02861                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *session_key,
<a name="l02862"></a>02862                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *decrypted_token)
<a name="l02863"></a>02863 {
<a name="l02864"></a>02864     <span class="keywordtype">char</span> key[256];
<a name="l02865"></a>02865     <a class="code" href="structDecryptedToken.html">DecryptedToken</a> *token;
<a name="l02866"></a>02866 
<a name="l02867"></a>02867     snprintf (key, <span class="keyword">sizeof</span>(key), <span class="stringliteral">&quot;%s%s&quot;</span>, encrypted_token, session_key);
<a name="l02868"></a>02868     key[255] = 0;
<a name="l02869"></a>02869 
<a name="l02870"></a>02870     pthread_rwlock_wrlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);
<a name="l02871"></a>02871 
<a name="l02872"></a>02872     token = g_new0 (<a class="code" href="structDecryptedToken.html">DecryptedToken</a>, 1);
<a name="l02873"></a>02873     token-&gt;<a class="code" href="structDecryptedToken.html#a616524db801f9ed7ee2b7b9095bf7cd1">token</a> = g_strdup(decrypted_token);
<a name="l02874"></a>02874     token-&gt;<a class="code" href="structDecryptedToken.html#ac28926407787ff9b8f9e85f677c02447">reap_time</a> = (gint64)time(NULL) + <a class="code" href="server_2repo-mgr_8c.html#a6e0d8a1f0eba39caca9c0b6745241644">DECRYPTED_TOKEN_TTL</a>;
<a name="l02875"></a>02875 
<a name="l02876"></a>02876     g_hash_table_insert (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a000e23969980c4dcc63654c2fd0e37d0">decrypted_tokens</a>,
<a name="l02877"></a>02877                          g_strdup(key),
<a name="l02878"></a>02878                          token);
<a name="l02879"></a>02879 
<a name="l02880"></a>02880     pthread_rwlock_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);
<a name="l02881"></a>02881 }
<a name="l02882"></a>02882 
<a name="l02883"></a>02883 <span class="keywordtype">char</span> *
<a name="l02884"></a><a class="code" href="server_2repo-mgr_8h.html#af52386548dacb8d7b466e1c75c79a208">02884</a> <a class="code" href="server_2repo-mgr_8c.html#af52386548dacb8d7b466e1c75c79a208">seaf_repo_manager_get_decrypted_token</a> (<a class="code" href="struct__SeafRepoManager.html">SeafRepoManager</a> *mgr,
<a name="l02885"></a>02885                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *encrypted_token,
<a name="l02886"></a>02886                                        <span class="keyword">const</span> <span class="keywordtype">char</span> *session_key)
<a name="l02887"></a>02887 {
<a name="l02888"></a>02888     <span class="keywordtype">char</span> key[256];
<a name="l02889"></a>02889     <a class="code" href="structDecryptedToken.html">DecryptedToken</a> *token;
<a name="l02890"></a>02890 
<a name="l02891"></a>02891     snprintf (key, <span class="keyword">sizeof</span>(key), <span class="stringliteral">&quot;%s%s&quot;</span>, encrypted_token, session_key);
<a name="l02892"></a>02892     key[255] = 0;
<a name="l02893"></a>02893 
<a name="l02894"></a>02894     pthread_rwlock_rdlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);
<a name="l02895"></a>02895     token = g_hash_table_lookup (mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a000e23969980c4dcc63654c2fd0e37d0">decrypted_tokens</a>, key);
<a name="l02896"></a>02896     pthread_rwlock_unlock (&amp;mgr-&gt;<a class="code" href="struct__SeafRepoManager.html#afeb589ad01ce0797c851f27b348c94ad">priv</a>-&gt;<a class="code" href="struct__SeafRepoManagerPriv.html#a04dfb93d633d71ac87e6f61174db0cc3">lock</a>);
<a name="l02897"></a>02897 
<a name="l02898"></a>02898     <span class="keywordflow">if</span> (token)
<a name="l02899"></a>02899         <span class="keywordflow">return</span> g_strdup(token-&gt;<a class="code" href="structDecryptedToken.html#a616524db801f9ed7ee2b7b9095bf7cd1">token</a>);
<a name="l02900"></a>02900     <span class="keywordflow">return</span> NULL;
<a name="l02901"></a>02901 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Wed Aug 19 2015 02:46:10 for My Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
