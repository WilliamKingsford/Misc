<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>My Project: seafile/daemon/sync-mgr.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">My Project
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">seafile/daemon/sync-mgr.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="sync-mgr_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 <span class="preprocessor">#include &quot;common.h&quot;</span>
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;<a class="code" href="ccnet_8h.html">ccnet.h</a>&gt;</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="preprocessor">#include &quot;db.h&quot;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;<a class="code" href="daemon_2seafile-session_8h.html">seafile-session.h</a>&quot;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &quot;<a class="code" href="seafile-config_8h.html">seafile-config.h</a>&quot;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &quot;<a class="code" href="sync-mgr_8h.html">sync-mgr.h</a>&quot;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="transfer-mgr_8h.html">transfer-mgr.h</a>&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="sync-repo-proc_8h.html">processors/sync-repo-proc.h</a>&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="getca-proc_8h.html">processors/getca-proc.h</a>&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;<a class="code" href="check-protocol-proc_8h.html">processors/check-protocol-proc.h</a>&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;<a class="code" href="vc-common_8h.html">vc-common.h</a>&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="seafile-error_8h.html">seafile-error.h</a>&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="status_8h.html">status.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="mq-mgr_8h.html">mq-mgr.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;utils.h&quot;</span>
<a name="l00021"></a>00021 
<a name="l00022"></a><a class="code" href="sync-mgr_8c.html#a05d1af42442c934b555896d3fe55c79e">00022</a> <span class="preprocessor">#define DEBUG_FLAG SEAFILE_DEBUG_SYNC</span>
<a name="l00023"></a>00023 <span class="preprocessor"></span><span class="preprocessor">#include &quot;log.h&quot;</span>
<a name="l00024"></a>00024 
<a name="l00025"></a><a class="code" href="sync-mgr_8c.html#abedb0ac48612d533360b213b5596259a">00025</a> <span class="preprocessor">#define DEFAULT_SYNC_INTERVAL 30 </span><span class="comment">/* 30s */</span>
<a name="l00026"></a><a class="code" href="sync-mgr_8c.html#a10a0b7b6d015d053a6fff2b5101455e6">00026</a> <span class="preprocessor">#define CHECK_SYNC_INTERVAL  1000 </span><span class="comment">/* 1s */</span>
<a name="l00027"></a><a class="code" href="sync-mgr_8c.html#a9d14e39f5a26e739b3843777ae399f64">00027</a> <span class="preprocessor">#define UPDATE_TX_STATE_INTERVAL 1000 </span><span class="comment">/* 1s */</span>
<a name="l00028"></a><a class="code" href="sync-mgr_8c.html#ac5eb49751413cb3c490eb13809ac13c6">00028</a> <span class="preprocessor">#define MAX_RUNNING_SYNC_TASKS 5</span>
<a name="l00029"></a><a class="code" href="sync-mgr_8c.html#ad6282372227e4cf10c44911b384f5a14">00029</a> <span class="preprocessor"></span><span class="preprocessor">#define CHECK_LOCKED_FILES_INTERVAL 10 </span><span class="comment">/* 10s */</span>
<a name="l00030"></a><a class="code" href="sync-mgr_8c.html#af65ba0d46a26859a25127a6d03efd5b4">00030</a> <span class="preprocessor">#define CHECK_FOLDER_PERMS_INTERVAL 30 </span><span class="comment">/* 30s */</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="keyword">enum</span> {
<a name="l00033"></a><a class="code" href="sync-mgr_8c.html#a16685eea158879e41b101ca3634de462a6c21229b0a45dd28406c0072669f5a65">00033</a>     <a class="code" href="sync-mgr_8c.html#a16685eea158879e41b101ca3634de462a6c21229b0a45dd28406c0072669f5a65">SERVER_SIDE_MERGE_UNKNOWN</a> = 0,
<a name="l00034"></a><a class="code" href="sync-mgr_8c.html#a16685eea158879e41b101ca3634de462aa9a54f83b0490bef2294e496c9e758f9">00034</a>     <a class="code" href="sync-mgr_8c.html#a16685eea158879e41b101ca3634de462aa9a54f83b0490bef2294e496c9e758f9">SERVER_SIDE_MERGE_SUPPORTED</a>,
<a name="l00035"></a><a class="code" href="sync-mgr_8c.html#a16685eea158879e41b101ca3634de462ac2a0c6479a5c92919e0138492de300bf">00035</a>     <a class="code" href="sync-mgr_8c.html#a16685eea158879e41b101ca3634de462ac2a0c6479a5c92919e0138492de300bf">SERVER_SIDE_MERGE_UNSUPPORTED</a>,
<a name="l00036"></a>00036 };
<a name="l00037"></a>00037 
<a name="l00038"></a><a class="code" href="struct__ServerState.html">00038</a> <span class="keyword">struct </span><a class="code" href="struct__ServerState.html">_ServerState</a> {
<a name="l00039"></a><a class="code" href="struct__ServerState.html#adb0ef1901e8918aaa2a1e2ee5468b479">00039</a>     <span class="keywordtype">int</span> <a class="code" href="struct__ServerState.html#adb0ef1901e8918aaa2a1e2ee5468b479">server_side_merge</a>;
<a name="l00040"></a><a class="code" href="struct__ServerState.html#a178babd4576d9ccf17ac0ccd640c4a27">00040</a>     gboolean <a class="code" href="struct__ServerState.html#a178babd4576d9ccf17ac0ccd640c4a27">checking</a>;
<a name="l00041"></a>00041 };
<a name="l00042"></a><a class="code" href="sync-mgr_8c.html#ab041cfa4613f765c04c67d86a27ee61b">00042</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__ServerState.html">_ServerState</a> <a class="code" href="struct__ServerState.html">ServerState</a>;
<a name="l00043"></a>00043 
<a name="l00044"></a><a class="code" href="struct__HttpServerState.html">00044</a> <span class="keyword">struct </span><a class="code" href="struct__HttpServerState.html">_HttpServerState</a> {
<a name="l00045"></a><a class="code" href="struct__HttpServerState.html#a86d68d7c613b0b4a08e3e53ee44f129b">00045</a>     gboolean <a class="code" href="struct__HttpServerState.html#a86d68d7c613b0b4a08e3e53ee44f129b">http_not_supported</a>;
<a name="l00046"></a><a class="code" href="struct__HttpServerState.html#abca94be9f168b0a44234314ad1e0d00b">00046</a>     <span class="keywordtype">int</span> <a class="code" href="struct__HttpServerState.html#abca94be9f168b0a44234314ad1e0d00b">http_version</a>;
<a name="l00047"></a><a class="code" href="struct__HttpServerState.html#a3addf09bb7110d3c0abb9e223be2f532">00047</a>     gboolean <a class="code" href="struct__HttpServerState.html#a3addf09bb7110d3c0abb9e223be2f532">checking</a>;
<a name="l00048"></a>00048 
<a name="l00049"></a><a class="code" href="struct__HttpServerState.html#a30f8aae98bdf6115f7a68461936e7888">00049</a>     gboolean <a class="code" href="struct__HttpServerState.html#a30f8aae98bdf6115f7a68461936e7888">folder_perms_not_supported</a>;
<a name="l00050"></a><a class="code" href="struct__HttpServerState.html#a0b28daa3819543642d186ab8f2bddc54">00050</a>     gint64 <a class="code" href="struct__HttpServerState.html#a0b28daa3819543642d186ab8f2bddc54">last_check_perms_time</a>;
<a name="l00051"></a><a class="code" href="struct__HttpServerState.html#a2c37a6a8ad57661b1f8143b3a47b80c6">00051</a>     gboolean <a class="code" href="struct__HttpServerState.html#a2c37a6a8ad57661b1f8143b3a47b80c6">checking_folder_perms</a>;
<a name="l00052"></a>00052 };
<a name="l00053"></a><a class="code" href="sync-mgr_8c.html#afd8d15ece973e7bf47e99e19c8e5a92f">00053</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__HttpServerState.html">_HttpServerState</a> <a class="code" href="struct__HttpServerState.html">HttpServerState</a>;
<a name="l00054"></a>00054 
<a name="l00055"></a><a class="code" href="struct__SeafSyncManagerPriv.html">00055</a> <span class="keyword">struct </span><a class="code" href="struct__SeafSyncManagerPriv.html">_SeafSyncManagerPriv</a> {
<a name="l00056"></a><a class="code" href="struct__SeafSyncManagerPriv.html#af5cc60aaed95c9af8f98eb250bf86539">00056</a>     <span class="keyword">struct </span><a class="code" href="structCcnetTimer.html">CcnetTimer</a> *<a class="code" href="struct__SeafSyncManagerPriv.html#af5cc60aaed95c9af8f98eb250bf86539">check_sync_timer</a>;
<a name="l00057"></a><a class="code" href="struct__SeafSyncManagerPriv.html#a8fe398da116c1473125cde74cf229811">00057</a>     <span class="keyword">struct </span><a class="code" href="structCcnetTimer.html">CcnetTimer</a> *<a class="code" href="struct__SeafSyncManagerPriv.html#a8fe398da116c1473125cde74cf229811">update_tx_state_timer</a>;
<a name="l00058"></a><a class="code" href="struct__SeafSyncManagerPriv.html#a28ae360e3481964e9c0bf4ecf66ff256">00058</a>     <span class="keywordtype">int</span>    <a class="code" href="struct__SeafSyncManagerPriv.html#a28ae360e3481964e9c0bf4ecf66ff256">pulse_count</a>;
<a name="l00059"></a>00059 
<a name="l00060"></a>00060     <span class="comment">/* When FALSE, auto sync is globally disabled */</span>
<a name="l00061"></a><a class="code" href="struct__SeafSyncManagerPriv.html#a3719d42c83ff26e39db5f7141d4bae54">00061</a>     gboolean   <a class="code" href="struct__SeafSyncManagerPriv.html#a3719d42c83ff26e39db5f7141d4bae54">auto_sync_enabled</a>;
<a name="l00062"></a>00062 };
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00065"></a>00065 start_sync (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager, <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo,
<a name="l00066"></a>00066             gboolean need_commit, gboolean is_manual_sync,
<a name="l00067"></a>00067             gboolean is_initial_commit);
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="keyword">static</span> <span class="keywordtype">int</span> auto_sync_pulse (<span class="keywordtype">void</span> *vmanager);
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="keyword">static</span> <span class="keywordtype">void</span> on_repo_fetched (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>,
<a name="l00072"></a>00072                              <a class="code" href="struct__TransferTask.html">TransferTask</a> *tx_task,
<a name="l00073"></a>00073                              <a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager);
<a name="l00074"></a>00074 <span class="keyword">static</span> <span class="keywordtype">void</span> on_repo_uploaded (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>,
<a name="l00075"></a>00075                               <a class="code" href="struct__TransferTask.html">TransferTask</a> *tx_task,
<a name="l00076"></a>00076                               <a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager);
<a name="l00077"></a>00077 <span class="keyword">static</span> <span class="keywordtype">void</span> on_repo_http_fetched (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>,
<a name="l00078"></a>00078                                   <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *tx_task,
<a name="l00079"></a>00079                                   <a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager);
<a name="l00080"></a>00080 <span class="keyword">static</span> <span class="keywordtype">void</span> on_repo_http_uploaded (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>,
<a name="l00081"></a>00081                                    <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *tx_task,
<a name="l00082"></a>00082                                    <a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager);
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00085"></a>00085 transition_sync_state (<a class="code" href="struct__SyncTask.html">SyncTask</a> *task, <span class="keywordtype">int</span> new_state);
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="keyword">static</span> <span class="keywordtype">void</span> sync_task_free (<a class="code" href="struct__SyncTask.html">SyncTask</a> *task);
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="keyword">static</span> gboolean
<a name="l00090"></a>00090 check_relay_status (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *mgr, <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo);
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 <span class="keyword">static</span> gboolean
<a name="l00093"></a>00093 has_old_commits_to_upload (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo);
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00096"></a>00096 sync_repo_v2 (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager, <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, gboolean is_manual_sync);
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="keyword">static</span> gboolean
<a name="l00099"></a>00099 check_http_protocol (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *mgr, <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, gboolean *is_checking);
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 <a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a>*
<a name="l00102"></a><a class="code" href="sync-mgr_8h.html#a959b922a0a6c15eaad8964999431929c">00102</a> <a class="code" href="sync-mgr_8c.html#a3a7160745ee3c4ccf7e25c5ac4a1c773">seaf_sync_manager_new</a> (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>)
<a name="l00103"></a>00103 {
<a name="l00104"></a>00104     <a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *mgr = g_new0 (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a>, 1);
<a name="l00105"></a>00105     mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a98a501bc370a4c500ec8c0688896d9bb">priv</a> = g_new0 (<a class="code" href="struct__SeafSyncManagerPriv.html">SeafSyncManagerPriv</a>, 1);    
<a name="l00106"></a>00106     mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a98a501bc370a4c500ec8c0688896d9bb">priv</a>-&gt;<a class="code" href="struct__SeafSyncManagerPriv.html#a3719d42c83ff26e39db5f7141d4bae54">auto_sync_enabled</a> = TRUE;
<a name="l00107"></a>00107     mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a15dbbff6ec86d385b4fbfcd5605b1112">seaf</a> = <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>;
<a name="l00108"></a>00108 
<a name="l00109"></a>00109     mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a318c269683fe0c9b9acee8734765fa47">sync_interval</a> = <a class="code" href="sync-mgr_8c.html#abedb0ac48612d533360b213b5596259a">DEFAULT_SYNC_INTERVAL</a>;
<a name="l00110"></a>00110     mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a3b638d371d53219f1169c85bdc716727">sync_infos</a> = g_hash_table_new (g_str_hash, g_str_equal);
<a name="l00111"></a>00111 
<a name="l00112"></a>00112     mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a623ff0c818f5d0d7da880cdba6700bce">server_states</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
<a name="l00113"></a>00113                                                 g_free, g_free);
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a6c8c0f36f8e44feabd6cd44d6a4f49c1">http_server_states</a> = g_hash_table_new_full (g_str_hash, g_str_equal,
<a name="l00116"></a>00116                                                      g_free, g_free);
<a name="l00117"></a>00117 
<a name="l00118"></a>00118     gboolean exists;
<a name="l00119"></a>00119     <span class="keywordtype">int</span> download_limit = <a class="code" href="seafile-config_8c.html#a1f9c83c8876aa6909a8568fb8ce73070">seafile_session_config_get_int</a> (seaf,
<a name="l00120"></a>00120                                                          <a class="code" href="seafile-config_8h.html#a5a48d3c4fabe714c6a09773f9b2e74a4">KEY_DOWNLOAD_LIMIT</a>,
<a name="l00121"></a>00121                                                          &amp;exists);
<a name="l00122"></a>00122     <span class="keywordflow">if</span> (exists)
<a name="l00123"></a>00123         mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a8ca07c4d618fb2c931b0fbc616a24a47">download_limit</a> = download_limit;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125     <span class="keywordtype">int</span> upload_limit = <a class="code" href="seafile-config_8c.html#a1f9c83c8876aa6909a8568fb8ce73070">seafile_session_config_get_int</a> (seaf,
<a name="l00126"></a>00126                                                        <a class="code" href="seafile-config_8h.html#a61546165efed667d83b2e9c26d492322">KEY_UPLOAD_LIMIT</a>,
<a name="l00127"></a>00127                                                        &amp;exists);
<a name="l00128"></a>00128     <span class="keywordflow">if</span> (exists)
<a name="l00129"></a>00129         mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#af27650b12e9237509a8b214808f18e21">upload_limit</a> = upload_limit;
<a name="l00130"></a>00130 
<a name="l00131"></a>00131     <span class="keywordflow">return</span> mgr;
<a name="l00132"></a>00132 }
<a name="l00133"></a>00133 
<a name="l00134"></a>00134 <span class="keyword">static</span> <a class="code" href="struct__SyncInfo.html">SyncInfo</a>*
<a name="l00135"></a>00135 get_sync_info (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager, <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l00136"></a>00136 {
<a name="l00137"></a>00137     <a class="code" href="struct__SyncInfo.html">SyncInfo</a> *info = g_hash_table_lookup (manager-&gt;<a class="code" href="struct__SeafSyncManager.html#a3b638d371d53219f1169c85bdc716727">sync_infos</a>, repo_id);
<a name="l00138"></a>00138     <span class="keywordflow">if</span> (info) <span class="keywordflow">return</span> info;
<a name="l00139"></a>00139 
<a name="l00140"></a>00140     info = g_new0 (<a class="code" href="struct__SyncInfo.html">SyncInfo</a>, 1);
<a name="l00141"></a>00141     memcpy (info-&gt;<a class="code" href="struct__SyncInfo.html#a18a9302a6bb2f4e1b8e67171c9664c8b">repo_id</a>, repo_id, 41);
<a name="l00142"></a>00142     g_hash_table_insert (manager-&gt;<a class="code" href="struct__SeafSyncManager.html#a3b638d371d53219f1169c85bdc716727">sync_infos</a>, info-&gt;<a class="code" href="struct__SyncInfo.html#a18a9302a6bb2f4e1b8e67171c9664c8b">repo_id</a>, info);
<a name="l00143"></a>00143     <span class="keywordflow">return</span> info;
<a name="l00144"></a>00144 }
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 <a class="code" href="struct__SyncInfo.html">SyncInfo</a> *
<a name="l00147"></a><a class="code" href="sync-mgr_8h.html#afb758dbde64ac4505ad259f95601d45e">00147</a> <a class="code" href="sync-mgr_8c.html#afb758dbde64ac4505ad259f95601d45e">seaf_sync_manager_get_sync_info</a> (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *mgr,
<a name="l00148"></a>00148                                  <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l00149"></a>00149 {
<a name="l00150"></a>00150     <span class="keywordflow">return</span> g_hash_table_lookup (mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a3b638d371d53219f1169c85bdc716727">sync_infos</a>, repo_id);
<a name="l00151"></a>00151 }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 <span class="keywordtype">int</span>
<a name="l00154"></a><a class="code" href="sync-mgr_8h.html#a9778260aff4f730cf7b2da1fd2367e55">00154</a> <a class="code" href="sync-mgr_8c.html#a9778260aff4f730cf7b2da1fd2367e55">seaf_sync_manager_init</a> (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *mgr)
<a name="l00155"></a>00155 {
<a name="l00156"></a>00156     <span class="keywordflow">return</span> 0;
<a name="l00157"></a>00157 }
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 <span class="comment">/* In case ccnet relay info is lost(e.g. ~/ccnet is removed), we need to</span>
<a name="l00160"></a>00160 <span class="comment"> * re-add the relay by supplying addr:port</span>
<a name="l00161"></a>00161 <span class="comment"> */</span>
<a name="l00162"></a>00162 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00163"></a>00163 add_relay_if_needed (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l00164"></a>00164 {
<a name="l00165"></a>00165     <a class="code" href="struct__CcnetPeer.html">CcnetPeer</a> *relay = NULL;
<a name="l00166"></a>00166     <span class="keywordtype">char</span> *relay_port = NULL, *relay_addr = NULL;
<a name="l00167"></a>00167     GString *buf = NULL; 
<a name="l00168"></a>00168 
<a name="l00169"></a>00169     <a class="code" href="daemon_2repo-mgr_8c.html#a018177d17e765b6b8519f6537650e1cc">seaf_repo_manager_get_repo_relay_info</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l00170"></a>00170                                            &amp;relay_addr, &amp;relay_port);
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     relay = <a class="code" href="ccnet_8h.html#a136915227534e9204ffca3d7dc4d331e">ccnet_get_peer</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#add541d96cca483ad72ff56ad061d1d32">ccnetrpc_client</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>);
<a name="l00173"></a>00173     <span class="keywordflow">if</span> (relay) {
<a name="l00174"></a>00174         <span class="comment">/* no relay addr/port info in seafile db. This means we are</span>
<a name="l00175"></a>00175 <span class="comment">         * updating from an old version. */</span>
<a name="l00176"></a>00176         <span class="keywordflow">if</span> (!relay_addr || !relay_port) {
<a name="l00177"></a>00177             <span class="keywordflow">if</span> (relay-&gt;<a class="code" href="struct__CcnetPeer.html#a9a5ccac357bbe914955a9faf277c3459">public_addr</a> &amp;&amp; relay-&gt;<a class="code" href="struct__CcnetPeer.html#a386d17bb9a7bd07af29237484abf98e3">public_port</a>) {
<a name="l00178"></a>00178                 <span class="keywordtype">char</span> port[16];
<a name="l00179"></a>00179                 snprintf (port, <span class="keyword">sizeof</span>(port), <span class="stringliteral">&quot;%d&quot;</span>, relay-&gt;<a class="code" href="struct__CcnetPeer.html#a386d17bb9a7bd07af29237484abf98e3">public_port</a>);
<a name="l00180"></a>00180                 <a class="code" href="daemon_2repo-mgr_8c.html#a8539157b5ddbb1e183886ac3f03b0f0d">seaf_repo_manager_set_repo_relay_info</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l00181"></a>00181                                                        relay-&gt;<a class="code" href="struct__CcnetPeer.html#a9a5ccac357bbe914955a9faf277c3459">public_addr</a>, port);
<a name="l00182"></a>00182             }
<a name="l00183"></a>00183         }
<a name="l00184"></a>00184         <span class="keywordflow">goto</span> out;
<a name="l00185"></a>00185     }
<a name="l00186"></a>00186 
<a name="l00187"></a>00187     <span class="comment">/* relay info is lost in ccnet, but we have its addr:port in seafile.db */</span>
<a name="l00188"></a>00188     <span class="keywordflow">if</span> (relay_addr &amp;&amp; relay_port) {
<a name="l00189"></a>00189         buf = g_string_new(NULL);
<a name="l00190"></a>00190         g_string_append_printf (buf, <span class="stringliteral">&quot;add-relay --id %s --addr %s:%s&quot;</span>,
<a name="l00191"></a>00191                                 repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>, relay_addr, relay_port);
<a name="l00192"></a>00192                                                
<a name="l00193"></a>00193     } <span class="keywordflow">else</span> {
<a name="l00194"></a>00194         seaf_warning (<span class="stringliteral">&quot;[sync mgr] relay addr/port info&quot;</span>
<a name="l00195"></a>00195                       <span class="stringliteral">&quot; of repo %.10s is unknown\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00196"></a>00196     }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198     <span class="keywordflow">if</span> (buf) {
<a name="l00199"></a>00199         <a class="code" href="ccnet_8h.html#a7e0e66a5bbdd84284c8a524f467c1d6f">ccnet_send_command</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>, buf-&gt;str, NULL, NULL);
<a name="l00200"></a>00200     }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 out:
<a name="l00203"></a>00203     g_free (relay_addr);
<a name="l00204"></a>00204     g_free (relay_port);
<a name="l00205"></a>00205     <span class="keywordflow">if</span> (relay)
<a name="l00206"></a>00206         g_object_unref (relay);
<a name="l00207"></a>00207     <span class="keywordflow">if</span> (buf)
<a name="l00208"></a>00208         g_string_free (buf, TRUE);
<a name="l00209"></a>00209 }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00212"></a>00212 add_repo_relays ()
<a name="l00213"></a>00213 {
<a name="l00214"></a>00214     GList *ptr, *repo_list;
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     repo_list = <a class="code" href="daemon_2repo-mgr_8c.html#a5fe41fb7382995f3f335e408ba4ddb30">seaf_repo_manager_get_repo_list</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, 0, -1);
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     <span class="keywordflow">for</span> (ptr = repo_list; ptr; ptr = ptr-&gt;next) {
<a name="l00219"></a>00219         <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = ptr-&gt;data;
<a name="l00220"></a>00220         <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>) {
<a name="l00221"></a>00221             add_relay_if_needed (repo);
<a name="l00222"></a>00222         }
<a name="l00223"></a>00223     }
<a name="l00224"></a>00224 
<a name="l00225"></a>00225     g_list_free (repo_list);
<a name="l00226"></a>00226 }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 <span class="keyword">static</span> <span class="keywordtype">void</span> 
<a name="l00229"></a>00229 format_transfer_task_detail (<a class="code" href="struct__TransferTask.html">TransferTask</a> *task, GString *buf)
<a name="l00230"></a>00230 {
<a name="l00231"></a>00231     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> != <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceac3efc29c1793f3f902e002589c600b33">TASK_STATE_NORMAL</a> ||
<a name="l00232"></a>00232         task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> == <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300a27c8f8580beaf1e17a371eacafb2a305">TASK_RT_STATE_INIT</a> ||
<a name="l00233"></a>00233         task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> == <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300acaea6e8f567a83d7ddff12cade4af1d5">TASK_RT_STATE_FINISHED</a> ||
<a name="l00234"></a>00234         task-&gt;<a class="code" href="struct__TransferTask.html#ab22f3346d8667c07d449772a83e860fd">runtime_state</a> == <a class="code" href="transfer-mgr_8h.html#a67c6a75301d0b08cf078b0494e25a300abee3bb533aa834941c0ef1820a0aeec7">TASK_RT_STATE_NETDOWN</a>)
<a name="l00235"></a>00235         <span class="keywordflow">return</span>;
<a name="l00236"></a>00236 
<a name="l00237"></a>00237     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l00238"></a>00238                                                  task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>);
<a name="l00239"></a>00239     <span class="keywordtype">char</span> *repo_name;
<a name="l00240"></a>00240     <span class="keywordtype">char</span> *<a class="code" href="fs-mgr_8c.html#a65cfc9e13d3352fd9099a0408cba715c">type</a>;
<a name="l00241"></a>00241     
<a name="l00242"></a>00242     <span class="keywordflow">if</span> (repo) {
<a name="l00243"></a>00243         repo_name = repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>;
<a name="l00244"></a>00244         type = (task-&gt;<a class="code" href="struct__TransferTask.html#a5cb264f2074f78b92ac005633f412c24">type</a> == <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa800672fa26f828e725e4f6efe3dd7a67">TASK_TYPE_UPLOAD</a>) ? <span class="stringliteral">&quot;upload&quot;</span> : <span class="stringliteral">&quot;download&quot;</span>;
<a name="l00245"></a>00245         
<a name="l00246"></a>00246     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__TransferTask.html#a4462883da6780feae2b41060e5b48456">is_clone</a>) {
<a name="l00247"></a>00247         <a class="code" href="struct__CloneTask.html">CloneTask</a> *ctask;
<a name="l00248"></a>00248         ctask = <a class="code" href="clone-mgr_8c.html#acb26f43fecfbf4f3b0c81ea6f7a6195f">seaf_clone_manager_get_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a5c8bf74f127df80a600e36fbb19b696e">clone_mgr</a>, task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>);
<a name="l00249"></a>00249         repo_name = ctask-&gt;<a class="code" href="struct__CloneTask.html#af4f2887a7ddd497587e0bfbe0d51018f">repo_name</a>;
<a name="l00250"></a>00250         type = <span class="stringliteral">&quot;download&quot;</span>;
<a name="l00251"></a>00251         
<a name="l00252"></a>00252     } <span class="keywordflow">else</span> {
<a name="l00253"></a>00253         <span class="keywordflow">return</span>;
<a name="l00254"></a>00254     }
<a name="l00255"></a>00255     <span class="keywordtype">int</span> rate = <a class="code" href="transfer-mgr_8c.html#a02a3fa3f098edcc60cd0bd1340fa80e9">transfer_task_get_rate</a>(task);
<a name="l00256"></a>00256 
<a name="l00257"></a>00257     g_string_append_printf (buf, <span class="stringliteral">&quot;%s\t%d %s\n&quot;</span>, type, rate, repo_name);
<a name="l00258"></a>00258 }
<a name="l00259"></a>00259 
<a name="l00260"></a>00260 <span class="keyword">static</span> <span class="keywordtype">void</span> 
<a name="l00261"></a>00261 format_http_task_detail (<a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *task, GString *buf)
<a name="l00262"></a>00262 {
<a name="l00263"></a>00263     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> != <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ad33e055301cbadbb9544f199ee76c00e">HTTP_TASK_STATE_NORMAL</a> ||
<a name="l00264"></a>00264         task-&gt;<a class="code" href="struct__HttpTxTask.html#a42338e3407f898a2dc149f087cd0cea6">runtime_state</a> == <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617a529f48738b7509bb452c8f25915938cf">HTTP_TASK_RT_STATE_INIT</a> ||
<a name="l00265"></a>00265         task-&gt;<a class="code" href="struct__HttpTxTask.html#a42338e3407f898a2dc149f087cd0cea6">runtime_state</a> == <a class="code" href="http-tx-mgr_8h.html#ae97e5fbdbd28cab8bf8823ca4f66f617a48fa58e541bc5e2f237e8cd81b1a33b3">HTTP_TASK_RT_STATE_FINISHED</a>)
<a name="l00266"></a>00266         <span class="keywordflow">return</span>;
<a name="l00267"></a>00267 
<a name="l00268"></a>00268     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l00269"></a>00269                                                  task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l00270"></a>00270     <span class="keywordtype">char</span> *repo_name;
<a name="l00271"></a>00271     <span class="keywordtype">char</span> *<a class="code" href="fs-mgr_8c.html#a65cfc9e13d3352fd9099a0408cba715c">type</a>;
<a name="l00272"></a>00272     
<a name="l00273"></a>00273     <span class="keywordflow">if</span> (repo) {
<a name="l00274"></a>00274         repo_name = repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>;
<a name="l00275"></a>00275         type = (task-&gt;<a class="code" href="struct__HttpTxTask.html#ad954a300aab26e22dcd2100b2c5e248a">type</a> == <a class="code" href="http-tx-mgr_8h.html#a16af7b253440dadd46a80a4b9fddba4da138a1036827f5836bd8e372ebe2aad95">HTTP_TASK_TYPE_UPLOAD</a>) ? <span class="stringliteral">&quot;upload&quot;</span> : <span class="stringliteral">&quot;download&quot;</span>;
<a name="l00276"></a>00276         
<a name="l00277"></a>00277     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__HttpTxTask.html#a8dc7ba305c249ab73ce9424725776d41">is_clone</a>) {
<a name="l00278"></a>00278         <a class="code" href="struct__CloneTask.html">CloneTask</a> *ctask;
<a name="l00279"></a>00279         ctask = <a class="code" href="clone-mgr_8c.html#acb26f43fecfbf4f3b0c81ea6f7a6195f">seaf_clone_manager_get_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a5c8bf74f127df80a600e36fbb19b696e">clone_mgr</a>, task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l00280"></a>00280         repo_name = ctask-&gt;<a class="code" href="struct__CloneTask.html#af4f2887a7ddd497587e0bfbe0d51018f">repo_name</a>;
<a name="l00281"></a>00281         type = <span class="stringliteral">&quot;download&quot;</span>;
<a name="l00282"></a>00282         
<a name="l00283"></a>00283     } <span class="keywordflow">else</span> {
<a name="l00284"></a>00284         <span class="keywordflow">return</span>;
<a name="l00285"></a>00285     }
<a name="l00286"></a>00286     <span class="keywordtype">int</span> rate = <a class="code" href="http-tx-mgr_8c.html#ae22399dc7fe166fe634ba3738b657036">http_tx_task_get_rate</a>(task);
<a name="l00287"></a>00287 
<a name="l00288"></a>00288     g_string_append_printf (buf, <span class="stringliteral">&quot;%s\t%d %s\n&quot;</span>, type, rate, repo_name);
<a name="l00289"></a>00289 }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291 <span class="comment">/*</span>
<a name="l00292"></a>00292 <span class="comment"> * Publish a notification message to report :</span>
<a name="l00293"></a>00293 <span class="comment"> *</span>
<a name="l00294"></a>00294 <span class="comment"> *      [uploading/downloading]\t[transfer-rate] [repo-name]\n</span>
<a name="l00295"></a>00295 <span class="comment"> */</span>
<a name="l00296"></a>00296 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00297"></a>00297 update_tx_state (<span class="keywordtype">void</span> *vmanager)
<a name="l00298"></a>00298 {
<a name="l00299"></a>00299     <a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *mgr = vmanager;
<a name="l00300"></a>00300     GString *buf = g_string_new (NULL);
<a name="l00301"></a>00301     GList *tasks, *ptr;
<a name="l00302"></a>00302     <a class="code" href="struct__TransferTask.html">TransferTask</a> *task;
<a name="l00303"></a>00303     <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *http_task;
<a name="l00304"></a>00304 
<a name="l00305"></a>00305     mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#acf36129fa93b873ff6fdedf906ddd116">last_sent_bytes</a> = g_atomic_int_get (&amp;mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#aae566549651ea69a0b37db631f0b9a32">sent_bytes</a>);
<a name="l00306"></a>00306     g_atomic_int_set (&amp;mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#aae566549651ea69a0b37db631f0b9a32">sent_bytes</a>, 0);
<a name="l00307"></a>00307     mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a85dcef85e0f40df799cbb76df7d23e46">last_recv_bytes</a> = g_atomic_int_get (&amp;mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a0c2c72b3bff4c8c3d5b29717c06f9195">recv_bytes</a>);
<a name="l00308"></a>00308     g_atomic_int_set (&amp;mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a0c2c72b3bff4c8c3d5b29717c06f9195">recv_bytes</a>, 0);
<a name="l00309"></a>00309 
<a name="l00310"></a>00310     tasks = <a class="code" href="transfer-mgr_8c.html#ab45ac6ab5c091d45224f57b0aa1f6452">seaf_transfer_manager_get_upload_tasks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa04a8214ef989d1e5d68799dc19cbf22">transfer_mgr</a>);
<a name="l00311"></a>00311     <span class="keywordflow">for</span> (ptr = tasks; ptr; ptr = ptr-&gt;next) {
<a name="l00312"></a>00312         task = ptr-&gt;data;
<a name="l00313"></a>00313         format_transfer_task_detail (task, buf);
<a name="l00314"></a>00314     }
<a name="l00315"></a>00315     g_list_free (tasks);
<a name="l00316"></a>00316 
<a name="l00317"></a>00317     tasks = <a class="code" href="transfer-mgr_8c.html#acb8e9fc3a0648f40f6018c7f25d5b36f">seaf_transfer_manager_get_download_tasks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa04a8214ef989d1e5d68799dc19cbf22">transfer_mgr</a>);
<a name="l00318"></a>00318     <span class="keywordflow">for</span> (ptr = tasks; ptr; ptr = ptr-&gt;next) {
<a name="l00319"></a>00319         task = ptr-&gt;data;
<a name="l00320"></a>00320         format_transfer_task_detail (task, buf);
<a name="l00321"></a>00321     }
<a name="l00322"></a>00322     g_list_free (tasks);
<a name="l00323"></a>00323 
<a name="l00324"></a>00324     tasks = <a class="code" href="http-tx-mgr_8c.html#a3cf653baf4245f9f361a2be605464035">http_tx_manager_get_upload_tasks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>);
<a name="l00325"></a>00325     <span class="keywordflow">for</span> (ptr = tasks; ptr; ptr = ptr-&gt;next) {
<a name="l00326"></a>00326         http_task = ptr-&gt;data;
<a name="l00327"></a>00327         format_http_task_detail (http_task, buf);
<a name="l00328"></a>00328     }
<a name="l00329"></a>00329     g_list_free (tasks);
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     tasks = <a class="code" href="http-tx-mgr_8c.html#a4b8e6e4dd009a90d6fd8a42b6683995c">http_tx_manager_get_download_tasks</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>);
<a name="l00332"></a>00332     <span class="keywordflow">for</span> (ptr = tasks; ptr; ptr = ptr-&gt;next) {
<a name="l00333"></a>00333         http_task = ptr-&gt;data;
<a name="l00334"></a>00334         format_http_task_detail (http_task, buf);
<a name="l00335"></a>00335     }
<a name="l00336"></a>00336     g_list_free (tasks);
<a name="l00337"></a>00337 
<a name="l00338"></a>00338     <span class="keywordflow">if</span> (buf-&gt;len != 0)
<a name="l00339"></a>00339         <a class="code" href="mq-mgr_8c.html#a0e6f86438a353da6463eaf45b940f9f0">seaf_mq_manager_publish_notification</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a89e2a6000f250563b18123661ba9abbd">mq_mgr</a>, <span class="stringliteral">&quot;transfer&quot;</span>,
<a name="l00340"></a>00340                                               buf-&gt;str);
<a name="l00341"></a>00341 
<a name="l00342"></a>00342     g_string_free (buf, TRUE);
<a name="l00343"></a>00343 
<a name="l00344"></a>00344     <span class="keywordflow">return</span> TRUE;
<a name="l00345"></a>00345 }
<a name="l00346"></a>00346 
<a name="l00347"></a>00347 <span class="keywordtype">int</span>
<a name="l00348"></a><a class="code" href="sync-mgr_8h.html#a6b94a19a3cc3b20b29af0ae1e42abe4b">00348</a> <a class="code" href="sync-mgr_8c.html#a6b94a19a3cc3b20b29af0ae1e42abe4b">seaf_sync_manager_start</a> (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *mgr)
<a name="l00349"></a>00349 {
<a name="l00350"></a>00350     add_repo_relays ();
<a name="l00351"></a>00351 
<a name="l00352"></a>00352     mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a98a501bc370a4c500ec8c0688896d9bb">priv</a>-&gt;<a class="code" href="struct__SeafSyncManagerPriv.html#af5cc60aaed95c9af8f98eb250bf86539">check_sync_timer</a> = <a class="code" href="timer_8h.html#a68b6afb704a7f56b625ed78146691b7c">ccnet_timer_new</a> (
<a name="l00353"></a>00353         auto_sync_pulse, mgr, <a class="code" href="sync-mgr_8c.html#a10a0b7b6d015d053a6fff2b5101455e6">CHECK_SYNC_INTERVAL</a>);
<a name="l00354"></a>00354 
<a name="l00355"></a>00355     mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a98a501bc370a4c500ec8c0688896d9bb">priv</a>-&gt;<a class="code" href="struct__SeafSyncManagerPriv.html#a8fe398da116c1473125cde74cf229811">update_tx_state_timer</a> = <a class="code" href="timer_8h.html#a68b6afb704a7f56b625ed78146691b7c">ccnet_timer_new</a> (
<a name="l00356"></a>00356         update_tx_state, mgr, <a class="code" href="sync-mgr_8c.html#a9d14e39f5a26e739b3843777ae399f64">UPDATE_TX_STATE_INTERVAL</a>);
<a name="l00357"></a>00357 
<a name="l00358"></a>00358     <a class="code" href="include_2ccnet_2proc-factory_8h.html#aa8eba73e6627b33e2cb2d91fd0ea9922">ccnet_proc_factory_register_processor</a> (mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a15dbbff6ec86d385b4fbfcd5605b1112">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>,
<a name="l00359"></a>00359                                            <span class="stringliteral">&quot;seafile-sync-repo&quot;</span>,
<a name="l00360"></a>00360                                            <a class="code" href="sync-repo-proc_8h.html#a1bb522eb19686b7f927922307b1768f3">SEAFILE_TYPE_SYNC_REPO_PROC</a>);
<a name="l00361"></a>00361     <a class="code" href="include_2ccnet_2proc-factory_8h.html#aa8eba73e6627b33e2cb2d91fd0ea9922">ccnet_proc_factory_register_processor</a> (mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a15dbbff6ec86d385b4fbfcd5605b1112">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>,
<a name="l00362"></a>00362                                            <span class="stringliteral">&quot;seafile-getca&quot;</span>,
<a name="l00363"></a>00363                                            <a class="code" href="getca-proc_8h.html#a2d5749aa4fb5992924d2973f3cb38bdd">SEAFILE_TYPE_GETCA_PROC</a>);
<a name="l00364"></a>00364     <a class="code" href="include_2ccnet_2proc-factory_8h.html#aa8eba73e6627b33e2cb2d91fd0ea9922">ccnet_proc_factory_register_processor</a> (mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a15dbbff6ec86d385b4fbfcd5605b1112">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>,
<a name="l00365"></a>00365                                            <span class="stringliteral">&quot;seafile-check-protocol&quot;</span>,
<a name="l00366"></a>00366                                            <a class="code" href="check-protocol-proc_8h.html#ac3d3e157d72e3362e93a56aaa253f437">SEAFILE_TYPE_CHECK_PROTOCOL_PROC</a>);
<a name="l00367"></a>00367     g_signal_connect (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>, <span class="stringliteral">&quot;repo-fetched&quot;</span>,
<a name="l00368"></a>00368                       (GCallback)on_repo_fetched, mgr);
<a name="l00369"></a>00369     g_signal_connect (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>, <span class="stringliteral">&quot;repo-uploaded&quot;</span>,
<a name="l00370"></a>00370                       (GCallback)on_repo_uploaded, mgr);
<a name="l00371"></a>00371     g_signal_connect (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>, <span class="stringliteral">&quot;repo-http-fetched&quot;</span>,
<a name="l00372"></a>00372                       (GCallback)on_repo_http_fetched, mgr);
<a name="l00373"></a>00373     g_signal_connect (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>, <span class="stringliteral">&quot;repo-http-uploaded&quot;</span>,
<a name="l00374"></a>00374                       (GCallback)on_repo_http_uploaded, mgr);
<a name="l00375"></a>00375 
<a name="l00376"></a>00376     <span class="keywordflow">return</span> 0;
<a name="l00377"></a>00377 }
<a name="l00378"></a>00378 
<a name="l00379"></a>00379 <span class="keywordtype">int</span>
<a name="l00380"></a><a class="code" href="sync-mgr_8h.html#aeea02ab15ddf4c48dd3227f30b791f37">00380</a> <a class="code" href="sync-mgr_8c.html#aeea02ab15ddf4c48dd3227f30b791f37">seaf_sync_manager_add_sync_task</a> (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *mgr,
<a name="l00381"></a>00381                                  <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id,
<a name="l00382"></a>00382                                  GError **error)
<a name="l00383"></a>00383 {
<a name="l00384"></a>00384     <span class="keywordflow">if</span> (!<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a5432788378b921624977855244c63a85">started</a>) {
<a name="l00385"></a>00385         seaf_message (<span class="stringliteral">&quot;sync manager is not started, skip sync request.\n&quot;</span>);
<a name="l00386"></a>00386         <span class="keywordflow">return</span> -1;
<a name="l00387"></a>00387     }
<a name="l00388"></a>00388 
<a name="l00389"></a>00389     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l00390"></a>00390 
<a name="l00391"></a>00391     repo = <a class="code" href="daemon_2repo-mgr_8c.html#af0276c036723560e3e8b9aa5529133d6">seaf_repo_manager_get_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id);
<a name="l00392"></a>00392     <span class="keywordflow">if</span> (!repo) {
<a name="l00393"></a>00393         seaf_warning (<span class="stringliteral">&quot;[sync mgr] cannot find repo %s.\n&quot;</span>, repo_id);
<a name="l00394"></a>00394         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a4e83bbdab82c39e4738fd82c33a87ab4">SEAF_ERR_BAD_REPO</a>, <span class="stringliteral">&quot;Invalid repo&quot;</span>);
<a name="l00395"></a>00395         <span class="keywordflow">return</span> -1;
<a name="l00396"></a>00396     }
<a name="l00397"></a>00397 
<a name="l00398"></a>00398     <span class="keywordflow">if</span> (<a class="code" href="daemon_2repo-mgr_8c.html#ad1200d69d8e6219885da4e85af15dca2">seaf_repo_check_worktree</a> (repo) &lt; 0) {
<a name="l00399"></a>00399         g_set_error (error, <a class="code" href="seafile_2common_2log_8h.html#a8672557bc38a1d129649fe83577444ca">SEAFILE_DOMAIN</a>, <a class="code" href="seafile-error_8h.html#a571d212e2b415447f350a03dcc8e13cc">SEAF_ERR_NO_WORKTREE</a>,
<a name="l00400"></a>00400                      <span class="stringliteral">&quot;Worktree doesn&#39;t exist&quot;</span>);
<a name="l00401"></a>00401         <span class="keywordflow">return</span> -1;
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <a class="code" href="struct__SyncInfo.html">SyncInfo</a> *info = get_sync_info (mgr, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00405"></a>00405 
<a name="l00406"></a>00406     <span class="keywordflow">if</span> (info-&gt;<a class="code" href="struct__SyncInfo.html#ad0f77a2b8e799b3a0abc417fce88843a">in_sync</a>)
<a name="l00407"></a>00407         <span class="keywordflow">return</span> 0;
<a name="l00408"></a>00408 
<a name="l00409"></a>00409     gboolean is_checking_http = FALSE;
<a name="l00410"></a>00410     <span class="keywordflow">if</span> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3df88d84e57f0b8508144a5ff151ed19">enable_http_sync</a> &amp;&amp; repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a> &gt; 0) {
<a name="l00411"></a>00411         <span class="keywordflow">if</span> (check_http_protocol (mgr, repo, &amp;is_checking_http)) {
<a name="l00412"></a>00412             sync_repo_v2 (mgr, repo, TRUE);
<a name="l00413"></a>00413             <span class="keywordflow">return</span> 0;
<a name="l00414"></a>00414         }
<a name="l00415"></a>00415     }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417     <span class="comment">/* If relay is not ready or protocol version is not determined,</span>
<a name="l00418"></a>00418 <span class="comment">     * need to wait.</span>
<a name="l00419"></a>00419 <span class="comment">     */</span>
<a name="l00420"></a>00420     <span class="keywordflow">if</span> (!check_relay_status (mgr, repo)) {
<a name="l00421"></a>00421         seaf_warning (<span class="stringliteral">&quot;Relay for repo %s(%.8s) is not ready or protocol version&quot;</span>
<a name="l00422"></a>00422                       <span class="stringliteral">&quot;is not detected.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00423"></a>00423         <span class="keywordflow">return</span> 0;
<a name="l00424"></a>00424     }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426     <a class="code" href="struct__ServerState.html">ServerState</a> *state = g_hash_table_lookup (mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a623ff0c818f5d0d7da880cdba6700bce">server_states</a>,
<a name="l00427"></a>00427                                               repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>);
<a name="l00428"></a>00428 
<a name="l00429"></a>00429     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a> == 0 ||
<a name="l00430"></a>00430         state-&gt;<a class="code" href="struct__ServerState.html#adb0ef1901e8918aaa2a1e2ee5468b479">server_side_merge</a> == <a class="code" href="sync-mgr_8c.html#a16685eea158879e41b101ca3634de462ac2a0c6479a5c92919e0138492de300bf">SERVER_SIDE_MERGE_UNSUPPORTED</a> ||
<a name="l00431"></a>00431         has_old_commits_to_upload (repo))
<a name="l00432"></a>00432         start_sync (mgr, repo, TRUE, TRUE, FALSE);
<a name="l00433"></a>00433     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state-&gt;<a class="code" href="struct__ServerState.html#adb0ef1901e8918aaa2a1e2ee5468b479">server_side_merge</a> == <a class="code" href="sync-mgr_8c.html#a16685eea158879e41b101ca3634de462aa9a54f83b0490bef2294e496c9e758f9">SERVER_SIDE_MERGE_SUPPORTED</a>)
<a name="l00434"></a>00434         sync_repo_v2 (mgr, repo, TRUE);
<a name="l00435"></a>00435 
<a name="l00436"></a>00436     <span class="keywordflow">return</span> 0;
<a name="l00437"></a>00437 }
<a name="l00438"></a>00438 
<a name="l00439"></a>00439 <span class="keywordtype">void</span>
<a name="l00440"></a><a class="code" href="sync-mgr_8h.html#a0b90f2ae7c7e7a85ae97b7ade254572a">00440</a> <a class="code" href="sync-mgr_8c.html#a0b90f2ae7c7e7a85ae97b7ade254572a">seaf_sync_manager_cancel_sync_task</a> (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *mgr,
<a name="l00441"></a>00441                                     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l00442"></a>00442 {
<a name="l00443"></a>00443     <a class="code" href="struct__SyncInfo.html">SyncInfo</a> *info;
<a name="l00444"></a>00444     <a class="code" href="struct__SyncTask.html">SyncTask</a> *task;
<a name="l00445"></a>00445 
<a name="l00446"></a>00446     <span class="keywordflow">if</span> (!<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a5432788378b921624977855244c63a85">started</a>) {
<a name="l00447"></a>00447         seaf_message (<span class="stringliteral">&quot;sync manager is not started, skip cancel request.\n&quot;</span>);
<a name="l00448"></a>00448         <span class="keywordflow">return</span>;
<a name="l00449"></a>00449     }
<a name="l00450"></a>00450 
<a name="l00451"></a>00451     <span class="comment">/* Cancel running task. */</span>
<a name="l00452"></a>00452     info = g_hash_table_lookup (mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a3b638d371d53219f1169c85bdc716727">sync_infos</a>, repo_id);
<a name="l00453"></a>00453     <span class="keywordflow">if</span> (!info || !info-&gt;<a class="code" href="struct__SyncInfo.html#ad0f77a2b8e799b3a0abc417fce88843a">in_sync</a>)
<a name="l00454"></a>00454         <span class="keywordflow">return</span>;
<a name="l00455"></a>00455 
<a name="l00456"></a>00456     g_return_if_fail (info-&gt;<a class="code" href="struct__SyncInfo.html#a6b0407e7d6def63347532d7d73eb7c6b">current_task</a> != NULL);
<a name="l00457"></a>00457     task = info-&gt;<a class="code" href="struct__SyncInfo.html#a6b0407e7d6def63347532d7d73eb7c6b">current_task</a>;
<a name="l00458"></a>00458 
<a name="l00459"></a>00459     <span class="keywordflow">switch</span> (task-&gt;<a class="code" href="struct__SyncTask.html#a442ac2b31e670693c3f1ec595a158ae4">state</a>) {
<a name="l00460"></a>00460     <span class="keywordflow">case</span> <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da4d3da856442685e0c11e7b8d6da4ae7a">SYNC_STATE_FETCH</a>:
<a name="l00461"></a>00461         <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__SyncTask.html#a29f8510d0999c926b2723a443a57f007">http_sync</a>)
<a name="l00462"></a>00462             <a class="code" href="transfer-mgr_8c.html#af834de917c22d13996383431bef032a0">seaf_transfer_manager_cancel_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa04a8214ef989d1e5d68799dc19cbf22">transfer_mgr</a>,
<a name="l00463"></a>00463                                                task-&gt;<a class="code" href="struct__SyncTask.html#a205ad78d2d7e9f477e1b4ddeb95d681a">tx_id</a>,
<a name="l00464"></a>00464                                                <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa68841d8280724b9623db3dea4a78dde5">TASK_TYPE_DOWNLOAD</a>);
<a name="l00465"></a>00465         <span class="keywordflow">else</span>
<a name="l00466"></a>00466             <a class="code" href="http-tx-mgr_8c.html#a1333f1b023ba910df52c75f6ec51c41d">http_tx_manager_cancel_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>,
<a name="l00467"></a>00467                                          repo_id,
<a name="l00468"></a>00468                                          <a class="code" href="http-tx-mgr_8h.html#a16af7b253440dadd46a80a4b9fddba4da429731c6953f215203cf1b17fe92ebb1">HTTP_TASK_TYPE_DOWNLOAD</a>);
<a name="l00469"></a>00469         transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da4bdd5ea7e9e244ed294244fb4b31924d">SYNC_STATE_CANCEL_PENDING</a>);
<a name="l00470"></a>00470         <span class="keywordflow">break</span>;
<a name="l00471"></a>00471     <span class="keywordflow">case</span> <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89dadabb88743cd5d62f35d77d9ed28e6973">SYNC_STATE_UPLOAD</a>:
<a name="l00472"></a>00472         <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__SyncTask.html#a29f8510d0999c926b2723a443a57f007">http_sync</a>)
<a name="l00473"></a>00473             <a class="code" href="transfer-mgr_8c.html#af834de917c22d13996383431bef032a0">seaf_transfer_manager_cancel_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa04a8214ef989d1e5d68799dc19cbf22">transfer_mgr</a>,
<a name="l00474"></a>00474                                                task-&gt;<a class="code" href="struct__SyncTask.html#a205ad78d2d7e9f477e1b4ddeb95d681a">tx_id</a>,
<a name="l00475"></a>00475                                                <a class="code" href="transfer-mgr_8h.html#a394b3903fbf00ba2b6243f60689a5a5fa800672fa26f828e725e4f6efe3dd7a67">TASK_TYPE_UPLOAD</a>);
<a name="l00476"></a>00476         <span class="keywordflow">else</span>
<a name="l00477"></a>00477             <a class="code" href="http-tx-mgr_8c.html#a1333f1b023ba910df52c75f6ec51c41d">http_tx_manager_cancel_task</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>,
<a name="l00478"></a>00478                                          repo_id,
<a name="l00479"></a>00479                                          <a class="code" href="http-tx-mgr_8h.html#a16af7b253440dadd46a80a4b9fddba4da138a1036827f5836bd8e372ebe2aad95">HTTP_TASK_TYPE_UPLOAD</a>);
<a name="l00480"></a>00480         transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da4bdd5ea7e9e244ed294244fb4b31924d">SYNC_STATE_CANCEL_PENDING</a>);
<a name="l00481"></a>00481         <span class="keywordflow">break</span>;
<a name="l00482"></a>00482     <span class="keywordflow">case</span> <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89dad5ea812e07d2b3a88cc24f0aa48a9475">SYNC_STATE_COMMIT</a>:
<a name="l00483"></a>00483     <span class="keywordflow">case</span> <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89daa158c5b9c6636626f72c9aa67f003675">SYNC_STATE_INIT</a>:
<a name="l00484"></a>00484     <span class="keywordflow">case</span> <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89daf15f2ef041660fd4bc9e1a7cd2b31adc">SYNC_STATE_MERGE</a>:
<a name="l00485"></a>00485         transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da4bdd5ea7e9e244ed294244fb4b31924d">SYNC_STATE_CANCEL_PENDING</a>);
<a name="l00486"></a>00486         <span class="keywordflow">break</span>;
<a name="l00487"></a>00487     <span class="keywordflow">case</span> <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da4bdd5ea7e9e244ed294244fb4b31924d">SYNC_STATE_CANCEL_PENDING</a>:
<a name="l00488"></a>00488         <span class="keywordflow">break</span>;
<a name="l00489"></a>00489     <span class="keywordflow">default</span>:
<a name="l00490"></a>00490         g_return_if_reached ();
<a name="l00491"></a>00491     }
<a name="l00492"></a>00492 }
<a name="l00493"></a>00493 
<a name="l00494"></a>00494 <span class="comment">/* Check the notify setting by user.  */</span>
<a name="l00495"></a>00495 <span class="keyword">static</span> gboolean
<a name="l00496"></a>00496 need_notify_sync (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l00497"></a>00497 {
<a name="l00498"></a>00498     <span class="keywordtype">char</span> *notify_setting = <a class="code" href="seafile-config_8c.html#a9980640c9959844f1380c1ae7252b9c3">seafile_session_config_get_string</a>(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>, <span class="stringliteral">&quot;notify_sync&quot;</span>);
<a name="l00499"></a>00499     <span class="keywordflow">if</span> (notify_setting == NULL) {
<a name="l00500"></a>00500         <a class="code" href="seafile-config_8c.html#acfe503d4b0ebbefcb0f14b6ede6e2dcc">seafile_session_config_set_string</a>(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>, <span class="stringliteral">&quot;notify_sync&quot;</span>, <span class="stringliteral">&quot;on&quot;</span>);
<a name="l00501"></a>00501         <span class="keywordflow">return</span> TRUE;
<a name="l00502"></a>00502     }
<a name="l00503"></a>00503 
<a name="l00504"></a>00504     gboolean result = (g_strcmp0(notify_setting, <span class="stringliteral">&quot;on&quot;</span>) == 0);
<a name="l00505"></a>00505     g_free (notify_setting);
<a name="l00506"></a>00506     <span class="keywordflow">return</span> result;
<a name="l00507"></a>00507 }
<a name="l00508"></a>00508 
<a name="l00509"></a>00509 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *sync_state_str[] = {
<a name="l00510"></a>00510     <span class="stringliteral">&quot;synchronized&quot;</span>,
<a name="l00511"></a>00511     <span class="stringliteral">&quot;committing&quot;</span>,
<a name="l00512"></a>00512     <span class="stringliteral">&quot;initializing&quot;</span>,
<a name="l00513"></a>00513     <span class="stringliteral">&quot;downloading&quot;</span>,
<a name="l00514"></a>00514     <span class="stringliteral">&quot;merging&quot;</span>,
<a name="l00515"></a>00515     <span class="stringliteral">&quot;uploading&quot;</span>,
<a name="l00516"></a>00516     <span class="stringliteral">&quot;error&quot;</span>,
<a name="l00517"></a>00517     <span class="stringliteral">&quot;canceled&quot;</span>,
<a name="l00518"></a>00518     <span class="stringliteral">&quot;cancel pending&quot;</span>
<a name="l00519"></a>00519 };
<a name="l00520"></a>00520 
<a name="l00521"></a>00521 <span class="keyword">static</span> gboolean
<a name="l00522"></a>00522 find_meaningful_commit (<a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit, <span class="keywordtype">void</span> *data, gboolean *stop)
<a name="l00523"></a>00523 {
<a name="l00524"></a>00524     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> **p_head = data;
<a name="l00525"></a>00525 
<a name="l00526"></a>00526     <span class="keywordflow">if</span> (commit-&gt;<a class="code" href="struct__SeafCommit.html#aad2ebe1498cc25f837554456cbcd31f5">second_parent_id</a> &amp;&amp; commit-&gt;<a class="code" href="struct__SeafCommit.html#a78d20b7c73d8d7645fc5d6410cb1a4be">new_merge</a> &amp;&amp; !commit-&gt;<a class="code" href="struct__SeafCommit.html#a5e522b729c973107a36257cc1d60badb">conflict</a>)
<a name="l00527"></a>00527         <span class="keywordflow">return</span> TRUE;
<a name="l00528"></a>00528 
<a name="l00529"></a>00529     *stop = TRUE;
<a name="l00530"></a>00530     <a class="code" href="commit-mgr_8c.html#a2b1cc305cf40cb64c341a0e64d0fe921">seaf_commit_ref</a> (commit);
<a name="l00531"></a>00531     *p_head = commit;
<a name="l00532"></a>00532     <span class="keywordflow">return</span> TRUE;
<a name="l00533"></a>00533 }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00536"></a>00536 notify_sync (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l00537"></a>00537 {
<a name="l00538"></a>00538     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head = NULL;
<a name="l00539"></a>00539 
<a name="l00540"></a>00540     <span class="keywordflow">if</span> (!<a class="code" href="commit-mgr_8c.html#a7a915577c5ab3095960ef08474a35aa0">seaf_commit_manager_traverse_commit_tree_truncated</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l00541"></a>00541                                                    repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
<a name="l00542"></a>00542                                                    repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>,
<a name="l00543"></a>00543                                                    find_meaningful_commit,
<a name="l00544"></a>00544                                                    &amp;head, FALSE)) {
<a name="l00545"></a>00545         seaf_warning (<span class="stringliteral">&quot;Failed to traverse commit tree of %.8s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00546"></a>00546         <span class="keywordflow">return</span>;
<a name="l00547"></a>00547     }
<a name="l00548"></a>00548     <span class="keywordflow">if</span> (!head)
<a name="l00549"></a>00549         <span class="keywordflow">return</span>;
<a name="l00550"></a>00550 
<a name="l00551"></a>00551     GString *buf = g_string_new (NULL);
<a name="l00552"></a>00552     g_string_append_printf (buf, <span class="stringliteral">&quot;%s\t%s\t%s&quot;</span>,
<a name="l00553"></a>00553                             repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>,
<a name="l00554"></a>00554                             repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l00555"></a>00555                             head-&gt;<a class="code" href="struct__SeafCommit.html#a92b6981822e3ca00f30b797ceaa65243">desc</a>);
<a name="l00556"></a>00556     <a class="code" href="mq-mgr_8c.html#a0e6f86438a353da6463eaf45b940f9f0">seaf_mq_manager_publish_notification</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a89e2a6000f250563b18123661ba9abbd">mq_mgr</a>,
<a name="l00557"></a>00557                                           <span class="stringliteral">&quot;sync.done&quot;</span>,
<a name="l00558"></a>00558                                           buf-&gt;str);
<a name="l00559"></a>00559     g_string_free (buf, TRUE);
<a name="l00560"></a>00560     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (head);
<a name="l00561"></a>00561 }
<a name="l00562"></a>00562 
<a name="l00563"></a>00563 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00564"></a>00564 transition_sync_state (<a class="code" href="struct__SyncTask.html">SyncTask</a> *task, <span class="keywordtype">int</span> new_state)
<a name="l00565"></a>00565 {
<a name="l00566"></a>00566     g_return_if_fail (new_state &gt;= 0 &amp;&amp; new_state &lt; <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da454e120cc51f9bbf1a61c67300bc055b">SYNC_STATE_NUM</a>);
<a name="l00567"></a>00567 
<a name="l00568"></a>00568     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__SyncTask.html#a442ac2b31e670693c3f1ec595a158ae4">state</a> != new_state) {
<a name="l00569"></a>00569         <span class="keywordflow">if</span> (!(task-&gt;<a class="code" href="struct__SyncTask.html#a442ac2b31e670693c3f1ec595a158ae4">state</a> == <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da3c73047f0bdb59ed767efc67261354bb">SYNC_STATE_DONE</a> &amp;&amp; new_state == <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89daa158c5b9c6636626f72c9aa67f003675">SYNC_STATE_INIT</a>) &amp;&amp;
<a name="l00570"></a>00570             !(task-&gt;<a class="code" href="struct__SyncTask.html#a442ac2b31e670693c3f1ec595a158ae4">state</a> == <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89daa158c5b9c6636626f72c9aa67f003675">SYNC_STATE_INIT</a> &amp;&amp; new_state == <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da3c73047f0bdb59ed767efc67261354bb">SYNC_STATE_DONE</a>)) {
<a name="l00571"></a>00571             seaf_message (<span class="stringliteral">&quot;Repo &#39;%s&#39; sync state transition from &#39;%s&#39; to &#39;%s&#39;.\n&quot;</span>,
<a name="l00572"></a>00572                           task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>,
<a name="l00573"></a>00573                           sync_state_str[task-&gt;<a class="code" href="struct__SyncTask.html#a442ac2b31e670693c3f1ec595a158ae4">state</a>],
<a name="l00574"></a>00574                           sync_state_str[new_state]);
<a name="l00575"></a>00575         }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577         <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__SyncTask.html#a4f2d508226faddcf79be1f58bc11b781">server_side_merge</a>) {
<a name="l00578"></a>00578             <span class="keywordflow">if</span> ((task-&gt;<a class="code" href="struct__SyncTask.html#a442ac2b31e670693c3f1ec595a158ae4">state</a> == <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89daf15f2ef041660fd4bc9e1a7cd2b31adc">SYNC_STATE_MERGE</a> ||
<a name="l00579"></a>00579                  task-&gt;<a class="code" href="struct__SyncTask.html#a442ac2b31e670693c3f1ec595a158ae4">state</a> == <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89dadabb88743cd5d62f35d77d9ed28e6973">SYNC_STATE_UPLOAD</a>) &amp;&amp;
<a name="l00580"></a>00580                 new_state == <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da3c73047f0bdb59ed767efc67261354bb">SYNC_STATE_DONE</a> &amp;&amp;
<a name="l00581"></a>00581                 need_notify_sync(task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>))
<a name="l00582"></a>00582                 notify_sync (task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>);
<a name="l00583"></a>00583         } <span class="keywordflow">else</span> {
<a name="l00584"></a>00584             <span class="keywordflow">if</span> (((task-&gt;<a class="code" href="struct__SyncTask.html#a442ac2b31e670693c3f1ec595a158ae4">state</a> == <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89daa158c5b9c6636626f72c9aa67f003675">SYNC_STATE_INIT</a> &amp;&amp; task-&gt;<a class="code" href="struct__SyncTask.html#af5500a94e3d4e76c70bf200265bddc21">uploaded</a>) ||
<a name="l00585"></a>00585                  task-&gt;<a class="code" href="struct__SyncTask.html#a442ac2b31e670693c3f1ec595a158ae4">state</a> == <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da4d3da856442685e0c11e7b8d6da4ae7a">SYNC_STATE_FETCH</a>) &amp;&amp;
<a name="l00586"></a>00586                 new_state == <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da3c73047f0bdb59ed767efc67261354bb">SYNC_STATE_DONE</a> &amp;&amp;
<a name="l00587"></a>00587                 need_notify_sync(task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>))
<a name="l00588"></a>00588                 notify_sync (task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>);
<a name="l00589"></a>00589         }
<a name="l00590"></a>00590 
<a name="l00591"></a>00591         task-&gt;<a class="code" href="struct__SyncTask.html#a442ac2b31e670693c3f1ec595a158ae4">state</a> = new_state;
<a name="l00592"></a>00592         <span class="keywordflow">if</span> (new_state == <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da3c73047f0bdb59ed767efc67261354bb">SYNC_STATE_DONE</a> || 
<a name="l00593"></a>00593             new_state == <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da8e0121d3e9964268e71fd702733f2579">SYNC_STATE_CANCELED</a> ||
<a name="l00594"></a>00594             new_state == <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da6223e8d6f29cba71fedc0ceda4d6aca3">SYNC_STATE_ERROR</a>) {
<a name="l00595"></a>00595             task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a>-&gt;<a class="code" href="struct__SyncInfo.html#ad0f77a2b8e799b3a0abc417fce88843a">in_sync</a> = FALSE;
<a name="l00596"></a>00596             --(task-&gt;<a class="code" href="struct__SyncTask.html#a8848e06615a4fc1bc9c145f8a224fe19">mgr</a>-&gt;<a class="code" href="struct__SeafSyncManager.html#a9c8ce9cbb2868b95ac75a882bf565c87">n_running_tasks</a>);
<a name="l00597"></a>00597             <span class="keywordflow">if</span> (new_state == <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da6223e8d6f29cba71fedc0ceda4d6aca3">SYNC_STATE_ERROR</a>)
<a name="l00598"></a>00598                 task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a>-&gt;<a class="code" href="struct__SyncInfo.html#a1fe909e4558f1c7a9fd3e83f0af4ddd3">err_cnt</a>++;
<a name="l00599"></a>00599             <span class="keywordflow">else</span>
<a name="l00600"></a>00600                 task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a>-&gt;<a class="code" href="struct__SyncInfo.html#a1fe909e4558f1c7a9fd3e83f0af4ddd3">err_cnt</a> = 0;
<a name="l00601"></a>00601         }
<a name="l00602"></a>00602     }
<a name="l00603"></a>00603 }
<a name="l00604"></a>00604 
<a name="l00605"></a>00605 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *sync_error_str[] = {
<a name="l00606"></a>00606     <span class="stringliteral">&quot;Success&quot;</span>,
<a name="l00607"></a>00607     <span class="stringliteral">&quot;relay not connected&quot;</span>,
<a name="l00608"></a>00608     <span class="stringliteral">&quot;failed to upgrade old repo&quot;</span>,
<a name="l00609"></a>00609     <span class="stringliteral">&quot;Server has been removed&quot;</span>,
<a name="l00610"></a>00610     <span class="stringliteral">&quot;You have not login to the server&quot;</span>,
<a name="l00611"></a>00611     <span class="stringliteral">&quot;Remote service is not available&quot;</span>,
<a name="l00612"></a>00612     <span class="stringliteral">&quot;You do not have permission to access this library&quot;</span>,
<a name="l00613"></a>00613     <span class="stringliteral">&quot;The storage space of the repo owner has been used up&quot;</span>,
<a name="l00614"></a>00614     <span class="stringliteral">&quot;Access denied to service. Please check your registration on relay.&quot;</span>,
<a name="l00615"></a>00615     <span class="stringliteral">&quot;Internal data corrupted.&quot;</span>,
<a name="l00616"></a>00616     <span class="stringliteral">&quot;Failed to start upload.&quot;</span>,
<a name="l00617"></a>00617     <span class="stringliteral">&quot;Error occured in upload.&quot;</span>,
<a name="l00618"></a>00618     <span class="stringliteral">&quot;Failed to start download.&quot;</span>,
<a name="l00619"></a>00619     <span class="stringliteral">&quot;Error occured in download.&quot;</span>,
<a name="l00620"></a>00620     <span class="stringliteral">&quot;No such repo on relay.&quot;</span>,
<a name="l00621"></a>00621     <span class="stringliteral">&quot;Repo is damaged on relay.&quot;</span>,
<a name="l00622"></a>00622     <span class="stringliteral">&quot;Failed to index files.&quot;</span>,
<a name="l00623"></a>00623     <span class="stringliteral">&quot;Conflict in merge.&quot;</span>,
<a name="l00624"></a>00624     <span class="stringliteral">&quot;Files changed in local folder, skip merge.&quot;</span>,
<a name="l00625"></a>00625     <span class="stringliteral">&quot;Server version is too old.&quot;</span>,
<a name="l00626"></a>00626     <span class="stringliteral">&quot;Failed to get sync info from server.&quot;</span>,
<a name="l00627"></a>00627     <span class="stringliteral">&quot;Files are locked by other application&quot;</span>,
<a name="l00628"></a>00628     <span class="stringliteral">&quot;Unknown error.&quot;</span>,
<a name="l00629"></a>00629 };
<a name="l00630"></a>00630 
<a name="l00631"></a>00631 <span class="keywordtype">void</span>
<a name="l00632"></a><a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">00632</a> <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (<a class="code" href="struct__SyncTask.html">SyncTask</a> *task, <span class="keywordtype">int</span> error)
<a name="l00633"></a>00633 {
<a name="l00634"></a>00634     g_return_if_fail (error &gt;= 0 &amp;&amp; error &lt; <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a7d4d35b0843584d00238d4110e2bad8e">SYNC_ERROR_NUM</a>);
<a name="l00635"></a>00635 
<a name="l00636"></a>00636     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__SyncTask.html#a442ac2b31e670693c3f1ec595a158ae4">state</a> != <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da6223e8d6f29cba71fedc0ceda4d6aca3">SYNC_STATE_ERROR</a>) {
<a name="l00637"></a>00637         seaf_message (<span class="stringliteral">&quot;Repo &#39;%s&#39; sync state transition from %s to &#39;%s&#39;: &#39;%s&#39;.\n&quot;</span>,
<a name="l00638"></a>00638                       task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>,
<a name="l00639"></a>00639                       sync_state_str[task-&gt;<a class="code" href="struct__SyncTask.html#a442ac2b31e670693c3f1ec595a158ae4">state</a>],
<a name="l00640"></a>00640                       sync_state_str[<a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da6223e8d6f29cba71fedc0ceda4d6aca3">SYNC_STATE_ERROR</a>],
<a name="l00641"></a>00641                       sync_error_str[error]);
<a name="l00642"></a>00642         task-&gt;<a class="code" href="struct__SyncTask.html#a442ac2b31e670693c3f1ec595a158ae4">state</a> = <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da6223e8d6f29cba71fedc0ceda4d6aca3">SYNC_STATE_ERROR</a>;
<a name="l00643"></a>00643         task-&gt;<a class="code" href="struct__SyncTask.html#ad9f58b13e60cd60b461164617d8593d2">error</a> = error;
<a name="l00644"></a>00644         task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a>-&gt;<a class="code" href="struct__SyncInfo.html#ad0f77a2b8e799b3a0abc417fce88843a">in_sync</a> = FALSE;
<a name="l00645"></a>00645         task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a>-&gt;<a class="code" href="struct__SyncInfo.html#a1fe909e4558f1c7a9fd3e83f0af4ddd3">err_cnt</a>++;
<a name="l00646"></a>00646         --(task-&gt;<a class="code" href="struct__SyncTask.html#a8848e06615a4fc1bc9c145f8a224fe19">mgr</a>-&gt;<a class="code" href="struct__SeafSyncManager.html#a9c8ce9cbb2868b95ac75a882bf565c87">n_running_tasks</a>);
<a name="l00647"></a>00647 
<a name="l00648"></a>00648 <span class="preprocessor">#if 0</span>
<a name="l00649"></a>00649 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a> &amp;&amp; error != <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a50741a36b251030d0ae069d21738116d">SYNC_ERROR_RELAY_OFFLINE</a>
<a name="l00650"></a>00650             &amp;&amp; error != <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55acab29b78af67a6700738bfcec981d548">SYNC_ERROR_NOREPO</a>) {
<a name="l00651"></a>00651             GString *buf = g_string_new (NULL);
<a name="l00652"></a>00652             g_string_append_printf (buf, <span class="stringliteral">&quot;%s\t%s&quot;</span>, task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>,
<a name="l00653"></a>00653                                     task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00654"></a>00654             <a class="code" href="mq-mgr_8c.html#a0e6f86438a353da6463eaf45b940f9f0">seaf_mq_manager_publish_notification</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a89e2a6000f250563b18123661ba9abbd">mq_mgr</a>,
<a name="l00655"></a>00655                                                   <span class="stringliteral">&quot;sync.error&quot;</span>,
<a name="l00656"></a>00656                                                   buf-&gt;str);
<a name="l00657"></a>00657             g_string_free (buf, TRUE);
<a name="l00658"></a>00658         }
<a name="l00659"></a>00659 <span class="preprocessor">#endif                                         </span>
<a name="l00660"></a>00660 <span class="preprocessor"></span>    }
<a name="l00661"></a>00661 }
<a name="l00662"></a>00662 
<a name="l00663"></a>00663 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00664"></a>00664 sync_task_free (<a class="code" href="struct__SyncTask.html">SyncTask</a> *task)
<a name="l00665"></a>00665 {
<a name="l00666"></a>00666     g_free (task-&gt;<a class="code" href="struct__SyncTask.html#a205ad78d2d7e9f477e1b4ddeb95d681a">tx_id</a>);
<a name="l00667"></a>00667     g_free (task-&gt;<a class="code" href="struct__SyncTask.html#a956579282afe1f78871352ed31488946">dest_id</a>);
<a name="l00668"></a>00668     g_free (task-&gt;<a class="code" href="struct__SyncTask.html#a49503a78f8c685ae2361ef400fabfb47">token</a>);
<a name="l00669"></a>00669     g_free (task);
<a name="l00670"></a>00670 }
<a name="l00671"></a>00671 
<a name="l00672"></a>00672 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00673"></a>00673 start_upload_if_necessary (<a class="code" href="struct__SyncTask.html">SyncTask</a> *task)
<a name="l00674"></a>00674 {
<a name="l00675"></a>00675     GError *error = NULL;
<a name="l00676"></a>00676     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>;
<a name="l00677"></a>00677     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id = task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>;
<a name="l00678"></a>00678 
<a name="l00679"></a>00679     <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__SyncTask.html#a29f8510d0999c926b2723a443a57f007">http_sync</a>) {
<a name="l00680"></a>00680         <span class="keywordtype">char</span> *tx_id = <a class="code" href="transfer-mgr_8c.html#a084f2ccd845f2ff514aa3fd6a4a7b697">seaf_transfer_manager_add_upload</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa04a8214ef989d1e5d68799dc19cbf22">transfer_mgr</a>,
<a name="l00681"></a>00681                                                         repo_id,
<a name="l00682"></a>00682                                                         task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
<a name="l00683"></a>00683                                                         task-&gt;<a class="code" href="struct__SyncTask.html#a956579282afe1f78871352ed31488946">dest_id</a>,
<a name="l00684"></a>00684                                                         <span class="stringliteral">&quot;local&quot;</span>,
<a name="l00685"></a>00685                                                         <span class="stringliteral">&quot;master&quot;</span>,
<a name="l00686"></a>00686                                                         task-&gt;<a class="code" href="struct__SyncTask.html#a49503a78f8c685ae2361ef400fabfb47">token</a>,
<a name="l00687"></a>00687                                                         task-&gt;<a class="code" href="struct__SyncTask.html#a4f2d508226faddcf79be1f58bc11b781">server_side_merge</a>,
<a name="l00688"></a>00688                                                         &amp;error);
<a name="l00689"></a>00689         <span class="keywordflow">if</span> (error != NULL) {
<a name="l00690"></a>00690             seaf_warning (<span class="stringliteral">&quot;Failed to start upload: %s\n&quot;</span>, error-&gt;message);
<a name="l00691"></a>00691             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a9586a92b4288d476e0e3d8956352242c">SYNC_ERROR_START_UPLOAD</a>);
<a name="l00692"></a>00692             <span class="keywordflow">return</span>;
<a name="l00693"></a>00693         }
<a name="l00694"></a>00694         task-&gt;<a class="code" href="struct__SyncTask.html#a205ad78d2d7e9f477e1b4ddeb95d681a">tx_id</a> = tx_id;
<a name="l00695"></a>00695     } <span class="keywordflow">else</span> {
<a name="l00696"></a>00696         <span class="keywordflow">if</span> (<a class="code" href="http-tx-mgr_8c.html#a585b7bf53556be4ced268b966dd11fd2">http_tx_manager_add_upload</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>,
<a name="l00697"></a>00697                                         repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l00698"></a>00698                                         repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
<a name="l00699"></a>00699                                         repo-&gt;<a class="code" href="struct__SeafRepo.html#a1a7beee19acb913be2c23ac0e71ea733">server_url</a>,
<a name="l00700"></a>00700                                         repo-&gt;<a class="code" href="struct__SeafRepo.html#a0ce3b61cb31e78ffea429615379b3eb4">token</a>,
<a name="l00701"></a>00701                                         task-&gt;<a class="code" href="struct__SyncTask.html#aed3920db60e520cf749b53fa3b6caca8">http_version</a>,
<a name="l00702"></a>00702                                         &amp;error) &lt; 0) {
<a name="l00703"></a>00703             seaf_warning (<span class="stringliteral">&quot;Failed to start http upload: %s\n&quot;</span>, error-&gt;message);
<a name="l00704"></a>00704             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a9586a92b4288d476e0e3d8956352242c">SYNC_ERROR_START_UPLOAD</a>);
<a name="l00705"></a>00705             <span class="keywordflow">return</span>;
<a name="l00706"></a>00706         }
<a name="l00707"></a>00707         task-&gt;<a class="code" href="struct__SyncTask.html#a205ad78d2d7e9f477e1b4ddeb95d681a">tx_id</a> = g_strdup(repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00708"></a>00708     }
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89dadabb88743cd5d62f35d77d9ed28e6973">SYNC_STATE_UPLOAD</a>);
<a name="l00711"></a>00711 }
<a name="l00712"></a>00712 
<a name="l00713"></a>00713 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00714"></a>00714 start_fetch_if_necessary (<a class="code" href="struct__SyncTask.html">SyncTask</a> *task, <span class="keyword">const</span> <span class="keywordtype">char</span> *remote_head)
<a name="l00715"></a>00715 {
<a name="l00716"></a>00716     GError *error = NULL;
<a name="l00717"></a>00717     <span class="keywordtype">char</span> *tx_id;
<a name="l00718"></a>00718     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>;
<a name="l00719"></a>00719     <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id = task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>;
<a name="l00720"></a>00720 
<a name="l00721"></a>00721     <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__SyncTask.html#a29f8510d0999c926b2723a443a57f007">http_sync</a>) {
<a name="l00722"></a>00722         tx_id = <a class="code" href="transfer-mgr_8c.html#a7c1421651b69da119fab63e9f1d5bf55">seaf_transfer_manager_add_download</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#aa04a8214ef989d1e5d68799dc19cbf22">transfer_mgr</a>,
<a name="l00723"></a>00723                                                     repo_id,
<a name="l00724"></a>00724                                                     task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
<a name="l00725"></a>00725                                                     task-&gt;<a class="code" href="struct__SyncTask.html#a956579282afe1f78871352ed31488946">dest_id</a>,
<a name="l00726"></a>00726                                                     <span class="stringliteral">&quot;fetch_head&quot;</span>,
<a name="l00727"></a>00727                                                     <span class="stringliteral">&quot;master&quot;</span>,
<a name="l00728"></a>00728                                                     task-&gt;<a class="code" href="struct__SyncTask.html#a49503a78f8c685ae2361ef400fabfb47">token</a>,
<a name="l00729"></a>00729                                                     task-&gt;<a class="code" href="struct__SyncTask.html#a4f2d508226faddcf79be1f58bc11b781">server_side_merge</a>,
<a name="l00730"></a>00730                                                     NULL,
<a name="l00731"></a>00731                                                     NULL,
<a name="l00732"></a>00732                                                     &amp;error);
<a name="l00733"></a>00733 
<a name="l00734"></a>00734         <span class="keywordflow">if</span> (error != NULL) {
<a name="l00735"></a>00735             seaf_warning (<span class="stringliteral">&quot;[sync-mgr] Failed to start download: %s\n&quot;</span>,
<a name="l00736"></a>00736                           error-&gt;message);
<a name="l00737"></a>00737             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a66c8cfe8e07f2f0d6e7ae6d83575a9e6">SYNC_ERROR_START_FETCH</a>);
<a name="l00738"></a>00738             <span class="keywordflow">return</span>;
<a name="l00739"></a>00739         }
<a name="l00740"></a>00740         task-&gt;<a class="code" href="struct__SyncTask.html#a205ad78d2d7e9f477e1b4ddeb95d681a">tx_id</a> = tx_id;
<a name="l00741"></a>00741     } <span class="keywordflow">else</span> {
<a name="l00742"></a>00742         <span class="keywordflow">if</span> (<a class="code" href="http-tx-mgr_8c.html#a0bd2d454a6270528980a22372d300ddb">http_tx_manager_add_download</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>,
<a name="l00743"></a>00743                                           repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l00744"></a>00744                                           repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
<a name="l00745"></a>00745                                           repo-&gt;<a class="code" href="struct__SeafRepo.html#a1a7beee19acb913be2c23ac0e71ea733">server_url</a>,
<a name="l00746"></a>00746                                           repo-&gt;<a class="code" href="struct__SeafRepo.html#a0ce3b61cb31e78ffea429615379b3eb4">token</a>,
<a name="l00747"></a>00747                                           remote_head,
<a name="l00748"></a>00748                                           FALSE,
<a name="l00749"></a>00749                                           NULL, NULL,
<a name="l00750"></a>00750                                           task-&gt;<a class="code" href="struct__SyncTask.html#aed3920db60e520cf749b53fa3b6caca8">http_version</a>,
<a name="l00751"></a>00751                                           &amp;error) &lt; 0) {
<a name="l00752"></a>00752             seaf_warning (<span class="stringliteral">&quot;Failed to start http download: %s.\n&quot;</span>, error-&gt;message);
<a name="l00753"></a>00753             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a66c8cfe8e07f2f0d6e7ae6d83575a9e6">SYNC_ERROR_START_FETCH</a>);
<a name="l00754"></a>00754             <span class="keywordflow">return</span>;
<a name="l00755"></a>00755         }
<a name="l00756"></a>00756         task-&gt;<a class="code" href="struct__SyncTask.html#a205ad78d2d7e9f477e1b4ddeb95d681a">tx_id</a> = g_strdup(repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00757"></a>00757     }
<a name="l00758"></a>00758 
<a name="l00759"></a>00759     transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da4d3da856442685e0c11e7b8d6da4ae7a">SYNC_STATE_FETCH</a>);
<a name="l00760"></a>00760 }
<a name="l00761"></a>00761 
<a name="l00762"></a><a class="code" href="structMergeResult.html">00762</a> <span class="keyword">struct </span><a class="code" href="structMergeResult.html">MergeResult</a> {
<a name="l00763"></a><a class="code" href="structMergeResult.html#a6d2d62ae6e2a3ff34be23ae20795a578">00763</a>     <a class="code" href="struct__SyncTask.html">SyncTask</a> *<a class="code" href="structMergeResult.html#a6d2d62ae6e2a3ff34be23ae20795a578">task</a>;
<a name="l00764"></a><a class="code" href="structMergeResult.html#aae6dbbbb06f03a10fb85e873394d460b">00764</a>     gboolean <a class="code" href="structMergeResult.html#aae6dbbbb06f03a10fb85e873394d460b">success</a>;
<a name="l00765"></a><a class="code" href="structMergeResult.html#a6f24e94ec5f9a07e9c13218dc004568f">00765</a>     <span class="keywordtype">int</span> <a class="code" href="structMergeResult.html#a6f24e94ec5f9a07e9c13218dc004568f">merge_status</a>;
<a name="l00766"></a><a class="code" href="structMergeResult.html#ac99d00a73e94d0397c6a8a2ff341001b">00766</a>     gboolean <a class="code" href="structMergeResult.html#ac99d00a73e94d0397c6a8a2ff341001b">worktree_dirty</a>;
<a name="l00767"></a>00767 };
<a name="l00768"></a>00768 
<a name="l00769"></a>00769 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l00770"></a>00770 merge_job (<span class="keywordtype">void</span> *vtask)
<a name="l00771"></a>00771 {
<a name="l00772"></a>00772     <a class="code" href="struct__SyncTask.html">SyncTask</a> *task = vtask;
<a name="l00773"></a>00773     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>;
<a name="l00774"></a>00774     <span class="keywordtype">char</span> *err_msg = NULL;
<a name="l00775"></a>00775     <span class="keyword">struct </span><a class="code" href="structMergeResult.html">MergeResult</a> *res = g_new0 (<span class="keyword">struct</span> <a class="code" href="structMergeResult.html">MergeResult</a>, 1);
<a name="l00776"></a>00776 
<a name="l00777"></a>00777     res-&gt;<a class="code" href="structMergeResult.html#a6d2d62ae6e2a3ff34be23ae20795a578">task</a> = <a class="code" href="structMergeResult.html#a6d2d62ae6e2a3ff34be23ae20795a578">task</a>;
<a name="l00778"></a>00778 
<a name="l00779"></a>00779     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>) {
<a name="l00780"></a>00780         seaf_message (<span class="stringliteral">&quot;Repo %s was deleted, don&#39;t need to merge.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00781"></a>00781         <span class="keywordflow">return</span> res;
<a name="l00782"></a>00782     }
<a name="l00783"></a>00783 
<a name="l00784"></a>00784     <span class="comment">/*</span>
<a name="l00785"></a>00785 <span class="comment">     * 4 types of errors may occur:</span>
<a name="l00786"></a>00786 <span class="comment">     * 1. merge conflicts;</span>
<a name="l00787"></a>00787 <span class="comment">     * 2. fail to checkout a file because the worktree file has been changed;</span>
<a name="l00788"></a>00788 <span class="comment">     * 3. Files are locked on Windows;</span>
<a name="l00789"></a>00789 <span class="comment">     * 4. other I/O errors.</span>
<a name="l00790"></a>00790 <span class="comment">     *</span>
<a name="l00791"></a>00791 <span class="comment">     * For 1, the next commit operation will make worktree clean.</span>
<a name="l00792"></a>00792 <span class="comment">     * For 2 and 4, the errors are ignored by the merge routine (return 0).</span>
<a name="l00793"></a>00793 <span class="comment">     * For 3, just wait another merge retry.</span>
<a name="l00794"></a>00794 <span class="comment">     * */</span>
<a name="l00795"></a>00795     <span class="keywordflow">if</span> (<a class="code" href="daemon_2repo-mgr_8c.html#a25b9a6f8f5199db34dcb95789a80eba4">seaf_repo_merge</a> (repo, <span class="stringliteral">&quot;master&quot;</span>, &amp;err_msg, &amp;res-&gt;<a class="code" href="structMergeResult.html#a6f24e94ec5f9a07e9c13218dc004568f">merge_status</a>) &lt; 0) {
<a name="l00796"></a>00796         seaf_message (<span class="stringliteral">&quot;[Sync mgr] Merge of repo %s(%.8s) is not clean.\n&quot;</span>,
<a name="l00797"></a>00797                    repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00798"></a>00798         res-&gt;<a class="code" href="structMergeResult.html#aae6dbbbb06f03a10fb85e873394d460b">success</a> = FALSE;
<a name="l00799"></a>00799         g_free (err_msg);
<a name="l00800"></a>00800         <span class="keywordflow">return</span> res;
<a name="l00801"></a>00801     }
<a name="l00802"></a>00802 
<a name="l00803"></a>00803     res-&gt;<a class="code" href="structMergeResult.html#aae6dbbbb06f03a10fb85e873394d460b">success</a> = TRUE;
<a name="l00804"></a>00804     g_free (err_msg);
<a name="l00805"></a>00805     seaf_message (<span class="stringliteral">&quot;[Sync mgr] Merged repo %s(%.8s).\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00806"></a>00806     <span class="keywordflow">return</span> res;
<a name="l00807"></a>00807 }
<a name="l00808"></a>00808 
<a name="l00809"></a>00809 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00810"></a>00810 merge_job_done (<span class="keywordtype">void</span> *vresult)
<a name="l00811"></a>00811 {
<a name="l00812"></a>00812     <span class="keyword">struct </span><a class="code" href="structMergeResult.html">MergeResult</a> *res = vresult;
<a name="l00813"></a>00813     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = res-&gt;<a class="code" href="structMergeResult.html#a6d2d62ae6e2a3ff34be23ae20795a578">task</a>-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>;
<a name="l00814"></a>00814 
<a name="l00815"></a>00815     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>) {
<a name="l00816"></a>00816         transition_sync_state (res-&gt;<a class="code" href="structMergeResult.html#a6d2d62ae6e2a3ff34be23ae20795a578">task</a>, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da8e0121d3e9964268e71fd702733f2579">SYNC_STATE_CANCELED</a>);
<a name="l00817"></a>00817         <a class="code" href="daemon_2repo-mgr_8c.html#afdce2de6ee36dcf6b6264ac35fb17f7a">seaf_repo_manager_del_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo);
<a name="l00818"></a>00818         g_free (res);
<a name="l00819"></a>00819         <span class="keywordflow">return</span>;
<a name="l00820"></a>00820     }
<a name="l00821"></a>00821 
<a name="l00822"></a>00822     <span class="keywordflow">if</span> (res-&gt;<a class="code" href="structMergeResult.html#a6d2d62ae6e2a3ff34be23ae20795a578">task</a>-&gt;<a class="code" href="struct__SyncTask.html#a442ac2b31e670693c3f1ec595a158ae4">state</a> == <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da4bdd5ea7e9e244ed294244fb4b31924d">SYNC_STATE_CANCEL_PENDING</a>) {
<a name="l00823"></a>00823         transition_sync_state (res-&gt;<a class="code" href="structMergeResult.html#a6d2d62ae6e2a3ff34be23ae20795a578">task</a>, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da8e0121d3e9964268e71fd702733f2579">SYNC_STATE_CANCELED</a>);
<a name="l00824"></a>00824         g_free (res);
<a name="l00825"></a>00825         <span class="keywordflow">return</span>;
<a name="l00826"></a>00826     }
<a name="l00827"></a>00827 
<a name="l00828"></a>00828     <span class="keywordflow">if</span> (res-&gt;<a class="code" href="structMergeResult.html#aae6dbbbb06f03a10fb85e873394d460b">success</a>) {
<a name="l00829"></a>00829         <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *local;
<a name="l00830"></a>00830         <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *master = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>,
<a name="l00831"></a>00831                                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l00832"></a>00832                                                              <span class="stringliteral">&quot;master&quot;</span>);
<a name="l00833"></a>00833         <span class="keywordflow">if</span> (!master) {
<a name="l00834"></a>00834             seaf_warning (<span class="stringliteral">&quot;[sync mgr] master branch doesn&#39;t exist.\n&quot;</span>);
<a name="l00835"></a>00835             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (res-&gt;<a class="code" href="structMergeResult.html#a6d2d62ae6e2a3ff34be23ae20795a578">task</a>, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a180b83198b20ee2f2412619b9fd41600">SYNC_ERROR_DATA_CORRUPT</a>);
<a name="l00836"></a>00836             <span class="keywordflow">goto</span> out;
<a name="l00837"></a>00837         }
<a name="l00838"></a>00838         <span class="comment">/* Save head commit id of master branch for GC, since we&#39;ve</span>
<a name="l00839"></a>00839 <span class="comment">         * checked out the blocks on the master branch.</span>
<a name="l00840"></a>00840 <span class="comment">         */</span>
<a name="l00841"></a>00841         <a class="code" href="daemon_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l00842"></a>00842                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l00843"></a>00843                                              <a class="code" href="daemon_2repo-mgr_8h.html#af63040384723b88eb87e261c8ebb298b">REPO_REMOTE_HEAD</a>,
<a name="l00844"></a>00844                                              master-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l00845"></a>00845         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (master);
<a name="l00846"></a>00846 
<a name="l00847"></a>00847         <span class="comment">/* If it&#39;s a ff merge, also update REPO_LOCAL_HEAD. */</span>
<a name="l00848"></a>00848         <span class="keywordflow">switch</span> (res-&gt;<a class="code" href="structMergeResult.html#a6f24e94ec5f9a07e9c13218dc004568f">merge_status</a>) {
<a name="l00849"></a>00849         <span class="keywordflow">case</span> <a class="code" href="daemon_2repo-mgr_8h.html#ab48899087cc647f0f791ed0c459adc53ae88b9f0b426e62748bda17f4cdda0400">MERGE_STATUS_FAST_FORWARD</a>:
<a name="l00850"></a>00850             local = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>,
<a name="l00851"></a>00851                                                     repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l00852"></a>00852                                                     <span class="stringliteral">&quot;local&quot;</span>);
<a name="l00853"></a>00853             <span class="keywordflow">if</span> (!local) {
<a name="l00854"></a>00854                 seaf_warning (<span class="stringliteral">&quot;[sync mgr] local branch doesn&#39;t exist.\n&quot;</span>);
<a name="l00855"></a>00855                 <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (res-&gt;<a class="code" href="structMergeResult.html#a6d2d62ae6e2a3ff34be23ae20795a578">task</a>, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a180b83198b20ee2f2412619b9fd41600">SYNC_ERROR_DATA_CORRUPT</a>);
<a name="l00856"></a>00856                 <span class="keywordflow">goto</span> out;
<a name="l00857"></a>00857             }
<a name="l00858"></a>00858 
<a name="l00859"></a>00859             <a class="code" href="daemon_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l00860"></a>00860                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l00861"></a>00861                                                  <a class="code" href="daemon_2repo-mgr_8h.html#ab09a088f0dfff9872d5dfb605ed1cade">REPO_LOCAL_HEAD</a>,
<a name="l00862"></a>00862                                                  local-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l00863"></a>00863             <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (local);
<a name="l00864"></a>00864 
<a name="l00865"></a>00865             transition_sync_state (res-&gt;<a class="code" href="structMergeResult.html#a6d2d62ae6e2a3ff34be23ae20795a578">task</a>, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da3c73047f0bdb59ed767efc67261354bb">SYNC_STATE_DONE</a>);
<a name="l00866"></a>00866             <span class="keywordflow">break</span>;
<a name="l00867"></a>00867         <span class="keywordflow">case</span> <a class="code" href="daemon_2repo-mgr_8h.html#ab48899087cc647f0f791ed0c459adc53a838e7d086c148e6873ba7408ec010b53">MERGE_STATUS_REAL_MERGE</a>:
<a name="l00868"></a>00868             start_upload_if_necessary (res-&gt;<a class="code" href="structMergeResult.html#a6d2d62ae6e2a3ff34be23ae20795a578">task</a>);
<a name="l00869"></a>00869             <span class="keywordflow">break</span>;
<a name="l00870"></a>00870         <span class="keywordflow">case</span> <a class="code" href="daemon_2repo-mgr_8h.html#ab48899087cc647f0f791ed0c459adc53a06828bd6cd4c8965ecca5747bf0d582f">MERGE_STATUS_UPTODATE</a>:
<a name="l00871"></a>00871             transition_sync_state (res-&gt;<a class="code" href="structMergeResult.html#a6d2d62ae6e2a3ff34be23ae20795a578">task</a>, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da3c73047f0bdb59ed767efc67261354bb">SYNC_STATE_DONE</a>);
<a name="l00872"></a>00872             <span class="keywordflow">break</span>;
<a name="l00873"></a>00873         }
<a name="l00874"></a>00874     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res-&gt;<a class="code" href="structMergeResult.html#ac99d00a73e94d0397c6a8a2ff341001b">worktree_dirty</a>)
<a name="l00875"></a>00875         <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (res-&gt;<a class="code" href="structMergeResult.html#a6d2d62ae6e2a3ff34be23ae20795a578">task</a>, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a0d1fb5ac07bf96d64db559d832fe759e">SYNC_ERROR_WORKTREE_DIRTY</a>);
<a name="l00876"></a>00876     <span class="keywordflow">else</span>
<a name="l00877"></a>00877         <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (res-&gt;<a class="code" href="structMergeResult.html#a6d2d62ae6e2a3ff34be23ae20795a578">task</a>, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a3cb3d1dcf06dfbce5ddefebde300da42">SYNC_ERROR_MERGE</a>);
<a name="l00878"></a>00878 
<a name="l00879"></a>00879 out:
<a name="l00880"></a>00880     g_free (res);
<a name="l00881"></a>00881 }
<a name="l00882"></a>00882 
<a name="l00883"></a>00883 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00884"></a>00884 merge_branches_if_necessary (<a class="code" href="struct__SyncTask.html">SyncTask</a> *task)
<a name="l00885"></a>00885 {
<a name="l00886"></a>00886     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>;
<a name="l00887"></a>00887 
<a name="l00888"></a>00888     <span class="comment">/* Repo is not checked out yet. */</span>
<a name="l00889"></a>00889     <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>) {
<a name="l00890"></a>00890         transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da3c73047f0bdb59ed767efc67261354bb">SYNC_STATE_DONE</a>);
<a name="l00891"></a>00891         <span class="keywordflow">return</span>;
<a name="l00892"></a>00892     }
<a name="l00893"></a>00893     transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89daf15f2ef041660fd4bc9e1a7cd2b31adc">SYNC_STATE_MERGE</a>);
<a name="l00894"></a>00894 
<a name="l00895"></a>00895     <a class="code" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768">ccnet_job_manager_schedule_job</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#abcbb9886e315abb16c620ce49808a0b2">job_mgr</a>, 
<a name="l00896"></a>00896                                     merge_job, 
<a name="l00897"></a>00897                                     merge_job_done,
<a name="l00898"></a>00898                                     task);
<a name="l00899"></a>00899 }
<a name="l00900"></a>00900 
<a name="l00901"></a><a class="code" href="structCheckFFData.html">00901</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00902"></a><a class="code" href="structCheckFFData.html#a1774f584128c5257406f1baf9b9b1ecf">00902</a>     <span class="keywordtype">char</span> remote_id[41];
<a name="l00903"></a><a class="code" href="structCheckFFData.html#af255c8d9fd0d332b8b72f3ee1fb849a7">00903</a>     <span class="keywordtype">char</span> last_uploaded[41];
<a name="l00904"></a><a class="code" href="structCheckFFData.html#a1a2d916a3078e8c77f5f0074ee3d7b3a">00904</a>     <span class="keywordtype">char</span> last_checkout[41];
<a name="l00905"></a><a class="code" href="structCheckFFData.html#aaea5d814159ad2a236d1b32e89fc57b1">00905</a>     gboolean <a class="code" href="structCheckFFData.html#aaea5d814159ad2a236d1b32e89fc57b1">result</a>;
<a name="l00906"></a>00906 } <a class="code" href="structCheckFFData.html">CheckFFData</a>;
<a name="l00907"></a>00907 
<a name="l00908"></a>00908 <span class="keyword">static</span> gboolean
<a name="l00909"></a>00909 check_fast_forward (<a class="code" href="struct__SeafCommit.html">SeafCommit</a> *commit, <span class="keywordtype">void</span> *vdata, gboolean *stop)
<a name="l00910"></a>00910 {
<a name="l00911"></a>00911     <a class="code" href="structCheckFFData.html">CheckFFData</a> *data = vdata;
<a name="l00912"></a>00912 
<a name="l00913"></a>00913     <span class="keywordflow">if</span> (strcmp (commit-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>, data-&gt;<a class="code" href="structCheckFFData.html#a1774f584128c5257406f1baf9b9b1ecf">remote_id</a>) == 0) {
<a name="l00914"></a>00914         *stop = TRUE;
<a name="l00915"></a>00915         data-&gt;<a class="code" href="structCheckFFData.html#aaea5d814159ad2a236d1b32e89fc57b1">result</a> = TRUE;
<a name="l00916"></a>00916         <span class="keywordflow">return</span> TRUE;
<a name="l00917"></a>00917     }
<a name="l00918"></a>00918 
<a name="l00919"></a>00919     <span class="keywordflow">if</span> (strcmp (commit-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>, data-&gt;<a class="code" href="structCheckFFData.html#af255c8d9fd0d332b8b72f3ee1fb849a7">last_uploaded</a>) == 0 ||
<a name="l00920"></a>00920         strcmp (commit-&gt;<a class="code" href="struct__SeafCommit.html#a104ba59f297c87bbc769576d2c3d6563">commit_id</a>, data-&gt;<a class="code" href="structCheckFFData.html#a1a2d916a3078e8c77f5f0074ee3d7b3a">last_checkout</a>) == 0) {
<a name="l00921"></a>00921         *stop = TRUE;
<a name="l00922"></a>00922         <span class="keywordflow">return</span> TRUE;
<a name="l00923"></a>00923     }
<a name="l00924"></a>00924 
<a name="l00925"></a>00925     <span class="keywordflow">return</span> TRUE;
<a name="l00926"></a>00926 }
<a name="l00927"></a>00927 
<a name="l00928"></a>00928 <span class="keyword">static</span> gboolean
<a name="l00929"></a>00929 check_fast_forward_with_limit (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo,
<a name="l00930"></a>00930                                <span class="keyword">const</span> <span class="keywordtype">char</span> *local_id,
<a name="l00931"></a>00931                                <span class="keyword">const</span> <span class="keywordtype">char</span> *remote_id,
<a name="l00932"></a>00932                                <span class="keyword">const</span> <span class="keywordtype">char</span> *last_uploaded,
<a name="l00933"></a>00933                                <span class="keyword">const</span> <span class="keywordtype">char</span> *last_checkout,
<a name="l00934"></a>00934                                gboolean *error)
<a name="l00935"></a>00935 {
<a name="l00936"></a>00936     <a class="code" href="structCheckFFData.html">CheckFFData</a> data;
<a name="l00937"></a>00937 
<a name="l00938"></a>00938     memset (&amp;data, 0, <span class="keyword">sizeof</span>(data));
<a name="l00939"></a>00939     memcpy (data.<a class="code" href="structCheckFFData.html#a1774f584128c5257406f1baf9b9b1ecf">remote_id</a>, remote_id, 40);
<a name="l00940"></a>00940     memcpy (data.<a class="code" href="structCheckFFData.html#af255c8d9fd0d332b8b72f3ee1fb849a7">last_uploaded</a>, last_uploaded, 40);
<a name="l00941"></a>00941     memcpy (data.<a class="code" href="structCheckFFData.html#a1a2d916a3078e8c77f5f0074ee3d7b3a">last_checkout</a>, last_checkout, 40);
<a name="l00942"></a>00942     *error = FALSE;
<a name="l00943"></a>00943 
<a name="l00944"></a>00944     <span class="keywordflow">if</span> (!<a class="code" href="commit-mgr_8c.html#a7a915577c5ab3095960ef08474a35aa0">seaf_commit_manager_traverse_commit_tree_truncated</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l00945"></a>00945                                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l00946"></a>00946                                                              repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
<a name="l00947"></a>00947                                                              local_id,
<a name="l00948"></a>00948                                                              check_fast_forward,
<a name="l00949"></a>00949                                                              &amp;data, FALSE)) {
<a name="l00950"></a>00950         seaf_warning (<span class="stringliteral">&quot;Failed to traverse commit tree from %s.\n&quot;</span>, local_id);
<a name="l00951"></a>00951         *error = TRUE;
<a name="l00952"></a>00952         <span class="keywordflow">return</span> FALSE;
<a name="l00953"></a>00953     }
<a name="l00954"></a>00954 
<a name="l00955"></a>00955     <span class="keywordflow">return</span> data.<a class="code" href="structCheckFFData.html#aaea5d814159ad2a236d1b32e89fc57b1">result</a>;
<a name="l00956"></a>00956 }
<a name="l00957"></a>00957 
<a name="l00958"></a>00958 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00959"></a>00959 getca_done_cb (<a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor, gboolean success, <span class="keywordtype">void</span> *data)
<a name="l00960"></a>00960 {
<a name="l00961"></a>00961     <a class="code" href="struct__SyncTask.html">SyncTask</a> *task = data;
<a name="l00962"></a>00962     <a class="code" href="struct__SyncInfo.html">SyncInfo</a> *info = task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a>;
<a name="l00963"></a>00963     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>;
<a name="l00964"></a>00964     <a class="code" href="struct__SeafileGetcaProc.html">SeafileGetcaProc</a> *proc = (<a class="code" href="struct__SeafileGetcaProc.html">SeafileGetcaProc</a> *)processor;
<a name="l00965"></a>00965     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *master;
<a name="l00966"></a>00966 
<a name="l00967"></a>00967     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>) {
<a name="l00968"></a>00968         transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da8e0121d3e9964268e71fd702733f2579">SYNC_STATE_CANCELED</a>);
<a name="l00969"></a>00969         <a class="code" href="daemon_2repo-mgr_8c.html#afdce2de6ee36dcf6b6264ac35fb17f7a">seaf_repo_manager_del_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo);
<a name="l00970"></a>00970         <span class="keywordflow">return</span>;
<a name="l00971"></a>00971     }
<a name="l00972"></a>00972 
<a name="l00973"></a>00973     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__SyncTask.html#a442ac2b31e670693c3f1ec595a158ae4">state</a> == <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da4bdd5ea7e9e244ed294244fb4b31924d">SYNC_STATE_CANCEL_PENDING</a>) {
<a name="l00974"></a>00974         transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da8e0121d3e9964268e71fd702733f2579">SYNC_STATE_CANCELED</a>);
<a name="l00975"></a>00975         <span class="keywordflow">return</span>;
<a name="l00976"></a>00976     }
<a name="l00977"></a>00977 
<a name="l00978"></a>00978     <span class="keywordflow">if</span> (!success) {
<a name="l00979"></a>00979         <span class="keywordflow">switch</span> (processor-&gt;<a class="code" href="struct__CcnetProcessor.html#a044d12f3870190314e8fe43d636fd823">failure</a>) {
<a name="l00980"></a>00980         <span class="keywordflow">case</span> <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260a32e3732cd459464942237b9963e3cfa7">PROC_NO_SERVICE</a>:
<a name="l00981"></a>00981             seaf_warning (<span class="stringliteral">&quot;Server doesn&#39;t support putca-proc.\n&quot;</span>);
<a name="l00982"></a>00982             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a2cbd24f8c6809692a56d71324d92db9b">SYNC_ERROR_DEPRECATED_SERVER</a>);
<a name="l00983"></a>00983             <span class="keywordflow">break</span>;
<a name="l00984"></a>00984         <span class="keywordflow">case</span> <a class="code" href="getca-proc_8h.html#a11a3b8ff2bb0c96d440fe3bdaa187da1">GETCA_PROC_ACCESS_DENIED</a>:
<a name="l00985"></a>00985             seaf_warning (<span class="stringliteral">&quot;No permission to access repo %.8s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00986"></a>00986             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a6a98b81697cbbb8bcff96c1360f7ed01">SYNC_ERROR_ACCESS_DENIED</a>);
<a name="l00987"></a>00987             <span class="keywordflow">break</span>;
<a name="l00988"></a>00988         <span class="keywordflow">case</span> <a class="code" href="getca-proc_8h.html#af9a9028db5f54f6c59e8111e09095455">GETCA_PROC_NO_CA</a>:
<a name="l00989"></a>00989             seaf_warning (<span class="stringliteral">&quot;Compute common ancestor failed for %.8s.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l00990"></a>00990             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a3839a8ff16af7993849949da453d0c43">SYNC_ERROR_UNKNOWN</a>);
<a name="l00991"></a>00991             <span class="keywordflow">break</span>;
<a name="l00992"></a>00992         <span class="keywordflow">case</span> <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260a3034ea6f6eb7c4ecc98d1d4b45aabcdf">PROC_REMOTE_DEAD</a>:
<a name="l00993"></a>00993             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55aea2057a6ab1581e1d79fa81a3f44fb71">SYNC_ERROR_SERVICE_DOWN</a>);
<a name="l00994"></a>00994             <span class="keywordflow">break</span>;
<a name="l00995"></a>00995         <span class="keywordflow">case</span> <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260aab69eea021cf87799528c363e8a6e88c">PROC_PERM_ERR</a>:
<a name="l00996"></a>00996             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a461a5ffea0714ff980112c23c2dae052">SYNC_ERROR_PROC_PERM_ERR</a>);
<a name="l00997"></a>00997             <span class="keywordflow">break</span>;
<a name="l00998"></a>00998         <span class="keywordflow">case</span> <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260a356349f5c99d03c7721d011d08ccd624">PROC_DONE</a>:
<a name="l00999"></a>00999             <span class="comment">/* It can never happen */</span>
<a name="l01000"></a>01000             g_return_if_reached ();
<a name="l01001"></a>01001         <span class="keywordflow">case</span> <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260a78f0f66889520ef72e7ff02d7bb6d283">PROC_BAD_RESP</a>:
<a name="l01002"></a>01002         <span class="keywordflow">case</span> <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260a446522776dda7bc0ec1ac63acf582f53">PROC_NOTSET</a>:
<a name="l01003"></a>01003         <span class="keywordflow">default</span>:
<a name="l01004"></a>01004             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a3839a8ff16af7993849949da453d0c43">SYNC_ERROR_UNKNOWN</a>);
<a name="l01005"></a>01005         }
<a name="l01006"></a>01006         <span class="keywordflow">return</span>;
<a name="l01007"></a>01007     }
<a name="l01008"></a>01008 
<a name="l01009"></a>01009     <a class="code" href="daemon_2repo-mgr_8c.html#af2f71495e665325efae99d4beb03deb5">seaf_repo_manager_set_common_ancestor</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l01010"></a>01010                                            repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l01011"></a>01011                                            proc-&gt;<a class="code" href="struct__SeafileGetcaProc.html#a6bfbef27f183c828c0ac87a332c8dde1">ca_id</a>,
<a name="l01012"></a>01012                                            repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l01013"></a>01013 
<a name="l01014"></a>01014     master = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>,
<a name="l01015"></a>01015                                              info-&gt;<a class="code" href="struct__SyncInfo.html#a18a9302a6bb2f4e1b8e67171c9664c8b">repo_id</a>,
<a name="l01016"></a>01016                                              <span class="stringliteral">&quot;master&quot;</span>);
<a name="l01017"></a>01017 
<a name="l01018"></a>01018     <span class="keywordflow">if</span> (!master || strcmp (info-&gt;<a class="code" href="struct__SyncInfo.html#a9e831740601198ad30ee08db5b64382a">head_commit</a>, master-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>) != 0) {
<a name="l01019"></a>01019         start_fetch_if_necessary (task, NULL);
<a name="l01020"></a>01020     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>, master-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>) != 0) {
<a name="l01021"></a>01021         <span class="comment">/* Try to merge even if we don&#39;t need to fetch. */</span>
<a name="l01022"></a>01022         merge_branches_if_necessary (task);
<a name="l01023"></a>01023     }
<a name="l01024"></a>01024 
<a name="l01025"></a>01025     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (master);
<a name="l01026"></a>01026 }
<a name="l01027"></a>01027 
<a name="l01028"></a>01028 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01029"></a>01029 start_get_ca_proc (<a class="code" href="struct__SyncTask.html">SyncTask</a> *task, <span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l01030"></a>01030 {
<a name="l01031"></a>01031     <a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor;
<a name="l01032"></a>01032 
<a name="l01033"></a>01033     processor = <a class="code" href="include_2ccnet_2proc-factory_8h.html#a4e77de8f2768695e93845129041759c7">ccnet_proc_factory_create_remote_master_processor</a> (
<a name="l01034"></a>01034         <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>, <span class="stringliteral">&quot;seafile-getca&quot;</span>, task-&gt;<a class="code" href="struct__SyncTask.html#a956579282afe1f78871352ed31488946">dest_id</a>);
<a name="l01035"></a>01035     <span class="keywordflow">if</span> (!processor) {
<a name="l01036"></a>01036         seaf_warning (<span class="stringliteral">&quot;[sync-mgr] failed to create getca proc.\n&quot;</span>);
<a name="l01037"></a>01037         <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a3839a8ff16af7993849949da453d0c43">SYNC_ERROR_UNKNOWN</a>);
<a name="l01038"></a>01038         <span class="keywordflow">return</span> -1;
<a name="l01039"></a>01039     }
<a name="l01040"></a>01040 
<a name="l01041"></a>01041     <span class="keywordflow">if</span> (<a class="code" href="include_2ccnet_2processor_8h.html#ae2bb4b51c8e7dd43366b777ca9b00cf6">ccnet_processor_startl</a> (processor, repo_id, task-&gt;<a class="code" href="struct__SyncTask.html#a49503a78f8c685ae2361ef400fabfb47">token</a>, NULL) &lt; 0) {
<a name="l01042"></a>01042         seaf_warning (<span class="stringliteral">&quot;[sync-mgr] failed to start getca proc.\n&quot;</span>);
<a name="l01043"></a>01043         <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a3839a8ff16af7993849949da453d0c43">SYNC_ERROR_UNKNOWN</a>);
<a name="l01044"></a>01044         <span class="keywordflow">return</span> -1;
<a name="l01045"></a>01045     }
<a name="l01046"></a>01046 
<a name="l01047"></a>01047     g_signal_connect (processor, <span class="stringliteral">&quot;done&quot;</span>, (GCallback)getca_done_cb, task);
<a name="l01048"></a>01048     <span class="keywordflow">return</span> 0;
<a name="l01049"></a>01049 }
<a name="l01050"></a>01050 
<a name="l01051"></a>01051 <span class="comment">/* Return TURE if we started a processor, otherwise return FALSE. */</span>
<a name="l01052"></a>01052 <span class="keyword">static</span> gboolean
<a name="l01053"></a>01053 update_common_ancestor (<a class="code" href="struct__SyncTask.html">SyncTask</a> *task,
<a name="l01054"></a>01054                         <span class="keyword">const</span> <span class="keywordtype">char</span> *last_uploaded,
<a name="l01055"></a>01055                         <span class="keyword">const</span> <span class="keywordtype">char</span> *last_checkout)
<a name="l01056"></a>01056 {
<a name="l01057"></a>01057     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>;
<a name="l01058"></a>01058     <span class="keywordtype">char</span> *local_head = repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>;
<a name="l01059"></a>01059     <span class="keywordtype">char</span> ca_id[41], cached_head_id[41];
<a name="l01060"></a>01060 
<a name="l01061"></a>01061     <span class="comment">/* If common ancestor result is not cached, we need to compute it. */</span>
<a name="l01062"></a>01062     <span class="keywordflow">if</span> (<a class="code" href="daemon_2repo-mgr_8c.html#a3d8affa43a26075cdd6821e330f68748">seaf_repo_manager_get_common_ancestor</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l01063"></a>01063                                                ca_id, cached_head_id) &lt; 0)
<a name="l01064"></a>01064         <span class="keywordflow">goto</span> update_common_ancestor;
<a name="l01065"></a>01065 
<a name="l01066"></a>01066     <span class="comment">/* If the head id is unchanged, use the cached common ancestor id directly.</span>
<a name="l01067"></a>01067 <span class="comment">     * Common ancestor won&#39;t change if the local head is not updated.</span>
<a name="l01068"></a>01068 <span class="comment">     */</span>
<a name="l01069"></a>01069     <span class="keywordflow">if</span> (strcmp (cached_head_id, local_head) == 0) {
<a name="l01070"></a>01070         seaf_debug (<span class="stringliteral">&quot;Use cached common ancestor.\n&quot;</span>);
<a name="l01071"></a>01071         <span class="keywordflow">return</span> FALSE;
<a name="l01072"></a>01072     }
<a name="l01073"></a>01073 
<a name="l01074"></a>01074 update_common_ancestor:
<a name="l01075"></a>01075     <span class="keywordflow">if</span> (strcmp (last_uploaded, local_head) == 0 ||
<a name="l01076"></a>01076         strcmp (last_checkout, local_head) == 0) {
<a name="l01077"></a>01077         seaf_debug (<span class="stringliteral">&quot;Use local head as common ancestor.\n&quot;</span>);
<a name="l01078"></a>01078         <a class="code" href="daemon_2repo-mgr_8c.html#af2f71495e665325efae99d4beb03deb5">seaf_repo_manager_set_common_ancestor</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l01079"></a>01079                                                local_head, local_head);
<a name="l01080"></a>01080         <span class="keywordflow">return</span> FALSE;
<a name="l01081"></a>01081     }
<a name="l01082"></a>01082 
<a name="l01083"></a>01083     start_get_ca_proc (task, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01084"></a>01084     <span class="keywordflow">return</span> TRUE;
<a name="l01085"></a>01085 }
<a name="l01086"></a>01086 
<a name="l01087"></a>01087 <span class="keyword">static</span> gboolean
<a name="l01088"></a>01088 repo_block_store_exists (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l01089"></a>01089 {
<a name="l01090"></a>01090     gboolean ret;
<a name="l01091"></a>01091     <span class="keywordtype">char</span> *store_path = g_build_filename (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ae4df188e5674e3e4b405f14d0ee1bf9f">seaf_dir</a>, <span class="stringliteral">&quot;storage&quot;</span>, <span class="stringliteral">&quot;blocks&quot;</span>,
<a name="l01092"></a>01092                                          repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, NULL);
<a name="l01093"></a>01093     <span class="keywordflow">if</span> (g_file_test (store_path, G_FILE_TEST_IS_DIR))
<a name="l01094"></a>01094         ret = TRUE;
<a name="l01095"></a>01095     <span class="keywordflow">else</span>
<a name="l01096"></a>01096         ret = FALSE;
<a name="l01097"></a>01097     g_free (store_path);
<a name="l01098"></a>01098     <span class="keywordflow">return</span> ret;
<a name="l01099"></a>01099 }
<a name="l01100"></a>01100 
<a name="l01101"></a>01101 <span class="preprocessor">#ifdef WIN32</span>
<a name="l01102"></a>01102 <span class="preprocessor"></span>
<a name="l01103"></a>01103 <span class="keyword">static</span> GHashTable *
<a name="l01104"></a>01104 load_locked_files_blocks (<span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id)
<a name="l01105"></a>01105 {
<a name="l01106"></a>01106     <a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset;
<a name="l01107"></a>01107     GHashTable *block_id_hash;
<a name="l01108"></a>01108     GHashTableIter iter;
<a name="l01109"></a>01109     gpointer key, value;
<a name="l01110"></a>01110     <a class="code" href="struct__LockedFile.html">LockedFile</a> *locked;
<a name="l01111"></a>01111     <a class="code" href="struct__Seafile.html">Seafile</a> *file;
<a name="l01112"></a>01112     <span class="keywordtype">int</span> i;
<a name="l01113"></a>01113     <span class="keywordtype">char</span> *blk_id;
<a name="l01114"></a>01114 
<a name="l01115"></a>01115     fset = <a class="code" href="daemon_2repo-mgr_8c.html#a06294e91365be10d46a356d427f62e07">seaf_repo_manager_get_locked_file_set</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo_id);
<a name="l01116"></a>01116 
<a name="l01117"></a>01117     block_id_hash = g_hash_table_new_full (g_str_hash, g_str_equal, g_free, NULL);
<a name="l01118"></a>01118 
<a name="l01119"></a>01119     g_hash_table_iter_init (&amp;iter, fset-&gt;<a class="code" href="struct__LockedFileSet.html#a228bfd2b438cfa59fcf2dbd596ce335a">locked_files</a>);
<a name="l01120"></a>01120     <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
<a name="l01121"></a>01121         locked = value;
<a name="l01122"></a>01122 
<a name="l01123"></a>01123         <span class="keywordflow">if</span> (strcmp (locked-&gt;<a class="code" href="struct__LockedFile.html#abdcab3c93928ff7a61146d497d5e4ec7">operation</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a73695736a3b6d6bc38b8a7e439dba0b4">LOCKED_OP_UPDATE</a>) == 0) {
<a name="l01124"></a>01124             file = <a class="code" href="fs-mgr_8c.html#a029c16e2ecdf6eafd96edb2ee4e6beac">seaf_fs_manager_get_seafile</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
<a name="l01125"></a>01125                                                 fset-&gt;<a class="code" href="struct__LockedFileSet.html#ae51031b45e0a18e92898ce33bef301fe">repo_id</a>, 1,
<a name="l01126"></a>01126                                                 locked-&gt;<a class="code" href="struct__LockedFile.html#aebea73a3294e0a1493195022ffce6f23">file_id</a>);
<a name="l01127"></a>01127             <span class="keywordflow">if</span> (!file) {
<a name="l01128"></a>01128                 seaf_warning (<span class="stringliteral">&quot;Failed to find file %s in repo %.8s.\n&quot;</span>,
<a name="l01129"></a>01129                               locked-&gt;<a class="code" href="struct__LockedFile.html#aebea73a3294e0a1493195022ffce6f23">file_id</a>, fset-&gt;<a class="code" href="struct__LockedFileSet.html#ae51031b45e0a18e92898ce33bef301fe">repo_id</a>);
<a name="l01130"></a>01130                 <span class="keywordflow">continue</span>;
<a name="l01131"></a>01131             }
<a name="l01132"></a>01132 
<a name="l01133"></a>01133             <span class="keywordflow">for</span> (i = 0; i &lt; file-&gt;<a class="code" href="struct__Seafile.html#af2d5c5e5bb56d38122dead42128b9c20">n_blocks</a>; ++i) {
<a name="l01134"></a>01134                 blk_id = g_strdup (file-&gt;<a class="code" href="struct__Seafile.html#aacaedff2674132faf3d522ba8df6e268">blk_sha1s</a>[i]);
<a name="l01135"></a>01135                 g_hash_table_replace (block_id_hash, blk_id, blk_id);
<a name="l01136"></a>01136             }
<a name="l01137"></a>01137 
<a name="l01138"></a>01138             <a class="code" href="fs-mgr_8c.html#a0a491c647769cf7bd09d5092ab84b85a">seafile_unref</a> (file);
<a name="l01139"></a>01139         }
<a name="l01140"></a>01140     }
<a name="l01141"></a>01141 
<a name="l01142"></a>01142     <a class="code" href="daemon_2repo-mgr_8c.html#ab44c57f5e23996e5eb807f7c84f443f5">locked_file_set_free</a> (fset);
<a name="l01143"></a>01143 
<a name="l01144"></a>01144     <span class="keywordflow">return</span> block_id_hash;
<a name="l01145"></a>01145 }
<a name="l01146"></a>01146 
<a name="l01147"></a>01147 <span class="keyword">static</span> gboolean
<a name="l01148"></a>01148 remove_block_cb (<span class="keyword">const</span> <span class="keywordtype">char</span> *store_id,
<a name="l01149"></a>01149                  <span class="keywordtype">int</span> <a class="code" href="block-tx-utils_8h.html#a1abe2c64ac9f8bc05bbb1719cad360f3">version</a>,
<a name="l01150"></a>01150                  <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="block-tx-utils_8h.html#a2d616e1f81d11995c8b388444be651ef">block_id</a>,
<a name="l01151"></a>01151                  <span class="keywordtype">void</span> *user_data)
<a name="l01152"></a>01152 {
<a name="l01153"></a>01153     GHashTable *block_hash = user_data;
<a name="l01154"></a>01154 
<a name="l01155"></a>01155     <span class="keywordflow">if</span> (!g_hash_table_lookup (block_hash, block_id))
<a name="l01156"></a>01156         <a class="code" href="block-mgr_8c.html#a4b9324cd1b942eb1378bc9ea7f5eaccf">seaf_block_manager_remove_block</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>, store_id, version, block_id);
<a name="l01157"></a>01157 
<a name="l01158"></a>01158     <span class="keywordflow">return</span> TRUE;
<a name="l01159"></a>01159 }
<a name="l01160"></a>01160 
<a name="l01161"></a>01161 <span class="preprocessor">#endif</span>
<a name="l01162"></a>01162 <span class="preprocessor"></span>
<a name="l01163"></a>01163 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l01164"></a>01164 remove_repo_blocks (<span class="keywordtype">void</span> *vtask)
<a name="l01165"></a>01165 {
<a name="l01166"></a>01166     <a class="code" href="struct__SyncTask.html">SyncTask</a> *task = vtask;
<a name="l01167"></a>01167 
<a name="l01168"></a>01168 <span class="preprocessor">#ifndef WIN32</span>
<a name="l01169"></a>01169 <span class="preprocessor"></span>    <a class="code" href="block-mgr_8c.html#adb9b61331732cb75b3a9e783cd7ad58c">seaf_block_manager_remove_store</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>, task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01170"></a>01170 <span class="preprocessor">#else</span>
<a name="l01171"></a>01171 <span class="preprocessor"></span>    GHashTable *block_hash;
<a name="l01172"></a>01172 
<a name="l01173"></a>01173     block_hash = load_locked_files_blocks (task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01174"></a>01174     <span class="keywordflow">if</span> (g_hash_table_size (block_hash) == 0) {
<a name="l01175"></a>01175         g_hash_table_destroy (block_hash);
<a name="l01176"></a>01176         <a class="code" href="block-mgr_8c.html#adb9b61331732cb75b3a9e783cd7ad58c">seaf_block_manager_remove_store</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>, task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01177"></a>01177         <span class="keywordflow">return</span> vtask;
<a name="l01178"></a>01178     }
<a name="l01179"></a>01179 
<a name="l01180"></a>01180     <a class="code" href="block-mgr_8c.html#a3509f9cacf52f38936e99c58ab22d59c">seaf_block_manager_foreach_block</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>,
<a name="l01181"></a>01181                                       task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l01182"></a>01182                                       task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
<a name="l01183"></a>01183                                       remove_block_cb,
<a name="l01184"></a>01184                                       block_hash);
<a name="l01185"></a>01185 
<a name="l01186"></a>01186     g_hash_table_destroy (block_hash);
<a name="l01187"></a>01187 <span class="preprocessor">#endif</span>
<a name="l01188"></a>01188 <span class="preprocessor"></span>
<a name="l01189"></a>01189     <span class="keywordflow">return</span> vtask;
<a name="l01190"></a>01190 }
<a name="l01191"></a>01191 
<a name="l01192"></a>01192 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01193"></a>01193 remove_blocks_done (<span class="keywordtype">void</span> *vtask)
<a name="l01194"></a>01194 {
<a name="l01195"></a>01195     <a class="code" href="struct__SyncTask.html">SyncTask</a> *task = vtask;
<a name="l01196"></a>01196 
<a name="l01197"></a>01197     transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da3c73047f0bdb59ed767efc67261354bb">SYNC_STATE_DONE</a>);
<a name="l01198"></a>01198 }
<a name="l01199"></a>01199 
<a name="l01200"></a>01200 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01201"></a>01201 update_sync_status (<a class="code" href="struct__SyncTask.html">SyncTask</a> *task)
<a name="l01202"></a>01202 {
<a name="l01203"></a>01203     <a class="code" href="struct__SyncInfo.html">SyncInfo</a> *info = task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a>;
<a name="l01204"></a>01204     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>;
<a name="l01205"></a>01205     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *master, *local;
<a name="l01206"></a>01206     <span class="keywordtype">char</span> *last_uploaded = NULL, *last_checkout = NULL;
<a name="l01207"></a>01207 
<a name="l01208"></a>01208     local = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (
<a name="l01209"></a>01209         <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, info-&gt;<a class="code" href="struct__SyncInfo.html#a18a9302a6bb2f4e1b8e67171c9664c8b">repo_id</a>, <span class="stringliteral">&quot;local&quot;</span>);
<a name="l01210"></a>01210     <span class="keywordflow">if</span> (!local) {
<a name="l01211"></a>01211         seaf_warning (<span class="stringliteral">&quot;[sync-mgr] Branch local not found for repo %s(%.8s).\n&quot;</span>,
<a name="l01212"></a>01212                    repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01213"></a>01213         <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a180b83198b20ee2f2412619b9fd41600">SYNC_ERROR_DATA_CORRUPT</a>);
<a name="l01214"></a>01214         <span class="keywordflow">return</span>;
<a name="l01215"></a>01215     }
<a name="l01216"></a>01216     master = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (
<a name="l01217"></a>01217         <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, info-&gt;<a class="code" href="struct__SyncInfo.html#a18a9302a6bb2f4e1b8e67171c9664c8b">repo_id</a>, <span class="stringliteral">&quot;master&quot;</span>);
<a name="l01218"></a>01218 
<a name="l01219"></a>01219     last_uploaded = <a class="code" href="daemon_2repo-mgr_8c.html#a71edf5bba9589fa8793d7b0312cb9553">seaf_repo_manager_get_repo_property</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l01220"></a>01220                                                          repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l01221"></a>01221                                                          <a class="code" href="daemon_2repo-mgr_8h.html#ab09a088f0dfff9872d5dfb605ed1cade">REPO_LOCAL_HEAD</a>);
<a name="l01222"></a>01222     <span class="keywordflow">if</span> (!last_uploaded) {
<a name="l01223"></a>01223         seaf_warning (<span class="stringliteral">&quot;Last uploaded commit id is not found in db.\n&quot;</span>);
<a name="l01224"></a>01224         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (local);
<a name="l01225"></a>01225         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (master);
<a name="l01226"></a>01226         <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a180b83198b20ee2f2412619b9fd41600">SYNC_ERROR_DATA_CORRUPT</a>);
<a name="l01227"></a>01227         <span class="keywordflow">return</span>;
<a name="l01228"></a>01228     }
<a name="l01229"></a>01229 
<a name="l01230"></a>01230     last_checkout = <a class="code" href="daemon_2repo-mgr_8c.html#a71edf5bba9589fa8793d7b0312cb9553">seaf_repo_manager_get_repo_property</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l01231"></a>01231                                                          repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l01232"></a>01232                                                          <a class="code" href="daemon_2repo-mgr_8h.html#af63040384723b88eb87e261c8ebb298b">REPO_REMOTE_HEAD</a>);
<a name="l01233"></a>01233     <span class="keywordflow">if</span> (!last_checkout) {
<a name="l01234"></a>01234         seaf_warning (<span class="stringliteral">&quot;Last checked out commit id is not found in db.\n&quot;</span>);
<a name="l01235"></a>01235         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (local);
<a name="l01236"></a>01236         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (master);
<a name="l01237"></a>01237         g_free (last_uploaded);
<a name="l01238"></a>01238         <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a180b83198b20ee2f2412619b9fd41600">SYNC_ERROR_DATA_CORRUPT</a>);
<a name="l01239"></a>01239         <span class="keywordflow">return</span>;
<a name="l01240"></a>01240     }
<a name="l01241"></a>01241 
<a name="l01242"></a>01242     <span class="keywordflow">if</span> (info-&gt;<a class="code" href="struct__SyncInfo.html#a456a4baa8b89a5eaf4d122bafa43263a">repo_corrupted</a>) {
<a name="l01243"></a>01243         <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55aac3a3d0eb6cb522cde2b064359b793c6">SYNC_ERROR_REPO_CORRUPT</a>);
<a name="l01244"></a>01244     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (info-&gt;<a class="code" href="struct__SyncInfo.html#ad3f648faaee9de704066180f885be5e1">deleted_on_relay</a>) {
<a name="l01245"></a>01245         <span class="comment">/* First upload. */</span>
<a name="l01246"></a>01246         <span class="keywordflow">if</span> (!master)
<a name="l01247"></a>01247             start_upload_if_necessary (task);
<a name="l01248"></a>01248         <span class="comment">/* If repo doesn&#39;t exist on relay and we have &quot;master&quot;,</span>
<a name="l01249"></a>01249 <span class="comment">         * it was deleted on relay. In this case we remove this repo.</span>
<a name="l01250"></a>01250 <span class="comment">         */</span>
<a name="l01251"></a>01251         <span class="keywordflow">else</span> {
<a name="l01252"></a>01252             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55acab29b78af67a6700738bfcec981d548">SYNC_ERROR_NOREPO</a>);
<a name="l01253"></a>01253 
<a name="l01254"></a>01254             seaf_warning (<span class="stringliteral">&quot;repo %s(%.8s) not found on server\n&quot;</span>,
<a name="l01255"></a>01255                         repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01256"></a>01256 
<a name="l01257"></a>01257             <span class="keywordflow">if</span> (!<a class="code" href="seafile-config_8c.html#a5be93c260e0210720f0cf25cac2fa8b6">seafile_session_config_get_allow_repo_not_found_on_server</a>(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>)) {
<a name="l01258"></a>01258                 seaf_debug (<span class="stringliteral">&quot;remove repo %s(%.8s) since it&#39;s deleted on relay\n&quot;</span>,
<a name="l01259"></a>01259                             repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01260"></a>01260                 <a class="code" href="mq-mgr_8c.html#a0e6f86438a353da6463eaf45b940f9f0">seaf_mq_manager_publish_notification</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a89e2a6000f250563b18123661ba9abbd">mq_mgr</a>,
<a name="l01261"></a>01261                                                       <span class="stringliteral">&quot;repo.deleted_on_relay&quot;</span>,
<a name="l01262"></a>01262                                                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>);
<a name="l01263"></a>01263                 <a class="code" href="daemon_2repo-mgr_8c.html#afdce2de6ee36dcf6b6264ac35fb17f7a">seaf_repo_manager_del_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo);
<a name="l01264"></a>01264             }
<a name="l01265"></a>01265         }
<a name="l01266"></a>01266     } <span class="keywordflow">else</span> {
<a name="l01267"></a>01267         <span class="comment">/* branch deleted on relay */</span>
<a name="l01268"></a>01268         <span class="keywordflow">if</span> (info-&gt;<a class="code" href="struct__SyncInfo.html#a35b97e9f978267101414813e1341e227">branch_deleted_on_relay</a>) {
<a name="l01269"></a>01269             start_upload_if_necessary (task);
<a name="l01270"></a>01270             <span class="keywordflow">goto</span> out;
<a name="l01271"></a>01271         }
<a name="l01272"></a>01272 
<a name="l01273"></a>01273         <span class="comment">/* If local head is the same as remote head, already in sync. */</span>
<a name="l01274"></a>01274         <span class="keywordflow">if</span> (strcmp (local-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>, info-&gt;<a class="code" href="struct__SyncInfo.html#a9e831740601198ad30ee08db5b64382a">head_commit</a>) == 0) {
<a name="l01275"></a>01275             <span class="comment">/* As long as the repo is synced with the server. All the local</span>
<a name="l01276"></a>01276 <span class="comment">             * blocks are not useful any more.</span>
<a name="l01277"></a>01277 <span class="comment">             */</span>
<a name="l01278"></a>01278             <span class="keywordflow">if</span> (repo_block_store_exists (repo)) {
<a name="l01279"></a>01279                 <span class="comment">/* seaf_message (&quot;Removing blocks for repo %s(%.8s).\n&quot;, */</span>
<a name="l01280"></a>01280                 <span class="comment">/*               repo-&gt;name, repo-&gt;id); */</span>
<a name="l01281"></a>01281                 <a class="code" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768">ccnet_job_manager_schedule_job</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#abcbb9886e315abb16c620ce49808a0b2">job_mgr</a>,
<a name="l01282"></a>01282                                                 remove_repo_blocks,
<a name="l01283"></a>01283                                                 remove_blocks_done,
<a name="l01284"></a>01284                                                 task);
<a name="l01285"></a>01285             } <span class="keywordflow">else</span>
<a name="l01286"></a>01286                 transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da3c73047f0bdb59ed767efc67261354bb">SYNC_STATE_DONE</a>);
<a name="l01287"></a>01287             <span class="keywordflow">goto</span> out;
<a name="l01288"></a>01288         }
<a name="l01289"></a>01289 
<a name="l01290"></a>01290         <span class="comment">/* This checking is done in the main thread. But it usually doesn&#39;t take</span>
<a name="l01291"></a>01291 <span class="comment">         * much time, because the traversing is limited by last_uploaded and</span>
<a name="l01292"></a>01292 <span class="comment">         * last_checkout commits.</span>
<a name="l01293"></a>01293 <span class="comment">         */</span>
<a name="l01294"></a>01294         gboolean error = FALSE;
<a name="l01295"></a>01295         gboolean is_ff = check_fast_forward_with_limit (repo,
<a name="l01296"></a>01296                                                         local-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>,
<a name="l01297"></a>01297                                                         info-&gt;<a class="code" href="struct__SyncInfo.html#a9e831740601198ad30ee08db5b64382a">head_commit</a>,
<a name="l01298"></a>01298                                                         last_uploaded,
<a name="l01299"></a>01299                                                         last_checkout,
<a name="l01300"></a>01300                                                         &amp;error);
<a name="l01301"></a>01301         <span class="keywordflow">if</span> (error) {
<a name="l01302"></a>01302             seaf_warning (<span class="stringliteral">&quot;Failed to check fast forward.\n&quot;</span>);
<a name="l01303"></a>01303             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a180b83198b20ee2f2412619b9fd41600">SYNC_ERROR_DATA_CORRUPT</a>);
<a name="l01304"></a>01304             <span class="keywordflow">goto</span> out;
<a name="l01305"></a>01305         }
<a name="l01306"></a>01306 
<a name="l01307"></a>01307         <span class="comment">/* fast-forward upload */</span>
<a name="l01308"></a>01308         <span class="keywordflow">if</span> (is_ff) {
<a name="l01309"></a>01309             start_upload_if_necessary (task);
<a name="l01310"></a>01310             <span class="keywordflow">goto</span> out;
<a name="l01311"></a>01311         }
<a name="l01312"></a>01312 
<a name="l01313"></a>01313         <span class="comment">/*</span>
<a name="l01314"></a>01314 <span class="comment">         * We have to compute the common ancestor before doing merge.</span>
<a name="l01315"></a>01315 <span class="comment">         * The last result of computation is cached in local db.</span>
<a name="l01316"></a>01316 <span class="comment">         * Check if we need to re-compute the common ancestor.</span>
<a name="l01317"></a>01317 <span class="comment">         * If so we&#39;ll start a processor to do that on the server.</span>
<a name="l01318"></a>01318 <span class="comment">         * For repo version == 0, we download all commits so there is no</span>
<a name="l01319"></a>01319 <span class="comment">         * need to check.</span>
<a name="l01320"></a>01320 <span class="comment">         */</span>
<a name="l01321"></a>01321         <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a> &gt; 0 &amp;&amp;
<a name="l01322"></a>01322             update_common_ancestor (task, last_uploaded, last_checkout))
<a name="l01323"></a>01323             <span class="keywordflow">goto</span> out;
<a name="l01324"></a>01324 
<a name="l01325"></a>01325         <span class="keywordflow">if</span> (!master || strcmp (info-&gt;<a class="code" href="struct__SyncInfo.html#a9e831740601198ad30ee08db5b64382a">head_commit</a>, master-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>) != 0) {
<a name="l01326"></a>01326             start_fetch_if_necessary (task, NULL);
<a name="l01327"></a>01327         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp (local-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>, master-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>) != 0) {
<a name="l01328"></a>01328             <span class="comment">/* Try to merge even if we don&#39;t need to fetch. */</span>
<a name="l01329"></a>01329             merge_branches_if_necessary (task);
<a name="l01330"></a>01330         }
<a name="l01331"></a>01331     }
<a name="l01332"></a>01332 
<a name="l01333"></a>01333 out:
<a name="l01334"></a>01334     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (local);
<a name="l01335"></a>01335     <span class="keywordflow">if</span> (master)
<a name="l01336"></a>01336         <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (master);
<a name="l01337"></a>01337     g_free (last_uploaded);
<a name="l01338"></a>01338     g_free (last_checkout);
<a name="l01339"></a>01339 }
<a name="l01340"></a>01340 
<a name="l01341"></a>01341 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01342"></a>01342 update_sync_status_v2 (<a class="code" href="struct__SyncTask.html">SyncTask</a> *task)
<a name="l01343"></a>01343 {
<a name="l01344"></a>01344     <a class="code" href="struct__SyncInfo.html">SyncInfo</a> *info = task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a>;
<a name="l01345"></a>01345     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>;
<a name="l01346"></a>01346     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *master = NULL, *local = NULL;
<a name="l01347"></a>01347 
<a name="l01348"></a>01348     local = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (
<a name="l01349"></a>01349         <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, info-&gt;<a class="code" href="struct__SyncInfo.html#a18a9302a6bb2f4e1b8e67171c9664c8b">repo_id</a>, <span class="stringliteral">&quot;local&quot;</span>);
<a name="l01350"></a>01350     <span class="keywordflow">if</span> (!local) {
<a name="l01351"></a>01351         seaf_warning (<span class="stringliteral">&quot;[sync-mgr] Branch local not found for repo %s(%.8s).\n&quot;</span>,
<a name="l01352"></a>01352                    repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01353"></a>01353         <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a180b83198b20ee2f2412619b9fd41600">SYNC_ERROR_DATA_CORRUPT</a>);
<a name="l01354"></a>01354         <span class="keywordflow">return</span>;
<a name="l01355"></a>01355     }
<a name="l01356"></a>01356 
<a name="l01357"></a>01357     master = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (
<a name="l01358"></a>01358         <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, info-&gt;<a class="code" href="struct__SyncInfo.html#a18a9302a6bb2f4e1b8e67171c9664c8b">repo_id</a>, <span class="stringliteral">&quot;master&quot;</span>);
<a name="l01359"></a>01359     <span class="keywordflow">if</span> (!master) {
<a name="l01360"></a>01360         seaf_warning (<span class="stringliteral">&quot;[sync-mgr] Branch master not found for repo %s(%.8s).\n&quot;</span>,
<a name="l01361"></a>01361                    repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01362"></a>01362         <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a180b83198b20ee2f2412619b9fd41600">SYNC_ERROR_DATA_CORRUPT</a>);
<a name="l01363"></a>01363         <span class="keywordflow">return</span>;
<a name="l01364"></a>01364     }
<a name="l01365"></a>01365 
<a name="l01366"></a>01366     <span class="keywordflow">if</span> (info-&gt;<a class="code" href="struct__SyncInfo.html#a456a4baa8b89a5eaf4d122bafa43263a">repo_corrupted</a>) {
<a name="l01367"></a>01367         <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55aac3a3d0eb6cb522cde2b064359b793c6">SYNC_ERROR_REPO_CORRUPT</a>);
<a name="l01368"></a>01368     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (info-&gt;<a class="code" href="struct__SyncInfo.html#ad3f648faaee9de704066180f885be5e1">deleted_on_relay</a>) {
<a name="l01369"></a>01369         <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55acab29b78af67a6700738bfcec981d548">SYNC_ERROR_NOREPO</a>);
<a name="l01370"></a>01370 
<a name="l01371"></a>01371         seaf_warning (<span class="stringliteral">&quot;repo %s(%.8s) not found on server\n&quot;</span>,
<a name="l01372"></a>01372                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01373"></a>01373 
<a name="l01374"></a>01374         <span class="keywordflow">if</span> (!<a class="code" href="seafile-config_8c.html#a5be93c260e0210720f0cf25cac2fa8b6">seafile_session_config_get_allow_repo_not_found_on_server</a>(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>)) {
<a name="l01375"></a>01375             seaf_message (<span class="stringliteral">&quot;remove repo %s(%.8s) since it&#39;s deleted on relay\n&quot;</span>,
<a name="l01376"></a>01376                         repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01377"></a>01377             <a class="code" href="mq-mgr_8c.html#a0e6f86438a353da6463eaf45b940f9f0">seaf_mq_manager_publish_notification</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a89e2a6000f250563b18123661ba9abbd">mq_mgr</a>,
<a name="l01378"></a>01378                                                   <span class="stringliteral">&quot;repo.deleted_on_relay&quot;</span>,
<a name="l01379"></a>01379                                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>);
<a name="l01380"></a>01380             <a class="code" href="daemon_2repo-mgr_8c.html#afdce2de6ee36dcf6b6264ac35fb17f7a">seaf_repo_manager_del_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo);
<a name="l01381"></a>01381         }
<a name="l01382"></a>01382     } <span class="keywordflow">else</span> {
<a name="l01383"></a>01383         <span class="comment">/* If local head is the same as remote head, already in sync. */</span>
<a name="l01384"></a>01384         <span class="keywordflow">if</span> (strcmp (local-&gt;commit_id, info-&gt;<a class="code" href="struct__SyncInfo.html#a9e831740601198ad30ee08db5b64382a">head_commit</a>) == 0) {
<a name="l01385"></a>01385             <span class="comment">/* As long as the repo is synced with the server. All the local</span>
<a name="l01386"></a>01386 <span class="comment">             * blocks are not useful any more.</span>
<a name="l01387"></a>01387 <span class="comment">             */</span>
<a name="l01388"></a>01388             <span class="keywordflow">if</span> (repo_block_store_exists (repo)) {
<a name="l01389"></a>01389                 seaf_message (<span class="stringliteral">&quot;Removing blocks for repo %s(%.8s).\n&quot;</span>,
<a name="l01390"></a>01390                               repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01391"></a>01391                 <a class="code" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768">ccnet_job_manager_schedule_job</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#abcbb9886e315abb16c620ce49808a0b2">job_mgr</a>,
<a name="l01392"></a>01392                                                 remove_repo_blocks,
<a name="l01393"></a>01393                                                 remove_blocks_done,
<a name="l01394"></a>01394                                                 task);
<a name="l01395"></a>01395             } <span class="keywordflow">else</span>
<a name="l01396"></a>01396                 transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da3c73047f0bdb59ed767efc67261354bb">SYNC_STATE_DONE</a>);
<a name="l01397"></a>01397         } <span class="keywordflow">else</span>
<a name="l01398"></a>01398             start_fetch_if_necessary (task, task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a>-&gt;<a class="code" href="struct__SyncInfo.html#a9e831740601198ad30ee08db5b64382a">head_commit</a>);
<a name="l01399"></a>01399     }
<a name="l01400"></a>01400 
<a name="l01401"></a>01401     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (local);
<a name="l01402"></a>01402     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (master);
<a name="l01403"></a>01403 }
<a name="l01404"></a>01404 
<a name="l01405"></a>01405 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01406"></a>01406 sync_done_cb (<a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor, gboolean success, <span class="keywordtype">void</span> *data)
<a name="l01407"></a>01407 {
<a name="l01408"></a>01408     <a class="code" href="struct__SyncTask.html">SyncTask</a> *task = data;
<a name="l01409"></a>01409     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>;
<a name="l01410"></a>01410 
<a name="l01411"></a>01411     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>) {
<a name="l01412"></a>01412         transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da8e0121d3e9964268e71fd702733f2579">SYNC_STATE_CANCELED</a>);
<a name="l01413"></a>01413         <a class="code" href="daemon_2repo-mgr_8c.html#afdce2de6ee36dcf6b6264ac35fb17f7a">seaf_repo_manager_del_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo);
<a name="l01414"></a>01414         <span class="keywordflow">return</span>;
<a name="l01415"></a>01415     }
<a name="l01416"></a>01416 
<a name="l01417"></a>01417     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__SyncTask.html#a442ac2b31e670693c3f1ec595a158ae4">state</a> == <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da4bdd5ea7e9e244ed294244fb4b31924d">SYNC_STATE_CANCEL_PENDING</a>) {
<a name="l01418"></a>01418         transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da8e0121d3e9964268e71fd702733f2579">SYNC_STATE_CANCELED</a>);
<a name="l01419"></a>01419         <span class="keywordflow">return</span>;
<a name="l01420"></a>01420     }
<a name="l01421"></a>01421 
<a name="l01422"></a>01422     <span class="keywordflow">if</span> (!success) {
<a name="l01423"></a>01423         <span class="keywordflow">switch</span> (processor-&gt;<a class="code" href="struct__CcnetProcessor.html#a044d12f3870190314e8fe43d636fd823">failure</a>) {
<a name="l01424"></a>01424         <span class="keywordflow">case</span> <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260a356349f5c99d03c7721d011d08ccd624">PROC_DONE</a>:
<a name="l01425"></a>01425             <span class="comment">/* It can never happen */</span>
<a name="l01426"></a>01426             g_return_if_reached ();
<a name="l01427"></a>01427         <span class="keywordflow">case</span> <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260a3034ea6f6eb7c4ecc98d1d4b45aabcdf">PROC_REMOTE_DEAD</a>:
<a name="l01428"></a>01428         <span class="keywordflow">case</span> <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260a32e3732cd459464942237b9963e3cfa7">PROC_NO_SERVICE</a>:
<a name="l01429"></a>01429             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55aea2057a6ab1581e1d79fa81a3f44fb71">SYNC_ERROR_SERVICE_DOWN</a>);
<a name="l01430"></a>01430             <span class="keywordflow">break</span>;
<a name="l01431"></a>01431         <span class="keywordflow">case</span> <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260aab69eea021cf87799528c363e8a6e88c">PROC_PERM_ERR</a>:
<a name="l01432"></a>01432             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a461a5ffea0714ff980112c23c2dae052">SYNC_ERROR_PROC_PERM_ERR</a>);
<a name="l01433"></a>01433             <span class="keywordflow">break</span>;
<a name="l01434"></a>01434         <span class="keywordflow">case</span> <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260a78f0f66889520ef72e7ff02d7bb6d283">PROC_BAD_RESP</a>:
<a name="l01435"></a>01435         <span class="keywordflow">case</span> <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260a446522776dda7bc0ec1ac63acf582f53">PROC_NOTSET</a>:
<a name="l01436"></a>01436         <span class="keywordflow">default</span>:
<a name="l01437"></a>01437             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a3839a8ff16af7993849949da453d0c43">SYNC_ERROR_UNKNOWN</a>);
<a name="l01438"></a>01438         }
<a name="l01439"></a>01439         <span class="keywordflow">return</span>;
<a name="l01440"></a>01440     }
<a name="l01441"></a>01441 
<a name="l01442"></a>01442     <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__SyncTask.html#a4f2d508226faddcf79be1f58bc11b781">server_side_merge</a>)
<a name="l01443"></a>01443         update_sync_status (task);
<a name="l01444"></a>01444     <span class="keywordflow">else</span>
<a name="l01445"></a>01445         update_sync_status_v2 (task);
<a name="l01446"></a>01446 }
<a name="l01447"></a>01447 
<a name="l01448"></a>01448 <span class="comment">/*</span>
<a name="l01449"></a>01449 <span class="comment">  The sync-repo processor is used to check the head commit at the server side.</span>
<a name="l01450"></a>01450 <span class="comment">*/</span>
<a name="l01451"></a>01451 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01452"></a>01452 start_sync_repo_proc (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager, <a class="code" href="struct__SyncTask.html">SyncTask</a> *task)
<a name="l01453"></a>01453 {
<a name="l01454"></a>01454     <a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor;
<a name="l01455"></a>01455 
<a name="l01456"></a>01456     processor = <a class="code" href="include_2ccnet_2proc-factory_8h.html#a4e77de8f2768695e93845129041759c7">ccnet_proc_factory_create_remote_master_processor</a> (
<a name="l01457"></a>01457         <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>, <span class="stringliteral">&quot;seafile-sync-repo&quot;</span>, task-&gt;<a class="code" href="struct__SyncTask.html#a956579282afe1f78871352ed31488946">dest_id</a>);
<a name="l01458"></a>01458     <span class="keywordflow">if</span> (!processor) {
<a name="l01459"></a>01459         seaf_warning (<span class="stringliteral">&quot;[sync-mgr] failed to create get seafile-sync-repo proc.\n&quot;</span>);
<a name="l01460"></a>01460         <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a3839a8ff16af7993849949da453d0c43">SYNC_ERROR_UNKNOWN</a>);
<a name="l01461"></a>01461         <span class="keywordflow">return</span> -1;
<a name="l01462"></a>01462     }
<a name="l01463"></a>01463     ((<a class="code" href="struct__SeafileSyncRepoProc.html">SeafileSyncRepoProc</a> *)processor)-&gt;task = task;
<a name="l01464"></a>01464 
<a name="l01465"></a>01465     <span class="keywordflow">if</span> (<a class="code" href="include_2ccnet_2processor_8h.html#ae2bb4b51c8e7dd43366b777ca9b00cf6">ccnet_processor_startl</a> (processor, NULL) &lt; 0) {
<a name="l01466"></a>01466         seaf_warning (<span class="stringliteral">&quot;[sync-mgr] failed to start get seafile-sync-repo proc.\n&quot;</span>);
<a name="l01467"></a>01467         <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a3839a8ff16af7993849949da453d0c43">SYNC_ERROR_UNKNOWN</a>);
<a name="l01468"></a>01468         <span class="keywordflow">return</span> -1;
<a name="l01469"></a>01469     }
<a name="l01470"></a>01470 
<a name="l01471"></a>01471     g_signal_connect (processor, <span class="stringliteral">&quot;done&quot;</span>, (GCallback)sync_done_cb, task);
<a name="l01472"></a>01472 
<a name="l01473"></a>01473     transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89daa158c5b9c6636626f72c9aa67f003675">SYNC_STATE_INIT</a>);
<a name="l01474"></a>01474 
<a name="l01475"></a>01475     <span class="keywordflow">return</span> 0;
<a name="l01476"></a>01476 }
<a name="l01477"></a>01477 
<a name="l01478"></a>01478 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01479"></a>01479 check_head_commit_done (<a class="code" href="struct__HttpHeadCommit.html">HttpHeadCommit</a> *result, <span class="keywordtype">void</span> *user_data)
<a name="l01480"></a>01480 {
<a name="l01481"></a>01481     <a class="code" href="struct__SyncTask.html">SyncTask</a> *task = user_data;
<a name="l01482"></a>01482     <a class="code" href="struct__SyncInfo.html">SyncInfo</a> *info = task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a>;
<a name="l01483"></a>01483 
<a name="l01484"></a>01484     <span class="keywordflow">if</span> (!result-&gt;<a class="code" href="struct__HttpHeadCommit.html#a42bce3980347bafa4af5d2b6ef8197a8">check_success</a>) {
<a name="l01485"></a>01485         <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a4c33384a7322d166e639c0942f39989a">SYNC_ERROR_GET_SYNC_INFO</a>);
<a name="l01486"></a>01486         <span class="keywordflow">return</span>;
<a name="l01487"></a>01487     }
<a name="l01488"></a>01488 
<a name="l01489"></a>01489     info-&gt;<a class="code" href="struct__SyncInfo.html#ad3f648faaee9de704066180f885be5e1">deleted_on_relay</a> = result-&gt;<a class="code" href="struct__HttpHeadCommit.html#ad720cf100758716906c6d73a82aad51a">is_deleted</a>;
<a name="l01490"></a>01490     info-&gt;<a class="code" href="struct__SyncInfo.html#a456a4baa8b89a5eaf4d122bafa43263a">repo_corrupted</a> = result-&gt;<a class="code" href="struct__HttpHeadCommit.html#ae76efcb51a295dedfbf56129af736a4b">is_corrupt</a>;
<a name="l01491"></a>01491     memcpy (info-&gt;<a class="code" href="struct__SyncInfo.html#a9e831740601198ad30ee08db5b64382a">head_commit</a>, result-&gt;<a class="code" href="struct__HttpHeadCommit.html#a153c7fda109c256dacfd330e5025e7e4">head_commit</a>, 40);
<a name="l01492"></a>01492 
<a name="l01493"></a>01493     update_sync_status_v2 (task);
<a name="l01494"></a>01494 }
<a name="l01495"></a>01495 
<a name="l01496"></a>01496 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01497"></a>01497 check_head_commit_http (<a class="code" href="struct__SyncTask.html">SyncTask</a> *task)
<a name="l01498"></a>01498 {
<a name="l01499"></a>01499     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>;
<a name="l01500"></a>01500 
<a name="l01501"></a>01501     <span class="keywordtype">int</span> ret = <a class="code" href="http-tx-mgr_8c.html#a4f2b3d94b4366c519af0a69ebb6edc34">http_tx_manager_check_head_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>,
<a name="l01502"></a>01502                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
<a name="l01503"></a>01503                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a1a7beee19acb913be2c23ac0e71ea733">server_url</a>,
<a name="l01504"></a>01504                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a0ce3b61cb31e78ffea429615379b3eb4">token</a>,
<a name="l01505"></a>01505                                                  check_head_commit_done,
<a name="l01506"></a>01506                                                  task);
<a name="l01507"></a>01507     <span class="keywordflow">if</span> (ret == 0)
<a name="l01508"></a>01508         transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89daa158c5b9c6636626f72c9aa67f003675">SYNC_STATE_INIT</a>);
<a name="l01509"></a>01509     <span class="keywordflow">return</span> ret;
<a name="l01510"></a>01510 }
<a name="l01511"></a>01511 
<a name="l01512"></a><a class="code" href="structCommitResult.html">01512</a> <span class="keyword">struct </span><a class="code" href="structCommitResult.html">CommitResult</a> {
<a name="l01513"></a><a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">01513</a>     <a class="code" href="struct__SyncTask.html">SyncTask</a> *<a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>;
<a name="l01514"></a><a class="code" href="structCommitResult.html#a8d00aeced02617cd9ebccfd62a468820">01514</a>     gboolean <a class="code" href="structCommitResult.html#a8d00aeced02617cd9ebccfd62a468820">changed</a>;
<a name="l01515"></a><a class="code" href="structCommitResult.html#a64c81e60ba6dbe84a830c9452e95460b">01515</a>     gboolean <a class="code" href="structCommitResult.html#a64c81e60ba6dbe84a830c9452e95460b">success</a>;
<a name="l01516"></a>01516 };
<a name="l01517"></a>01517 
<a name="l01518"></a>01518 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l01519"></a>01519 commit_job (<span class="keywordtype">void</span> *vtask)
<a name="l01520"></a>01520 {
<a name="l01521"></a>01521     <a class="code" href="struct__SyncTask.html">SyncTask</a> *task = vtask;
<a name="l01522"></a>01522     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>;
<a name="l01523"></a>01523     <span class="keyword">struct </span><a class="code" href="structCommitResult.html">CommitResult</a> *res = g_new0 (<span class="keyword">struct</span> <a class="code" href="structCommitResult.html">CommitResult</a>, 1);
<a name="l01524"></a>01524     GError *error = NULL;
<a name="l01525"></a>01525 
<a name="l01526"></a>01526     res-&gt;<a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a> = <a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>;
<a name="l01527"></a>01527 
<a name="l01528"></a>01528     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>)
<a name="l01529"></a>01529         <span class="keywordflow">return</span> res;
<a name="l01530"></a>01530 
<a name="l01531"></a>01531     res-&gt;<a class="code" href="structCommitResult.html#a8d00aeced02617cd9ebccfd62a468820">changed</a> = TRUE;
<a name="l01532"></a>01532     res-&gt;<a class="code" href="structCommitResult.html#a64c81e60ba6dbe84a830c9452e95460b">success</a> = TRUE;
<a name="l01533"></a>01533 
<a name="l01534"></a>01534     <span class="keywordtype">char</span> *commit_id = <a class="code" href="daemon_2repo-mgr_8c.html#af591ba84286a82123c728debd33ff300">seaf_repo_index_commit</a> (repo, <span class="stringliteral">&quot;&quot;</span>, task-&gt;<a class="code" href="struct__SyncTask.html#aa761b3497876b4d08db90987bc6edbf3">is_manual_sync</a>,
<a name="l01535"></a>01535                                               &amp;error);
<a name="l01536"></a>01536     <span class="keywordflow">if</span> (commit_id == NULL &amp;&amp; error != NULL) {
<a name="l01537"></a>01537         seaf_warning (<span class="stringliteral">&quot;[Sync mgr] Failed to commit to repo %s(%.8s).\n&quot;</span>,
<a name="l01538"></a>01538                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01539"></a>01539         res-&gt;<a class="code" href="structCommitResult.html#a64c81e60ba6dbe84a830c9452e95460b">success</a> = FALSE;
<a name="l01540"></a>01540     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (commit_id == NULL) {
<a name="l01541"></a>01541         res-&gt;<a class="code" href="structCommitResult.html#a8d00aeced02617cd9ebccfd62a468820">changed</a> = FALSE;
<a name="l01542"></a>01542     }
<a name="l01543"></a>01543     g_free (commit_id);
<a name="l01544"></a>01544 
<a name="l01545"></a>01545     <span class="keywordflow">return</span> res;
<a name="l01546"></a>01546 }
<a name="l01547"></a>01547 
<a name="l01548"></a>01548 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01549"></a>01549 commit_job_done (<span class="keywordtype">void</span> *vres)
<a name="l01550"></a>01550 {
<a name="l01551"></a>01551     <span class="keyword">struct </span><a class="code" href="structCommitResult.html">CommitResult</a> *res = vres;
<a name="l01552"></a>01552     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = res-&gt;<a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>;
<a name="l01553"></a>01553     <a class="code" href="struct__SyncTask.html">SyncTask</a> *task = res-&gt;<a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>;
<a name="l01554"></a>01554 
<a name="l01555"></a>01555     res-&gt;<a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>-&gt;<a class="code" href="struct__SyncTask.html#a8848e06615a4fc1bc9c145f8a224fe19">mgr</a>-&gt;<a class="code" href="struct__SeafSyncManager.html#a5097b95a3336e7828856aad73384c287">commit_job_running</a> = FALSE;
<a name="l01556"></a>01556 
<a name="l01557"></a>01557     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>) {
<a name="l01558"></a>01558         transition_sync_state (res-&gt;<a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da8e0121d3e9964268e71fd702733f2579">SYNC_STATE_CANCELED</a>);
<a name="l01559"></a>01559         <a class="code" href="daemon_2repo-mgr_8c.html#afdce2de6ee36dcf6b6264ac35fb17f7a">seaf_repo_manager_del_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo);
<a name="l01560"></a>01560         g_free (res);
<a name="l01561"></a>01561         <span class="keywordflow">return</span>;
<a name="l01562"></a>01562     }
<a name="l01563"></a>01563 
<a name="l01564"></a>01564     <span class="keywordflow">if</span> (res-&gt;<a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>-&gt;<a class="code" href="struct__SyncTask.html#a442ac2b31e670693c3f1ec595a158ae4">state</a> == <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da4bdd5ea7e9e244ed294244fb4b31924d">SYNC_STATE_CANCEL_PENDING</a>) {
<a name="l01565"></a>01565         transition_sync_state (res-&gt;<a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da8e0121d3e9964268e71fd702733f2579">SYNC_STATE_CANCELED</a>);
<a name="l01566"></a>01566         g_free (res);
<a name="l01567"></a>01567         <span class="keywordflow">return</span>;
<a name="l01568"></a>01568     }
<a name="l01569"></a>01569 
<a name="l01570"></a>01570     <span class="keywordflow">if</span> (!res-&gt;<a class="code" href="structCommitResult.html#a64c81e60ba6dbe84a830c9452e95460b">success</a>) {
<a name="l01571"></a>01571         <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (res-&gt;<a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55ae8badc64904d184e89af24606d61f42c">SYNC_ERROR_COMMIT</a>);
<a name="l01572"></a>01572         g_free (res);
<a name="l01573"></a>01573         <span class="keywordflow">return</span>;
<a name="l01574"></a>01574     }
<a name="l01575"></a>01575 
<a name="l01576"></a>01576     <span class="keywordflow">if</span> (!res-&gt;<a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>-&gt;<a class="code" href="struct__SyncTask.html#a4f2d508226faddcf79be1f58bc11b781">server_side_merge</a>) {
<a name="l01577"></a>01577         <span class="comment">/* If nothing committed and is not manual sync, no need to sync. */</span>
<a name="l01578"></a>01578         <span class="keywordflow">if</span> (!res-&gt;<a class="code" href="structCommitResult.html#a8d00aeced02617cd9ebccfd62a468820">changed</a> &amp;&amp;
<a name="l01579"></a>01579             !res-&gt;<a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>-&gt;<a class="code" href="struct__SyncTask.html#aa761b3497876b4d08db90987bc6edbf3">is_manual_sync</a> &amp;&amp; !res-&gt;<a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>-&gt;<a class="code" href="struct__SyncTask.html#ad81fd3ba2de4b8792bd43b8e8a5998d8">is_initial_commit</a>) {
<a name="l01580"></a>01580             transition_sync_state (res-&gt;<a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da3c73047f0bdb59ed767efc67261354bb">SYNC_STATE_DONE</a>);
<a name="l01581"></a>01581             g_free (res);
<a name="l01582"></a>01582             <span class="keywordflow">return</span>;
<a name="l01583"></a>01583         }
<a name="l01584"></a>01584         start_sync_repo_proc (res-&gt;<a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>-&gt;<a class="code" href="struct__SyncTask.html#a8848e06615a4fc1bc9c145f8a224fe19">mgr</a>, res-&gt;<a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>);
<a name="l01585"></a>01585     } <span class="keywordflow">else</span> {
<a name="l01586"></a>01586         <span class="keywordflow">if</span> (res-&gt;<a class="code" href="structCommitResult.html#a8d00aeced02617cd9ebccfd62a468820">changed</a>)
<a name="l01587"></a>01587             start_upload_if_necessary (res-&gt;<a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>);
<a name="l01588"></a>01588         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__SyncTask.html#aa761b3497876b4d08db90987bc6edbf3">is_manual_sync</a> || task-&gt;<a class="code" href="struct__SyncTask.html#ad81fd3ba2de4b8792bd43b8e8a5998d8">is_initial_commit</a>) {
<a name="l01589"></a>01589             <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__SyncTask.html#a29f8510d0999c926b2723a443a57f007">http_sync</a>)
<a name="l01590"></a>01590                 check_head_commit_http (task);
<a name="l01591"></a>01591             <span class="keywordflow">else</span>
<a name="l01592"></a>01592                 start_sync_repo_proc (task-&gt;<a class="code" href="struct__SyncTask.html#a8848e06615a4fc1bc9c145f8a224fe19">mgr</a>, task);
<a name="l01593"></a>01593         } <span class="keywordflow">else</span>
<a name="l01594"></a>01594             transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da3c73047f0bdb59ed767efc67261354bb">SYNC_STATE_DONE</a>);
<a name="l01595"></a>01595     }
<a name="l01596"></a>01596 
<a name="l01597"></a>01597     g_free (res);
<a name="l01598"></a>01598 }
<a name="l01599"></a>01599 
<a name="l01600"></a>01600 <span class="keyword">static</span> <span class="keywordtype">int</span> check_commit_state (<span class="keywordtype">void</span> *data);
<a name="l01601"></a>01601 
<a name="l01602"></a>01602 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01603"></a>01603 commit_repo (<a class="code" href="struct__SyncTask.html">SyncTask</a> *task)
<a name="l01604"></a>01604 {
<a name="l01605"></a>01605     <span class="comment">/* In order not to eat too much CPU power, only one commit job can be run</span>
<a name="l01606"></a>01606 <span class="comment">     * at the same time. Other sync tasks have to check every 1 second.</span>
<a name="l01607"></a>01607 <span class="comment">     */</span>
<a name="l01608"></a>01608     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__SyncTask.html#a8848e06615a4fc1bc9c145f8a224fe19">mgr</a>-&gt;<a class="code" href="struct__SeafSyncManager.html#a5097b95a3336e7828856aad73384c287">commit_job_running</a>) {
<a name="l01609"></a>01609         task-&gt;<a class="code" href="struct__SyncTask.html#a33841f5faec8da91b45e035318276c2f">commit_timer</a> = <a class="code" href="timer_8h.html#a68b6afb704a7f56b625ed78146691b7c">ccnet_timer_new</a> (check_commit_state, task, 1000);
<a name="l01610"></a>01610         <span class="keywordflow">return</span>;
<a name="l01611"></a>01611     }
<a name="l01612"></a>01612 
<a name="l01613"></a>01613     task-&gt;<a class="code" href="struct__SyncTask.html#a8848e06615a4fc1bc9c145f8a224fe19">mgr</a>-&gt;<a class="code" href="struct__SeafSyncManager.html#a5097b95a3336e7828856aad73384c287">commit_job_running</a> = TRUE;
<a name="l01614"></a>01614 
<a name="l01615"></a>01615     transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89dad5ea812e07d2b3a88cc24f0aa48a9475">SYNC_STATE_COMMIT</a>);
<a name="l01616"></a>01616 
<a name="l01617"></a>01617     <a class="code" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768">ccnet_job_manager_schedule_job</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#abcbb9886e315abb16c620ce49808a0b2">job_mgr</a>, 
<a name="l01618"></a>01618                                     commit_job, 
<a name="l01619"></a>01619                                     commit_job_done,
<a name="l01620"></a>01620                                     task);
<a name="l01621"></a>01621 }
<a name="l01622"></a>01622 
<a name="l01623"></a>01623 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01624"></a>01624 check_commit_state (<span class="keywordtype">void</span> *data)
<a name="l01625"></a>01625 {
<a name="l01626"></a>01626     <a class="code" href="struct__SyncTask.html">SyncTask</a> *task = data;
<a name="l01627"></a>01627 
<a name="l01628"></a>01628     <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__SyncTask.html#a8848e06615a4fc1bc9c145f8a224fe19">mgr</a>-&gt;<a class="code" href="struct__SeafSyncManager.html#a5097b95a3336e7828856aad73384c287">commit_job_running</a>) {
<a name="l01629"></a>01629         <a class="code" href="timer_8h.html#a22961f0e9c25baa320e81d1587c1324c">ccnet_timer_free</a> (&amp;task-&gt;<a class="code" href="struct__SyncTask.html#a33841f5faec8da91b45e035318276c2f">commit_timer</a>);
<a name="l01630"></a>01630         commit_repo (task);
<a name="l01631"></a>01631         <span class="keywordflow">return</span> 0;
<a name="l01632"></a>01632     }
<a name="l01633"></a>01633 
<a name="l01634"></a>01634     <span class="keywordflow">return</span> 1;
<a name="l01635"></a>01635 }
<a name="l01636"></a>01636 
<a name="l01637"></a>01637 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01638"></a>01638 start_sync (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager, <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo,
<a name="l01639"></a>01639             gboolean need_commit, gboolean is_manual_sync,
<a name="l01640"></a>01640             gboolean is_initial_commit)
<a name="l01641"></a>01641 {
<a name="l01642"></a>01642     <a class="code" href="struct__SyncTask.html">SyncTask</a> *task = g_new0 (<a class="code" href="struct__SyncTask.html">SyncTask</a>, 1);
<a name="l01643"></a>01643     <a class="code" href="struct__SyncInfo.html">SyncInfo</a> *info;
<a name="l01644"></a>01644 
<a name="l01645"></a>01645     info = get_sync_info (manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01646"></a>01646 
<a name="l01647"></a>01647     task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a> = info;
<a name="l01648"></a>01648     task-&gt;<a class="code" href="struct__SyncTask.html#a8848e06615a4fc1bc9c145f8a224fe19">mgr</a> = manager;
<a name="l01649"></a>01649 
<a name="l01650"></a>01650     task-&gt;<a class="code" href="struct__SyncTask.html#a956579282afe1f78871352ed31488946">dest_id</a> = g_strdup(repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>);
<a name="l01651"></a>01651     task-&gt;<a class="code" href="struct__SyncTask.html#a49503a78f8c685ae2361ef400fabfb47">token</a> = g_strdup(repo-&gt;<a class="code" href="struct__SeafRepo.html#a0ce3b61cb31e78ffea429615379b3eb4">token</a>);
<a name="l01652"></a>01652     task-&gt;<a class="code" href="struct__SyncTask.html#aa761b3497876b4d08db90987bc6edbf3">is_manual_sync</a> = is_manual_sync;
<a name="l01653"></a>01653     task-&gt;<a class="code" href="struct__SyncTask.html#ad81fd3ba2de4b8792bd43b8e8a5998d8">is_initial_commit</a> = is_initial_commit;
<a name="l01654"></a>01654 
<a name="l01655"></a>01655     repo-&gt;<a class="code" href="struct__SeafRepo.html#aea8a8f2c57241ca9b47ae1e7026b4ea5">last_sync_time</a> = time(NULL);
<a name="l01656"></a>01656     ++(manager-&gt;<a class="code" href="struct__SeafSyncManager.html#a9c8ce9cbb2868b95ac75a882bf565c87">n_running_tasks</a>);
<a name="l01657"></a>01657 
<a name="l01658"></a>01658     <span class="comment">/* Free the last task when a new task is started.</span>
<a name="l01659"></a>01659 <span class="comment">     * This way we can always get the state of the last task even</span>
<a name="l01660"></a>01660 <span class="comment">     * after it&#39;s done.</span>
<a name="l01661"></a>01661 <span class="comment">     */</span>
<a name="l01662"></a>01662     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a>-&gt;<a class="code" href="struct__SyncInfo.html#a6b0407e7d6def63347532d7d73eb7c6b">current_task</a>)
<a name="l01663"></a>01663         sync_task_free (task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a>-&gt;<a class="code" href="struct__SyncInfo.html#a6b0407e7d6def63347532d7d73eb7c6b">current_task</a>);
<a name="l01664"></a>01664     task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a>-&gt;<a class="code" href="struct__SyncInfo.html#a6b0407e7d6def63347532d7d73eb7c6b">current_task</a> = <a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>;
<a name="l01665"></a>01665     task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a>-&gt;<a class="code" href="struct__SyncInfo.html#ad0f77a2b8e799b3a0abc417fce88843a">in_sync</a> = TRUE;
<a name="l01666"></a>01666     task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a> = repo;
<a name="l01667"></a>01667 
<a name="l01668"></a>01668     <span class="keywordflow">if</span> (need_commit) {
<a name="l01669"></a>01669         repo-&gt;<a class="code" href="struct__SeafRepo.html#ae55dc691d150f9eef30f3f942d8dacca">create_partial_commit</a> = FALSE;
<a name="l01670"></a>01670         commit_repo (task);
<a name="l01671"></a>01671     } <span class="keywordflow">else</span>
<a name="l01672"></a>01672         start_sync_repo_proc (manager, task);
<a name="l01673"></a>01673 }
<a name="l01674"></a>01674 
<a name="l01675"></a>01675 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01676"></a>01676 sync_repo (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager, <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l01677"></a>01677 {
<a name="l01678"></a>01678     <a class="code" href="structWTStatus.html">WTStatus</a> *<a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l01679"></a>01679     gint now = (gint)time(NULL);
<a name="l01680"></a>01680     gint last_changed;
<a name="l01681"></a>01681 
<a name="l01682"></a>01682     status = <a class="code" href="wt-monitor-linux_8c.html#ac6fd1291570eac2124938f17d4223651">seaf_wt_monitor_get_worktree_status</a> (manager-&gt;<a class="code" href="struct__SeafSyncManager.html#a15dbbff6ec86d385b4fbfcd5605b1112">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a64fc6ad3e80ab34bd2d5ac10dfc1aa66">wt_monitor</a>,
<a name="l01683"></a>01683                                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01684"></a>01684     <span class="keywordflow">if</span> (status) {
<a name="l01685"></a>01685         last_changed = g_atomic_int_get (&amp;status-&gt;<a class="code" href="structWTStatus.html#a69bd0de2ffbf7d9d4b2a32494aac9e00">last_changed</a>);
<a name="l01686"></a>01686         <span class="keywordflow">if</span> (status-&gt;<a class="code" href="structWTStatus.html#a1d4b006ea747a09e264b269d27e173b8">last_check</a> == 0) {
<a name="l01687"></a>01687             <span class="comment">/* Force commit and sync after a new repo is added. */</span>
<a name="l01688"></a>01688             start_sync (manager, repo, TRUE, FALSE, TRUE);
<a name="l01689"></a>01689             status-&gt;<a class="code" href="structWTStatus.html#a1d4b006ea747a09e264b269d27e173b8">last_check</a> = now;
<a name="l01690"></a>01690             <a class="code" href="wt-monitor-structs_8c.html#a53f5564385cb3d86fff013bf7ee17e86">wt_status_unref</a> (status);
<a name="l01691"></a>01691             <span class="keywordflow">return</span> 0;
<a name="l01692"></a>01692         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (last_changed != 0 &amp;&amp; status-&gt;<a class="code" href="structWTStatus.html#a1d4b006ea747a09e264b269d27e173b8">last_check</a> &lt;= last_changed) {
<a name="l01693"></a>01693             <span class="comment">/* Commit and sync if the repo has been updated after the</span>
<a name="l01694"></a>01694 <span class="comment">             * last check and is not updated for the last 2 seconds.</span>
<a name="l01695"></a>01695 <span class="comment">             */</span>
<a name="l01696"></a>01696             <span class="keywordflow">if</span> (now - last_changed &gt;= 2) {
<a name="l01697"></a>01697                 start_sync (manager, repo, TRUE, FALSE, FALSE);
<a name="l01698"></a>01698                 status-&gt;<a class="code" href="structWTStatus.html#a1d4b006ea747a09e264b269d27e173b8">last_check</a> = now;
<a name="l01699"></a>01699                 <a class="code" href="wt-monitor-structs_8c.html#a53f5564385cb3d86fff013bf7ee17e86">wt_status_unref</a> (status);
<a name="l01700"></a>01700                 <span class="keywordflow">return</span> 0;
<a name="l01701"></a>01701             }
<a name="l01702"></a>01702         }
<a name="l01703"></a>01703         <a class="code" href="wt-monitor-structs_8c.html#a53f5564385cb3d86fff013bf7ee17e86">wt_status_unref</a> (status);
<a name="l01704"></a>01704     }
<a name="l01705"></a>01705 
<a name="l01706"></a>01706     <span class="keywordflow">if</span> (manager-&gt;<a class="code" href="struct__SeafSyncManager.html#a9c8ce9cbb2868b95ac75a882bf565c87">n_running_tasks</a> &gt;= <a class="code" href="sync-mgr_8c.html#ac5eb49751413cb3c490eb13809ac13c6">MAX_RUNNING_SYNC_TASKS</a>)
<a name="l01707"></a>01707         <span class="keywordflow">return</span> -1;
<a name="l01708"></a>01708 
<a name="l01709"></a>01709     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#aea8a8f2c57241ca9b47ae1e7026b4ea5">last_sync_time</a> &gt; now - manager-&gt;<a class="code" href="struct__SeafSyncManager.html#a318c269683fe0c9b9acee8734765fa47">sync_interval</a>)
<a name="l01710"></a>01710         <span class="keywordflow">return</span> -1;
<a name="l01711"></a>01711 
<a name="l01712"></a>01712     start_sync (manager, repo, FALSE, FALSE, FALSE);
<a name="l01713"></a>01713 
<a name="l01714"></a>01714     <span class="keywordflow">return</span> 0;
<a name="l01715"></a>01715 }
<a name="l01716"></a>01716 
<a name="l01717"></a>01717 <span class="keyword">static</span> <a class="code" href="struct__SyncTask.html">SyncTask</a> *
<a name="l01718"></a>01718 create_sync_task_v2 (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager, <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo,
<a name="l01719"></a>01719                      gboolean is_manual_sync, gboolean is_initial_commit)
<a name="l01720"></a>01720 {
<a name="l01721"></a>01721     <a class="code" href="struct__SyncTask.html">SyncTask</a> *task = g_new0 (<a class="code" href="struct__SyncTask.html">SyncTask</a>, 1);
<a name="l01722"></a>01722     <a class="code" href="struct__SyncInfo.html">SyncInfo</a> *info;
<a name="l01723"></a>01723 
<a name="l01724"></a>01724     info = get_sync_info (manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01725"></a>01725 
<a name="l01726"></a>01726     task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a> = info;
<a name="l01727"></a>01727     task-&gt;<a class="code" href="struct__SyncTask.html#a8848e06615a4fc1bc9c145f8a224fe19">mgr</a> = manager;
<a name="l01728"></a>01728 
<a name="l01729"></a>01729     task-&gt;<a class="code" href="struct__SyncTask.html#a956579282afe1f78871352ed31488946">dest_id</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>);
<a name="l01730"></a>01730     task-&gt;<a class="code" href="struct__SyncTask.html#a49503a78f8c685ae2361ef400fabfb47">token</a> = g_strdup(repo-&gt;<a class="code" href="struct__SeafRepo.html#a0ce3b61cb31e78ffea429615379b3eb4">token</a>);
<a name="l01731"></a>01731     task-&gt;<a class="code" href="struct__SyncTask.html#aa761b3497876b4d08db90987bc6edbf3">is_manual_sync</a> = is_manual_sync;
<a name="l01732"></a>01732     task-&gt;<a class="code" href="struct__SyncTask.html#ad81fd3ba2de4b8792bd43b8e8a5998d8">is_initial_commit</a> = is_initial_commit;
<a name="l01733"></a>01733     task-&gt;<a class="code" href="struct__SyncTask.html#a4f2d508226faddcf79be1f58bc11b781">server_side_merge</a> = TRUE;
<a name="l01734"></a>01734 
<a name="l01735"></a>01735     repo-&gt;<a class="code" href="struct__SeafRepo.html#aea8a8f2c57241ca9b47ae1e7026b4ea5">last_sync_time</a> = time(NULL);
<a name="l01736"></a>01736     ++(manager-&gt;<a class="code" href="struct__SeafSyncManager.html#a9c8ce9cbb2868b95ac75a882bf565c87">n_running_tasks</a>);
<a name="l01737"></a>01737 
<a name="l01738"></a>01738     <span class="comment">/* Free the last task when a new task is started.</span>
<a name="l01739"></a>01739 <span class="comment">     * This way we can always get the state of the last task even</span>
<a name="l01740"></a>01740 <span class="comment">     * after it&#39;s done.</span>
<a name="l01741"></a>01741 <span class="comment">     */</span>
<a name="l01742"></a>01742     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a>-&gt;<a class="code" href="struct__SyncInfo.html#a6b0407e7d6def63347532d7d73eb7c6b">current_task</a>)
<a name="l01743"></a>01743         sync_task_free (task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a>-&gt;<a class="code" href="struct__SyncInfo.html#a6b0407e7d6def63347532d7d73eb7c6b">current_task</a>);
<a name="l01744"></a>01744     task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a>-&gt;<a class="code" href="struct__SyncInfo.html#a6b0407e7d6def63347532d7d73eb7c6b">current_task</a> = <a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>;
<a name="l01745"></a>01745     task-&gt;<a class="code" href="struct__SyncTask.html#abd93230b8c1da0d123ab2c73710f56cd">info</a>-&gt;<a class="code" href="struct__SyncInfo.html#ad0f77a2b8e799b3a0abc417fce88843a">in_sync</a> = TRUE;
<a name="l01746"></a>01746     task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a> = repo;
<a name="l01747"></a>01747 
<a name="l01748"></a>01748     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a1a7beee19acb913be2c23ac0e71ea733">server_url</a>) {
<a name="l01749"></a>01749         <a class="code" href="struct__HttpServerState.html">HttpServerState</a> *state = g_hash_table_lookup (manager-&gt;<a class="code" href="struct__SeafSyncManager.html#a6c8c0f36f8e44feabd6cd44d6a4f49c1">http_server_states</a>,
<a name="l01750"></a>01750                                                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a1a7beee19acb913be2c23ac0e71ea733">server_url</a>);
<a name="l01751"></a>01751         <span class="keywordflow">if</span> (state) {
<a name="l01752"></a>01752             <span class="keywordflow">if</span> (!state-&gt;<a class="code" href="struct__HttpServerState.html#a86d68d7c613b0b4a08e3e53ee44f129b">http_not_supported</a>) {
<a name="l01753"></a>01753                 task-&gt;<a class="code" href="struct__SyncTask.html#a29f8510d0999c926b2723a443a57f007">http_sync</a> = TRUE;
<a name="l01754"></a>01754                 task-&gt;<a class="code" href="struct__SyncTask.html#aed3920db60e520cf749b53fa3b6caca8">http_version</a> = state-&gt;<a class="code" href="struct__HttpServerState.html#abca94be9f168b0a44234314ad1e0d00b">http_version</a>;
<a name="l01755"></a>01755             }
<a name="l01756"></a>01756         }
<a name="l01757"></a>01757     }
<a name="l01758"></a>01758 
<a name="l01759"></a>01759     <span class="keywordflow">return</span> <a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>;
<a name="l01760"></a>01760 }
<a name="l01761"></a>01761 
<a name="l01762"></a>01762 <span class="keyword">static</span> gboolean
<a name="l01763"></a>01763 create_commit_from_event_queue (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager, <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo,
<a name="l01764"></a>01764                                 gboolean is_manual_sync)
<a name="l01765"></a>01765 {
<a name="l01766"></a>01766     <a class="code" href="structWTStatus.html">WTStatus</a> *<a class="code" href="block-tx-utils_8h.html#a2aaa5f99cdedb08950d78469e9e64edc">status</a>;
<a name="l01767"></a>01767     <a class="code" href="struct__SyncTask.html">SyncTask</a> *<a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>;
<a name="l01768"></a>01768     gboolean ret = FALSE;
<a name="l01769"></a>01769     gint now = (gint)time(NULL);
<a name="l01770"></a>01770     gint last_changed;
<a name="l01771"></a>01771 
<a name="l01772"></a>01772     status = <a class="code" href="wt-monitor-linux_8c.html#ac6fd1291570eac2124938f17d4223651">seaf_wt_monitor_get_worktree_status</a> (manager-&gt;<a class="code" href="struct__SeafSyncManager.html#a15dbbff6ec86d385b4fbfcd5605b1112">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a64fc6ad3e80ab34bd2d5ac10dfc1aa66">wt_monitor</a>,
<a name="l01773"></a>01773                                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01774"></a>01774     <span class="keywordflow">if</span> (status) {
<a name="l01775"></a>01775         last_changed = g_atomic_int_get (&amp;status-&gt;<a class="code" href="structWTStatus.html#a69bd0de2ffbf7d9d4b2a32494aac9e00">last_changed</a>);
<a name="l01776"></a>01776         <span class="keywordflow">if</span> (status-&gt;<a class="code" href="structWTStatus.html#a1d4b006ea747a09e264b269d27e173b8">last_check</a> == 0) {
<a name="l01777"></a>01777             <span class="comment">/* Force commit and sync after a new repo is added. */</span>
<a name="l01778"></a>01778             task = create_sync_task_v2 (manager, repo, is_manual_sync, TRUE);
<a name="l01779"></a>01779             repo-&gt;<a class="code" href="struct__SeafRepo.html#ae55dc691d150f9eef30f3f942d8dacca">create_partial_commit</a> = TRUE;
<a name="l01780"></a>01780             commit_repo (task);
<a name="l01781"></a>01781             status-&gt;<a class="code" href="structWTStatus.html#a1d4b006ea747a09e264b269d27e173b8">last_check</a> = now;
<a name="l01782"></a>01782             ret = TRUE;
<a name="l01783"></a>01783         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status-&gt;<a class="code" href="structWTStatus.html#a80a104859f6aa1d369f07efaf3c6bcfc">partial_commit</a>) {
<a name="l01784"></a>01784             task = create_sync_task_v2 (manager, repo, is_manual_sync, FALSE);
<a name="l01785"></a>01785             repo-&gt;<a class="code" href="struct__SeafRepo.html#ae55dc691d150f9eef30f3f942d8dacca">create_partial_commit</a> = TRUE;
<a name="l01786"></a>01786             commit_repo (task);
<a name="l01787"></a>01787             ret = TRUE;
<a name="l01788"></a>01788         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (last_changed != 0 &amp;&amp; status-&gt;<a class="code" href="structWTStatus.html#a1d4b006ea747a09e264b269d27e173b8">last_check</a> &lt;= last_changed) {
<a name="l01789"></a>01789             <span class="comment">/* Commit and sync if the repo has been updated after the</span>
<a name="l01790"></a>01790 <span class="comment">             * last check and is not updated for the last 2 seconds.</span>
<a name="l01791"></a>01791 <span class="comment">             */</span>
<a name="l01792"></a>01792             <span class="keywordflow">if</span> (now - last_changed &gt;= 2) {
<a name="l01793"></a>01793                 task = create_sync_task_v2 (manager, repo, is_manual_sync, FALSE);
<a name="l01794"></a>01794                 repo-&gt;<a class="code" href="struct__SeafRepo.html#ae55dc691d150f9eef30f3f942d8dacca">create_partial_commit</a> = TRUE;
<a name="l01795"></a>01795                 commit_repo (task);
<a name="l01796"></a>01796                 status-&gt;<a class="code" href="structWTStatus.html#a1d4b006ea747a09e264b269d27e173b8">last_check</a> = now;
<a name="l01797"></a>01797                 ret = TRUE;
<a name="l01798"></a>01798             }
<a name="l01799"></a>01799         }
<a name="l01800"></a>01800         <a class="code" href="wt-monitor-structs_8c.html#a53f5564385cb3d86fff013bf7ee17e86">wt_status_unref</a> (status);
<a name="l01801"></a>01801     }
<a name="l01802"></a>01802 
<a name="l01803"></a>01803     <span class="keywordflow">return</span> ret;
<a name="l01804"></a>01804 }
<a name="l01805"></a>01805 
<a name="l01806"></a>01806 <span class="keyword">static</span> gboolean
<a name="l01807"></a>01807 can_schedule_repo (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager, <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l01808"></a>01808 {
<a name="l01809"></a>01809     <span class="keywordtype">int</span> now = (int)time(NULL);
<a name="l01810"></a>01810 
<a name="l01811"></a>01811     <span class="keywordflow">return</span> ((repo-&gt;<a class="code" href="struct__SeafRepo.html#aea8a8f2c57241ca9b47ae1e7026b4ea5">last_sync_time</a> == 0 ||
<a name="l01812"></a>01812              repo-&gt;<a class="code" href="struct__SeafRepo.html#aea8a8f2c57241ca9b47ae1e7026b4ea5">last_sync_time</a> &lt; now - manager-&gt;<a class="code" href="struct__SeafSyncManager.html#a318c269683fe0c9b9acee8734765fa47">sync_interval</a>) &amp;&amp;
<a name="l01813"></a>01813             manager-&gt;<a class="code" href="struct__SeafSyncManager.html#a9c8ce9cbb2868b95ac75a882bf565c87">n_running_tasks</a> &lt; <a class="code" href="sync-mgr_8c.html#ac5eb49751413cb3c490eb13809ac13c6">MAX_RUNNING_SYNC_TASKS</a>);
<a name="l01814"></a>01814 }
<a name="l01815"></a>01815 
<a name="l01816"></a>01816 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01817"></a>01817 sync_repo_v2 (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager, <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, gboolean is_manual_sync)
<a name="l01818"></a>01818 {
<a name="l01819"></a>01819     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *master, *local;
<a name="l01820"></a>01820     <a class="code" href="struct__SyncTask.html">SyncTask</a> *<a class="code" href="structCommitResult.html#a2d5d5db19762164a516068e8e149dd7b">task</a>;
<a name="l01821"></a>01821     <span class="keywordtype">int</span> ret = 0;
<a name="l01822"></a>01822     <span class="keywordtype">char</span> *last_download = NULL;
<a name="l01823"></a>01823 
<a name="l01824"></a>01824     master = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="stringliteral">&quot;master&quot;</span>);
<a name="l01825"></a>01825     <span class="keywordflow">if</span> (!master) {
<a name="l01826"></a>01826         seaf_warning (<span class="stringliteral">&quot;No master branch found for repo %s(%.8s).\n&quot;</span>,
<a name="l01827"></a>01827                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01828"></a>01828         <span class="keywordflow">return</span> -1;
<a name="l01829"></a>01829     }
<a name="l01830"></a>01830     local = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="stringliteral">&quot;local&quot;</span>);
<a name="l01831"></a>01831     <span class="keywordflow">if</span> (!local) {
<a name="l01832"></a>01832         seaf_warning (<span class="stringliteral">&quot;No local branch found for repo %s(%.8s).\n&quot;</span>,
<a name="l01833"></a>01833                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01834"></a>01834         <span class="keywordflow">return</span> -1;
<a name="l01835"></a>01835     }
<a name="l01836"></a>01836 
<a name="l01837"></a>01837     <span class="comment">/* If last download was interrupted in the fetch and download stage,</span>
<a name="l01838"></a>01838 <span class="comment">     * need to resume it at exactly the same remote commit.</span>
<a name="l01839"></a>01839 <span class="comment">     */</span>
<a name="l01840"></a>01840     last_download = <a class="code" href="daemon_2repo-mgr_8c.html#a71edf5bba9589fa8793d7b0312cb9553">seaf_repo_manager_get_repo_property</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l01841"></a>01841                                                          repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l01842"></a>01842                                                          <a class="code" href="daemon_2repo-mgr_8h.html#a1d90660156a493f14023ca76013acd64">REPO_PROP_DOWNLOAD_HEAD</a>);
<a name="l01843"></a>01843     <span class="keywordflow">if</span> (last_download &amp;&amp; strcmp (last_download, <a class="code" href="seafile_2common_2common_8h.html#aaa0130adfcd2ec28ea4cf85337ace2da">EMPTY_SHA1</a>) != 0) {
<a name="l01844"></a>01844         <span class="keywordflow">if</span> (is_manual_sync || can_schedule_repo (manager, repo)) {
<a name="l01845"></a>01845             task = create_sync_task_v2 (manager, repo, is_manual_sync, FALSE);
<a name="l01846"></a>01846             start_fetch_if_necessary (task, last_download);
<a name="l01847"></a>01847         }
<a name="l01848"></a>01848         <span class="keywordflow">goto</span> out;
<a name="l01849"></a>01849     }
<a name="l01850"></a>01850 
<a name="l01851"></a>01851     <span class="keywordflow">if</span> (strcmp (master-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>, local-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>) != 0) {
<a name="l01852"></a>01852         <span class="keywordflow">if</span> (is_manual_sync || can_schedule_repo (manager, repo)) {
<a name="l01853"></a>01853             task = create_sync_task_v2 (manager, repo, is_manual_sync, FALSE);
<a name="l01854"></a>01854             start_upload_if_necessary (task);
<a name="l01855"></a>01855         }
<a name="l01856"></a>01856         <span class="comment">/* Do nothing if the client still has something to upload</span>
<a name="l01857"></a>01857 <span class="comment">         * but it&#39;s before 30-second schedule.</span>
<a name="l01858"></a>01858 <span class="comment">         */</span>
<a name="l01859"></a>01859         <span class="keywordflow">goto</span> out;
<a name="l01860"></a>01860     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is_manual_sync) {
<a name="l01861"></a>01861         task = create_sync_task_v2 (manager, repo, is_manual_sync, FALSE);
<a name="l01862"></a>01862         commit_repo (task);
<a name="l01863"></a>01863         <span class="keywordflow">goto</span> out;
<a name="l01864"></a>01864     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (create_commit_from_event_queue (manager, repo, is_manual_sync))
<a name="l01865"></a>01865         <span class="keywordflow">goto</span> out;
<a name="l01866"></a>01866 
<a name="l01867"></a>01867     <span class="keywordflow">if</span> (is_manual_sync || can_schedule_repo (manager, repo)) {
<a name="l01868"></a>01868         task = create_sync_task_v2 (manager, repo, is_manual_sync, FALSE);
<a name="l01869"></a>01869         <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__SyncTask.html#a29f8510d0999c926b2723a443a57f007">http_sync</a>)
<a name="l01870"></a>01870             check_head_commit_http (task);
<a name="l01871"></a>01871         <span class="keywordflow">else</span>
<a name="l01872"></a>01872             start_sync_repo_proc (manager, task);
<a name="l01873"></a>01873     }
<a name="l01874"></a>01874 
<a name="l01875"></a>01875 out:
<a name="l01876"></a>01876     g_free (last_download);
<a name="l01877"></a>01877     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (master);
<a name="l01878"></a>01878     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (local);
<a name="l01879"></a>01879     <span class="keywordflow">return</span> ret;
<a name="l01880"></a>01880 }
<a name="l01881"></a>01881 
<a name="l01882"></a>01882 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01883"></a>01883 auto_delete_repo (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager, <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l01884"></a>01884 {
<a name="l01885"></a>01885     <a class="code" href="struct__SyncInfo.html">SyncInfo</a> *info = <a class="code" href="sync-mgr_8c.html#afb758dbde64ac4505ad259f95601d45e">seaf_sync_manager_get_sync_info</a> (manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l01886"></a>01886     <span class="keywordtype">char</span> *<a class="code" href="index_8h.html#a2a7f851274ec18e17d38114c39b8511a">name</a> = g_strdup (repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>);
<a name="l01887"></a>01887 
<a name="l01888"></a>01888     seaf_message (<span class="stringliteral">&quot;Auto deleted repo &#39;%s&#39;.\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>);
<a name="l01889"></a>01889 
<a name="l01890"></a>01890     <span class="keywordflow">if</span> (info != NULL &amp;&amp; info-&gt;<a class="code" href="struct__SyncInfo.html#ad0f77a2b8e799b3a0abc417fce88843a">in_sync</a>) {
<a name="l01891"></a>01891         <a class="code" href="daemon_2repo-mgr_8c.html#ad41b6fcdbf4fdfa7d70daf98af124460">seaf_repo_manager_mark_repo_deleted</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo);
<a name="l01892"></a>01892     } <span class="keywordflow">else</span> {
<a name="l01893"></a>01893         <a class="code" href="daemon_2repo-mgr_8c.html#afdce2de6ee36dcf6b6264ac35fb17f7a">seaf_repo_manager_del_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo);
<a name="l01894"></a>01894     }
<a name="l01895"></a>01895 
<a name="l01896"></a>01896     <span class="comment">/* Publish a message, for applet to notify in the system tray */</span>
<a name="l01897"></a>01897     <a class="code" href="mq-mgr_8c.html#a0e6f86438a353da6463eaf45b940f9f0">seaf_mq_manager_publish_notification</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a89e2a6000f250563b18123661ba9abbd">mq_mgr</a>,
<a name="l01898"></a>01898                                           <span class="stringliteral">&quot;repo.removed&quot;</span>,
<a name="l01899"></a>01899                                           name);
<a name="l01900"></a>01900     g_free (name);
<a name="l01901"></a>01901 }
<a name="l01902"></a>01902 
<a name="l01903"></a>01903 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01904"></a>01904 check_protocol_done_cb (<a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor, gboolean success, <span class="keywordtype">void</span> *data)
<a name="l01905"></a>01905 {
<a name="l01906"></a>01906     <a class="code" href="struct__ServerState.html">ServerState</a> *state = data;
<a name="l01907"></a>01907 
<a name="l01908"></a>01908     state-&gt;<a class="code" href="struct__ServerState.html#a178babd4576d9ccf17ac0ccd640c4a27">checking</a> = FALSE;
<a name="l01909"></a>01909     <span class="keywordflow">if</span> (success)
<a name="l01910"></a>01910         state-&gt;<a class="code" href="struct__ServerState.html#adb0ef1901e8918aaa2a1e2ee5468b479">server_side_merge</a> = <a class="code" href="sync-mgr_8c.html#a16685eea158879e41b101ca3634de462aa9a54f83b0490bef2294e496c9e758f9">SERVER_SIDE_MERGE_SUPPORTED</a>;
<a name="l01911"></a>01911     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (processor-&gt;<a class="code" href="struct__CcnetProcessor.html#a044d12f3870190314e8fe43d636fd823">failure</a> == <a class="code" href="include_2ccnet_2processor_8h.html#ade9ca5088d171ad20b4c237f1c2d6260a32e3732cd459464942237b9963e3cfa7">PROC_NO_SERVICE</a>)
<a name="l01912"></a>01912         <span class="comment">/* Talking to an old server. */</span>
<a name="l01913"></a>01913         state-&gt;<a class="code" href="struct__ServerState.html#adb0ef1901e8918aaa2a1e2ee5468b479">server_side_merge</a> = <a class="code" href="sync-mgr_8c.html#a16685eea158879e41b101ca3634de462ac2a0c6479a5c92919e0138492de300bf">SERVER_SIDE_MERGE_UNSUPPORTED</a>;
<a name="l01914"></a>01914 }
<a name="l01915"></a>01915 
<a name="l01916"></a>01916 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01917"></a>01917 start_check_protocol_proc (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager,
<a name="l01918"></a>01918                            <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_id, <a class="code" href="struct__ServerState.html">ServerState</a> *state)
<a name="l01919"></a>01919 {
<a name="l01920"></a>01920     <a class="code" href="struct__CcnetProcessor.html">CcnetProcessor</a> *processor;
<a name="l01921"></a>01921 
<a name="l01922"></a>01922     processor = <a class="code" href="include_2ccnet_2proc-factory_8h.html#a4e77de8f2768695e93845129041759c7">ccnet_proc_factory_create_remote_master_processor</a> (
<a name="l01923"></a>01923         <a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#ab2fe4d566fbe5b9cff50a9bef54cd931">session</a>-&gt;<a class="code" href="struct__CcnetClient.html#a0323e7b06acd2088f195ca6b0688ed54">proc_factory</a>, <span class="stringliteral">&quot;seafile-check-protocol&quot;</span>, peer_id);
<a name="l01924"></a>01924     <span class="keywordflow">if</span> (!processor) {
<a name="l01925"></a>01925         seaf_warning (<span class="stringliteral">&quot;[sync-mgr] failed to create get seafile-check-protocol proc.\n&quot;</span>);
<a name="l01926"></a>01926         <span class="keywordflow">return</span> -1;
<a name="l01927"></a>01927     }
<a name="l01928"></a>01928 
<a name="l01929"></a>01929     <span class="keywordflow">if</span> (<a class="code" href="include_2ccnet_2processor_8h.html#ae2bb4b51c8e7dd43366b777ca9b00cf6">ccnet_processor_startl</a> (processor, NULL) &lt; 0) {
<a name="l01930"></a>01930         seaf_warning (<span class="stringliteral">&quot;[sync-mgr] failed to start seafile-check-protocol proc.\n&quot;</span>);
<a name="l01931"></a>01931         <span class="keywordflow">return</span> -1;
<a name="l01932"></a>01932     }
<a name="l01933"></a>01933 
<a name="l01934"></a>01934     g_signal_connect (processor, <span class="stringliteral">&quot;done&quot;</span>, (GCallback)check_protocol_done_cb, state);
<a name="l01935"></a>01935 
<a name="l01936"></a>01936     <span class="keywordflow">return</span> 0;
<a name="l01937"></a>01937 }
<a name="l01938"></a>01938 
<a name="l01939"></a>01939 <span class="keyword">static</span> gboolean
<a name="l01940"></a>01940 check_relay_status (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *mgr, <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l01941"></a>01941 {
<a name="l01942"></a>01942     gboolean is_ready = <a class="code" href="ccnet_8h.html#aaf2e8f3b63d6ad9fb1012b23d4e242b0">ccnet_peer_is_ready</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#add541d96cca483ad72ff56ad061d1d32">ccnetrpc_client</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>);
<a name="l01943"></a>01943 
<a name="l01944"></a>01944     <a class="code" href="struct__ServerState.html">ServerState</a> *state = g_hash_table_lookup (mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a623ff0c818f5d0d7da880cdba6700bce">server_states</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>);
<a name="l01945"></a>01945     <span class="keywordflow">if</span> (!state) {
<a name="l01946"></a>01946         state = g_new0 (<a class="code" href="struct__ServerState.html">ServerState</a>, 1);
<a name="l01947"></a>01947         g_hash_table_insert (mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a623ff0c818f5d0d7da880cdba6700bce">server_states</a>, g_strdup(repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>), state);
<a name="l01948"></a>01948     }
<a name="l01949"></a>01949 
<a name="l01950"></a>01950     <span class="keywordflow">if</span> (is_ready) {
<a name="l01951"></a>01951         <span class="keywordflow">if</span> (state-&gt;<a class="code" href="struct__ServerState.html#adb0ef1901e8918aaa2a1e2ee5468b479">server_side_merge</a> == <a class="code" href="sync-mgr_8c.html#a16685eea158879e41b101ca3634de462a6c21229b0a45dd28406c0072669f5a65">SERVER_SIDE_MERGE_UNKNOWN</a>) {
<a name="l01952"></a>01952             <span class="keywordflow">if</span> (!state-&gt;<a class="code" href="struct__ServerState.html#a178babd4576d9ccf17ac0ccd640c4a27">checking</a>) {
<a name="l01953"></a>01953                 start_check_protocol_proc (mgr, repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>, state);
<a name="l01954"></a>01954                 state-&gt;<a class="code" href="struct__ServerState.html#a178babd4576d9ccf17ac0ccd640c4a27">checking</a> = TRUE;
<a name="l01955"></a>01955             }
<a name="l01956"></a>01956             <span class="keywordflow">return</span> FALSE;
<a name="l01957"></a>01957         } <span class="keywordflow">else</span>
<a name="l01958"></a>01958             <span class="keywordflow">return</span> TRUE;
<a name="l01959"></a>01959     } <span class="keywordflow">else</span> {
<a name="l01960"></a>01960         <span class="keywordflow">if</span> (state-&gt;<a class="code" href="struct__ServerState.html#adb0ef1901e8918aaa2a1e2ee5468b479">server_side_merge</a> == <a class="code" href="sync-mgr_8c.html#a16685eea158879e41b101ca3634de462a6c21229b0a45dd28406c0072669f5a65">SERVER_SIDE_MERGE_UNKNOWN</a>)
<a name="l01961"></a>01961             <span class="keywordflow">return</span> FALSE;
<a name="l01962"></a>01962         <span class="keywordflow">else</span> {
<a name="l01963"></a>01963             <span class="comment">/* Reset protocol_version to unknown so that we&#39;ll check it</span>
<a name="l01964"></a>01964 <span class="comment">             * after the server is up again. */</span>
<a name="l01965"></a>01965             state-&gt;<a class="code" href="struct__ServerState.html#adb0ef1901e8918aaa2a1e2ee5468b479">server_side_merge</a> = <a class="code" href="sync-mgr_8c.html#a16685eea158879e41b101ca3634de462a6c21229b0a45dd28406c0072669f5a65">SERVER_SIDE_MERGE_UNKNOWN</a>;
<a name="l01966"></a>01966             <span class="keywordflow">return</span> FALSE;
<a name="l01967"></a>01967         }
<a name="l01968"></a>01968     }
<a name="l01969"></a>01969 }
<a name="l01970"></a>01970 
<a name="l01971"></a>01971 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01972"></a>01972 check_http_protocol_done (<a class="code" href="struct__HttpProtocolVersion.html">HttpProtocolVersion</a> *result, <span class="keywordtype">void</span> *user_data)
<a name="l01973"></a>01973 {
<a name="l01974"></a>01974     <a class="code" href="struct__HttpServerState.html">HttpServerState</a> *state = user_data;
<a name="l01975"></a>01975 
<a name="l01976"></a>01976     state-&gt;<a class="code" href="struct__HttpServerState.html#a3addf09bb7110d3c0abb9e223be2f532">checking</a> = FALSE;
<a name="l01977"></a>01977 
<a name="l01978"></a>01978     <span class="keywordflow">if</span> (result-&gt;<a class="code" href="struct__HttpProtocolVersion.html#a991b27b1c98ba43a9b1ce6015621967b">check_success</a>) {
<a name="l01979"></a>01979         state-&gt;<a class="code" href="struct__HttpServerState.html#a86d68d7c613b0b4a08e3e53ee44f129b">http_not_supported</a> = result-&gt;<a class="code" href="struct__HttpProtocolVersion.html#a8b83905e8e620d43f74b060a44c3a6fd">not_supported</a>;
<a name="l01980"></a>01980         <span class="keywordflow">if</span> (!result-&gt;<a class="code" href="struct__HttpProtocolVersion.html#a8b83905e8e620d43f74b060a44c3a6fd">not_supported</a>)
<a name="l01981"></a>01981             state-&gt;<a class="code" href="struct__HttpServerState.html#abca94be9f168b0a44234314ad1e0d00b">http_version</a> = result-&gt;<a class="code" href="struct__HttpProtocolVersion.html#af81f9fb94ee6b008195681a8d2026591">version</a>;
<a name="l01982"></a>01982     } <span class="keywordflow">else</span>
<a name="l01983"></a>01983         state-&gt;<a class="code" href="struct__HttpServerState.html#a86d68d7c613b0b4a08e3e53ee44f129b">http_not_supported</a> = TRUE;
<a name="l01984"></a>01984 }
<a name="l01985"></a>01985 
<a name="l01986"></a><a class="code" href="sync-mgr_8c.html#a85ecb834a2ce957aab689e2fba277333">01986</a> <span class="preprocessor">#define CHECK_HTTP_INTERVAL 10</span>
<a name="l01987"></a>01987 <span class="preprocessor"></span>
<a name="l01988"></a>01988 <span class="comment">/*</span>
<a name="l01989"></a>01989 <span class="comment"> * Returns TRUE if we can use http-sync; otherwise FALSE.</span>
<a name="l01990"></a>01990 <span class="comment"> * If FALSE is returned, the caller should also check @is_checking value.</span>
<a name="l01991"></a>01991 <span class="comment"> * If @is_checking is set to TRUE, we&#39;re still determining whether the</span>
<a name="l01992"></a>01992 <span class="comment"> * server supports http-sync.</span>
<a name="l01993"></a>01993 <span class="comment"> */</span>
<a name="l01994"></a>01994 <span class="keyword">static</span> gboolean
<a name="l01995"></a>01995 check_http_protocol (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *mgr, <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, gboolean *is_checking)
<a name="l01996"></a>01996 {
<a name="l01997"></a>01997     *is_checking = FALSE;
<a name="l01998"></a>01998 
<a name="l01999"></a>01999     <span class="comment">/* If a repo was cloned before 4.0, server-url is not set. */</span>
<a name="l02000"></a>02000     <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#a1a7beee19acb913be2c23ac0e71ea733">server_url</a>)
<a name="l02001"></a>02001         <span class="keywordflow">return</span> FALSE;
<a name="l02002"></a>02002 
<a name="l02003"></a>02003     <a class="code" href="struct__HttpServerState.html">HttpServerState</a> *state = g_hash_table_lookup (mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a6c8c0f36f8e44feabd6cd44d6a4f49c1">http_server_states</a>,
<a name="l02004"></a>02004                                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#a1a7beee19acb913be2c23ac0e71ea733">server_url</a>);
<a name="l02005"></a>02005     <span class="keywordflow">if</span> (!state) {
<a name="l02006"></a>02006         state = g_new0 (<a class="code" href="struct__HttpServerState.html">HttpServerState</a>, 1);
<a name="l02007"></a>02007         g_hash_table_insert (mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a6c8c0f36f8e44feabd6cd44d6a4f49c1">http_server_states</a>,
<a name="l02008"></a>02008                              g_strdup(repo-&gt;<a class="code" href="struct__SeafRepo.html#a1a7beee19acb913be2c23ac0e71ea733">server_url</a>), state);
<a name="l02009"></a>02009     }
<a name="l02010"></a>02010 
<a name="l02011"></a>02011     <span class="keywordflow">if</span> (state-&gt;<a class="code" href="struct__HttpServerState.html#a3addf09bb7110d3c0abb9e223be2f532">checking</a>) {
<a name="l02012"></a>02012         *is_checking = TRUE;
<a name="l02013"></a>02013         <span class="keywordflow">return</span> FALSE;
<a name="l02014"></a>02014     }
<a name="l02015"></a>02015 
<a name="l02016"></a>02016     <span class="keywordflow">if</span> (state-&gt;<a class="code" href="struct__HttpServerState.html#a86d68d7c613b0b4a08e3e53ee44f129b">http_not_supported</a>)
<a name="l02017"></a>02017         <span class="keywordflow">return</span> FALSE;
<a name="l02018"></a>02018     <span class="keywordflow">if</span> (state-&gt;<a class="code" href="struct__HttpServerState.html#abca94be9f168b0a44234314ad1e0d00b">http_version</a> &gt; 0)
<a name="l02019"></a>02019         <span class="keywordflow">return</span> TRUE;
<a name="l02020"></a>02020 
<a name="l02021"></a>02021     <a class="code" href="http-tx-mgr_8c.html#a43e9d54b963e1bd9b8f43814a92563ea">http_tx_manager_check_protocol_version</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>,
<a name="l02022"></a>02022                                             repo-&gt;<a class="code" href="struct__SeafRepo.html#a1a7beee19acb913be2c23ac0e71ea733">server_url</a>,
<a name="l02023"></a>02023                                             check_http_protocol_done,
<a name="l02024"></a>02024                                             state);
<a name="l02025"></a>02025     state-&gt;<a class="code" href="struct__HttpServerState.html#a3addf09bb7110d3c0abb9e223be2f532">checking</a> = TRUE;
<a name="l02026"></a>02026     *is_checking = TRUE;
<a name="l02027"></a>02027 
<a name="l02028"></a>02028     <span class="keywordflow">return</span> FALSE;
<a name="l02029"></a>02029 }
<a name="l02030"></a>02030 
<a name="l02031"></a>02031 <span class="comment">/*</span>
<a name="l02032"></a>02032 <span class="comment"> * If the user upgarde from 3.0.x, there may be more than one commit to upload</span>
<a name="l02033"></a>02033 <span class="comment"> * on the local branch. The new syncing protocol can&#39;t handle more than one</span>
<a name="l02034"></a>02034 <span class="comment"> * commit. So if we detect this case, fall back to old protocol.</span>
<a name="l02035"></a>02035 <span class="comment"> * After the repo is synced this time, we can use new protocol in the future.</span>
<a name="l02036"></a>02036 <span class="comment"> */</span>
<a name="l02037"></a>02037 <span class="keyword">static</span> gboolean
<a name="l02038"></a>02038 has_old_commits_to_upload (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo)
<a name="l02039"></a>02039 {
<a name="l02040"></a>02040     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *master = NULL, *local = NULL;
<a name="l02041"></a>02041     <a class="code" href="struct__SeafCommit.html">SeafCommit</a> *head = NULL;
<a name="l02042"></a>02042     gboolean ret = TRUE;
<a name="l02043"></a>02043 
<a name="l02044"></a>02044     master = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="stringliteral">&quot;master&quot;</span>);
<a name="l02045"></a>02045     <span class="keywordflow">if</span> (!master) {
<a name="l02046"></a>02046         seaf_warning (<span class="stringliteral">&quot;No master branch found for repo %s(%.8s).\n&quot;</span>,
<a name="l02047"></a>02047                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02048"></a>02048         <span class="keywordflow">goto</span> out;
<a name="l02049"></a>02049     }
<a name="l02050"></a>02050     local = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="stringliteral">&quot;local&quot;</span>);
<a name="l02051"></a>02051     <span class="keywordflow">if</span> (!local) {
<a name="l02052"></a>02052         seaf_warning (<span class="stringliteral">&quot;No local branch found for repo %s(%.8s).\n&quot;</span>,
<a name="l02053"></a>02053                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02054"></a>02054         <span class="keywordflow">goto</span> out;
<a name="l02055"></a>02055     }
<a name="l02056"></a>02056 
<a name="l02057"></a>02057     <span class="keywordflow">if</span> (strcmp (local-&gt;commit_id, master-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>) == 0) {
<a name="l02058"></a>02058         ret = FALSE;
<a name="l02059"></a>02059         <span class="keywordflow">goto</span> out;
<a name="l02060"></a>02060     }
<a name="l02061"></a>02061 
<a name="l02062"></a>02062     head = <a class="code" href="commit-mgr_8c.html#adaf4b74c4dba25ddaa746f4ff9221b3f">seaf_commit_manager_get_commit</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a62979f26f91fc5e54e0a670e8d69ef67">commit_mgr</a>,
<a name="l02063"></a>02063                                            repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
<a name="l02064"></a>02064                                            local-&gt;commit_id);
<a name="l02065"></a>02065     <span class="keywordflow">if</span> (!head) {
<a name="l02066"></a>02066         seaf_warning (<span class="stringliteral">&quot;Failed to get head commit of repo %s(%.8s).\n&quot;</span>,
<a name="l02067"></a>02067                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02068"></a>02068         <span class="keywordflow">goto</span> out;
<a name="l02069"></a>02069     }
<a name="l02070"></a>02070 
<a name="l02071"></a>02071     <span class="keywordflow">if</span> (head-&gt;<a class="code" href="struct__SeafCommit.html#aad2ebe1498cc25f837554456cbcd31f5">second_parent_id</a> == NULL &amp;&amp;
<a name="l02072"></a>02072         g_strcmp0 (head-&gt;<a class="code" href="struct__SeafCommit.html#a24518f58c804153742e9976049da8512">parent_id</a>, master-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>) == 0)
<a name="l02073"></a>02073         ret = FALSE;
<a name="l02074"></a>02074 
<a name="l02075"></a>02075 out:
<a name="l02076"></a>02076     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (master);
<a name="l02077"></a>02077     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (local);
<a name="l02078"></a>02078     <a class="code" href="commit-mgr_8c.html#a436a9092e9c5711820dc1a09234aac04">seaf_commit_unref</a> (head);
<a name="l02079"></a>02079     <span class="keywordflow">return</span> ret;
<a name="l02080"></a>02080 }
<a name="l02081"></a>02081 
<a name="l02082"></a>02082 gint
<a name="l02083"></a><a class="code" href="sync-mgr_8c.html#a79dce39e18ecc6f32e4bff8fc3a2cf04">02083</a> <a class="code" href="sync-mgr_8c.html#a79dce39e18ecc6f32e4bff8fc3a2cf04">cmp_repos_by_sync_time</a> (gconstpointer a, gconstpointer b, gpointer user_data)
<a name="l02084"></a>02084 {
<a name="l02085"></a>02085     <span class="keyword">const</span> <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo_a = a;
<a name="l02086"></a>02086     <span class="keyword">const</span> <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo_b = b;
<a name="l02087"></a>02087 
<a name="l02088"></a>02088     <span class="keywordflow">return</span> (repo_a-&gt;<a class="code" href="struct__SeafRepo.html#aea8a8f2c57241ca9b47ae1e7026b4ea5">last_sync_time</a> - repo_b-&gt;<a class="code" href="struct__SeafRepo.html#aea8a8f2c57241ca9b47ae1e7026b4ea5">last_sync_time</a>);
<a name="l02089"></a>02089 }
<a name="l02090"></a>02090 
<a name="l02091"></a>02091 <span class="preprocessor">#ifdef WIN32</span>
<a name="l02092"></a>02092 <span class="preprocessor"></span>
<a name="l02093"></a>02093 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02094"></a>02094 cleanup_file_blocks (<span class="keyword">const</span> <span class="keywordtype">char</span> *repo_id, <span class="keywordtype">int</span> version, <span class="keyword">const</span> <span class="keywordtype">char</span> *file_id)
<a name="l02095"></a>02095 {
<a name="l02096"></a>02096     <a class="code" href="struct__Seafile.html">Seafile</a> *file;
<a name="l02097"></a>02097     <span class="keywordtype">int</span> i;
<a name="l02098"></a>02098 
<a name="l02099"></a>02099     file = <a class="code" href="fs-mgr_8c.html#a029c16e2ecdf6eafd96edb2ee4e6beac">seaf_fs_manager_get_seafile</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
<a name="l02100"></a>02100                                         repo_id, version,
<a name="l02101"></a>02101                                         file_id);
<a name="l02102"></a>02102     <span class="keywordflow">for</span> (i = 0; i &lt; file-&gt;<a class="code" href="struct__Seafile.html#af2d5c5e5bb56d38122dead42128b9c20">n_blocks</a>; ++i)
<a name="l02103"></a>02103         <a class="code" href="block-mgr_8c.html#a4b9324cd1b942eb1378bc9ea7f5eaccf">seaf_block_manager_remove_block</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a4b29afaa0ca920084596a236c8460df2">block_mgr</a>,
<a name="l02104"></a>02104                                          repo_id, version,
<a name="l02105"></a>02105                                          file-&gt;<a class="code" href="struct__Seafile.html#aacaedff2674132faf3d522ba8df6e268">blk_sha1s</a>[i]);
<a name="l02106"></a>02106 
<a name="l02107"></a>02107     <a class="code" href="fs-mgr_8c.html#a0a491c647769cf7bd09d5092ab84b85a">seafile_unref</a> (file);
<a name="l02108"></a>02108 }
<a name="l02109"></a>02109 
<a name="l02110"></a>02110 <span class="keyword">static</span> gboolean
<a name="l02111"></a>02111 handle_locked_file_update (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate,
<a name="l02112"></a>02112                            <a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset, <span class="keyword">const</span> <span class="keywordtype">char</span> *path, <a class="code" href="struct__LockedFile.html">LockedFile</a> *locked)
<a name="l02113"></a>02113 {
<a name="l02114"></a>02114     <span class="keyword">struct </span><a class="code" href="structcache__entry.html">cache_entry</a> *ce;
<a name="l02115"></a>02115     <span class="keywordtype">char</span> file_id[41];
<a name="l02116"></a>02116     <span class="keywordtype">char</span> *fullpath = NULL;
<a name="l02117"></a>02117     <a class="code" href="seafile_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l02118"></a>02118     gboolean file_exists = TRUE;
<a name="l02119"></a>02119     <a class="code" href="structSeafileCrypt.html">SeafileCrypt</a> *crypt = NULL;
<a name="l02120"></a>02120     <a class="code" href="struct__SeafBranch.html">SeafBranch</a> *master = NULL;
<a name="l02121"></a>02121     gboolean ret = TRUE;
<a name="l02122"></a>02122 
<a name="l02123"></a>02123     <span class="comment">/* File is still locked, do nothing. */</span>
<a name="l02124"></a>02124     <span class="keywordflow">if</span> (<a class="code" href="vc-utils_8h.html#ade755cc297b064bd93b1527533979454">do_check_file_locked</a> (path, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>))
<a name="l02125"></a>02125         <span class="keywordflow">return</span> FALSE;
<a name="l02126"></a>02126 
<a name="l02127"></a>02127     seaf_debug (<span class="stringliteral">&quot;Update previously locked file %s in repo %.8s.\n&quot;</span>,
<a name="l02128"></a>02128                 path, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02129"></a>02129 
<a name="l02130"></a>02130     <span class="comment">/* If the file was locked on the last checkout, the worktree file was not</span>
<a name="l02131"></a>02131 <span class="comment">     * updated, but the index has been updated. So the ce in the index should</span>
<a name="l02132"></a>02132 <span class="comment">     * contain the information for the file to be updated.</span>
<a name="l02133"></a>02133 <span class="comment">     */</span>
<a name="l02134"></a>02134     ce = <a class="code" href="index_8c.html#a3931a94c55aad8bf8267f179ae846711">index_name_exists</a> (istate, path, strlen(path), 0);
<a name="l02135"></a>02135     <span class="keywordflow">if</span> (!ce) {
<a name="l02136"></a>02136         seaf_warning (<span class="stringliteral">&quot;Cache entry for %s in repo %s(%.8s) is not found &quot;</span>
<a name="l02137"></a>02137                       <span class="stringliteral">&quot;when update locked file.&quot;</span>,
<a name="l02138"></a>02138                       path, repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02139"></a>02139         <span class="keywordflow">goto</span> remove_from_db;
<a name="l02140"></a>02140     }
<a name="l02141"></a>02141 
<a name="l02142"></a>02142     <a class="code" href="seafile_2lib_2utils_8c.html#ae947b53110fc0132e83445d76ddded09">rawdata_to_hex</a> (ce-&gt;<a class="code" href="structcache__entry.html#a119ab5c5e9db495e6e5f8d301f01421c">sha1</a>, file_id, 20);
<a name="l02143"></a>02143 
<a name="l02144"></a>02144     fullpath = g_build_filename (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, path, NULL);
<a name="l02145"></a>02145 
<a name="l02146"></a>02146     file_exists = <a class="code" href="seafile_2lib_2utils_8c.html#a1c2448a989efb1ce953a90f3db3c8042">seaf_util_exists</a> (fullpath);
<a name="l02147"></a>02147 
<a name="l02148"></a>02148     <span class="keywordflow">if</span> (file_exists &amp;&amp; <a class="code" href="seafile_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (fullpath, &amp;st) &lt; 0) {
<a name="l02149"></a>02149         seaf_warning (<span class="stringliteral">&quot;Failed to stat %s: %s.\n&quot;</span>, fullpath, strerror(errno));
<a name="l02150"></a>02150         <span class="keywordflow">goto</span> out;
<a name="l02151"></a>02151     }
<a name="l02152"></a>02152 
<a name="l02153"></a>02153     <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab50d0e015838fe83d735ba2d6cb40804">encrypted</a>)
<a name="l02154"></a>02154         crypt = <a class="code" href="seafile-crypt_8c.html#af29d9c2876336f8354c568773b40d228">seafile_crypt_new</a> (repo-&gt;<a class="code" href="struct__SeafRepo.html#af4cb7f672489dceb52cbd47da097ebf8">enc_version</a>,
<a name="l02155"></a>02155                                    repo-&gt;<a class="code" href="struct__SeafRepo.html#ad951f63e287f0ea14c863937afea6779">enc_key</a>,
<a name="l02156"></a>02156                                    repo-&gt;<a class="code" href="struct__SeafRepo.html#a7ad105e1fab206035f1c585c25e0dc94">enc_iv</a>);
<a name="l02157"></a>02157 
<a name="l02158"></a>02158     master = <a class="code" href="branch-mgr_8c.html#a1dffc8c3c325e4ca1daf8a5d5f4f6956">seaf_branch_manager_get_branch</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#acd445f79648f74358e145f48f771e11c">branch_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <span class="stringliteral">&quot;master&quot;</span>);
<a name="l02159"></a>02159     <span class="keywordflow">if</span> (!master) {
<a name="l02160"></a>02160         seaf_warning (<span class="stringliteral">&quot;No master branch found for repo %s(%.8s).\n&quot;</span>,
<a name="l02161"></a>02161                       repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02162"></a>02162         <span class="keywordflow">goto</span> out;
<a name="l02163"></a>02163     }
<a name="l02164"></a>02164 
<a name="l02165"></a>02165     gboolean conflicted;
<a name="l02166"></a>02166     gboolean force_conflict = (file_exists &amp;&amp; st.st_mtime != locked-&gt;<a class="code" href="struct__LockedFile.html#a1e6ec2e3b09c05236c6898df5dc77475">old_mtime</a>);
<a name="l02167"></a>02167     <span class="keywordflow">if</span> (<a class="code" href="fs-mgr_8c.html#aa1e02fce35b0a00a0a65c37299865628">seaf_fs_manager_checkout_file</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a7ab44dd0bf8e3b3df6ee858e7d07e86d">fs_mgr</a>,
<a name="l02168"></a>02168                                        repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>,
<a name="l02169"></a>02169                                        file_id, fullpath,
<a name="l02170"></a>02170                                        ce-&gt;<a class="code" href="structcache__entry.html#a5fcbcc4e7265ae8150f136380ed92c05">ce_mode</a>, ce-&gt;<a class="code" href="structcache__entry.html#a1c66f1f4e7773a56010e7ec64bd38a95">ce_mtime</a>.<a class="code" href="structcache__time64.html#ae37877c7f3995f5a44a4a9fd7bb91d46">sec</a>,
<a name="l02171"></a>02171                                        crypt,
<a name="l02172"></a>02172                                        path,
<a name="l02173"></a>02173                                        master-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>,
<a name="l02174"></a>02174                                        force_conflict,
<a name="l02175"></a>02175                                        &amp;conflicted) &lt; 0) {
<a name="l02176"></a>02176         seaf_warning (<span class="stringliteral">&quot;Failed to checkout previously locked file %s in repo &quot;</span>
<a name="l02177"></a>02177                       <span class="stringliteral">&quot;%s(%.8s).\n&quot;</span>,
<a name="l02178"></a>02178                       path, repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02179"></a>02179     }
<a name="l02180"></a>02180 
<a name="l02181"></a>02181 out:
<a name="l02182"></a>02182     cleanup_file_blocks (repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>, file_id);
<a name="l02183"></a>02183 
<a name="l02184"></a>02184 remove_from_db:
<a name="l02185"></a>02185     <span class="comment">/* Remove the locked file record from db. */</span>
<a name="l02186"></a>02186     <a class="code" href="daemon_2repo-mgr_8c.html#a4d1dacc802b818970800154a9bc6e3db">locked_file_set_remove</a> (fset, path, TRUE);
<a name="l02187"></a>02187 
<a name="l02188"></a>02188     g_free (fullpath);
<a name="l02189"></a>02189     g_free (crypt);
<a name="l02190"></a>02190     <a class="code" href="branch-mgr_8c.html#a2e44cba993ba080e7550a832f019f653">seaf_branch_unref</a> (master);
<a name="l02191"></a>02191     <span class="keywordflow">return</span> ret;
<a name="l02192"></a>02192 }
<a name="l02193"></a>02193 
<a name="l02194"></a>02194 <span class="keyword">static</span> gboolean
<a name="l02195"></a>02195 handle_locked_file_delete (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <span class="keyword">struct</span> <a class="code" href="structindex__state.html">index_state</a> *istate,
<a name="l02196"></a>02196                            <a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset, <span class="keyword">const</span> <span class="keywordtype">char</span> *path, <a class="code" href="struct__LockedFile.html">LockedFile</a> *locked)
<a name="l02197"></a>02197 {
<a name="l02198"></a>02198     <span class="keywordtype">char</span> *fullpath = NULL;
<a name="l02199"></a>02199     <a class="code" href="seafile_2lib_2utils_8h.html#a5b073bcbe1516b249924c3702002d32c">SeafStat</a> st;
<a name="l02200"></a>02200     gboolean file_exists = TRUE;
<a name="l02201"></a>02201     gboolean ret = TRUE;
<a name="l02202"></a>02202 
<a name="l02203"></a>02203     <span class="comment">/* File is still locked, do nothing. */</span>
<a name="l02204"></a>02204     <span class="keywordflow">if</span> (<a class="code" href="vc-utils_8h.html#ade755cc297b064bd93b1527533979454">do_check_file_locked</a> (path, repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>))
<a name="l02205"></a>02205         <span class="keywordflow">return</span> FALSE;
<a name="l02206"></a>02206 
<a name="l02207"></a>02207     seaf_debug (<span class="stringliteral">&quot;Delete previously locked file %s in repo %.8s.\n&quot;</span>,
<a name="l02208"></a>02208                 path, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02209"></a>02209 
<a name="l02210"></a>02210     fullpath = g_build_filename (repo-&gt;<a class="code" href="struct__SeafRepo.html#a4342ff79933f9cbdbbd34114e5a26df3">worktree</a>, path, NULL);
<a name="l02211"></a>02211 
<a name="l02212"></a>02212     file_exists = <a class="code" href="seafile_2lib_2utils_8c.html#a1c2448a989efb1ce953a90f3db3c8042">seaf_util_exists</a> (fullpath);
<a name="l02213"></a>02213 
<a name="l02214"></a>02214     <span class="keywordflow">if</span> (file_exists &amp;&amp; <a class="code" href="seafile_2lib_2utils_8c.html#ab46893ad4a68049bcd80eac8dcc2e299">seaf_stat</a> (fullpath, &amp;st) &lt; 0) {
<a name="l02215"></a>02215         seaf_warning (<span class="stringliteral">&quot;Failed to stat %s: %s.\n&quot;</span>, fullpath, strerror(errno));
<a name="l02216"></a>02216         <span class="keywordflow">goto</span> out;
<a name="l02217"></a>02217     }
<a name="l02218"></a>02218 
<a name="l02219"></a>02219     <span class="keywordflow">if</span> (file_exists &amp;&amp; st.st_mtime == locked-&gt;<a class="code" href="struct__LockedFile.html#a1e6ec2e3b09c05236c6898df5dc77475">old_mtime</a>)
<a name="l02220"></a>02220         <a class="code" href="seafile_2lib_2utils_8c.html#a26f091009701c5a9d1886b9d6ceb9c8e">seaf_util_unlink</a> (fullpath);
<a name="l02221"></a>02221 
<a name="l02222"></a>02222 out:
<a name="l02223"></a>02223     <span class="comment">/* Remove the locked file record from db. */</span>
<a name="l02224"></a>02224     <a class="code" href="daemon_2repo-mgr_8c.html#a4d1dacc802b818970800154a9bc6e3db">locked_file_set_remove</a> (fset, path, TRUE);
<a name="l02225"></a>02225 
<a name="l02226"></a>02226     g_free (fullpath);
<a name="l02227"></a>02227     <span class="keywordflow">return</span> ret;
<a name="l02228"></a>02228 }
<a name="l02229"></a>02229 
<a name="l02230"></a>02230 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l02231"></a>02231 check_locked_files (<span class="keywordtype">void</span> *vdata)
<a name="l02232"></a>02232 {
<a name="l02233"></a>02233     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = vdata;
<a name="l02234"></a>02234     <a class="code" href="struct__LockedFileSet.html">LockedFileSet</a> *fset;
<a name="l02235"></a>02235     GHashTableIter iter;
<a name="l02236"></a>02236     gpointer key, value;
<a name="l02237"></a>02237     <span class="keywordtype">char</span> *path;
<a name="l02238"></a>02238     <a class="code" href="struct__LockedFile.html">LockedFile</a> *locked;
<a name="l02239"></a>02239     <span class="keywordtype">char</span> <a class="code" href="index_8c.html#a35caece3e3575d32521f820a8f0a24a7">index_path</a>[<a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>];
<a name="l02240"></a>02240     <span class="keyword">struct </span><a class="code" href="structindex__state.html">index_state</a> istate;
<a name="l02241"></a>02241 
<a name="l02242"></a>02242     fset = <a class="code" href="daemon_2repo-mgr_8c.html#a06294e91365be10d46a356d427f62e07">seaf_repo_manager_get_locked_file_set</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02243"></a>02243 
<a name="l02244"></a>02244     <span class="keywordflow">if</span> (g_hash_table_size (fset-&gt;locked_files) == 0) {
<a name="l02245"></a>02245         <a class="code" href="daemon_2repo-mgr_8c.html#ab44c57f5e23996e5eb807f7c84f443f5">locked_file_set_free</a> (fset);
<a name="l02246"></a>02246         <span class="keywordflow">return</span> vdata;
<a name="l02247"></a>02247     }
<a name="l02248"></a>02248 
<a name="l02249"></a>02249     memset (&amp;istate, 0, <span class="keyword">sizeof</span>(istate));
<a name="l02250"></a>02250     snprintf (index_path, <a class="code" href="seafile_2common_2common_8h.html#a169a119979344433b9e2a39e4e8e334a">SEAF_PATH_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9bae0acc12e2e63b0686027f7399e034">manager</a>-&gt;<a class="code" href="struct__SeafRepoManager.html#a24a8835becd3d59636e13e5cc0cfc365">index_dir</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02251"></a>02251     <span class="keywordflow">if</span> (<a class="code" href="index_8c.html#a0f9de2761514c9136fb4b9c5541ef6f8">read_index_from</a> (&amp;istate, index_path, repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a>) &lt; 0) {
<a name="l02252"></a>02252         seaf_warning (<span class="stringliteral">&quot;Failed to load index.\n&quot;</span>);
<a name="l02253"></a>02253         <span class="keywordflow">return</span> vdata;
<a name="l02254"></a>02254     }
<a name="l02255"></a>02255 
<a name="l02256"></a>02256     gboolean success;
<a name="l02257"></a>02257     g_hash_table_iter_init (&amp;iter, fset-&gt;locked_files);
<a name="l02258"></a>02258     <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
<a name="l02259"></a>02259         path = key;
<a name="l02260"></a>02260         locked = value;
<a name="l02261"></a>02261 
<a name="l02262"></a>02262         success = FALSE;
<a name="l02263"></a>02263         <span class="keywordflow">if</span> (strcmp (locked-&gt;<a class="code" href="struct__LockedFile.html#abdcab3c93928ff7a61146d497d5e4ec7">operation</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a73695736a3b6d6bc38b8a7e439dba0b4">LOCKED_OP_UPDATE</a>) == 0)
<a name="l02264"></a>02264             success = handle_locked_file_update (repo, &amp;istate, fset, path, locked);
<a name="l02265"></a>02265         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp (locked-&gt;<a class="code" href="struct__LockedFile.html#abdcab3c93928ff7a61146d497d5e4ec7">operation</a>, <a class="code" href="daemon_2repo-mgr_8h.html#ae9d9b81961c1ed4497f7f808c6be96ed">LOCKED_OP_DELETE</a>) == 0)
<a name="l02266"></a>02266             success = handle_locked_file_delete (repo, &amp;istate, fset, path, locked);
<a name="l02267"></a>02267 
<a name="l02268"></a>02268         <span class="keywordflow">if</span> (success)
<a name="l02269"></a>02269             g_hash_table_iter_remove (&amp;iter);
<a name="l02270"></a>02270     }
<a name="l02271"></a>02271 
<a name="l02272"></a>02272     <a class="code" href="index_8c.html#a835affdb8e7226b619f5cbf69a36db1f">discard_index</a> (&amp;istate);
<a name="l02273"></a>02273     <a class="code" href="daemon_2repo-mgr_8c.html#ab44c57f5e23996e5eb807f7c84f443f5">locked_file_set_free</a> (fset);
<a name="l02274"></a>02274 
<a name="l02275"></a>02275     <span class="keywordflow">return</span> vdata;
<a name="l02276"></a>02276 }
<a name="l02277"></a>02277 
<a name="l02278"></a>02278 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02279"></a>02279 check_locked_files_done (<span class="keywordtype">void</span> *vdata)
<a name="l02280"></a>02280 {
<a name="l02281"></a>02281     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo = vdata;
<a name="l02282"></a>02282     repo-&gt;<a class="code" href="struct__SeafRepo.html#a772a296124f0a505659064406232dfe2">checking_locked_files</a> = FALSE;
<a name="l02283"></a>02283 }
<a name="l02284"></a>02284 
<a name="l02285"></a>02285 <span class="preprocessor">#endif</span>
<a name="l02286"></a>02286 <span class="preprocessor"></span>
<a name="l02287"></a>02287 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02288"></a>02288 check_folder_perms_done (<a class="code" href="struct__HttpFolderPerms.html">HttpFolderPerms</a> *result, <span class="keywordtype">void</span> *user_data)
<a name="l02289"></a>02289 {
<a name="l02290"></a>02290     <a class="code" href="struct__HttpServerState.html">HttpServerState</a> *server_state = user_data;
<a name="l02291"></a>02291     GList *ptr;
<a name="l02292"></a>02292     <a class="code" href="struct__HttpFolderPermRes.html">HttpFolderPermRes</a> *res;
<a name="l02293"></a>02293     gint64 now = (gint64)time(NULL);
<a name="l02294"></a>02294 
<a name="l02295"></a>02295     server_state-&gt;<a class="code" href="struct__HttpServerState.html#a2c37a6a8ad57661b1f8143b3a47b80c6">checking_folder_perms</a> = FALSE;
<a name="l02296"></a>02296 
<a name="l02297"></a>02297     <span class="keywordflow">if</span> (!result-&gt;<a class="code" href="struct__HttpFolderPerms.html#a9379fb92d03bba941e2769bf9b7eb7da">success</a>) {
<a name="l02298"></a>02298         <span class="comment">/* If on star-up we find that checking folder perms fails,</span>
<a name="l02299"></a>02299 <span class="comment">         * we assume the server doesn&#39;t support it.</span>
<a name="l02300"></a>02300 <span class="comment">         */</span>
<a name="l02301"></a>02301         <span class="keywordflow">if</span> (server_state-&gt;<a class="code" href="struct__HttpServerState.html#a0b28daa3819543642d186ab8f2bddc54">last_check_perms_time</a> == 0)
<a name="l02302"></a>02302             server_state-&gt;<a class="code" href="struct__HttpServerState.html#a30f8aae98bdf6115f7a68461936e7888">folder_perms_not_supported</a> = TRUE;
<a name="l02303"></a>02303         server_state-&gt;<a class="code" href="struct__HttpServerState.html#a0b28daa3819543642d186ab8f2bddc54">last_check_perms_time</a> = now;
<a name="l02304"></a>02304         <span class="keywordflow">return</span>;
<a name="l02305"></a>02305     }
<a name="l02306"></a>02306 
<a name="l02307"></a>02307     <span class="keywordflow">for</span> (ptr = result-&gt;<a class="code" href="struct__HttpFolderPerms.html#ae86a1a8d2d956bf938be35e1fc4d4a9f">results</a>; ptr; ptr = ptr-&gt;next) {
<a name="l02308"></a>02308         res = ptr-&gt;data;
<a name="l02309"></a>02309 
<a name="l02310"></a>02310         <a class="code" href="daemon_2repo-mgr_8c.html#a446e8f23cdec415146a604f1b954c1a3">seaf_repo_manager_update_folder_perms</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, res-&gt;<a class="code" href="struct__HttpFolderPermRes.html#a5494ec0e4cf8755ccc3a7b5695622de0">repo_id</a>,
<a name="l02311"></a>02311                                                <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa664ef9343772c1e5e20606d23a2f696a">FOLDER_PERM_TYPE_USER</a>,
<a name="l02312"></a>02312                                                res-&gt;<a class="code" href="struct__HttpFolderPermRes.html#a02929f1af633e277256696ffc7ec3220">user_perms</a>);
<a name="l02313"></a>02313         <a class="code" href="daemon_2repo-mgr_8c.html#a446e8f23cdec415146a604f1b954c1a3">seaf_repo_manager_update_folder_perms</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, res-&gt;<a class="code" href="struct__HttpFolderPermRes.html#a5494ec0e4cf8755ccc3a7b5695622de0">repo_id</a>,
<a name="l02314"></a>02314                                                <a class="code" href="daemon_2repo-mgr_8h.html#aa3928c5df6e4b48d8f0218bc5440ad1aa55b4f2e55f412aa138091a6f350d16de">FOLDER_PERM_TYPE_GROUP</a>,
<a name="l02315"></a>02315                                                res-&gt;<a class="code" href="struct__HttpFolderPermRes.html#a739b8d7b0272f8a9a59bced0f202b533">group_perms</a>);
<a name="l02316"></a>02316         <a class="code" href="daemon_2repo-mgr_8c.html#af7adb54d2ed6bcfd5b722428bfcfb6d6">seaf_repo_manager_update_folder_perm_timestamp</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l02317"></a>02317                                                         res-&gt;<a class="code" href="struct__HttpFolderPermRes.html#a5494ec0e4cf8755ccc3a7b5695622de0">repo_id</a>,
<a name="l02318"></a>02318                                                         res-&gt;<a class="code" href="struct__HttpFolderPermRes.html#a677f775892b98905ea3cacfa9454e8a0">timestamp</a>);
<a name="l02319"></a>02319     }
<a name="l02320"></a>02320     server_state-&gt;<a class="code" href="struct__HttpServerState.html#a0b28daa3819543642d186ab8f2bddc54">last_check_perms_time</a> = now;
<a name="l02321"></a>02321 }
<a name="l02322"></a>02322 
<a name="l02323"></a>02323 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02324"></a>02324 check_folder_permissions_one_server (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *mgr,
<a name="l02325"></a>02325                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *host,
<a name="l02326"></a>02326                                      <a class="code" href="struct__HttpServerState.html">HttpServerState</a> *server_state,
<a name="l02327"></a>02327                                      GList *repos)
<a name="l02328"></a>02328 {
<a name="l02329"></a>02329     GList *ptr;
<a name="l02330"></a>02330     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l02331"></a>02331     <span class="keywordtype">char</span> *token;
<a name="l02332"></a>02332     gint64 <a class="code" href="structindex__state.html#aba21746d004309949f3af631aced813a">timestamp</a>;
<a name="l02333"></a>02333     <a class="code" href="struct__HttpFolderPermReq.html">HttpFolderPermReq</a> *req;
<a name="l02334"></a>02334     GList *requests = NULL;
<a name="l02335"></a>02335 
<a name="l02336"></a>02336     gint64 now = (gint64)time(NULL);
<a name="l02337"></a>02337 
<a name="l02338"></a>02338     <span class="keywordflow">if</span> (server_state-&gt;<a class="code" href="struct__HttpServerState.html#abca94be9f168b0a44234314ad1e0d00b">http_version</a> == 0 ||
<a name="l02339"></a>02339         server_state-&gt;<a class="code" href="struct__HttpServerState.html#a30f8aae98bdf6115f7a68461936e7888">folder_perms_not_supported</a> ||
<a name="l02340"></a>02340         server_state-&gt;<a class="code" href="struct__HttpServerState.html#a2c37a6a8ad57661b1f8143b3a47b80c6">checking_folder_perms</a>)
<a name="l02341"></a>02341         <span class="keywordflow">return</span>;
<a name="l02342"></a>02342 
<a name="l02343"></a>02343     <span class="keywordflow">if</span> (server_state-&gt;<a class="code" href="struct__HttpServerState.html#a0b28daa3819543642d186ab8f2bddc54">last_check_perms_time</a> &gt; 0 &amp;&amp;
<a name="l02344"></a>02344         now - server_state-&gt;<a class="code" href="struct__HttpServerState.html#a0b28daa3819543642d186ab8f2bddc54">last_check_perms_time</a> &lt; <a class="code" href="sync-mgr_8c.html#af65ba0d46a26859a25127a6d03efd5b4">CHECK_FOLDER_PERMS_INTERVAL</a>)
<a name="l02345"></a>02345         <span class="keywordflow">return</span>;
<a name="l02346"></a>02346 
<a name="l02347"></a>02347     <span class="keywordflow">for</span> (ptr = repos; ptr; ptr = ptr-&gt;next) {
<a name="l02348"></a>02348         repo = ptr-&gt;data;
<a name="l02349"></a>02349 
<a name="l02350"></a>02350         <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>)
<a name="l02351"></a>02351             <span class="keywordflow">continue</span>;
<a name="l02352"></a>02352 
<a name="l02353"></a>02353         <span class="keywordflow">if</span> (g_strcmp0 (host, repo-&gt;<a class="code" href="struct__SeafRepo.html#a1a7beee19acb913be2c23ac0e71ea733">server_url</a>) != 0)
<a name="l02354"></a>02354             <span class="keywordflow">continue</span>;
<a name="l02355"></a>02355 
<a name="l02356"></a>02356         token = <a class="code" href="daemon_2repo-mgr_8c.html#a71edf5bba9589fa8793d7b0312cb9553">seaf_repo_manager_get_repo_property</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l02357"></a>02357                                                      repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, <a class="code" href="daemon_2repo-mgr_8h.html#a1d2a9886ff3a1d69407ba0b287cbeac4">REPO_PROP_TOKEN</a>);
<a name="l02358"></a>02358         <span class="keywordflow">if</span> (!token)
<a name="l02359"></a>02359             <span class="keywordflow">continue</span>;
<a name="l02360"></a>02360 
<a name="l02361"></a>02361         timestamp = <a class="code" href="daemon_2repo-mgr_8c.html#a7320afc04f67e0cb3dcc20389479c234">seaf_repo_manager_get_folder_perm_timestamp</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l02362"></a>02362                                                                  repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02363"></a>02363         <span class="keywordflow">if</span> (timestamp &lt; 0)
<a name="l02364"></a>02364             timestamp = 0;
<a name="l02365"></a>02365 
<a name="l02366"></a>02366         req = g_new0 (<a class="code" href="struct__HttpFolderPermReq.html">HttpFolderPermReq</a>, 1);
<a name="l02367"></a>02367         memcpy (req-&gt;<a class="code" href="struct__HttpFolderPermReq.html#ac1e67df051ff5a1a9c41488633b842e1">repo_id</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>, 36);
<a name="l02368"></a>02368         req-&gt;<a class="code" href="struct__HttpFolderPermReq.html#aa33db724e9d1c9b0f37cbd297ed76063">token</a> = g_strdup(token);
<a name="l02369"></a>02369         req-&gt;<a class="code" href="struct__HttpFolderPermReq.html#ae33fa9e631483b84321249871cff9a03">timestamp</a> = <a class="code" href="structindex__state.html#aba21746d004309949f3af631aced813a">timestamp</a>;
<a name="l02370"></a>02370 
<a name="l02371"></a>02371         requests = g_list_append (requests, req);
<a name="l02372"></a>02372     }
<a name="l02373"></a>02373 
<a name="l02374"></a>02374     <span class="keywordflow">if</span> (!requests)
<a name="l02375"></a>02375         <span class="keywordflow">return</span>;
<a name="l02376"></a>02376 
<a name="l02377"></a>02377     server_state-&gt;<a class="code" href="struct__HttpServerState.html#a2c37a6a8ad57661b1f8143b3a47b80c6">checking_folder_perms</a> = TRUE;
<a name="l02378"></a>02378 
<a name="l02379"></a>02379     <span class="comment">/* The requests list will be freed in http tx manager. */</span>
<a name="l02380"></a>02380     <a class="code" href="http-tx-mgr_8c.html#a24eb2fd0df4be5e88734649f6ff73fc3">http_tx_manager_get_folder_perms</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3be7b98d0f1cc49d0fad03c68e63da74">http_tx_mgr</a>,
<a name="l02381"></a>02381                                       host,
<a name="l02382"></a>02382                                       requests,
<a name="l02383"></a>02383                                       check_folder_perms_done,
<a name="l02384"></a>02384                                       server_state);
<a name="l02385"></a>02385 }
<a name="l02386"></a>02386 
<a name="l02387"></a>02387 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02388"></a>02388 check_folder_permissions (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *mgr, GList *repos)
<a name="l02389"></a>02389 {
<a name="l02390"></a>02390     GHashTableIter iter;
<a name="l02391"></a>02391     gpointer key, value;
<a name="l02392"></a>02392     <span class="keywordtype">char</span> *host;
<a name="l02393"></a>02393     <a class="code" href="struct__HttpServerState.html">HttpServerState</a> *state;
<a name="l02394"></a>02394 
<a name="l02395"></a>02395     g_hash_table_iter_init (&amp;iter, mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a6c8c0f36f8e44feabd6cd44d6a4f49c1">http_server_states</a>);
<a name="l02396"></a>02396     <span class="keywordflow">while</span> (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value)) {
<a name="l02397"></a>02397         host = key;
<a name="l02398"></a>02398         state = value;
<a name="l02399"></a>02399         check_folder_permissions_one_server (mgr, host, state, repos);
<a name="l02400"></a>02400     }
<a name="l02401"></a>02401 }
<a name="l02402"></a>02402 
<a name="l02403"></a>02403 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02404"></a>02404 auto_sync_pulse (<span class="keywordtype">void</span> *vmanager)
<a name="l02405"></a>02405 {
<a name="l02406"></a>02406     <a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager = vmanager;
<a name="l02407"></a>02407     GList *repos, *ptr;
<a name="l02408"></a>02408     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l02409"></a>02409     gint64 now;
<a name="l02410"></a>02410 
<a name="l02411"></a>02411     repos = <a class="code" href="daemon_2repo-mgr_8c.html#a5fe41fb7382995f3f335e408ba4ddb30">seaf_repo_manager_get_repo_list</a> (manager-&gt;<a class="code" href="struct__SeafSyncManager.html#a15dbbff6ec86d385b4fbfcd5605b1112">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, -1, -1);
<a name="l02412"></a>02412 
<a name="l02413"></a>02413     check_folder_permissions (manager, repos);
<a name="l02414"></a>02414 
<a name="l02415"></a>02415     <span class="comment">/* Sort repos by last_sync_time, so that we don&#39;t &quot;starve&quot; any repo. */</span>
<a name="l02416"></a>02416     repos = g_list_sort_with_data (repos, <a class="code" href="sync-mgr_8c.html#a79dce39e18ecc6f32e4bff8fc3a2cf04">cmp_repos_by_sync_time</a>, NULL);
<a name="l02417"></a>02417 
<a name="l02418"></a>02418     <span class="keywordflow">for</span> (ptr = repos; ptr != NULL; ptr = ptr-&gt;next) {
<a name="l02419"></a>02419         repo = ptr-&gt;data;
<a name="l02420"></a>02420 
<a name="l02421"></a>02421         <span class="comment">/* Every second, we&#39;ll check the worktree to see if it still exists.</span>
<a name="l02422"></a>02422 <span class="comment">         * We&#39;ll invalidate worktree if it gets moved or deleted.</span>
<a name="l02423"></a>02423 <span class="comment">         * But there is a hole here: If the user delete the worktree dir and</span>
<a name="l02424"></a>02424 <span class="comment">         * recreate a dir with the same name within a second, we&#39;ll falsely</span>
<a name="l02425"></a>02425 <span class="comment">         * see the worktree as valid. What&#39;s worse, the new worktree dir won&#39;t</span>
<a name="l02426"></a>02426 <span class="comment">         * be monitored.</span>
<a name="l02427"></a>02427 <span class="comment">         * This problem can only be solved by restart.</span>
<a name="l02428"></a>02428 <span class="comment">         */</span>
<a name="l02429"></a>02429         <span class="comment">/* If repo has been checked out and the worktree doesn&#39;t exist,</span>
<a name="l02430"></a>02430 <span class="comment">         * we&#39;ll delete the repo automatically.</span>
<a name="l02431"></a>02431 <span class="comment">         */</span>
<a name="l02432"></a>02432 
<a name="l02433"></a>02433         <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a> != NULL) {
<a name="l02434"></a>02434             <span class="keywordflow">if</span> (<a class="code" href="daemon_2repo-mgr_8c.html#ad1200d69d8e6219885da4e85af15dca2">seaf_repo_check_worktree</a> (repo) &lt; 0) {
<a name="l02435"></a>02435                 <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a>) {
<a name="l02436"></a>02436                     <span class="comment">// The repo worktree was valid, but now it&#39;s invalid</span>
<a name="l02437"></a>02437                     <a class="code" href="daemon_2repo-mgr_8c.html#a4002175d5613c80a6dd82b95bc1fae24">seaf_repo_manager_invalidate_repo_worktree</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo);
<a name="l02438"></a>02438                     <span class="keywordflow">if</span> (!<a class="code" href="seafile-config_8c.html#adfb95469d4c47a60ad25400c3e2a9f96">seafile_session_config_get_allow_invalid_worktree</a>(<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>)) {
<a name="l02439"></a>02439                         auto_delete_repo (manager, repo);
<a name="l02440"></a>02440                     }
<a name="l02441"></a>02441                 }
<a name="l02442"></a>02442                 <span class="keywordflow">continue</span>;
<a name="l02443"></a>02443             } <span class="keywordflow">else</span> {
<a name="l02444"></a>02444                 <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a>) {
<a name="l02445"></a>02445                     <span class="comment">// The repo worktree was invalid, but now it&#39;s valid again,</span>
<a name="l02446"></a>02446                     <span class="comment">// so we start watch it</span>
<a name="l02447"></a>02447                     <a class="code" href="daemon_2repo-mgr_8c.html#a8299b47936df15cd58ba2ae41e344450">seaf_repo_manager_validate_repo_worktree</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo);
<a name="l02448"></a>02448                     <span class="keywordflow">continue</span>;
<a name="l02449"></a>02449                 }
<a name="l02450"></a>02450             }
<a name="l02451"></a>02451         }
<a name="l02452"></a>02452 
<a name="l02453"></a>02453         repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a> = FALSE;
<a name="l02454"></a>02454 
<a name="l02455"></a>02455         <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>) {
<a name="l02456"></a>02456             <a class="code" href="daemon_2repo-mgr_8c.html#afdce2de6ee36dcf6b6264ac35fb17f7a">seaf_repo_manager_del_repo</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, repo);
<a name="l02457"></a>02457             <span class="keywordflow">continue</span>;
<a name="l02458"></a>02458         }
<a name="l02459"></a>02459 
<a name="l02460"></a>02460         <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#a0ce3b61cb31e78ffea429615379b3eb4">token</a>) {
<a name="l02461"></a>02461             <span class="comment">/* If the user has logged out of the account, the repo token would</span>
<a name="l02462"></a>02462 <span class="comment">             * be null */</span>
<a name="l02463"></a>02463             seaf_debug (<span class="stringliteral">&quot;repo token of %s (%.8s) is null, would not sync it\n&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02464"></a>02464             <span class="keywordflow">continue</span>;
<a name="l02465"></a>02465         }
<a name="l02466"></a>02466 
<a name="l02467"></a>02467         <span class="comment">/* Don&#39;t sync repos not checked out yet. */</span>
<a name="l02468"></a>02468         <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>)
<a name="l02469"></a>02469             <span class="keywordflow">continue</span>;
<a name="l02470"></a>02470 
<a name="l02471"></a>02471         <span class="keywordflow">if</span> (!manager-&gt;<a class="code" href="struct__SeafSyncManager.html#a98a501bc370a4c500ec8c0688896d9bb">priv</a>-&gt;<a class="code" href="struct__SeafSyncManagerPriv.html#a3719d42c83ff26e39db5f7141d4bae54">auto_sync_enabled</a> || !repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a>)
<a name="l02472"></a>02472             <span class="keywordflow">continue</span>;
<a name="l02473"></a>02473 
<a name="l02474"></a>02474 <span class="preprocessor">#ifdef WIN32</span>
<a name="l02475"></a>02475 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a> &gt; 0) {
<a name="l02476"></a>02476             <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a772a296124f0a505659064406232dfe2">checking_locked_files</a>)
<a name="l02477"></a>02477                 <span class="keywordflow">continue</span>;
<a name="l02478"></a>02478 
<a name="l02479"></a>02479             now = (gint64)time(NULL);
<a name="l02480"></a>02480             <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#a96199d89e3f0105139c4d94d568c7208">last_check_locked_time</a> == 0 ||
<a name="l02481"></a>02481                 now - repo-&gt;<a class="code" href="struct__SeafRepo.html#a96199d89e3f0105139c4d94d568c7208">last_check_locked_time</a> &gt;= <a class="code" href="sync-mgr_8c.html#ad6282372227e4cf10c44911b384f5a14">CHECK_LOCKED_FILES_INTERVAL</a>)
<a name="l02482"></a>02482             {
<a name="l02483"></a>02483                 repo-&gt;<a class="code" href="struct__SeafRepo.html#a772a296124f0a505659064406232dfe2">checking_locked_files</a> = TRUE;
<a name="l02484"></a>02484                 <a class="code" href="job-mgr_8h.html#ac2bb163f21ddd6494f8d0101cc989768">ccnet_job_manager_schedule_job</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#abcbb9886e315abb16c620ce49808a0b2">job_mgr</a>,
<a name="l02485"></a>02485                                                 check_locked_files,
<a name="l02486"></a>02486                                                 check_locked_files_done,
<a name="l02487"></a>02487                                                 repo);
<a name="l02488"></a>02488                 repo-&gt;<a class="code" href="struct__SeafRepo.html#a96199d89e3f0105139c4d94d568c7208">last_check_locked_time</a> = now;
<a name="l02489"></a>02489 
<a name="l02490"></a>02490             }
<a name="l02491"></a>02491         }
<a name="l02492"></a>02492 <span class="preprocessor">#endif</span>
<a name="l02493"></a>02493 <span class="preprocessor"></span>
<a name="l02494"></a>02494         <a class="code" href="struct__SyncInfo.html">SyncInfo</a> *info = get_sync_info (manager, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02495"></a>02495 
<a name="l02496"></a>02496         <span class="keywordflow">if</span> (info-&gt;<a class="code" href="struct__SyncInfo.html#ad0f77a2b8e799b3a0abc417fce88843a">in_sync</a>)
<a name="l02497"></a>02497             <span class="keywordflow">continue</span>;
<a name="l02498"></a>02498 
<a name="l02499"></a>02499         <span class="comment">/* Try to use http sync first if enabled. */</span>
<a name="l02500"></a>02500         gboolean is_checking_http = FALSE;
<a name="l02501"></a>02501         <span class="keywordflow">if</span> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a3df88d84e57f0b8508144a5ff151ed19">enable_http_sync</a> &amp;&amp; repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a> &gt; 0) {
<a name="l02502"></a>02502             <span class="keywordflow">if</span> (check_http_protocol (manager, repo, &amp;is_checking_http)) {
<a name="l02503"></a>02503                 sync_repo_v2 (manager, repo, FALSE);
<a name="l02504"></a>02504                 <span class="keywordflow">continue</span>;
<a name="l02505"></a>02505             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is_checking_http)
<a name="l02506"></a>02506                 <span class="keywordflow">continue</span>;
<a name="l02507"></a>02507             <span class="comment">/* Otherwise we&#39;ve determined the server doesn&#39;t support http-sync. */</span>
<a name="l02508"></a>02508         }
<a name="l02509"></a>02509 
<a name="l02510"></a>02510         <span class="comment">/* If relay is not ready or protocol version is not determined,</span>
<a name="l02511"></a>02511 <span class="comment">         * need to wait.</span>
<a name="l02512"></a>02512 <span class="comment">         */</span>
<a name="l02513"></a>02513         <span class="keywordflow">if</span> (!check_relay_status (manager, repo))
<a name="l02514"></a>02514             <span class="keywordflow">continue</span>;
<a name="l02515"></a>02515 
<a name="l02516"></a>02516         <a class="code" href="struct__ServerState.html">ServerState</a> *state = g_hash_table_lookup (manager-&gt;<a class="code" href="struct__SeafSyncManager.html#a623ff0c818f5d0d7da880cdba6700bce">server_states</a>,
<a name="l02517"></a>02517                                                   repo-&gt;<a class="code" href="struct__SeafRepo.html#a5ec79fa4b78423415fc5f31b90fa5bd1">relay_id</a>);
<a name="l02518"></a>02518 
<a name="l02519"></a>02519         <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#ab75d342176657e7504c5cddd5ca2c56a">version</a> == 0 ||
<a name="l02520"></a>02520             state-&gt;<a class="code" href="struct__ServerState.html#adb0ef1901e8918aaa2a1e2ee5468b479">server_side_merge</a> == <a class="code" href="sync-mgr_8c.html#a16685eea158879e41b101ca3634de462ac2a0c6479a5c92919e0138492de300bf">SERVER_SIDE_MERGE_UNSUPPORTED</a> ||
<a name="l02521"></a>02521             has_old_commits_to_upload (repo))
<a name="l02522"></a>02522             sync_repo (manager, repo);
<a name="l02523"></a>02523         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state-&gt;<a class="code" href="struct__ServerState.html#adb0ef1901e8918aaa2a1e2ee5468b479">server_side_merge</a> == <a class="code" href="sync-mgr_8c.html#a16685eea158879e41b101ca3634de462aa9a54f83b0490bef2294e496c9e758f9">SERVER_SIDE_MERGE_SUPPORTED</a>)
<a name="l02524"></a>02524             sync_repo_v2 (manager, repo, FALSE);
<a name="l02525"></a>02525     }
<a name="l02526"></a>02526 
<a name="l02527"></a>02527     g_list_free (repos);
<a name="l02528"></a>02528     <span class="keywordflow">return</span> TRUE;
<a name="l02529"></a>02529 }
<a name="l02530"></a>02530 
<a name="l02531"></a>02531 <span class="keyword">inline</span> <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02532"></a>02532 send_sync_error_notification (<a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo, <span class="keyword">const</span> <span class="keywordtype">char</span> *type)
<a name="l02533"></a>02533 {
<a name="l02534"></a>02534     GString *buf = g_string_new (NULL);
<a name="l02535"></a>02535     g_string_append_printf (buf, <span class="stringliteral">&quot;%s\t%s&quot;</span>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a235da8ad7bdcaa5bf5b8e2b3e6e23b88">name</a>, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02536"></a>02536     <a class="code" href="mq-mgr_8c.html#a0e6f86438a353da6463eaf45b940f9f0">seaf_mq_manager_publish_notification</a> (<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>-&gt;<a class="code" href="struct__SeafileSession.html#a89e2a6000f250563b18123661ba9abbd">mq_mgr</a>,
<a name="l02537"></a>02537                                           type,
<a name="l02538"></a>02538                                           buf-&gt;str);
<a name="l02539"></a>02539     g_string_free (buf, TRUE);
<a name="l02540"></a>02540 }
<a name="l02541"></a>02541 
<a name="l02542"></a>02542 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02543"></a>02543 on_repo_fetched (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *<a class="code" href="seaf-daemon_8c.html#ae66636d1834d105bd51d89ff01acfe15">seaf</a>,
<a name="l02544"></a>02544                  <a class="code" href="struct__TransferTask.html">TransferTask</a> *tx_task,
<a name="l02545"></a>02545                  <a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager)
<a name="l02546"></a>02546 {
<a name="l02547"></a>02547     <a class="code" href="struct__SyncInfo.html">SyncInfo</a> *info = get_sync_info (manager, tx_task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>);
<a name="l02548"></a>02548     <a class="code" href="struct__SyncTask.html">SyncTask</a> *task = info-&gt;<a class="code" href="struct__SyncInfo.html#a6b0407e7d6def63347532d7d73eb7c6b">current_task</a>;
<a name="l02549"></a>02549 
<a name="l02550"></a>02550     <span class="comment">/* Clone tasks are handled by clone manager. */</span>
<a name="l02551"></a>02551     <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__TransferTask.html#a4462883da6780feae2b41060e5b48456">is_clone</a>)
<a name="l02552"></a>02552         <span class="keywordflow">return</span>;
<a name="l02553"></a>02553 
<a name="l02554"></a>02554     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>) {
<a name="l02555"></a>02555         transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da8e0121d3e9964268e71fd702733f2579">SYNC_STATE_CANCELED</a>);
<a name="l02556"></a>02556         <a class="code" href="daemon_2repo-mgr_8c.html#afdce2de6ee36dcf6b6264ac35fb17f7a">seaf_repo_manager_del_repo</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>);
<a name="l02557"></a>02557         <span class="keywordflow">return</span>;
<a name="l02558"></a>02558     }
<a name="l02559"></a>02559 
<a name="l02560"></a>02560     <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> == <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bcea407d72c040f282acb88e904361c217a2">TASK_STATE_FINISHED</a>) {
<a name="l02561"></a>02561         memcpy (info-&gt;<a class="code" href="struct__SyncInfo.html#a9e831740601198ad30ee08db5b64382a">head_commit</a>, tx_task-&gt;<a class="code" href="struct__TransferTask.html#a1c9929f6b7f819e950b3738e676d82db">head</a>, 41);
<a name="l02562"></a>02562 
<a name="l02563"></a>02563         <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__SyncTask.html#a4f2d508226faddcf79be1f58bc11b781">server_side_merge</a>)
<a name="l02564"></a>02564             merge_branches_if_necessary (task);
<a name="l02565"></a>02565         <span class="keywordflow">else</span>
<a name="l02566"></a>02566             transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da3c73047f0bdb59ed767efc67261354bb">SYNC_STATE_DONE</a>);
<a name="l02567"></a>02567     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> == <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaae36dd6c8f3e2e25e7946660ec15cf7d">TASK_STATE_CANCELED</a>) {
<a name="l02568"></a>02568         transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da8e0121d3e9964268e71fd702733f2579">SYNC_STATE_CANCELED</a>);
<a name="l02569"></a>02569     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> == <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaeef2d65ee28a06d4dad01ed46ab8c213">TASK_STATE_ERROR</a>) {
<a name="l02570"></a>02570         <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__TransferTask.html#a9f76a7a029f2b7103127167a03be025e">error</a> == <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a94ac0b4961fc25cdc575811d855832b6">TASK_ERR_ACCESS_DENIED</a>) {
<a name="l02571"></a>02571             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a6a98b81697cbbb8bcff96c1360f7ed01">SYNC_ERROR_ACCESS_DENIED</a>);
<a name="l02572"></a>02572             <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#ad40b148677957cac652258ee67c68358">access_denied_notified</a>) {
<a name="l02573"></a>02573                 send_sync_error_notification (task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>, <span class="stringliteral">&quot;sync.access_denied&quot;</span>);
<a name="l02574"></a>02574                 task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#ad40b148677957cac652258ee67c68358">access_denied_notified</a> = 1;
<a name="l02575"></a>02575             }
<a name="l02576"></a>02576         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__TransferTask.html#a9f76a7a029f2b7103127167a03be025e">error</a> == <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7abe38610c980c565069b26a2dcc63508d">TASK_ERR_FILES_LOCKED</a>) {
<a name="l02577"></a>02577             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55ad664b46fd1ffee9e6582fbf221334aba">SYNC_ERROR_FILES_LOCKED</a>);
<a name="l02578"></a>02578         } <span class="keywordflow">else</span>
<a name="l02579"></a>02579             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55aace54068bf03b79a8666d73a624a0dfb">SYNC_ERROR_FETCH</a>);
<a name="l02580"></a>02580     }
<a name="l02581"></a>02581 }
<a name="l02582"></a>02582 
<a name="l02583"></a>02583 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02584"></a>02584 on_repo_uploaded (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *seaf,
<a name="l02585"></a>02585                   <a class="code" href="struct__TransferTask.html">TransferTask</a> *tx_task,
<a name="l02586"></a>02586                   <a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager)
<a name="l02587"></a>02587 {
<a name="l02588"></a>02588     <a class="code" href="struct__SyncInfo.html">SyncInfo</a> *info = get_sync_info (manager, tx_task-&gt;<a class="code" href="struct__TransferTask.html#adc5f8a15d03c66765d59b91e37e32746">repo_id</a>);
<a name="l02589"></a>02589     <a class="code" href="struct__SyncTask.html">SyncTask</a> *task = info-&gt;<a class="code" href="struct__SyncInfo.html#a6b0407e7d6def63347532d7d73eb7c6b">current_task</a>;
<a name="l02590"></a>02590 
<a name="l02591"></a>02591     g_return_if_fail (task != NULL &amp;&amp; info-&gt;<a class="code" href="struct__SyncInfo.html#ad0f77a2b8e799b3a0abc417fce88843a">in_sync</a>);
<a name="l02592"></a>02592 
<a name="l02593"></a>02593     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>) {
<a name="l02594"></a>02594         transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da8e0121d3e9964268e71fd702733f2579">SYNC_STATE_CANCELED</a>);
<a name="l02595"></a>02595         <a class="code" href="daemon_2repo-mgr_8c.html#afdce2de6ee36dcf6b6264ac35fb17f7a">seaf_repo_manager_del_repo</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>);
<a name="l02596"></a>02596         <span class="keywordflow">return</span>;
<a name="l02597"></a>02597     }
<a name="l02598"></a>02598 
<a name="l02599"></a>02599     <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> == <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bcea407d72c040f282acb88e904361c217a2">TASK_STATE_FINISHED</a>) {
<a name="l02600"></a>02600         memcpy (info-&gt;<a class="code" href="struct__SyncInfo.html#a9e831740601198ad30ee08db5b64382a">head_commit</a>, tx_task-&gt;<a class="code" href="struct__TransferTask.html#a1c9929f6b7f819e950b3738e676d82db">head</a>, 41);
<a name="l02601"></a>02601 
<a name="l02602"></a>02602         <span class="comment">/* Save current head commit id for GC. */</span>
<a name="l02603"></a>02603         <a class="code" href="daemon_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l02604"></a>02604                                              task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l02605"></a>02605                                              <a class="code" href="daemon_2repo-mgr_8h.html#ab09a088f0dfff9872d5dfb605ed1cade">REPO_LOCAL_HEAD</a>,
<a name="l02606"></a>02606                                              task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l02607"></a>02607         <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__SyncTask.html#a4f2d508226faddcf79be1f58bc11b781">server_side_merge</a>)
<a name="l02608"></a>02608             transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da3c73047f0bdb59ed767efc67261354bb">SYNC_STATE_DONE</a>);
<a name="l02609"></a>02609         <span class="keywordflow">else</span> {
<a name="l02610"></a>02610             task-&gt;<a class="code" href="struct__SyncTask.html#af5500a94e3d4e76c70bf200265bddc21">uploaded</a> = TRUE;
<a name="l02611"></a>02611             <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__SyncTask.html#a29f8510d0999c926b2723a443a57f007">http_sync</a>)
<a name="l02612"></a>02612                 start_sync_repo_proc (manager, task);
<a name="l02613"></a>02613             <span class="keywordflow">else</span>
<a name="l02614"></a>02614                 check_head_commit_http (task);
<a name="l02615"></a>02615         }
<a name="l02616"></a>02616     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> == <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaae36dd6c8f3e2e25e7946660ec15cf7d">TASK_STATE_CANCELED</a>) {
<a name="l02617"></a>02617         transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da8e0121d3e9964268e71fd702733f2579">SYNC_STATE_CANCELED</a>);
<a name="l02618"></a>02618     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__TransferTask.html#a1d4ba9aacf2e9930fb136b0092bf9531">state</a> == <a class="code" href="transfer-mgr_8h.html#a724f9ce2351c125b3b7f6c7923822bceaeef2d65ee28a06d4dad01ed46ab8c213">TASK_STATE_ERROR</a>) {
<a name="l02619"></a>02619         <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__TransferTask.html#a9f76a7a029f2b7103127167a03be025e">error</a> == <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a94ac0b4961fc25cdc575811d855832b6">TASK_ERR_ACCESS_DENIED</a>) {
<a name="l02620"></a>02620             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a6a98b81697cbbb8bcff96c1360f7ed01">SYNC_ERROR_ACCESS_DENIED</a>);
<a name="l02621"></a>02621             <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#ad40b148677957cac652258ee67c68358">access_denied_notified</a>) {
<a name="l02622"></a>02622                 send_sync_error_notification (task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>, <span class="stringliteral">&quot;sync.access_denied&quot;</span>);
<a name="l02623"></a>02623                 task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#ad40b148677957cac652258ee67c68358">access_denied_notified</a> = 1;
<a name="l02624"></a>02624             }
<a name="l02625"></a>02625         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__TransferTask.html#a9f76a7a029f2b7103127167a03be025e">error</a> == <a class="code" href="transfer-mgr_8h.html#a996fbed76432550cd23973f754b716b7a31125a53312a164fbd4319abf3ec605c">TASK_ERR_QUOTA_FULL</a>) {
<a name="l02626"></a>02626             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a4339be587e91d150d3289dce026b6b49">SYNC_ERROR_QUOTA_FULL</a>);
<a name="l02627"></a>02627             <span class="comment">/* Only notify &quot;quota full&quot; once. */</span>
<a name="l02628"></a>02628             <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a11dafeec06d10af805448ba5e11a7693">quota_full_notified</a>) {
<a name="l02629"></a>02629                 send_sync_error_notification (task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>, <span class="stringliteral">&quot;sync.quota_full&quot;</span>);
<a name="l02630"></a>02630                 task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a11dafeec06d10af805448ba5e11a7693">quota_full_notified</a> = 1;
<a name="l02631"></a>02631             }
<a name="l02632"></a>02632         } <span class="keywordflow">else</span>
<a name="l02633"></a>02633             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a84edb880000b2a73f03bf4f424a26525">SYNC_ERROR_UPLOAD</a>);
<a name="l02634"></a>02634     }
<a name="l02635"></a>02635 }
<a name="l02636"></a>02636 
<a name="l02637"></a>02637 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02638"></a>02638 on_repo_http_fetched (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *seaf,
<a name="l02639"></a>02639                       <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *tx_task,
<a name="l02640"></a>02640                       <a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager)
<a name="l02641"></a>02641 {
<a name="l02642"></a>02642     <a class="code" href="struct__SyncInfo.html">SyncInfo</a> *info = get_sync_info (manager, tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02643"></a>02643     <a class="code" href="struct__SyncTask.html">SyncTask</a> *task = info-&gt;<a class="code" href="struct__SyncInfo.html#a6b0407e7d6def63347532d7d73eb7c6b">current_task</a>;
<a name="l02644"></a>02644 
<a name="l02645"></a>02645     <span class="comment">/* Clone tasks are handled by clone manager. */</span>
<a name="l02646"></a>02646     <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#a8dc7ba305c249ab73ce9424725776d41">is_clone</a>)
<a name="l02647"></a>02647         <span class="keywordflow">return</span>;
<a name="l02648"></a>02648 
<a name="l02649"></a>02649     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>) {
<a name="l02650"></a>02650         transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da8e0121d3e9964268e71fd702733f2579">SYNC_STATE_CANCELED</a>);
<a name="l02651"></a>02651         <a class="code" href="daemon_2repo-mgr_8c.html#afdce2de6ee36dcf6b6264ac35fb17f7a">seaf_repo_manager_del_repo</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>);
<a name="l02652"></a>02652         <span class="keywordflow">return</span>;
<a name="l02653"></a>02653     }
<a name="l02654"></a>02654 
<a name="l02655"></a>02655     <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5a0facf2c60cc1a598735bd4d8d488417b">HTTP_TASK_STATE_FINISHED</a>) {
<a name="l02656"></a>02656         memcpy (info-&gt;<a class="code" href="struct__SyncInfo.html#a9e831740601198ad30ee08db5b64382a">head_commit</a>, tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>, 41);
<a name="l02657"></a>02657         transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da3c73047f0bdb59ed767efc67261354bb">SYNC_STATE_DONE</a>);
<a name="l02658"></a>02658     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>) {
<a name="l02659"></a>02659         transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da8e0121d3e9964268e71fd702733f2579">SYNC_STATE_CANCELED</a>);
<a name="l02660"></a>02660     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5a7829485480889c6958e5ddd2996b05ff">HTTP_TASK_STATE_ERROR</a>) {
<a name="l02661"></a>02661         <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> == <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159aa00ba87058de87811a512e793545688d">HTTP_TASK_ERR_FORBIDDEN</a>) {
<a name="l02662"></a>02662             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a6a98b81697cbbb8bcff96c1360f7ed01">SYNC_ERROR_ACCESS_DENIED</a>);
<a name="l02663"></a>02663             <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#ad40b148677957cac652258ee67c68358">access_denied_notified</a>) {
<a name="l02664"></a>02664                 send_sync_error_notification (task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>, <span class="stringliteral">&quot;sync.access_denied&quot;</span>);
<a name="l02665"></a>02665                 task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#ad40b148677957cac652258ee67c68358">access_denied_notified</a> = 1;
<a name="l02666"></a>02666             }
<a name="l02667"></a>02667         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> == <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159aae23d23cfaef7dcaed67aae072df1f74">HTTP_TASK_ERR_FILES_LOCKED</a>) {
<a name="l02668"></a>02668             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55ad664b46fd1ffee9e6582fbf221334aba">SYNC_ERROR_FILES_LOCKED</a>);
<a name="l02669"></a>02669         } <span class="keywordflow">else</span>
<a name="l02670"></a>02670             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55aace54068bf03b79a8666d73a624a0dfb">SYNC_ERROR_FETCH</a>);
<a name="l02671"></a>02671     }
<a name="l02672"></a>02672 }
<a name="l02673"></a>02673 
<a name="l02674"></a>02674 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02675"></a>02675 on_repo_http_uploaded (<a class="code" href="struct__SeafileSession.html">SeafileSession</a> *seaf,
<a name="l02676"></a>02676                        <a class="code" href="struct__HttpTxTask.html">HttpTxTask</a> *tx_task,
<a name="l02677"></a>02677                        <a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *manager)
<a name="l02678"></a>02678 {
<a name="l02679"></a>02679     <a class="code" href="struct__SyncInfo.html">SyncInfo</a> *info = get_sync_info (manager, tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#aa59aeedc8cf62fbeecf3c04bf6127811">repo_id</a>);
<a name="l02680"></a>02680     <a class="code" href="struct__SyncTask.html">SyncTask</a> *task = info-&gt;<a class="code" href="struct__SyncInfo.html#a6b0407e7d6def63347532d7d73eb7c6b">current_task</a>;
<a name="l02681"></a>02681 
<a name="l02682"></a>02682     g_return_if_fail (task != NULL &amp;&amp; info-&gt;<a class="code" href="struct__SyncInfo.html#ad0f77a2b8e799b3a0abc417fce88843a">in_sync</a>);
<a name="l02683"></a>02683 
<a name="l02684"></a>02684     <span class="keywordflow">if</span> (task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a1316126e566b3b2c1d444c9a9511b2ff">delete_pending</a>) {
<a name="l02685"></a>02685         transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da8e0121d3e9964268e71fd702733f2579">SYNC_STATE_CANCELED</a>);
<a name="l02686"></a>02686         <a class="code" href="daemon_2repo-mgr_8c.html#afdce2de6ee36dcf6b6264ac35fb17f7a">seaf_repo_manager_del_repo</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>);
<a name="l02687"></a>02687         <span class="keywordflow">return</span>;
<a name="l02688"></a>02688     }
<a name="l02689"></a>02689 
<a name="l02690"></a>02690     <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5a0facf2c60cc1a598735bd4d8d488417b">HTTP_TASK_STATE_FINISHED</a>) {
<a name="l02691"></a>02691         memcpy (info-&gt;<a class="code" href="struct__SyncInfo.html#a9e831740601198ad30ee08db5b64382a">head_commit</a>, tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#adf8fd25193df2e73ec6e92f2eff9a5f1">head</a>, 41);
<a name="l02692"></a>02692 
<a name="l02693"></a>02693         <span class="comment">/* Save current head commit id for GC. */</span>
<a name="l02694"></a>02694         <a class="code" href="daemon_2repo-mgr_8c.html#a9d2f586c85f26b2de677fd03606103aa">seaf_repo_manager_set_repo_property</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>,
<a name="l02695"></a>02695                                              task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>,
<a name="l02696"></a>02696                                              <a class="code" href="daemon_2repo-mgr_8h.html#ab09a088f0dfff9872d5dfb605ed1cade">REPO_LOCAL_HEAD</a>,
<a name="l02697"></a>02697                                              task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a8e635ccff244ee483d3b4abe576e388e">head</a>-&gt;<a class="code" href="struct__SeafBranch.html#a244ae046d92274c745de9f2b4d115962">commit_id</a>);
<a name="l02698"></a>02698         task-&gt;<a class="code" href="struct__SyncTask.html#af5500a94e3d4e76c70bf200265bddc21">uploaded</a> = TRUE;
<a name="l02699"></a>02699         check_head_commit_http (task);
<a name="l02700"></a>02700     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5ace5e6d5d0a85c8b2f79aeb038c7ea9bc">HTTP_TASK_STATE_CANCELED</a>) {
<a name="l02701"></a>02701         transition_sync_state (task, <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da8e0121d3e9964268e71fd702733f2579">SYNC_STATE_CANCELED</a>);
<a name="l02702"></a>02702     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#ae22667654511c675acce777dcb74a890">state</a> == <a class="code" href="http-tx-mgr_8h.html#af4932c1ce85a6123a03c64cde0384dc5a7829485480889c6958e5ddd2996b05ff">HTTP_TASK_STATE_ERROR</a>) {
<a name="l02703"></a>02703         <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> == <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159aa00ba87058de87811a512e793545688d">HTTP_TASK_ERR_FORBIDDEN</a>) {
<a name="l02704"></a>02704             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a6a98b81697cbbb8bcff96c1360f7ed01">SYNC_ERROR_ACCESS_DENIED</a>);
<a name="l02705"></a>02705             <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#ad40b148677957cac652258ee67c68358">access_denied_notified</a>) {
<a name="l02706"></a>02706                 send_sync_error_notification (task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>, <span class="stringliteral">&quot;sync.access_denied&quot;</span>);
<a name="l02707"></a>02707                 task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#ad40b148677957cac652258ee67c68358">access_denied_notified</a> = 1;
<a name="l02708"></a>02708             }
<a name="l02709"></a>02709         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tx_task-&gt;<a class="code" href="struct__HttpTxTask.html#a377ab043fcd84ccdf5d8c84d6e6fd18f">error</a> == <a class="code" href="http-tx-mgr_8h.html#a597f2c645b8d06d74fc53b1324fa7159a2a3d2dfaad7277c09bfec6d98442c774">HTTP_TASK_ERR_NO_QUOTA</a>) {
<a name="l02710"></a>02710             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a4339be587e91d150d3289dce026b6b49">SYNC_ERROR_QUOTA_FULL</a>);
<a name="l02711"></a>02711             <span class="comment">/* Only notify &quot;quota full&quot; once. */</span>
<a name="l02712"></a>02712             <span class="keywordflow">if</span> (!task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a11dafeec06d10af805448ba5e11a7693">quota_full_notified</a>) {
<a name="l02713"></a>02713                 send_sync_error_notification (task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>, <span class="stringliteral">&quot;sync.quota_full&quot;</span>);
<a name="l02714"></a>02714                 task-&gt;<a class="code" href="struct__SyncTask.html#a519c9441b367566b1f7c6084c426b2e5">repo</a>-&gt;<a class="code" href="struct__SeafRepo.html#a11dafeec06d10af805448ba5e11a7693">quota_full_notified</a> = 1;
<a name="l02715"></a>02715             }
<a name="l02716"></a>02716         } <span class="keywordflow">else</span>
<a name="l02717"></a>02717             <a class="code" href="sync-mgr_8c.html#a5061802c84fd1122d5917d3f502509a0">seaf_sync_manager_set_task_error</a> (task, <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a84edb880000b2a73f03bf4f424a26525">SYNC_ERROR_UPLOAD</a>);
<a name="l02718"></a>02718     }
<a name="l02719"></a>02719 }
<a name="l02720"></a>02720 
<a name="l02721"></a>02721 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l02722"></a><a class="code" href="sync-mgr_8h.html#ae811eab4103ac4fc768be073c7847565">02722</a> <a class="code" href="sync-mgr_8c.html#ae811eab4103ac4fc768be073c7847565">sync_error_to_str</a> (<span class="keywordtype">int</span> error)
<a name="l02723"></a>02723 {
<a name="l02724"></a>02724     <span class="keywordflow">if</span> (error &lt; 0 || error &gt;= <a class="code" href="sync-mgr_8h.html#afa231099d07583c3ed0981e0bb665f55a7d4d35b0843584d00238d4110e2bad8e">SYNC_ERROR_NUM</a>) {
<a name="l02725"></a>02725         seaf_warning (<span class="stringliteral">&quot;illegal sync error: %d\n&quot;</span>, error); 
<a name="l02726"></a>02726         <span class="keywordflow">return</span> NULL;
<a name="l02727"></a>02727     }
<a name="l02728"></a>02728 
<a name="l02729"></a>02729     <span class="keywordflow">return</span> sync_error_str[error];
<a name="l02730"></a>02730 }
<a name="l02731"></a>02731 
<a name="l02732"></a>02732 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l02733"></a><a class="code" href="sync-mgr_8h.html#ae2fef6674a65dc768d3a1c0c8a760020">02733</a> <a class="code" href="sync-mgr_8c.html#ae2fef6674a65dc768d3a1c0c8a760020">sync_state_to_str</a> (<span class="keywordtype">int</span> state)
<a name="l02734"></a>02734 {
<a name="l02735"></a>02735     <span class="keywordflow">if</span> (state &lt; 0 || state &gt;= <a class="code" href="sync-mgr_8h.html#a2970898e8a43ce21e1cc510d49f1b89da454e120cc51f9bbf1a61c67300bc055b">SYNC_STATE_NUM</a>) {
<a name="l02736"></a>02736         seaf_warning (<span class="stringliteral">&quot;illegal sync state: %d\n&quot;</span>, state); 
<a name="l02737"></a>02737         <span class="keywordflow">return</span> NULL;
<a name="l02738"></a>02738     }
<a name="l02739"></a>02739 
<a name="l02740"></a>02740     <span class="keywordflow">return</span> sync_state_str[state];
<a name="l02741"></a>02741 }
<a name="l02742"></a>02742 
<a name="l02743"></a>02743 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02744"></a>02744 cancel_all_sync_tasks (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *mgr)
<a name="l02745"></a>02745 {
<a name="l02746"></a>02746     GList *repos;
<a name="l02747"></a>02747     GList *ptr;
<a name="l02748"></a>02748     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l02749"></a>02749 
<a name="l02750"></a>02750     repos = <a class="code" href="daemon_2repo-mgr_8c.html#a5fe41fb7382995f3f335e408ba4ddb30">seaf_repo_manager_get_repo_list</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, -1, -1);
<a name="l02751"></a>02751     <span class="keywordflow">for</span> (ptr = repos; ptr; ptr = ptr-&gt;next) {
<a name="l02752"></a>02752         repo = ptr-&gt;data;
<a name="l02753"></a>02753         <a class="code" href="sync-mgr_8c.html#a0b90f2ae7c7e7a85ae97b7ade254572a">seaf_sync_manager_cancel_sync_task</a> (mgr, repo-&gt;<a class="code" href="struct__SeafRepo.html#a9d6bc9ae525da00bc4c7d1f62dc9b762">id</a>);
<a name="l02754"></a>02754     }
<a name="l02755"></a>02755 
<a name="l02756"></a>02756     g_list_free (repos);
<a name="l02757"></a>02757 }
<a name="l02758"></a>02758 
<a name="l02759"></a>02759 <span class="keywordtype">int</span>
<a name="l02760"></a><a class="code" href="sync-mgr_8h.html#abe16c7da3482de138f5c6f48757ae022">02760</a> <a class="code" href="sync-mgr_8c.html#abe16c7da3482de138f5c6f48757ae022">seaf_sync_manager_disable_auto_sync</a> (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *mgr)
<a name="l02761"></a>02761 {
<a name="l02762"></a>02762     <span class="keywordflow">if</span> (!seaf-&gt;<a class="code" href="struct__SeafileSession.html#a5432788378b921624977855244c63a85">started</a>) {
<a name="l02763"></a>02763         seaf_message (<span class="stringliteral">&quot;sync manager is not started, skip disable auto sync.\n&quot;</span>);
<a name="l02764"></a>02764         <span class="keywordflow">return</span> -1;
<a name="l02765"></a>02765     }
<a name="l02766"></a>02766 
<a name="l02767"></a>02767     cancel_all_sync_tasks (mgr);
<a name="l02768"></a>02768     mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a98a501bc370a4c500ec8c0688896d9bb">priv</a>-&gt;<a class="code" href="struct__SeafSyncManagerPriv.html#a3719d42c83ff26e39db5f7141d4bae54">auto_sync_enabled</a> = FALSE;
<a name="l02769"></a>02769     <a class="code" href="seafile_2lib_2include_8h.html#ae5a5c3cadbc1f6e2363d25fc0fb46084">g_debug</a> (<span class="stringliteral">&quot;[sync mgr] auto sync is disabled\n&quot;</span>);
<a name="l02770"></a>02770     <span class="keywordflow">return</span> 0;
<a name="l02771"></a>02771 }
<a name="l02772"></a>02772 
<a name="l02773"></a>02773 <span class="preprocessor">#if 0</span>
<a name="l02774"></a>02774 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02775"></a>02775 add_sync_tasks_for_all (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *mgr)
<a name="l02776"></a>02776 {
<a name="l02777"></a>02777     GList *repos, *ptr;
<a name="l02778"></a>02778     <a class="code" href="struct__SeafRepo.html">SeafRepo</a> *repo;
<a name="l02779"></a>02779 
<a name="l02780"></a>02780     repos = <a class="code" href="daemon_2repo-mgr_8c.html#a5fe41fb7382995f3f335e408ba4ddb30">seaf_repo_manager_get_repo_list</a> (seaf-&gt;<a class="code" href="struct__SeafileSession.html#a08681eb4d012b49f2552a91f4ba494f7">repo_mgr</a>, -1, -1);
<a name="l02781"></a>02781     <span class="keywordflow">for</span> (ptr = repos; ptr; ptr = ptr-&gt;next) {
<a name="l02782"></a>02782         repo = ptr-&gt;data;
<a name="l02783"></a>02783         <span class="keywordflow">if</span> (!repo-&gt;<a class="code" href="struct__SeafRepo.html#a179d8ca9672a5eeafcbf535d0ccee45d">auto_sync</a>)
<a name="l02784"></a>02784             <span class="keywordflow">continue</span>;
<a name="l02785"></a>02785 
<a name="l02786"></a>02786         <span class="keywordflow">if</span> (repo-&gt;<a class="code" href="struct__SeafRepo.html#aeedd453a6f0cf0f3f8104bd2c04d0488">worktree_invalid</a>)
<a name="l02787"></a>02787             <span class="keywordflow">continue</span>;
<a name="l02788"></a>02788         
<a name="l02789"></a>02789         start_sync (mgr, repo, TRUE, FALSE, TRUE);
<a name="l02790"></a>02790     }
<a name="l02791"></a>02791 
<a name="l02792"></a>02792     g_list_free (repos);
<a name="l02793"></a>02793 }
<a name="l02794"></a>02794 <span class="preprocessor">#endif</span>
<a name="l02795"></a>02795 <span class="preprocessor"></span>
<a name="l02796"></a>02796 <span class="keywordtype">int</span>
<a name="l02797"></a><a class="code" href="sync-mgr_8h.html#ae0cb02ae35e27db0ba2010575d853630">02797</a> <a class="code" href="sync-mgr_8c.html#ae0cb02ae35e27db0ba2010575d853630">seaf_sync_manager_enable_auto_sync</a> (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *mgr)
<a name="l02798"></a>02798 {
<a name="l02799"></a>02799     <span class="keywordflow">if</span> (!seaf-&gt;<a class="code" href="struct__SeafileSession.html#a5432788378b921624977855244c63a85">started</a>) {
<a name="l02800"></a>02800         seaf_message (<span class="stringliteral">&quot;sync manager is not started, skip enable auto sync.\n&quot;</span>);
<a name="l02801"></a>02801         <span class="keywordflow">return</span> -1;
<a name="l02802"></a>02802     }
<a name="l02803"></a>02803 
<a name="l02804"></a>02804     <span class="comment">/* add_sync_tasks_for_all (mgr); */</span>
<a name="l02805"></a>02805     mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a98a501bc370a4c500ec8c0688896d9bb">priv</a>-&gt;<a class="code" href="struct__SeafSyncManagerPriv.html#a3719d42c83ff26e39db5f7141d4bae54">auto_sync_enabled</a> = TRUE;
<a name="l02806"></a>02806     <a class="code" href="seafile_2lib_2include_8h.html#ae5a5c3cadbc1f6e2363d25fc0fb46084">g_debug</a> (<span class="stringliteral">&quot;[sync mgr] auto sync is enabled\n&quot;</span>);
<a name="l02807"></a>02807     <span class="keywordflow">return</span> 0;
<a name="l02808"></a>02808 }
<a name="l02809"></a>02809 
<a name="l02810"></a>02810 <span class="keywordtype">int</span>
<a name="l02811"></a><a class="code" href="sync-mgr_8h.html#a68263f08a3a853d91f0314dce1e706b8">02811</a> <a class="code" href="sync-mgr_8c.html#a68263f08a3a853d91f0314dce1e706b8">seaf_sync_manager_is_auto_sync_enabled</a> (<a class="code" href="struct__SeafSyncManager.html">SeafSyncManager</a> *mgr)
<a name="l02812"></a>02812 {
<a name="l02813"></a>02813     <span class="keywordflow">if</span> (mgr-&gt;<a class="code" href="struct__SeafSyncManager.html#a98a501bc370a4c500ec8c0688896d9bb">priv</a>-&gt;<a class="code" href="struct__SeafSyncManagerPriv.html#a3719d42c83ff26e39db5f7141d4bae54">auto_sync_enabled</a>)
<a name="l02814"></a>02814         <span class="keywordflow">return</span> 1;
<a name="l02815"></a>02815     <span class="keywordflow">else</span>
<a name="l02816"></a>02816         <span class="keywordflow">return</span> 0;
<a name="l02817"></a>02817 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Wed Aug 19 2015 03:28:56 for My Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
